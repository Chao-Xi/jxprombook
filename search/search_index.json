{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u624b\u6478\u624bPrometheus&amp;Thanos\u76d1\u63a7\u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b","text":"<p>Started at Oct 16, 2018 By Jacob Xi</p> <p>Prometheus, Grafana, AlertManager, PromQL, Thanos, VictoriaMetrics and APM</p>"},{"location":"#jxs-chit-chat","title":"JX's chit-chat","text":"<p>Hi, this part is fucking new and freshing\ud83e\udd14</p> <p>\u8bb0\u5f55\u4e00\u4e0b\u751f\u6d3b\uff0c\u5927\u6982\u662f\u4e0a\u5468\u56db19\u53f7\u7684\u65f6\u5019\u7ec8\u4e8e\u62ff\u5230\u4e86\u6b63\u5f0f\u7684offer letter, associate director \u526f\u8463\u4e8b\uff0c\u4e5f\u662f\u6211\u8fd9\u8f88\u5b50\u7b2c\u4e00\u6b21\u6709\u4e86\u81ea\u5df1\u7684title\uff0c\u542c\u8d77\u6765\u8fd8\u86ee\u552c\u4eba\u7684\u3002\u4e0d\u8fc7\u5e94\u8be5\u8fd8\u662f\u4e00\u4e2a\u60b2\u50ac\u7684\u6253\u5de5\u4ed4\uff0c\u65e2\u7136\u5df2\u7ecf\u62ff\u5230\u4e86\u5c5e\u4e8e\u81ea\u5df1\u594b\u6597\u7684\u7ed3\u679c\uff0c\u7ec8\u4e8e\u53ef\u4ee5\u6309\u90e8\u5c31\u73ed\u7684\u5b9e\u73b0\u81ea\u5df1\u7684\u8ba1\u5212\u4e86\uff0c\u5e0c\u671b\u4e00\u5207\u987a\u5229\u3002\u8fd9\u5468\u4e00\u4eba\u751f\u7b2c\u4e00\u6b21\u4e3b\u52a8\u63d0\u79bb\u804c\uff0c\u6709\u70b9\u5c0f\u7d27\u5f20\uff0c\u6ee1\u809a\u5b50\u7684\u6028\u6c14\u8fd8\u662f\u6ca1\u6709\u6492\u51fa\u53bb\uff0c\u4e0d\u8fc7\u6211\u5df2\u7ecfpeace\u4e86\u3002 </p> <p>\u611f\u89c9\u5feb\u8981\u89e3\u5c01\u4e86\uff0c\u5e0c\u671b\u5427\uff0c\u4e0d\u8981\u518d\u6b3a\u9a97\u6211\u4eec\u8fd9\u4e9b\u5355\u7eaf\u7684\u5c0f\u4f19\u5b50\u4eec\u4e86\ud83e\udd20</p> <p>\u8bf4\u8bf4\u6700\u8fd1\u770b\u7684\u65b0\u5267\u548c\u5c0f\u8bf4\u5427</p> <ul> <li>\u201c\u795e\u63a2\u6ce2\u7f57\u201d\u9a6c\u4e0a\u5c31\u8981\u770b\u5b8c\u4e86\uff0c\u867d\u7136\u611f\u89c9\u6709\u70b9\u75b2\u4e86\uff0c\u4f46\u662f\u4e0d\u5f97\u4e0d\u8bf4\uff0c\u771f\u7684\u8fd8\u662f\u771f\u7cbe\u81f4\u7684\u5267\uff0c\u8001\u620f\u9aa8\u7684\u6f14\u6280\u6ca1\u5f97\u8bf4</li> <li>\u4e1c\u4eac\u7f6a\u6076 Tokyo Vice, \u597d\u4e45\u6ca1\u6709\u770b\u5230\u8282\u594f\u548c\u753b\u9762\u8fd9\u4e48\u68d2\u7684\u7535\u89c6\u5267\u4e86\uff0c\u770b\u5b8c\u771f\u7684\u597d\u60f3\u53bb\u4e1c\u4eac\u8f6c\u4e00\u5708</li> <li>\u53f2\u524d\u661f\u7403 Prehistoric Planet \u4e0d\u591a\u8bf4\uff0c\u6bcf\u4e00\u5e27\u90fd\u53ef\u4ee5\u622a\u56fe\u4f5c\u4e3a\u58c1\u7eb8\uff0c\u4ee5\u767d\u57a9\u7eaa\u65f6\u4ee3\u7684\u73af\u5883\u4e3a\u80cc\u666f\uff0c\u63cf\u7ed8\u4e86\u6d77\u5cb8\u3001\u6c99\u6f20\u3001\u6cb3\u6d41\u3001\u51b0\u96ea\u4e16\u754c\u548c\u68ee\u6797\u7684\u573a\u666f\uff0c\u5c55\u793a\u4e86\u9c9c\u4e3a\u4eba\u77e5\u4e14\u4ee4\u4eba\u60ca\u8bb6\u7684\u6050\u9f99\u751f\u6d3b\u3002</li> <li>\u5c0f\u8bf4\uff0c\u6700\u8fd1\u770b\u5b8c\u4e86\u300a\u5bc4\u751f\u524d\u591c\u300b\uff0c\u300a\u970d\u6bd4\u7279\u4eba\u300b\uff0c\u89c9\u5f97\u81ea\u5df1\u5e74\u7eaa\u5927\u4e86\uff0c\u53cd\u800c\u5f00\u59cb\u559c\u6b22\u8fd9\u79cd\u6162\u8282\u594f\u7684\u4e2d\u4e16\u7eaa\u5c0f\u8bf4\u4e86</li> </ul>"},{"location":"#_1","title":"\u5185\u5bb9\u7b80\u4ecb","text":"<p>\u672c\u4e66\u662f\u4e2a\u7279\u522b\u6709\u610f\u601d\u7684\u4e00\u6b21\u5c1d\u8bd5\uff0c\u7b2c\u4e00\u7bc7\u6587\u7ae0\u53d1\u8868\u4e8e2018\u5e7410\u6708\uff0c\u9646\u9646\u7eed\u7eed\u5199\u4e86\u56db\u5e74\u591a\uff0c90\u591a\u7bc7\u6587\u7ae0\uff0c\u4eceBB\u5230SAP\uff0c\u751a\u81f3\u9a6c\u4e0a\u5c31\u8981\u5230\u65b0\u516c\u53f8\u4e86\u3002\u7a81\u7136\u53d1\u73b0\u968f\u7740\u8fd9\u4e9b\u5b64\u7acb\u7684\u6587\u7ae0\u8d8a\u5199\u8d8a\u591a\uff0c\u4e0d\u5982\u628a\u8fd9\u4e9b\u6587\u7ae0\u6574\u7406\u6574\u7406\u51fa\u4e00\u672c\u7535\u5b50\u4e66\uff0c\u6709\u5173Prometheus\u76d1\u63a7\u6280\u672f\u6808\uff0c\u5305\u62ecPrometheus\u7684\u4f7f\u7528\uff0cPrometheus stack\u7684\u642d\u5efa\uff0c\u670d\u52a1\u7684\u6293\u53d6\uff0cPromQL \u7684\u4f7f\u7528\uff0c\u597d\u7528\u4ee5\u53ca\u5e38\u7528\u7684Alert\u4fe1\u606f\uff0c Prometheus HA\u96c6\u7fa4 Thanos\uff0cPrometheus \u6301\u4e45\u5316\u96c6\u7fa4 VictoriaMetrics\uff0c\u4ee5\u53caAPM\u76d1\u63a7\u7684\u4ecb\u7ecd</p> <ul> <li>Promethues\u5e94\u7528\u76d1\u63a7\u4ecb\u7ecd\uff0cK8S \u91cc\u9762\u66b4\u9732\u4fe1\u606f\u5e38\u7528\u7684kube-state-metrics\uff0cHPA,  Metrics Server, \u4f20\u7edf\u7684\u5b89\u88c5\u65b9\u5f0f</li> <li>Promethues on Linux, Node Exporter\uff0cPrometheus MySQL \u53ef\u89c6\u89c6\u5316\u76d1\u63a7</li> <li>\u624b\u52a8\u90e8\u7f72Kubernetes Prometheus\uff0c \u73a9\u8f6cPrometheus Operator\u90e8\u7f72\uff0cPrometheus \u670d\u52a1\u7684\u81ea\u52a8\u53d1\u73b0\u4f7f\u7528</li> <li>Prometheus-Adapter \u5b9e\u73b0 \u5e94\u7528\u8fdb\u884c\u81ea\u5b9a\u4e49\u6307\u6807\u6269\u7f29\u5bb9</li> <li>PromQL\u7684\u5b66\u4e60\u5305\u62ec\uff0c\u64cd\u4f5c\u7b26 &amp; \u5185\u7f6e\u51fd\u6570\uff0c\u7b80\u5355\u793a\u4f8b\uff0c\u8bb0\u5f55\u89c4\u5219\u7684\u4f7f\u7528(Recording Rule)</li> <li>Awesome Prometheus alerts </li> <li>\u6570\u636e\u53ef\u89c6\u5316 Grafana \u4ee5\u53ca\u51e0\u4e2a\u5e38\u7528\u7684 Grafana Plugin DevOpsProdigy KubeGraf\uff0c darks</li> <li>\u5927\u89c4\u6a21\u573a\u666f\u4e0b Prometheus \u7684\u4f18\u5316\u624b\u6bb5 Thanos </li> <li>Prometheus\u9ad8\u6027\u80fd\u8fdc\u7a0b\u5b58\u50a8VictoriaMetrics</li> <li>\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u6280\u672f \u4ee5\u53ca APM\u7684\u5e94\u7528\u4ecb\u7ecd</li> </ul> <p></p> <p></p> <p></p>"},{"location":"#previous-on-my-technolog-book","title":"Previous on my Technolog book","text":"<p>\u624b\u6478\u624b Jenkins \u6218\u672f\u6559\u7a0b (\u5927\u5e08\u7248\uff09</p> <p>\u624b\u6478\u624b Elasticsearch7 \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Redis \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Chef &amp; Ansible \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b \u5206\u5e03\u5f0f\u4e0e\u6d41\u5f0f\u7cfb\u7edf (In progress)</p> <p>Azure 103&amp;900 Tutorial (In progress)</p> <p>\u624b\u6478\u624b Linux Performance &amp; \u9762\u8bd5\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Databases \u5168\u6559\u7a0b</p> <p>AWS Certified Data Analytics Tutorial</p> <p>Istio &amp; Service Mesh \u6218\u672f\u6559\u7a0b</p> <p>AWS Certification Solutions Architect Book</p> <p>\u624b\u6478\u624bPrometheus&amp;Thanos\u76d1\u63a7\u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>Distributed Message System Book(Kafka)</p>"},{"location":"#salut-cest-moi","title":"Salut! C'est Moi","text":"<p>Do or Do not, there is no try</p> <p>Hello, this is me, Jacob. Currently, I'm working as DevOps and Cloud Engineer in SAP, and I'm the certified AWS Solution Architect and Certified Azure Administrator, Kubernetes Specialist, Jenkins CI/CD and ElasticStack enthusiast. </p> <p>I was working as Backend Engineer in New York City and achieved my CS master degree in SIT, America. Believe it or not, I'll keep writing, more and more books will come out at such dramatic and unprecedented 2021. </p> <p>If you have anything want to talk to me directly, you can reach out for via email xichao2015@outlook.com\u3002</p> <p>Salute, c'est moi, Jacob. Actuellement, je travaille en tant qu'ing\u00e9nieur DevOps et Cloud dans SAP, et je suis architecte de solution AWS certifi\u00e9 et administrateur Azure certifi\u00e9, sp\u00e9cialiste Kubernetes et passionn\u00e9 de CI/CD.</p> <p>Je travaillais en tant qu'ing\u00e9nieur backend \u00e0 New York et j'ai obtenu mon master CS \u00e0 SIT, en Am\u00e9rique. Croyez-le ou non, je continuerai \u00e0 \u00e9crire, de plus en plus de livres sortiront cette ann\u00e9e.</p> <p></p>"},{"location":"#to-be-continue","title":"To be continue","text":"<p>I will start working on Fintech book later on and in future, I will put more effort do finish \"Distributed Message System Book\".\ud83d\ude42</p> <p></p>"},{"location":"chap0/1monitor_tools10/","title":"1 \u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff1a10\u4e2a Kubernetes \u76d1\u63a7\u5de5\u5177","text":"<p>Kubernetes (K8s) \u662f\u5f00\u53d1\u4eba\u5458\u4e2d\u6700\u5e38\u7528\u7684\u5bb9\u5668\u7f16\u6392\u5e73\u53f0\u3002\u5b83\u81ea\u52a8\u5316\u90e8\u7f72\u3001\u6269\u5c55\u548c\u7ba1\u7406\u5bb9\u5668\u7684\u80fd\u529b\u5f7b\u5e95\u6539\u53d8\u4e86\u6211\u4eec\u5927\u89c4\u6a21\u6784\u5efa\u548c\u8fd0\u884c\u5e94\u7528\u7a0b\u5e8f\u7684\u65b9\u5f0f\u3002\u7136\u800c\uff0c\u968f\u7740 Kubernetes \u53d8\u5f97\u8d8a\u6765\u8d8a\u6d41\u884c\uff0c\u4e3a\u4e86\u63d0\u4f9b\u9ad8\u6027\u80fd\u5e94\u7528\u7a0b\u5e8f\uff0c\u5bf9\u5f3a\u5927\u7684\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\u7684\u9700\u6c42\u53d8\u5f97\u66f4\u52a0\u8feb\u5207\u3002</p> <p>\u76d1\u63a7 Kubernetes \u53ef\u4ee5\u6df1\u5165\u4e86\u89e3\u96c6\u7fa4\u548c\u5e94\u7528\u7a0b\u5e8f\u7684\u8fd0\u884c\u72b6\u51b5\u3001\u6027\u80fd\u548c\u8d44\u6e90\u5229\u7528\u7387\u3002\u5b83\u4f7f\u5f00\u53d1\u4eba\u5458\u80fd\u591f\u4e3b\u52a8\u8bc6\u522b\u74f6\u9888\u3001\u89e3\u51b3\u95ee\u9898\u5e76\u786e\u4fdd\u5bb9\u5668\u5316\u57fa\u7840\u8bbe\u65bd\u7684\u6700\u4f73\u72b6\u6001\u3002</p> <p>\u56e0\u6b64\uff0c\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5c06\u8ba8\u8bba\u5341\u5927 Kubernetes \u76d1\u63a7\u5de5\u5177\u53ca\u5176\u529f\u80fd\uff0c\u4ee5\u5e2e\u52a9\u60a8\u63d0\u9ad8\u57fa\u4e8e Kubernetes \u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u6027\u80fd\u3002</p>"},{"location":"chap0/1monitor_tools10/#1-helios","title":"1 Helios","text":"<p>Helios\u662f\u4e13\u95e8\u4e3a \u5206\u5e03\u5f0f\u73af\u5883 \u8bbe\u8ba1\u7684\u7efc\u5408\u76d1\u63a7\u5de5\u5177\u3002</p> <p>\u5b83\u4e3a\u57fa\u4e8e Kubernetes \u7684\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u5f3a\u5927\u7684\u76d1\u63a7\u529f\u80fd\u548c\u7aef\u5230\u7aef\u53ef\u89c1\u6027\uff0c\u4ee5\u6709\u6548\u8ddf\u8e2a\u548c\u7ba1\u7406\u5176\u6027\u80fd\u3002</p> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528Helios OpenTelemetry SDK\u8f7b\u677e\u5c06 Helios \u5b89\u88c5\u5230 Kubernetes \u96c6\u7fa4\u3002</p>"},{"location":"chap0/1monitor_tools10/#helios","title":"Helios\u7684\u7279\u70b9","text":"<ul> <li>\u4e3a\u590d\u6742\u7684\u540c\u6b65\u548c\u5f02\u6b65\u6d41\uff08\u4f8b\u5982 HTTP \u8bf7\u6c42\u548c\u4e8b\u4ef6\u6d41\uff09\u63d0\u4f9b\u53ef\u89c6\u5316\u3002</li> <li>\u63d0\u4f9b\u6574\u4e2a\u7cfb\u7edf\u7684\u5355\u4e00\u6982\u8ff0\u3002</li> <li>\u901a\u8fc7\u5206\u6790\u6709\u6548\u8d1f\u8f7d\u548c\u9519\u8bef\u6570\u636e\u5e2e\u52a9\u8bc6\u522b\u6027\u80fd\u74f6\u9888\u3002</li> <li>Lambda \u8c03\u7528\u7684\u5de5\u4f5c\u6d41\u7a0b\u91cd\u65b0\u521b\u5efa\u3002HTTP \u8bf7\u6c42\u3001Kafka \u548c RabbitMQ \u6d88\u606f\u3002</li> <li>\u652f\u6301\u4e0e\u73b0\u6709\u65e5\u5fd7\u3001\u6d4b\u8bd5\u3001\u9519\u8bef\u76d1\u63a7\u7b49\u8f7b\u677e\u96c6\u6210\u3002</li> <li>\u652f\u6301\u591a\u79cd\u8bed\u8a00\uff0c\u5305\u62ecPython\u3001JavaScript\u3001Node.js\u3001Java\u3001Ruby\u3001.NET\u3001Go\u3001C++\u548cCollector\u3002</li> </ul>"},{"location":"chap0/1monitor_tools10/#2-prometheus","title":"2 Prometheus","text":"<p>Prometheus\u662f\u4e00\u4e2a\u5f00\u6e90\u76d1\u63a7\u548c\u8b66\u62a5\u5de5\u5177\u5305\uff0c\u4e13\u4e3a Kubernetes \u7b49\u52a8\u6001\u4e91\u539f\u751f\u73af\u5883\u800c\u8bbe\u8ba1\u3002\u5b83\u63d0\u4f9b\u4e86\u6709\u5173 Kubernetes \u96c6\u7fa4\u7684\u8fd0\u884c\u72b6\u51b5\u548c\u6027\u80fd\u7684\u5b9d\u8d35\u89c1\u89e3\u3002\u4f7f\u7528 Prometheus\uff0c\u60a8\u53ef\u4ee5\u6709\u6548\u5730\u76d1\u63a7\u548c\u5206\u6790\u5404\u79cd\u6307\u6807\uff0c\u4f8b\u5982 Pod\u3001\u8282\u70b9\u548c\u5bb9\u5668\u7684 CPU \u548c\u5185\u5b58\u5229\u7528\u7387\u3001\u7f51\u7edc\u6d41\u91cf\u548c\u541e\u5410\u91cf\u3001Pod \u548c\u8282\u70b9\u53ef\u7528\u6027\u7b49\u3002</p>"},{"location":"chap0/1monitor_tools10/#prometheus","title":"Prometheus\u7684\u7279\u70b9","text":"<ul> <li>\u79ef\u6781\u7684\u793e\u533a\u652f\u6301\u3002</li> <li>\u6536\u96c6\u5e76\u5b58\u50a8\u7528\u4e8e\u76d1\u63a7\u6307\u6807\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u3002</li> <li>\u7528\u4e8e\u6570\u636e\u5206\u6790\u548c\u53ef\u89c6\u5316\u7684\u5f3a\u5927\u67e5\u8be2\u8bed\u8a00\u3002</li> <li>\u8b66\u62a5\u529f\u80fd\u53ef\u901a\u77e5\u7528\u6237\u5f02\u5e38\u60c5\u51b5\u3002</li> <li>\u4e0e Grafana \u65e0\u7f1d\u96c6\u6210\uff0c\u521b\u5efa\u76f4\u89c2\u7684\u4eea\u8868\u677f\u3002</li> </ul>"},{"location":"chap0/1monitor_tools10/#3-new-relic","title":"3 New Relic","text":"<p>New Relic\u662f\u4e00\u4e2a\u57fa\u4e8e\u4e91\u7684\u76d1\u63a7\u548c\u53ef\u89c2\u5bdf\u5e73\u53f0\uff0c\u4e3a Kubernetes \u73af\u5883\u63d0\u4f9b\u5e7f\u6cdb\u7684\u652f\u6301\u3002</p> <p>\u5b83\u4e3a Kubernetes \u96c6\u7fa4\u5185\u7684\u5e94\u7528\u7a0b\u5e8f\u3001\u5bb9\u5668\u548c\u57fa\u7840\u8bbe\u65bd\u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u76d1\u63a7\u529f\u80fd\u3002\u501f\u52a9 New Relic APM\uff0c\u60a8\u53ef\u4ee5\u8ddf\u8e2a\u96c6\u7fa4\u4e2d\u7684\u5173\u952e\u6307\u6807\uff0c\u4f8b\u5982\u54cd\u5e94\u65f6\u95f4\u3001\u541e\u5410\u91cf\u3001CPU \u5229\u7528\u7387\u548c\u9519\u8bef\u7387\uff0c\u4ee5\u8bc6\u522b\u74f6\u9888\u3001\u89e3\u51b3\u95ee\u9898\u5e76\u4f18\u5316\u6027\u80fd\u3002</p>"},{"location":"chap0/1monitor_tools10/#new-relic","title":"New Relic\u7684\u7279\u70b9","text":"<ul> <li>\u5b9e\u65f6\u6027\u80fd\u76d1\u63a7\u548c\u6545\u969c\u6392\u9664\u3002</li> <li>\u6df1\u5165\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u3001\u5bb9\u5668\u548c\u57fa\u7840\u8bbe\u65bd\u3002</li> <li>Kubernetes\u96c6\u7fa4\u7684\u81ea\u52a8\u53d1\u73b0\u548c\u6620\u5c04\u3002</li> <li>\u7528\u4e8e\u5bb9\u91cf\u89c4\u5212\u548c\u4f18\u5316\u7684\u9ad8\u7ea7\u5206\u6790\u3002</li> <li>\u63d0\u4f9b\u53ef\u5b9a\u5236\u7684\u53ef\u89c6\u5316\u6548\u679c\u3002</li> <li>\u53ef\u4ee5\u5904\u7406\u5927\u89c4\u6a21\u90e8\u7f72\u548c\u9ad8\u6570\u636e\u91cf\u3002</li> </ul>"},{"location":"chap0/1monitor_tools10/#4-grafana","title":"4 Grafana","text":"<p>Grafana\u662f\u4e00\u79cd\u6d41\u884c\u7684\u5f00\u6e90\u6570\u636e\u53ef\u89c6\u5316\u548c\u76d1\u63a7\u5de5\u5177\uff0c\u53ef\u4e0eKubernetes\u76d1\u63a7\u7cfb\u7edf\u65e0\u7f1d\u96c6\u6210\u3002\u5b83\u63d0\u4f9b\u7075\u6d3b\u7684\u67e5\u8be2\u529f\u80fd\u548c\u8fc7\u6ee4\u5668\uff0c\u5141\u8bb8\u7528\u6237\u68c0\u7d22\u6709\u5173 Kubernetes \u96c6\u7fa4\u7684\u7279\u5b9a\u6570\u636e\uff0c\u4ee5\u83b7\u5f97\u66f4\u6df1\u5165\u7684\u4e86\u89e3\u3002</p>"},{"location":"chap0/1monitor_tools10/#grafana","title":"Grafana\u7684\u7279\u70b9","text":"<ul> <li>\u53ef\u5b9a\u5236\u7684\u4eea\u8868\u677f\uff0c\u7528\u4e8e\u53ef\u89c6\u5316\u5404\u79cd\u6765\u6e90\u7684\u6307\u6807\u3002</li> <li>\u652f\u6301\u4f17\u591a\u6570\u636e\u6e90\uff0c\u5305\u62ec Prometheus\u3001Graphite \u548c InfluxDB\u3002</li> <li>\u4e30\u5bcc\u7684\u53ef\u89c6\u5316\u9009\u9879\u96c6\uff0c\u5305\u62ec\u56fe\u5f62\u3001\u56fe\u8868\u548c\u8b66\u62a5\u3002</li> <li>\u534f\u4f5c\u5171\u4eab\u548c\u6ce8\u91ca\u529f\u80fd\u53ef\u5b9e\u73b0\u6709\u6548\u7684\u56e2\u961f\u534f\u4f5c\u3002</li> <li>\u7528\u6237\u53cb\u597d\u7684\u754c\u9762\u53ef\u4ee5\u8f7b\u677e\u5bfc\u822a\u548c\u63a2\u7d22\u6570\u636e\uff0c\u4ece\u800c\u5b9e\u73b0 Kubernetes \u96c6\u7fa4\u7684\u9ad8\u6548\u76d1\u63a7\u548c\u6545\u969c\u6392\u9664\u3002</li> </ul>"},{"location":"chap0/1monitor_tools10/#5-datadog","title":"5 DataDog","text":"<p>Datadog\u662f\u4e00\u4e2a\u4e91\u76d1\u63a7\u5e73\u53f0\uff0c\u4e3aKubernetes\u63d0\u4f9b\u5168\u9762\u7684\u76d1\u63a7\u548c\u53ef\u89c2\u5bdf\u80fd\u529b\u3002</p> <p>\u501f\u52a9 Datadog\uff0c\u60a8\u53ef\u4ee5\u6df1\u5165\u4e86\u89e3 Kubernetes \u73af\u5883\uff0c\u4ece\u800c\u76d1\u63a7\u5e94\u7528\u7a0b\u5e8f\u3001\u5bb9\u5668\u548c\u57fa\u7840\u8bbe\u65bd\u7684\u6027\u80fd\u548c\u8fd0\u884c\u72b6\u51b5\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u76d1\u63a7\u529f\u80fd\u548c\u5de5\u5177\uff0c\u53ef\u5e2e\u52a9\u60a8\u6709\u6548\u8bc6\u522b\u548c\u89e3\u51b3\u95ee\u9898\uff0c\u786e\u4fdd Kubernetes \u96c6\u7fa4\u7684\u987a\u5229\u8fd0\u884c</p>"},{"location":"chap0/1monitor_tools10/#datadog","title":"DataDog\u7684\u7279\u70b9","text":"<ul> <li>\u5b9e\u65f6\u6307\u6807\u3001\u65e5\u5fd7\u548c\u8ddf\u8e2a\u53ef\u89c6\u5316\u3002</li> <li>\u81ea\u52a8\u53d1\u73b0\u548c\u76d1\u63a7 Kubernetes \u7ec4\u4ef6\u3002</li> <li>\u5f02\u5e38\u68c0\u6d4b\u548c\u8b66\u62a5\u4ee5\u4e3b\u52a8\u54cd\u5e94\u4e8b\u4ef6\u3002</li> <li>\u4e0e\u6d41\u884c\u7684 CI/CD \u548c\u81ea\u52a8\u5316\u5de5\u5177\u65e0\u7f1d\u96c6\u6210\u3002</li> <li>\u53ef\u5b9a\u5236\u7684\u4ea4\u4e92\u5f0f\u4eea\u8868\u677f\u3002</li> </ul>"},{"location":"chap0/1monitor_tools10/#6-sysdig","title":"6 Sysdig","text":"<p>Sysdig\u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u5bb9\u5668\u667a\u80fd\u5e73\u53f0\uff0c\u53ef\u5bf9 Kubernetes \u73af\u5883\u8fdb\u884c\u76d1\u63a7\u548c\u6545\u969c\u6392\u9664\u3002</p> <p>\u501f\u52a9 Sysdig\uff0c\u60a8\u53ef\u4ee5\u83b7\u5f97\u6709\u5173\u5bb9\u5668\u3001Pod \u548c\u96c6\u7fa4\u7684\u6027\u80fd\u548c\u8fd0\u884c\u72b6\u51b5\u7684\u5b9d\u8d35\u89c1\u89e3\u3002\u5b83\u63d0\u4f9b\u5b9e\u65f6\u76d1\u63a7\u548c\u5206\u6790\uff0c\u4f7f\u60a8\u80fd\u591f\u5feb\u901f\u8bc6\u522b\u548c\u89e3\u51b3\u5f71\u54cd Kubernetes \u57fa\u7840\u8bbe\u65bd\u7684\u95ee\u9898\u3002</p>"},{"location":"chap0/1monitor_tools10/#sysdig","title":"Sysdig \u7684\u7279\u70b9","text":"<ul> <li>\u6df1\u5165\u7684\u5bb9\u5668\u53ef\u89c1\u6027\uff0c\u5305\u62ec\u7f51\u7edc\u6d3b\u52a8\u548c\u7cfb\u7edf\u8c03\u7528\u3002</li> <li>\u6301\u7eed\u76d1\u63a7\u5bb9\u5668\u3001pod \u548c\u96c6\u7fa4\u3002</li> <li>\u901a\u8fc7\u6df1\u5165\u7684\u5bb9\u5668\u6d1e\u5bdf\u8fdb\u884c\u9ad8\u7ea7\u6545\u969c\u6392\u9664\u3002</li> <li>\u8fd0\u884c\u65f6\u5b89\u5168\u76d1\u63a7\u548c\u5408\u89c4\u6027\u68c0\u67e5\u3002</li> </ul>"},{"location":"chap0/1monitor_tools10/#7-zabbix","title":"7 Zabbix","text":"<p>Zabbix\u662f\u4e00\u4e2a\u4f01\u4e1a\u7ea7\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff0c\u63d0\u4f9b\u5f3a\u5927\u7684 Kubernetes \u96c6\u7fa4\u76d1\u63a7\u529f\u80fd\u3002</p> <p>\u501f\u52a9 Zabbix\uff0c\u60a8\u53ef\u4ee5\u6709\u6548\u76d1\u63a7 Kubernetes \u73af\u5883\u7684\u8fd0\u884c\u72b6\u51b5\u548c\u6027\u80fd\u3002\u6b64\u5916\uff0c\u60a8\u8fd8\u53ef\u4ee5\u4f7f\u7528 Zabbiz \u76d1\u63a7\u6574\u4e2a IT \u57fa\u7840\u8bbe\u65bd\uff0c\u5305\u62ec\u7f51\u7edc\u3001\u670d\u52a1\u5668\u3001\u4e91\u670d\u52a1\u548c\u5e94\u7528\u7a0b\u5e8f\u3002</p>"},{"location":"chap0/1monitor_tools10/#zabbix","title":"Zabbix\u7684\u7279\u70b9","text":"<ul> <li>\u57fa\u4e8e\u4ee3\u7406\u7684\u76d1\u63a7\uff0c\u7528\u4e8e\u6536\u96c6\u6307\u6807\u548c\u6027\u80fd\u6570\u636e\u3002</li> <li>\u7075\u6d3b\u4e14\u53ef\u5b9a\u5236\u7684\u8b66\u62a5\u548c\u901a\u77e5\u673a\u5236\u3002</li> <li>\u7528\u4e8e\u4f18\u5316\u8d44\u6e90\u914d\u7f6e\u7684\u5bb9\u91cf\u89c4\u5212\u548c\u8d8b\u52bf\u5206\u6790\u3002</li> <li>\u5e7f\u6cdb\u7684\u62a5\u544a\u548c\u53ef\u89c6\u5316\u9009\u9879\u3002</li> <li>\u652f\u6301\u4e3b\u8981\u4e91\u670d\u52a1\u63d0\u4f9b\u5546\u7684\u4e91\u90e8\u7f72\uff0c\u5305\u62ec AWS\u3001GCP \u548c Digitel Ocean\u3002</li> <li>\u9ad8\u53ef\u7528\u6027\u3002</li> </ul>"},{"location":"chap0/1monitor_tools10/#8-appdynamics","title":"8 AppDynamics","text":"<p>AppDynamics\u662f\u4e00\u6b3e\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u76d1\u63a7\u5de5\u5177\uff0c\u65e8\u5728\u63d0\u4f9b\u5bf9\u57fa\u4e8e Kubernetes \u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5168\u9762\u53ef\u89c1\u6027\u3002AppDynamics \u4f7f\u60a8\u80fd\u591f\u4e3b\u52a8\u76d1\u63a7\u548c\u89e3\u51b3\u6f5c\u5728\u95ee\u9898\uff0c\u786e\u4fdd Kubernetes \u90e8\u7f72\u7684\u987a\u5229\u8fd0\u884c\u3002\u6b64\u5916\uff0c\u5b83\u8fd8\u63d0\u4f9b\u53ef\u89c6\u5316\u529f\u80fd\uff0c\u53ef\u4ee5\u8f7b\u677e\u76d1\u63a7 Kubernetes \u96c6\u7fa4\u7684\u53ef\u7528\u6027\u3001\u6027\u80fd\u548c\u4f9d\u8d56\u6027\u3002</p>"},{"location":"chap0/1monitor_tools10/#appdynamics","title":"AppDynamics\u7684\u7279\u70b9","text":"<ul> <li>\u81ea\u52a8\u53d1\u73b0\u548c\u6620\u5c04\u5e94\u7528\u7a0b\u5e8f\u4f9d\u8d56\u9879\u3002</li> <li>\u7528\u4e8e\u8bc6\u522b\u6027\u80fd\u74f6\u9888\u7684\u4ee3\u7801\u7ea7\u89c1\u89e3\u3002</li> <li>\u5b9e\u65f6\u4e1a\u52a1\u5f71\u54cd\u5206\u6790\uff0c\u786e\u5b9a\u95ee\u9898\u7684\u4f18\u5148\u7ea7\u3002</li> <li>\u4e3b\u52a8\u5f02\u5e38\u68c0\u6d4b\u548c\u6839\u672c\u539f\u56e0\u5206\u6790\u3002</li> <li>\u4eba\u5de5\u667a\u80fd\u8f85\u52a9\u8b66\u62a5\u3002</li> <li>\u63d0\u4f9b\u6709\u5173\u57fa\u7840\u8bbe\u65bd\u8fd0\u884c\u72b6\u51b5\u5982\u4f55\u5f71\u54cd Kubernetes \u73af\u5883\u7684\u76f8\u5173\u6027\u3002</li> </ul>"},{"location":"chap0/1monitor_tools10/#9-dynatrace","title":"9 Dynatrace","text":"<p>Dynatrace\u662f\u4e00\u4e2a\u5148\u8fdb\u7684\u53ef\u89c2\u5bdf\u6027\u5e73\u53f0\uff0c\u4e3a Kubernetes \u73af\u5883\u63d0\u4f9b\u5168\u9762\u7684\u76d1\u63a7\u548c\u7ba1\u7406\u529f\u80fd\u3002\u5b83\u63d0\u4f9b\u5bf9\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u7684\u81ea\u52a8\u76d1\u63a7\u548c\u53d1\u73b0\uff0c\u4f7f\u60a8\u80fd\u591f\u4e86\u89e3\u5b83\u4eec\u7684\u884c\u4e3a\u548c\u4f9d\u8d56\u5173\u7cfb\u3002\u5176\u7aef\u5230\u7aef\u4e8b\u52a1\u8ddf\u8e2a\u529f\u80fd\u5141\u8bb8\u60a8\u8ddf\u8e2a\u548c\u4f18\u5316\u5e94\u7528\u7a0b\u5e8f\u7684\u6027\u80fd\u3002</p>"},{"location":"chap0/1monitor_tools10/#dynatrace","title":"Dynatrace \u7684\u7279\u70b9","text":"<ul> <li>\u52a8\u6001\u5fae\u670d\u52a1\u7684\u81ea\u52a8\u76d1\u63a7\u548c\u53d1\u73b0\u3002</li> <li>\u4eba\u5de5\u667a\u80fd\u9a71\u52a8\u7684\u95ee\u9898\u8bc6\u522b\u548c\u6839\u672c\u539f\u56e0\u5206\u6790\u3002</li> <li>\u7cbe\u786e\u7684\u7aef\u5230\u7aef\u4e8b\u52a1\u8ddf\u8e2a\u4ee5\u4f18\u5316\u6027\u80fd\u3002</li> <li>\u81ea\u52a8\u5bb9\u91cf\u89c4\u5212\u548c\u81ea\u52a8\u6269\u5c55\u5efa\u8bae\u3002</li> </ul>"},{"location":"chap0/1monitor_tools10/#10-sensu","title":"10 Sensu","text":"<p>Sensu\u662f\u4e00\u4e2a\u9002\u7528\u4e8e Kubernetes \u548c\u5176\u4ed6\u4e91\u539f\u751f\u67b6\u6784\u7684\u5f00\u6e90\u76d1\u63a7\u6846\u67b6\u3002\u5b83\u63d0\u4f9b\u4e86\u7075\u6d3b\u4e14\u53ef\u6269\u5c55\u7684\u76d1\u63a7\u65b9\u6cd5\uff0c\u5141\u8bb8\u60a8\u4f7f\u7528\u4ee3\u7406\u548c\u65e0\u4ee3\u7406\u9009\u9879\u6765\u76d1\u63a7 Kubernetes \u73af\u5883\u3002</p> <p>Sensu\u7684\u67b6\u6784\u901a\u8fc7\u5176\u5206\u5e03\u5f0f\u8bbe\u8ba1\u786e\u4fdd\u4e86\u9ad8\u53ef\u7528\u6027\u548c\u5bb9\u9519\u80fd\u529b\u3002</p>"},{"location":"chap0/1monitor_tools10/#sensu","title":"Sensu\u7684\u7279\u70b9","text":"<ul> <li>\u9488\u5bf9\u6df7\u5408\u6216\u591a\u4e91 Kubernetes \u73af\u5883\u7684\u591a\u4e91\u76d1\u63a7\u3002</li> <li>\u81ea\u52a8\u5316 DevOps \u7ba1\u9053\u3002</li> <li>\u5206\u5e03\u5f0f\u67b6\u6784\uff0c\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\u548c\u5bb9\u9519\u80fd\u529b\u3002</li> <li>\u5e7f\u6cdb\u7684\u96c6\u6210\u548c\u63d2\u4ef6\u652f\u6301\u3002</li> <li>\u5b9a\u5236\u76d1\u63a7\u5de5\u4f5c\u6d41\u7a0b\u3002</li> </ul>"},{"location":"chap1/10kube-state-metrics-cluster-opt/","title":"\u7b2c\u5341\u8282 kube-state-metrics \u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u4e0b\u7684\u4f18\u5316(2023)","text":"<p>\u5f53\u6211\u4eec\u4f7f\u7528 Prometheus \u6765\u76d1\u63a7 Kubernetes \u96c6\u7fa4\u7684\u65f6\u5019\uff0ckube-state-metrics\uff08KSM\uff09 \u57fa\u672c\u5c5e\u4e8e\u4e00\u4e2a\u5fc5\u5907\u7ec4\u4ef6\uff0c\u5b83\u901a\u8fc7 Watch APIServer \u6765\u751f\u6210\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u6307\u6807\uff0c\u5b83\u5e76\u4e0d\u4f1a\u5173\u6ce8\u5355\u4e2a Kubernetes \u7ec4\u4ef6\u7684\u5065\u5eb7\u72b6\u51b5\uff0c\u800c\u662f\u5173\u6ce8\u5404\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u5065\u5eb7\u72b6\u6001\uff0c\u6bd4\u5982 Deployment\u3001Node\u3001Pod\u3001Ingress\u3001Job\u3001Service \u7b49\u7b49\uff0c\u6bcf\u79cd\u8d44\u6e90\u5bf9\u8c61\u4e2d\u5305\u542b\u4e86\u9700\u8981\u6307\u6807\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u5b98\u65b9\u6587\u6863 https://github.com/kubernetes/kube-state-metrics/tree/main/docs \u5904\u8fdb\u884c\u67e5\u770b\u3002</p> <p>\u8981\u5b89\u88c5 KSM \u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u4ee3\u7801\u4ed3\u5e93\u4e2d\u5c31\u5305\u542b\u4e86\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u4f46\u662f\u5728\u5b89\u88c5\u7684\u65f6\u5019\u8bb0\u5f97\u8981\u548c\u4f60\u7684 K8s \u96c6\u7fa4\u7248\u672c\u5bf9\u5e94</p> <p></p> <p>\u6211\u8fd9\u91cc\u7684\u6d4b\u8bd5\u96c6\u7fa4\u662f v1.25 \u7248\u672c\u7684\uff0c\u6240\u4ee5\u6211\u5148\u5207\u6362\u5230\u8be5\u5206\u652f\uff1a</p> <pre><code>$ git clone https://github.com/kubernetes/kube-state-metrics &amp;&amp; cd kube-state-metrics\n$ git checkout v2.7.0\n$ kubectl apply -f examples/standard\n</code></pre> <p>\u8be5\u65b9\u5f0f\u4f1a\u4ee5 Deployment \u65b9\u5f0f\u90e8\u7f72\u4e00\u4e2a KSM \u5b9e\u4f8b\uff1a</p> <pre><code>$ kubectl get deploy -n kube-system kube-state-metrics\nNAME                 READY   UP-TO-DATE   AVAILABLE   AGE\nkube-state-metrics   1/1     1            1           2m49s\n$ kubectl get pods -n kube-system -l app.kubernetes.io/name=kube-state-metrics\nNAME                                  READY   STATUS    RESTARTS   AGE\nkube-state-metrics-548546fc89-zgkx5   1/1     Running   0          2m51s\n</code></pre> <p>\u7136\u540e\u53ea\u9700\u8981\u8ba9 Prometheus \u6765\u53d1\u73b0 KSM \u5b9e\u4f8b\u5c31\u53ef\u4ee5\u4e86\uff0c\u5f53\u7136\u6709\u5f88\u591a\u65b9\u5f0f\uff0c\u6bd4\u5982\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u6ce8\u89e3\u6765\u81ea\u52a8\u53d1\u73b0\uff0c\u4e5f\u53ef\u4ee5\u5355\u72ec\u4e3a KSM \u521b\u5efa\u4e00\u4e2a\u72ec\u7acb\u7684 Job\uff0c\u5982\u679c\u4f7f\u7528\u7684\u662f Prometheus Operator\uff0c\u4e5f\u53ef\u4ee5\u521b\u5efa ServiceMonitor \u5bf9\u8c61\u6765\u83b7\u53d6 KSM \u6307\u6807\u6570\u636e\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u5bf9\u4e8e\u5c0f\u89c4\u6a21\u96c6\u7fa4\u662f\u6ca1\u592a\u5927\u95ee\u9898\u7684\uff0c\u6570\u636e\u91cf\u4e0d\u5927\uff0c\u53ef\u4ee5\u6b63\u5e38\u63d0\u4f9b\u670d\u52a1\uff0c\u53ea\u9700\u8981\u4fdd\u8bc1 KSM \u9ad8\u53ef\u7528\u5c31\u53ef\u4ee5\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u4e86\u3002\u4f46\u662f\u5bf9\u4e8e\u5927\u89c4\u6a21\u7684\u96c6\u7fa4\u6765\u8bf4\uff0c\u5c31\u975e\u5e38\u56f0\u96be\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6709\u4e00\u4e2a 8K \u5de6\u53f3 Pod \u7684\u96c6\u7fa4\uff0c\u4e0d\u7b97\u7279\u522b\u5927\u3002</p> <p></p> <p>\u4f46\u662f\u53ea\u901a\u8fc7\u4e00\u4e2a KSM \u5b9e\u4f8b\u6765\u63d0\u4f9b metrics \u6307\u6807\u8fd8\u662f\u975e\u5e38\u5403\u529b\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ef\u80fd\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\u662f\u83b7\u53d6\u4e0d\u5230\u6307\u6807\u7684\uff0c\u56e0\u4e3a metrics \u63a5\u53e3\u91cc\u9762\u7684\u6570\u636e\u91cf\u592a\u5927\u4e86\u3002</p> <p></p> <p>\u5373\u4f7f\u5076\u5c14\u83b7\u53d6\u5230\u4e86\uff0c\u4e5f\u9700\u8981\u8bdd\u82b1\u5f88\u957f\u65f6\u95f4\uff0c\u8981\u77e5\u9053\u6211\u4eec\u4f1a\u6bcf\u9694 <code>scrape_interval</code>\u7684\u65f6\u95f4\u90fd\u4f1a\u53bb\u8bbf\u95ee\u8be5\u6307\u6807\u63a5\u53e3\u7684\uff0c\u53ef\u80fd\u524d\u9762\u4e00\u6b21\u8bf7\u6c42\u8fd8\u6ca1\u7ed3\u675f\uff0c\u4e0b\u4e00\u6b21\u8bf7\u6c42\u53c8\u53d1\u8d77\u4e86\uff0c\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u5c31\u5f97\u4ece KSM \u7aef\u5165\u624b\u89e3\u51b3\uff0c\u5728 KSM \u7684\u542f\u52a8\u53c2\u6570\u4e2d\u6211\u4eec\u53ef\u4ee5\u914d\u7f6e\u8fc7\u6ee4\u6389\u4e00\u4e9b\u4e0d\u9700\u8981\u7684\u6307\u6807\u6807\u7b7e\uff1a</p> <pre><code>$ kube-state-metrics -h\nkube-state-metrics is a simple service that listens to the Kubernetes API server and generates metrics about the state of the objects.\n\nUsage:\n  kube-state-metrics [flags]\n  kube-state-metrics [command]\n\nAvailable Commands:\n  completion  Generate completion script for kube-state-metrics.\n  help        Help about any command\n  version     Print version information.\n\nFlags:\n      --add_dir_header                             If true, adds the file directory to the header of the log messages\n      --alsologtostderr                            log to standard error as well as files (no effect when -logtostderr=true)\n      --apiserver string                           The URL of the apiserver to use as a master\n      --config string                              Path to the kube-state-metrics options config file\n      --custom-resource-state-config string        Inline Custom Resource State Metrics config YAML (experimental)\n      --custom-resource-state-config-file string   Path to a Custom Resource State Metrics config file (experimental)\n      --custom-resource-state-only                 Only provide Custom Resource State metrics (experimental)\n      --enable-gzip-encoding                       Gzip responses when requested by clients via 'Accept-Encoding: gzip' header.\n  -h, --help                                       Print Help text\n      --host string                                Host to expose metrics on. (default \"::\")\n      --kubeconfig string                          Absolute path to the kubeconfig file\n      --log_backtrace_at traceLocation             when logging hits line file:N, emit a stack trace (default :0)\n      --log_dir string                             If non-empty, write log files in this directory (no effect when -logtostderr=true)\n      --log_file string                            If non-empty, use this log file (no effect when -logtostderr=true)\n      --log_file_max_size uint                     Defines the maximum size a log file can grow to (no effect when -logtostderr=true). Unit is megabytes. If the value is 0, the maximum file size is unlimited. (default 1800)\n      --logtostderr                                log to standard error instead of files (default true)\n      --metric-allowlist string                    Comma-separated list of metrics to be exposed. This list comprises of exact metric names and/or regex patterns. The allowlist and denylist are mutually exclusive.\n      --metric-annotations-allowlist string        Comma-separated list of Kubernetes annotations keys that will be used in the resource' labels metric. By default the metric contains only name and namespace labels. To include additional annotations provide a list of resource names in their plural form and Kubernetes annotation keys you would like to allow for them (Example: '=namespaces=[kubernetes.io/team,...],pods=[kubernetes.io/team],...)'. A single '*' can be provided per resource instead to allow any annotations, but that has severe performance implications (Example: '=pods=[*]').\n      --metric-denylist string                     Comma-separated list of metrics not to be enabled. This list comprises of exact metric names and/or regex patterns. The allowlist and denylist are mutually exclusive.\n      --metric-labels-allowlist string             Comma-separated list of additional Kubernetes label keys that will be used in the resource' labels metric. By default the metric contains only name and namespace labels. To include additional labels provide a list of resource names in their plural form and Kubernetes label keys you would like to allow for them (Example: '=namespaces=[k8s-label-1,k8s-label-n,...],pods=[app],...)'. A single '*' can be provided per resource instead to allow any labels, but that has severe performance implications (Example: '=pods=[*]'). Additionally, an asterisk (*) can be provided as a key, which will resolve to all resources, i.e., assuming '--resources=deployments,pods', '=*=[*]' will resolve to '=deployments=[*],pods=[*]'.\n      --metric-opt-in-list string                  Comma-separated list of metrics which are opt-in and not enabled by default. This is in addition to the metric allow- and denylists\n      --namespaces string                          Comma-separated list of namespaces to be enabled. Defaults to \"\"\n      --namespaces-denylist string                 Comma-separated list of namespaces not to be enabled. If namespaces and namespaces-denylist are both set, only namespaces that are excluded in namespaces-denylist will be used.\n      --node string                                Name of the node that contains the kube-state-metrics pod. Most likely it should be passed via the downward API. This is used for daemonset sharding. Only available for resources (pod metrics) that support spec.nodeName fieldSelector. This is experimental.\n      --one_output                                 If true, only write logs to their native severity level (vs also writing to each lower severity level; no effect when -logtostderr=true)\n      --pod string                                 Name of the pod that contains the kube-state-metrics container. When set, it is expected that --pod and --pod-namespace are both set. Most likely this should be passed via the downward API. This is used for auto-detecting sharding. If set, this has preference over statically configured sharding. This is experimental, it may be removed without notice.\n      --pod-namespace string                       Name of the namespace of the pod specified by --pod. When set, it is expected that --pod and --pod-namespace are both set. Most likely this should be passed via the downward API. This is used for auto-detecting sharding. If set, this has preference over statically configured sharding. This is experimental, it may be removed without notice.\n      --port int                                   Port to expose metrics on. (default 8080)\n      --resources string                           Comma-separated list of Resources to be enabled. Defaults to \"certificatesigningrequests,configmaps,cronjobs,daemonsets,deployments,endpoints,horizontalpodautoscalers,ingresses,jobs,leases,limitranges,mutatingwebhookconfigurations,namespaces,networkpolicies,nodes,persistentvolumeclaims,persistentvolumes,poddisruptionbudgets,pods,replicasets,replicationcontrollers,resourcequotas,secrets,services,statefulsets,storageclasses,validatingwebhookconfigurations,volumeattachments\"\n      --shard int32                                The instances shard nominal (zero indexed) within the total number of shards. (default 0)\n      --skip_headers                               If true, avoid header prefixes in the log messages\n      --skip_log_headers                           If true, avoid headers when opening log files (no effect when -logtostderr=true)\n      --stderrthreshold severity                   logs at or above this threshold go to stderr when writing to files and stderr (no effect when -logtostderr=true or -alsologtostderr=false) (default 2)\n      --telemetry-host string                      Host to expose kube-state-metrics self metrics on. (default \"::\")\n      --telemetry-port int                         Port to expose kube-state-metrics self metrics on. (default 8081)\n      --tls-config string                          Path to the TLS configuration file\n      --total-shards int                           The total number of shards. Sharding is disabled when total shards is set to 1. (default 1)\n      --use-apiserver-cache                        Sets resourceVersion=0 for ListWatch requests, using cached resources from the apiserver instead of an etcd quorum read.\n  -v, --v Level                                    number for the log level verbosity\n      --vmodule moduleSpec                         comma-separated list of pattern=N settings for file-filtered logging\n\nUse \"kube-state-metrics [command] --help\" for more information about a command.\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7 <code>--metric-allowlist</code> \u6216\u8005 <code>--metric-denylist</code> \u53c2\u6570\u8fdb\u884c\u8fc7\u6ee4\u3002\u4f46\u662f\u5982\u679c\u5373\u4f7f\u8fc7\u6ee4\u4e86\u4e0d\u9700\u8981\u7684\u6307\u6807\u6216\u6807\u7b7e\u540e\u6307\u6807\u63a5\u53e3\u6570\u636e\u4ecd\u7136\u975e\u5e38\u5927\u53c8\u8be5\u600e\u4e48\u529e\u5462\uff1f</p> <p>\u5176\u5b9e\u6211\u4eec\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\uff0c\u65e0\u8bba\u600e\u4e48\u8fc7\u6ee4\uff0c\u8bf7\u6c42\u4e00\u6b21\u5230\u8fbe metrics \u63a5\u53e3\u540e\u7684\u6570\u636e\u91cf\u90fd\u662f\u975e\u5e38\u5927\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u662f\u4e0d\u662f\u53ea\u80fd\u5bf9\u6307\u6807\u6570\u636e\u8fdb\u884c\u62c6\u5206\u4e86\uff0c\u53ef\u4ee5\u90e8\u7f72\u591a\u4e2a KSM \u5b9e\u4f8b\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u63d0\u4f9b\u4e00\u90e8\u5206\u63a5\u53e3\u6570\u636e\uff0c\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u7f13\u89e3\u538b\u529b\u4e86\uff0c\u8fd9\u5176\u5b9e\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u6c34\u5e73\u5206\u7247\u3002</p> <p>\u4e3a\u4e86\u6c34\u5e73\u5206\u7247 <code>kube-state-metrics</code>\uff0c\u5b83\u5df2\u7ecf\u5b9e\u73b0\u4e86\u4e00\u4e9b\u81ea\u52a8\u5206\u7247\u529f\u80fd\uff0c\u5b83\u662f\u901a\u8fc7\u4ee5\u4e0b\u6807\u5fd7\u8fdb\u884c\u914d\u7f6e\u7684\uff1a</p> <ul> <li><code>--shard</code> (\u4ece 0 \u5f00\u59cb)</li> <li><code>--total-shards</code></li> </ul> <p>\u5206\u7247\u662f\u901a\u8fc7\u5bf9 Kubernetes \u5bf9\u8c61\u7684 UID \u8fdb\u884c MD5 \u54c8\u5e0c\u548c\u5bf9\u603b\u5206\u7247\u6570\u8fdb\u884c\u53d6\u6a21\u8fd0\u7b97\u6765\u5b8c\u6210\u7684\uff0c\u6bcf\u4e2a\u5206\u7247\u51b3\u5b9a\u662f\u5426\u7531 <code>kube-state-metrics</code> \u7684\u76f8\u5e94\u5b9e\u4f8b\u5904\u7406\u5bf9\u8c61\u3002</p> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c<code>kube-state-metrics</code> \u7684\u6240\u6709\u5b9e\u4f8b\uff0c\u5373\u4f7f\u5df2\u7ecf\u5206\u7247\uff0c\u4e5f\u4f1a\u5904\u7406\u6240\u6709\u5bf9\u8c61\u7684\u7f51\u7edc\u6d41\u91cf\u548c\u8d44\u6e90\u6d88\u8017\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662f\u4ed6\u4eec\u8d1f\u8d23\u90a3\u90e8\u5206\u5bf9\u8c61\uff0c\u8981\u4f18\u5316\u8fd9\u4e2a\u95ee\u9898\uff0cKubernetes API \u9700\u8981\u652f\u6301\u5206\u7247\u7684 list/watch \u529f\u80fd\u3002</p> <p>\u5728\u6700\u7406\u60f3\u7684\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u5206\u7247\u7684\u5185\u5b58\u6d88\u8017\u5c06\u6bd4\u672a\u5206\u7247\u8bbe\u7f6e\u5c11 1/n\u3002</p> <p>\u901a\u5e38\uff0c\u4e3a\u4e86\u4f7f kube-state-metrics \u80fd\u591f\u8fc5\u901f\u8fd4\u56de\u5176\u6307\u6807\u7ed9 Prometheus\uff0c\u9700\u8981\u8fdb\u884c\u5185\u5b58\u548c\u5ef6\u8fdf\u4f18\u5316\u3002</p> <p>\u51cf\u5c11 <code>kube-state-metrics</code> \u548c <code>kube-apiserver</code>\u4e4b\u95f4\u7684\u5ef6\u8fdf\u7684\u4e00\u79cd\u65b9\u6cd5\u662f\u4f7f\u7528 <code>--use-apiserver-cache</code> \u6807\u5fd7\u8fd0\u884c <code>KSM</code>\uff0c\u9664\u4e86\u51cf\u5c11\u5ef6\u8fdf\uff0c\u8fd9\u4e2a\u9009\u9879\u8fd8\u5c06\u5bfc\u81f4\u51cf\u5c11\u5bf9 etcd \u7684\u8d1f\u8f7d\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u662f\u5efa\u8bae\u542f\u7528\u8be5\u53c2\u6570\u7684</p> <p>\u5f53\u7136\u5982\u679c\u4f7f\u7528\u4e86\u5206\u7247\u6a21\u5f0f\uff0c\u5219\u6700\u597d\u5bf9\u5206\u7247\u76f8\u5173\u6307\u6807\u8fdb\u884c\u76d1\u63a7\uff0c\u4ee5\u786e\u4fdd\u5206\u7247\u8bbe\u7f6e\u7b26\u5408\u9884\u671f\uff0c\u53ef\u4ee5\u7528\u4e0b\u9762\u4e24\u4e2a\u62a5\u8b66\u89c4\u5219\u6765\u8fdb\u884c\u62a5\u8b66\uff1a</p> <pre><code>- alert: KubeStateMetricsShardingMismatch\n    annotations:\n      description: kube-state-metrics pods are running with different --total-shards configuration, some Kubernetes objects may be exposed multiple times or not exposed at all.\n      summary: kube-state-metrics sharding is misconfigured.\n    expr: |\n      stdvar (kube_state_metrics_total_shards{job=\"kube-state-metrics\"}) != 0\n    for: 15m\n    labels:\n      severity: critical\n- alert: KubeStateMetricsShardsMissing\n  annotations:\n    description: kube-state-metrics shards are missing, some Kubernetes objects are not being exposed.\n    summary: kube-state-metrics shards are missing.\n  expr: |\n    2^max(kube_state_metrics_total_shards{job=\"kube-state-metrics\"}) - 1\n      -\n    sum( 2 ^ max by (shard_ordinal) (kube_state_metrics_shard_ordinal{job=\"kube-state-metrics\"}) )\n    != 0\n  for: 15m\n  labels:\n    severity: critical\n</code></pre> <p>\u7531\u4e8e\u624b\u52a8\u53bb\u914d\u7f6e\u5206\u7247\u53ef\u80fd\u4f1a\u51fa\u73b0\u9519\u8bef\uff0c\u6240\u4ee5 KSM \u4e5f\u63d0\u4f9b\u4e86\u81ea\u52a8\u5206\u7247\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u8fc7 StatefulSet \u65b9\u5f0f\u6765\u90e8\u7f72\u591a\u4e2a\u526f\u672c\u7684 KSM\uff0c\u81ea\u52a8\u5206\u7247\u5141\u8bb8\u6bcf\u4e2a\u5206\u7247\u5728 StatefulSet \u4e2d\u90e8\u7f72\u65f6\u53d1\u73b0\u5176\u5b9e\u4f8b\u4f4d\u7f6e\uff0c\u8fd9\u5bf9\u4e8e\u81ea\u52a8\u914d\u7f6e\u5206\u7247\u975e\u5e38\u6709\u7528\u3002</p> <p>\u6240\u4ee5\u8981\u542f\u7528\u81ea\u52a8\u5206\u7247\uff0c\u5fc5\u987b\u901a\u8fc7 <code>StatefulSet</code> \u8fd0\u884c <code>kube-state-metrics</code>\uff0c\u5e76\u901a\u8fc7 <code>--pod</code> \u548c <code>--pod-namespace</code>\u6807\u5fd7\u5c06 pod \u540d\u79f0\u548c\u547d\u540d\u7a7a\u95f4\u4f20\u9012\u7ed9 <code>kube-state-metrics</code> \u8fdb\u7a0b\uff0c\u5982\u4e0b\u6240\u793a</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: kube-state-metrics\n  namespace: kube-system\nspec:\n  replicas: 10\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: kube-state-metrics\n  serviceName: kube-state-metrics\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/component: exporter\n        app.kubernetes.io/name: kube-state-metrics\n        app.kubernetes.io/version: 2.8.0\n    spec:\n      automountServiceAccountToken: true\n      containers:\n      - args:\n        - --pod=$(POD_NAME)\n        - --pod-namespace=$(POD_NAMESPACE)\n        env:\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: POD_NAMESPACE\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.namespace\n        image: registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.8.0\n        # ......\n</code></pre> <p>\u4f7f\u7528\u8fd9\u79cd\u90e8\u7f72\u5206\u7247\u7684\u65b9\u6cd5\uff0c\u5f53\u4f60\u60f3\u8981\u901a\u8fc7\u5355\u4e2a Kubernetes \u8d44\u6e90\uff08\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u4e3a\u5355\u4e2a StatefulSet\uff09\u7ba1\u7406 KSM \u5206\u7247\u65f6\u662f\u5f88\u6709\u7528\u7684\uff0c\u800c\u4e0d\u662f\u6bcf\u4e2a\u5206\u7247\u90fd\u6709\u4e00\u4e2a Deployment\uff0c\u8fd9\u79cd\u4f18\u52bf\u5728\u90e8\u7f72\u5927\u91cf\u5206\u7247\u65f6\u5c24\u4e3a\u663e\u7740\u3002</p> <p>\u5f53\u7136\u4f7f\u7528\u81ea\u52a8\u5206\u7247\u7684\u90e8\u7f72\u65b9\u5f0f\u4e5f\u662f\u6709\u7f3a\u70b9\u7684\uff0c\u4e3b\u8981\u662f\u6765\u81ea\u4e8e StatefulSet \u652f\u6301\u7684\u6eda\u52a8\u5347\u7ea7\u7b56\u7565\uff0c\u5f53\u7531 StatefulSet \u7ba1\u7406\u65f6\uff0c\u4e00\u4e2a\u4e00\u4e2a\u5730\u66ff\u6362 pod\uff0c\u5f53 pod \u5148\u88ab\u7ec8\u6b62\u540e\uff0c\u7136\u540e\u518d\u91cd\u65b0\u521b\u5efa\uff0c\u8fd9\u6837\u7684\u5347\u7ea7\u901f\u5ea6\u8f83\u6162\uff0c\u4e5f\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6bcf\u4e2a\u5206\u7247\u7684\u77ed\u6682\u505c\u673a\uff0c\u5982\u679c\u5728\u5347\u7ea7\u671f\u95f4\u8fdb\u884c Prometheus \u6293\u53d6\uff0c\u5219\u53ef\u80fd\u4f1a\u9519\u8fc7 kube-state-metrics \u5bfc\u51fa\u7684\u67d0\u4e9b\u6307\u6807\u3002</p> <p>\u81ea\u52a8\u5206\u7247\u529f\u80fd\u7684\u793a\u4f8b\u6e05\u5355\u5728 <code>examples/autosharding</code> \u76ee\u5f55\u4e2d\u53ef\u4ee5\u627e\u5230\uff0c\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u90e8\u7f72\uff1a</p> <pre><code>$ kubectl apply -k examples/autosharding\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4ee5 StatefulSet \u65b9\u5f0f\u90e8\u7f72 2 \u4e2a KSM \u5b9e\u4f8b\uff1a</p> <pre><code>$ kubectl get pods -n kube-system -l app.kubernetes.io/name=kube-state-metrics\nNAME                   READY   STATUS             RESTARTS   AGE\nkube-state-metrics-0   1/1     Running            0          70m\nkube-state-metrics-1   1/1     Running            0          65m\n</code></pre> <p>\u53ef\u4ee5\u968f\u4fbf\u67e5\u770b\u4e00\u4e2a Pod \u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs -f kube-state-metrics-1 -nkube-system\nI0216 05:53:23.151163       1 wrapper.go:78] Starting kube-state-metrics\nI0216 05:53:23.154495       1 server.go:125] \"Used default resources\"\nI0216 05:53:23.154923       1 types.go:184] \"Using all namespaces\"\nI0216 05:53:23.155556       1 server.go:166] \"Metric allow-denylisting\" allowDenyStatus=\"Excluding the following lists that were on denylist: \"\nW0216 05:53:23.155792       1 client_config.go:617] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.\nI0216 05:53:23.178553       1 server.go:311] \"Tested communication with server\"\nI0216 05:53:23.241024       1 server.go:316] \"Run with Kubernetes cluster version\" major=\"1\" minor=\"25\" gitVersion=\"v1.25.3\" gitTreeState=\"clean\" gitCommit=\"434bfd82814af038ad94d62ebe59b133fcb50506\" platform=\"linux/arm64\"\nI0216 05:53:23.241169       1 server.go:317] \"Communication with server successful\"\nI0216 05:53:23.245132       1 server.go:263] \"Started metrics server\" metricsServerAddress=\"[::]:8080\"\nI0216 05:53:23.246148       1 metrics_handler.go:103] \"Autosharding enabled with pod\" pod=\"kube-system/kube-state-metrics-1\"\nI0216 05:53:23.246233       1 metrics_handler.go:104] \"Auto detecting sharding settings\"\nI0216 05:53:23.246267       1 server.go:252] \"Started kube-state-metrics self metrics server\" telemetryAddress=\"[::]:8081\"\nI0216 05:53:23.253477       1 server.go:69] levelinfomsgListening onaddress[::]:8081\nI0216 05:53:23.253477       1 server.go:69] levelinfomsgListening onaddress[::]:8080\nI0216 05:53:23.253944       1 server.go:69] levelinfomsgTLS is disabled.http2falseaddress[::]:8080\nI0216 05:53:23.254534       1 server.go:69] levelinfomsgTLS is disabled.http2falseaddress[::]:8081\nI0216 05:53:23.297524       1 metrics_handler.go:80] \"Configuring sharding of this instance to be shard index (zero-indexed) out of total shards\" shard=1 totalShards=2\nI0216 05:53:23.411710       1 builder.go:257] \"Active resources\" activeStoreNames=\"certificatesigningrequests,configmaps,cronjobs,daemonsets,deployments,endpoints,horizontalpodautoscalers,ingresses,jobs,leases,limitranges,mutatingwebhookconfigurations,namespaces,networkpolicies,nodes,persistentvolumeclaims,persistentvolumes,poddisruptionbudgets,pods,replicasets,replicationcontrollers,resourcequotas,secrets,services,statefulsets,storageclasses,validatingwebhookconfigurations,volumeattachments\"\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6709\u7c7b\u578b \"Configuring sharding of this instance to be shard index (zero-indexed) out of total shards\" shard=1 totalShards=2 \u8fd9\u6837\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u8868\u9762\u81ea\u52a8\u5206\u7247\u6210\u529f\u4e86\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u53bb\u5206\u522b\u83b7\u53d6\u4e0b\u5206\u7247\u7684\u6307\u6807\u6570\u636e\u5927\u5c0f\uff0c\u5e76\u548c\u672a\u5206\u7247\u4e4b\u524d\u7684\u8fdb\u884c\u5bf9\u6bd4\uff0c\u53ef\u4ee5\u770b\u5230\u5206\u7247\u540e\u7684\u6307\u6807\u660e\u663e\u51cf\u5c11\u4e86\uff0c\u5982\u679c\u5355\u4e2a\u5b9e\u4f8b\u7684\u6307\u6807\u6570\u636e\u8fd8\u662f\u592a\u5927\uff0c\u5219\u53ef\u4ee5\u589e\u52a0 StatefulSet \u7684\u526f\u672c\u6570\u5373\u53ef\u3002</p> <p></p> <p>\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u5355\u72ec\u9488\u5bf9 pod \u6307\u6807\u6309\u7167\u6bcf\u4e2a\u8282\u70b9\u8fdb\u884c\u5206\u7247\uff0c\u53ea\u9700\u8981\u52a0\u4e0a <code>--node</code> \u548c <code>--resource</code> \u5373\u53ef\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u76f4\u63a5\u4f7f\u7528\u4e00\u4e2a DaemonSet \u6765\u521b\u5efa KSM \u5b9e\u4f8b\u5373\u53ef\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: DaemonSet\nspec:\n  template:\n    spec:\n      containers:\n      - image: registry.k8s.io/kube-state-metrics/kube-state-metrics:IMAGE_TAG\n        name: kube-state-metrics\n        args:\n        - --resource=pods\n        - --node=$(NODE_NAME)\n        env:\n        - name: NODE_NAME\n          valueFrom:\n            fieldRef:\n              apiVersion: v1\n              fieldPath: spec.nodeName\n</code></pre> <p>\u5bf9\u4e8e\u5176\u4ed6\u7684\u6307\u6807\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>--resource</code> \u6765\u5355\u72ec\u6307\u5b9a\u90e8\u7f72\uff0c\u4e5f\u53ef\u4ee5\u7ee7\u7eed\u4f7f\u7528\u5206\u7247\u7684\u65b9\u5f0f\u3002</p> <p>\u603b\u7ed3\u6765\u8bf4\u5c31\u662f\u5bf9\u4e8e\u5927\u89c4\u6a21\u96c6\u7fa4\u4f7f\u7528 <code>kube-state-metrics</code> \u9700\u8981\u505a\u5f88\u591a\u4f18\u5316\uff1a</p> <ul> <li>\u8fc7\u6ee4\u4e0d\u9700\u8981\u7684\u6307\u6807\u548c\u6807\u7b7e</li> <li>\u901a\u8fc7\u5206\u7247\u964d\u4f4e KSM \u5b9e\u4f8b\u538b\u529b</li> <li>\u53ef\u4ee5\u4f7f\u7528 DaemonSet \u65b9\u5f0f\u5355\u72ec\u9488\u5bf9 pod \u6307\u6807\u8fdb\u884c\u90e8\u7f72</li> </ul>"},{"location":"chap1/11Prom_intro_2023-CN/","title":"2023 \u4e91\u539f\u751f\u7cfb\u7edf\u76d1\u63a7","text":"<ol> <li>\u7406\u89e3\u76d1\u63a7\u7cfb\u7edf\u7684\u610f\u4e49\u548c\u5206\u7c7b</li> <li>\u7406\u89e3 Prometheus \u7684\u67b6\u6784</li> <li>Prometheus \u7684\u6307\u6807\u7c7b\u578b</li> <li>\u6df1\u5165\u7406\u89e3 Prometheus \u6570\u636e\u91c7\u96c6\u3001\u6570\u636e\u5b58\u50a8\u548c\u6570\u636e\u6d88\u8d39</li> </ol>"},{"location":"chap1/11Prom_intro_2023-CN/#_1","title":"\u76d1\u63a7\u7cfb\u7edf","text":"<p>\u4e3a\u4ec0\u4e48\u76d1\u63a7\uff0c\u76d1\u63a7\u4ec0\u4e48\u5185\u5bb9\uff1f</p> <ul> <li>\u5bf9\u81ea\u5df1\u7cfb\u7edf\u7684\u8fd0\u884c\u72b6\u6001\u4e86\u5982\u6307\u638c\uff0c\u6709\u95ee\u9898\u53ca\u65f6\u53d1\u73b0\uff0c\u800c\u4e0d\u8ba9\u7528\u6237\u5148\u53d1\u73b0\u6211\u4eec\u7cfb\u7edf\u4e0d\u80fd\u4f7f\u7528\u3002</li> <li>\u6211\u4eec\u4e5f\u9700\u8981\u77e5\u9053\u6211\u4eec\u7684\u670d\u52a1\u8fd0\u884c\u60c5\u51b5\u3002</li> </ul> <p>\u76d1\u63a7\u76ee\u7684</p> <ul> <li>\u957f\u671f\u8d8b\u52bf\u5206\u6790\uff1a\u6bd4\u5982\u8d44\u6e90\u7528\u91cf\u9884\u6d4b</li> <li>\u5bf9\u7167\u5206\u6790\uff1a\u6bd4\u5982\u4e24\u4e2a\u7248\u672c\u7684\u7cfb\u7edf\u8fd0\u884c\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u7684\u5dee\u5f02</li> <li>\u544a\u8b66\uff1a\u5f53\u7cfb\u7edf\u51fa\u73b0\u6216\u8005\u5373\u5c06\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u76d1\u63a7\u7cfb\u7edf\u9700\u8981\u8fc5\u901f\u53cd\u5e94\u5e76\u901a\u77e5\u7ba1\u7406\u5458</li> <li>\u6545\u969c\u5206\u6790\u4e0e\u5b9a\u4f4d\uff1a\u901a\u8fc7\u5bf9\u4e0d\u540c\u76d1\u63a7\u76d1\u63a7\u4ee5\u53ca\u5386\u53f2\u6570\u636e\u7684\u5206\u6790\uff0c\u80fd\u591f\u627e\u5230\u5e76\u89e3\u51b3\u6839\u6e90\u95ee\u9898</li> <li>\u6570\u636e\u53ef\u89c6\u5316\uff1a\u901a\u8fc7\u53ef\u89c6\u5316\u4eea\u8868\u76d8\u80fd\u591f\u76f4\u63a5\u837b\u53d6\u7cfb\u7edf\u7684\u8fd0\u884c\u72b6\u6001\u3001\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3001\u4ee5\u53ca\u670d\u52a1\u8fd0\u884c\u72b6\u6001\u7b49\u76f4\u89c2\u7684\u4fe1\u606f</li> </ul> <p></p>"},{"location":"chap1/11Prom_intro_2023-CN/#_2","title":"\u76d1\u63a7\u7684\u5206\u7c7b","text":"<p>\u9ed1\u76d2\u76d1\u63a7</p> <ul> <li>\u5b9e\u73b0\u673a\u5236<ul> <li>\u4ece\u7cfb\u7edf\u5916\u90e8\u76d1\u63a7\u3002</li> <li>\u5bf9\u5e94\u7528\u8fd0\u884c\u903b\u8f91\u4e00\u65e0\u6240\u77e5\u3002</li> <li>\u57fa\u4e8e ping, http request \u7b49\u68c0\u6d4b\u624b\u6bb5\uff0c\u5e76\u7b49\u5f85\u68c0\u6d4b\u7ed3\u679c\uff0e</li> </ul> </li> <li>\u5e94\u7528\u573a\u666f<ul> <li>\u4ece\u7cfb\u7edf\u5916\u90e8\u89c2\u6d4b\u6574\u4f53\u53ef\u7528\u6027\u3002</li> <li>\u65e0\u6cd5\u83b7\u5f97\u7cfb\u7edf\u5185\u90e8\u7684\u8fd0\u884c\u60c5\u51b5\u3002</li> <li>\u6d4b\u8bd5\u7ed3\u679c\u901a\u5e38\u662f\u5e03\u5c14\u578b\uff1a\u6210\u529f\u6216\u5931\u8d25\uff0c\u65e0\u6cd5\u5168\u65b9\u4f4d\u76d1\u63a7\u3002</li> </ul> </li> </ul> <p>\u767d\u76d2\u76d1\u63a7</p> <ul> <li>\u5b9e\u73b0\u673a\u5236<ul> <li>\u901a\u8fc7\u4fb5\u5165\u6027\u4ee3\u7801\u91c7\u96c6\u7cfb\u7edf\u6307\u6807\uff08\u5982cgroup\uff09 \u548c\u81ea\u5b9a\u4e49\u4e1a\u52a1\u6307\u6807\uff08\u5982 httpcode\uff0c\u5e76\u53d1request\uff0c\u7528\u6237\u884c\u4e3a\u4fe1\u606f\u7b49\uff09</li> </ul> </li> <li>\u5e94\u7528\u573a\u666f<ul> <li>\u9ed1\u76d2\u76d1\u63a7\u7684\u8865\u5145</li> <li>\u901a\u8fc7\u767d\u76d2\u80fd\u591f\u4e86\u89e3\u5176\u5185\u90e8\u7684\u5b9e\u9645\u8fd0\u884c\u72b6\u6001\uff0c\u901a\u8fc7\u5bf9\u76d1\u63a7\u6307\u6807\u7684\u89c2\u5bdf\u80fd\u591f\u9884\u5224\u53ef\u80fd\u51fa\u73b0\u7684\u95ee\u9898\uff0c\u4ece\u800c\u5bf9\u6f5c\u5728\u7684\u4e0d\u786e\u5b9a\u56e0\u7d20\u8fdb\u884c\u4f18\u5316\u3002</li> <li>\u76d1\u63a7\u6307\u6807\u4e30\u5bcc\u53ef\u6269\u5c55\uff0c\u53ef\u76d1\u63a7 CPU \u5229\u7528\u7387\uff0c\u4e5f\u53ef\u4ee5\u76d1\u63a7\u5e76\u53d1\u8bf7\u6c42\u6570\u91cf\u3002</li> </ul> </li> </ul>"},{"location":"chap1/11Prom_intro_2023-CN/#prometheus","title":"Prometheus \u67b6\u6784","text":"<p>\u7531\u524d Google \u5458\u5de5\uff0c\u53d7 Google \u5185\u90e8 Borgman \u7684\u542f\u53d1\uff0c2012 \u5e74\u5f00\u59cb\u7684\u5f00\u6e90\u9879\u76ee\uff0c2018 \u5e74\u8fdb\u5165\u6bd5\u4e1a\u72b6\u6001\u3002Prometheus: \u5148\u89c1\u4e4b\u660e</p> <ul> <li>\u4ee5\u6307\u6807\u540d\u79f0\u548c\u952e\u503c\u5bf9\u552f\u4e00\u6807\u8bc6\u7684\u57fa\u4e8e\u65f6\u95f4\u5e8f\u5217\u7684\u591a\u7ef4\u6570\u636e\u6a21\u578b</li> <li>\u652f\u6301\u591a\u7ef4\u7075\u6d3b\u67e5\u8be2\u7684 PromQL</li> <li>\u4e0e\u5b58\u50a8\u7cfb\u7edf\u89e3\u8026</li> <li>\u57fa\u4e8e HTTP\u534f\u8bae\u7684Pull\u6a21\u5f0f\u8fdb\u884c\u65f6\u95f4\u5e8f\u5217\u6307\u6807\u91c7\u96c6</li> <li>\u4e2d\u95f4\u7f51\u5173\u652f\u6301 Push \u6a21\u5f0f</li> <li>\u57fa\u4e8e\u9759\u6001\u914d\u7f6e\u548c\u6216\u670d\u52a1\u53d1\u73b0\u7684\u76ee\u6807\u53d1\u73b0\u673a\u5236</li> <li>\u7075\u6d3b\u7684\u56fe\u50cf\u5316\u5c55\u793a</li> </ul> <p></p>"},{"location":"chap1/11Prom_intro_2023-CN/#prometheus_1","title":"Prometheus\u6570\u636e\u6a21\u578b","text":"<ul> <li>\u6307\u6807\u540d\u4e0e\u6807\u7b7e\uff08Metrics Name\u548cLabels\uff09<ul> <li>\u6bcf\u4e2a\u4e1a\u52a1\u6307\u6807\u7531\u6307\u6807\u540d\u79f0\u548c\u952e\u503c\u5bf9\u6807\u7b7e\u552f\u4e00\u6807\u8bc6</li> </ul> </li> <li>\u91c7\u6837\u70b9\uff08Samples\uff09<ul> <li>\u6bcf\u6b21\u6307\u6807\u6536\u96c6\u5230\u7684\u6765\u6837\u6570\u636e\u7531\u4e24\u90e8\u5206\u7ec4\u6210<ul> <li>Timestamp</li> <li>Value</li> </ul> </li> </ul> </li> <li>\u6307\u6807\u8868\u793a\u65b9\u5f0f<ul> <li>OpenTSDB\u7684\u6807\u793a\u65b9\u5f0f<ul> <li><code>&lt;metric name&gt;(&lt;labelname&gt;=&lt;labelvalue&gt;\uff0c...)</code></li> </ul> </li> <li>\u793a\u4f8b<ul> <li><code>api_http_requests_total{method=\"POST\", handler=\"/messages\"}</code></li> </ul> </li> </ul> </li> </ul>"},{"location":"chap1/11Prom_intro_2023-CN/#prometheus_2","title":"Prometheus\u7684\u6307\u6807\u7c7b\u578b","text":"<ul> <li> <p>counter\uff08\u8ba1\u6570\u5668\u5668\uff09</p> <ul> <li>Counter \u7c7b\u578b\u4ee3\u8868\u4e00\u79cd\u6837\u672c\u6570\u636e\u5355\u8c03\u9012\u589e\u7684\u6307\u6807\uff0c\u5373\u53ea\u589e\u4e0d\u51cf\uff0c\u9664\u975e \u76d1\u63a7\u7cfb\u7edf\u53d1\u751f\u4e86\u91cd\u7f6e</li> </ul> </li> <li> <p>Gauge (\u4eea\u8868\u76d8)</p> <ul> <li>Gauge \u7c7b\u578b\u4ee3\u8868\u4e00\u79cd\u6837\u672c\u6570\u636e\u53ef\u4ee5\u4efb\u610f\u53d8\u5316\u7684\u6307\u6807\uff0c\u5373\u53ef\u589e\u53ef\u51cf</li> </ul> </li> <li> <p>Histogram (\u76f4\u65b9\u56fe)</p> <ul> <li>Histogram \u5728\u4e00\u6bb5\u65f6\u95f4\u8303\u56f4\u5185\u5bf9\u6570\u636e\u8fdb\u884c\u91c7\u6837(\u901a\u5e38\u662f\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u6216\u54cd\u5e94\u5927\u5c0f\u7b49\uff09\u5e76\u5c06\u5176\u8ba1\u5165\u53ef\u914d\u7f6e\u7684\u5b58\u50a8\u6876\uff08bucket\uff09\u4e2d\uff0c\u540e\u7eed\u53ef\u901a\u8fc7\u6307\u5b9a\u533a\u95f4\u7b5b\u9009\u6837\u672c\uff0c\u4e5f\u53ef\u4ee5\u7edf\u8ba1\u3001\u6837\u672c\u603b\u6570\uff0c\u6700\u540e\u4e00\u822c\u5c06\u6570\u636e\u5c55\u793a\u4e3a\u76f4\u65b9\u56fe\uff0c</li> <li>\u6837\u672c\u7684\u503c\u5206\u5e03\u5728 bucket \u4e2d\u7684\u6570\u91cf\uff0c\u547d\u540d\u4e3a<code>&lt;basenames_bucket{le=\"&lt;\u4e0a\u8fb9\u754c&gt;\"}</code>\u3002</li> <li>\u6240\u6709\u6837\u6728\u503c\u7684\u5927\u5c0f\u603b\u548c\uff0c\u547d\u540d\u4e3a <code>&lt;basename&gt;_sum</code></li> <li>\u6837\u672c\u603b\u6570\uff0c\u547d\u540d\u4e3a<code>&lt;basename&gt;_count</code>\uff0c \u503c\u548c<code>&lt;basename&gt;_bucket{le=\"+lnf\"}</code>\u76f8\u540c\u3002</li> </ul> </li> <li> <p>Summary\uff08\u6458\u8981\uff09</p> <ul> <li>\u4e0eHistogram \u7c7b\u578b\u7c7b\u4f3c\uff0c\u7528\u4e8e\u8868\u793a\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6570\u636e\u91c7\u6837\u7ed3\u679c(\u901a\u5e38\u662f\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u6216\u54cd\u5e94\u5927\u5c0f\u7b49\uff09\uff0c\u4f46\u5b83\u76f4\u63a5\u5b58\u50a8\u4e86\u5206\u4f4d\u6570\u901a\u8fc7\u5ba2\u6237\u7aef\u8ba1\u7b97\uff0c\u7136\u540e\u5c55\u793a\u51fa\u6765\uff09\uff0c\u800c\u4e0d\u662f\u901a\u8fc7\u533a\u95f4\u6765\u8ba1\u7b97\u3002</li> <li>\u5b83\u4eec\u90fd\u5305\u542b\u4e86<code>&lt;basename&gt;_sum</code>\u548c<code>&lt;basename&gt;_count</code>\u6307\u6807\u3002</li> <li>Histogram\u9700\u8981\u901a\u8fc7<code>&lt;basename&gt;_bucket</code>\u6765\u8ba1\u7b97\u5206\u4f4d\u6570\uff0c\u800c Summary\u5219\u76f4\u63a5\u5b58\u50a8\u4e86\u5206\u4f4d\u6570\u7684\u503c\u3002</li> </ul> </li> </ul> <p></p>"},{"location":"chap1/11Prom_intro_2023-CN/#redis","title":"Redis\u6545\u969c\u540e\u9650\u6d41\u3001\u964d\u7ea7\u7684\u5e94\u6025\u9884\u6848","text":"<p>\u6781\u5c11\u7684\u7a7a\u95f4\u6765\u6807\u8bc6\u8d85\u5927\u91cf\u7684\u6570\u636e\uff0c\u6240\u4ee5\u4e00\u65e6relis \u51fa\u73b0\u4e86\u6545\u969c\u3002\u6570\u636e\u5e93\u5f88\u5feb\u5c31\u4f1a\u62db\u67b6\u4e0d\u4f4f\uff0c\u5f88\u6709\u53ef\u80fd\u5c31\u4f1a\u5b95\u673a\u3002 \u6570\u636e\u5e93\u5b95\u673a\u7cfb\u7edf\u5c31\u4f1a\u6302\uff0c</p> <p>\u4e24\u79cd\u89e3\u51b3\u65b9\u6cd5\uff1a \u4e00\u4e2a\u662f\u964d\u7ea7\uff0c\u4e00\u4e2a\u662f\u9650\u6d41\u3002</p> <ul> <li> <p>\u964d\u7ea7\uff1a \u53ef\u4ee5\u4f7f\u7528\u672c\u5730\u7f13\u5b58\uff0c\u5c06\u7f13\u5b58\u6570\u636e\u5728\u8fd9\u4e2ajvm\u4e2d\uff0c\u4e00\u65e6redis\u6545\u969c\u67e5\u4e0d\u5230\uff0c\u5c31\u76f4\u63a5\u542f\u7528\u672c\u5730\u7f13\u5b58\uff0c\u5c31\u4e0d\u7528\u8d70\u6570\u636e\u5e93\u3002 \u90a3\u4e48\u8bf7\u6c42\u8fc7\u6765\uff0c \u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u8fd9\u4e2a\u672c\u5730\u7f13\u5b58\u4e2d\u62ff\u6570\u636e\uff0c\u5e38\u89c1\u7684\u672c\u5730\u7f13\u5b58\u7684\u50cf\u8fd9\u4e2aguava\uff0c ehcache\uff0c caffeine\u3002 \u6027\u80fd\u548c\u7a33\u5b9a\u6027\u80fd\u5404\u65b9\u9762\u90fd\u5f88\u4f18\u79c0</p> </li> <li> <p>\u9650\u6d41 \u4e00\u822c\u5728\u7f51\u5173\u5c42\u505a\u4e00\u4e9b\u9650\u5236\uff0c \u6b64\u5982\u8bf4\u8fd9\u4e2aqps\u662f1\u4e07\uff0c \u53ef\u4ee5\u628a\u8fd9\u4e2a\u6d41\u91cf\u63a7\u5236\u5728\u6bcf\u79d21,000\u4e2a\u3002 \u90a3\u4e48\u5176\u4ed6\u7684\u5176\u4ed6\u7684\u4e00\u4e9b\u8bf7\u6c42\u5c31\u67e5\u63a5\u6253\u56de\uff0c \u5728\u6e90\u5934\u4e0a\u505a\u597d\u628a\u5173\u3002\u7136\u540e\u5728\u754c\u9762\u4e0a\u505a\u4e00\u4e9b\u53cb\u597d\u63d0\u793a\uff0c \u6392\u961f\u4e2d\u8bf7\u7a0d\u540e\u518d\u8bd5\uff0c\u9650\u6d41\u7b97\u6cd5\u6709\u5f88\u591a\uff0c\u50cf\u4ee4\u724c\u724c\u7b52\u7b97\u6cd5\uff0c \u6f0f\u7b52\u7b97\u6cd5\uff0c\u8fd8\u6709\u6ed1\u52a8\u7a97\u53e3\u7b97\u6cd5\u3002\u76ee\u7684\u5c31\u662f\u4e3a\u4e86\u901a\u8fc7\u8fd9\u4e2a\u9650\u6d41\u7b97\u6cd5\uff0c \u6765\u6321\u4f4f\u8fd9\u4e2a\u6d41\u91cf\u6d2a\u5cf0\uff0c \u907f\u514d\u76f4\u63a5\u53bb\u6c96\u51fb\u6570\u636e\u5e93</p> </li> </ul>"},{"location":"chap1/11Prom_intro_2023-CN/#push-or-pull","title":"\u76d1\u63a7\u6570\u636e\u7684\u91c7\u96c6 (Push or Pull)","text":"Push Pull \u4ee3\u8868\u5e94\u7528 InfluxDB Prometheus \u53d1\u8d77\u8005 \u88ab\u76d1\u63a7\u65b9\u53d1\u8d77 \u76d1\u63a7\u7cfb\u7edf\u53d1\u8d77\uff08\u77ed\u65f61ob \u5982\u4f55\u76d1\u63a7\uff1f\uff09 \u7f51\u7edc\u9700\u6c42 \u76ee\u6807\u5730\u5740\u56fa\u5b9a\uff0c\u5bb9\u6613\u7ed5\u8fc7\u9632\u706b\u5899 \u9700\u8981\u8fde\u63a5\u6240\u6709\u88ab\u76d1\u63a7\u65b9\uff0c\u901a\u5e38\u9700\u8981\u4e0e\u88ab\u76d1\u63a7\u623f\u90e8\u7f72\u5728\u4e00\u8d77 \u5e76\u53d1 \u7531\u88ab\u76d1\u63a7\u7cfb\u7edf\u4e0a\u62a5\u6570\u636e\uff0c\u5bb9\u6613\u5bf9\u76d1\u63a7\u7cfb\u7edf\u9020\u6210\u8f83\u5927\u5e76\u53d1\u538b\u529b\uff0c\u5bfc\u81f4\u76d1\u63a7\u7cfb\u7edf\u7f51\u7edc\u62e5\u585e\u6216\u8005\u7cfb\u7edf\u8fc7\u8f7d \u53ef\u7531\u76d1\u63a7\u7cfb\u7edf\u8f6e\u8bad\u5e76\u987a\u5e8f\u62c9\u53d6\uff0c\u65e0\u5e76\u53d1\u95ee\u9898 \u6545\u969c\u611f\u77e5 \u82e5\u76d1\u63a7\u7cfb\u7edf\u5047\u6b7b\uff0c\u88ab\u76d1\u63a7\u65b9\u65e0\u6cd5\u611f\u77e5\uff0c\u53ef\u80fd\u4f1a\u7ee7\u7eed\u63a8\u9001\u6570\u636e\u5bfc\u81f4\u96ea\u5d29 \u82e5\u7cfb\u7edf\u8d85\u8d1f\u8377\uff0c\u6570\u636e\u91c7\u96c6\u4f1a\u53d8\u6162\uff0c\u96ea\u5d29\u51e0\u7387\u8f83\u5c0f \u76ee\u6807\u53d1\u73b0 \u88ab\u76d1\u63a7\u76ee\u6807\u4e3b\u52a8\u4e0a\u62a5\uff0c\u65e0\u9700\u8fdb\u884c\u76ee\u6807\u53d1\u73b0 \u9700\u8981\u4e3b\u52a8\u53d1\u73b0\u88ab\u76d1\u63a7\u76ee\u6807"},{"location":"chap1/11Prom_intro_2023-CN/#kubernetes","title":"\u5728Kubernetes \u96c6\u7fa4\u4e2d\u7684\u76d1\u63a7\u7cfb\u7edf","text":"<p>\u6bcf\u4e2a\u8282\u70b9\u7684kubelet \u4f1a\u6536\u96c6\u5f53\u524d\u8282\u70b9host\u4e0a\u6240\u6709\u4fe1\u606f\uff0c\u5305\u62ec CPU\u3001\u5185\u5b58\u3001\u78c1\u76d8\u7b49\u3002Prometheus \u4f1apull\u8fd9\u4e9b\u4fe1\u606f\uff0c\u7ed9\u6bcf\u4e2a\u8282\u70b9\u6253\u4e0a\u6807\u7b7e\u6765\u533a\u5206\u4e0d\u540c\u7684\u8282\u70b9\u3002</p> <p></p>"},{"location":"chap1/11Prom_intro_2023-CN/#kubernetes_1","title":"\u5728 Kubernetes \u4e2d\u6c47\u62a5\u6307\u6807","text":"<p>\u5e94\u7528 Pod \u9700\u8981\u58f0\u660e\u4e0a\u62a5\u6307\u6807\u7aef\u53e3\u548c\u5730\u5740</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    prometheus.io/port: http-metrics\n    prometheus.io/scrape: \"true\"\nname: loki-0\n  namespace: default\nspec:\nports:\n - containerPort: 3100\n   name: http-metrics\n   protocol: TCP\n</code></pre> <p>\u5e94\u7528\u542f\u52a8\u65f6\uff0c \u9700\u8981\u6ce8\u518cmetrics</p> <pre><code>http.Handle(\u201c/metrics\u201d, promhttp.Handler()\uff09\nhttp.ListenAndserve(sever.MetricsBindAddress, nil\uff09\n</code></pre> <p>\u6ce8\u518c\u6307\u6807</p> <pre><code>funcRegisterMetrics(){\n    registerMetriconce.Do(func(){\n        prometheus.MustRegister(APIServerRequests\uff09\n        prometheus.MustRegister(WorkQueueSize\uff09\n    })\n}\n</code></pre> <p>\u4ee3\u7801\u4e2d\u8f93\u51fa\u6307\u6807</p> <pre><code>metrics.AddAPIServerReguest(controllerName, constants.CoreAPIGroup, constants.SecretResource\uff0cconstants.Get, cn.Namespace\uff09\n</code></pre>"},{"location":"chap1/11Prom_intro_2023-CN/#kubernetes_2","title":"\u5728Kubernetes \u96c6\u7fa4\u4e2d\u7684\u76d1\u63a7\u7cfb\u7edf","text":"<p>Kubernetes\u7684\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\uff0c\u5305\u62ec\u5404\u79cdcontroller\u540d\u90fd\u539f\u751f\u7684\u66b4\u9732Prometheus\u683c\u5f0f\u7684metrics\u3002</p> <p></p> <p>\u6570\u636e\u7684\u5b58\u50a8(TSDB\uff09</p> <p></p> <ul> <li>\u7eb5\u5411\u5199\uff1a\u6bcf\u4e00\u6b21\u6570\u636e\u91c7\u96c6\uff0c\u4f1a\u6c47\u62a5\u5468\u671f\u5185\u6240\u6709\u6307\u6807\u6570\u636e</li> <li>\u6a2a\u5411\u8bfb\uff1a\u6307\u6807\u8bfb\u53d6\u901a\u5e38\u662f\u6309\u7279\u5b9a\u5e8f\u5217\u8bfb\u53d6\uff0c\u5355\u6761\u65f6\u95f4\u5e8f\u5217=Metrics Name \uff0b \u552f\u4e00\u7684labels\u3002</li> </ul> <p>\u6570\u636e\u7684\u5b58\u50a8\u673a\u5236</p> <p></p> <p></p>"},{"location":"chap1/11Prom_intro_2023-CN/#_3","title":"\u6570\u636e\u7d22\u5f15","text":"<ul> <li>\u6bcf\u4e00\u4e2ablock\u4e2d\uff0c\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u90fd\u6709\u4e00\u4e2a\u552f\u4e00ID\u3002</li> <li>\u7d22\u5f15\u6a21\u5757\u7ef4\u62a4\u4e86\u4e00\u4e2a\u952e\u503cLabel\u5230ID\u7684\u6620\u5c04\u5173\u7cfb</li> <li>\u901a\u8fc7K\u8def\u8f6e\u8bad\u5b8c\u6210\u65f6\u95f4\u5e8f\u5217\u7684\u9ad8\u6548\u67e5\u8be2\u3002</li> </ul> <pre><code>{\n    __name__ = \"request_total\", \n    pod = \"mynginx-0\", \n    status = 200\uff0c\n    method = \"GET\"\n}\n</code></pre>"},{"location":"chap1/11Prom_intro_2023-CN/#_4","title":"\u6570\u636e\u7684\u538b\u7f29","text":"<ul> <li>Time \u538b\u7f29</li> </ul> <ul> <li>Series \u538b\u7f29</li> </ul>"},{"location":"chap1/11Prom_intro_2023-CN/#_5","title":"\u5b58\u50a8\u89c4\u5212","text":"<ul> <li>\u4e00\u4e2a\u91c7\u6837\u70b9<ul> <li>8\u5b57\u8282\u65f6\u95f4\u6233+8\u5b57\u8282\u503c\uff0c\u603b\u8ba116\u5b57\u8282</li> <li>\u538b\u7f29\u540e\u5e73\u57471.37\u5b57\u8282/\u91c7\u6837\u70b9\uff0c12\u500d\u7a7a\u95f4\u8282\u7701\uff01</li> </ul> </li> <li>500\u4e07\u4e2a\u6d3b\u8dc3\u65f6\u95f4\u5e8f\u5217<ul> <li>30\u79d2\u91c7\u6837\u95f4\u9694</li> <li>1\u4e2a\u6708\u5386\u53f2\u4fdd\u7559</li> </ul> </li> <li>\u5408\u8ba1\u9700\u8981166000\u4e2a\u91c7\u6837\u6570\u636e/\u79d2</li> <li>\u603b\u8ba1\u9700\u8981\u5b58\u50a8432Billion\u91c7\u6837\u6570\u636e<ul> <li>\u6bcf\u4e2a\u91c7\u6837\u70b98\u5b57\u8282\u65f6\u95f4\u622a+8\u5b57\u8282\u503c\uff0c\u603b\u8ba1\u9700\u89818T\u5b58\u50a8</li> <li>\u5e94\u7528\u538b\u7f29\u7b97\u6cd5\u540e\u53ea\u97000.8TB\u5b58\u50a8\u7a7a\u95f4</li> </ul> </li> </ul>"},{"location":"chap1/11Prom_intro_2023-CN/#promql","title":"\u6570\u636e\u7684\u67e5\u8be2\u4e0e\u6d88\u8d39PromQL","text":"<ul> <li><code>histogram_quantile(0.95, sum(rate(httpserver_execution_latency_seconds_bucket[5M])) by (le))</code></li> <li>Histogram\u662f\u76f4\u65b9\u56fe\uff0c<code>httpserver_execution_latency_seconds_bucket</code> \u662f\u76f4\u65b9\u56fe\u6307\u6807\uff0c\u662f\u5c06 <code>httpserver</code> \u5904\u7406\u8bf7\u6c42\u7684\u65f6\u95f4\u653e\u5165\u4e0d\u540c\u7684\u6876\u5185\uff0c\u5176\u8868\u8fbe\u7684\u662f\u843d\u5728\u4e0d\u540c\u65f6\u957f\u533a\u95f4\u7684\u54cd\u5e94\u6b21\u6570\u3002</li> <li><code>by\uff08le\uff09</code> \uff0c\u662f\u5c06\u91c7\u96c6\u7684\u6570\u636e\u6309\u6876\u7684\u4e0a\u8fb9\u754c\u5206\u7ec4\u3002</li> <li><code>rate(httpserver_execution_latency_seconds_bucket[5m])</code>\uff0c\u8ba1\u7b97\u7684\u662f\u4e94\u5206\u949f\u5185\u7684\u53d8\u5316\u7387\u3002</li> <li><code>sum()</code>\uff0c\u662f\u5c06\u6240\u6709\u6307\u6807\u7684\u53d8\u5316\u7387\u603b\u8ba1\u3002</li> <li>0.95\uff0c\u662f\u53d695\u5206\u4f4d\u3002</li> </ul> <p>\u7efc\u4e0a\uff1a\u4e0a\u8ff0\u8868\u8fbe\u5f0f\u8ba1\u7b97\u7684\u662f<code>httpserver</code>\u5904\u7406\u8bf7\u6c42\u65f6\uff0c<code>95%</code>\u7684\u8bf7\u6c42\u5728\u4e94\u5206\u949f\u5185\uff0c\u5728\u4e0d\u540c\u54cd\u5e94\u65f6\u95f4\u533a\u95f4\u7684\u5904\u7406\u7684\u6570\u91cf\u7684\u53d8\u5316\u60c5\u51b5\u3002</p>"},{"location":"chap1/11Prom_intro_2023-CN/#kubernetes_3","title":"\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u76d1\u63a7\u7cfb\u7edf","text":"<p>\u5f00\u542f\u544a\u8b66</p> <p></p>"},{"location":"chap1/11Prom_intro_2023-CN/#thanos","title":"\u4ee5 Thanos \u5e94\u5bf9\u89c4\u6a21\u5316\u6311\u6218","text":""},{"location":"chap1/17Adv_K8S_Metrics_Server/","title":"\u7b2c\u56db\u8282 Metrics Server \u5b89\u88c5","text":"<p><code>kubernetes</code> \u96c6\u7fa4\u8d44\u6e90\u76d1\u63a7\u4e4b\u524d\u53ef\u4ee5\u901a\u8fc7 <code>heapster</code> \u6765\u83b7\u53d6\u6570\u636e\uff0c\u5728 <code>1.11</code> \u5f00\u59cb\u5f00\u59cb\u9010\u6e10\u5e9f\u5f03 <code>heapster</code> \u4e86\uff0c\u91c7\u7528 <code>metrics-server</code> \u6765\u4ee3\u66ff\uff0c</p> <ul> <li><code>metrics-server</code> \u662f\u96c6\u7fa4\u7684\u6838\u5fc3\u76d1\u63a7\u6570\u636e\u7684\u805a\u5408\u5668\uff0c\u5b83\u4ece <code>kubelet</code> \u516c\u5f00\u7684 <code>Summary API</code> \u4e2d\u91c7\u96c6\u6307\u6807\u4fe1\u606f\uff0c</li> <li><code>metrics-server</code> \u662f\u6269\u5c55\u7684 <code>APIServer</code>\uff0c\u4f9d\u8d56\u4e8e<code>kube-aggregator</code>\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u5728 APIServer \u4e2d\u5f00\u542f\u76f8\u5173\u53c2\u6570\u3002</li> </ul> <p>\u67e5\u770b <code>APIServer</code> \u53c2\u6570\u914d\u7f6e\uff0c\u786e\u4fdd\u4f60\u7684 <code>APIServer</code> \u542f\u52a8\u53c2\u6570\u4e2d\u5305\u542b\u4e0b\u7684\u4e00\u4e9b\u53c2\u6570\u914d\u7f6e\u3002</p> <pre><code>...\n- --requestheader-client-ca-file=/etc/kubernetes/certs/proxy-ca.crt\n- --proxy-client-cert-file=/etc/kubernetes/certs/proxy.crt\n- --proxy-client-key-file=/etc/kubernetes/certs/proxy.key\n- --requestheader-allowed-names=aggregator\n- --requestheader-extra-headers-prefix=X-Remote-Extra-\n- --requestheader-group-headers=X-Remote-Group\n- --requestheader-username-headers=X-Remote-User\n- --enable-aggregator-routing=true\n...\n</code></pre> <p>\u5982\u679c\u60a8\u672a\u5728 <code>master</code> \u8282\u70b9\u4e0a\u8fd0\u884c <code>kube-proxy</code>\uff0c\u5219\u5fc5\u987b\u786e\u4fdd <code>kube-apiserver</code> \u542f\u52a8\u53c2\u6570\u4e2d\u5305\u542b<code>--enable-aggregator-routing=true</code></p>"},{"location":"chap1/17Adv_K8S_Metrics_Server/#1","title":"1 \u5b89\u88c5","text":"<p>\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>metrics-server</code> \u5b98\u65b9\u63d0\u4f9b\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u76f4\u63a5\u5b89\u88c5\uff0c\u5730\u5740\uff1ahttps://github.com/kubernetes-incubator/metrics-server/tree/master/deploy</p> <pre><code># kubernetes 1.7\n$ kubectl create -f 1.7/\n\n# kubernetes &gt; 1.8\n$ kubectl create -f 1.8+/\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>Helm</code> \u6765\u5b89\u88c5\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06 <code>metrics-server</code> \u7684 <code>Chart</code> \u5305 <code>fetch</code> \u5230\u96c6\u7fa4\u4e2d\uff0c\u67e5\u770b\u6a21\u677f\uff0c\u53bb\u4e86\u89e3\u5982\u4f55\u90e8\u7f72\u5e94\u7528\uff1a</p> <pre><code>$ helm fetch stable/metrics-server\n$ tar -xvf metrics-server-2.7.1.tgz\n$ cd metrics-server\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5fae\u8f6f\u7684\u955c\u50cf\u6765\u8986\u76d6\u9ed8\u8ba4\u7684 gcr.io \u955c\u50cf\uff0c\u5982\u4e0b\u547d\u540d\u5b89\u88c5\uff1a</p> <pre><code>$ helm install --name metric --namespace kube-system --set image.repository=gcr.azk8s.cn/google_containers/metrics-server-amd64 .\nNAME:   metric\nLAST DEPLOYED: Wed May 22 01:30:53 2019\nNAMESPACE: kube-system\nSTATUS: DEPLOYED\n\nRESOURCES:\n==&gt; v1/ServiceAccount\nNAME                   SECRETS  AGE\nmetric-metrics-server  1        1s\n\n==&gt; v1/ClusterRole\nNAME                                     AGE\nsystem:metrics-server-aggregated-reader  1s\nsystem:metric-metrics-server             1s\n\n==&gt; v1/ClusterRoleBinding\nNAME                                         AGE\nmetric-metrics-server:system:auth-delegator  1s\nsystem:metric-metrics-server                 1s\n\n==&gt; v1beta1/RoleBinding\nNAME                               AGE\nmetric-metrics-server-auth-reader  1s\n\n==&gt; v1/Service\nNAME                   TYPE       CLUSTER-IP      EXTERNAL-IP  PORT(S)  AGE\nmetric-metrics-server  ClusterIP  10.103.214.219  &lt;none&gt;       443/TCP  1s\n\n==&gt; v1/Deployment\nNAME                   DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE\nmetric-metrics-server  1        1        1           0          1s\n\n==&gt; v1beta1/APIService\nNAME                    AGE\nv1beta1.metrics.k8s.io  1s\n\n==&gt; v1/Pod(related)\nNAME                                    READY  STATUS             RESTARTS  AGE\nmetric-metrics-server-697bd98b8b-kvg2d  0/1    ContainerCreating  0         1s\n\n\nNOTES:\nThe metric server has been deployed.\n\nIn a few minutes you should be able to list metrics using the following\ncommand:\n\n  kubectl get --raw \"/apis/metrics.k8s.io/v1beta1/nodes\"\n</code></pre> <p>\u7b49\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770b Pod \u65e5\u5fd7\u662f\u5426\u6b63\u5e38\uff1a</p> <pre><code>$ kubectl get pods -n kube-system -l release=metric\nNAME                                     READY     STATUS    RESTARTS   AGE\nmetric-metrics-server-697bd98b8b-kvg2d   1/1       Running   0          58m\n$ kubectl logs -f metric-metrics-server-697bd98b8b-kvg2d -n kube-system\nI0521 17:31:54.580374       1 serving.go:273] Generated self-signed cert (/tmp/apiserver.crt, /tmp/apiserver.key)\n[restful] 2019/05/21 17:31:55 log.go:33: [restful/swagger] listing is available at https://:8443/swaggerapi\n[restful] 2019/05/21 17:31:55 log.go:33: [restful/swagger] https://:8443/swaggerui/ is mapped to folder /swagger-ui/\nI0521 17:31:55.112171       1 serve.go:96] Serving securely on [::]:8443\nE0521 17:32:55.229771       1 manager.go:111] unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:ydzs-node2: unable to fetch metrics from kubelet ydzs-node2 (ydzs-node2): Get https://ydzs-node2:10250/stats/summary/: dial tcp: lookup ydzs-node2 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-master: unable to fetch metrics from kubelet ydzs-master (ydzs-master): Get https://ydzs-master:10250/stats/summary/: dial tcp: lookup ydzs-master on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-node1: unable to fetch metrics from kubelet ydzs-node1 (ydzs-node1): Get https://ydzs-node1:10250/stats/summary/: dial tcp: lookup ydzs-node1 on 10.96.0.10:53: no such host\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 <code>Pod</code> \u4e2d\u51fa\u73b0\u4e86\u4e00\u4e9b\u9519\u8bef\u4fe1\u606f\uff1a<code>xxx: no such host</code>\uff0c\u6211\u4eec\u770b\u5230\u8fd9\u4e2a\u9519\u8bef\u4fe1\u606f\u4e00\u822c\u5c31\u53ef\u4ee5\u786e\u5b9a\u662f <code>DNS</code> \u89e3\u6790\u4e0d\u4e86\u9020\u6210\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>metrics-server</code> \u4f1a\u901a\u8fc7 <code>kubelet</code> \u7684 <code>10250</code> \u7aef\u53e3\u83b7\u53d6\u4fe1\u606f\uff0c\u4f7f\u7528\u7684\u662f <code>hostname</code>\uff0c\u6211\u4eec\u90e8\u7f72\u96c6\u7fa4\u7684\u65f6\u5019\u5728\u8282\u70b9\u7684 <code>/etc/hosts</code>\u91cc\u9762\u6dfb\u52a0\u4e86\u8282\u70b9\u7684 <code>hostname</code> \u548c <code>ip</code> \u7684\u6620\u5c04\uff0c\u4f46\u662f\u662f\u6211\u4eec\u7684 <code>metrics-server</code> \u7684 <code>Pod</code> \u5185\u90e8\u5e76\u6ca1\u6709\u8fd9\u4e2a <code>hosts</code> \u4fe1\u606f\uff0c\u5f53\u7136\u4e5f\u5c31\u4e0d\u8bc6\u522b <code>hostname</code> \u4e86\uff0c\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728\u96c6\u7fa4\u5185\u90e8\u7684 <code>DNS</code> \u670d\u52a1\u91cc\u9762\u6dfb\u52a0\u4e0a <code>hostname</code> \u7684\u89e3\u6790\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u96c6\u7fa4\u4e2d\u4f7f\u7528\u7684\u662f <code>CoreDNS</code>\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u53bb\u4fee\u6539\u4e0b <code>CoreDNS</code> \u7684 <code>Configmap</code> \u4fe1\u606f\uff0c\u6dfb\u52a0\u4e0a <code>hosts</code> \u4fe1\u606f\uff1a</p> <pre><code>\n$ kubectl edit configmap coredns -n kube-system\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health\n        hosts {  # \u6dfb\u52a0\u96c6\u7fa4\u8282\u70b9hosts\u9690\u5c04\u4fe1\u606f\n          10.151.30.11 emp-master\n          10.151.30.22 emp-node1\n          10.151.30.23 emp-node2\n          fallthrough\n        }\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           upstream\n           fallthrough in-addr.arpa ip6.arpa\n        }\n        prometheus :9153\n        proxy . /etc/resolv.conf\n        cache 30\n        reload\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2019-05-18T11:07:46Z\n  name: coredns\n  namespace: kube-system\n</code></pre> <p>\u8fd9\u6837\u5f53\u5728\u96c6\u7fa4\u5185\u90e8\u8bbf\u95ee\u96c6\u7fa4\u7684 <code>hostname</code> \u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u89e3\u6790\u5230\u5bf9\u5e94\u7684 <code>ip</code> \u4e86\uff0c</p> <p>\u53e6\u5916\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728 <code>metrics-server</code> \u7684\u542f\u52a8\u53c2\u6570\u4e2d\u4fee\u6539<code>kubelet-preferred-address-types</code>\u53c2\u6570\uff0c\u5982\u4e0b\uff1a\uff08custom-values.yaml\uff09</p> <pre><code>image:\n  repository: gcr.azk8s.cn/google_containers/metrics-server-amd64\n\nargs:\n- --kubelet-preferred-address-types=InternalIP\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u7136\u540e\u91cd\u65b0\u5b89\u88c5\uff1a</p> <pre><code>$ helm delete metric --purge\n$ helm install --name metric --namespace kube-system -f custom-values.yaml .\n......\n$ kubectl get pods -n kube-system |grep metric\nmetric-metrics-server-58fc94d9f-jlxcb            1/1       Running   0          47s\n$ kubectl logs -f metric-metrics-server-58fc94d9f-jlxcb -n kube-system\nI0521 17:54:32.873326       1 serving.go:273] Generated self-signed cert (/tmp/apiserver.crt, /tmp/apiserver.key)\n[restful] 2019/05/21 17:54:34 log.go:33: [restful/swagger] listing is available at https://:8443/swaggerapi\n[restful] 2019/05/21 17:54:34 log.go:33: [restful/swagger] https://:8443/swaggerui/ is mapped to folder /swagger-ui/\nI0521 17:54:34.668940       1 serve.go:96] Serving securely on [::]:8443\n\nE0521 17:55:34.650303       1 manager.go:111] unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:ydzs-master: unable to fetch metrics from kubelet ydzs-master (10.151.30.11): Get https://10.151.30.11:10250/stats/summary/: x509: cannot validate certificate for 10.151.30.11 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-node2: unable to fetch metrics from kubelet ydzs-node2 (10.151.30.23): Get https://10.151.30.23:10250/stats/summary/: x509: cannot validate certificate for 10.151.30.23 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-node1: unable to fetch metrics from kubelet ydzs-node1 (10.151.30.22): Get https://10.151.30.22:10250/stats/summary/: x509: cannot validate certificate for 10.151.30.22 because it doesn't contain any IP SANs]\n</code></pre> <p>\u56e0\u4e3a\u90e8\u7f72\u96c6\u7fa4\u7684\u65f6\u5019\uff0c<code>CA</code>\u8bc1\u4e66\u5e76\u6ca1\u6709\u628a\u5404\u4e2a\u8282\u70b9\u7684 <code>IP</code> \u7b7e\u4e0a\u53bb\uff0c\u6240\u4ee5\u8fd9\u91cc <code>metrics-server</code> \u901a\u8fc7 <code>IP</code> \u53bb\u8bf7\u6c42\u65f6\uff0c\u63d0\u793a\u7b7e\u7684\u8bc1\u4e66\u6ca1\u6709\u5bf9\u5e94\u7684 <code>IP\uff08\u9519\u8bef\uff1ax509: cannot validate certificate for 192.168.33.11 because it doesn\u2019t contain any IP SANs\uff09</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a<code>--kubelet-insecure-tls</code>\u53c2\u6570\u8df3\u8fc7\u8bc1\u4e66\u6821\u9a8c\uff1a</p> <pre><code>image:\n  repository: gcr.azk8s.cn/google_containers/metrics-server-amd64\n\nargs:\n- --kubelet-insecure-tls\n- --kubelet-preferred-address-types=InternalIP\n</code></pre> <p>\u7136\u540e\u518d<code>\u91cd\u65b0\u5b89\u88c5</code>\u5373\u53ef\u6210\u529f!</p> <pre><code>$ kubectl get apiservice | grep metrics\nv1beta1.metrics.k8s.io                 2019-05-21T18:03:03Z\n\n$ kubectl get --raw \"/apis/metrics.k8s.io/v1beta1/nodes\"\n{\"kind\":\"NodeMetricsList\",\"apiVersion\":\"metrics.k8s.io/v1beta1\",\"metadata\":{\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes\"},\"items\":[{\"metadata\":{\"name\":\"ydzs-master\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-master\",\"creationTimestamp\":\"2019-05-22T22:11:16Z\"},\"timestamp\":\"2019-05-22T22:11:01Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"516674270n\",\"memory\":\"2555172Ki\"}},{\"metadata\":{\"name\":\"ydzs-node1\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-node1\",\"creationTimestamp\":\"2019-05-22T22:11:16Z\"},\"timestamp\":\"2019-05-22T22:11:05Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"413218279n\",\"memory\":\"3417680Ki\"}}]}\n\n\n$ kubectl top nodes\nNAME          CPU(cores)   CPU%      MEMORY(bytes)   MEMORY%\nemp-master   496m         24%       2443Mi          66%\nemp-node1    412m         10%       3338Mi          43%\n</code></pre> <p>\u672c\u7bc7\u6587\u7ae0\u4f7f\u7528\u7684\u96c6\u7fa4\u7248\u672c\u4e3a <code>kubernetes v1.11.0</code> \u7248\u672c\uff0c\u91c7\u7528 <code>Kubeadm</code> \u65b9\u5f0f\u5b89\u88c5\u3002</p> <p>\u5728\u5b89\u88c5\u7684\u8fc7\u7a0b\u4e2d\u6216\u591a\u6216\u5c11\u53ef\u80fd\u4f1a\u6709\u4e00\u4e9b\u95ee\u9898\uff0c\u6700\u597d\u7684\u529e\u6cd5\u5c31\u662f\u4e00\u6b65\u4e00\u6b65\u7684\u53bb\u6392\u9519\uff0c\u51fa\u73b0\u4e86\u9519\u8bef\u4e0d\u8981\u7740\u6025\uff0c\u6700\u91cd\u8981\u7684\u5c31\u662f\u5206\u6790\u9519\u8bef\u65e5\u5fd7\u4fe1\u606f\uff0c\u5f88\u591a\u9519\u8bef\u65e5\u5fd7\u63d0\u793a\u5176\u5b9e\u5df2\u7ecf\u975e\u5e38\u660e\u663e\u4e86\u3002</p>"},{"location":"chap1/18Adv_Prometheus_index_classfication/","title":"\u7b2c\u4e8c\u8282 \u6df1\u5165Prometheus\u8bbe\u8ba1-\u6307\u6807\u5b9a\u4e49\u4e0e\u5206\u7c7b(PromQL)","text":""},{"location":"chap1/18Adv_Prometheus_index_classfication/#1","title":"1.\u6307\u6807","text":"<ul> <li>\u6bcf\u79cd\u76d1\u63a7\u7cfb\u7edf\u90fd\u6709\u81ea\u5df1\u7684\u6307\u6807\u5b9a\u4e49\u548c\u89c4\u8303</li> <li>\u6307\u6807\u7684\u6570\u636e\u683c\u5f0f\u5c06\u76f4\u63a5\u5f71\u54cd\u5bf9\u6570\u636e\u7684\u91c7\u96c6\u548c\u5b58\u50a8</li> <li>\u5b9a\u4e49\u6307\u6807\u65f6\u9700\u8981\u5145\u5206\u8003\u8651\u901a\u7528\u6027\u548c\u6269\u5c55\u6027</li> </ul>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#11","title":"1.1 \u6307\u6807\u5b9a\u4e49","text":"<pre><code>&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...},\n</code></pre>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#111metric-name","title":"1.1.1\u6307\u6807\u540d\u79f0\uff08metric name\uff09","text":"<ul> <li>\u7528\u4e8e\u8bf4\u660e\u6307\u6807\u7684\u542b\u4e49</li> <li>\u6307\u6807\u540d\u79f0\u5fc5\u987b\u6709\u5b57\u6bcd\u3001\u6570\u5b57\u3001\u4e0b\u5212\u7ebf\u6216\u8005\u5192\u53f7\u7ec4\u6210</li> <li>\u7b26\u5408\u6b63\u5219\u8868\u8fbe\u5f0f <code>[a-zA-Z:][a-zA-Z0-9:]</code></li> <li>\u5192\u53f7\u4e0d\u80fd\u7528\u4e8e<code>exporter</code></li> </ul>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#112-label","title":"1.1.2 \u6807\u7b7e\uff08label\uff09","text":"<ul> <li>\u4f53\u73b0\u6307\u6807\u7684\u7ef4\u5ea6\u7279\u6027\uff0c\u7528\u4e8e\u8fc7\u6ee4\u548c\u805a\u5408</li> <li>\u901a\u8fc7\u6807\u7b7e\u540d\u548c\u6807\u7b7e\u503c\u7ec4\u6210\uff0c\u952e\u503c\u5bf9\u5f62\u5f0f\u5f62\u6210\u591a\u79cd\u7ef4\u5ea6</li> </ul>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#113","title":"1.1.3 \u4e3e\u4f8b","text":"<pre><code>\u6307\u68071 http_request_total{status=\"200\",method=\"POST\"}\n</code></pre> <pre><code>\u6307\u68072 {__name__ = \"http_request_total\",status=\"200\",method=\"POST\"}\n</code></pre> <ul> <li>\u4ee5\u4e0a\u4e24\u4e2a\u6307\u6807\u662f\u4e00\u6837\uff0c\u4e0b\u5212\u7ebf\u5f00\u5934\u7684\u6807\u7b7e\u662f\u7cfb\u7edf\u5185\u90e8\u4f7f\u7528\u7684</li> <li>\u6307\u6807\u540d\u79f0\uff1a<code>http_request_total</code> \u4ee3\u8868<code>HTTP</code>\u8bf7\u6c42\u7684\u603b\u6570</li> <li>\u6807\u7b7e1\uff1a <code>status</code> \u503c <code>200</code>\uff0c \u4ee3\u8868\u72b6\u6001\u7801\u4e3a<code>200</code></li> <li>\u6807\u7b7e2\uff1a <code>method</code> \u503c <code>POST</code>\uff0c\u4ee3\u8868\u8bf7\u6c42\u7c7b\u578b\u4e3a<code>POST</code></li> </ul>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#2","title":"2 \u6307\u6807\u5206\u7c7b","text":"<p><code>Prometheus</code>\u6307\u6807\u5206\u4e3a<code>Counter</code>\u3001<code>Gauge</code>\u3001<code>Histogram</code>\u3001<code>Summary</code>\u3002</p>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#21-counter","title":"2.1 Counter \u8ba1\u6570\u5668","text":"<ul> <li>\u8ba1\u6570\u5668\u7c7b\u578b\uff0c\u53ea\u589e\u4e0d\u51cf</li> <li>\u9002\u7528\u4e8e\u673a\u5668\u542f\u52a8\u65f6\u95f4\u3001HTTP\u8bbf\u95ee\u91cf</li> <li>\u5177\u6709\u5f88\u597d\u7684\u4e0d\u76f8\u5173\u6027\uff0c\u4e0d\u4f1a\u56e0\u4e3a\u673a\u5668\u91cd\u542f\u800c\u7f6e<code>0</code></li> <li>\u901a\u5e38\u4f1a\u7ed3\u5408<code>rate()</code>\u65b9\u6cd5\u83b7\u53d6\u8be5\u6307\u6807\u5728\u67d0\u4e2a\u65f6\u95f4\u6bb5\u7684\u53d8\u5316\u7387</li> </ul>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#22-gauge","title":"2.2 Gauge","text":"<ul> <li>\u4eea\u8868\u76d8\uff0c\u8868\u5f81\u6307\u6807\u7684\u5b9e\u65f6\u53d8\u5316\u60c5\u51b5\u3002</li> <li>\u53ef\u589e\u53ef\u51cf\uff0c<code>CPU</code>\u548c\u5185\u5b58\u4f7f\u7528\u91cf\u3002</li> <li>\u5927\u90e8\u5206\u76d1\u63a7\u6570\u636e\u7c7b\u578b\u90fd\u662f<code>Gauge</code>\u7c7b\u578b\u7684</li> </ul>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#23-summary","title":"2.3 Summary","text":"<ul> <li>\u9ad8\u7ea7\u6307\u6807\uff0c\u7528\u4e8e\u51f8\u663e\u6570\u636e\u7684\u5206\u5e03\u60c5\u51b5</li> <li>\u67d0\u4e2a\u65f6\u95f4\u6bb5\u5185\u8bf7\u6c42\u7684\u54cd\u5e94\u65f6\u95f4</li> <li>\u53ef\u4ee5\u4e0e<code>Histogram</code>\u76f8\u4e92\u8f6c\u5316</li> <li>\u91c7\u6837\u70b9\u5206\u4f4d\u56fe\u7edf\u8ba1\uff0c\u7528\u4e8e\u5f97\u5230\u6570\u636e\u7684\u5206\u5e03\u60c5\u51b5</li> <li>\u65e0\u9700\u6d88\u8017\u670d\u52a1\u7aef\u8d44\u6e90</li> <li>\u4e0e<code>histogram</code>\u76f8\u6bd4\u6d88\u8017\u7cfb\u7edf\u8d44\u6e90\u66f4\u591a</li> <li>\u8ba1\u7b97\u7684\u6307\u6807\u4e0d\u80fd\u518d\u83b7\u53d6\u5e73\u5747\u6570\u7b49\u5176\u4ed6\u6307\u6807</li> <li>\u4e00\u822c\u53ea\u9002\u7528\u4e8e\u72ec\u7acb\u7684\u76d1\u63a7\u6307\u6807\uff0c\u5982\u5783\u573e\u56de\u6536\u65f6\u95f4\u7b49</li> </ul>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#24-histogram","title":"2.4 Histogram","text":"<ul> <li>\u53cd\u6620\u4e86\u67d0\u4e2a\u533a\u95f4\u5185\u7684\u6837\u672c\u4e2a\u6570\uff0c\u901a\u8fc7<code>{le=\"\u4e0a\u8fb9\u754c\"}</code>\u6307\u5b9a\u8fd9\u4e2a\u8303\u56f4\u5185\u7684\u6837\u672c\u6570\u3002</li> </ul>"},{"location":"chap1/18Adv_Prometheus_index_classfication/#25","title":"2.5 \u6570\u636e\u6837\u672c","text":"<p><code>Prometheus</code> \u91c7\u96c6\u7684\u6570\u636e\u6837\u672c\u90fd\u662f\u4ee5\u65f6\u95f4\u5e8f\u5217\u4fdd\u5b58\u7684\uff0c\u6bcf\u4e2a\u6837\u672c\u90fd\u7531\u4e09\u4e2a\u90e8\u5206\u7ec4\u6210</p> <ul> <li>\u6307\u6807</li> <li>\u6837\u672c\u503c\uff1a 64\u4f4d\u6d6e\u70b9\u6570\u548c\u65f6\u95f4\u6233\u7684\u7ec4\u5408\u4ee3\u8868\u8fd9\u4e2a\u65f6\u95f4\u70b9\u91c7\u96c6\u5230\u7684\u6570\u636e\u3002</li> <li>\u65f6\u95f4\u6233</li> </ul>"},{"location":"chap1/1prometheus2022/","title":"\u7b2c\u4e00\u8282 Prometheus \u7cfb\u7edf\u4ecb\u7ecd 2022","text":""},{"location":"chap1/1prometheus2022/#1","title":"1 \u7b80\u4ecb","text":"<p>Prometheus \u662f\u53e4\u5e0c\u814a\u795e\u8bdd\u91cc\u6cf0\u5766\u65cf\u7684\u4e00\u540d\u795e\u660e\uff0c\u540d\u5b57\u7684\u610f\u601d\u662f\u201c\u5148\u89c1\u4e4b\u660e\u201d\uff0c\u4e0b\u56fe\u4e2d\u662f Prometheus \u88ab\u5b99\u65af\u60e9\u7f5a\uff0c\u9971\u53d7\u809d\u810f\u65e5\u98df\u591c\u957f\u4e4b\u82e6\u3002</p> <p>\u5176\u5b98\u7f51\u5c01\u9762\u56fe\u5f15\u5bfc\u8bed\uff1aFrom metrics to insight\uff0c\u4ece\u6307\u6807\u5230\u6d1e\u5bdf\u529b\uff0c\u901a\u8fc7\u6307\u6807\u53bb\u6d1e\u5bdf\u4f60\u7684\u7cfb\u7edf\uff0c\u4e3a\u6211\u4eec\u7684\u7cfb\u7edf\u63d0\u4f9b\u6307\u6807\u6536\u96c6\u548c\u76d1\u63a7\u7684\u5f00\u6e90\u89e3\u51b3\u65b9\u6848\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cPrometheus \u662f\u4e00\u4e2a\u6570\u636e\u76d1\u63a7\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u8ba9\u6211\u4eec\u80fd\u968f\u65f6\u638c\u63e1\u7cfb\u7edf\u8fd0\u884c\u7684\u72b6\u6001\uff0c\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898\u548c\u6392\u9664\u6545\u969c\u3002</p> <p></p> <p>Prometheus \u53d1\u5c55\u901f\u5ea6\u5f88\u5feb\uff0c12 \u5e74\u5f00\u53d1\u5b8c\u6210\uff0c16 \u5e74\u52a0\u5165 CNCF\uff0c\u6210\u4e3a\u7ee7 Kubernetes \u4e4b\u540e\u7b2c\u4e8c\u4e2a CNCF \u6258\u7ba1\u7684\u9879\u76ee\uff0c\u76ee\u524d GitHub 42k \u7684 \ud83c\udf1f\uff0c\u800c\u4e14\u793e\u533a\u5f88\u6d3b\u8dc3\uff0c\u7ef4\u62a4\u9891\u7387\u5f88\u9ad8\uff0c\u57fa\u672c\u7a33\u5b9a\u5728 1 \u4e2a\u6708 1 \u4e2a\u5c0f\u7248\u672c\u7684\u8fed\u4ee3\u901f\u5ea6\u3002</p> <p></p>"},{"location":"chap1/1prometheus2022/#2","title":"2 \u6574\u4f53\u751f\u6001","text":"<p>Prometheus \u63d0\u4f9b\u4e86\u4ece\u6307\u6807\u66b4\u9732\uff0c\u5230\u6307\u6807\u6293\u53d6\u3001\u5b58\u50a8\u548c\u53ef\u89c6\u5316\uff0c\u4ee5\u53ca\u6700\u540e\u7684\u76d1\u63a7\u544a\u8b66\u7b49\u4e00\u7cfb\u5217\u7ec4\u4ef6\u3002</p> <p></p>"},{"location":"chap1/1prometheus2022/#2-1","title":"2-1 \u6307\u6807\u66b4\u9732","text":"<p>\u6bcf\u4e00\u4e2a\u88ab Prometheus \u76d1\u63a7\u7684\u670d\u52a1\u90fd\u662f\u4e00\u4e2a Job\uff0cPrometheus \u4e3a\u8fd9\u4e9b Job \u63d0\u4f9b\u4e86\u5b98\u65b9\u7684 SDK \uff0c\u5229\u7528\u8fd9\u4e2a SDK \u53ef\u4ee5\u81ea\u5b9a\u4e49\u5e76\u5bfc\u51fa\u81ea\u5df1\u7684\u4e1a\u52a1\u6307\u6807\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Prometheus \u5b98\u65b9\u63d0\u4f9b\u7684\u5404\u79cd\u5e38\u7528\u7ec4\u4ef6\u548c\u4e2d\u95f4\u4ef6\u7684 Exporter\uff08\u6bd4\u5982\u5e38\u7528\u7684 MySQL\uff0cConsul \u7b49\u7b49\uff09\u3002</p> <p>\u5bf9\u4e8e\u77ed\u65f6\u95f4\u6267\u884c\u7684\u811a\u672c\u4efb\u52a1\u6216\u8005\u4e0d\u597d\u76f4\u63a5 Pull \u6307\u6807\u7684\u670d\u52a1\uff0cPrometheus \u63d0\u4f9b\u4e86 PushGateWay \u7f51\u5173\u7ed9\u8fd9\u4e9b\u4efb\u52a1\u5c06\u670d\u52a1\u6307\u6807\u4e3b\u52a8\u63a8 Push \u5230\u7f51\u5173\uff0cPrometheus \u518d\u4ece\u8fd9\u4e2a\u7f51\u5173\u91cc Pull \u6307\u6807\u3002</p>"},{"location":"chap1/1prometheus2022/#2-2","title":"2-2 \u6307\u6807\u6293\u53d6","text":"<p>\u4e0a\u9762\u63d0\u5230\u4e86 Push \u548c Pull\uff0c\u5176\u5b9e\u8fd9\u662f\u4e24\u79cd\u6307\u6807\u6293\u53d6\u6a21\u578b\u3002</p> <p>Pull \u6a21\u578b\uff1a\u76d1\u63a7\u670d\u52a1\u4e3b\u52a8\u62c9\u53d6\u88ab\u76d1\u63a7\u670d\u52a1\u7684\u6307\u6807\u3002</p> <p></p> <p>\u88ab\u76d1\u63a7\u670d\u52a1\u4e00\u822c\u901a\u8fc7\u4e3b\u52a8\u66b4\u9732 metrics \u7aef\u53e3\u6216\u8005\u901a\u8fc7 Exporter \u7684\u65b9\u5f0f\u66b4\u9732\u6307\u6807\uff0c\u76d1\u63a7\u670d\u52a1\u4f9d\u8d56\u670d\u52a1\u53d1\u73b0\u6a21\u5757\u53d1\u73b0\u88ab\u76d1\u63a7\u670d\u52a1\uff0c\u4ece\u800c\u53bb\u5b9a\u671f\u7684\u6293\u53d6\u6307\u6807\u3002</p> <p>Push \u6a21\u578b\uff1a\u88ab\u76d1\u63a7\u670d\u52a1\u4e3b\u52a8\u5c06\u6307\u6807\u63a8\u9001\u5230\u76d1\u63a7\u670d\u52a1\uff0c\u53ef\u80fd\u9700\u8981\u5bf9\u6307\u6807\u505a\u534f\u8bae\u9002\u914d\uff0c\u5fc5\u987b\u5f97\u7b26\u5408\u76d1\u63a7\u670d\u52a1\u8981\u6c42\u7684\u6307\u6807\u683c\u5f0f\u3002</p> <p></p> <p>\u5bf9\u4e8e Prometheus \u4e2d\u7684\u6307\u6807\u6293\u53d6\uff0c\u91c7\u7528\u7684\u662f Pull \u6a21\u578b\uff0c\u9ed8\u8ba4\u662f\u4e00\u5206\u949f\u53bb\u62c9\u53d6\u4e00\u6b21\u6307\u6807\uff0c</p> <ul> <li>\u901a\u8fc7 Prometheus.yaml \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 <code>scrape_interval</code> \u914d\u7f6e\u9879\u914d\u7f6e\uff0cPrometheus \u5bf9\u5916\u90fd\u662f\u7528\u7684 Pull \u6a21\u578b</li> <li>\u4e00\u4e2a\u662f Pull Exporter \u7684\u66b4\u9732\u7684\u6307\u6807\uff0c</li> <li>\u4e00\u4e2a\u662f Pull PushGateway \u66b4\u9732\u7684\u6307\u6807\u3002</li> </ul>"},{"location":"chap1/1prometheus2022/#2-3","title":"2-3 \u6307\u6807\u5b58\u50a8\u548c\u67e5\u8be2","text":"<p>\u6307\u6807\u6293\u53d6\u540e\u4f1a\u5b58\u50a8\u5728\u5185\u7f6e\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u4e2d\uff0cPrometheus \u4e5f\u63d0\u4f9b\u4e86 PromQL \u67e5\u8be2\u8bed\u8a00\u7ed9\u6211\u4eec\u505a\u6307\u6807\u7684\u67e5\u8be2\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Prometheus \u7684 WebUI \u4e0a\u901a\u8fc7 PromQL\uff0c\u53ef\u89c6\u5316\u67e5\u8be2\u6211\u4eec\u7684\u6307\u6807\uff0c\u4e5f\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u63a5\u5165\u7b2c\u4e09\u65b9\u7684\u53ef\u89c6\u5316\u5de5\u5177\uff0c\u4f8b\u5982 Grafana\u3002</p>"},{"location":"chap1/1prometheus2022/#2-4","title":"2-4 \u76d1\u63a7\u544a\u8b66","text":"<p>Prometheus \u63d0\u4f9b\u4e86 Alertmanageer \u57fa\u4e8e PromQL \u6765\u505a\u7cfb\u7edf\u7684\u76d1\u63a7\u544a\u8b66\uff0c\u5f53 PromQL \u67e5\u8be2\u51fa\u6765\u7684\u6307\u6807\u8d85\u8fc7\u6211\u4eec\u5b9a\u4e49\u7684\u9608\u503c\u65f6\uff0cPrometheus \u4f1a\u53d1\u9001\u4e00\u6761\u544a\u8b66\u4fe1\u606f\u5230 Alertmanager\uff0cmanager \u4f1a\u5c06\u544a\u8b66\u4e0b\u53d1\u5230\u914d\u7f6e\u597d\u7684\u90ae\u7bb1\u6216\u8005\u5fae\u4fe1\u3002</p>"},{"location":"chap1/1prometheus2022/#3","title":"3 \u5de5\u4f5c\u539f\u7406","text":"<p>Prometheus \u7684\u4ece\u88ab\u76d1\u63a7\u670d\u52a1\u7684\u6ce8\u518c\u5230\u6307\u6807\u6293\u53d6\u5230\u6307\u6807\u67e5\u8be2\u7684\u6d41\u7a0b\u5206\u4e3a\u4e94\u4e2a\u6b65\u9aa4\uff1a</p> <p></p>"},{"location":"chap1/1prometheus2022/#3-1","title":"3-1 \u670d\u52a1\u6ce8\u518c","text":"<p>\u88ab\u76d1\u63a7\u670d\u52a1\u5728 Prometheus \u4e2d\u662f\u4e00\u4e2a Job \u5b58\u5728\uff0c\u88ab\u76d1\u63a7\u670d\u52a1\u7684\u6240\u6709\u5b9e\u4f8b\u5728 Prometheus \u4e2d\u662f\u4e00\u4e2a target \u7684\u5b58\u5728\uff0c\u6240\u4ee5\u88ab\u76d1\u63a7\u670d\u52a1\u7684\u6ce8\u518c\u5c31\u662f\u5728 Prometheus \u4e2d\u6ce8\u518c\u4e00\u4e2a Job \u548c\u5176\u6240\u6709\u7684 target\uff0c\u8fd9\u4e2a\u6ce8\u518c\u5206\u4e3a\uff1a</p> <ul> <li>\u9759\u6001\u6ce8\u518c</li> <li>\u52a8\u6001\u6ce8\u518c</li> </ul> <p>\u9759\u6001\u6ce8\u518c\uff1a\u9759\u6001\u7684\u5c06\u670d\u52a1\u7684 IP \u548c\u6293\u53d6\u6307\u6807\u7684\u7aef\u53e3\u53f7\u914d\u7f6e\u5728 Prometheus yaml \u6587\u4ef6\u7684 <code>scrape_configs</code> \u914d\u7f6e\u4e0b\uff1a</p> <pre><code>scrape_configs:\n - job_name: \"prometheus\"\n   static_configs:\n   - targets: [\"localhost:9090\"]\n</code></pre> <p>\u4ee5\u4e0a\u5c31\u662f\u6ce8\u518c\u4e86\u4e00\u4e2a\u540d\u4e3a Prometheus \u7684\u670d\u52a1\uff0c\u8fd9\u4e2a\u670d\u52a1\u4e0b\u6709\u4e00\u4e2a\u5b9e\u4f8b\uff0c\u66b4\u9732\u7684\u6293\u53d6\u5730\u5740\u662f localhost:9090\u3002</p> <p>\u52a8\u6001\u6ce8\u518c\uff1a\u52a8\u6001\u6ce8\u518c\u5c31\u662f\u5728 Prometheus yaml \u6587\u4ef6\u7684 <code>scrape_configs</code> \u914d\u7f6e\u4e0b\u914d\u7f6e\u670d\u52a1\u53d1\u73b0\u7684\u5730\u5740\u548c\u670d\u52a1\u540d\uff0cPrometheus \u4f1a\u53bb\u8be5\u5730\u5740\uff0c\u6839\u636e\u4f60\u63d0\u4f9b\u7684\u670d\u52a1\u540d\u52a8\u6001\u53d1\u73b0\u5b9e\u4f8b\u5217\u8868\uff0c\u5728 Prometheus \u4e2d\uff0c\u652f\u6301 Consul\u3001DNS\u3001\u6587\u4ef6\u3001Kubernetes \u7b49\u591a\u79cd\u670d\u52a1\u53d1\u73b0\u673a\u5236\u3002</p> <p>\u57fa\u4e8e Consul \u7684\u670d\u52a1\u53d1\u73b0\uff1a</p> <pre><code> - job_name: \"node_export_consul\"\n  metrics_path: /node_metrics\n  scheme: http\n  consul_sd_configs:\n   - server: localhost:8500\n     services:\n     - node_exporter\n</code></pre> <p><code>consul_sd_configs</code></p> <p>\u6211\u4eec Consul \u7684\u5730\u5740\u5c31\u662f\uff1alocalhost:8500\uff0c\u670d\u52a1\u540d\u662f <code>node_exporter</code>\uff0c\u5728\u8fd9\u4e2a\u670d\u52a1\u4e0b\u6709\u4e00\u4e2a exporter \u5b9e\u4f8b\uff1alocalhost:9600\u3002</p> <p></p> <p>\u6ce8\u610f\uff1a\u5982\u679c\u662f\u52a8\u6001\u6ce8\u518c\uff0c\u6700\u597d\u52a0\u4e0a\u8fd9\u4e24\u914d\u7f6e\uff0c\u9759\u6001\u6ce8\u518c\u6307\u6807\u62c9\u53d6\u7684\u8def\u5f84\u4f1a\u9ed8\u8ba4\u7684\u5e2e\u6211\u4eec\u6307\u5b9a\u4e3a <code>metrics_path:/metrics</code>\uff0c\u6240\u4ee5\u5982\u679c\u66b4\u9732\u7684\u6307\u6807\u6293\u53d6\u8def\u5f84\u4e0d\u540c\u6216\u8005\u662f\u52a8\u6001\u7684\u670d\u52a1\u6ce8\u518c\uff0c\u6700\u597d\u52a0\u4e0a\u8fd9\u4e24\u4e2a\u914d\u7f6e\u3002</p> <pre><code>metrics_path: /node_metrics\nscheme: http\n</code></pre> <p>\u4e0d\u7136\u4f1a\u62a5\u9519\u201cINVALID is not a valid start token\u201d\uff0c\u6f14\u793a\u4e0b\uff0c\u767e\u5ea6\u4e86\u4e00\u4e0b\uff0c\u8fd9\u91cc\u53ef\u80fd\u662f\u6570\u636e\u683c\u5f0f\u4e0d\u7edf\u4e00\u5bfc\u81f4\u3002</p> <p>\u6700\u540e\u53ef\u4ee5\u5728 WebUI \u4e2d\u67e5\u770b\u53d1\u73b0\u7684\u5b9e\u4f8b\uff1a</p> <p></p> <p>\u76ee\u524d\uff0cPrometheus \u652f\u6301\u591a\u8fbe\u4e8c\u5341\u591a\u79cd\u670d\u52a1\u53d1\u73b0\u534f\u8bae\uff1a</p> <pre><code>&lt;azure_sd_config&gt;\n&lt;consul_sd_config&gt;\n&lt;digitalocean_sd_config&gt;\n&lt;docker_sd_config&gt;\n&lt;dockerswarm_sd_config&gt;\n&lt;dns_sd_config&gt;\n&lt;ec2_sd_config&gt;\n&lt;openstack_sd_config&gt;\n&lt;file_sd_config&gt;\n&lt;gce_sd_config&gt;\n&lt;hetzner_sd_config&gt;\n&lt;http_sd_config&gt;\n&lt;kubernetes_sd_config&gt;\n&lt;kuma_sd_config&gt;\n&lt;lightsail_sd_config&gt;\n&lt;linode_sd_config&gt;\n&lt;marathon_sd_config&gt;\n&lt;nerve_sd_config&gt;\n&lt;serverset_sd_config&gt;\n&lt;triton_sd_config&gt;\n&lt;eureka_sd_config&gt;\n&lt;scaleway_sd_config&gt;\n&lt;static_config&gt;\n</code></pre>"},{"location":"chap1/1prometheus2022/#3-2","title":"3-2 \u914d\u7f6e\u66f4\u65b0","text":"<p>\u5728\u66f4\u65b0\u5b8c Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u9700\u8981\u66f4\u65b0\u6211\u4eec\u7684\u914d\u7f6e\u5230\u7a0b\u5e8f\u5185\u5b58\u91cc\uff0c\u8fd9\u91cc\u7684\u66f4\u65b0\u65b9\u5f0f\u6709\u4e24\u79cd\uff0c\u7b2c\u4e00\u79cd\u7b80\u5355\u7c97\u66b4\uff0c\u5c31\u662f\u91cd\u542f Prometheus\uff0c\u7b2c\u4e8c\u79cd\u662f\u52a8\u6001\u66f4\u65b0\u7684\u65b9\u5f0f\u3002</p> <p>\u5982\u4f55\u5b9e\u73b0\u52a8\u6001\u7684\u66f4\u65b0 Prometheus \u914d\u7f6e\u3002</p> <p>\u7b2c\u4e00\u6b65\uff1a\u9996\u5148\u8981\u4fdd\u8bc1\u542f\u52a8 Prometheus \u7684\u65f6\u5019\u5e26\u4e0a\u542f\u52a8\u53c2\u6570\uff1a<code>--web.enable-lifecycle</code>\u3002</p> <pre><code>prometheus --config.file=/usr/local/etc/prometheus.yml --web.enable-lifecycle\n</code></pre> <p>\u7b2c\u4e8c\u6b65\uff1a\u53bb\u66f4\u65b0\u6211\u4eec\u7684 Prometheus \u914d\u7f6e\u3002</p> <p>\u7b2c\u4e09\u6b65\uff1a\u66f4\u65b0\u5b8c\u914d\u7f6e\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Post \u8bf7\u6c42\u7684\u65b9\u5f0f\uff0c\u52a8\u6001\u66f4\u65b0\u914d\u7f6e\uff1a</p> <pre><code>curl -v --request POST 'http://localhost:9090/-/reload'\n</code></pre> <p>\u539f\u7406\uff1a</p> <p>Prometheus \u5728 Web \u6a21\u5757\u4e2d\uff0c\u6ce8\u518c\u4e86\u4e00\u4e2a handler\uff1a</p> <pre><code>if o.EnableLifecycle {\n  router.Post(\"/-/quit\", h.quit)\n  router.Put(\"/-/quit\", h.quit)\n  router.Post(\"/-/reload\", h.reload) // reload\u914d\u7f6e\n  router.Put(\"/-/reload\", h.reload)\n}\n</code></pre> <p>\u901a\u8fc7 <code>h.reload</code> \u8fd9\u4e2a handler \u65b9\u6cd5\u5b9e\u73b0\uff1a\u8fd9\u4e2a handler \u5c31\u662f\u5f80\u4e00\u4e2a channle \u4e2d\u53d1\u9001\u4e00\u4e2a\u4fe1\u53f7\uff1a</p> <pre><code>func (h *Handler) reload(w http.ResponseWriter, r *http.Request) {\n  rc := make(chan error)\n  h.reloadCh &lt;- rc  // \u53d1\u9001\u4e00\u4e2a\u4fe1\u53f7\u5230channe\u4e86\u4e2d\n  if err := &lt;-rc; err != nil {\n   http.Error(w, fmt.Sprintf(\"failed to reload config: %s\", err), http.StatusInternalServerError)\n  }\n}\n</code></pre> <p>\u5728 main \u51fd\u6570\u4e2d\u4f1a\u53bb\u76d1\u542c\u8fd9\u4e2a channel\uff0c\u53ea\u8981\u6709\u76d1\u542c\u5230\u4fe1\u53f7\uff0c\u5c31\u4f1a\u505a\u914d\u7f6e\u7684 reload\uff0c\u91cd\u65b0\u5c06\u65b0\u914d\u7f6e\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\uff1a</p> <p><code>case rc := &lt;-webHandler.Reload():   if err := reloadConfig(cfg.configFile, cfg.enableExpandExternalLabels, cfg.tsdb.EnableExemplarStorage, logger, noStepSubqueryInterval, reloaders...); err != nil {    level.Error(logger).Log(\"msg\", \"Error reloading config\", \"err\", err)    rc &lt;- err   } else {    rc &lt;- nil   }</code></p>"},{"location":"chap1/1prometheus2022/#3-3","title":"3-3 \u6307\u6807\u6293\u53d6\u548c\u5b58\u50a8","text":"<p>Prometheus \u5bf9\u6307\u6807\u7684\u6293\u53d6\u91c7\u53d6\u4e3b\u52a8 Pull \u7684\u65b9\u5f0f\uff0c\u5373\u5468\u671f\u6027\u7684\u8bf7\u6c42\u88ab\u76d1\u63a7\u670d\u52a1\u66b4\u9732\u7684 Metrics \u63a5\u53e3\u6216\u8005\u662f PushGateway\uff0c\u4ece\u800c\u83b7\u53d6\u5230 Metrics \u6307\u6807\uff0c\u9ed8\u8ba4\u65f6\u95f4\u662f 15s \u6293\u53d6\u4e00\u6b21\uff0c\u914d\u7f6e\u9879\u5982\u4e0b\uff1a</p> <pre><code>global:\n scrape_interval: 15s\n</code></pre> <p>\u6293\u53d6\u5230\u7684\u6307\u6807\u4f1a\u88ab\u4ee5\u65f6\u95f4\u5e8f\u5217\u7684\u5f62\u5f0f\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u5e76\u4e14\u5b9a\u65f6\u5237\u5230\u78c1\u76d8\u4e0a\uff0c\u9ed8\u8ba4\u662f\u4e24\u4e2a\u5c0f\u65f6\u56de\u5237\u4e00\u6b21\u3002\u5e76\u4e14\u4e3a\u4e86\u9632\u6b62 Prometheus \u53d1\u751f\u5d29\u6e83\u6216\u91cd\u542f\u65f6\u80fd\u591f\u6062\u590d\u6570\u636e\uff0cPrometheus \u4e5f\u63d0\u4f9b\u4e86\u7c7b\u4f3c MySQL \u4e2d binlog \u4e00\u6837\u7684\u9884\u5199\u65e5\u5fd7\uff0c\u5f53 Prometheus \u5d29\u6e83\u91cd\u542f\u65f6\uff0c\u4f1a\u8bfb\u8fd9\u4e2a\u9884\u5199\u65e5\u5fd7\u6765\u6062\u590d\u6570\u636e\u3002</p>"},{"location":"chap1/1prometheus2022/#4-metric","title":"4 Metric \u6307\u6807","text":""},{"location":"chap1/1prometheus2022/#4-1","title":"4-1 \u6570\u636e\u6a21\u578b","text":"<p>Prometheus \u91c7\u96c6\u7684\u6240\u6709\u6307\u6807\u90fd\u662f\u4ee5\u65f6\u95f4\u5e8f\u5217\u7684\u5f62\u5f0f\u8fdb\u884c\u5b58\u50a8\uff0c\u6bcf\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u6709\u4e09\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li>\u6307\u6807\u540d\u548c\u6307\u6807\u6807\u7b7e\u96c6\u5408\uff1a<code>metric_name{&lt;label1=v1&gt;,&lt;label2=v2&gt;....}</code>\uff0c\u6307\u6807\u540d\uff1a\u8868\u793a\u8fd9\u4e2a\u6307\u6807\u662f\u76d1\u63a7\u54ea\u4e00\u65b9\u9762\u7684\u72b6\u6001\uff0c\u6bd4\u5982 <code>http_request_total</code> \u8868\u793a\u8bf7\u6c42\u6570\u91cf\uff1b<ul> <li>\u6307\u6807\u6807\u7b7e\uff1a\u63cf\u8ff0\u8fd9\u4e2a\u6307\u6807\u6709\u54ea\u4e9b\u7ef4\u5ea6\uff0c\u6bd4\u5982 <code>http_request_total</code> \u8fd9\u4e2a\u6307\u6807\uff0c\u6709\u8bf7\u6c42\u72b6\u6001\u7801 <code>code = 200/400/500</code>\uff0c\u8bf7\u6c42\u65b9\u5f0f <code>method = get/post</code> \u7b49\uff0c\u5b9e\u9645\u4e0a\u6307\u6807\u540d\u79f0\u5b9e\u9645\u4e0a\u662f\u4ee5\u6807\u7b7e\u7684\u5f62\u5f0f\u4fdd\u5b58\uff0c\u8fd9\u4e2a\u6807\u7b7e\u662f name\uff0c\u5373\uff1aname=\u3002</li> </ul> </li> <li>\u65f6\u95f4\u6233\uff1a\u63cf\u8ff0\u5f53\u524d\u65f6\u95f4\u5e8f\u5217\u7684\u65f6\u95f4\uff0c\u5355\u4f4d\uff1a\u6beb\u79d2</li> <li>\u6837\u672c\u503c\uff1a\u5f53\u524d\u76d1\u63a7\u6307\u6807\u7684\u5177\u4f53\u6570\u503c\uff0c\u6bd4\u5982 <code>http_request_total</code> \u7684\u503c\u5c31\u662f\u8bf7\u6c42\u6570\u662f\u591a\u5c11\u3002</li> </ul> <p></p> <p>\u6240\u6709\u7684\u6307\u6807\u4e5f\u90fd\u662f\u901a\u8fc7\u5982\u4e0b\u6240\u793a\u7684\u683c\u5f0f\u6765\u6807\u8bc6\u7684\uff1a</p> <pre><code># HELP  // HELP\uff1a\u8fd9\u91cc\u63cf\u8ff0\u7684\u6307\u6807\u7684\u4fe1\u606f\uff0c\u8868\u793a\u8fd9\u4e2a\u662f\u4e00\u4e2a\u4ec0\u4e48\u6307\u6807\uff0c\u7edf\u8ba1\u4ec0\u4e48\u7684\n# TYPE  // TYPE\uff1a\u8fd9\u4e2a\u6307\u6807\u662f\u4ec0\u4e48\u7c7b\u578b\u7684\n&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...} value  // \u6307\u6807\u7684\u5177\u4f53\u683c\u5f0f\uff0c&lt;\u6307\u6807\u540d&gt;{\u6807\u7b7e\u96c6\u5408} \u6307\u6807\u503c\n</code></pre>"},{"location":"chap1/1prometheus2022/#4-2","title":"4-2 \u6307\u6807\u7c7b\u578b","text":"<p>Prometheus \u5e95\u5c42\u5b58\u50a8\u4e0a\u5176\u5b9e\u5e76\u6ca1\u6709\u5bf9\u6307\u6807\u505a\u7c7b\u578b\u7684\u533a\u5206\uff0c\u90fd\u662f\u4ee5\u65f6\u95f4\u5e8f\u5217\u7684\u5f62\u5f0f\u5b58\u50a8\uff0c\u4f46\u662f\u4e3a\u4e86\u65b9\u4fbf\u7528\u6237\u7684\u4f7f\u7528\u548c\u7406\u89e3\u4e0d\u540c\u76d1\u63a7\u6307\u6807\u4e4b\u95f4\u7684\u5dee\u5f02\uff0c</p> <p><code>Prometheus</code> \u5b9a\u4e49\u4e86 4 \u79cd\u4e0d\u540c\u7684\u6307\u6807\u7c7b\u578b\uff1a\u8ba1\u6570\u5668 <code>counter</code>\uff0c\u4eea\u8868\u76d8<code>gauge</code>\uff0c\u76f4\u65b9\u56fe <code>histogram</code>\uff0c\u6458\u8981 <code>summary</code>\u3002</p> <p></p> <p>Counter \u8ba1\u6570\u5668\uff1a</p> <p>Counter \u7c7b\u578b\u548c Redis \u7684\u81ea\u589e\u547d\u4ee4\u4e00\u6837\uff0c\u53ea\u589e\u4e0d\u51cf\uff0c\u901a\u8fc7 Counter \u6307\u6807\u53ef\u4ee5\u7edf\u8ba1 Http \u8bf7\u6c42\u6570\u91cf\uff0c\u8bf7\u6c42\u9519\u8bef\u6570\uff0c\u63a5\u53e3\u8c03\u7528\u6b21\u6570\u7b49\u5355\u8c03\u9012\u589e\u7684\u6570\u636e\u3002\u540c\u65f6\u53ef\u4ee5\u7ed3\u5408 increase \u548c rate \u7b49\u51fd\u6570\u7edf\u8ba1\u53d8\u5316\u901f\u7387\uff0c\u540e\u7eed\u6211\u4eec\u4f1a\u63d0\u5230\u8fd9\u4e9b\u5185\u7f6e\u51fd\u6570\u3002</p> <p></p> <p>Gauge \u4eea\u8868\u76d8\uff1a</p> <p>\u548c Counter \u4e0d\u540c\uff0cGauge \u662f\u53ef\u589e\u53ef\u51cf\u7684\uff0c\u53ef\u4ee5\u53cd\u6620\u4e00\u4e9b\u52a8\u6001\u53d8\u5316\u7684\u6570\u636e\uff0c\u4f8b\u5982\u5f53\u524d\u5185\u5b58\u5360\u7528\uff0cCPU \u5229\u7528\uff0cGc \u6b21\u6570\u7b49\u52a8\u6001\u53ef\u4e0a\u5347\u53ef\u4e0b\u964d\u7684\u6570\u636e\uff0c\u5728 Prometheus \u4e0a\u901a\u8fc7 Gauge\uff0c\u53ef\u4ee5\u4e0d\u7528\u7ecf\u8fc7\u5185\u7f6e\u51fd\u6570\u76f4\u89c2\u7684\u53cd\u6620\u6570\u636e\u7684\u53d8\u5316\u60c5\u51b5\uff0c\u5982\u4e0b\u56fe\u8868\u793a\u5806\u53ef\u5206\u914d\u7684\u7a7a\u95f4\u5927\u5c0f\uff1a</p> <p></p> <p>Histogram \u76f4\u65b9\u56fe\uff1a</p> <p>Histogram \u662f\u4e00\u79cd\u76f4\u65b9\u56fe\u7c7b\u578b\uff0c\u53ef\u4ee5\u89c2\u5bdf\u5230\u6307\u6807\u5728\u5404\u4e2a\u4e0d\u540c\u7684\u533a\u95f4\u8303\u56f4\u7684\u5206\u5e03\u60c5\u51b5\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a\u53ef\u4ee5\u89c2\u5bdf\u5230\u8bf7\u6c42\u8017\u65f6\u5728\u5404\u4e2a\u6876\u7684\u5206\u5e03\u3002</p> <p></p> <p>\u6709\u4e00\u70b9\u8981\u6ce8\u610f\u7684\u662f\uff0cHistogram \u662f\u7d2f\u8ba1\u76f4\u65b9\u56fe\uff0c\u5373\u6bcf\u4e00\u4e2a\u6876\u7684\u662f\u53ea\u6709\u4e0a\u533a\u95f4\uff0c\u4f8b\u5982\u4e0b\u56fe\u8868\u793a\u5c0f\u4e8e 0.1 \u6beb\u79d2\uff08le=\"0.1\"\uff09\u7684\u8bf7\u6c42\u6570\u91cf\u662f 18173 \u4e2a\uff0c\u5c0f\u4e8e 0.2 \u6beb\u79d2\uff08le=\"0.2\"\uff09\u7684\u8bf7\u6c42\u662f 18182 \u4e2a\uff0c\u5728 le=\"0.2\" \u8fd9\u4e2a\u6876\u4e2d\u662f\u5305\u542b\u4e86 le=\"0.1\"\u8fd9\u4e2a\u6876\u7684\u6570\u636e\uff0c\u5982\u679c\u6211\u4eec\u8981\u62ff\u5230 0.1 \u6beb\u79d2\u5230 0.2 \u6beb\u79d2\u7684\u8bf7\u6c42\u6570\u91cf\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e24\u4e2a\u6876\u60f3\u51cf\u5f97\u5230\u3002</p> <p></p> <p>\u5728\u76f4\u65b9\u56fe\u4e2d\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 <code>histogram_quantile</code> \u51fd\u6570\u6c42\u51fa\u767e\u5206\u4f4d\u6570\uff0c\u6bd4\u5982 P50\u3001P90\u3001P99 \u7b49\u6570\u636e\u3002</p> <p>Summary \u6458\u8981\uff1a</p> <p>Summary \u4e5f\u662f\u7528\u6765\u505a\u7edf\u8ba1\u5206\u6790\u7684\uff0c\u548c Histogram \u533a\u522b\u5728\u4e8e\uff0cSummary \u76f4\u63a5\u5b58\u50a8\u7684\u5c31\u662f\u767e\u5206\u4f4d\u6570\uff0c\u5982\u4e0b\u6240\u793a\uff1a\u53ef\u4ee5\u76f4\u89c2\u7684\u89c2\u5bdf\u5230\u6837\u672c\u7684\u4e2d\u4f4d\u6570\uff0cP90 \u548c P99\u3002</p> <p></p> <p>Summary \u7684\u767e\u5206\u4f4d\u6570\u662f\u5ba2\u6237\u7aef\u8ba1\u7b97\u597d\u76f4\u63a5\u8ba9 Prometheus \u6293\u53d6\u7684\uff0c\u4e0d\u9700\u8981 Prometheus \u8ba1\u7b97\uff0c\u76f4\u65b9\u56fe\u662f\u901a\u8fc7\u5185\u7f6e\u51fd\u6570 <code>histogram_quantile</code> \u5728 Prometheus \u670d\u52a1\u7aef\u8ba1\u7b97\u6c42\u51fa\u3002</p>"},{"location":"chap1/1prometheus2022/#4-3","title":"4-3 \u6307\u6807\u5bfc\u51fa","text":"<p>\u6807\u5bfc\u51fa\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u4e00\u79cd\u662f\u4f7f\u7528 Prometheus \u793e\u533a\u63d0\u4f9b\u7684\u5b9a\u5236\u597d\u7684 Exporter \u5bf9\u4e00\u4e9b\u7ec4\u4ef6\u8bf8\u5982 MySQL\uff0cKafka \u7b49\u7684\u6307\u6807\u4f5c\u5bfc\u51fa\uff0c\u4e5f\u53ef\u4ee5\u5229\u7528\u793e\u533a\u63d0\u4f9b\u7684 Client \u6765\u81ea\u5b9a\u4e49\u6307\u6807\u5bfc\u51fa\u3002</p> <pre><code>github.com/prometheus/client_golang/prometheus/promhttp\n</code></pre> <p>\u81ea\u5b9a\u4e49 Prometheus exporter\uff1a</p> <pre><code>package main\nimport (\n  \"net/http\"\n  \"github.com/prometheus/client_golang/prometheus/promhttp\"\n)\n\nfunc main() {\n  http.Handle(\"/metrics\", promhttp.Handler())\n  http.ListenAndServe(\":8080\", nil)\n}\n</code></pre> <p>\u8bbf\u95ee\uff1a<code>http://localhost:8080/metrics</code>\uff0c\u5373\u53ef\u770b\u5230\u5bfc\u51fa\u7684\u6307\u6807\uff0c\u8fd9\u91cc\u6211\u4eec\u6ca1\u6709\u81ea\u5b9a\u4e49\u4efb\u4f55\u7684\u6307\u6807\uff0c\u4f46\u662f\u80fd\u770b\u5230\u4e00\u4e9b\u5185\u7f6e\u7684 Go \u7684\u8fd0\u884c\u65f6\u6307\u6807\u548c promhttp \u76f8\u5173\u7684\u6307\u6807\uff0c\u8fd9\u4e2a Client \u9ed8\u8ba4\u4e3a\u6211\u4eec\u66b4\u9732\u7684\u6307\u6807\uff0c<code>go_\uff1a</code> \u4ee5 go \u4e3a\u524d\u7f00\u7684\u6307\u6807\u662f\u5173\u4e8e Go \u8fd0\u884c\u65f6\u76f8\u5173\u7684\u6307\u6807\uff0c\u6bd4\u5982\u5783\u573e\u56de\u6536\u65f6\u95f4\u3001goroutine \u6570\u91cf\u7b49\uff0c\u8fd9\u4e9b\u90fd\u662f Go \u5ba2\u6237\u7aef\u5e93\u7279\u6709\u7684\uff0c\u5176\u4ed6\u8bed\u8a00\u7684\u5ba2\u6237\u7aef\u5e93\u53ef\u80fd\u4f1a\u66b4\u9732\u5404\u81ea\u8bed\u8a00\u7684\u5176\u4ed6\u8fd0\u884c\u65f6\u6307\u6807\u3002</p> <p>promhttp\uff1a\u6765\u81ea promhttp \u5de5\u5177\u5305\u7684\u76f8\u5173\u6307\u6807\uff0c\u7528\u4e8e\u8ddf\u8e2a\u5bf9\u6307\u6807\u8bf7\u6c42\u7684\u5904\u7406\u3002</p> <p></p> <p></p> <p>\u6dfb\u52a0\u81ea\u5b9a\u4e49\u6307\u6807\uff1a</p> <pre><code>package main\nimport (\n  \"net/http\"\n\n  \"github.com/prometheus/client_golang/prometheus\"\n  \"github.com/prometheus/client_golang/prometheus/promhttp\"\n)\n\nfunc main() {\n\n  // 1.\u5b9a\u4e49\u6307\u6807\uff08\u7c7b\u578b\uff0c\u540d\u5b57\uff0c\u5e2e\u52a9\u4fe1\u606f\uff09\n  myCounter := prometheus.NewCounter(prometheus.CounterOpts{\n   Name: \"my_counter_total\",\n   Help: \"\u81ea\u5b9a\u4e49counter\",\n  })\n  // 2.\u6ce8\u518c\u6307\u6807\n  prometheus.MustRegister(myCounter)\n  // 3.\u8bbe\u7f6e\u6307\u6807\u503c\n  myCounter.Add(23)\n\n  http.Handle(\"/metrics\", promhttp.Handler())\n  http.ListenAndServe(\":8080\", nil)\n\n}\n</code></pre> <p>\u8fd0\u884c\uff1a</p> <p></p> <p>\u6a21\u62df\u4e0b\u5728\u4e1a\u52a1\u4e2d\u4e0a\u62a5\u63a5\u53e3\u8bf7\u6c42\u91cf\uff1a</p> <pre><code>package main\n\nimport (\n  \"fmt\"\n  \"net/http\"\n  \"github.com/prometheus/client_golang/prometheus\"\n)\n\nvar (\n  MyCounter prometheus.Counter\n)\n\n\n// init \u6ce8\u518c\u6307\u6807\nfunc init() {\n  // 1.\u5b9a\u4e49\u6307\u6807\uff08\u7c7b\u578b\uff0c\u540d\u5b57\uff0c\u5e2e\u52a9\u4fe1\u606f\uff09\n  MyCounter = prometheus.NewCounter(prometheus.CounterOpts{\n   Name: \"my_counter_total\",\n   Help: \"\u81ea\u5b9a\u4e49counter\",\n  })\n\n  // 2.\u6ce8\u518c\u6307\u6807\n  prometheus.MustRegister(MyCounter)\n}\n\n// Sayhello\nfunc Sayhello(w http.ResponseWriter, r *http.Request) {\n  // \u63a5\u53e3\u8bf7\u6c42\u91cf\u9012\u589e\n  MyCounter.Inc()\n  fmt.Fprintf(w, \"Hello World!\")\n}\n</code></pre> <p>main.go\uff1a</p> <pre><code>package main\nimport (\n  \"net/http\"\n  \"github.com/prometheus/client_golang/prometheus/promhttp\"\n)\nfunc main() {\n  http.Handle(\"/metrics\", promhttp.Handler())\n  http.HandleFunc(\"/counter\",Sayhello)\n  http.ListenAndServe(\":8080\", nil)\n}\n</code></pre> <p>\u4e00\u5f00\u59cb\u542f\u52a8\u65f6\uff0c\u6307\u6807 counter \u662f 0\uff1a</p> <p></p> <p>\u8c03\u7528\uff1a/counter \u63a5\u53e3\u540e\uff0c\u6307\u6807\u6570\u636e\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7b80\u5355\u5b9e\u73b0\u4e86\u63a5\u53e3\u8bf7\u6c42\u6570\u7684\u7edf\u8ba1\uff1a</p> <p></p> <p>\u5bf9\u4e8e\u5176\u4ed6\u6307\u6807\u5b9a\u4e49\u65b9\u5f0f\u662f\u4e00\u6837\u7684\uff1a</p> <pre><code>var (\n  MyCounter prometheus.Counter\n  MyGauge prometheus.Gauge\n  MyHistogram prometheus.Histogram\n  MySummary prometheus.Summary\n\n)\n\n// init \u6ce8\u518c\u6307\u6807\nfunc init() {\n  // 1.\u5b9a\u4e49\u6307\u6807\uff08\u7c7b\u578b\uff0c\u540d\u5b57\uff0c\u5e2e\u52a9\u4fe1\u606f\uff09\n  MyCounter = prometheus.NewCounter(prometheus.CounterOpts{\n   Name: \"my_counter_total\",\n   Help: \"\u81ea\u5b9a\u4e49counter\",\n  })\n\n  // \u5b9a\u4e49gauge\u7c7b\u578b\u6307\u6807\n  MyGauge = prometheus.NewGauge(prometheus.GaugeOpts{\n   Name: \"my_gauge_num\",\n   Help: \"\u81ea\u5b9a\u4e49gauge\",\n\n  })\n\n  // \u5b9a\u4e49histogram\n  MyHistogram = prometheus.NewHistogram(prometheus.HistogramOpts{\n   Name: \"my_histogram_bucket\",\n   Help: \"\u81ea\u5b9a\u4e49histogram\",\n   Buckets: []float64{0.1,0.2,0.3,0.4,0.5},  // \u9700\u8981\u6307\u5b9a\u6876\n\n  })\n\n  // \u5b9a\u4e49Summary\n  MySummary = prometheus.NewSummary(prometheus.SummaryOpts{\n   Name: \"my_summary_bucket\",\n   Help: \"\u81ea\u5b9a\u4e49summary\",\n   // \u8fd9\u90e8\u5206\u53ef\u4ee5\u7b97\u597d\u540e\u5728set\n   Objectives: map[float64]float64{\n     0.5: 0.05,\n     0.9: 0.01,\n     0.99: 0.001,\n   },\n  })\n\n  // 2.\u6ce8\u518c\u6307\u6807\n  prometheus.MustRegister(MyCounter)\n  prometheus.MustRegister(MyGauge)\n  prometheus.MustRegister(MyHistogram)\n  prometheus.MustRegister(MySummary)\n}\n</code></pre> <p></p> <p>\u4e0a\u9762\u7684\u6307\u6807\u90fd\u662f\u6ca1\u6709\u8bbe\u7f6e\u6807\u7b7e\u7684\uff0c\u6211\u4eec\u4e00\u822c\u7684\u6307\u6807\u90fd\u662f\u5e26\u6709\u6807\u7b7e\u7684\uff0c\u5982\u4f55\u8bbe\u7f6e\u6307\u6807\u7684\u6807\u7b7e\u5462\uff1f</p> <p>\u5982\u679c\u6211\u8981\u8bbe\u7f6e\u5e26\u6807\u7b7e\u7684 counter \u7c7b\u578b\u6307\u6807\uff0c\u53ea\u9700\u8981\u5c06\u539f\u6765\u7684 NewCounter \u65b9\u6cd5\u66ff\u6362\u4e3a NewCounterVec \u65b9\u6cd5\u5373\u53ef\uff0c\u5e76\u4e14\u4f20\u5165\u6807\u7b7e\u96c6\u5408\u3002</p> <pre><code>MyCounter *prometheus.CounterVec\n// 1.\u5b9a\u4e49\u6307\u6807\uff08\u7c7b\u578b\uff0c\u540d\u5b57\uff0c\u5e2e\u52a9\u4fe1\u606f\uff09\nMyCounter = prometheus.NewCounterVec(\n  prometheus.CounterOpts{\n  Name: \"my_counter_total\",\n  Help: \"\u81ea\u5b9a\u4e49counter\",\n  },\n  // \u6807\u7b7e\u96c6\u5408\n  []string{\"label1\",\"label2\"},\n)\n// \u5e26\u6807\u7b7e\u7684set\u6307\u6807\u503c\nMyCounter.With(prometheus.Labels{\"label1\":\"1\",\"label2\":\"2\"}).Inc()\n</code></pre> <p></p>"},{"location":"chap1/1prometheus2022/#5-promql","title":"5 PromQL","text":"<p>\u521a\u521a\u63d0\u5230\u4e86 Prometheus \u4e2d\u6307\u6807\u6709\u54ea\u4e9b\u7c7b\u578b\u4ee5\u53ca\u5982\u4f55\u5bfc\u51fa\u6211\u4eec\u7684\u6307\u6807\uff0c\u73b0\u5728\u6307\u6807\u5bfc\u51fa\u5230 Prometheus \u4e86\uff0c\u5229\u7528\u5176\u63d0\u4f9b\u7684 PromQL \u53ef\u4ee5\u67e5\u8be2\u6211\u4eec\u5bfc\u51fa\u7684\u6307\u6807\u3002</p> <p>PromQL \u662f Prometheus \u4e3a\u6211\u4eec\u63d0\u4f9b\u7684\u51fd\u6570\u5f0f\u7684\u67e5\u8be2\u8bed\u8a00\uff0c\u67e5\u8be2\u8868\u8fbe\u5f0f\u6709\u56db\u79cd\u7c7b\u578b\uff1a</p> <ul> <li>\u5b57\u7b26\u4e32\uff1a\u53ea\u4f5c\u4e3a\u67d0\u4e9b\u5185\u7f6e\u51fd\u6570\u7684\u53c2\u6570\u51fa\u73b0</li> <li>\u6807\u91cf\uff1a\u5355\u4e00\u7684\u6570\u5b57\u503c\uff0c\u53ef\u4ee5\u662f\u51fd\u6570\u53c2\u6570\uff0c\u4e5f\u53ef\u4ee5\u662f\u51fd\u6570\u7684\u8fd4\u56de\u7ed3\u679c</li> <li>\u77ac\u65f6\u5411\u91cf\uff1a\u67d0\u4e00\u65f6\u523b\u7684\u65f6\u5e8f\u6570\u636e</li> <li>\u533a\u95f4\u5411\u91cf\uff1a\u67d0\u4e00\u65f6\u95f4\u533a\u95f4\u5185\u7684\u65f6\u5e8f\u6570\u636e\u96c6\u5408</li> </ul>"},{"location":"chap1/1prometheus2022/#5-1","title":"5-1 \u77ac\u65f6\u67e5\u8be2","text":"<p>\u76f4\u63a5\u901a\u8fc7\u6307\u6807\u540d\u5373\u53ef\u8fdb\u884c\u67e5\u8be2\uff0c\u67e5\u8be2\u7ed3\u679c\u662f\u5f53\u524d\u6307\u6807\u6700\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u6bd4\u5982\u67e5\u8be2 Gc \u7d2f\u79ef\u6d88\u8017\u7684\u65f6\u95f4\uff1a</p> <pre><code>go_gc_duration_seconds_count\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u67e5\u8be2\u51fa\u6765\u6709\u591a\u4e2a\u540c\u540d\u6307\u6807\u7ed3\u679c\uff0c\u53ef\u4ee5\u7528<code>{}</code>\u505a\u6807\u7b7e\u8fc7\u6ee4\u67e5\u8be2\uff1a\u6bd4\u5982\u6211\u4eec\u60f3\u67e5\u6307\u5b9a\u5b9e\u4f8b\u7684\u6307\u6807\u3002</p> <p></p> <pre><code>go_gc_duration_seconds_count{instance=\"127.0.0.1:9600\"}\n</code></pre> <p>\u800c\u4e14\u4e5f\u652f\u6301\u5219\u8868\u8fbe\u5f0f\uff0c\u901a\u8fc7 <code>=~</code>\u6307\u5b9a\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5982\u4e0b\u6240\u793a\uff1a\u67e5\u8be2\u6240\u6709 instance \u662f localhost \u5f00\u5934\u7684\u6307\u6807\u3002</p> <p></p> <pre><code>go_gc_duration_seconds_count{instance=~\"localhost.*\"}\n</code></pre> <p></p>"},{"location":"chap1/1prometheus2022/#5-2","title":"5-2 \u8303\u56f4\u67e5\u8be2","text":"<p>\u8303\u56f4\u67e5\u8be2\u7684\u7ed3\u679c\u96c6\u5c31\u662f\u533a\u95f4\u5411\u91cf\uff0c\u53ef\u4ee5\u901a\u8fc7<code>[]</code>\u6307\u5b9a\u65f6\u95f4\u6765\u505a\u8303\u56f4\u67e5\u8be2\uff0c\u67e5\u8be2 5 \u5206\u949f\u5185\u7684 Gc \u7d2f\u79ef\u6d88\u8017\u65f6\u95f4\uff1a</p> <pre><code>go_gc_duration_seconds_count{}[5m]\n</code></pre> <p>\u6ce8\u610f\uff1a\u8fd9\u91cc\u8303\u56f4\u67e5\u8be2\u7b2c\u4e00\u4e2a\u70b9\u5e76\u4e0d\u4e00\u5b9a\u7cbe\u786e\u5230\u521a\u521a\u597d 5 \u5206\u949f\u524d\u7684\u90a3\u4e2a\u65f6\u5e8f\u6837\u672c\u70b9\uff0c\u4ed6\u662f\u4ee5 5 \u5206\u949f\u4f5c\u4e3a\u4e00\u4e2a\u533a\u95f4\uff0c\u5bfb\u627e\u8fd9\u4e2a\u533a\u95f4\u7684\u7b2c\u4e00\u4e2a\u70b9\u5230\u6700\u540e\u4e00\u4e2a\u6837\u672c\u70b9\u3002</p> <p></p> <p>\u65f6\u95f4\u5355\u4f4d\uff1a</p> <p></p> <p>d\uff1a\u5929\uff0ch\uff1a\u5c0f\u65f6\uff0cm\uff1a\u5206\u949f\uff0cms\uff1a\u6beb\u79d2\uff0cs\uff1a\u79d2\uff0cw\uff1a\u5468\uff0cy\uff1a\u5e74</p> <p>\u540c\u6837\u652f\u6301\u7c7b\u4f3c SQL \u4e2d\u7684 offset \u67e5\u8be2\uff0c\u5982\u4e0b\uff1a\u67e5\u8be2\u4e00\u5929\u524d\u5f53\u524d 5 \u5206\u949f\u524d\u7684\u65f6\u5e8f\u6570\u636e\u96c6\uff1a</p> <pre><code>go_gc_duration_seconds_count{}[5m] offset 1d\n</code></pre>"},{"location":"chap1/1prometheus2022/#5-3","title":"5-3 \u5185\u7f6e\u51fd\u6570","text":"<p>Prometheus \u5185\u7f6e\u4e86\u5f88\u591a\u51fd\u6570\uff0c\u8fd9\u91cc\u4e3b\u8981\u8bb0\u5f55\u4e0b\u5e38\u7528\u7684\u51e0\u4e2a\u51fd\u6570\u7684\u4f7f\u7528\uff1a</p> <p>rate \u548c irate \u51fd\u6570</p> <p>rate \u51fd\u6570\u53ef\u4ee5\u7528\u6765\u6c42\u6307\u6807\u7684\u5e73\u5747\u53d8\u5316\u901f\u7387\uff1a<code>rate\u51fd\u6570=\u65f6\u95f4\u533a\u95f4\u524d\u540e\u4e24\u4e2a\u70b9\u7684\u5dee / \u65f6\u95f4\u8303\u56f4</code>\u3002</p> <p>\u4e00\u822c rate \u51fd\u6570\u53ef\u4ee5\u7528\u6765\u6c42\u67d0\u4e2a\u65f6\u95f4\u533a\u95f4\u5185\u7684\u8bf7\u6c42\u901f\u7387\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684 QPS\uff1a</p> <p></p> <p>\u4f46\u662f rate \u51fd\u6570\u53ea\u662f\u7b97\u51fa\u6765\u4e86\u67d0\u4e2a\u65f6\u95f4\u533a\u95f4\u5185\u7684\u5e73\u5747\u901f\u7387\uff0c\u6ca1\u529e\u6cd5\u53cd\u6620\u7a81\u53d1\u53d8\u5316\uff0c\u5047\u8bbe\u5728\u4e00\u5206\u949f\u7684\u65f6\u95f4\u533a\u95f4\u91cc\uff0c\u524d 50 \u79d2\u7684\u8bf7\u6c42\u91cf\u90fd\u662f 0 \u5230 10 \u5de6\u53f3\uff0c\u4f46\u662f\u6700\u540e 10 \u79d2\u7684\u8bf7\u6c42\u91cf\u66b4\u589e\u5230 100 \u4ee5\u4e0a\uff0c\u8fd9\u65f6\u5019\u7b97\u51fa\u6765\u7684\u503c\u53ef\u80fd\u65e0\u6cd5\u5f88\u597d\u7684\u53cd\u6620\u8fd9\u4e2a\u5cf0\u503c\u53d8\u5316\u3002</p> <p>\u8fd9\u4e2a\u95ee\u9898\u53ef\u4ee5\u901a\u8fc7 irate \u51fd\u6570\u89e3\u51b3\uff0cirate \u51fd\u6570\u6c42\u51fa\u6765\u7684\u5c31\u662f\u77ac\u65f6\u53d8\u5316\u7387\u3002</p> <p>\u65f6\u95f4\u533a\u95f4\u5185\u6700\u540e\u4e24\u4e2a\u6837\u672c\u70b9\u7684\u5dee / \u6700\u540e\u4e24\u4e2a\u6837\u672c\u70b9\u7684\u65f6\u95f4\u5dee\u3002</p> <p></p> <p>\u53ef\u4ee5\u901a\u8fc7\u56fe\u50cf\u770b\u4e0b\u4e24\u8005\u7684\u533a\u522b\uff1airate \u51fd\u6570\u7684\u56fe\u50cf\u5cf0\u503c\u53d8\u5316\u5927\uff0crate \u51fd\u6570\u53d8\u5316\u8f83\u4e3a\u5e73\u7f13\u3002</p> <p>rate \u51fd\u6570\uff1a</p> <p></p> <p>irate \u51fd\u6570\uff1a</p> <p></p> <p>\u805a\u5408\u51fd\u6570\uff1a<code>Sum() by() without()</code></p> <p>\u4e5f\u662f\u4e0a\u8fb9\u7684\u4f8b\u5b50\uff0c\u6211\u4eec\u5728\u6c42\u6307\u5b9a\u63a5\u53e3\u7684 QPS \u7684\u65f6\u5019\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u591a\u4e2a\u5b9e\u4f8b\u7684 QPS \u7684\u8ba1\u7b97\u7ed3\u679c\uff0c\u5982\u4e0b\u662f\u5b58\u5728\u591a\u4e2a\u63a5\u53e3\uff0c\u4e09\u4e2a\u670d\u52a1\u7684 QPS\u3002</p> <pre><code>rate(demo_api_request_duration_seconds_count{job=\"demo\", method=\"GET\", status=\"200\"}[5m])\n</code></pre> <p></p> <p>\u5229\u7528 Sum \u51fd\u6570\u53ef\u4ee5\u5c06\u4e09\u4e2a QPS \u805a\u5408\uff0c\u5373\u53ef\u5f97\u5230\u6574\u4e2a\u670d\u52a1\u8be5\u63a5\u53e3\u7684 QPS\uff1a\u5176\u5b9e Sum \u5c31\u662f\u5c06\u6307\u6807\u503c\u505a\u76f8\u52a0\u3002</p> <p></p> <p>\u4f46\u662f\u8fd9\u6837\u76f4\u63a5\u7684\u76f8\u52a0\u592a\u7b3c\u7edf\u62bd\u8c61\u4e86\uff0c\u53ef\u4ee5\u914d\u5408 by \u548c without \u51fd\u6570\u5728 sum \u7684\u65f6\u5019\uff0c\u57fa\u4e8e\u67d0\u4e9b\u6807\u7b7e\u5206\u7ec4\uff0c\u7c7b\u4f3c SQL \u4e2d\u7684 group by\u3002</p> <p>\u4f8b\u5982\uff0c\u6211\u53ef\u4ee5\u6839\u636e\u8bf7\u6c42\u63a5\u53e3\u6807\u7b7e\u5206\u7ec4\uff1a\u8fd9\u6837\u62ff\u5230\u7684\u5c31\u662f\u5177\u4f53\u63a5\u53e3\u7684 QPS\uff1a</p> <pre><code>sum(rate(demo_api_request_duration_seconds_count{job=\"demo\", method=\"GET\", status=\"200\"}[5m])) by(path)\n</code></pre> <p></p> <p>\u4e5f\u53ef\u4ee5\u4e0d\u6839\u636e\u63a5\u53e3\u8def\u5f84\u5206\u7ec4\uff1a\u901a\u8fc7 without \u6307\u5b9a\uff1a</p> <pre><code>sum(rate(demo_api_request_duration_seconds_count{job=\"demo\", method=\"GET\", status=\"200\"}[5m])) without(path)\n</code></pre> <p></p> <p>\u53ef\u4ee5\u901a\u8fc7 <code>histogram_quantile</code> \u51fd\u6570\u505a\u6570\u636e\u7edf\u8ba1\uff1a\u53ef\u4ee5\u7528\u6765\u7edf\u8ba1\u767e\u5206\u4f4d\u6570\uff1a\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u767e\u5206\u4f4d\uff0c\u7b2c\u4e8c\u4e2a histogram \u6307\u6807\uff0c\u8fd9\u6837\u8ba1\u7b97\u51fa\u6765\u7684\u5c31\u662f\u4e2d\u4f4d\u6570\uff0c\u5373 P50\u3002</p> <p></p> <p>\u5728\u521a\u521a\u5199\u7684\u81ea\u5b9a\u4e49 exporter \u4e0a\u65b0\u589e\u51e0\u4e2a histogram \u7684\u6837\u672c\u70b9\uff1a</p> <pre><code>MyHistogram.Observe(0.3)\nMyHistogram.Observe(0.4)\nMyHistogram.Observe(0.5)\n</code></pre> <p>\u81ea\u5b9a\u4e49\u6876\uff1a</p> <pre><code>// \u5b9a\u4e49histogram\nMyHistogram = prometheus.NewHistogram(prometheus.HistogramOpts{\n  Name: \"my_histogram_bucket\",\n  Help: \"\u81ea\u5b9a\u4e49histogram\",\n  Buckets: []float64{0.1,0.2,0.3,0.4,0.5},  // \u9700\u8981\u6307\u5b9a\u6876\n})\n</code></pre> <p>\u4e0a\u62a5\u6570\u636e\uff1a</p> <pre><code>MyHistogram.Observe(0.1)\nMyHistogram.Observe(0.3)\nMyHistogram.Observe(0.4)\n</code></pre> <p></p> <p>\u91cd\u65b0\u8ba1\u7b97 P50\uff0cP99\uff1a</p> <pre><code>histogram_quantile(0.5,my_histogram_bucket_bucket)\n</code></pre> <pre><code>histogram_quantile(0.99,my_histogram_bucket_bucket)\n</code></pre> <p>\u6876\u8bbe\u7f6e\u7684\u8d8a\u5408\u7406\uff0c\u8ba1\u7b97\u7684\u8bef\u5dee\u8d8a\u5c0f\u3002</p>"},{"location":"chap1/1prometheus2022/#6-grafana","title":"6 Grafana \u53ef\u89c6\u5316","text":"<p>\u9664\u4e86\u53ef\u4ee5\u5229\u7528 Prometheus \u63d0\u4f9b\u7684 webUI \u53ef\u89c6\u5316\u6211\u4eec\u7684\u6307\u6807\u5916\uff0c\u8fd8\u53ef\u4ee5\u63a5\u5165 Grafana \u6765\u505a\u6307\u6807\u7684\u53ef\u89c6\u5316\u3002</p> <ul> <li>\u7b2c\u4e00\u6b65\uff0c\u5bf9\u63a5\u6570\u636e\u6e90\uff1a \u914d\u7f6e\u597d prometheus \u7684\u5730\u5740</li> <li>\u7b2c\u4e8c\u6b65\uff0c\u521b\u5efa\u4eea\u8868\u76d8\uff1a<ul> <li>\u7f16\u8f91\u4eea\u8868\u76d8</li> <li>\u5728 Metrics \u5904\u7f16\u5199 PromQL \u5373\u53ef\u5b8c\u6210\u67e5\u8be2\u548c\u53ef\u89c6\u5316</li> <li>\u4eea\u8868\u76d8\u7f16\u8f91\u5b8c\u540e\uff0c\u53ef\u4ee5\u5bfc\u51fa\u5bf9\u5e94\u7684 json \u6587\u4ef6\uff0c\u65b9\u4fbf\u4e0b\u6b21\u5bfc\u5165\u540c\u6837\u7684\u4eea\u8868\u76d8\uff1a</li> </ul> </li> </ul> <p></p>"},{"location":"chap1/1prometheus2022/#7","title":"7 \u76d1\u63a7\u544a\u8b66","text":"<p>AlertManager \u662f Prometheus \u63d0\u4f9b\u7684\u544a\u8b66\u4fe1\u606f\u4e0b\u53d1\u7ec4\u4ef6\uff0c\u5305\u542b\u4e86\u5bf9\u544a\u8b66\u4fe1\u606f\u7684\u5206\u7ec4\uff0c\u4e0b\u53d1\uff0c\u9759\u9ed8\u7b49\u7b56\u7565\u3002\u914d\u7f6e\u5b8c\u6210\u540e\u53ef\u4ee5\u5728 WebUI \u4e0a\u770b\u5230\u5bf9\u5e94\u7684\u544a\u8b66\u7b56\u7565\u4fe1\u606f\u3002\u544a\u8b66\u89c4\u5219\u4e5f\u662f\u57fa\u4e8e PromQL \u8fdb\u884c\u5b9a\u5236\u7684\u3002</p> <p>\u7f16\u5199\u544a\u8b66\u914d\u7f6e\uff1a\u5f53 <code>Http_srv</code> \u8fd9\u4e2a\u670d\u52a1\u6302\u4e86\uff0cPrometheus \u91c7\u96c6\u4e0d\u5230\u6307\u6807\uff0c\u5e76\u4e14\u6301\u7eed\u65f6\u95f4 1 \u5206\u949f\uff0c\u5c31\u4f1a\u89e6\u53d1\u544a\u8b66\u3002</p> <pre><code>groups:\n\\- name: simulator-alert-rule\n rules:\n \\- alert: HttpSimulatorDown\n  expr: sum(up{job=\"http_srv\"}) == 0\n  for: 1m\n  labels:\n   severity: critical\n</code></pre> <p>\u5728 <code>prometheus.yml</code> \u4e2d\u914d\u7f6e\u544a\u8b66\u914d\u7f6e\u6587\u4ef6\uff0c\u9700\u8981\u914d\u7f6e\u4e0a Alertmanager \u7684\u5730\u5740\u548c\u544a\u8b66\u6587\u4ef6\u7684\u5730\u5740\u3002</p> <pre><code>\\# Alertmanager configuration\nalerting:\n alertmanagers:\n \\- static_configs:\n  \\- targets: ['localhost:9093']\n\\# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  \\- \"alert_rules.yml\"\n  \\#- \"first_rules.yml\"\n</code></pre> <p>\u914d\u7f6e\u544a\u8b66\u4fe1\u606f\uff0c\u4f8b\u5982\u544a\u8b66\u53d1\u9001\u5730\u5740\uff0c\u544a\u8b66\u5185\u5bb9\u6a21\u7248\uff0c\u5206\u7ec4\u7b56\u7565\u7b49\u90fd\u5728 Alertmanager \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u914d\u7f6e\uff1a</p> <pre><code>global:\n smtp_smarthost: 'smtp.qq.com:465'\n smtp_from: 'xxxx@qq.com'\n smtp_auth_username: 'xxxx@qq.com'\n smtp_auth_password: 'xxxx'\n smtp_require_tls: false\n\nroute:\n group_interval: 1m\n repeat_interval: 1m\n receiver: 'mail-receiver'\n\n\n# group_by       //\u91c7\u7528\u54ea\u4e2a\u6807\u7b7e\u4f5c\u4e3a\u5206\u7ec4\n# group_wait      //\u5206\u7ec4\u7b49\u5f85\u7684\u65f6\u95f4\uff0c\u6536\u5230\u62a5\u8b66\u4e0d\u662f\u7acb\u9a6c\u53d1\u9001\u51fa\u53bb\uff0c\u800c\u662f\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4\uff0c\u770b\u770b\u540c\u4e00\u7ec4\u4e2d\u662f\u5426\u6709\u5176\u4ed6\u62a5\u8b66\uff0c\u5982\u679c\u6709\u4e00\u5e76\u53d1\u9001\n# group_interval    //\u544a\u8b66\u65f6\u95f4\u95f4\u9694\n# repeat_interval   //\u91cd\u590d\u544a\u8b66\u65f6\u95f4\u95f4\u9694\uff0c\u53ef\u4ee5\u51cf\u5c11\u53d1\u9001\u544a\u8b66\u7684\u9891\u7387\n# receiver       //\u63a5\u6536\u8005\u662f\u8c01\n# routes        //\u5b50\u8def\u7531\u914d\u7f6e\n\nreceivers:\n\\- name: 'mail-receiver'\n email_configs:\n  \\- to: 'xxxx@qq.com'\n</code></pre> <p>\u5f53\u6211 kill \u8fdb\u7a0b\uff1a</p> <p></p> <p>Prometheus \u5df2\u7ecf\u89e6\u53d1\u544a\u8b66\uff1a</p> <p></p> <p>\u5728\u7b49\u5f85 1 \u5206\u949f\uff0c\u5982\u679c\u6301\u7eed\u8fd8\u662f\u7b26\u5408\u544a\u8b66\u7b56\u7565\uff0c\u5219\u72b6\u6001\u4e3a\u4ece pending \u53d8\u4e3a FIRING \u4f1a\u53d1\u9001\u90ae\u4ef6\u5230\u6211\u7684\u90ae\u7bb1\u3002</p> <p></p> <p>\u6b64\u65f6\u6211\u7684\u90ae\u7bb1\u6536\u5230\u4e86\u4e00\u6761\u544a\u8b66\u6d88\u606f\uff1a</p> <p></p> <p>Alertmanager \u4e5f\u652f\u6301\u5bf9\u544a\u8b66\u8fdb\u884c\u9759\u9ed8\uff0c\u5728 Alertmanager \u7684 WebUI \u4e2d\u914d\u7f6e\u5373\u53ef\uff1a</p> <p></p> <p>\u95f4\u9694\u4e86 4 \u5206\u949f\uff0c\u6ca1\u6709\u6536\u5230\u544a\u8b66\uff0c\u9759\u9ed8\u751f\u6548\uff1a</p> <p></p> <p>\u4e00\u4e2a\u5c0f\u65f6\u6ca1\u6709\u6536\u5230\u544a\u8b66\u4fe1\u606f\uff1a</p> <p></p>"},{"location":"chap1/20Install_metrics_server_SAP_CC/","title":"\u7b2c\u4e94\u8282 Install Kubernetes Metrics Server on SAP Converged Cloud","text":""},{"location":"chap1/20Install_metrics_server_SAP_CC/#1-project-introduction","title":"1 Project Introduction","text":""},{"location":"chap1/20Install_metrics_server_SAP_CC/#1-bcakground-1-sap-converged-cloud","title":"1 Bcakground 1: Sap Converged Cloud","text":"<p>SAP Converged Cloud: From Playground to Production on one Infrastructure-as-a-Service (IaaS), powered by Kubernetes, OpenStack, SAP HANA and Monsoon Automation</p>"},{"location":"chap1/20Install_metrics_server_SAP_CC/#2-bcakground-2-why-metrics-servers-not-heaspter","title":"2 Bcakground 2: Why Metrics servers not heaspter","text":"<p>RETIRED: Heapster is now retired. . We will not be making changes to Heapster.</p> <p>The following are potential migration paths for Heapster functionality:</p> <ul> <li>For basic CPU/memory HPA metrics: Use metrics-server.</li> <li>For general monitoring: Consider a third-party monitoring pipeline that can gather Prometheus-formatted metrics. The kubelet exposes all the metrics exported by Heapster in Prometheus format.</li> </ul>"},{"location":"chap1/20Install_metrics_server_SAP_CC/#3-prvious-install-tiller-server-for-the-cluster","title":"3 Prvious: Install Tiller Server for the cluster","text":"<p>Check which cluster to install tiller server</p> <pre><code>$ kubectl config current-context\njam  \n</code></pre>"},{"location":"chap1/20Install_metrics_server_SAP_CC/#initialize-helm-on-both-client-and-server","title":"initialize Helm on both client and server","text":"<p>Helm 2</p> <pre><code>$ helm init\n$HELM_HOME has been configured at /Users/.../.helm.\n\nTiller (the Helm server-side component) has been installed into your Kubernetes Cluster.\n\nPlease note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy.\nTo prevent this, run `helm init` with the --tiller-tls-verify flag.\n</code></pre> <pre><code>$ kubectl get pods --all-namespaces\nNAMESPACE     NAME                             READY   STATUS             RESTARTS   AGE\nkube-system   tiller-deploy-595f59d579-nszzh   1/1     Running            0          35s\n</code></pre>"},{"location":"chap1/20Install_metrics_server_SAP_CC/#2-install-metrics-server-by-helm","title":"2 Install Metrics Server by <code>helm</code>","text":""},{"location":"chap1/20Install_metrics_server_SAP_CC/#2-1-fetchmetrics-server-package","title":"2-1\" fetch\"metrics server package","text":"<pre><code>helm fetch:     download a chart to your local directory to view\n</code></pre> <pre><code>$ helm fetch stable/metrics-server\n$ tar -xvf metrics-server-2.8.2.tgz\nx metrics-server/Chart.yaml\nx metrics-server/values.yaml\nx metrics-server/templates/NOTES.txt\nx metrics-server/templates/_helpers.tpl\nx metrics-server/templates/aggregated-metrics-reader-cluster-role.yaml\nx metrics-server/templates/auth-delegator-crb.yaml\nx metrics-server/templates/cluster-role.yaml\nx metrics-server/templates/metric-server-service.yaml\nx metrics-server/templates/metrics-api-service.yaml\nx metrics-server/templates/metrics-server-crb.yaml\nx metrics-server/templates/metrics-server-deployment.yaml\nx metrics-server/templates/metrics-server-serviceaccount.yaml\nx metrics-server/templates/pdb.yaml\nx metrics-server/templates/psp.yaml\nx metrics-server/templates/role-binding.yaml\nx metrics-server/templates/tests/test-version.yaml\nx metrics-server/.helmignore\nx metrics-server/README.md\nx metrics-server/ci/ci-values.yaml\n\n$ helm install ./metrics-server --namespace kube-system --name metric\n</code></pre> <ul> <li><code>--namespace</code>: <code>special namespaces</code></li> <li><code>--name</code>: <code>special release name</code></li> </ul> <pre><code>$ helm install ./metrics-server --namespace kube-system\n\nError: no available release name found\n</code></pre> <pre><code>$ helm install ./metrics-server --namespace kube-system --name metric\n\nError: release metric failed: namespaces \"kube-system\" is forbidden: User \"system:serviceaccount:kube-system:default\" cannot get namespaces in the namespace \"kube-system\"\n</code></pre>"},{"location":"chap1/20Install_metrics_server_SAP_CC/#2-2-looks-like-we-have-service-account-forbidden-problem","title":"2-2 Looks like we have <code>Service-account</code> forbidden Problem","text":""},{"location":"chap1/20Install_metrics_server_SAP_CC/#so-create-tiller-sa-accound-and-role","title":"So create <code>tiller</code> SA accound and role","text":"<pre><code>$ kubectl create serviceaccount --namespace kube-system tiller\nserviceaccount/tiller created\n\n$ kubectl get sa --all-namespaces\nNAMESPACE     NAME                                 SECRETS   AGE\nkube-system   tiller                               1         28s\n\n$ kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller\n\nclusterrolebinding.rbac.authorization.k8s.io/tiller-cluster-rule created\n\n$ kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller\n\nclusterrolebinding.rbac.authorization.k8s.io/tiller-cluster-rule created\n\n$ kubectl patch deploy --namespace kube-system tiller-deploy -p '{\"spec\":{\"template\":{\"spec\":{\"serviceAccount\":\"tiller\"}}}}'\ndeployment.extensions/tiller-deploy patched\n</code></pre>"},{"location":"chap1/20Install_metrics_server_SAP_CC/#2-3-install-the-metrics-server","title":"2-3 Install The metrics server","text":"<pre><code>$ helm install ./metrics-server --namespace kube-system --name metric\nNAME:   metric\nLAST DEPLOYED: Fri Jul 19 17:25:29 2019\nNAMESPACE: kube-system\nSTATUS: DEPLOYED\n\nRESOURCES:\n==&gt; v1/ClusterRole\nNAME                                     AGE\nsystem:metric-metrics-server             2s\nsystem:metrics-server-aggregated-reader  2s\n\n==&gt; v1/ClusterRoleBinding\nNAME                                         AGE\nmetric-metrics-server:system:auth-delegator  2s\nsystem:metric-metrics-server                 2s\n\n==&gt; v1/Deployment\nNAME                   READY  UP-TO-DATE  AVAILABLE  AGE\nmetric-metrics-server  0/1    1           0          2s\n\n==&gt; v1/Pod(related)\nNAME                                    READY  STATUS             RESTARTS  AGE\nmetric-metrics-server-77df84fbdd-5bb9c  0/1    ContainerCreating  0         2s\n\n==&gt; v1/Service\nNAME                   TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)  AGE\nmetric-metrics-server  ClusterIP  198.18.216.71  &lt;none&gt;       443/TCP  2s\n\n==&gt; v1/ServiceAccount\nNAME                   SECRETS  AGE\nmetric-metrics-server  1        2s\n\n==&gt; v1beta1/APIService\nNAME                    AGE\nv1beta1.metrics.k8s.io  2s\n\n==&gt; v1beta1/RoleBinding\nNAME                               AGE\nmetric-metrics-server-auth-reader  2s\n\n\nNOTES:\nThe metric server has been deployed.\n\nIn a few minutes you should be able to list metrics using the following\ncommand:\n\n  kubectl get --raw \"/apis/metrics.k8s.io/v1beta1/nodes\"\n</code></pre> <pre><code>$ kubectl get pods -n kube-system`\nNAME                                     READY   STATUS    RESTARTS   AGE\ntiller-deploy-c5c655fc5-zldr4            1/1     Running   0          1m\nmetric-metrics-server-77df84fbdd-5bb9c   0/1     Running   0          30s\n</code></pre>"},{"location":"chap1/20Install_metrics_server_SAP_CC/#3-fix-problem","title":"3 Fix problem","text":"<p>Looks we have <code>unable to fetch metrics from Kubelet</code> problem here</p> <pre><code>$ kubectl logs -f metric-metrics-server-77df84fbdd-5bb9c -n kube-system\nI0719 09:25:33.716791       1 serving.go:273] Generated self-signed cert (/tmp/apiserver.crt, /tmp/apiserver.key)\n[restful] 2019/07/19 09:25:34 log.go:33: [restful/swagger] listing is available at https://:8443/swaggerapi\n[restful] 2019/07/19 09:25:34 log.go:33: [restful/swagger] https://:8443/swaggerui/ is mapped to folder /swagger-ui/\nI0719 09:25:34.884929       1 serve.go:96] Serving securely on [::]:8443\nE0719 09:26:34.898366       1 manager.go:111] unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:jam-m2xlarge-fphgs: unable to fetch metrics from Kubelet jam-m2xlarge-fphgs (jam-m2xlarge-fphgs.novalocal): Get https://jam-m2xlarge-fphgs.novalocal:10250/stats/summary/: dial tcp: lookup jam-m2xlarge-fphgs.novalocal on 198.18.128.2:53: no such host, unable to fully scrape metrics from source kubelet_summary:jam-m2xlarge-6zqkq: unable to fetch metrics from Kubelet jam-m2xlarge-6zqkq (jam-m2xlarge-6zqkq.novalocal): Get https://jam-m2xlarge-6zqkq.novalocal:10250/stats/summary/: dial tcp: lookup jam-m2xlarge-6zqkq.novalocal on 198.18.128.2:53: no such host, unable to fully scrape metrics from source kubelet_summary:jam-m2xlarge-sxrj8: unable to fetch metrics from Kubelet jam-m2xlarge-sxrj8 (jam-m2xlarge-sxrj8.novalocal): Get https://jam-m2xlarge-sxrj8.novalocal:10250/stats/summary/: dial tcp: lookup jam-m2xlarge-sxrj8.novalocal on 198.18.128.2:53: no such host]\n\n\n[restful] 2019/07/19 09:28:30 log.go:33: [restful/swagger] listing is available at https://:8443/swaggerapi\n[restful] 2019/07/19 09:28:30 log.go:33: [restful/swagger] https://:8443/swaggerui/ is mapped to folder /swagger-ui/\nI0719 09:28:30.854420       1 serve.go:96] Serving securely on [::]:8443\nE0719 09:28:56.628369       1 reststorage.go:129] unable to fetch node metrics for node \"jam-m2xlarge-6zqkq\": no metrics known for node\nE0719 09:28:56.628399       1 reststorage.go:129] unable to fetch node metrics for node \"jam-m2xlarge-fphgs\": no metrics known for node\nE0719 09:28:56.628404       1 reststorage.go:129] unable to fetch node metrics for node \"jam-m2xlarge-sxrj8\": no metrics known for node\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 <code>Pod</code> \u4e2d\u51fa\u73b0\u4e86\u4e00\u4e9b\u9519\u8bef\u4fe1\u606f\uff1a<code>xxx: no such host</code>\uff0c\u6211\u4eec\u770b\u5230\u8fd9\u4e2a\u9519\u8bef\u4fe1\u606f\u4e00\u822c\u5c31\u53ef\u4ee5\u786e\u5b9a\u662f <code>DNS</code> \u89e3\u6790\u4e0d\u4e86\u9020\u6210\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>metrics-server</code> \u4f1a\u901a\u8fc7 <code>kubelet</code> \u7684 <code>10250</code> \u7aef\u53e3\u83b7\u53d6\u4fe1\u606f\uff0c\u4f7f\u7528\u7684\u662f <code>hostname</code>\uff0c</p> <p>\u6211\u4eec\u90e8\u7f72\u96c6\u7fa4\u7684\u65f6\u5019\u5728\u8282\u70b9\u7684 <code>/etc/hosts</code>\u91cc\u9762\u6dfb\u52a0\u4e86\u8282\u70b9\u7684 <code>hostname</code> \u548c <code>ip</code> \u7684\u6620\u5c04\uff0c\u4f46\u662f\u662f\u6211\u4eec\u7684 <code>metrics-server</code> \u7684 <code>Pod</code> \u5185\u90e8\u5e76\u6ca1\u6709\u8fd9\u4e2a <code>hosts</code> \u4fe1\u606f\uff0c\u5f53\u7136\u4e5f\u5c31\u4e0d\u8bc6\u522b <code>hostname</code></p> <p>\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <ul> <li>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728\u96c6\u7fa4\u5185\u90e8\u7684 DNS \u670d\u52a1\u91cc\u9762\u6dfb\u52a0\u4e0a <code>hostname</code> \u7684\u89e3\u6790</li> <li>\u53e6\u5916\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728 <code>metrics-server</code> \u7684\u542f\u52a8\u53c2\u6570\u4e2d\u4fee\u6539<code>kubelet-preferred-address-types</code>\u53c2\u6570</li> <li>\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a<code>--kubelet-insecure-tls</code>\u53c2\u6570\u8df3\u8fc7\u8bc1\u4e66\u6821\u9a8c </li> </ul>"},{"location":"chap1/20Install_metrics_server_SAP_CC/#3-1-edit-metric-server-deployment-to-add-the-flags","title":"3-1 Edit metric-server deployment to add the flags","text":"<pre><code>$ kubectl edit deployment metric-metrics-server -n kube-system\ndeployment.extensions/metric-metrics-server edited\n</code></pre> <p>8 spaces</p> <pre><code>args:\n- --kubelet-insecure-tls\n- --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname\n</code></pre> <p></p> <p>Please use 4 spaces to replace one tap, otherwise you may encounter unident problem</p> <pre><code>$ kubectl get pods --all-namespaces\nNAMESPACE     NAME                                     READY   STATUS             RESTARTS   AGE\nkube-system   metric-metrics-server-77df84fbdd-5bb9c   0/1     Terminating        9          26m\nkube-system   metric-metrics-server-78996fbfbf-plcww   1/1     Running            0          1m\n</code></pre> <pre><code>$ kubectl top nodes\nNAME                 CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%\njam-m2xlarge-6zqkq   39m          0%     948Mi           5%\njam-m2xlarge-fphgs   62m          0%     825Mi           5%\njam-m2xlarge-sxrj8   47m          0%     613Mi           3%\n</code></pre> <p>Now it works fine</p>"},{"location":"chap1/37kubectl_top/","title":"\u4ecekubectl top\u770bK8S\u76d1\u63a7\u539f\u7406","text":""},{"location":"chap1/37kubectl_top/#1","title":"1 \u524d\u8a00","text":"<p>kubectl top \u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u67e5\u770bnode\u3001pod\u7684\u5b9e\u65f6\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff1a\u5982CPU\u3001\u5185\u5b58\u3002\u8fd9\u7bc7\u6587\u7ae0\u4f1a\u4ecb\u7ecd\u5176\u6570\u636e\u94fe\u8def\u548c\u5b9e\u73b0\u539f\u7406\uff0c\u540c\u65f6\u501f<code>kubectl top</code> \u9610\u8ff0 k8s \u4e2d\u7684\u76d1\u63a7\u4f53\u7cfb\uff0c\u7aa5\u4e00\u6591\u800c\u77e5\u5168\u8c79\u3002\u6700\u540e\u4f1a\u89e3\u91ca\u5e38\u89c1\u7684\u4e00\u4e9b\u95ee\u9898\uff1a</p> <ul> <li>kubectl top \u4e3a\u4ec0\u4e48\u4f1a\u62a5\u9519\uff1f</li> <li>kubectl top node \u600e\u4e48\u8ba1\u7b97\uff0c\u548c\u8282\u70b9\u4e0a\u76f4\u63a5 top \u6709\u4ec0\u4e48\u533a\u522b\uff1f</li> <li>kubectl top pod \u600e\u4e48\u8ba1\u7b97\uff0c\u5305\u542b pause \u5417\uff1f</li> <li>kubectl top pod \u548cexec \u8fdb\u5165 pod \u540e\u770b\u5230\u7684 top \u4e0d\u4e00\u6837\uff1f</li> <li>kubectl top pod \u548c docker stats\u5f97\u5230\u7684\u503c\u4e3a\u4ec0\u4e48\u4e0d\u540c\uff1f</li> </ul>"},{"location":"chap1/37kubectl_top/#2","title":"2 \u4f7f\u7528","text":"<p>kubectl top \u662f\u57fa\u7840\u547d\u4ee4\uff0c\u4f46\u662f\u9700\u8981\u90e8\u7f72\u914d\u5957\u7684\u7ec4\u4ef6\u624d\u80fd\u83b7\u53d6\u5230\u76d1\u63a7\u503c</p> <ul> <li>1.8\u4ee5\u4e0b\uff1a\u90e8\u7f72 <code>heapter</code></li> <li>1.8\u4ee5\u4e0a\uff1a\u90e8\u7f72 <code>metric-server</code></li> </ul>"},{"location":"chap1/37kubectl_top/#2-1","title":"2-1 \u5b89\u88c5","text":"<pre><code>helm install metric ./metrics-server --namespace kube-system\n\nkubectl edit deployment metric-metrics-server -n kube-system\n...\nargs:\n- --kubelet-insecure-tls\n- --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname\n...\n</code></pre> <pre><code>$ kubectl top nodes\nNAME             CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   \ndocker-desktop   499m         12%    2198Mi          27% \n</code></pre> <p>kubectl top pod: \u67e5\u770b pod \u7684\u4f7f\u7528\u60c5\u51b5</p> <pre><code>$ kubectl top pods\nNAME                    CPU(cores)   MEMORY(bytes)   \ndark-57c5c58bf8-llxqj   1m           4Mi\n</code></pre> <pre><code>$ kubectl top pod kfk-zookeeper-0 -n kafka \nNAME              CPU(cores)   MEMORY(bytes)   \nkfk-zookeeper-0   3m           187Mi\n\n$ kubectl top pod kfk-zookeeper-0 -n kafka --containers\nPOD               NAME        CPU(cores)   MEMORY(bytes)   \nkfk-zookeeper-0   zookeeper   3m           187Mi \n</code></pre> <p>\u6307\u6807\u542b\u4e49\uff1a</p> <ul> <li>\u548c<code>k8s</code>\u4e2d\u7684<code>request\u3001limit</code>\u4e00\u81f4\uff0c<code>CPU</code>\u5355\u4f4d<code>100m=0.1</code>\u5185\u5b58\u5355\u4f4d<code>1Mi=1024Ki</code></li> <li><code>pod</code>\u7684\u5185\u5b58\u503c\u662f\u5176\u5b9e\u9645\u4f7f\u7528\u91cf\uff0c\u4e5f\u662f\u505a<code>limit</code>\u9650\u5236\u65f6\u5224\u65ad<code>oom</code>\u7684\u4f9d\u636e\u3002<code>pod</code>\u7684\u4f7f\u7528\u91cf\u7b49\u4e8e\u5176\u6240\u6709\u4e1a\u52a1\u5bb9\u5668\u7684\u603b\u548c\uff0c\u4e0d\u5305\u62ec <code>pause</code> \u5bb9\u5668\uff0c\u503c\u7b49\u4e8e<code>cadvisr</code>\u4e2d\u7684<code>container_memory_working_set_bytes</code>\u6307\u6807</li> <li><code>node</code>\u7684\u503c\u5e76\u4e0d\u7b49\u4e8e\u8be5<code>node</code> \u4e0a\u6240\u6709<code>pod</code> \u503c\u7684\u603b\u548c\uff0c\u4e5f\u4e0d\u7b49\u4e8e\u76f4\u63a5\u5728\u673a\u5668\u4e0a\u8fd0\u884c<code>top</code> \u6216 <code>free</code> \u770b\u5230\u7684\u503c</li> </ul>"},{"location":"chap1/37kubectl_top/#3","title":"3 \u5b9e\u73b0\u539f\u7406","text":""},{"location":"chap1/37kubectl_top/#31","title":"3.1 \u6570\u636e\u94fe\u8def","text":"<p><code>kubectl top</code> \u3001 <code>k8s dashboard</code> \u4ee5\u53ca <code>HPA</code>\u7b49\u8c03\u5ea6\u7ec4\u4ef6\u4f7f\u7528\u7684\u6570\u636e\u662f\u4e00\u6837\uff0c\u6570\u636e\u94fe\u8def\u5982\u4e0b\uff1a</p> <p></p> <p>\u4f7f\u7528 <code>heapster</code> \u65f6\uff1a<code>apiserver</code> \u4f1a\u76f4\u63a5\u5c06<code>metric</code>\u8bf7\u6c42\u901a\u8fc7<code>proxy</code>\u7684\u65b9\u5f0f\u8f6c\u53d1\u7ed9\u96c6\u7fa4\u5185\u7684 <code>hepaster</code> \u670d\u52a1\u3002</p> <p></p> <p>\u800c\u4f7f\u7528 <code>metrics-server</code> \u65f6\uff1a<code>apiserver</code>\u662f\u901a\u8fc7<code>/apis/metrics.k8s.io/</code>\u7684\u5730\u5740\u8bbf\u95ee<code>metric</code></p> <p></p> <p>\u8fd9\u91cc\u53ef\u4ee5\u5bf9\u6bd4\u4e0b<code>kubect get pod</code>\u65f6\u7684\u65e5\u5fd7\uff1a</p> <p></p>"},{"location":"chap1/37kubectl_top/#32-metric-api","title":"3.2 metric api","text":"<p>\u53ef\u4ee5\u53d1\u73b0\uff0c<code>heapster</code>\u4f7f\u7528\u7684\u662f <code>proxy</code>\u8f6c\u53d1\uff0c\u800c <code>metric-server</code>\u548c\u666e\u901a <code>pod</code>\u90fd\u662f\u4f7f\u7528 <code>api/xx</code> \u7684\u8d44\u6e90\u63a5\u53e3\uff0c<code>heapster</code>\u91c7\u7528\u7684\u8fd9\u79cd <code>proxy</code>\u65b9\u5f0f\u662f\u6709\u95ee\u9898\u7684\uff1a</p> <ul> <li><code>proxy</code>\u53ea\u662f\u4ee3\u7406\u8bf7\u6c42\uff0c\u4e00\u822c\u7528\u4e8e\u95ee\u9898\u6392\u67e5\uff0c\u4e0d\u591f\u7a33\u5b9a\uff0c\u4e14\u7248\u672c\u4e0d\u53ef\u63a7</li> <li><code>heapster</code>\u7684\u63a5\u53e3\u4e0d\u80fd\u50cf<code>apiserver</code>\u4e00\u6837\u6709\u5b8c\u6574\u7684\u9274\u6743\u4ee5\u53ca<code>client</code>\u96c6\u6210\uff0c\u4e24\u8fb9\u90fd\u7ef4\u62a4\u7684\u8bdd\u4ee3\u4ef7\u9ad8\uff0c\u5982<code>generic apiserver</code>\uff09</li> <li><code>pod</code> \u7684\u76d1\u63a7\u6570\u636e\u662f\u6838\u5fc3\u6307\u6807\uff08HPA\u8c03\u5ea6\uff09\uff0c\u5e94\u8be5\u548c <code>pod</code> \u672c\u8eab\u62e5\u6709\u540c\u7b49\u5730\u4f4d\uff0c\u5373 <code>metric</code>\u5e94\u8be5\u4f5c\u4e3a\u4e00\u79cd\u8d44\u6e90\u5b58\u5728\uff0c\u5982<code>metrics.k8s.io</code> \u7684\u5f62\u5f0f\uff0c\u79f0\u4e4b\u4e3a <code>Metric Api</code></li> </ul> <p>\u4e8e\u662f\u5b98\u65b9\u4ece 1.8 \u7248\u672c\u5f00\u59cb\u9010\u6b65\u5e9f\u5f03 <code>heapster</code>\uff0c\u5e76\u63d0\u51fa\u4e86\u4e0a\u8fb9<code>Metric api</code>\u7684\u6982\u5ff5\uff0c\u800c<code>metrics-server</code> \u5c31\u662f\u8fd9\u79cd\u6982\u5ff5\u4e0b\u5b98\u65b9\u7684\u4e00\u79cd\u5b9e\u73b0\uff0c\u7528\u4e8e\u4ece <code>kubelet</code>\u83b7\u53d6\u6307\u6807\uff0c\u66ff\u6362\u6389\u4e4b\u524d\u7684<code>heapster</code></p>"},{"location":"chap1/37kubectl_top/#33-kube-aggregator","title":"3.3 kube-aggregator","text":"<p>\u6709\u4e86metrics-server\u7ec4\u4ef6\uff0c\u91c7\u96c6\u5230\u4e86\u9700\u8981\u7684\u6570\u636e\uff0c\u4e5f\u66b4\u9732\u4e86\u63a5\u53e3\uff0c\u4f46\u8d70\u5230\u8fd9\u4e00\u6b65\u548c heapster \u5176\u5b9e\u6ca1\u6709\u533a\u522b\uff0c\u6700\u5173\u952e\u7684\u4e00\u6b65\u5c31\u662f\u5982\u4f55\u5c06\u6253\u5230<code>apiserver\u7684/apis/metrics.k8s.io</code>\u8bf7\u6c42\u8f6c\u53d1\u7ed9<code>metrics-server</code>\u7ec4\u4ef6\uff1f</p> <p>\u89e3\u51b3\u65b9\u6848\u5c31\u662f\uff1akube-aggregator\u3002</p> <p><code>kube-aggregator</code>\u662f\u5bf9 <code>apiserver</code>\u7684\u6709\u529b\u6269\u5c55\uff0c\u5b83\u5141\u8bb8k8s\u7684\u5f00\u53d1\u4eba\u5458\u7f16\u5199\u4e00\u4e2a\u81ea\u5df1\u7684\u670d\u52a1\uff0c\u5e76\u628a\u8fd9\u4e2a\u670d\u52a1\u6ce8\u518c\u5230k8s\u7684<code>ap</code>i\u91cc\u9762\uff0c\u5373\u6269\u5c55 <code>API</code>\uff0c<code>metric-server</code>\u5176\u5b9e\u5728<code>1.7</code>\u7248\u672c\u5c31\u5df2\u7ecf\u5b8c\u6210\u4e86\uff0c\u53ea\u662f\u5728\u7b49<code>kube-aggregator</code>\u7684\u51fa\u73b0\u3002</p> <p>kube-aggregator\u662f apiserver \u4e2d\u7684\u5b9e\u73b0\uff0c\u6709\u4e9b k8s \u7248\u672c\u9ed8\u8ba4\u6ca1\u5f00\u542f\uff0c\u4f60\u53ef\u4ee5\u52a0\u4e0a\u8fd9\u4e9b\u914d\u7f6e \u6765\u5f00\u542f\u3002\u4ed6\u7684\u6838\u5fc3\u529f\u80fd\u662f\u52a8\u6001\u6ce8\u518c\u3001\u53d1\u73b0\u6c47\u603b\u3001\u5b89\u5168\u4ee3\u7406\u3002</p> <p></p> <p>\u5982 <code>metric-server</code> \u6ce8\u518c <code>pod</code> \u548c <code>node</code> \u65f6:</p> <p></p>"},{"location":"chap1/37kubectl_top/#34","title":"3.4 \u76d1\u63a7\u4f53\u7cfb","text":"<p>\u5728\u63d0\u51fa metric api \u7684\u6982\u5ff5\u65f6\uff0c\u5b98\u65b9\u4e5f\u63d0\u51fa\u4e86\u65b0\u7684\u76d1\u63a7\u4f53\u7cfb\uff0c\u76d1\u63a7\u8d44\u6e90\u88ab\u5206\u4e3a\u4e862\u79cd\uff1a</p> <ul> <li><code>Core metrics</code>(\u6838\u5fc3\u6307\u6807)\uff1a\u4ece <code>Kubelet</code>\u3001<code>cAdvisor</code> \u7b49\u83b7\u53d6\u5ea6\u91cf\u6570\u636e\uff0c\u518d\u7531<code>metrics-server</code> \u63d0\u4f9b\u7ed9<code>Dashboard</code>\u3001<code>HPA</code>\u63a7\u5236\u5668\u7b49\u4f7f\u7528\u3002</li> <li><code>Custom Metrics</code>(\u81ea\u5b9a\u4e49\u6307\u6807)\uff1a\u7531 <code>Prometheus Adapter</code> \u63d0\u4f9b<code>API custom.metrics.k8s.io</code>\uff0c\u7531\u6b64\u53ef\u652f\u6301\u4efb\u610f<code>Prometheus</code>\u91c7\u96c6\u5230\u7684\u6307\u6807\u3002</li> </ul> <p></p> <p>\u6838\u5fc3\u6307\u6807\u53ea\u5305\u542b<code>node</code>\u548c<code>pod</code>\u7684<code>cpu</code>\u3001\u5185\u5b58\u7b49\uff0c\u4e00\u822c\u6765\u8bf4\uff0c\u6838\u5fc3\u6307\u6807\u4f5cHPA\u5df2\u7ecf\u8db3\u591f\uff0c\u4f46\u5982\u679c\u60f3\u6839\u636e\u81ea\u5b9a\u4e49\u6307\u6807:\u5982\u8bf7\u6c42<code>qps/5xx</code>\u9519\u8bef\u6570\u6765\u5b9e\u73b0HPA\uff0c\u5c31\u9700\u8981\u4f7f\u7528\u81ea\u5b9a\u4e49\u6307\u6807\u4e86\u3002</p> <p>\u76ee\u524d<code>Kubernetes</code>\u4e2d\u81ea\u5b9a\u4e49\u6307\u6807\u4e00\u822c\u7531<code>Prometheus</code>\u6765\u63d0\u4f9b\uff0c\u518d\u5229\u7528<code>k8s-prometheus-adpater</code>\u805a\u5408\u5230<code>apiserver</code>\uff0c\u5b9e\u73b0\u548c\u6838\u5fc3\u6307\u6807\uff08<code>metric-server</code>)\u540c\u6837\u7684\u6548\u679c\u3002</p>"},{"location":"chap1/37kubectl_top/#35-kubelet","title":"3.5 kubelet","text":"<p>\u524d\u9762\u63d0\u5230\uff0c\u65e0\u8bba\u662f <code>heapster</code>\u8fd8\u662f <code>metric-server</code>\uff0c\u90fd\u53ea\u662f\u6570\u636e\u7684\u4e2d\u8f6c\u548c\u805a\u5408\uff0c\u4e24\u8005\u90fd\u662f\u8c03\u7528\u7684 <code>kubelet</code> \u7684 <code>api</code>\u63a5\u53e3\u83b7\u53d6\u7684\u6570\u636e\uff0c\u800c <code>kubelet</code> \u4ee3\u7801\u4e2d\u5b9e\u9645\u91c7\u96c6\u6307\u6807\u7684\u662f <code>cadvisor</code> \u6a21\u5757\uff0c\u4f60\u53ef\u4ee5\u5728 <code>node</code> \u8282\u70b9\u8bbf\u95ee <code>10255</code> \u7aef\u53e3 \uff08<code>read-only-port</code>)\u83b7\u53d6\u76d1\u63a7\u6570\u636e\uff1a</p> <ul> <li><code>Kubelet Summary metrics: 127.0.0.1:10255/metrics</code>\uff0c\u66b4\u9732<code>node\u3001pod</code>\u6c47\u603b\u6570\u636e</li> <li><code>Cadvisor metrics: 127.0.0.1:10255/metrics/cadvisor</code>\uff0c\u66b4\u9732 <code>container</code> \u7ef4\u5ea6\u6570\u636e</li> </ul> <p>\u793a\u4f8b\uff0c\u5bb9\u5668\u7684\u5185\u5b58\u4f7f\u7528\u91cf\uff1a</p> <p></p> <p>kubelet\u867d\u7136\u63d0\u4f9b\u4e86<code>metric</code> \u63a5\u53e3\uff0c\u4f46\u5b9e\u9645\u76d1\u63a7\u903b\u8f91\u7531\u5185\u7f6e\u7684<code>cAdvisor</code>\u6a21\u5757\u8d1f\u8d23\uff0c\u6f14\u53d8\u8fc7\u7a0b\u5982\u4e0b\uff1a</p> <ul> <li>\u4ece<code>k8s 1.6</code>\u5f00\u59cb\uff0c<code>kubernetes</code>\u5c06<code>cAdvisor</code>\u5f00\u59cb\u96c6\u6210\u5728<code>kubelet</code>\u4e2d\uff0c\u4e0d\u9700\u8981\u5355\u72ec\u914d\u7f6e</li> <li>\u4ece<code>k8s 1.7</code>\u5f00\u59cb\uff0c<code>Kubelet metrics API</code> \u4e0d\u518d\u5305\u542b <code>cadvisor metrics</code>\uff0c\u800c\u662f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u72ec\u7acb\u7684 <code>API</code> \u63a5\u53e3\u6765\u505a\u6c47\u603b</li> <li>\u4ece<code>k8s 1.12</code>\u5f00\u59cb\uff0c<code>cadvisor</code> \u76d1\u542c\u7684\u7aef\u53e3\u5728<code>k8s</code>\u4e2d\u88ab\u5220\u9664\uff0c\u6240\u6709\u76d1\u63a7\u6570\u636e\u7edf\u4e00\u7531<code>Kubelet</code>\u7684<code>API</code>\u63d0\u4f9b</li> </ul> <p>\u5230\u8fd9\u91cc\u4e3a\u6b62\uff0c<code>k8s</code>\u8303\u56f4\u5185\u7684\u76d1\u63a7\u4f53\u7cfb\u5c31\u7ed3\u675f\u4e86\uff0c\u5982\u679c\u4f60\u60f3\u7ee7\u7eed\u4e86\u89e3cadvisor\u548c cgroup \u7684\u5185\u5bb9\uff0c\u53ef\u4ee5\u5411\u4e0b\u9605\u8bfb</p>"},{"location":"chap1/37kubectl_top/#36-cadvisor","title":"3.6 cadvisor","text":"<p>cadvisor\u7531\u8c37\u6b4c\u5f00\u6e90\uff0c\u4f7f\u7528Go\u5f00\u53d1\uff0c\u9879\u76ee\u5730\u5740\u4e5f\u662f<code>google/cadvisor</code>\uff0c<code>cadvisor</code>\u4e0d\u4ec5\u53ef\u4ee5\u641c\u96c6\u4e00\u53f0\u673a\u5668\u4e0a\u6240\u6709\u8fd0\u884c\u7684\u5bb9\u5668\u4fe1\u606f\uff0c\u5305\u62ec<code>CPU</code>\u4f7f\u7528\u60c5\u51b5\u3001\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u3001\u7f51\u7edc\u541e\u5410\u91cf\u53ca\u6587\u4ef6\u7cfb\u7edf\u4f7f\u7528\u60c5\u51b5\uff0c\u8fd8\u63d0\u4f9b\u57fa\u7840\u67e5\u8be2\u754c\u9762\u548chttp\u63a5\u53e3\uff0c\u65b9\u4fbf\u5176\u4ed6\u7ec4\u4ef6\u8fdb\u884c\u6570\u636e\u6293\u53d6\u3002\u5728K8S\u4e2d\u96c6\u6210\u5728Kubelet\u91cc\u4f5c\u4e3a\u9ed8\u8ba4\u542f\u52a8\u9879\uff0ck8s\u5b98\u65b9\u6807\u914d\u3002</p> <p>cadvisor \u62ff\u5230\u7684\u6570\u636e\u7ed3\u6784\u793a\u4f8b\uff1a</p> <p></p> <p>\u6838\u5fc3\u903b\u8f91\uff1a</p> <p>\u901a\u8fc7<code>new</code>\u51fa\u6765\u7684<code>memoryStorage</code>\u4ee5\u53ca<code>sysfs</code>\u5b9e\u4f8b\uff0c\u521b\u5efa\u4e00\u4e2a<code>manager</code>\u5b9e\u4f8b\uff0c<code>manager</code>\u7684<code>interface</code>\u4e2d\u5b9a\u4e49\u4e86\u8bb8\u591a\u7528\u4e8e\u83b7\u53d6\u5bb9\u5668\u548c<code>machine</code>\u4fe1\u606f\u7684\u51fd\u6570</p> <p></p> <p>cadvisor\u7684\u6307\u6807\u89e3\u8bfb\uff1acgroup-v1</p> <p><code>cadvisor</code>\u83b7\u53d6\u6307\u6807\u65f6\u5b9e\u9645\u8c03\u7528\u7684\u662f <code>runc/libcontainer</code>\u5e93\uff0c\u800c<code>libcontainer</code>\u662f\u5bf9<code>cgroup</code>\u6587\u4ef6 \u7684\u5c01\u88c5\uff0c\u5373 <code>cadvsio</code>r\u4e5f\u53ea\u662f\u4e2a\u8f6c\u53d1\u8005\uff0c\u5b83\u7684\u6570\u636e\u6765\u81ea\u4e8e<code>cgroup</code>\u6587\u4ef6\u3002</p>"},{"location":"chap1/37kubectl_top/#37-cgroup","title":"3.7 cgroup","text":"<p>cgroup\u6587\u4ef6\u4e2d\u7684\u503c\u662f\u76d1\u63a7\u6570\u636e\u7684\u6700\u7ec8\u6765\u6e90\uff0c\u5982</p> <ul> <li><code>mem usage</code>\u7684\u503c\uff0c\u6765\u81ea\u4e8e <code>/sys/fs/cgroup/memory/docker/[containerId]/memory.usage_in_bytes</code></li> <li>\u5982\u679c\u6ca1\u9650\u5236\u5185\u5b58\uff0c<code>Limit = machine_mem</code>\uff0c\u5426\u5219\u6765\u81ea\u4e8e<code>/sys/fs/cgroup/memory/docker/[id]/memory.limit_in_bytes</code></li> <li>\u5185\u5b58\u4f7f\u7528\u7387 <code>= memory.usage_in_bytes/memory.limit_in_bytes</code></li> </ul> <p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0ccgroup\u6587\u4ef6\u5939\u4e0b\u7684\u5185\u5bb9\u5305\u62ecCPU\u3001\u5185\u5b58\u3001\u78c1\u76d8\u3001\u7f51\u7edc\u7b49\u4fe1\u606f\uff1a</p> <p></p> <p>\u5982memory\u4e0b\u7684\u51e0\u4e2a\u5e38\u7528\u7684\u6307\u6807\u542b\u4e49\uff1a</p> <p></p> <p><code>memory.stat</code>\u4e2d\u7684\u4fe1\u606f\u662f\u6700\u5168\u7684\uff1a</p> <p></p> <p>\u539f\u7406\u5230\u8fd9\u91cc\u7ed3\u675f\uff0c\u8fd9\u91cc\u89e3\u91ca\u4e0b\u6700\u5f00\u59cb\u7684kubectl top \u7684\u51e0\u4e2a\u95ee\u9898\uff1a</p>"},{"location":"chap1/37kubectl_top/#_1","title":"\u56db. \u95ee\u9898","text":""},{"location":"chap1/37kubectl_top/#41-kubectl-top","title":"4.1 kubectl top \u4e3a\u4ec0\u4e48\u4f1a\u62a5\u9519","text":"<p>\u4e00\u822c\u60c5\u51b5\u4e0b top \u62a5\u9519\u6709\u4ee5\u4e0b\u51e0\u79cd\uff0c\u53ef\u4ee5 <code>kubectl top pod -v=10</code>\u770b\u5230\u5177\u4f53\u7684\u8c03\u7528\u65e5\u5fd7:</p> <ul> <li>\u6ca1\u6709\u90e8\u7f72 <code>heapster</code> \u6216\u8005 <code>metric-server</code>\uff0c\u6216\u8005<code>pod</code>\u8fd0\u884c\u5f02\u5e38\uff0c\u53ef\u4ee5\u6392\u67e5\u5bf9\u5e94 <code>pod</code>\u65e5\u5fd7</li> <li>\u8981\u770b\u7684<code>pod</code>\u521a\u521a\u5efa\u51fa\u6765\uff0c\u8fd8\u6ca1\u6765\u5f97\u53ca\u91c7\u96c6\u6307\u6807\uff0c\u62a5 <code>not found</code>\u9519\u8bef\uff0c\u9ed8\u8ba4<code>1</code>\u5206\u949f</li> <li>\u4ee5\u4e0a\u4e24\u79cd\u90fd\u4e0d\u662f\uff0c\u53ef\u4ee5\u68c0\u67e5\u4e0b<code>kubelet</code> \u7684 <code>10255</code>\u7aef\u53e3\u662f\u5426\u5f00\u653e\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u4f7f\u7528\u8fd9\u4e2a\u53ea\u8bfb\u7aef\u53e3\u83b7\u53d6\u6307\u6807\uff0c\u4e5f\u53ef\u4ee5\u5728<code>heapster</code>\u6216<code>metric-server</code>\u7684\u914d\u7f6e\u4e2d\u589e\u52a0\u8bc1\u4e66\uff0c\u6362\u6210 <code>10250</code> \u8ba4\u8bc1\u7aef\u53e3</li> </ul>"},{"location":"chap1/37kubectl_top/#42-kubectl-top-pod-pause","title":"4.2 kubectl top pod \u5185\u5b58\u600e\u4e48\u8ba1\u7b97\uff0c\u5305\u542b pause\u5bb9\u5668\u5417","text":"<p>\u6bcf\u6b21\u542f\u52a8<code>pod</code>\uff0c\u90fd\u4f1a\u6709\u4e00\u4e2a <code>pause</code> \u5bb9\u5668\uff0c\u65e2\u7136\u662f\u5bb9\u5668\u5c31\u4e00\u5b9a\u6709\u8d44\u6e90\u6d88\u8017\uff08\u4e00\u822c\u5728 2-3M \u7684\u5185\u5b58\uff09\uff0c<code>cgroup</code> \u6587\u4ef6\u4e2d\uff0c\u4e1a\u52a1\u5bb9\u5668\u548c<code>pause</code> \u5bb9\u5668\u90fd\u5728\u540c\u4e00\u4e2a pod\u7684\u6587\u4ef6\u5939\u4e0b\u3002</p> <p>\u4f46 <code>cadvisor</code> \u5728\u67e5\u8be2 <code>pod</code> \u7684\u5185\u5b58\u4f7f\u7528\u91cf\u65f6\uff0c\u662f\u5148\u83b7\u53d6\u4e86 <code>pod</code> \u4e0b\u7684<code>container</code>\u5217\u8868\uff0c\u518d\u9010\u4e2a\u83b7\u53d6<code>container</code>\u7684\u5185\u5b58\u5360\u7528\uff0c\u4e0d\u8fc7\u8fd9\u91cc\u7684 <code>container</code>\u5217\u8868\u5e76\u6ca1\u6709\u5305\u542b<code>pause</code>\uff0c\u56e0\u6b64\u6700\u7ec8<code>top pod</code> \u7684\u7ed3\u679c\u4e5f\u4e0d\u5305\u542b <code>pause</code> \u5bb9\u5668</p>"},{"location":"chap1/37kubectl_top/#pod","title":"pod \u7684\u5185\u5b58\u4f7f\u7528\u91cf\u8ba1\u7b97","text":"<p>kubectl top pod \u5f97\u5230\u7684\u5185\u5b58\u4f7f\u7528\u91cf\uff0c\u5e76\u4e0d\u662f<code>cadvisor</code> \u4e2d\u7684<code>container_memory_usage_bytes</code>\uff0c\u800c\u662f<code>container_memory_working_set_bytes</code>\uff0c\u8ba1\u7b97\u65b9\u5f0f\u4e3a\uff1a</p> <ul> <li><code>container_memory_usage_bytes == container_memory_rss + container_memory_cache + kernel memory</code></li> <li><code>container_memory_working_set_bytes = container_memory_usage_bytes \u2013 total_inactive_file</code>\uff08\u672a\u6fc0\u6d3b\u7684\u533f\u540d\u7f13\u5b58\u9875\uff09</li> </ul> <p><code>container_memory_working_set_bytes</code>\u662f\u5bb9\u5668\u771f\u5b9e\u4f7f\u7528\u7684\u5185\u5b58\u91cf\uff0c\u4e5f\u662f<code>limit</code>\u9650\u5236\u65f6\u7684 <code>oom</code> \u5224\u65ad\u4f9d\u636e</p> <p><code>cadvisor</code>\u4e2d\u7684 <code>container_memory_usage_bytes</code>\u5bf9\u5e94 <code>cgroup</code> \u4e2d\u7684 <code>memory.usage_in_bytes</code>\u6587\u4ef6\uff0c\u4f46<code>container_memory_working_set_bytes</code>\u5e76\u6ca1\u6709\u5177\u4f53\u7684\u6587\u4ef6\uff0c\u4ed6\u7684\u8ba1\u7b97\u903b\u8f91\u5728 <code>cadvisor</code> \u7684\u4ee3\u7801\u4e2d\uff0c\u5982\u4e0b\uff1a</p> <p></p> <p>\u540c\u7406\uff0cnode \u7684\u5185\u5b58\u4f7f\u7528\u91cf\u4e5f\u662f<code>container_memory_working_set_bytes</code></p>"},{"location":"chap1/37kubectl_top/#43-kubectl-top-node-top","title":"4.3 kubectl top node \u600e\u4e48\u8ba1\u7b97\uff0c\u548c\u8282\u70b9\u4e0a\u76f4\u63a5 top \u6709\u4ec0\u4e48\u533a\u522b","text":"<p><code>kubectl top node</code>\u5f97\u5230\u7684 <code>cpu</code> \u548c\u5185\u5b58\u503c\uff0c\u5e76\u4e0d\u662f\u8282\u70b9\u4e0a\u6240\u6709 <code>pod</code> \u7684\u603b\u548c\uff0c\u4e0d\u8981\u76f4\u63a5\u76f8\u52a0\u3002<code>top node</code>\u662f\u673a\u5668\u4e0a<code>cgroup</code>\u6839\u76ee\u5f55\u4e0b\u7684\u6c47\u603b\u7edf\u8ba1</p> <p></p> <p>\u5728\u673a\u5668\u4e0a\u76f4\u63a5 top\u547d\u4ee4\u770b\u5230\u7684\u503c\u548c<code>kubectl top node</code>\u4e0d\u80fd\u76f4\u63a5\u5bf9\u6bd4\uff0c\u56e0\u4e3a\u8ba1\u7b97\u903b\u8f91\u4e0d\u540c\uff0c\u5982\u5185\u5b58\uff0c\u5927\u81f4\u7684\u5bf9\u5e94\u5173\u7cfb\u662f(\u524d\u8005\u662f\u673a\u5668\u4e0a top\uff0c\u540e\u8005\u662fkubectl top):</p> <pre><code>rss + cache = (in)active_anon + (in)active_file\n</code></pre>"},{"location":"chap1/37kubectl_top/#44-kubectl-top-pod-exec-pod-top","title":"4.4 kubectl top pod \u548cexec \u8fdb\u5165 pod \u540e\u770b\u5230\u7684 top \u4e0d\u4e00\u6837","text":"<p>top\u547d\u4ee4\u7684\u5dee\u5f02\u548c\u4e0a\u8fb9 \u4e00\u81f4\uff0c\u65e0\u6cd5\u76f4\u63a5\u5bf9\u6bd4\uff0c\u540c\u65f6\uff0c\u5c31\u7b97\u4f60\u5bf9 <code>pod</code> \u505a\u4e86<code>limit</code> \u9650\u5236\uff0c<code>pod</code> \u5185\u7684 <code>top</code> \u770b\u5230\u7684\u5185\u5b58\u548c <code>cpu</code>\u603b\u91cf\u4ecd\u7136\u662f\u673a\u5668\u603b\u91cf\uff0c\u5e76\u4e0d\u662f<code>pod</code> \u53ef\u5206\u914d\u91cf</p> <ul> <li>\u8fdb\u7a0b\u7684<code>RSS</code>\u4e3a\u8fdb\u7a0b\u4f7f\u7528\u7684\u6240\u6709\u7269\u7406\u5185\u5b58\uff08<code>file_rss\uff0banon_rss</code>\uff09\uff0c\u5373<code>Anonymous pages\uff0bMapped apges</code>\uff08\u5305\u542b\u5171\u4eab\u5185\u5b58\uff09</li> <li><code>cgroup RSS</code>\u4e3a\uff08<code>anonymous and swap cache memory</code>\uff09\uff0c\u4e0d\u5305\u542b\u5171\u4eab\u5185\u5b58\u3002\u4e24\u8005\u90fd\u4e0d\u5305\u542b<code>file cache</code></li> </ul>"},{"location":"chap1/37kubectl_top/#45-kubectl-top-pod-docker-stats","title":"4.5 kubectl top pod \u548c docker stats\u5f97\u5230\u7684\u503c\u4e3a\u4ec0\u4e48\u4e0d\u540c\uff1f","text":"<p><code>docker stats dockerID</code> \u53ef\u4ee5\u770b\u5230\u5bb9\u5668\u5f53\u524d\u7684\u4f7f\u7528\u91cf\uff1a</p> <p></p> <p>\u5982\u679c\u4f60\u7684 <code>pod</code>\u4e2d\u53ea\u6709\u4e00\u4e2a <code>container</code>\uff0c\u4f60\u4f1a\u53d1\u73b0<code>docker stats</code>\u503c\u4e0d\u7b49\u4e8e<code>kubectl top</code> \u7684\u503c\uff0c\u65e2\u4e0d\u7b49\u4e8e<code>container_memory_usage_bytes</code>\uff0c\u4e5f\u4e0d\u7b49\u4e8e<code>container_memory_working_set_bytes</code>\u3002</p> <p>\u56e0\u4e3a<code>docker stats</code> \u548c <code>cadvisor</code> \u7684\u8ba1\u7b97\u65b9\u5f0f\u4e0d\u540c\uff0c\u603b\u4f53\u503c\u4f1a\u5c0f\u4e8e<code>kubectl top</code>\uff1a\u8ba1\u7b97\u903b\u8f91\u662f\uff1a</p> <pre><code>docker stats = container_memory_usage_bytes - container_memory_cache\n</code></pre>"},{"location":"chap1/37kubectl_top/#_2","title":"\u4e94. \u540e\u8bb0","text":"<p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5e76\u4e0d\u9700\u8981\u65f6\u523b\u5173\u5fc3node \u6216 pod \u7684\u4f7f\u7528\u91cf\uff0c\u56e0\u4e3a\u6709\u96c6\u7fa4\u81ea\u52a8\u6269\u7f29\u5bb9(cluster-autoscaler)\u548cpod \u6c34\u5e73\u6269\u7f29\u5bb9\uff08<code>HPA</code>\uff09\u6765\u5e94\u5bf9\u8fd9\u4e24\u79cd\u8d44\u6e90\u53d8\u5316\uff0c\u8d44\u6e90\u6307\u6807\u7684\u610f\u4e49\u66f4\u9002\u5408\u4f7f\u7528<code>prometheus</code>\u6765\u6301\u4e45\u5316<code>cadvisor</code>\u7684\u6570\u636e\uff0c\u7528\u4e8e\u56de\u6eaf\u5386\u53f2\u6216\u8005\u53d1\u9001\u62a5\u8b66\u3002</p> <p>\u5176\u4ed6\u8865\u5145\uff1a</p> <ul> <li>\u867d\u7136<code>kubectl top help</code>\u4e2d\u663e\u793a\u652f\u6301<code>Storage</code>\uff0c\u4f46\u76f4\u5230 1.16 \u7248\u672c\u4ecd\u7136\u4e0d\u652f\u6301</li> <li>1.13 \u4e4b\u524d\u9700\u8981 heapster\uff0c1.13 \u4ee5\u540e\u9700\u8981<code>metric-server</code>\uff0c\u8fd9\u90e8\u5206<code>kubectl top help</code>\u7684\u8f93\u51fa \u6709\u8bef\uff0c\u91cc\u9762\u53ea\u63d0\u5230\u4e86heapster</li> <li><code>k8s dashboard</code> \u4e2d\u7684\u76d1\u63a7\u56fe\u9ed8\u8ba4\u4f7f\u7528\u7684\u662f<code>heapster</code>\uff0c\u5207\u6362\u4e3a <code>metric-server</code>\u540e\u6570\u636e\u4f1a\u5f02\u5e38\uff0c\u9700\u8981\u591a\u90e8\u7f72\u4e00\u4e2a<code>metric-server-scraper</code> \u7684 <code>pod</code> \u6765\u505a\u63a5\u53e3\u8f6c\u6362\uff0c\u5177\u4f53\u53c2\u8003 pr\uff1ahttps://github.com/kubernetes/dashboard/pull/3504</li> </ul>"},{"location":"chap1/38k8s_hpa_metricsserver/","title":"\u7b2c\u516d\u8282 Kubernetes HPA \u4f7f\u7528\u8be6\u89e3(Metrics Server/CPU/Mem/adapater)","text":"<ul> <li>Metrics Server</li> <li>\u57fa\u4e8e CPU \u7684 HPA</li> <li>\u57fa\u4e8e\u5185\u5b58 \u7684 HPA</li> <li>\u57fa\u4e8e\u81ea\u5b9a\u4e49\u6307\u6807 \u548c Prometheus-adapater \u7684 HPA</li> </ul> <p>\u5728\u524d\u9762\u7684\u5b66\u4e60\u4e2d\u6211\u4eec\u4f7f\u7528\u7528\u4e00\u4e2a <code>kubectl scale</code> \u547d\u4ee4\u53ef\u4ee5\u6765\u5b9e\u73b0 <code>Pod</code> \u7684\u6269\u7f29\u5bb9\u529f\u80fd\uff0c\u4f46\u662f\u8fd9\u4e2a\u6bd5\u7adf\u662f\u5b8c\u5168\u624b\u52a8\u64cd\u4f5c\u7684\uff0c\u8981\u5e94\u5bf9\u7ebf\u4e0a\u7684\u5404\u79cd\u590d\u6742\u60c5\u51b5\uff0c\u6211\u4eec\u9700\u8981\u80fd\u591f\u505a\u5230\u81ea\u52a8\u5316\u53bb\u611f\u77e5\u4e1a\u52a1\uff0c\u6765\u81ea\u52a8\u8fdb\u884c\u6269\u7f29\u5bb9\u3002</p> <p>\u4e3a\u6b64\uff0c<code>Kubernetes</code> \u4e5f\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u4e00\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a<code>Horizontal Pod Autoscaling</code>\uff08Pod \u6c34\u5e73\u81ea\u52a8\u4f38\u7f29\uff09\uff0c\u7b80\u79f0<code>HPA</code>\uff0c<code>HPA</code> \u901a\u8fc7\u76d1\u63a7\u5206\u6790\u4e00\u4e9b\u63a7\u5236\u5668\u63a7\u5236\u7684\u6240\u6709 <code>Pod</code> \u7684\u8d1f\u8f7d\u53d8\u5316\u60c5\u51b5\u6765\u786e\u5b9a\u662f\u5426\u9700\u8981\u8c03\u6574 <code>Pod</code> \u7684\u526f\u672c\u6570\u91cf\uff0c\u8fd9\u662f <code>HPA</code> \u6700\u57fa\u672c\u7684\u539f\u7406\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u7684\u901a\u8fc7 <code>kubectl autoscale</code> \u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a <code>HPA</code> \u8d44\u6e90\u5bf9\u8c61\uff0c<code>HPA Controller</code>\u9ed8\u8ba4<code>30s</code>\u8f6e\u8be2\u4e00\u6b21\uff08\u53ef\u901a\u8fc7<code>kube-controller-manager</code> \u7684<code>--horizontal-pod-autoscaler-sync-period</code> \u53c2\u6570\u8fdb\u884c\u8bbe\u7f6e\uff09\uff0c\u67e5\u8be2\u6307\u5b9a\u7684\u8d44\u6e90\u4e2d\u7684 <code>Pod</code> \u8d44\u6e90\u4f7f\u7528\u7387\uff0c\u5e76\u4e14\u4e0e\u521b\u5efa\u65f6\u8bbe\u5b9a\u7684\u503c\u548c\u6307\u6807\u505a\u5bf9\u6bd4\uff0c\u4ece\u800c\u5b9e\u73b0\u81ea\u52a8\u4f38\u7f29\u7684\u529f\u80fd\u3002</p>"},{"location":"chap1/38k8s_hpa_metricsserver/#1-metrics-server","title":"1 Metrics Server","text":"<p>\u5728 <code>HPA</code> \u7684\u7b2c\u4e00\u4e2a\u7248\u672c\u4e2d\uff0c\u6211\u4eec\u9700\u8981 <code>Heapster</code> \u63d0\u4f9b <code>CPU</code> \u548c\u5185\u5b58\u6307\u6807\uff0c\u5728 <code>HPA v2</code> \u8fc7\u540e\u5c31\u9700\u8981\u5b89\u88c5 <code>Metrcis Server</code>\u4e86\uff0c<code>Metrics Server</code> \u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684 <code>Kubernetes API</code>\u628a\u76d1\u63a7\u6570\u636e\u66b4\u9732\u51fa\u6765\uff0c\u6709\u4e86 <code>Metrics Server</code> \u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684 <code>Kubernetes API</code> \u6765\u8bbf\u95ee\u6211\u4eec\u60f3\u8981\u83b7\u53d6\u7684\u76d1\u63a7\u6570\u636e\u4e86\uff1a</p> <pre><code>https://10.96.0.1/apis/metrics.k8s.io/v1beta1/namespaces/&lt;namespace-name&gt;/pods/&lt;pod-name&gt;\n</code></pre> <p>\u6bd4\u5982\u5f53\u6211\u4eec\u8bbf\u95ee\u4e0a\u9762\u7684 <code>API</code> \u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u83b7\u53d6\u5230\u8be5 <code>Pod</code>\u7684\u8d44\u6e90\u6570\u636e\uff0c\u8fd9\u4e9b\u6570\u636e\u5176\u5b9e\u662f\u6765\u81ea\u4e8e<code>kubelet</code>\u7684 <code>Summary API</code> \u91c7\u96c6\u800c\u6765\u7684\u3002</p> <p>\u4e0d\u8fc7\u9700\u8981\u8bf4\u660e\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684 <code>API</code> \u6765\u83b7\u53d6\u8d44\u6e90\u76d1\u63a7\u6570\u636e\uff0c\u5e76\u4e0d\u662f\u56e0\u4e3a <code>Metrics Server</code> \u5c31\u662f <code>APIServer</code> \u7684\u4e00\u90e8\u5206\uff0c\u800c\u662f\u901a\u8fc7 <code>Kubernetes</code> \u63d0\u4f9b\u7684 <code>Aggregator</code> \u6c47\u805a\u63d2\u4ef6\u6765\u5b9e\u73b0\u7684\uff0c\u662f\u72ec\u7acb\u4e8e <code>APIServer</code> \u4e4b\u5916\u8fd0\u884c\u7684\u3002</p> <p></p>"},{"location":"chap1/38k8s_hpa_metricsserver/#1-1-api","title":"1-1 \u805a\u5408 API","text":"<p><code>Aggregator</code> \u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u7f16\u5199\u4e00\u4e2a\u81ea\u5df1\u7684\u670d\u52a1\uff0c\u628a\u8fd9\u4e2a\u670d\u52a1\u6ce8\u518c\u5230 <code>Kubernetes</code> \u7684 <code>APIServer</code> \u91cc\u9762\u53bb\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u50cf\u539f\u751f\u7684 <code>APIServer</code> \u63d0\u4f9b\u7684 <code>API</code> \u4f7f\u7528\u81ea\u5df1\u7684 <code>API</code> \u4e86\uff0c\u6211\u4eec\u628a\u81ea\u5df1\u7684\u670d\u52a1\u8fd0\u884c\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u91cc\u9762\uff0c\u7136\u540e <code>Kubernetes</code> \u7684 <code>Aggregator</code> \u901a\u8fc7 <code>Service</code> \u540d\u79f0\u5c31\u53ef\u4ee5\u8f6c\u53d1\u5230\u6211\u4eec\u81ea\u5df1\u5199\u7684 <code>Service</code> \u91cc\u9762\u53bb\u4e86\u3002</p> <p>\u8fd9\u6837\u8fd9\u4e2a\u805a\u5408\u5c42\u5c31\u5e26\u6765\u4e86\u5f88\u591a\u597d\u5904\uff1a</p> <ul> <li>\u589e\u52a0\u4e86 <code>API</code> \u7684\u6269\u5c55\u6027\uff0c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u7f16\u5199\u81ea\u5df1\u7684 <code>API</code> \u670d\u52a1\u6765\u66b4\u9732\u4ed6\u4eec\u60f3\u8981\u7684 <code>API</code>\u3002</li> <li>\u4e30\u5bcc\u4e86 <code>API</code>\uff0c\u6838\u5fc3 <code>kubernetes</code> \u56e2\u961f\u963b\u6b62\u4e86\u5f88\u591a\u65b0\u7684 <code>API</code> \u63d0\u6848\uff0c\u901a\u8fc7\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u5c06\u4ed6\u4eec\u7684 <code>API</code> \u4f5c\u4e3a\u5355\u72ec\u7684\u670d\u52a1\u516c\u5f00\uff0c\u8fd9\u6837\u5c31\u65e0\u987b\u793e\u533a\u7e41\u6742\u7684\u5ba1\u67e5\u4e86\u3002</li> <li>\u5f00\u53d1\u5206\u9636\u6bb5\u5b9e\u9a8c\u6027 <code>API</code>\uff0c\u65b0\u7684 <code>API</code>\u53ef\u4ee5\u5728\u5355\u72ec\u7684\u805a\u5408\u670d\u52a1\u4e2d\u5f00\u53d1\uff0c\u5f53\u5b83\u7a33\u5b9a\u4e4b\u540e\uff0c\u5728\u5408\u5e76\u4f1a <code>APIServer</code> \u5c31\u5f88\u5bb9\u6613\u4e86\u3002</li> <li>\u786e\u4fdd\u65b0 <code>API</code> \u9075\u5faa <code>Kubernetes</code> \u7ea6\u5b9a\uff0c\u5982\u679c\u6ca1\u6709\u8fd9\u91cc\u63d0\u51fa\u7684\u673a\u5236\uff0c\u793e\u533a\u6210\u5458\u53ef\u80fd\u4f1a\u88ab\u8feb\u63a8\u51fa\u81ea\u5df1\u7684\u4e1c\u897f\uff0c\u8fd9\u6837\u5f88\u53ef\u80fd\u9020\u6210\u793e\u533a\u6210\u5458\u548c\u793e\u533a\u7ea6\u5b9a\u4e0d\u4e00\u81f4\u3002</li> </ul>"},{"location":"chap1/38k8s_hpa_metricsserver/#1-2","title":"1-2 \u5b89\u88c5","text":"<p>\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u8981\u4f7f\u7528 <code>HPA</code>\uff0c\u5c31\u9700\u8981\u5728\u96c6\u7fa4\u4e2d\u5b89\u88c5 <code>Metrics Server</code> \u670d\u52a1\uff0c\u8981\u5b89\u88c5 <code>Metrics Server</code> \u5c31\u9700\u8981\u5f00\u542f <code>Aggregator</code>\uff0c\u56e0\u4e3a <code>Metrics Server</code> \u5c31\u662f\u901a\u8fc7\u8be5\u4ee3\u7406\u8fdb\u884c\u6269\u5c55\u7684\uff0c\u4e0d\u8fc7\u6211\u4eec\u96c6\u7fa4\u662f\u901a\u8fc7 <code>Kubeadm</code> \u642d\u5efa\u7684\uff0c\u9ed8\u8ba4\u5df2\u7ecf\u5f00\u542f\u4e86\uff0c\u5982\u679c\u662f\u4e8c\u8fdb\u5236\u65b9\u5f0f\u5b89\u88c5\u7684\u96c6\u7fa4\uff0c\u9700\u8981\u5355\u72ec\u914d\u7f6e <code>kube-apsierver</code> \u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u53c2\u6570\uff1a</p> <pre><code>--requestheader-client-ca-file=&lt;path to aggregator CA cert&gt;\n--requestheader-allowed-names=aggregator\n--requestheader-extra-headers-prefix=X-Remote-Extra-\n--requestheader-group-headers=X-Remote-Group\n--requestheader-username-headers=X-Remote-User\n--proxy-client-cert-file=&lt;path to aggregator proxy cert&gt;\n--proxy-client-key-file=&lt;path to aggregator proxy key&gt;\n</code></pre> <pre><code>- --requestheader-allowed-names=front-proxy-client\n</code></pre> <p>\u5982\u679c <code>kube-proxy</code> \u6ca1\u6709\u548c <code>APIServer</code> \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u4e3b\u673a\u4e0a\uff0c\u90a3\u4e48\u9700\u8981\u786e\u4fdd\u542f\u7528\u4e86\u5982\u4e0b <code>kube-apsierver</code> \u7684\u53c2\u6570\uff1a</p> <pre><code>--enable-aggregator-routing=true\n</code></pre> <p>\u5bf9\u4e8e\u8fd9\u4e9b\u8bc1\u4e66\u7684\u751f\u6210\u65b9\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff1ahttps://github.com/kubernetes-sigs/apiserver-builder-alpha/blob/master/docs/concepts/auth.md\u3002</p> <p><code>Aggregator</code> \u805a\u5408\u5c42\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u5c31\u53ef\u4ee5\u6765\u5b89\u88c5<code>Metrics Server</code> \u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u83b7\u53d6\u8be5\u4ed3\u5e93\u7684\u5b98\u65b9\u5b89\u88c5\u8d44\u6e90\u6e05\u5355\uff1a</p> <pre><code>$ git clone https://github.com/kubernetes-incubator/metrics-server\n$ cd metrics-server\n$ kubectl apply -f deploy/1.8+/\n</code></pre> <p>\u5728\u90e8\u7f72\u4e4b\u524d\uff0c\u4fee\u6539 <code>metrcis-server/deploy/1.8+/metrics-server-deployment.yaml</code>\u7684\u955c\u50cf\u5730\u5740\u4e3a\uff1a</p> <pre><code>containers:\n- name: metrics-server\n  image: gcr.azk8s.cn/google_containers/metrics-server-amd64:v0.3.6\n</code></pre> <p>\u7b49\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770b Pod \u65e5\u5fd7\u662f\u5426\u6b63\u5e38\uff1a</p> <pre><code>$ kubectl get pods -n kube-system -l k8s-app=metrics-server\nNAME                              READY   STATUS    RESTARTS   AGE\nmetrics-server-6886856d7c-g5k6q   1/1     Running   0          2m39s\n$ kubectl logs -f metrics-server-6886856d7c-g5k6q -n kube-system\n......\nE1119 09:05:57.234312       1 manager.go:111] unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:jxi-node1: unable to fetch metrics from Kubelet jxi-node1 (jxi-node1): Get https://jxi-node1:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-node1 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:jxi-node4: unable to fetch metrics from Kubelet jxi-node4 (jxi-node4): Get https://jxi-node4:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-node4 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:jxi-node3: unable to fetch metrics from Kubelet jxi-node3 (jxi-node3): Get https://jxi-node3:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-node3 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:jxi-master: unable to fetch metrics from Kubelet jxi-master (jxi-master): Get https://jxi-master:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-master on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:jxi-node2: unable to fetch metrics from Kubelet jxi-node2 (jxi-node2): Get https://jxi-node2:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-node2 on 10.96.0.10:53: no such host]\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 Pod \u4e2d\u51fa\u73b0\u4e86\u4e00\u4e9b\u9519\u8bef\u4fe1\u606f\uff1a<code>xxx: no such host</code>\uff0c\u6211\u4eec\u770b\u5230\u8fd9\u4e2a\u9519\u8bef\u4fe1\u606f\u4e00\u822c\u5c31\u53ef\u4ee5\u786e\u5b9a\u662f<code>DNS</code>\u89e3\u6790\u4e0d\u4e86\u9020\u6210\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>Metrics Server</code> \u4f1a\u901a\u8fc7 <code>kubelet</code> \u7684 <code>10250</code> \u7aef\u53e3\u83b7\u53d6\u4fe1\u606f\uff0c\u4f7f\u7528\u7684\u662f <code>hostname</code>\uff0c\u6211\u4eec\u90e8\u7f72\u96c6\u7fa4\u7684\u65f6\u5019\u5728\u8282\u70b9\u7684 <code>/etc/hosts</code>\u91cc\u9762\u6dfb\u52a0\u4e86\u8282\u70b9\u7684 <code>hostname</code> \u548c <code>ip</code> \u7684\u6620\u5c04\uff0c</p> <p>\u4f46\u662f\u662f\u6211\u4eec\u7684 <code>Metrics Server</code> \u7684 <code>Pod</code> \u5185\u90e8\u5e76\u6ca1\u6709\u8fd9\u4e2a <code>hosts</code> \u4fe1\u606f\uff0c\u5f53\u7136\u4e5f\u5c31\u4e0d\u8bc6\u522b <code>hostname</code> \u4e86\uff0c\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728\u96c6\u7fa4\u5185\u90e8\u7684 <code>DNS</code> \u670d\u52a1\u91cc\u9762\u6dfb\u52a0\u4e0a <code>hostname</code> \u7684\u89e3\u6790\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u96c6\u7fa4\u4e2d\u4f7f\u7528\u7684\u662f <code>CoreDNS</code>\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u53bb\u4fee\u6539\u4e0b <code>CoreDNS</code> \u7684 <code>Configmap</code> \u4fe1\u606f\uff0c\u6dfb\u52a0\u4e0a <code>hosts</code> \u4fe1\u606f\uff1a</p> <pre><code>$ kubectl edit configmap coredns -n kube-system\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health\n        hosts {  # \u6dfb\u52a0\u96c6\u7fa4\u8282\u70b9hosts\u9690\u5c04\u4fe1\u606f\n          10.151.30.11 jxi-master\n          10.151.30.57 jxi-node3\n          10.151.30.59 jxi-node4\n          10.151.30.22 jxi-node1\n          10.151.30.23 jxi-node2\n          fallthrough\n        }\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           upstream\n           fallthrough in-addr.arpa ip6.arpa\n        }\n        prometheus :9153\n        proxy . /etc/resolv.conf\n        cache 30\n        reload\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2019-05-18T11:07:46Z\n  name: coredns\n  namespace: kube-system\n</code></pre> <p>\u8fd9\u6837\u5f53\u5728\u96c6\u7fa4\u5185\u90e8\u8bbf\u95ee\u96c6\u7fa4\u7684 <code>hostname</code> \u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u89e3\u6790\u5230\u5bf9\u5e94\u7684 <code>ip</code> \u4e86\uff0c\u53e6\u5916\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728 <code>metrics-server</code> \u7684\u542f\u52a8\u53c2\u6570\u4e2d\u4fee\u6539 <code>kubelet-preferred-address-types</code> \u53c2\u6570\uff0c\u5982\u4e0b\uff1a</p> <pre><code>args:\n- --cert-dir=/tmp\n- --secure-port=4443\n- --kubelet-preferred-address-types=InternalIP\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u7136\u540e\u91cd\u65b0\u5b89\u88c5\uff1a</p> <pre><code>$ kubectl get pods -n kube-system -l app=metrics-server\nNAME                                     READY   STATUS    RESTARTS   AGE\nmetric-metrics-server-6d4d4f6dc4-c8hhl   1/1     Running   0          2d11h\n\n$ kubectl logs -f metric-metrics-server-58fc94d9f-jlxcb -n kube-system\n......\nE1119 09:05:57.234312       1 manager.go:111] unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:jxi-node1: unable to fetch metrics from Kubelet jxi-node1 (jxi-node1): Get https://jxi-node1:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-node1 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:jxi-node4: unable to fetch metrics from Kubelet jxi-node4 (jxi-node4): Get https://jxi-node4:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-node4 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:jxi-node3: unable to fetch metrics from Kubelet jxi-node3 (jxi-node3): Get https://jxi-node3:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-node3 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:jxi-master: unable to fetch metrics from Kubelet jxi-master (jxi-master): Get https://jxi-master:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-master on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:jxi-node2: unable to fetch metrics from Kubelet jxi-node2 (jxi-node2): Get https://jxi-node2:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup jxi-node2 on 10.96.0.10:53: no such host]\n</code></pre> <p>\u56e0\u4e3a\u90e8\u7f72\u96c6\u7fa4\u7684\u65f6\u5019\uff0c<code>CA</code> \u8bc1\u4e66\u5e76\u6ca1\u6709\u628a\u5404\u4e2a\u8282\u70b9\u7684 <code>IP</code> \u7b7e\u4e0a\u53bb\uff0c\u6240\u4ee5\u8fd9\u91cc <code>Metrics Server</code> \u901a\u8fc7 <code>IP</code> \u53bb\u8bf7\u6c42\u65f6\uff0c\u63d0\u793a\u7b7e\u7684\u8bc1\u4e66\u6ca1\u6709\u5bf9\u5e94\u7684 IP\uff08\u9519\u8bef\uff1ax509: cannot validate certificate for 10.151.30.22 because it doesn\u2019t contain any IP SANs\uff09\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a<code>--kubelet-insecure-tls</code>\u53c2\u6570\u8df3\u8fc7\u8bc1\u4e66\u6821\u9a8c\uff1a</p> <pre><code>args:\n- --cert-dir=/tmp\n- --secure-port=4443\n- --kubelet-insecure-tls\n- --kubelet-preferred-address-types=InternalIP\n</code></pre> <p>\u7136\u540e\u518d\u91cd\u65b0\u5b89\u88c5\u5373\u53ef\u6210\u529f\uff01\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u9a8c\u8bc1\uff1a</p> <pre><code>$ kubectl apply -f deploy/1.8+/\n$ kubectl get pods -n kube-system -l k8s-app=metrics-server\nNAME                              READY   STATUS    RESTARTS   AGE\nmetrics-server-5d4dbb78bb-6klw6   1/1     Running   0          14s\n$ kubectl logs -f metrics-server-5d4dbb78bb-6klw6 -n kube-system\nI1119 09:10:44.249092       1 serving.go:312] Generated self-signed cert (/tmp/apiserver.crt, /tmp/apiserver.key)\nI1119 09:10:45.264076       1 secure_serving.go:116] Serving securely on [::]:4443\n$ kubectl get apiservice | grep metrics\nv1beta1.metrics.k8s.io                 kube-system/metrics-server   True        9m\n$ kubectl get --raw \"/apis/metrics.k8s.io/v1beta1/nodes\"\n{\"kind\":\"NodeMetricsList\",\"apiVersion\":\"metrics.k8s.io/v1beta1\",\"metadata\":{\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes\"},\"items\":[{\"metadata\":{\"name\":\"jxi-node3\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/jxi-node3\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:38Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"240965441n\",\"memory\":\"3004360Ki\"}},{\"metadata\":{\"name\":\"jxi-node4\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/jxi-node4\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:37Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"167036681n\",\"memory\":\"2574664Ki\"}},{\"metadata\":{\"name\":\"jxi-master\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/jxi-master\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:38Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"350907350n\",\"memory\":\"2986716Ki\"}},{\"metadata\":{\"name\":\"jxi-node1\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/jxi-node1\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:39Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"1319638039n\",\"memory\":\"2094376Ki\"}},{\"metadata\":{\"name\":\"jxi-node2\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/jxi-node2\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:36Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"320381888n\",\"memory\":\"3270368Ki\"}}]}\n$ kubectl top nodes\nNAME          CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   \njxi-master   351m         17%    2916Mi          79%       \njxi-node1    1320m        33%    2045Mi          26%       \njxi-node2    321m         8%     3193Mi          41%       \njxi-node3    241m         6%     2933Mi          37%       \njxi-node4    168m         4%     2514Mi          32% \n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 kubectl top \u547d\u4ee4\u6765\u83b7\u53d6\u5230\u8d44\u6e90\u6570\u636e\u4e86\uff0c\u8bc1\u660e <code>Metrics Server</code> \u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002</p>"},{"location":"chap1/38k8s_hpa_metricsserver/#2-cpu","title":"2 \u57fa\u4e8e CPU","text":"<p>\u73b0\u5728\u6211\u4eec\u7528 <code>Deployment</code> \u6765\u521b\u5efa\u4e00\u4e2a <code>Nginx Pod</code>\uff0c\u7136\u540e\u5229\u7528 <code>HPA</code> \u6765\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u3002\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08<code>hpa-demo.yaml</code>\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa <code>Deployment</code>\uff1a</p> <pre><code>$ kubectl apply -f hpa-demo.yaml \ndeployment.apps/hpa-demo created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a HPA \u8d44\u6e90\u5bf9\u8c61\uff0c\u53ef\u4ee5\u4f7f\u7528<code>kubectl autoscale</code>\u547d\u4ee4\u6765\u521b\u5efa\uff1a</p> <pre><code>kubectl autoscale deployment hpa-demo --cpu-percent=10 --min=1 --max=10\nhorizontalpodautoscaler.autoscaling/hpa-demo autoscaled\n\n$ kubectl get hpa\nNAME       REFERENCE             TARGETS         MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   &lt;unknown&gt;/10%   1         10        0          12s\n</code></pre> <p>\u6b64\u547d\u4ee4\u521b\u5efa\u4e86\u4e00\u4e2a\u5173\u8054\u8d44\u6e90 <code>hpa-demo</code> \u7684 <code>HPA</code>\uff0c\u6700\u5c0f\u7684 Pod \u526f\u672c\u6570\u4e3a<code>1</code>\uff0c\u6700\u5927\u4e3a<code>10</code>\u3002HPA \u4f1a\u6839\u636e\u8bbe\u5b9a\u7684 <code>cpu</code> \u4f7f\u7528\u7387\uff08<code>10%</code>\uff09\u52a8\u6001\u7684\u589e\u52a0\u6216\u8005\u51cf\u5c11 Pod \u6570\u91cf\u3002</p> <p>\u5f53\u7136\u6211\u4eec\u4f9d\u7136\u8fd8\u662f\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa YAML \u6587\u4ef6\u7684\u5f62\u5f0f\u6765\u521b\u5efa HPA \u8d44\u6e90\u5bf9\u8c61\u3002\u5982\u679c\u6211\u4eec\u4e0d\u77e5\u9053\u600e\u4e48\u7f16\u5199\u7684\u8bdd\uff0c\u53ef\u4ee5\u67e5\u770b\u4e0a\u9762\u547d\u4ee4\u884c\u521b\u5efa\u7684HPA\u7684YAML\u6587\u4ef6\uff1a</p> <pre><code>$  kubectl get hpa hpa-demo -o yaml\n\napiVersion: autoscaling/v1\nkind: HorizontalPodAutoscaler\nmetadata:\n  annotations:\n    autoscaling.alpha.kubernetes.io/conditions: '[{\"type\":\"AbleToScale\",\"status\":\"True\",\"lastTransitionTime\":\"2020-04-07T15:38:07Z\",\"reason\":\n\"SucceededGetScale\",\"message\":\"the\n      HPA controller was able to get the target''s current scale\"},{\"type\":\"ScalingActive\",\"status\":\"False\",\"lastTransitionTime\":\"2020-04-07T\n15:38:07Z\",\"reason\":\"FailedGetResourceMetric\",\"message\":\"the\n      HPA was unable to compute the replica count: missing request for cpu\"}]'\n  creationTimestamp: \"2020-04-07T15:37:52Z\"\n  name: hpa-demo\n  namespace: default\n  resourceVersion: \"2321037\"\n  selfLink: /apis/autoscaling/v1/namespaces/default/horizontalpodautoscalers/hpa-demo\n  uid: d24084ba-f050-41d3-a524-51fa1ed76d78\nspec:\n  maxReplicas: 10\n  minReplicas: 1\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: hpa-demo\n  targetCPUUtilizationPercentage: 10\nstatus:\n  currentReplicas: 1\n  desiredReplicas: 0\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u5c31\u53ef\u4ee5\u81ea\u5df1\u6765\u521b\u5efa\u4e00\u4e2a\u57fa\u4e8e YAML \u7684 HPA \u63cf\u8ff0\u6587\u4ef6\u4e86\u3002\u4f46\u662f\u6211\u4eec\u53d1\u73b0\u4e0a\u9762\u4fe1\u606f\u91cc\u9762\u51fa\u73b0\u4e86\u4e00\u4e9b Fail \u4fe1\u606f\uff0c\u6211\u4eec\u6765\u67e5\u770b\u4e0b\u8fd9\u4e2a HPA \u5bf9\u8c61\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Tue, 07 Apr 2020 23:37:52 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  &lt;unknown&gt; / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       1 current / 0 desired\nConditions:\n  Type           Status  Reason                   Message\n  ----           ------  ------                   -------\n  AbleToScale    True    SucceededGetScale        the HPA controller was able to get the target's current scale\n  ScalingActive  False   FailedGetResourceMetric  the HPA was unable to compute the replica count: missing request for cpu\nEvents:\n  Type     Reason                        Age                   From                       Message\n  ----     ------                        ----                  ----                       -------\n  Warning  FailedComputeMetricsReplicas  36s (x12 over 3m21s)  horizontal-pod-autoscaler  invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: missing request for cpu\n  Warning  FailedGetResourceMetric       21s (x13 over 3m21s)  horizontal-pod-autoscaler  missing request for cpu\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u4e8b\u4ef6\u4fe1\u606f\u91cc\u9762\u51fa\u73b0\u4e86 <code>failed to get cpu utilization: missing request for cpu</code> \u8fd9\u6837\u7684\u9519\u8bef\u4fe1\u606f\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u7684 <code>Pod</code> \u5bf9\u8c61\u6ca1\u6709\u6dfb\u52a0 <code>request</code>\u8d44\u6e90\u58f0\u660e\uff0c\u8fd9\u6837\u5bfc\u81f4 HPA \u8bfb\u53d6\u4e0d\u5230 <code>CPU</code> \u6307\u6807\u4fe1\u606f\uff0c\u6240\u4ee5\u5982\u679c\u8981\u60f3\u8ba9 <code>HPA</code> \u751f\u6548\uff0c\u5bf9\u5e94\u7684 <code>Pod \u8d44\u6e90\u5fc5\u987b\u6dfb\u52a0</code>requests` \u8d44\u6e90\u58f0\u660e\uff0c\u66f4\u65b0\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n        resources:\n          requests:\n            memory: 50Mi\n            cpu: 50m\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u66f4\u65b0 Deployment\uff0c\u91cd\u65b0\u521b\u5efa HPA \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f hpa-demo.yaml \ndeployment.apps/hpa-demo configured\n\n\n$ kubectl get pods -o wide -l app=nginx\nNAME                        READY   STATUS        RESTARTS   AGE   IP          NODE             NOMINATED NODE   READINESS GATES\nhpa-demo-75f94c5d7-ncg5f    1/1     Running       0          16s   10.1.5.71   docker-desktop   &lt;none&gt;           &lt;none&gt;\nhpa-demo-85ff79dd56-mc7mq   0/1     Terminating   0          34m   10.1.5.70   docker-desktop   &lt;none&gt;           &lt;none&gt;\n\n\n$ kubectl delete hpa hpa-demo\nhorizontalpodautoscaler.autoscaling \"hpa-demo\" deleted\n\n$ kubectl autoscale deployment hpa-demo --cpu-percent=10 --min=1 --max=10\nhorizontalpodautoscaler.autoscaling/hpa-demo autoscaled\n\n$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Wed, 08 Apr 2020 09:33:15 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  0% (0) / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       1 current / 1 desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)\n  ScalingLimited  False   DesiredWithinRange   the desired count is within the acceptable range\nEvents:           &lt;none&gt;\n\n$ kubectl get hpa             \nNAME       REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   0%/10%    1         10        1          91s\n</code></pre> <p>\u73b0\u5728\u53ef\u4ee5\u770b\u5230 HPA \u8d44\u6e90\u5bf9\u8c61\u5df2\u7ecf\u6b63\u5e38\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u6765\u589e\u5927\u8d1f\u8f7d\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a busybox \u7684 Pod\uff0c\u5e76\u4e14\u5faa\u73af\u8bbf\u95ee\u4e0a\u9762\u521b\u5efa\u7684 Pod\uff1a</p> <pre><code>$ kubectl get pod -l app=nginx -o wide\nNAME                        READY   STATUS    RESTARTS   AGE     IP          NODE             NOMINATED NODE   READINESS GATES\nhpa-demo-69968bb59f-dxjd7   1/1     Running   0          7m16s   10.1.5.75   docker-desktop   &lt;none&gt;           &lt;none&gt;\n\n\nkubectl run -it --image busybox test-hpa --restart=Never --rm /bin/sh\nIf you don't see a command prompt, try pressing enter.\n/ # while true; do wget -q -O- http://10.1.5.75; done\n</code></pre> <pre><code>$ kubectl get hpa\nNAME       REFERENCE             TARGETS    MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   264%/10%   1         10        8          7m36s\n\n]$ kubectl get pods -l app=nginx --watch \nNAME                        READY   STATUS              RESTARTS   AGE\nhpa-demo-69968bb59f-4624m   1/1     Running             0          41s\nhpa-demo-69968bb59f-4h6lh   1/1     Running             0          11s\nhpa-demo-69968bb59f-7dw9d   1/1     Running             0          26s\nhpa-demo-69968bb59f-dxjd7   1/1     Running             0          10m\nhpa-demo-69968bb59f-ggmgw   1/1     Running             0          41s\nhpa-demo-69968bb59f-nnsm7   1/1     Running             0          26s\nhpa-demo-69968bb59f-np6fc   1/1     Running             0          26s\nhpa-demo-69968bb59f-tkbzb   1/1     Running             0          41s\nhpa-demo-69968bb59f-x8x9r   1/1     Running             0          26s\nhpa-demo-69968bb59f-zcnp7   0/1     ContainerCreating   0          11s\nhpa-demo-69968bb59f-zcnp7   1/1     Running             0          13s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u81ea\u52a8\u62c9\u8d77\u4e86\u5f88\u591a\u65b0\u7684 Pod\uff0c\u6700\u540e\u5b9a\u683c\u5728\u4e86\u6211\u4eec\u4e0a\u9762\u8bbe\u7f6e\u7684 10 \u4e2a Pod\uff0c\u540c\u65f6\u67e5\u770b\u8d44\u6e90 hpa-demo \u7684\u526f\u672c\u6570\u91cf\uff0c\u526f\u672c\u6570\u91cf\u5df2\u7ecf\u4ece\u539f\u6765\u76841\u53d8\u6210\u4e8610\u4e2a\uff1a</p> <pre><code>$ kubectl get deployment hpa-demo\nNAME       READY   UP-TO-DATE   AVAILABLE   AGE\nhpa-demo   10/10   10           10          20m\n</code></pre> <p>\u67e5\u770b HPA \u8d44\u6e90\u7684\u5bf9\u8c61\u4e86\u89e3\u5de5\u4f5c\u8fc7\u7a0b\uff1a</p> <pre><code>$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Wed, 08 Apr 2020 09:33:15 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  10% (5m) / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       10 current / 10 desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)\n  ScalingLimited  True    TooManyReplicas      the desired replica count is more than the maximum replica count\nEvents:\n  Type    Reason             Age   From                       Message\n  ----    ------             ----  ----                       -------\n  Normal  SuccessfulRescale  89s   horizontal-pod-autoscaler  New size: 4; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  74s   horizontal-pod-autoscaler  New size: 8; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  59s   horizontal-pod-autoscaler  New size: 10; reason: cpu resource utilization (percentage of request) above target\n</code></pre> <p>\u540c\u6837\u7684\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6765\u5173\u6389 busybox \u6765\u51cf\u5c11\u8d1f\u8f7d\uff0c\u7136\u540e\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4\u89c2\u5bdf\u4e0b HPA \u548c Deployment \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get hpa\nNAME       REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   0%/10%    1         10        1          14m\n$ kubectl get deployment hpa-demo\nNAME       READY   UP-TO-DATE   AVAILABLE   AGE\nhpa-demo   1/1     1            1           24m\n</code></pre> <p>\u4ece <code>Kubernetes v1.12</code> \u7248\u672c\u5f00\u59cb\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>kube-controller-manager</code> \u7ec4\u4ef6\u7684<code>--horizontal-pod-autoscaler-downscale-stabilization</code>\u53c2\u6570\u6765\u8bbe\u7f6e\u4e00\u4e2a\u6301\u7eed\u65f6\u95f4\uff0c\u7528\u4e8e\u6307\u5b9a\u5728\u5f53\u524d\u64cd\u4f5c\u5b8c\u6210\u540e\uff0c<code>HPA</code> \u5fc5\u987b\u7b49\u5f85\u591a\u957f\u65f6\u95f4\u624d\u80fd\u6267\u884c\u53e6\u4e00\u6b21\u7f29\u653e\u64cd\u4f5c\u3002\u9ed8\u8ba4\u4e3a<code>5</code>\u5206\u949f\uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u9700\u8981\u7b49\u5f855\u5206\u949f\u540e\u624d\u4f1a\u5f00\u59cb\u81ea\u52a8\u7f29\u653e\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\u526f\u672c\u6570\u91cf\u5df2\u7ecf\u7531 10 \u53d8\u4e3a 1\uff0c\u5f53\u524d\u6211\u4eec\u53ea\u662f\u6f14\u793a\u4e86 CPU \u4f7f\u7528\u7387\u8fd9\u4e00\u4e2a\u6307\u6807\uff0c\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u8fd8\u4f1a\u5b66\u4e60\u5230\u6839\u636e\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u6307\u6807\u6765\u81ea\u52a8\u5bf9 Pod \u8fdb\u884c\u6269\u7f29\u5bb9\u3002</p> <pre><code>$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Wed, 08 Apr 2020 09:33:15 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  0% (0) / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       1 current / 1 desired\nConditions:\n  Type            Status  Reason            Message\n  ----            ------  ------            -------\n  AbleToScale     True    ReadyForNewScale  recommended size matches current size\n  ScalingActive   True    ValidMetricFound  the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)\n  ScalingLimited  True    TooFewReplicas    the desired replica count is less than the minimum replica count\nEvents:\n  Type    Reason             Age    From                       Message\n  ----    ------             ----   ----                       -------\n  Normal  SuccessfulRescale  11m    horizontal-pod-autoscaler  New size: 4; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  11m    horizontal-pod-autoscaler  New size: 8; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  10m    horizontal-pod-autoscaler  New size: 10; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  4m23s  horizontal-pod-autoscaler  New size: 1; reason: All metrics below target\n[Jacob@i515190:~/Devops_sap/k8s_cka/CKAD]$ kubectl describe hpa hpa-demo\n</code></pre>"},{"location":"chap1/38k8s_hpa_metricsserver/#3","title":"3 \u57fa\u4e8e\u5185\u5b58","text":"<p><code>HorizontalPodAutoscaler</code> \u662f <code>Kubernetes autoscaling API</code> \u7ec4\u7684\u8d44\u6e90\uff0c\u5728\u5f53\u524d\u7a33\u5b9a\u7248\u672c <code>autoscaling/v1</code> \u4e2d\u53ea\u652f\u6301\u57fa\u4e8e <code>CPU</code>\u6307\u6807\u7684\u7f29\u653e\u3002</p> <p>\u5728 <code>Beta</code> \u7248\u672c<code>autoscaling/v2beta2</code>\uff0c\u5f15\u5165\u4e86\u57fa\u4e8e\u5185\u5b58\u548c\u81ea\u5b9a\u4e49\u6307\u6807\u7684\u7f29\u653e\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u4f7f\u7528 <code>Beta</code> \u7248\u672c\u7684 <code>API</code>\u3002</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u7528 Deployment \u6765\u521b\u5efa\u4e00\u4e2a Nginx Pod\uff0c\u7136\u540e\u5229\u7528 HPA \u6765\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u3002\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08<code>hpa-mem-demo.yaml</code>\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-mem-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      volumes:\n      - name: increase-mem-script\n        configMap:\n          name: increase-mem-config\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n        volumeMounts:\n        - name: increase-mem-script\n          mountPath: /etc/script\n        resources:\n          requests:\n            memory: 50Mi\n            cpu: 50m\n        securityContext:\n          privileged: true\n</code></pre> <p>\u8fd9\u91cc\u548c\u524d\u9762\u666e\u901a\u7684\u5e94\u7528\u6709\u4e00\u4e9b\u533a\u522b\uff0c\u6211\u4eec\u5c06\u4e00\u4e2a\u540d\u4e3a <code>increase-mem-config</code> \u7684 <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\u6302\u8f7d\u5230\u4e86\u5bb9\u5668\u4e2d\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u662f\u7528\u4e8e\u540e\u9762\u589e\u52a0\u5bb9\u5668\u5185\u5b58\u5360\u7528\u7684\u811a\u672c\uff0c\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\uff08<code>increase-mem-cm.yaml</code>\uff09</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: increase-mem-config\ndata:\n  increase-mem.sh: |\n    #!/bin/bash  \n    mkdir /tmp/memory  \n    mount -t tmpfs -o size=40M tmpfs /tmp/memory  \n    dd if=/dev/zero of=/tmp/memory/block  \n    sleep 60 \n    rm /tmp/memory/block  \n    umount /tmp/memory  \n    rmdir /tmp/memory\n</code></pre> <pre><code>$ kubectl apply -f increase-mem-cm.yaml\n$ kubectl apply -f hpa-mem-demo.yaml \n$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nhpa-mem-demo-66944b79bf-696r8   1/1     Running   0          19s\n</code></pre> <p>\u7136\u540e\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u57fa\u4e8e\u5185\u5b58\u7684 <code>HPA</code> \u8d44\u6e90\u5bf9\u8c61\uff1a\uff08<code>hpa-mem.yaml</code>\uff09</p> <pre><code>apiVersion: autoscaling/v2beta1\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: nginx-hpa\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: hpa-mem-demo\n  minReplicas: 1\n  maxReplicas: 5\n  metrics:\n  - type: Resource\n    resource:\n      name: memory\n      targetAverageUtilization: 60\n</code></pre> <pre><code>$ kubectl apply -f hpa-mem.yaml \nhorizontalpodautoscaler.autoscaling/nginx-hpa created\n\n$ kubectl get hpa\nNAME        REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo    Deployment/hpa-demo       0%/10%    1         10        1          22m\nnginx-hpa   Deployment/hpa-mem-demo   4%/60%    1         5         1          15s\n</code></pre> <p>\u5230\u8fd9\u91cc\u8bc1\u660e HPA \u8d44\u6e90\u5bf9\u8c61\u5df2\u7ecf\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5bf9\u5e94\u7528\u8fdb\u884c\u538b\u6d4b\uff0c\u5c06\u5185\u5b58\u538b\u4e0a\u53bb\uff0c\u76f4\u63a5\u6267\u884c\u4e0a\u9762\u6211\u4eec\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u7684 <code>increase-mem.sh</code> \u811a\u672c\u5373\u53ef\uff1a</p> <pre><code>$  kubectl exec -it hpa-mem-demo-66944b79bf-696r8 /bin/bash\nroot@hpa-mem-demo-66944b79bf-696r8:/# ls /etc/script/\nincrease-mem.sh\nroot@hpa-mem-demo-66944b79bf-696r8:/# increase-mem.sh\nbash: increase-mem.sh: command not found\nroot@hpa-mem-demo-66944b79bf-696r8:/# source /etc/script/increase-mem.sh \ndd: writing to '/tmp/memory/block': No space left on device\n81921+0 records in\n81920+0 records out\n41943040 bytes (42 MB, 40 MiB) copied, 0.14645 s, 286 MB/s\n</code></pre> <p>\u7136\u540e\u6253\u5f00\u53e6\u5916\u4e00\u4e2a\u7ec8\u7aef\u89c2\u5bdf HPA \u8d44\u6e90\u5bf9\u8c61\u7684\u53d8\u5316\u60c5\u51b5\uff1a</p> <pre><code>$ kubectl get hpa\nNAME        REFERENCE                 TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nnginx-hpa   Deployment/hpa-mem-demo   44%/60%   1         5         2          2m45s\n</code></pre> <pre><code>$ kubectl describe hpa nginx-hpa\nName:                                                     nginx-hpa\nNamespace:                                                default\nLabels:                                                   &lt;none&gt;\nAnnotations:                                              kubectl.kubernetes.io/last-applied-configuration:\n                                                            {\"apiVersion\":\"autoscaling/v2beta1\",\"kind\":\"HorizontalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-hpa\",\"namespace\":\"default\"...\nCreationTimestamp:                                        Wed, 08 Apr 2020 09:55:46 +0800\nReference:                                                Deployment/hpa-mem-demo\nMetrics:                                                  ( current / target )\n  resource memory on pods  (as a percentage of request):  44% (23568384) / 60%\nMin replicas:                                             1\nMax replicas:                                             5\nDeployment pods:                                          2 current / 2 desired\nConditions:\n  Type            Status  Reason              Message\n  ----            ------  ------              -------\n  AbleToScale     True    ReadyForNewScale    recommended size matches current size\n  ScalingActive   True    ValidMetricFound    the HPA was able to successfully calculate a replica count from memory resource utilization (percentage of request)\n  ScalingLimited  False   DesiredWithinRange  the desired count is within the acceptable range\nEvents:\n  Type    Reason             Age   From                       Message\n  ----    ------             ----  ----                       -------\n  Normal  SuccessfulRescale  47s   horizontal-pod-autoscaler  New size: 2; reason: memory resource utilization (percentage of request) above target\n\n$ kubectl top pod  hpa-mem-demo-66944b79bf-f79l2\nNAME                            CPU(cores)   MEMORY(bytes)   \nhpa-mem-demo-66944b79bf-tqrn9   0m           41Mi\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5185\u5b58\u4f7f\u7528\u5df2\u7ecf\u8d85\u8fc7\u4e86\u6211\u4eec\u8bbe\u5b9a\u7684 60% \u8fd9\u4e2a\u9608\u503c\u4e86\uff0cHPA \u8d44\u6e90\u5bf9\u8c61\u4e5f\u5df2\u7ecf\u89e6\u53d1\u4e86\u81ea\u52a8\u6269\u5bb9\uff0c\u53d8\u6210\u4e86\u4e24\u4e2a\u526f\u672c\u4e86\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nhpa-mem-demo-66944b79bf-696r8   1/1     Running   0          9m39s\nhpa-mem-demo-66944b79bf-f79l2   1/1     Running   0          5m47s\n</code></pre> <p>\u5f53\u5185\u5b58\u91ca\u653e\u6389\u540e\uff0c<code>controller-manager</code> \u9ed8\u8ba45\u5206\u949f\u8fc7\u540e\u4f1a\u8fdb\u884c\u7f29\u653e\uff0c\u5230\u8fd9\u91cc\u5c31\u5b8c\u6210\u4e86\u57fa\u4e8e\u5185\u5b58\u7684 <code>HPA</code>\u64cd\u4f5c\u3002</p>"},{"location":"chap1/38k8s_hpa_metricsserver/#4","title":"4 \u57fa\u4e8e\u81ea\u5b9a\u4e49\u6307\u6807","text":"<p>\u9664\u4e86\u57fa\u4e8e <code>CPU</code> \u548c\u5185\u5b58\u6765\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6839\u636e\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u6307\u6807\u6765\u8fdb\u884c\u3002</p> <p>\u8fd9\u4e2a\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528 <code>Prometheus Adapter</code>\uff0c<code>Prometheus</code> \u7528\u4e8e\u76d1\u63a7\u5e94\u7528\u7684\u8d1f\u8f7d\u548c\u96c6\u7fa4\u672c\u8eab\u7684\u5404\u79cd\u6307\u6807\uff0c<code>Prometheus Adapter</code> \u53ef\u4ee5\u5e2e\u6211\u4eec\u4f7f\u7528 <code>Prometheus</code> \u6536\u96c6\u7684\u6307\u6807\u5e76\u4f7f\u7528\u5b83\u4eec\u6765\u5236\u5b9a\u6269\u5c55\u7b56\u7565\uff0c\u8fd9\u4e9b\u6307\u6807\u90fd\u662f\u901a\u8fc7 <code>APIServer</code> \u66b4\u9732\u7684\uff0c\u800c\u4e14 <code>HPA</code> \u8d44\u6e90\u5bf9\u8c61\u4e5f\u53ef\u4ee5\u5f88\u8f7b\u6613\u7684\u76f4\u63a5\u4f7f\u7528</p> <p></p> <p>\u9996\u5148\uff0c\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u793a\u4f8b\u5e94\u7528\uff0c\u5728\u8be5\u5e94\u7528\u7a0b\u5e8f\u4e0a\u6d4b\u8bd5 Prometheus \u6307\u6807\u81ea\u52a8\u7f29\u653e\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\uff08<code>hpa-prome-demo.yaml</code>\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-prom-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx-server\n  template:\n    metadata:\n      labels:\n        app: nginx-server\n    spec:\n      containers:\n      - name: nginx-demo\n        image: cnych/nginx-vts:v1.0\n        resources:\n          limits:\n            cpu: 50m\n          requests:\n            cpu: 50m\n        ports:\n        - containerPort: 80\n          name: http\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: hpa-prom-demo\n  annotations:\n    prometheus.io/scrape: \"true\"\n    prometheus.io/port: \"80\"\n    prometheus.io/path: \"/status/format/prometheus\"\nspec:\n  ports:\n  - port: 80\n    targetPort: 80\n    name: http\n  selector:\n    app: nginx-server\n  type: NodePort\n</code></pre> <pre><code>$ kubectl apply -f hpa-prome-demo.yaml\ndeployment.apps/hpa-prom-demo created\nservice/hpa-prom-demo created\n</code></pre> <pre><code>$  kubectl get pods -l app=nginx-server \nNAME                            READY   STATUS    RESTARTS   AGE\nhpa-prom-demo-cddb7b67f-97pqf   1/1     Running   0          95s\n\n$ kubectl get svc \nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nhpa-prom-demo   NodePort    10.104.168.230   &lt;none&gt;        80:30339/TCP   109s\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u6d4b\u8bd5\u5e94\u7528\u662f\u5426\u6b63\u5e38\uff0c\u4ee5\u53ca\u6307\u6807\u6570\u636e\u63a5\u53e3\u80fd\u591f\u6b63\u5e38\u83b7\u53d6\uff1a</p> <pre><code>$ curl localhost:30339\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <pre><code>$ curl http://localhost:30339/status/format/prometheus \n# HELP nginx_vts_info Nginx info\n# TYPE nginx_vts_info gauge\nnginx_vts_info{hostname=\"hpa-prom-demo-cddb7b67f-97pqf\",version=\"1.13.12\"} 1\n# HELP nginx_vts_start_time_seconds Nginx start time\n# TYPE nginx_vts_start_time_seconds gauge\nnginx_vts_start_time_seconds 1586312884.322\n# HELP nginx_vts_main_connections Nginx connections\n# TYPE nginx_vts_main_connections gauge\nnginx_vts_main_connections{status=\"accepted\"} 4\nnginx_vts_main_connections{status=\"active\"} 2\nnginx_vts_main_connections{status=\"handled\"} 4\nnginx_vts_main_connections{status=\"reading\"} 0\nnginx_vts_main_connections{status=\"requests\"} 129\nnginx_vts_main_connections{status=\"waiting\"} 1\nnginx_vts_main_connections{status=\"writing\"} 1\n# HELP nginx_vts_main_shm_usage_bytes Shared memory [ngx_http_vhost_traffic_status] info\n# TYPE nginx_vts_main_shm_usage_bytes gauge\nnginx_vts_main_shm_usage_bytes{shared=\"max_size\"} 1048575\n...\n</code></pre> <p>\u4e0a\u9762\u7684\u6307\u6807\u6570\u636e\u4e2d\uff0c\u6211\u4eec\u6bd4\u8f83\u5173\u5fc3\u7684\u662f <code>nginx_vts_server_requests_total</code> \u8fd9\u4e2a\u6307\u6807\uff0c\u8868\u793a\u8bf7\u6c42\u603b\u6570\uff0c\u662f\u4e00\u4e2a <code>Counter</code> \u7c7b\u578b\u7684\u6307\u6807\uff0c\u6211\u4eec\u5c06\u4f7f\u7528\u8be5\u6307\u6807\u7684\u503c\u6765\u786e\u5b9a\u662f\u5426\u9700\u8981\u5bf9\u6211\u4eec\u7684\u5e94\u7528\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u3002</p> <pre><code>code prometheus-additional.yaml\nkubectl create secret generic additional-configs --from-file=prometheus-additional.yaml -n monitoring\nsecret/additional-configs created\n\n$ kubectl get prometheus -n monitoring \nNAME                                    VERSION   REPLICAS   AGE\nkube-prom-prometheus-opera-prometheus   v2.15.2   1          17d\n\nkubectl edit prometheus kube-prom-prometheus-opera-prometheus -n monitoring\n...\nsecurityContext:\n    fsGroup: 2000\n    runAsNonRoot: true\n    runAsUser: 1000\n  additionalScrapeConfigs:\n    name: additional-configs\n    key: prometheus-additional.yaml\n  serviceAccountName: prometheus-k8s\n...\n</code></pre> <pre><code>kubectl port-forward svc/prometheus-operated 9090:9090 -n monitoring\n</code></pre> <p></p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06 <code>Prometheus-Adapter</code> \u5b89\u88c5\u5230\u96c6\u7fa4\u4e2d\uff0c\u5e76\u6dfb\u52a0\u4e00\u4e2a\u89c4\u5219\u6765\u8ddf\u8e2a Pod \u7684\u8bf7\u6c42\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06 <code>Prometheus</code> \u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u6307\u6807\u90fd\u7528\u4e8e <code>HPA</code>\uff0c\u4f46\u662f\u524d\u63d0\u662f\u4f60\u5f97\u901a\u8fc7\u67e5\u8be2\u8bed\u53e5\u5c06\u5b83\u62ff\u5230\uff08\u5305\u62ec\u6307\u6807\u540d\u79f0\u548c\u5176\u5bf9\u5e94\u7684\u503c\uff09\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u89c4\u5219\uff1a</p> <pre><code>rules:\n- seriesQuery: 'nginx_vts_server_requests_total'\n  seriesFilters: []\n  resources:\n    overrides:\n      kubernetes_namespace:\n        resource: namespace\n      kubernetes_pod_name:\n        resource: pod\n  name:\n    matches: \"^(.*)_total\"\n    as: \"${1}_per_second\"\n  metricsQuery: (sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[1m])) by (&lt;&lt;.GroupBy&gt;&gt;))\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06 <code>Prometheus-Adapter</code>\u5b89\u88c5\u5230\u96c6\u7fa4\u4e2d\uff0c\u5e76\u6dfb\u52a0\u4e00\u4e2a\u89c4\u5219\u6765\u8ddf\u8e2a <code>Pod</code> \u7684\u8bf7\u6c42\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06 <code>Prometheus</code> \u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u6307\u6807\u90fd\u7528\u4e8e HPA\uff0c\u4f46\u662f\u524d\u63d0\u662f\u4f60\u5f97\u901a\u8fc7\u67e5\u8be2\u8bed\u53e5\u5c06\u5b83\u62ff\u5230\uff08\u5305\u62ec\u6307\u6807\u540d\u79f0\u548c\u5176\u5bf9\u5e94\u7684\u503c\uff09\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u89c4\u5219\uff1a</p> <pre><code>rules:\n- seriesQuery: 'nginx_vts_server_requests_total'\n  seriesFilters: []\n  resources:\n    overrides:\n      kubernetes_namespace:\n        resource: namespace\n      kubernetes_pod_name:\n        resource: pod\n  name:\n    matches: \"^(.*)_total\"\n    as: \"${1}_per_second\"\n  metricsQuery: (sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[1m])) by (&lt;&lt;.GroupBy&gt;&gt;))\n</code></pre> <p>\u8fd9\u662f\u4e00\u4e2a\u5e26\u53c2\u6570\u7684 Prometheus \u67e5\u8be2\uff0c\u5176\u4e2d\uff1a</p> <ul> <li><code>seriesQuery</code>\uff1a\u67e5\u8be2 <code>Prometheus</code> \u7684\u8bed\u53e5\uff0c\u901a\u8fc7\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u67e5\u8be2\u5230\u7684\u6240\u6709\u6307\u6807\u90fd\u53ef\u4ee5\u7528\u4e8e <code>HPA</code></li> <li><code>seriesFilters</code>\uff1a\u67e5\u8be2\u5230\u7684\u6307\u6807\u53ef\u80fd\u4f1a\u5b58\u5728\u4e0d\u9700\u8981\u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b83\u8fc7\u6ee4\u6389\u3002</li> <li><code>resources</code>\uff1a\u901a\u8fc7 <code>seriesQuery</code> \u67e5\u8be2\u5230\u7684\u53ea\u662f\u6307\u6807\uff0c\u5982\u679c\u9700\u8981\u67e5\u8be2\u67d0\u4e2a <code>Pod</code> \u7684\u6307\u6807\uff0c\u80af\u5b9a\u8981\u5c06\u5b83\u7684\u540d\u79f0\u548c\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u4f5c\u4e3a\u6307\u6807\u7684\u6807\u7b7e\u8fdb\u884c\u67e5\u8be2\uff0c<code>resources</code> \u5c31\u662f\u5c06\u6307\u6807\u7684\u6807\u7b7e\u548c <code>k8s</code> \u7684\u8d44\u6e90\u7c7b\u578b\u5173\u8054\u8d77\u6765\uff0c\u6700\u5e38\u7528\u7684\u5c31\u662f <code>pod</code> \u548c<code>namespace</code>\u3002\u6709\u4e24\u79cd\u6dfb\u52a0\u6807\u7b7e\u7684\u65b9\u5f0f\uff0c\u4e00\u79cd\u662f <code>overrides</code>\uff0c\u53e6\u4e00\u79cd\u662f <code>template</code>\u3002<ul> <li><code>overrides</code>\uff1a\u5b83\u4f1a\u5c06\u6307\u6807\u4e2d\u7684\u6807\u7b7e\u548c <code>k8s</code> \u8d44\u6e90\u5173\u8054\u8d77\u6765\u3002\u4e0a\u9762\u793a\u4f8b\u4e2d\u5c31\u662f\u5c06\u6307\u6807\u4e2d\u7684 <code>pod</code> \u548c <code>namespace</code> \u6807\u7b7e\u548c<code>k8s</code> \u4e2d\u7684 <code>pod</code> \u548c <code>namespace</code> \u5173\u8054\u8d77\u6765\uff0c\u56e0\u4e3a <code>pod</code> \u548c <code>namespace</code> \u90fd\u5c5e\u4e8e\u6838\u5fc3 <code>api</code> \u7ec4\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u6307\u5b9a <code>api</code> \u7ec4\u3002\u5f53\u6211\u4eec\u67e5\u8be2\u67d0\u4e2a <code>pod</code> \u7684\u6307\u6807\u65f6\uff0c\u5b83\u4f1a\u81ea\u52a8\u5c06 <code>pod</code> \u7684\u540d\u79f0\u548c\u540d\u79f0\u7a7a\u95f4\u4f5c\u4e3a\u6807\u7b7e\u52a0\u5165\u5230\u67e5\u8be2\u6761\u4ef6\u4e2d\u3002\u6bd4\u5982<code>nginx: {group: \"apps\", resource: \"deployment\"}</code>\u8fd9\u4e48\u5199\u8868\u793a\u7684\u5c31\u662f\u5c06\u6307\u6807\u4e2d <code>nginx</code> \u8fd9\u4e2a\u6807\u7b7e\u548c <code>apps</code> \u8fd9\u4e2a <code>api</code> \u7ec4\u4e2d\u7684 <code>deployment</code> \u8d44\u6e90\u5173\u8054\u8d77\u6765\uff1b</li> <li><code>template</code>\uff1a\u901a\u8fc7 <code>go</code> \u6a21\u677f\u7684\u5f62\u5f0f\u3002\u6bd4\u5982<code>template: \"kube_&lt;&lt;.Group&gt;&gt;_&lt;&lt;.Resource&gt;&gt;\"</code> \u8fd9\u4e48\u5199\u8868\u793a\uff0c\u5047\u5982 <code>&lt;&lt;.Group&gt;&gt;</code> \u4e3a <code>apps\uff0c&lt;&lt;.Resource&gt;&gt;</code> \u4e3a <code>deployment</code>\uff0c\u90a3\u4e48\u5b83\u5c31\u662f\u5c06\u6307\u6807\u4e2d <code>kube_apps_deployment</code> \u6807\u7b7e\u548c <code>deployment</code> \u8d44\u6e90\u5173\u8054\u8d77\u6765\u3002</li> </ul> </li> <li><code>name</code>\uff1a\u7528\u6765\u7ed9\u6307\u6807\u91cd\u547d\u540d\u7684\uff0c\u4e4b\u6240\u4ee5\u8981\u7ed9\u6307\u6807\u91cd\u547d\u540d\u662f\u56e0\u4e3a\u6709\u4e9b\u6307\u6807\u662f\u53ea\u589e\u7684\uff0c\u6bd4\u5982\u4ee5 <code>total</code> \u7ed3\u5c3e\u7684\u6307\u6807\u3002\u8fd9\u4e9b\u6307\u6807\u62ff\u6765\u505a <code>HPA</code> \u662f\u6ca1\u6709\u610f\u4e49\u7684\uff0c\u6211\u4eec\u4e00\u822c\u8ba1\u7b97\u5b83\u7684\u901f\u7387\uff0c\u4ee5\u901f\u7387\u4f5c\u4e3a\u503c\uff0c\u90a3\u4e48\u6b64\u65f6\u7684\u540d\u79f0\u5c31\u4e0d\u80fd\u4ee5 <code>total</code> \u7ed3\u5c3e\u4e86\uff0c\u6240\u4ee5\u8981\u8fdb\u884c\u91cd\u547d\u540d\u3002<ul> <li><code>matches</code>\uff1a\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f\u6765\u5339\u914d\u6307\u6807\u540d\uff0c\u53ef\u4ee5\u8fdb\u884c\u5206\u7ec4</li> <li><code>as</code>\uff1a\u9ed8\u8ba4\u503c\u4e3a <code>$1</code>\uff0c\u4e5f\u5c31\u662f\u7b2c\u4e00\u4e2a\u5206\u7ec4\u3002<code>as</code> \u4e3a\u7a7a\u5c31\u662f\u4f7f\u7528\u9ed8\u8ba4\u503c\u7684\u610f\u601d\u3002</li> </ul> </li> <li><code>metricsQuery</code>\uff1a\u8fd9\u5c31\u662f <code>Prometheus</code>\u7684\u67e5\u8be2\u8bed\u53e5\u4e86\uff0c\u524d\u9762\u7684 <code>seriesQuery</code> \u67e5\u8be2\u662f\u83b7\u5f97 <code>HPA</code> \u6307\u6807\u3002\u5f53\u6211\u4eec\u8981\u67e5\u67d0\u4e2a\u6307\u6807\u7684\u503c\u65f6\u5c31\u8981\u901a\u8fc7\u5b83\u6307\u5b9a\u7684\u67e5\u8be2\u8bed\u53e5\u8fdb\u884c\u4e86\u3002\u53ef\u4ee5\u770b\u5230\u67e5\u8be2\u8bed\u53e5\u4f7f\u7528\u4e86\u901f\u7387\u548c\u5206\u7ec4\uff0c\u8fd9\u5c31\u662f\u89e3\u51b3\u4e0a\u9762\u63d0\u5230\u7684\u53ea\u589e\u6307\u6807\u7684\u95ee\u9898<ul> <li><code>Series</code>\uff1a\u8868\u793a\u6307\u6807\u540d\u79f0</li> <li><code>LabelMatchers</code>\uff1a\u9644\u52a0\u7684\u6807\u7b7e\uff0c\u76ee\u524d\u53ea\u6709 <code>pod</code> \u548c <code>namespace</code> \u4e24\u79cd\uff0c\u56e0\u6b64\u6211\u4eec\u8981\u5728\u4e4b\u524d\u4f7f\u7528 <code>resources</code> \u8fdb\u884c\u5173\u8054</li> <li><code>GroupBy</code>\uff1a\u5c31\u662f <code>pod</code> \u540d\u79f0\uff0c\u540c\u6837\u9700\u8981\u4f7f\u7528 <code>resources</code> \u8fdb\u884c\u5173\u8054\u3002</li> </ul> </li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u901a\u8fc7 <code>Helm Chart</code>\u6765\u90e8\u7f72 <code>Prometheus Adapter</code>\uff0c\u65b0\u5efa <code>hpa-prome-adapter-values.yaml</code> \u6587\u4ef6\u8986\u76d6\u9ed8\u8ba4\u7684 <code>Values</code> \u503c\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>rules:\n  default: false\n  custom:\n  - seriesQuery: 'nginx_vts_server_requests_total'\n    resources: \n      overrides:\n        kubernetes_namespace:\n          resource: namespace\n        kubernetes_pod_name:\n          resource: pod\n    name:\n      matches: \"^(.*)_total\"\n      as: \"${1}_per_second\"\n    metricsQuery: (sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[1m])) by (&lt;&lt;.GroupBy&gt;&gt;))\n\nprometheus:\n  url: http://kube-prom-prometheus-opera-prometheus.monitoring.svc.cluster.local\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u6761 rules \u89c4\u5219\uff0c\u7136\u540e\u6307\u5b9a\u4e86 <code>Prometheus</code> \u7684\u5730\u5740\uff0c\u6211\u4eec\u8fd9\u91cc\u662f\u4f7f\u7528\u4e86 <code>Operator</code> \u90e8\u7f72\u7684 <code>Promethues</code> \u96c6\u7fa4\uff0c\u6240\u4ee5\u7528 <code>kube-prom-prometheus-opera-prometheus</code> \u7684\u5730\u5740\u3002\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e00\u952e\u5b89\u88c5\uff1a</p> <pre><code>$ helm install prometheus-adapter stable/prometheus-adapter -n monitoring -f hpa-prome-adapter-values.yaml\nNAME: prometheus-adapter\nLAST DEPLOYED: Wed Apr  8 12:09:13 2020\nNAMESPACE: monitoring\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nprometheus-adapter has been deployed.\nIn a few minutes you should be able to list metrics using the following command(s):\n\n  kubectl get --raw /apis/custom.metrics.k8s.io/v1beta1\n</code></pre> <p>\u7b49\u4e00\u5c0f\u4f1a\u513f\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u68c0\u6d4b\u662f\u5426\u751f\u6548\u4e86\uff1a</p> <pre><code>$  kubectl get pods -n monitoring -l app=prometheus-adapter\nNAME                                  READY   STATUS    RESTARTS   AGE\nprometheus-adapter-58b559fc7d-mk5bz   1/1     Running   0          3m39s\n</code></pre> <pre><code>$  kubectl get --raw=\"/apis/custom.metrics.k8s.io/v1beta1\" | jq\n{\n  \"kind\": \"APIResourceList\",\n  \"apiVersion\": \"v1\",\n  \"groupVersion\": \"custom.metrics.k8s.io/v1beta1\",\n  \"resources\": [\n    {\n      \"name\": \"namespaces/nginx_vts_server_requests_per_second\",\n      \"singularName\": \"\",\n      \"namespaced\": false,\n      \"kind\": \"MetricValueList\",\n      \"verbs\": [\n        \"get\"\n      ]\n    },\n    {\n      \"name\": \"pods/nginx_vts_server_requests_per_second\",\n      \"singularName\": \"\",\n      \"namespaced\": true,\n      \"kind\": \"MetricValueList\",\n      \"verbs\": [\n        \"get\"\n      ]\n    }\n  ]\n}\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>nginx_vts_server_requests_per_second</code> \u6307\u6807\u53ef\u7528\u3002 \u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u68c0\u67e5\u8be5\u6307\u6807\u7684\u5f53\u524d\u503c\uff1a</p> <pre><code>$ kubectl get --raw \"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/nginx_vts_server_requests_per_second\" | jq .\n{\n  \"kind\": \"MetricValueList\",\n  \"apiVersion\": \"custom.metrics.k8s.io/v1beta1\",\n  \"metadata\": {\n    \"selfLink\": \"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/nginx_vts_server_requests_per_second\"\n  },\n  \"items\": [\n    {\n      \"describedObject\": {\n        \"kind\": \"Pod\",\n        \"namespace\": \"default\",\n        \"name\": \"hpa-prom-demo-755bb56f85-lvksr\",\n        \"apiVersion\": \"/v1\"\n      },\n      \"metricName\": \"nginx_vts_server_requests_per_second\",\n      \"timestamp\": \"2020-04-07T09:45:45Z\",\n      \"value\": \"527m\",\n      \"selector\": null\n    }\n  ]\n}\n</code></pre> <p>\u51fa\u73b0\u7c7b\u4f3c\u4e0a\u9762\u7684\u4fe1\u606f\u5c31\u8868\u660e\u5df2\u7ecf\u914d\u7f6e\u6210\u529f\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u9488\u5bf9\u4e0a\u9762\u7684\u81ea\u5b9a\u4e49\u6307\u6807\u7684 HAP \u8d44\u6e90\u5bf9\u8c61\uff0c\u5982\u4e0b\u6240\u793a\uff1a(<code>hpa-prome.yaml</code>)</p> <pre><code>apiVersion: autoscaling/v2beta1\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: nginx-custom-hpa\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: hpa-prom-demo\n  minReplicas: 2\n  maxReplicas: 5\n  metrics:\n  - type: Pods\n    pods:\n      metricName: nginx_vts_server_requests_per_second\n      targetAverageValue: 10\n</code></pre> <p>\u5982\u679c\u8bf7\u6c42\u6570\u8d85\u8fc7\u6bcf\u79d210\u4e2a\uff0c\u5219\u5c06\u5bf9\u5e94\u7528\u8fdb\u884c\u6269\u5bb9\u3002\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f hpa-prome.yaml\nhorizontalpodautoscaler.autoscaling/nginx-custom-hpa created\n$ kubectl describe hpa nginx-custom-hpa\nName:                                              nginx-custom-hpa\nNamespace:                                         default\nLabels:                                            &lt;none&gt;\nAnnotations:                                       kubectl.kubernetes.io/last-applied-configuration:\n                                                     {\"apiVersion\":\"autoscaling/v2beta1\",\"kind\":\"HorizontalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-custom-hpa\",\"namespace\":\"d...\nCreationTimestamp:                                 Tue, 07 Apr 2020 17:54:55 +0800\nReference:                                         Deployment/hpa-prom-demo\nMetrics:                                           ( current / target )\n  \"nginx_vts_server_requests_per_second\" on pods:  &lt;unknown&gt; / 10\nMin replicas:                                      2\nMax replicas:                                      5\nDeployment pods:                                   1 current / 2 desired\nConditions:\n  Type         Status  Reason            Message\n  ----         ------  ------            -------\n  AbleToScale  True    SucceededRescale  the HPA controller was able to update the target scale to 2\nEvents:\n  Type    Reason             Age   From                       Message\n  ----    ------             ----  ----                       -------\n  Normal  SuccessfulRescale  7s    horizontal-pod-autoscaler  New size: 2; reason: Current number of replicas below Spec.MinReplicas\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 HPA \u5bf9\u8c61\u5df2\u7ecf\u751f\u6548\u4e86\uff0c\u4f1a\u5e94\u7528\u6700\u5c0f\u7684\u526f\u672c\u65702\uff0c\u6240\u4ee5\u4f1a\u65b0\u589e\u4e00\u4e2a Pod \u526f\u672c\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx-server\nNAME                             READY   STATUS    RESTARTS   AGE\nhpa-prom-demo-755bb56f85-s5dzf   1/1     Running   0          67s\nhpa-prom-demo-755bb56f85-wbpfr   1/1     Running   0          3m30s\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u540c\u6837\u5bf9\u5e94\u7528\u8fdb\u884c\u538b\u6d4b\uff1a</p> <pre><code>$ while true; do wget -q -O- http://localhost:30339; done\n</code></pre> <p>\u6253\u5f00\u53e6\u5916\u4e00\u4e2a\u7ec8\u7aef\u89c2\u5bdf HPA \u5bf9\u8c61\u7684\u53d8\u5316\uff1a</p> <pre><code>$ kubectl get hpa\nNAME               REFERENCE                  TARGETS     MINPODS   MAXPODS   REPLICAS   AGE\nnginx-custom-hpa   Deployment/hpa-prom-demo   14239m/10   2         5         2          4m27s\n$ kubectl describe hpa nginx-custom-hpa\nName:                                              nginx-custom-hpa\nNamespace:                                         default\nLabels:                                            &lt;none&gt;\nAnnotations:                                       kubectl.kubernetes.io/last-applied-configuration:\n                                                     {\"apiVersion\":\"autoscaling/v2beta1\",\"kind\":\"HorizontalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-custom-hpa\",\"namespace\":\"d...\nCreationTimestamp:                                 Tue, 07 Apr 2020 17:54:55 +0800\nReference:                                         Deployment/hpa-prom-demo\nMetrics:                                           ( current / target )\n  \"nginx_vts_server_requests_per_second\" on pods:  14308m / 10\nMin replicas:                                      2\nMax replicas:                                      5\nDeployment pods:                                   3 current / 3 desired\nConditions:\n  Type            Status  Reason              Message\n  ----            ------  ------              -------\n  AbleToScale     True    ReadyForNewScale    recommended size matches current size\n  ScalingActive   True    ValidMetricFound    the HPA was able to successfully calculate a replica count from pods metric nginx_vts_server_requests_per_second\n  ScalingLimited  False   DesiredWithinRange  the desired count is within the acceptable range\nEvents:\n  Type    Reason             Age   From                       Message\n  ----    ------             ----  ----                       -------\n  Normal  SuccessfulRescale  5m2s  horizontal-pod-autoscaler  New size: 2; reason: Current number of replicas below Spec.MinReplicas\n  Normal  SuccessfulRescale  61s   horizontal-pod-autoscaler  New size: 3; reason: pods metric nginx_vts_server_requests_per_second above target\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6307\u6807 <code>nginx_vts_server_requests_per_second</code> \u7684\u6570\u636e\u5df2\u7ecf\u8d85\u8fc7\u9608\u503c\u4e86\uff0c\u89e6\u53d1\u6269\u5bb9\u52a8\u4f5c\u4e86\uff0c\u526f\u672c\u6570\u53d8\u6210\u4e86<code>3</code>\uff0c\u4f46\u662f\u540e\u7eed\u5f88\u96be\u7ee7\u7eed\u6269\u5bb9\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u7684 <code>while</code> \u547d\u4ee4\u5e76\u4e0d\u591f\u5feb\uff0c<code>3</code>\u4e2a\u526f\u672c\u5b8c\u5168\u53ef\u4ee5\u6ee1\u8db3\u6bcf\u79d2\u4e0d\u8d85\u8fc7 <code>10</code> \u4e2a\u8bf7\u6c42\u7684\u9608\u503c\u3002</p> <p></p> <p>\u5982\u679c\u9700\u8981\u66f4\u597d\u7684\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b\u538b\u6d4b\u5de5\u5177\uff0c\u6bd4\u5982 ab\u3001fortio \u7b49\u5de5\u5177\u3002\u5f53\u6211\u4eec\u4e2d\u65ad\u6d4b\u8bd5\u540e\uff0c\u9ed8\u8ba45\u5206\u949f\u8fc7\u540e\u5c31\u4f1a\u81ea\u52a8\u7f29\u5bb9\uff1a</p> <pre><code>$ kubectl describe hpa nginx-custom-hpa\nName:                                              nginx-custom-hpa\nNamespace:                                         default\nLabels:                                            &lt;none&gt;\nAnnotations:                                       kubectl.kubernetes.io/last-applied-configuration:\n                                                     {\"apiVersion\":\"autoscaling/v2beta1\",\"kind\":\"HorizontalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-custom-hpa\",\"namespace\":\"d...\nCreationTimestamp:                                 Tue, 07 Apr 2020 17:54:55 +0800\nReference:                                         Deployment/hpa-prom-demo\nMetrics:                                           ( current / target )\n  \"nginx_vts_server_requests_per_second\" on pods:  533m / 10\nMin replicas:                                      2\nMax replicas:                                      5\nDeployment pods:                                   2 current / 2 desired\nConditions:\n  Type            Status  Reason            Message\n  ----            ------  ------            -------\n  AbleToScale     True    ReadyForNewScale  recommended size matches current size\n  ScalingActive   True    ValidMetricFound  the HPA was able to successfully calculate a replica count from pods metric nginx_vts_server_requests_per_second\n  ScalingLimited  True    TooFewReplicas    the desired replica count is less than the minimum replica count\nEvents:\n  Type    Reason             Age   From                       Message\n  ----    ------             ----  ----                       -------\n  Normal  SuccessfulRescale  23m   horizontal-pod-autoscaler  New size: 2; reason: Current number of replicas below Spec.MinReplicas\n  Normal  SuccessfulRescale  19m   horizontal-pod-autoscaler  New size: 3; reason: pods metric nginx_vts_server_requests_per_second above target\n  Normal  SuccessfulRescale  4m2s  horizontal-pod-autoscaler  New size: 2; reason: All metrics below target\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u6307\u6807\u5bf9\u5e94\u7528\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u7684\u64cd\u4f5c\u3002\u5982\u679c <code>Prometheus</code> \u5b89\u88c5\u5728\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u4e4b\u5916\uff0c\u5219\u53ea\u9700\u8981\u786e\u4fdd\u53ef\u4ee5\u4ece\u96c6\u7fa4\u8bbf\u95ee\u5230\u67e5\u8be2\u7684\u7aef\u70b9\uff0c\u5e76\u5728 adapter \u7684\u90e8\u7f72\u6e05\u5355\u4e2d\u5bf9\u5176\u8fdb\u884c\u66f4\u65b0\u5373\u53ef\u3002\u5728\u66f4\u590d\u6742\u7684\u573a\u666f\u4e2d\uff0c\u53ef\u4ee5\u83b7\u53d6\u591a\u4e2a\u6307\u6807\u7ed3\u5408\u4f7f\u7528\u6765\u5236\u5b9a\u6269\u5c55\u7b56\u7565\u3002</p>"},{"location":"chap1/55prometheus_go_metrics/","title":"\u7b2c\u4e03\u8282 \u4e3aGo\u5e94\u7528\u6dfb\u52a0Prometheus\u76d1\u63a7\u6307\u6807","text":""},{"location":"chap1/55prometheus_go_metrics/#1","title":"1\u3001\u521b\u5efa\u5e94\u7528","text":"<p>\u6211\u4eec\u9996\u5148\u4ece\u4e00\u4e2a\u6700\u7b80\u5355\u7684 Go \u5e94\u7528\u7a0b\u5e8f\u5f00\u59cb\uff0c\u5728\u7aef\u53e3 <code>8080</code> \u7684 <code>/metrics</code> \u7aef\u70b9\u4e0a\u66b4\u9732\u5ba2\u6237\u7aef\u5e93\u7684\u9ed8\u8ba4\u6ce8\u518c\u8868\uff0c\u6682\u65f6\u8fd8\u6ca1\u6709\u8ddf\u8e2a\u4efb\u4f55\u5176\u4ed6\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u6307\u6807\u3002</p> <p>\u5148\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>instrument-demo</code> \u7684\u76ee\u5f55\uff0c\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u521d\u59cb\u5316\u9879\u76ee\uff1a</p> <pre><code>\u2638 \u279c mkdir instrument-demo &amp;&amp; cd instrument-demo\n\u2638 \u279c go mod init github.com/cnych/instrument-demo\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u5728 <code>instrument-demo</code> \u76ee\u5f55\u4e0b\u9762\u751f\u6210\u4e00\u4e2a <code>go.mod</code> \u6587\u4ef6\uff0c\u5728\u540c\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a <code>main.go</code> \u7684\u5165\u53e3\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>package main\n\nimport (\n \"net/http\"\n\n \"github.com/prometheus/client_golang/prometheus/promhttp\"\n)\n\nfunc main() {\n    // Serve the default Prometheus metrics registry over HTTP on /metrics.\n http.Handle(\"/metrics\", promhttp.Handler())\n http.ListenAndServe(\":8080\", nil)\n}\n</code></pre> <p>\u7136\u540e\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u4e0b\u8f7d Prometheus \u5ba2\u6237\u7aef\u5e93\u4f9d\u8d56\uff1a</p> <pre><code>\u2638 \u279c export GOPROXY=\"https://goproxy.cn\"\n\u2638 \u279c go mod tidy\ngo: finding module for package github.com/prometheus/client_golang/prometheus/promhttp\ngo: found github.com/prometheus/client_golang/prometheus/promhttp in github.com/prometheus/client_golang v1.11.0\ngo: downloading google.golang.org/protobuf v1.26.0-rc.1\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u6267\u884c <code>go run</code> \u547d\u4ee4\u542f\u52a8\u670d\u52a1\uff1a</p> <pre><code>\u2638 \u279c go run main.go\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee <code>http://localhost:8080/metrics</code> \u6765\u83b7\u5f97\u9ed8\u8ba4\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff1a</p> <pre><code># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.\n# TYPE go_gc_duration_seconds summary\ngo_gc_duration_seconds{quantile=\"0\"} 0\ngo_gc_duration_seconds{quantile=\"0.25\"} 0\ngo_gc_duration_seconds{quantile=\"0.5\"} 0\ngo_gc_duration_seconds{quantile=\"0.75\"} 0\ngo_gc_duration_seconds{quantile=\"1\"} 0\ngo_gc_duration_seconds_sum 0\ngo_gc_duration_seconds_count 0\n# HELP go_goroutines Number of goroutines that currently exist.\n# TYPE go_goroutines gauge\ngo_goroutines 6\n......\n# HELP go_threads Number of OS threads created.\n# TYPE go_threads gauge\ngo_threads 8\n# HELP promhttp_metric_handler_requests_in_flight Current number of scrapes being served.\n# TYPE promhttp_metric_handler_requests_in_flight gauge\npromhttp_metric_handler_requests_in_flight 1\n# HELP promhttp_metric_handler_requests_total Total number of scrapes by HTTP status code.\n# TYPE promhttp_metric_handler_requests_total counter\npromhttp_metric_handler_requests_total{code=\"200\"} 1\npromhttp_metric_handler_requests_total{code=\"500\"} 0\npromhttp_metric_handler_requests_total{code=\"503\"} 0\n</code></pre> <p>\u6211\u4eec\u5e76\u6ca1\u6709\u5728\u4ee3\u7801\u4e2d\u6dfb\u52a0\u4ec0\u4e48\u4e1a\u52a1\u903b\u8f91\uff0c\u4f46\u662f\u53ef\u4ee5\u770b\u5230\u4f9d\u7136\u6709\u4e00\u4e9b\u6307\u6807\u6570\u636e\u8f93\u51fa\uff0c\u8fd9\u662f\u56e0\u4e3a Go \u5ba2\u6237\u7aef\u5e93\u9ed8\u8ba4\u5728\u6211\u4eec\u66b4\u9732\u7684\u5168\u5c40\u9ed8\u8ba4\u6307\u6807\u6ce8\u518c\u8868\u4e2d\u6ce8\u518c\u4e86\u4e00\u4e9b\u5173\u4e8e <code>promhttp</code> \u5904\u7406\u5668\u548c\u8fd0\u884c\u65f6\u95f4\u76f8\u5173\u7684\u9ed8\u8ba4\u6307\u6807\uff0c\u6839\u636e\u4e0d\u540c\u6307\u6807\u540d\u79f0\u7684\u524d\u7f00\u53ef\u4ee5\u770b\u51fa\uff1a</p> <ul> <li><code>go_*</code>\uff1a\u4ee5 <code>go_</code> \u4e3a\u524d\u7f00\u7684\u6307\u6807\u662f\u5173\u4e8e <code>Go</code> \u8fd0\u884c\u65f6\u76f8\u5173\u7684\u6307\u6807\uff0c\u6bd4\u5982\u5783\u573e\u56de\u6536\u65f6\u95f4\u3001<code>goroutine</code>\u6570\u91cf\u7b49\uff0c\u8fd9\u4e9b\u90fd\u662f Go \u5ba2\u6237\u7aef\u5e93\u7279\u6709\u7684\uff0c\u5176\u4ed6\u8bed\u8a00\u7684\u5ba2\u6237\u7aef\u5e93\u53ef\u80fd\u4f1a\u66b4\u9732\u5404\u81ea\u8bed\u8a00\u7684\u5176\u4ed6\u8fd0\u884c\u65f6\u6307\u6807\u3002</li> <li><code>promhttp_*</code>\uff1a\u6765\u81ea <code>promhttp</code> \u5de5\u5177\u5305\u7684\u76f8\u5173\u6307\u6807\uff0c\u7528\u4e8e\u8ddf\u8e2a\u5bf9\u6307\u6807\u8bf7\u6c42\u7684\u5904\u7406\u3002</li> </ul> <p>\u8fd9\u4e9b\u9ed8\u8ba4\u7684\u6307\u6807\u662f\u975e\u5e38\u6709\u7528\uff0c\u4f46\u662f\u66f4\u591a\u7684\u65f6\u5019\u6211\u4eec\u9700\u8981\u81ea\u5df1\u63a7\u5236\uff0c\u6765\u66b4\u9732\u4e00\u4e9b\u81ea\u5b9a\u4e49\u6307\u6807\u3002\u8fd9\u5c31\u9700\u8981\u6211\u4eec\u53bb\u5b9e\u73b0\u81ea\u5b9a\u4e49\u7684\u6307\u6807\u4e86\u3002</p>"},{"location":"chap1/55prometheus_go_metrics/#2","title":"2\u3001\u6dfb\u52a0\u81ea\u5b9a\u4e49\u6307\u6807","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u81ea\u5b9a\u4e49\u4e00\u4e2a\u7684 gauge \u6307\u6807\u6765\u66b4\u9732\u5f53\u524d\u7684\u6e29\u5ea6\u3002\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6587\u4ef6 <code>custom-metric/main.go</code>\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>package main\n\nimport (\n \"net/http\"\n\n \"github.com/prometheus/client_golang/prometheus\"\n \"github.com/prometheus/client_golang/prometheus/promhttp\"\n)\n\nfunc main() {\n    // \u521b\u5efa\u4e00\u4e2a\u6ca1\u6709\u4efb\u4f55 label \u6807\u7b7e\u7684 gauge \u6307\u6807\n temp := prometheus.NewGauge(prometheus.GaugeOpts{\n  Name: \"home_temperature_celsius\",\n  Help: \"The current temperature in degrees Celsius.\",\n })\n\n // \u5728\u9ed8\u8ba4\u7684\u6ce8\u518c\u8868\u4e2d\u6ce8\u518c\u8be5\u6307\u6807\n prometheus.MustRegister(temp)\n\n // \u8bbe\u7f6e gauge \u7684\u503c\u4e3a 39\n temp.Set(39)\n\n // \u66b4\u9732\u6307\u6807\n http.Handle(\"/metrics\", promhttp.Handler())\n http.ListenAndServe(\":8080\", nil)\n}\n</code></pre> <p>\u4e0a\u9762\u6587\u4ef6\u4e2d\u548c\u6700\u521d\u7684\u6587\u4ef6\u5c31\u6709\u4e00\u4e9b\u53d8\u5316\u4e86\uff1a</p> <ul> <li>\u6211\u4eec\u4f7f\u7528 <code>prometheus.NewGauge()</code> \u51fd\u6570\u521b\u5efa\u4e86\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684 <code>gauge</code> \u6307\u6807\u5bf9\u8c61\uff0c\u6307\u6807\u540d\u79f0\u4e3a <code>home_temperature_celsius</code>\uff0c\u5e76\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6ce8\u91ca\u4fe1\u606f\u3002</li> <li>\u7136\u540e\u4f7f\u7528 <code>prometheus.MustRegister()</code> \u51fd\u6570\u5728\u9ed8\u8ba4\u7684\u6ce8\u518c\u8868\u4e2d\u6ce8\u518c\u4e86\u8fd9\u4e2a <code>gauge</code> \u6307\u6807\u5bf9\u8c61\u3002</li> <li>\u901a\u8fc7\u8c03\u7528 <code>Set()</code> \u65b9\u6cd5\u5c06 gauge \u6307\u6807\u7684\u503c\u8bbe\u7f6e\u4e3a 39\u3002</li> <li>\u7136\u540e\u50cf\u4e4b\u524d\u4e00\u6837\u901a\u8fc7 <code>HTTP</code>\u66b4\u9732\u9ed8\u8ba4\u7684\u6ce8\u518c\u8868\u3002</li> </ul> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u9664\u4e86 <code>prometheus.MustRegister()</code> \u51fd\u6570\u4e4b\u5916\u8fd8\u6709\u4e00\u4e2a <code>prometheus.Register()</code> \u51fd\u6570\uff0c\u4e00\u822c\u5728 golang \u4e2d\u6211\u4eec\u4f1a\u5c06 <code>Mustxxx</code> \u5f00\u5934\u7684\u51fd\u6570\u5b9a\u4e49\u4e3a\u5fc5\u987b\u6ee1\u8db3\u6761\u4ef6\u7684\u51fd\u6570\uff0c\u5982\u679c\u4e0d\u6ee1\u8db3\u4f1a\u8fd4\u56de\u4e00\u4e2a panic \u800c\u4e0d\u662f\u4e00\u4e2a error \u64cd\u4f5c\uff0c\u6240\u4ee5\u5982\u679c\u8fd9\u91cc\u4e0d\u80fd\u6b63\u5e38\u6ce8\u518c\u7684\u8bdd\u4f1a\u629b\u51fa\u4e00\u4e2a panic\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u8fd0\u884c\u8fd9\u4e2a\u7a0b\u5e8f\uff1a</p> <pre><code>\u2638 \u279c go run ./custom-metric\n</code></pre> <p>\u542f\u52a8\u540e\u91cd\u65b0\u8bbf\u95ee\u6307\u6807\u63a5\u53e3 <code>http://localhost:8080/metrics</code>\uff0c\u4ed4\u7ec6\u5bf9\u6bd4\u6211\u4eec\u4f1a\u53d1\u73b0\u591a\u4e86\u4e00\u4e2a\u540d\u4e3a <code>home_temperature_celsius</code> \u7684\u6307\u6807\uff1a</p> <pre><code>...\n# HELP home_temperature_celsius The current temperature in degrees Celsius.\n# TYPE home_temperature_celsius gauge\nhome_temperature_celsius 42\n...\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u5b9e\u73b0\u4e86\u6dfb\u52a0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u6307\u6807\u7684\u64cd\u4f5c\uff0c\u6574\u4f53\u6bd4\u8f83\u7b80\u5355\uff0c\u5f53\u7136\u5728\u5b9e\u9645\u7684\u9879\u76ee\u4e2d\u9700\u8981\u7ed3\u5408\u4e1a\u52a1\u6765\u786e\u5b9a\u6dfb\u52a0\u54ea\u4e9b\u81ea\u5b9a\u4e49\u6307\u6807\u3002</p>"},{"location":"chap1/55prometheus_go_metrics/#3","title":"3\u3001\u81ea\u5b9a\u4e49\u6ce8\u518c\u8868","text":""},{"location":"chap1/55prometheus_go_metrics/#3-1-gauges","title":"3-1 Gauges","text":"<p>\u524d\u9762\u7684\u793a\u4f8b\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86\u5982\u4f55\u6dfb\u52a0 gauge \u7c7b\u578b\u7684\u6307\u6807\uff0c\u521b\u5efa\u4e86\u4e00\u4e2a\u6ca1\u6709\u4efb\u4f55\u6807\u7b7e\u7684\u6307\u6807\uff0c\u76f4\u63a5\u4f7f\u7528 <code>prometheus.NewGauge()</code> \u51fd\u6570\u5373\u53ef\u5b9e\u4f8b\u5316\u4e00\u4e2a gauge \u7c7b\u578b\u7684\u6307\u6807\u5bf9\u8c61\uff0c\u901a\u8fc7 <code>prometheus.GaugeOpts</code> \u5bf9\u8c61\u53ef\u4ee5\u6307\u5b9a\u6307\u6807\u7684\u540d\u79f0\u548c\u6ce8\u91ca\u4fe1\u606f\uff1a</p> <pre><code>queueLength := prometheus.NewGauge(prometheus.GaugeOpts{\n Name: \"queue_length\",\n Help: \"The number of items in the queue.\",\n})\n</code></pre> <p>\u6211\u4eec\u77e5\u9053 gauge \u7c7b\u578b\u7684\u6307\u6807\u503c\u662f\u53ef\u4ee5\u4e0a\u5347\u6216\u4e0b\u964d\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4e3a gauge \u6307\u6807\u8bbe\u7f6e\u4e00\u4e2a\u6307\u5b9a\u7684\u503c\uff0c\u6240\u4ee5 gauge \u6307\u6807\u5bf9\u8c61\u66b4\u9732\u4e86 <code>Set()</code>\u3001<code>Inc()</code>\u3001<code>Dec()</code>\u3001<code>Add()</code> \u548c <code>Sub()</code>\u8fd9\u4e9b\u51fd\u6570\u6765\u66f4\u6539\u6307\u6807\u503c\uff1a</p> <pre><code>// \u4f7f\u7528 Set() \u8bbe\u7f6e\u6307\u5b9a\u7684\u503c\nqueueLength.Set(0)\n\n// \u589e\u52a0\u6216\u51cf\u5c11\nqueueLength.Inc()   // +1\uff1aIncrement the gauge by 1.\nqueueLength.Dec()   // -1\uff1aDecrement the gauge by 1.\nqueueLength.Add(23) // Increment by 23.\nqueueLength.Sub(42) // Decrement by 42.\n</code></pre> <p>\u53e6\u5916 gauge \u4eea\u8868\u76d8\u7ecf\u5e38\u88ab\u7528\u6765\u66b4\u9732 Unix \u7684\u65f6\u95f4\u6233\u6837\u672c\u503c\uff0c\u6240\u4ee5\u4e5f\u6709\u4e00\u4e2a\u65b9\u4fbf\u7684\u65b9\u6cd5\u6765\u5c06 gauge \u8bbe\u7f6e\u4e3a\u5f53\u524d\u7684\u65f6\u95f4\u6233\uff1a</p> <pre><code>demoTimestamp.SetToCurrentTime()\n</code></pre> <p>\u6700\u7ec8 gauge \u6307\u6807\u4f1a\u88ab\u6e32\u67d3\u6210\u5982\u4e0b\u6240\u793a\u7684\u6570\u636e\uff1a</p> <pre><code>\n# HELP queue_length The number of items in the queue.\n# TYPE queue_length gauge\nqueue_length 42\n</code></pre>"},{"location":"chap1/55prometheus_go_metrics/#3-2-counters","title":"3-2 Counters","text":"<p>\u8981\u521b\u5efa\u4e00\u4e2a counter \u7c7b\u578b\u7684\u6307\u6807\u548c gauge \u6bd4\u8f83\u7c7b\u4f3c\uff0c\u53ea\u662f\u7528<code>prometheus.NewCounter()</code>\u51fd\u6570\u6765\u521d\u59cb\u5316\u6307\u6807\u5bf9\u8c61\uff1a</p> <pre><code>totalRequests := prometheus.NewCounter(prometheus.CounterOpts{\n Name: \"http_requests_total\",\n Help: \"The total number of handled HTTP requests.\",\n})\n</code></pre> <p>\u6211\u4eec\u77e5\u9053 counter \u6307\u6807\u53ea\u80fd\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\u800c\u4e0d\u65ad\u589e\u52a0\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u80fd\u4e3a\u5176\u8bbe\u7f6e\u4e00\u4e2a\u6307\u5b9a\u7684\u503c\u6216\u8005\u51cf\u5c11\u6307\u6807\u503c\uff0c\u6240\u4ee5\u8be5\u5bf9\u8c61\u4e0b\u9762\u53ea\u6709 <code>Inc()</code> \u548c <code>Add()</code> \u4e24\u4e2a\u51fd\u6570\uff1a</p> <pre><code>totalRequests.Inc()   // +1\uff1aIncrement the counter by 1.\ntotalRequests.Add(23) // +n\uff1aIncrement the counter by 23.\n</code></pre> <p>\u5f53\u670d\u52a1\u8fdb\u7a0b\u91cd\u65b0\u542f\u52a8\u7684\u65f6\u5019\uff0ccounter \u6307\u6807\u503c\u4f1a\u88ab\u91cd\u7f6e\u4e3a 0\uff0c\u4e0d\u8fc7\u4e0d\u7528\u62c5\u5fc3\u6570\u636e\u9519\u4e71\uff0c\u6211\u4eec\u4e00\u822c\u4f1a\u4f7f\u7528\u7684 <code>rate()</code>\u51fd\u6570\u4f1a\u81ea\u52a8\u5904\u7406\u3002</p> <pre><code># HELP http_requests_total The total number of handled HTTP requests.\n# TYPE http_requests_total counter\nhttp_requests_total 7734\n</code></pre>"},{"location":"chap1/55prometheus_go_metrics/#3-3-histograms","title":"3-3 Histograms","text":"<p>\u521b\u5efa\u76f4\u65b9\u56fe\u6307\u6807\u6bd4 counter \u548c gauge \u90fd\u8981\u590d\u6742\uff0c\u56e0\u4e3a\u9700\u8981\u914d\u7f6e\u628a\u89c2\u6d4b\u503c\u5f52\u5165\u7684 bucket \u7684\u6570\u91cf\uff0c\u4ee5\u53ca\u6bcf\u4e2a bucket \u7684\u4e0a\u8fb9\u754c\u3002</p> <p>Prometheus \u4e2d\u7684\u76f4\u65b9\u56fe\u662f\u7d2f\u79ef\u7684\uff0c\u6240\u4ee5\u6bcf\u4e00\u4e2a\u540e\u7eed\u7684 bucket \u90fd\u5305\u542b\u524d\u4e00\u4e2a bucket \u7684\u89c2\u5bdf\u8ba1\u6570\uff0c\u6240\u6709 bucket \u7684\u4e0b\u9650\u90fd\u4ece 0 \u5f00\u59cb\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u9700\u8981\u660e\u786e\u914d\u7f6e\u6bcf\u4e2a bucket \u7684\u4e0b\u9650\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u4e0a\u9650\u5373\u53ef\u3002</p> <p>\u540c\u6837\u8981\u521b\u5efa\u76f4\u65b9\u56fe\u6307\u6807\u5bf9\u8c61\uff0c\u6211\u4eec\u4f7f\u7528 <code>prometheus.NewHistogram()</code>\u51fd\u6570\u6765\u8fdb\u884c\u521d\u59cb\u5316\uff1a</p> <pre><code>requestDurations := prometheus.NewHistogram(prometheus.HistogramOpts{\n  Name:    \"http_request_duration_seconds\",\n  Help:    \"A histogram of the HTTP request durations in seconds.\",\n  // Bucket \u914d\u7f6e\uff1a\u7b2c\u4e00\u4e2a bucket \u5305\u62ec\u6240\u6709\u5728 0.05s \u5185\u5b8c\u6210\u7684\u8bf7\u6c42\uff0c\u6700\u540e\u4e00\u4e2a\u5305\u62ec\u6240\u6709\u572810s\u5185\u5b8c\u6210\u7684\u8bf7\u6c42\u3002\n  Buckets: []float64{0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10},\n})\n</code></pre> <p>\u8fd9\u91cc\u548c\u524d\u9762\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u5728\u4e8e\u9664\u4e86\u6307\u5b9a\u6307\u6807\u540d\u79f0\u548c\u5e2e\u52a9\u4fe1\u606f\u4e4b\u5916\uff0c\u8fd8\u9700\u8981\u914d\u7f6e Buckets\u3002\u5982\u679c\u6211\u4eec\u624b\u52a8\u53bb\u679a\u4e3e\u6240\u6709\u7684 bucket \u53ef\u80fd\u5f88\u7e41\u7410\uff0c\u6240\u4ee5 Go \u5ba2\u6237\u7aef\u5e93\u4e3a\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e9b\u8f85\u52a9\u51fd\u6570\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u751f\u6210\u7ebf\u6027\u6216\u8005\u6307\u6570\u589e\u957f\u7684 bucket\uff0c\u6bd4\u5982 <code>prometheus.LinearBuckets()</code> \u548c <code>prometheus.ExponentialBuckets()</code>\u51fd\u6570\u3002</p> <p>\u76f4\u65b9\u56fe\u4f1a\u81ea\u52a8\u5bf9\u6570\u503c\u7684\u5206\u5e03\u8fdb\u884c\u5206\u7c7b\u548c\u8ba1\u6570\uff0c\u6240\u4ee5\u5b83\u53ea\u6709\u4e00\u4e2a <code>Observe()</code>\u65b9\u6cd5\uff0c\u6bcf\u5f53\u4f60\u5728\u4ee3\u7801\u4e2d\u5904\u7406\u8981\u8ddf\u8e2a\u7684\u6570\u636e\u65f6\uff0c\u5c31\u4f1a\u8c03\u7528\u8fd9\u4e2a\u65b9\u6cd5\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u521a\u521a\u5904\u7406\u4e86\u4e00\u4e2a <code>HTTP</code> \u8bf7\u6c42\uff0c\u82b1\u4e86 <code>0.42</code> \u79d2\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u4ee3\u7801\u6765\u8ddf\u8e2a\u3002</p> <pre><code>requestDurations.Observe(0.42)\n</code></pre> <p>\u7531\u4e8e\u8ddf\u8e2a\u6301\u7eed\u65f6\u95f4\u662f\u76f4\u65b9\u56fe\u7684\u4e00\u4e2a\u5e38\u89c1\u7528\u4f8b\uff0cGo \u5ba2\u6237\u7aef\u5e93\u5c31\u63d0\u4f9b\u4e86\u8f85\u52a9\u51fd\u6570\uff0c\u7528\u4e8e\u5bf9\u4ee3\u7801\u7684\u67d0\u4e9b\u90e8\u5206\u8fdb\u884c\u8ba1\u65f6\uff0c\u7136\u540e\u81ea\u52a8\u89c2\u5bdf\u6240\u4ea7\u751f\u7684\u6301\u7eed\u65f6\u95f4\uff0c\u5c06\u5176\u8f6c\u5316\u4e3a\u76f4\u65b9\u56fe\uff0c\u5982\u4e0b\u4ee3\u7801\u6240\u793a\uff1a</p> <pre><code>\n// \u542f\u52a8\u4e00\u4e2a\u8ba1\u65f6\u5668\ntimer := prometheus.NewTimer(requestDurations)\n\n// [...\u5728\u5e94\u7528\u4e2d\u5904\u7406\u8bf7\u6c42...]\n\n// \u505c\u6b62\u8ba1\u65f6\u5668\u5e76\u89c2\u5bdf\u5176\u6301\u7eed\u65f6\u95f4\uff0c\u5c06\u5176\u653e\u8fdb requestDurations \u7684\u76f4\u65b9\u56fe\u6307\u6807\u4e2d\u53bb\ntimer.ObserveDuration()\n</code></pre> <p>\u76f4\u65b9\u56fe\u6307\u6807\u6700\u7ec8\u4f1a\u751f\u6210\u5982\u4e0b\u6240\u793a\u7684\u6570\u636e\uff1a</p> <pre><code># HELP http_request_duration_seconds A histogram of the HTTP request durations in seconds.\n# TYPE http_request_duration_seconds histogram\nhttp_request_duration_seconds_bucket{le=\"0.05\"} 4599\nhttp_request_duration_seconds_bucket{le=\"0.1\"} 24128\nhttp_request_duration_seconds_bucket{le=\"0.25\"} 45311\nhttp_request_duration_seconds_bucket{le=\"0.5\"} 59983\nhttp_request_duration_seconds_bucket{le=\"1\"} 60345\nhttp_request_duration_seconds_bucket{le=\"2.5\"} 114003\nhttp_request_duration_seconds_bucket{le=\"5\"} 201325\nhttp_request_duration_seconds_bucket{le=\"+Inf\"} 227420\nhttp_request_duration_seconds_sum 88364.234\nhttp_request_duration_seconds_count 227420\n</code></pre> <p>\u6bcf\u4e2a\u914d\u7f6e\u7684\u5b58\u50a8\u6876\u6700\u7ec8\u4f5c\u4e3a\u4e00\u4e2a\u5e26\u6709 <code>_bucket</code> \u540e\u7f00\u7684\u8ba1\u6570\u5668\u65f6\u95f4\u5e8f\u5217\uff0c\u4f7f\u7528 <code>le\uff08\u5c0f\u4e8e\u6216\u7b49\u4e8e</code>\uff09 \u6807\u7b7e\u6307\u793a\u8be5\u5b58\u50a8\u6876\u7684\u4e0a\u9650\uff0c\u5177\u6709\u4e0a\u9650\u7684\u9690\u5f0f\u5b58\u50a8\u6876 <code>+Inf</code> \u4e5f\u66b4\u9732\u4e8e\u6bd4\u6700\u5927\u914d\u7f6e\u7684\u5b58\u50a8\u6876\u8fb9\u754c\u82b1\u8d39\u66f4\u957f\u7684\u65f6\u95f4\u7684\u8bf7\u6c42\uff0c\u8fd8\u5305\u62ec\u4f7f\u7528\u540e\u7f00 <code>_sum</code>\u7d2f\u79ef\u603b\u548c\u548c\u8ba1\u6570 <code>_count</code> \u7684\u6307\u6807\uff0c\u8fd9\u4e9b\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5728\u6982\u5ff5\u4e0a\u90fd\u662f\u4e00\u4e2a <code>counter</code> \u8ba1\u6570\u5668\uff08\u53ea\u80fd\u4e0a\u5347\u7684\u5355\u4e2a\u503c\uff09\uff0c\u53ea\u662f\u5b83\u4eec\u662f\u4f5c\u4e3a\u76f4\u65b9\u56fe\u7684\u4e00\u90e8\u5206\u521b\u5efa\u7684\u3002</p>"},{"location":"chap1/55prometheus_go_metrics/#3-4-summaries","title":"3-4 Summaries","text":"<p>\u521b\u5efa\u548c\u4f7f\u7528\u6458\u8981\u4e0e\u76f4\u65b9\u56fe\u975e\u5e38\u7c7b\u4f3c\uff0c\u53ea\u662f\u6211\u4eec\u9700\u8981\u6307\u5b9a\u8981\u8ddf\u8e2a\u7684 quantiles \u5206\u4f4d\u6570\u503c\uff0c\u800c\u4e0d\u9700\u8981\u5904\u7406 bucket \u6876\uff0c\u6bd4\u5982\u6211\u4eec\u60f3\u8981\u8ddf\u8e2a HTTP \u8bf7\u6c42\u5ef6\u8fdf\u7684\u7b2c 50\u300190 \u548c 99 \u4e2a\u767e\u5206\u4f4d\u6570\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u8fd9\u6837\u7684\u4e00\u4e2a\u6458\u8981\u5bf9\u8c61\uff1a</p> <pre><code>requestDurations := prometheus.NewSummary(prometheus.SummaryOpts{\n    Name:       \"http_request_duration_seconds\",\n    Help:       \"A summary of the HTTP request durations in seconds.\",\n    Objectives: map[float64]float64{\n      0.5: 0.05,   // \u7b2c50\u4e2a\u767e\u5206\u4f4d\u6570\uff0c\u6700\u5927\u7edd\u5bf9\u8bef\u5dee\u4e3a0.05\u3002\n      0.9: 0.01,   // \u7b2c90\u4e2a\u767e\u5206\u4f4d\u6570\uff0c\u6700\u5927\u7edd\u5bf9\u8bef\u5dee\u4e3a0.01\u3002\n      0.99: 0.001, // \u7b2c90\u4e2a\u767e\u5206\u4f4d\u6570\uff0c\u6700\u5927\u7edd\u5bf9\u8bef\u5dee\u4e3a0.001\u3002\n    },\n  },\n)\n</code></pre> <p>\u8fd9\u91cc\u548c\u524d\u9762\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u5728\u4e8e\u4f7f\u7528 <code>prometheus.NewSummary()</code> \u51fd\u6570\u521d\u59cb\u5316\u6458\u8981\u6307\u6807\u5bf9\u8c61\u7684\u65f6\u5019\uff0c\u9700\u8981\u901a\u8fc7 <code>prometheus.SummaryOpts{}</code> \u5bf9\u8c61\u7684 <code>Objectives</code> \u5c5e\u6027\u6307\u5b9a\u60f3\u8981\u8ddf\u8e2a\u7684\u5206\u4f4d\u6570\u503c\u3002</p> <p>\u540c\u6837\u6458\u8981\u6307\u6807\u5bf9\u8c61\u521b\u5efa\u540e\uff0c\u8ddf\u8e2a\u6301\u7eed\u65f6\u95f4\u7684\u65b9\u5f0f\u548c\u76f4\u65b9\u56fe\u662f\u5b8c\u5168\u4e00\u6837\u7684\uff0c\u4f7f\u7528\u4e00\u4e2a <code>Observe()</code> \u51fd\u6570\u5373\u53ef\uff1a</p> <pre><code>requestDurations.Observe(0.42)\n</code></pre> <p>\u867d\u7136\u76f4\u65b9\u56fe\u6876\u53ef\u4ee5\u8de8\u7ef4\u5ea6\u6c47\u603b\uff08\u5982\u7aef\u70b9\u3001HTTP \u65b9\u6cd5\u7b49\uff09\uff0c\u4f46\u8fd9\u5bf9\u4e8e\u6c47\u603b quantiles \u5206\u4f4d\u6570\u503c\u6765\u8bf4\u5728\u7edf\u8ba1\u5b66\u4e0a\u662f\u65e0\u6548\u7684\u3002\u4f8b\u5982\uff0c\u4f60\u4e0d\u80fd\u5bf9\u4e24\u4e2a\u5355\u72ec\u7684\u670d\u52a1\u5b9e\u4f8b\u7684\u7b2c 90 \u767e\u5206\u4f4d\u5ef6\u8fdf\u8fdb\u884c\u5e73\u5747\uff0c\u5e76\u671f\u671b\u5f97\u5230\u4e00\u4e2a\u6709\u6548\u7684\u6574\u4f53\u7b2c 90 \u767e\u5206\u4f4d\u5ef6\u8fdf\u3002\u5982\u679c\u9700\u8981\u6309\u7ef4\u5ea6\u8fdb\u884c\u6c47\u603b\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u4f7f\u7528\u76f4\u65b9\u56fe\u800c\u4e0d\u662f\u6458\u8981\u6307\u6807\u3002</p> <p>\u6458\u8981\u6307\u6807\u6700\u7ec8\u751f\u6210\u7684\u6307\u6807\u6570\u636e\u4e0e\u76f4\u65b9\u56fe\u975e\u5e38\u7c7b\u4f3c\uff0c\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\u4f7f\u7528 <code>quantile</code> \u6807\u7b7e\u6765\u8868\u793a\u5206\u4f4d\u6570\u5e8f\u5217\uff0c\u5e76\u4e14\u8fd9\u4e9b\u5e8f\u5217\u6ca1\u6709\u6269\u5c55\u6307\u6807\u540d\u79f0\u7684\u540e\u7f00\uff1a</p> <pre><code>\n# HELP http_request_duration_seconds A summary of the HTTP request durations in seconds.\n# TYPE http_request_duration_seconds summary\nhttp_request_duration_seconds{quantile=\"0.5\"} 0.052\nhttp_request_duration_seconds{quantile=\"0.90\"} 0.564\nhttp_request_duration_seconds{quantile=\"0.99\"} 2.372\nhttp_request_duration_seconds_sum 88364.234\nhttp_request_duration_seconds_count 227420\n</code></pre>"},{"location":"chap1/55prometheus_go_metrics/#3-5","title":"3-5 \u6807\u7b7e","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u8fd8\u6ca1\u6709\u4e3a\u6307\u6807\u5bf9\u8c61\u6dfb\u52a0\u4efb\u4f55\u7684\u6807\u7b7e\uff0c\u8981\u521b\u5efa\u5177\u6709\u6807\u7b7e\u7ef4\u5ea6\u7684\u6307\u6807\uff0c\u6211\u4eec\u53ef\u4ee5\u8c03\u7528\u7c7b\u4f3c\u4e8e <code>NewXXXVec()</code>\u7684\u6784\u9020\u51fd\u6570\u6765\u521d\u59cb\u5316\u6307\u6807\u5bf9\u8c61\uff1a</p> <ul> <li><code>NewGauge()</code> \u53d8\u6210 <code>NewGaugeVec()</code></li> <li><code>NewCounter()</code>\u53d8\u6210 <code>NewCounterVec()</code></li> <li><code>NewSummary()</code> \u53d8\u6210 <code>NewSummaryVec()</code></li> <li><code>NewHistogram()</code> \u53d8\u6210 <code>NewHistogramVec()</code></li> </ul> <p>\u8fd9\u4e9b\u51fd\u6570\u5141\u8bb8\u6211\u4eec\u6307\u5b9a\u4e00\u4e2a\u989d\u5916\u7684\u5b57\u7b26\u4e32\u5207\u7247\u53c2\u6570\uff0c\u63d0\u4f9b\u6807\u7b7e\u540d\u79f0\u7684\u5217\u8868\uff0c\u901a\u8fc7\u5b83\u6765\u62c6\u5206\u6307\u6807\u3002</p> <p>\u4f8b\u5982\uff0c\u4e3a\u4e86\u6309\u7167\u623f\u5b50\u4ee5\u53ca\u6d4b\u91cf\u6e29\u5ea6\u7684\u623f\u95f4\u6765\u5212\u5206\u6211\u4eec\u65e9\u671f\u7684\u6e29\u5ea6\u8868\u6307\u6807\uff0c\u53ef\u4ee5\u8fd9\u6837\u521b\u5efa\u6307\u6807\u3002</p> <pre><code>temp := prometheus.NewGaugeVec(\n  prometheus.GaugeOpts{\n    Name: \"home_temperature_celsius\",\n    Help: \"The current temperature in degrees Celsius.\",\n  },\n  // \u4e24\u4e2a\u6807\u7b7e\u540d\u79f0\uff0c\u901a\u8fc7\u5b83\u4eec\u6765\u5206\u5272\u6307\u6807\u3002\n  []string{\"house\", \"room\"},\n)\n</code></pre> <p>\u7136\u540e\u8981\u8bbf\u95ee\u4e00\u4e2a\u7279\u6709\u6807\u7b7e\u7684\u5b50\u6307\u6807\uff0c\u9700\u8981\u5728\u8bbe\u7f6e\u5176\u503c\u4e4b\u524d\uff0c\u7528 <code>house</code> \u548c <code>room</code> \u6807\u7b7e\u7684\u5404\u81ea\u6570\u503c\uff0c\u5bf9\u4ea7\u751f\u7684 <code>gauge</code> \u5411\u91cf\u8c03\u7528 <code>WithLabelValues()</code>\u65b9\u6cd5\u6765\u5904\u7406\u4e0b\uff1a</p> <pre><code>// \u4e3a home=ydzs \u548c room=living-room \u8bbe\u7f6e\u6307\u6807\u503c\ntemp.WithLabelValues(\"ydzs\", \"living-room\").Set(27)\n</code></pre> <p>\u5982\u679c\u4f60\u559c\u6b22\u5728\u9009\u62e9\u7684\u5b50\u6307\u6807\u4e2d\u660e\u786e\u63d0\u4f9b\u6807\u7b7e\u540d\u79f0\uff0c\u53ef\u4ee5\u4f7f\u7528\u6548\u7387\u7a0d\u4f4e\u7684 <code>With()</code>\u65b9\u6cd5\u6765\u4ee3\u66ff\uff1a</p> <pre><code>temp.With(prometheus.Labels{\"house\": \"ydzs\", \"room\": \"living-room\"}).Set(66)\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u5982\u679c\u5411\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u4f20\u9012\u4e0d\u6b63\u786e\u7684\u6807\u7b7e\u6570\u91cf\u6216\u4e0d\u6b63\u786e\u7684\u6807\u7b7e\u540d\u79f0\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u90fd\u4f1a\u89e6\u53d1 panic\u3002</p> <p>\u4e0b\u9762\u662f\u6211\u4eec\u6309\u7167 <code>house</code> \u548c <code>room</code> \u6807\u7b7e\u7ef4\u5ea6\u533a\u5206\u6307\u6807\u7684\u5b8c\u6574\u793a\u4f8b\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>label-metric/main.go</code>\u7684\u65b0\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>package main\n\nimport (\n \"net/http\"\n\n \"github.com/prometheus/client_golang/prometheus\"\n \"github.com/prometheus/client_golang/prometheus/promhttp\"\n)\n\nfunc main() {\n    // \u521b\u5efa\u5e26 house \u548c room \u6807\u7b7e\u7684 gauge \u6307\u6807\u5bf9\u8c61\n temp := prometheus.NewGaugeVec(\n  prometheus.GaugeOpts{\n   Name: \"home_temperature_celsius\",\n   Help: \"The current temperature in degrees Celsius.\",\n  },\n  // \u6307\u5b9a\u6807\u7b7e\u540d\u79f0\n  []string{\"house\", \"room\"},\n )\n\n // \u6ce8\u518c\u5230\u5168\u5c40\u9ed8\u8ba4\u6ce8\u518c\u8868\u4e2d\n prometheus.MustRegister(temp)\n\n // \u9488\u5bf9\u4e0d\u540c\u6807\u7b7e\u503c\u8bbe\u7f6e\u4e0d\u540c\u7684\u6307\u6807\u503c\n temp.WithLabelValues(\"cnych\", \"living-room\").Set(27)\n temp.WithLabelValues(\"cnych\", \"bedroom\").Set(25.3)\n temp.WithLabelValues(\"ydzs\", \"living-room\").Set(24.5)\n temp.WithLabelValues(\"ydzs\", \"bedroom\").Set(27.7)\n\n // \u66b4\u9732\u81ea\u5b9a\u4e49\u7684\u6307\u6807\n http.Handle(\"/metrics\", promhttp.Handler())\n http.ListenAndServe(\":8080\", nil)\n}\n</code></pre> <p>\u4e0a\u9762\u4ee3\u7801\u975e\u5e38\u6e05\u6670\u4e86\uff0c\u8fd0\u884c\u4e0b\u9762\u7684\u7a0b\u5e8f\uff1a</p> <pre><code>\u2638 \u279c go run ./label-metric\n</code></pre> <p>\u542f\u52a8\u5b8c\u6210\u540e\u91cd\u65b0\u8bbf\u95ee\u6307\u6807\u7aef\u70b9 <code>http://localhost:8080/metrics</code>\uff0c\u53ef\u4ee5\u627e\u5230 <code>home_temperature_celsius</code> \u6307\u6807\u4e0d\u540c\u6807\u7b7e\u7ef4\u5ea6\u4e0b\u9762\u7684\u6307\u6807\u503c\uff1a</p> <pre><code>\n...\n# HELP home_temperature_celsius The current temperature in degrees Celsius.\n# TYPE home_temperature_celsius gauge\nhome_temperature_celsius{house=\"cnych\",room=\"bedroom\"} 25.3\nhome_temperature_celsius{house=\"cnych\",room=\"living-room\"} 27\nhome_temperature_celsius{house=\"ydzs\",room=\"bedroom\"} 27.7\nhome_temperature_celsius{house=\"ydzs\",room=\"living-room\"} 24.5\n...\n</code></pre> <p>\u6ce8\u610f\uff1a\u5f53\u4f7f\u7528\u5e26\u6709\u6807\u7b7e\u7ef4\u5ea6\u7684\u6307\u6807\u65f6\uff0c\u4efb\u4f55\u6807\u7b7e\u7ec4\u5408\u7684\u65f6\u95f4\u5e8f\u5217\u53ea\u6709\u5728\u8be5\u6807\u7b7e\u7ec4\u5408\u88ab\u8bbf\u95ee\u8fc7\u81f3\u5c11\u4e00\u6b21\u540e\u624d\u4f1a\u51fa\u73b0\u5728 /metrics \u8f93\u51fa\u4e2d\uff0c\u8fd9\u5bf9\u6211\u4eec\u5728 PromQL \u67e5\u8be2\u7684\u65f6\u5019\u4f1a\u4ea7\u751f\u4e00\u4e9b\u95ee\u9898\uff0c\u56e0\u4e3a\u5b83\u5e0c\u671b\u67d0\u4e9b\u65f6\u95f4\u5e8f\u5217\u4e00\u76f4\u5b58\u5728\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u7a0b\u5e8f\u7b2c\u4e00\u6b21\u542f\u52a8\u65f6\uff0c\u5c06\u6240\u6709\u91cd\u8981\u7684\u6807\u7b7e\u7ec4\u5408\u9884\u5148\u521d\u59cb\u5316\u4e3a\u9ed8\u8ba4\u503c\u3002</p>"},{"location":"chap1/57prometheus_best_practice/","title":"\u7b2c0\u8282 Promethues \u5e94\u7528\u76d1\u63a7\u7684\u4e00\u4e9b\u5b9e\u8df5","text":"<p>\u5728\u5177\u4f53\u8bbe\u8ba1 Metrics \u4e4b\u524d\uff0c\u9996\u5148\u9700\u8981\u660e\u786e\u9700\u8981\u6d4b\u91cf\u7684\u5bf9\u8c61\u3002\u9700\u8981\u6d4b\u91cf\u7684\u5bf9\u8c61\u5e94\u8be5\u4f9d\u636e\u5177\u4f53\u7684\u95ee\u9898\u80cc\u666f\u3001\u9700\u6c42\u548c\u9700\u76d1\u63a7\u7684\u7cfb\u7edf\u672c\u8eab\u6765\u786e\u5b9a\u3002</p>"},{"location":"chap1/57prometheus_best_practice/#1","title":"1 \u4ece\u9700\u6c42\u51fa\u53d1","text":"<p>Google \u9488\u5bf9\u5927\u91cf\u5206\u5e03\u5f0f\u76d1\u63a7\u7684\u7ecf\u9a8c\u603b\u7ed3\u51fa\u56db\u4e2a\u76d1\u63a7\u7684\u9ec4\u91d1\u6307\u6807\uff0c\u8fd9\u56db\u4e2a\u6307\u6807\u5bf9\u4e8e\u4e00\u822c\u6027\u7684\u76d1\u63a7\u6d4b\u91cf\u5bf9\u8c61\u90fd\u5177\u6709\u8f83\u597d\u7684\u53c2\u8003\u610f\u4e49\u3002\u8fd9\u56db\u4e2a\u6307\u6807\u5206\u522b\u4e3a\uff1a</p> <ul> <li>\u5ef6\u8fdf\uff1a\u670d\u52a1\u8bf7\u6c42\u7684\u65f6\u95f4\u3002</li> <li>\u901a\u8baf\u91cf\uff1a\u76d1\u63a7\u5f53\u524d\u7cfb\u7edf\u7684\u6d41\u91cf\uff0c\u7528\u4e8e\u8861\u91cf\u670d\u52a1\u7684\u5bb9\u91cf\u9700\u6c42\u3002</li> <li>\u9519\u8bef\uff1a\u76d1\u63a7\u5f53\u524d\u7cfb\u7edf\u6240\u6709\u53d1\u751f\u7684\u9519\u8bef\u8bf7\u6c42\uff0c\u8861\u91cf\u5f53\u524d\u7cfb\u7edf\u9519\u8bef\u53d1\u751f\u7684\u901f\u7387\u3002</li> <li>\u9971\u548c\u5ea6\uff1a\u8861\u91cf\u5f53\u524d\u670d\u52a1\u7684\u9971\u548c\u5ea6\u3002\u4e3b\u8981\u5f3a\u8c03\u6700\u80fd\u5f71\u54cd\u670d\u52a1\u72b6\u6001\u7684\u53d7\u9650\u5236\u7684\u8d44\u6e90\u3002\u4f8b\u5982\uff0c\u5982\u679c\u7cfb\u7edf\u4e3b\u8981\u53d7\u5185\u5b58\u5f71\u54cd\uff0c\u90a3\u5c31\u4e3b\u8981\u5173\u6ce8\u7cfb\u7edf\u7684\u5185\u5b58\u72b6\u6001\u3002\u4ee5\u4e0a\u56db\u79cd\u6307\u6807\uff0c\u5176\u5b9e\u662f\u4e3a\u4e86\u6ee1\u8db3\u56db\u4e2a\u76d1\u63a7\u9700\u6c42\uff1a</li> <li>\u53cd\u6620\u7528\u6237\u4f53\u9a8c\uff0c\u8861\u91cf\u7cfb\u7edf\u6838\u5fc3\u00e5\u6027\u80fd\u3002\u5982\uff1a\u5728\u7ebf\u7cfb\u7edf\u7684\u65f6\u5ef6\uff0c\u4f5c\u4e1a\u8ba1\u7b97\u7cfb\u7edf\u7684\u4f5c\u4e1a\u5b8c\u6210\u65f6\u95f4\u7b49\u3002</li> <li>\u53cd\u6620\u7cfb\u7edf\u7684\u541e\u5410\u91cf\u3002\u5982\uff1a\u8bf7\u6c42\u6570\uff0c\u53d1\u51fa\u548c\u63a5\u6536\u7684\u7f51\u7edc\u5305\u5927\u5c0f\u7b49\u3002</li> <li>\u5e2e\u52a9\u53d1\u73b0\u548c\u5b9a\u4f4d\u6545\u969c\u548c\u95ee\u9898\u3002\u5982\uff1a\u9519\u8bef\u8ba1\u6570\u3001\u8c03\u7528\u5931\u8d25\u7387\u7b49\u3002</li> <li>\u53cd\u6620\u7cfb\u7edf\u7684\u9971\u548c\u5ea6\u548c\u8d1f\u8f7d\u3002\u5982\uff1a\u7cfb\u7edf\u5360\u7528\u7684\u5185\u5b58\u3001\u4f5c\u4e1a\u961f\u5217\u7684\u957f\u5ea6\u7b49\u3002\u9664\u4e86\u4ee5\u4e0a\u5e38\u89c4\u9700\u6c42\uff0c\u8fd8\u53ef\u6839\u636e\u5177\u4f53\u7684\u95ee\u9898\u573a\u666f\uff0c\u4e3a\u4e86\u6392\u9664\u548c\u53d1\u73b0\u4ee5\u524d\u51fa\u73b0\u8fc7\u6216\u53ef\u80fd\u51fa\u73b0\u7684\u95ee\u9898\uff0c\u786e\u5b9a\u76f8\u5e94\u7684\u6d4b\u91cf\u5bf9\u8c61\u3002\u6bd4\u5982\uff0c\u7cfb\u7edf\u9700\u8981\u7ecf\u5e38\u8c03\u7528\u7684\u4e00\u4e2a\u5e93\u7684\u63a5\u53e3\u53ef\u80fd\u8017\u65f6\u8f83\u957f\uff0c\u6216\u5076\u6709\u5931\u8d25\uff0c\u53ef\u5236\u5b9a Metrics \u4ee5\u6d4b\u91cf\u8fd9\u4e2a\u63a5\u53e3\u7684\u65f6\u5ef6\u548c\u5931\u8d25\u6570\u3002</li> </ul>"},{"location":"chap1/57prometheus_best_practice/#2","title":"2 \u4ece\u9700\u8981\u76d1\u63a7\u7684\u7cfb\u7edf\u51fa\u53d1","text":"<p>\u4e3a\u4e86\u6ee1\u8db3\u76f8\u5e94\u7684\u9700\u6c42\uff0c\u4e0d\u540c\u7cfb\u7edf\u9700\u8981\u89c2\u6d4b\u7684\u6d4b\u91cf\u5bf9\u8c61\u4e5f\u662f\u4e0d\u540c\u7684\u3002\u5728 \u5b98\u65b9\u6587\u6863 \u7684\u6700\u4f73\u5b9e\u8df5\u4e2d\uff0c\u5c06\u9700\u8981\u76d1\u63a7\u7684\u5e94\u7528\u5206\u4e3a\u4e86\u4e09\u7c7b\uff1a</p> <ul> <li>\u7ebf\u4e0a\u670d\u52a1\u7cfb\u7edf\uff08Online-serving systems\uff09\uff1a\u9700\u5bf9\u8bf7\u6c42\u505a\u5373\u65f6\u7684\u54cd\u5e94\uff0c\u8bf7\u6c42\u53d1\u8d77\u8005\u4f1a\u7b49\u5f85\u54cd\u5e94\u3002\u5982 web \u670d\u52a1\u5668\u3002</li> <li>\u7ebf\u4e0b\u8ba1\u7b97\u7cfb\u7edf\uff08Offline processing\uff09\uff1a\u8bf7\u6c42\u53d1\u8d77\u8005\u4e0d\u4f1a\u7b49\u5f85\u54cd\u5e94\uff0c\u8bf7\u6c42\u7684\u4f5c\u4e1a\u901a\u5e38\u4f1a\u8017\u65f6\u8f83\u957f\u3002\u5982\u6279\u5904\u7406\u8ba1\u7b97\u6846\u67b6 Spark \u7b49\u3002</li> <li>\u6279\u5904\u7406\u4f5c\u4e1a\uff08Batch jobs\uff09\uff1a\u8fd9\u7c7b\u5e94\u7528\u901a\u5e38\u4e3a\u4e00\u6b21\u6027\u7684\uff0c\u4e0d\u4f1a\u4e00\u76f4\u8fd0\u884c\uff0c\u8fd0\u884c\u5b8c\u6210\u540e\u4fbf\u4f1a\u7ed3\u675f\u8fd0\u884c\u3002\u5982\u6570\u636e\u5206\u6790\u7684 MapReduce \u4f5c\u4e1a\u3002\u5bf9\u4e8e\u6bcf\u4e00\u7c7b\u5e94\u7528\u5176\u901a\u5e38\u60c5\u51b5\u4e0b\u6d4b\u91cf\u7684\u5bf9\u8c61\u662f\u4e0d\u592a\u4e00\u6837\u7684\u3002\u5176\u603b\u7ed3\u5982\u4e0b\uff1a *** \u7ebf\u4e0a\u670d\u52a1\u7cfb\u7edf**\uff1a\u4e3b\u8981\u6709\u8bf7\u6c42\u3001\u51fa\u9519\u7684\u6570\u91cf\uff0c\u8bf7\u6c42\u7684\u65f6\u5ef6\u7b49\u3002</li> <li>\u7ebf\u4e0b\u8ba1\u7b97\u7cfb\u7edf\uff1a\u6700\u540e\u5f00\u59cb\u5904\u7406\u4f5c\u4e1a\u7684\u65f6\u95f4\uff0c\u76ee\u524d\u6b63\u5728\u5904\u7406\u4f5c\u4e1a\u7684\u6570\u91cf\uff0c\u53d1\u51fa\u4e86\u591a\u5c11 items\uff0c \u4f5c\u4e1a\u961f\u5217\u7684\u957f\u5ea6\u7b49\u3002</li> <li>\u6279\u5904\u7406\u4f5c\u4e1a\uff1a\u6700\u540e\u6210\u529f\u6267\u884c\u7684\u65f6\u523b\uff0c\u6bcf\u4e2a\u4e3b\u8981 stage \u7684\u6267\u884c\u65f6\u95f4\uff0c\u603b\u7684\u8017\u65f6\uff0c\u5904\u7406\u7684\u8bb0\u5f55\u6570\u91cf\u7b49\u3002 *</li> </ul> <p>\u9664\u4e86\u7cfb\u7edf\u672c\u8eab\uff0c\u6709\u65f6\u8fd8\u9700\u76d1\u63a7\u5b50\u7cfb\u7edf\uff1a</p> <ul> <li>\u4f7f\u7528\u7684\u5e93\uff08Libraries\uff09: \u8c03\u7528\u6b21\u6570\uff0c\u6210\u529f\u6570\uff0c\u51fa\u9519\u6570\uff0c\u8c03\u7528\u7684\u65f6\u5ef6\u3002</li> <li>\u65e5\u5fd7\uff08Logging\uff09\uff1a\u8ba1\u6570\u6bcf\u4e00\u6761\u5199\u5165\u7684\u65e5\u5fd7\uff0c\u4ece\u800c\u53ef\u627e\u5230\u6bcf\u6761\u65e5\u5fd7\u53d1\u751f\u7684\u9891\u7387\u548c\u65f6\u95f4\u3002</li> <li>Failures: \u9519\u8bef\u8ba1\u6570\u3002</li> <li>\u7ebf\u7a0b\u6c60\uff1a\u6392\u961f\u7684\u8bf7\u6c42\u6570\uff0c\u6b63\u5728\u4f7f\u7528\u7684\u7ebf\u7a0b\u6570\uff0c\u603b\u7ebf\u7a0b\u6570\uff0c\u8017\u65f6\uff0c\u6b63\u5728\u5904\u7406\u7684\u4efb\u52a1\u6570\u7b49\u3002</li> <li>\u7f13\u5b58\uff1a\u8bf7\u6c42\u6570\uff0c\u547d\u4e2d\u6570\uff0c\u603b\u65f6\u5ef6\u7b49\u3002</li> </ul>"},{"location":"chap1/57prometheus_best_practice/#3-label","title":"3 \u786e\u5b9a Label","text":"<p>\u5e38\u89c1 Label \u7684\u9009\u62e9\u6709\uff1a</p> <ul> <li>resource</li> <li>region</li> <li>type \u786e\u5b9a Label \u7684\u4e00\u4e2a\u91cd\u8981\u539f\u5219\u662f\uff1a<ul> <li>\u540c\u4e00\u7ef4\u5ea6 Label \u7684\u6570\u636e\u662f\u53ef\u5e73\u5747\u548c\u53ef\u52a0\u548c\u7684\uff0c\u4e5f\u5373\u5355\u4f4d\u8981\u7edf\u4e00\u3002\u5982\u98ce\u6247\u7684\u98ce\u901f\u548c\u7535\u538b\u5c31\u4e0d\u80fd\u653e\u5728\u4e00\u4e2a Label \u91cc\u3002\u6b64\u5916\uff0c\u4e0d\u5efa\u8bae\u4e0b\u5217\u505a\u6cd5\uff1a<code>my_metric{label=a} 1 my_metric{label=b} 6 my_metric{label=total} 7</code> \u5373\u5728 Label \u4e2d\u540c\u65f6\u7edf\u8ba1\u4e86\u5206\u548c\u603b\u7684\u6570\u636e\uff0c\u5efa\u8bae\u91c7\u7528 PromQL \u5728\u670d\u52a1\u5668\u7aef\u805a\u5408\u5f97\u5230\u603b\u548c\u7684\u7ed3\u679c\u3002\u6216\u8005\u7528\u53e6\u5916\u7684 Metric \u53bb\u6d4b\u91cf\u603b\u7684\u6570\u636e\u3002</li> </ul> </li> </ul>"},{"location":"chap1/57prometheus_best_practice/#4-metrics-label","title":"4 \u547d\u540d Metrics \u548c Label","text":"<p>\u597d\u7684\u547d\u540d\u80fd\u591f\u89c1\u540d\u77e5\u4e49\uff0c\u56e0\u6b64\u547d\u540d\u4e5f\u662f\u826f\u597d\u8bbe\u8ba1\u7684\u4e00\u73af\u3002</p>"},{"location":"chap1/57prometheus_best_practice/#4-1-metric","title":"4-1 Metric \u7684\u547d\u540d\uff1a","text":"<ul> <li>\u9700\u8981\u7b26\u5408 <code>pattern: a-zA-Z*:*</code></li> <li>\u5e94\u8be5\u5305\u542b\u4e00\u4e2a\u5355\u8bcd\u4f5c\u4e3a\u524d\u7f00\uff0c\u8868\u660e\u8fd9\u4e2a Metric \u6240\u5c5e\u7684\u57df\u3002\u5982\uff1a<ul> <li><code>prometheus_notifications_total</code></li> <li><code>process_cpu_seconds_total</code></li> <li><code>ipamd_request_latency</code></li> </ul> </li> <li>\u5e94\u8be5\u5305\u542b\u4e00\u4e2a\u5355\u4f4d\u7684\u5355\u4f4d\u4f5c\u4e3a\u540e\u7f00\uff0c\u8868\u660e\u8fd9\u4e2a Metric \u7684\u5355\u4f4d\u3002\u5982\uff1a<ul> <li><code>http_request_duration_seconds</code></li> <li><code>node_memory_usage_bytes</code></li> <li><code>http_requests_total (for a unit-less accumulating count)</code></li> </ul> </li> <li>\u903b\u8f91\u4e0a\u4e0e\u88ab\u6d4b\u91cf\u7684\u53d8\u91cf\u542b\u4e49\u76f8\u540c\u3002</li> <li>\u5c3d\u91cf\u4f7f\u7528\u57fa\u672c\u5355\u4f4d\uff0c\u5982 seconds\uff0cbytes\u3002\u800c\u4e0d\u662f Milliseconds, megabytes\u3002</li> </ul>"},{"location":"chap1/57prometheus_best_practice/#4-2-label","title":"4-2 Label \u7684\u547d\u540d\uff1a","text":"<p>\u4f9d\u636e\u9009\u62e9\u7684\u7ef4\u5ea6\u547d\u540d\uff0c\u5982\uff1a</p> <ul> <li>region: shenzhen/guangzhou/beijing</li> <li>owner: user1/user2/user3</li> <li>stage: extract/transform/load</li> </ul>"},{"location":"chap1/57prometheus_best_practice/#5-buckets","title":"5 Buckets\u9009\u62e9","text":"<p>\u9002\u5b9c\u7684 buckets \u80fd\u4f7f histogram \u7684\u767e\u5206\u4f4d\u6570\u8ba1\u7b97\u66f4\u52a0\u51c6\u786e\u3002</p> <p>\u7406\u60f3\u60c5\u51b5\u4e0b\uff0c\u6876\u4f1a\u4f7f\u5f97\u6570\u636e\u5206\u5e03\u5448\u9636\u68af\u72b6\uff0c\u5373\u5404\u6876\u533a\u95f4\u5185\u6570\u636e\u4e2a\u6570\u5927\u81f4\u76f8\u540c\u3002buckets \u7684\u8bbe\u8ba1\u53ef\u9075\u4ece\u5982\u4e0b\u7ecf\u9a8c\uff1a</p> <ul> <li>\u9700\u8981\u77e5\u9053\u6570\u636e\u7684\u5927\u81f4\u5206\u5e03\uff0c\u82e5\u4e8b\u5148\u4e0d\u77e5\u9053\u53ef\u5148\u7528\u9ed8\u8ba4\u6876 <code>\uff08{.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10}\uff09</code>\u6216 2 \u500d\u6570\u6876<code>\uff08{1,2,4,8\u2026}\uff09</code>\u89c2\u5bdf\u6570\u636e\u5206\u5e03\u518d\u8c03\u6574 buckets\u3002</li> <li>\u6570\u636e\u5206\u5e03\u8f83\u5bc6\u5904\u6876\u95f4\u9694\u5236\u5b9a\u7684\u8f83\u7a84\u4e00\u4e9b\uff0c\u5206\u5e03\u7a00\u758f\u5904\u53ef\u5236\u5b9a\u7684\u8f83\u5bbd\u4e00\u4e9b\u3002</li> <li>\u5bf9\u4e8e\u591a\u6570\u65f6\u5ef6\u6570\u636e\uff0c\u4e00\u822c\u5177\u6709\u957f\u5c3e\u7684\u7279\u6027\uff0c\u8f83\u9002\u5b9c\u7528\u6307\u6570\u5f62\u5f0f\u7684\u6876\uff08<code>ExponentialBuckets</code>\uff09\u3002</li> <li>\u521d\u59cb\u6876\u4e0a\u754c\u4e00\u822c\u8986\u76d610%\u5de6\u53f3\u7684\u6570\u636e\uff0c\u82e5\u4e0d\u5173\u6ce8\u5934\u90e8\u6570\u636e\u4e5f\u53ef\u4ee5\u8ba9\u521d\u59cb\u4e0a\u754c\u66f4\u5927\u4e00\u4e9b\u3002</li> <li>\u82e5\u4e3a\u4e86\u66f4\u51c6\u786e\u8ba1\u7b97\u7279\u5b9a\u767e\u5206\u4f4d\u6570\uff0c\u598290%\uff0c\u53ef\u572890%\u7684\u6570\u636e\u5904\u52a0\u5bc6\u5206\u5e03\u6876\uff0c\u5373\u51cf\u5c11\u6876\u7684\u95f4\u9694\u3002</li> </ul> <p>\u6bd4\u5982\u6211\u5728\u76d1\u63a7\u6211\u4eec\u67d0\u4e9b\u4efb\u52a1\u8017\u65f6\u7684\u65f6\u5019\uff0c\u5c31\u662f\u9009\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u4f30\u7b97\u51fa\u5927\u81f4\u7684 bucket \u53d6\u503c\uff0c\u4e0a\u7ebf\u540e\u89c2\u5bdf\u6570\u636e\u548c\u76d1\u63a7\u518d\u53bb\u8c03\u6574 bucket\uff0c \u8fd9\u6837\u7ecf\u8fc7\u51e0\u6b21\u8c03\u6574\u5e94\u8be5\u5c31\u80fd\u8c03\u6574\u5230\u6bd4\u8f83\u5408\u9002\u7684 bucket\u3002</p>"},{"location":"chap1/57prometheus_best_practice/#6-grafana","title":"6 Grafana \u4f7f\u7528\u6280\u5de7","text":""},{"location":"chap1/57prometheus_best_practice/#6-1","title":"6-1 \u67e5\u770b\u6240\u6709\u7ef4\u5ea6","text":"<p>\u5982\u679c\u4f60\u60f3\u77e5\u9053\u662f\u5426\u8fd8\u80fd\u6309\u5176\u5b83\u7ef4\u5ea6\u5206\u7ec4\uff0c\u5e76\u5feb\u901f\u67e5\u770b\u8fd8\u6709\u54ea\u4e9b\u7ef4\u5ea6\uff0c\u53ef\u91c7\u7528\u4ee5\u4e0b\u6280\u5de7\uff1a\u5728 query \u7684\u8868\u8fbe\u5f0f\u4e0a\u53ea\u4fdd\u7559\u6307\u6807\u540d\u79f0\uff0c\u4e0d\u505a\u4efb\u4f55\u8ba1\u7b97\uff0cLegend format \u4e5f\u7559\u7a7a\u3002\u8fd9\u6837\u5c31\u80fd\u663e\u793a\u51fa\u539f\u59cb\u7684 metric \u6570\u636e\u3002\u5982\u4e0b\u56fe\u6240\u793a</p> <p></p>"},{"location":"chap1/57prometheus_best_practice/#6-2","title":"6-2 \u6807\u5c3a\u8054\u52a8","text":"<p>\u5728 Settings \u9762\u677f\u4e2d\uff0c\u6709\u4e00\u4e2a Graph Tooltip \u8bbe\u7f6e\u9879\uff0c\u9ed8\u8ba4\u4f7f\u7528 Default\u3002</p> <p></p> <p>\u4e0b\u9762\u5c06\u56fe\u5f62\u5c55\u793a\u5de5\u5177\u5206\u522b\u8c03\u6574\u4e3a Shared crosshair \u548c Shared Tooltip \u770b\u770b\u6548\u679c\u3002\u53ef\u4ee5\u770b\u5230\u6807\u5c3a\u80fd\u8054\u52a8\u5c55\u793a\u4e86\uff0c\u65b9\u4fbf\u6392\u67e5\u95ee\u9898\u65f6\u786e\u8ba4 2 \u4e2a\u6307\u6807\u7684\u5173\u8054\u6027\u3002\u5c06\u56fe\u5f62\u5c55\u793a\u5de5\u5177\u8c03\u6574\u4e3a Shared Tooltip\uff1a</p> <p></p>"},{"location":"chap1/9kube-state-metrics_crd/","title":"\u7b2c\u4e5d\u8282 \u901a\u8fc7kube-state-metrics\u6dfb\u52a0CRD\u72b6\u6001\u6307\u6807","text":"<p>\u5728 Kubernetes \u4e2d\uff0c\u81ea\u5b9a\u4e49\u8d44\u6e90\uff08CRD\uff09\u662f\u4e00\u79cd\u6269\u5c55 API \u7684\u673a\u5236\uff0c\u53ef\u4ee5\u4f7f\u7528 Kubernetes APIServer \u6765\u5b58\u50a8\u548c\u7ba1\u7406\u81ea\u5b9a\u4e49\u5bf9\u8c61\u3002</p> <p>\u672c\u6587\u6211\u4eec\u5c06\u63cf\u8ff0\u5982\u4f55\u5728\u4e0d\u7f16\u5199\u81ea\u5b9a\u4e49\u8d44\u6e90\u6ce8\u518c\u8868\u548c\u81ea\u5df1\u6784\u5efa KSM \u7684\u60c5\u51b5\u4e0b\uff0c\u6839\u636e\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684\u72b6\u6001\u6765\u6dfb\u52a0\u6307\u6807\u3002</p>"},{"location":"chap1/9kube-state-metrics_crd/#_1","title":"\u914d\u7f6e","text":"<p>\u9700\u8981\u4e0b\u9762\u63cf\u8ff0\u7684 YAML \u914d\u7f6e\u6587\u4ef6\u6765\u5b9a\u4e49\u4f60\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\u548c\u8981\u8f6c\u6362\u4e3a\u6307\u6807\u7684\u5b57\u6bb5\u3002</p> <p>\u6709\u4e24\u4e2a\u53c2\u6570\u9700\u8981\u7528\u5230\uff1a</p> <ul> <li><code>--custom-resource-state-config</code> \u5728\u5185\u8054\u7684 yaml \u4e2d</li> <li><code>--custom-resource-state-config-file</code> \u6307\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u8def\u5f84</li> </ul> <p>\u5982\u679c\u63d0\u4f9b\u4e86\u4e24\u4e2a\u6807\u5fd7\uff0c\u5219\u5185\u8054\u914d\u7f6e\u5c06\u4f18\u5148\u3002</p> <p>\u5f53\u540c\u4e00\u8d44\u6e90\u5b58\u5728\u591a\u4e2a\u6761\u76ee\u65f6\uff0c<code>kube-state-metrics</code> \u5c06\u9000\u51fa\u5e76\u62a5\u9519\uff0c\u8fd9\u5305\u62ec\u5f15\u7528\u4e0d\u540c API \u7248\u672c\u7684\u914d\u7f6e\u3002</p> <p>\u9664\u4e86\u6307\u5b9a <code>--custom-resource-state-config*</code> \u6807\u5fd7\u4e4b\u5916\uff0c\u8fd8\u5e94\u8be5\u5c06\u590d\u6570\u5f62\u5f0f\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\u79cd\u7c7b\u6dfb\u52a0\u5230 <code>--resources</code> \u6807\u5fd7\u4e2d\u7684\u66b4\u9732\u8d44\u6e90\u5217\u8868\u4e2d\u3002</p> <p>\u5982\u679c\u4e0d\u6307\u5b9a <code>--resources</code>\uff0c\u90a3\u4e48 <code>kube-state-metrics</code> \u5c06\u8003\u8651\u5728 <code>--custom-resource-state-config*</code> \u4e2d\u914d\u7f6e\u7684\u6240\u6709\u5df2\u77e5\u81ea\u5b9a\u4e49\u8d44\u6e90\u548c\u6240\u6709\u53ef\u7528\u7684\u9ed8\u8ba4 kubernetes \u5bf9\u8c61\u3002</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: kube-state-metrics\n  namespace: kube-system\nspec:\n  template:\n    spec:\n      containers:\n      - name: kube-state-metrics\n        args:\n          - --custom-resource-state-config\n          -  |  # \u5728YAML\u6587\u4ef6\u4e2d\uff0c| \u5141\u8bb8\u5c06\u591a\u884c\u5b57\u7b26\u4e32\u4f5c\u4e3a\u6807\u5fd7\u503c\u4f20\u9012  # https://yaml-multiline.info\n              spec:\n                resources:\n                  - groupVersionKind:\n                      group: myteam.io\n                      version: \"v1\"\n                      kind: Foo\n                    metrics:\n                      - name: active_count\n                        help: \"Count of active Foo\"\n                        each:\n                          type: Gauge\n                          ...\n          - --resources=certificatesigningrequests,configmaps,cronjobs,daemonsets,deployments,endpoints,foos,horizontalpodautoscalers,ingresses,jobs,limitranges,mutatingwebhookconfigurations,namespaces,networkpolicies,nodes,persistentvolumeclaims,persistentvolumes,poddisruptionbudgets,pods,replicasets,replicationcontrollers,resourcequotas,secrets,services,statefulsets,storageclasses,validatingwebhookconfigurations,volumeattachments,verticalpodautoscalers\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u5c06 kube-state-metrics \u914d\u7f6e\u4e3a\u4ec5\u5728\u81ea\u5b9a\u4e49\u8d44\u6e90\u6a21\u5f0f\u4e0b\u8fd0\u884c\uff0c\u9664\u4e86\u6307\u5b9a <code>--custom-resource-state-config*</code> \u6807\u5fd7\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u5c06 <code>--custom-resource-state-only</code> \u8bbe\u7f6e\u4e3a true\u3002</p> <p>\u4f7f\u7528\u6b64\u914d\u7f6e\uff0c<code>kube-state-metrics</code> \u53ea\u4f1a\u8003\u8651\u5728 <code>--custom-resource-state-config*</code> \u4e2d\u914d\u7f6e\u7684\u5df2\u77e5\u81ea\u5b9a\u4e49\u8d44\u6e90\u3002</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: kube-state-metrics\n  namespace: kube-system\nspec:\n  template:\n    spec:\n      containers:\n      - name: kube-state-metrics\n        args:\n          - --custom-resource-state-config\n          -  |\n              spec:\n                resources:\n                  - groupVersionKind:\n                      group: myteam.io\n                      version: \"v1\"\n                      kind: Foo\n                    metrics:\n                      - name: active_count\n                        help: \"Count of active Foo\"\n                        each:\n                          type: Gauge\n                          ...\n          - --custom-resource-state-only=true\n</code></pre> <p>\u6ce8\u610f\uff1a<code>customresource_group</code>\u3001<code>customresource_version</code> \u548c <code>customresource_kind</code> \u8fd9\u51e0\u4e2a\u516c\u5171\u6807\u7b7e\u662f\u4fdd\u7559\u7684\uff0c\u5c06\u88ab <code>groupVersionKind</code>\u5b57\u6bb5\u4e2d\u7684\u503c\u8986\u76d6\u3002</p>"},{"location":"chap1/9kube-state-metrics_crd/#_2","title":"\u793a\u4f8b","text":"<p>\u4e0b\u9762\u6211\u4eec\u5c06\u5c06\u4f7f\u7528\u4ee5\u4e0b\u81ea\u5b9a\u4e49\u8d44\u6e90\u6765\u8fdb\u884c\u8bf4\u660e\uff1a</p> <pre><code>kind: Foo\napiVersion: myteam.io/vl\nmetadata:\n    annotations:\n        bar: baz\n        qux: quxx\n    labels:\n        foo: bar\n    name: foo\nspec:\n    version: v1.2.3\n    order:\n        - id: 1\n          value: true\n        - id: 3\n          value: false\n    replicas: 1\nstatus:\n    phase: Pending\n    active:\n        type-a: 1\n        type-b: 3\n    conditions:\n        - name: a\n          value: 45\n        - name: b\n          value: 66\n    sub:\n        type-a:\n            active: 1\n            ready: 2\n        type-b:\n            active: 3\n            ready: 4\n    uptime: 43.21\n</code></pre>"},{"location":"chap1/9kube-state-metrics_crd/#_3","title":"\u5355\u503c","text":"<p>\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>kind: CustomResourceStateMetrics\nspec:\n  resources:\n    - groupVersionKind:\n        group: myteam.io\n        kind: \"Foo\"\n        version: \"v1\"\n      metrics:\n        - name: \"uptime\"\n          help: \"Foo uptime\"\n          each:\n            type: Gauge\n            gauge:\n              path: [status, uptime]\n</code></pre> <p>\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u4f1a\u4ea7\u751f\u5982\u4e0b\u6240\u793a\u6307\u6807\uff1a</p> <pre><code>kube_customresource_uptime{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\"} 43.21\n</code></pre>"},{"location":"chap1/9kube-state-metrics_crd/#_4","title":"\u591a\u6307\u6807","text":"<pre><code>kind: CustomResourceStateMetrics\nspec:\n  resources:\n    - groupVersionKind:\n        group: myteam.io\n        kind: \"Foo\"\n        version: \"v1\"\n      commonLabels:   # labels can be added to all metrics from a resource\n        crd_type: \"foo\"\n      labelsFromPath:  # \u6765\u81ea path \u8def\u5f84\u7684\u6807\u7b7e\n        name: [metadata, name]  # \u76f8\u5f53\u4e8e\uff1aname=metadata.name\n      metrics:\n        - name: \"ready_count\"\n          help: \"Number Foo Bars ready\"\n          each:\n            type: Gauge\n            gauge:\n              # \u4ee5\u5bf9\u8c61\u6216\u6570\u7ec4\u4e3a\u76ee\u6807\u5c06\u751f\u6210\u6bcf\u4e2a\u5143\u7d20\u6807\u7b7e FromPath \u7684\u6307\u6807\uff0c\u5e76\u4e14\u503c\u4e0e\u6b64\u8def\u5f84\u76f8\u5173\n              path: [status, sub]\n\n              # \u5982\u679c path \u76ee\u6807\u662f\u4e00\u4e2a\u5bf9\u8c61\uff0c\u5219\u5bf9\u8c61\u7684 key \u5c06\u4f1a\u88ab\u7528\u4f5c\u6807\u7b7e\u503c\n              # StateSet \u7c7b\u578b\u4e0d\u652f\u6301\u8fd9\u4e00\u70b9\uff0c\u56e0\u4e3a\u6240\u6709\u503c\u90fd\u662ftrue\uff0c\u8fd9\u662f\u591a\u4f59\u7684\u3002\n              labelFromKey: type\n              # \u53ef\u4ee5\u89e3\u6790\u7279\u5b9a\u4e8e\u6b64\u8def\u5f84\u7684\u6807\u7b7e\u503c\n              labelsFromPath:\n                active: [active]\n              # \u8981\u7528\u4f5c\u6307\u6807\u503c\u7684\u5b9e\u9645\u5b57\u6bb5\uff0c\u5e94\u4e3a\u6570\u5b57\u3001\u5e03\u5c14\u503c\u6216 RFC3339 \u65f6\u95f4\u6233\u5b57\u7b26\u4e32\u3002\n              valueFrom: [ready]\n          commonLabels:\n            custom_metric: \"yes\"\n          labelsFromPath:\n            # \u6574\u4e2a\u5bf9\u8c61\u53ef\u4ee5\u901a\u8fc7\u524d\u7f00\u201c*\u201d\u590d\u5236\u5230\u6807\u7b7e\u4e2d\n            # *\u4efb\u4f55\u5185\u5bb9\u90fd\u5c06\u88ab\u590d\u5236\u5230\u6807\u7b7e\u4e2d\uff0c\u9996\u5148\u662f\u6392\u5e8f\u6700\u9ad8\u7684 * \u5b57\u7b26\u4e32\n            \"*\": [metadata, labels]\n            \"**\": [metadata, annotations]\n\n            # \u6216\u8005\u53ef\u4ee5\u590d\u5236\u7279\u5b9a\u5b57\u6bb5\u3002\u8fd9\u4e9b\u5b57\u6bb5\u5c06\u59cb\u7ec8\u8986\u76d6*s\u4e2d\u7684\u503c\n            name: [metadata, name]\n            foo: [metadata, labels, foo]\n</code></pre> <p>\u7136\u540e\u4f1a\u4ea7\u751f\u5982\u4e0b\u6240\u793a\u7684\u6307\u6807\uff1a</p> <pre><code>kube_customresource_ready_count{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\", active=\"1\",custom_metric=\"yes\",foo=\"bar\",name=\"foo\",bar=\"baz\",qux=\"quxx\",type=\"type-a\"} 2\nkube_customresource_ready_count{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\", active=\"3\",custom_metric=\"yes\",foo=\"bar\",name=\"foo\",bar=\"baz\",qux=\"quxx\",type=\"type-b\"} 4\n</code></pre>"},{"location":"chap1/9kube-state-metrics_crd/#_5","title":"\u6307\u6807\u7c7b\u578b","text":"<p>\u8be5\u914d\u7f6e\u652f\u6301 OpenMetrics \u89c4\u8303 \u4e2d\u7684\u4e09\u79cd\u6307\u6807\u3002\u6307\u6807\u7c7b\u578b\u7531 type \u5b57\u6bb5\u53ca\u5176\u5728\u7c7b\u578b\u7279\u5b9a\u7ed3\u6784\u4e2d\u7684\u7279\u5b9a\u914d\u7f6e\u6307\u5b9a\u3002</p>"},{"location":"chap1/9kube-state-metrics_crd/#gauge","title":"Gauge","text":"<p>Gauge \u662f\u8868\u793a\u7684\u662f\u5f53\u524d\u7684\u6d4b\u91cf\u503c\uff0c\u5982\u5f53\u524d\u4f7f\u7528\u7684\u5185\u5b58\u5b57\u8282\u6570\u6216\u961f\u5217\u4e2d\u7684\u9879\u76ee\u6570\uff0c\u5bf9\u4e8e gauge \u6765\u8bf4\uff0c\u7edd\u5bf9\u503c\u662f\u5927\u5bb6\u611f\u5174\u8da3\u7684\u4e1c\u897f\u3002\u4f8b\u5982\uff1a</p> <pre><code>kind: CustomResourceStateMetrics\nspec:\n  resources:\n    - groupVersionKind:\n        group: myteam.io\n        kind: \"Foo\"\n        version: \"v1\"\n      metrics:\n        - name: \"uptime\"\n          help: \"Foo uptime\"\n          each:\n            type: Gauge\n            gauge:\n              path: [status, uptime]  # status.uptime\n</code></pre> <p>\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u53ef\u4ee5\u4ea7\u751f\u5982\u4e0b\u6240\u793a\u7684\u6307\u6807\uff1a</p> <pre><code>kube_customresource_uptime{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\"} 43.21\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u4e0b\u7c7b\u578b\u8f6c\u6362\u3002Gauge \u751f\u6210 float64 \u7c7b\u578b\u7684\u503c\uff0c\u4f46\u81ea\u5b9a\u4e49\u8d44\u6e90\u53ef\u4ee5\u662f\u5404\u79cd\u7c7b\u578b\uff0ckube-state-metrics \u5bf9\u5f88\u591a\u7c7b\u578b\u6267\u884c\u9690\u5f0f\u7c7b\u578b\u8f6c\u6362\uff0c\u652f\u6301\u7684\u7c7b\u578b\u5305\u62ec\uff1a</p> <ul> <li>(u)int32/64\u3001int\u3001float32 \u548c byte \u8f6c\u6362\u4e3a float64</li> <li>\u5982\u679c NilIsZero \u4e3a\u771f\uff0cnil \u4e00\u822c\u4f1a\u88ab\u6620\u5c04\u4e3a 0.0\uff0c\u5426\u5219\u4f1a\u4ea7\u751f\u4e00\u4e2a\u9519\u8bef</li> <li>bool \u7c7b\u578b true \u6620\u5c04\u5230 1.0\uff0cfalse \u6620\u5c04\u5230 0.0</li> <li>\u5bf9\u4e8e\u5b57\u7b26\u4e32\uff0c\u4ee5\u4e0b\u903b\u8f91\u9002\u7528\uff1a<ul> <li>\"true\" \u548c \"yes\" \u88ab\u6620\u5c04\u4e3a 1.0\uff0c\"false\" \u548c \"no\"\u88ab\u6620\u5c04\u4e3a 0.0\uff08\u5168\u90e8\u4e0d\u533a\u5206\u5927\u5c0f\u5199\uff09</li> <li>RFC3339 \u65f6\u95f4\u88ab\u89e3\u6790\u4e3a\u6d6e\u70b9\u65f6\u95f4\u6233</li> <li>\u6700\u540e\u4f7f\u7528 https://pkg.go.dev/strconv#ParseFloat \u5c06\u5b57\u7b26\u4e32\u89e3\u6790\u4e3a\u6d6e\u70b9\u6570\uff0c\u5b83\u5e94\u8be5\u652f\u6301\u6240\u6709\u5e38\u89c1\u7684\u6570\u5b57\u683c\u5f0f\uff0c\u5982\u679c\u5931\u8d25\uff0c\u5219\u4f1a\u4ea7\u751f\u9519\u8bef</li> </ul> </li> </ul> <p>Kubernetes \u63a7\u5236\u5668\u4e0a\u7684\u72b6\u6001\u6761\u4ef6\u793a\u4f8b\uff1a</p> <pre><code>kind: CustomResourceStateMetrics\nspec:\n  resources:\n  - groupVersionKind:\n      group: myteam.io\n      kind: \"Foo\"\n      version: \"v1\"\n    labelsFromPath:\n      name:\n      - metadata\n      - name\n      namespace:\n      - metadata\n      - namespace\n    metrics:\n    - name: \"foo_status\"\n      help: \"status condition \"\n      each:\n        type: Gauge\n        gauge:\n          path: [status, conditions]\n          labelsFromPath:\n            type: [\"type\"]\n          valueFrom: [\"status\"]\n</code></pre> <p>\u8fd9\u9002\u7528\u4e8e\u6839\u636e kubernetes api (https://pkg.go.dev/k8s.io/apimachinery/pkg/apis/meta/v1#Condition) \u516c\u5f00\u72b6\u6001\u6761\u4ef6\u7684 kubernetes \u63a7\u5236\u5668 CR\uff1a</p> <pre><code>status:\n  conditions:\n    - lastTransitionTime: \"2019-10-22T16:29:31Z\"\n      status: \"True\"\n      type: Ready\n</code></pre> <p>\u53ef\u4ee5\u4ea7\u751f\u5982\u4e0b\u6240\u793a\u7684\u6307\u6807\uff1a</p> <pre><code>kube_customresource_foo_status{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\", type=\"Ready\"} 1.0\n</code></pre>"},{"location":"chap1/9kube-state-metrics_crd/#stateset","title":"StateSet","text":"<p>StateSet \u8868\u793a\u4e00\u7cfb\u5217\u76f8\u5173\u7684\u5e03\u5c14\u503c\uff0c\u4e5f\u79f0\u4e3a bitset\u3002\u5982\u679c\u9700\u8981\u5bf9 ENUM \u8fdb\u884c\u7f16\u7801\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7 StateSet \u6765\u5b8c\u6210\u3002\u4f8b\u5982\uff1a</p> <pre><code>kind: CustomResourceStateMetrics\nspec:\n  resources:\n    - groupVersionKind:\n        group: myteam.io\n        kind: \"Foo\"\n        version: \"v1\"\n      metrics:\n        - name: \"status_phase\"\n          help: \"Foo status_phase\"\n          each:\n            type: StateSet\n            stateSet:\n              labelName: phase\n              path: [status, phase]\n              list: [Pending, Bar, Baz]\n</code></pre> <p>StateSet \u7c7b\u578b\u7684\u6307\u6807\u5c06\u4e3a\u6bcf\u4e2a\u8d44\u6e90\u7684\u5217\u8868\u4e2d\u5b9a\u4e49\u7684\u6bcf\u4e2a\u503c\u751f\u6210\u4e00\u4e2a\u6307\u6807\uff0c\u5982\u679c\u8be5\u503c\u4e0e\u5217\u8868\u4e2d\u7684\u503c\u5339\u914d\uff0c\u5219\u8be5\u503c\u5c06\u4e3a 1\u3002\u4f1a\u751f\u6210\u5982\u4e0b\u6240\u793a\u7684\u6307\u6807\uff1a</p> <pre><code>kube_customresource_status_phase{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\", phase=\"Pending\"} 1\nkube_customresource_status_phase{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\", phase=\"Bar\"} 0\nkube_customresource_status_phase{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\", phase=\"Baz\"} 0\n</code></pre>"},{"location":"chap1/9kube-state-metrics_crd/#info","title":"Info","text":"<p>Info \u6307\u6807\u7528\u4e8e\u66b4\u9732\u6587\u672c\u4fe1\u606f\uff0c\u8fd9\u4e9b\u4fe1\u606f\u5728\u8fdb\u7a0b\u751f\u547d\u5468\u671f\u5185\u4e0d\u5e94\u66f4\u6539\uff0c\u5e38\u89c1\u793a\u4f8b\u662f\u5e94\u7528\u7a0b\u5e8f\u7684\u7248\u672c\u3001\u4fee\u8ba2\u63a7\u5236\u63d0\u4ea4\u548c\u7f16\u8bd1\u5668\u7684\u7248\u672c\u3002 Info \u7c7b\u578b\u7684\u6307\u6807\u7684\u503c\u59cb\u7ec8\u4e3a 1\uff0c\u4f8b\u5982\uff1a</p> <pre><code>kind: CustomResourceStateMetrics\nspec:\n  resources:\n    - groupVersionKind:\n        group: myteam.io\n        kind: \"Foo\"\n        version: \"v1\"\n      metrics:\n        - name: \"version\"\n          help: \"Foo version\"\n          each:\n            type: Info\n            info:\n              labelsFromPath:\n                version: [spec, version]\n</code></pre> <p>\u4f1a\u4ea7\u751f\u5982\u4e0b\u6240\u793a\u7684\u6307\u6807\uff1a</p> <pre><code>kube_customresource_version{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\", version=\"v1.2.3\"} 1\n</code></pre>"},{"location":"chap1/9kube-state-metrics_crd/#_6","title":"\u547d\u540d","text":"<p>\u9ed8\u8ba4\u6307\u6807\u540d\u79f0\u5e26\u6709\u524d\u7f00\u4ee5\u907f\u514d\u4e0e\u5176\u4ed6\u6307\u6807\u51b2\u7a81\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528 <code>kube_</code> \u7684\u6307\u6807\u524d\u7f00\u4e0e\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684 <code>group+version+kind</code>\u8fde\u63a5\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>metricNamePrefix</code> \u5b57\u6bb5\u8986\u76d6\u6b64\u884c\u4e3a\u3002</p> <pre><code>kind: CustomResourceStateMetrics\nspec:\n  resources:\n    - groupVersionKind: ...\n      metricNamePrefix: myteam_foos\n      metrics:\n        - name: uptime\n          ...\n</code></pre> <p>\u4f1a\u4ea7\u751f\u5982\u4e0b\u6240\u793a\u7684\u6307\u6807\uff1a</p> <pre><code>myteam_foos_uptime{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\"} 43.21\n</code></pre> <p>\u8981\u5b8c\u5168\u7701\u7565\u547d\u540d\u7a7a\u95f4\u7a7a\u95f4\u548c/\u6216\u5b50\u7cfb\u7edf\uff0c\u8bf7\u5c06\u5b83\u4eec\u8bbe\u7f6e\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff1a</p> <pre><code>kind: CustomResourceStateMetrics\nspec:\n  resources:\n    - groupVersionKind: ...\n      metricNamePrefix: \"\"\n      metrics:\n        - name: uptime\n          ...\n</code></pre> <p>\u4f1a\u4ea7\u751f\u5982\u4e0b\u7684\u6307\u6807\uff1a</p> <pre><code>uptime{customresource_group=\"myteam.io\", customresource_kind=\"Foo\", customresource_version=\"v1\"} 43.21\n</code></pre>"},{"location":"chap1/9kube-state-metrics_crd/#_7","title":"\u65e5\u5fd7","text":"<p>\u5982\u679c\u5df2\u6ce8\u518c\u6307\u6807\u8def\u5f84\u4f46\u672a\u5728\u81ea\u5b9a\u4e49\u8d44\u6e90\u4e0a\u627e\u5230\uff0c\u5219\u4f1a\u8bb0\u5f55\u9519\u8bef\u65e5\u5fd7\u3002\u5bf9\u4e8e\u67d0\u4e9b\u8d44\u6e90\uff0c\u8fd9\u53ef\u80fd\u4f1a\u4ea7\u751f\u5927\u91cf\u65e0\u7528\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u8d44\u6e90\u6216\u6307\u6807\u4e0a\u7684 errorLogV \u8bbe\u7f6e\u6307\u6807\u6216\u8d44\u6e90\u7684\u9519\u8bef\u65e5\u5fd7\u8be6\u7ec6\u7a0b\u5ea6\uff1a</p> <pre><code>kind: CustomResourceStateMetrics\nspec:\n  resources:\n    - groupVersionKind: ...\n      errorLogV: 0  # 0 = default for errors\n      metrics:\n        - name: uptime\n          errorLogV: 10  # only log at high verbosity\n</code></pre>"},{"location":"chap1/9kube-state-metrics_crd/#_8","title":"\u8def\u5f84\u8bed\u6cd5","text":"<p>Path \u8def\u5f84\u88ab\u6307\u5b9a\u4e3a\u5b57\u7b26\u4e32\u5217\u8868\uff0c\u6bcf\u4e2a\u5b57\u7b26\u4e32\u90fd\u662f\u4e00\u4e2a path \u7247\u6bb5\uff0c\u6839\u636e\u81ea\u5b9a\u4e49\u8d44\u6e90\u7684\u6570\u636e\u52a8\u6001\u89e3\u6790\u3002\u5982\u679c\u7f3a\u5c11 path \u7684\u4efb\u4f55\u90e8\u5206\uff0c\u5219\u7ed3\u679c\u4e3a\u96f6\u3002\u4f8b\u5982\uff1a</p> <pre><code># \u7b80\u5355\u8def\u5f84\u67e5\u627e\n[spec, replicas]                         # spec.replicas == 1\n\n# \u6570\u7ec4\u7d22\u5f15\n[spec, order, \"0\", value]                # spec.order[0].value = true\n\n# \u901a\u8fc7 key = value \u5728\u5217\u8868\u4e2d\u67e5\u627e\u5143\u7d20\n[status, conditions, \"[name=a]\", value]  # status.conditions[0].value = 45\n\n# \u5982\u679c\u8981\u5339\u914d\u7684\u503c\u662f\u6570\u5b57\u6216\u5e03\u5c14\u503c\uff0c\u5219\u5c06\u8be5\u503c\u4f5c\u4e3a\u6570\u5b57\u6216\u5e03\u5c14\u503c\u8fdb\u884c\u6bd4\u8f83\n[status, conditions, \"[value=66]\", name]  # status.conditions[1].name = \"b\"\n</code></pre>"},{"location":"chap1/k8s_adv39_kube_state_metrics/","title":"\u7b2c\u4e09\u8282 kube-state-metrics","text":""},{"location":"chap1/k8s_adv39_kube_state_metrics/#1","title":"1 \u6982\u8ff0","text":"<p>\u5df2\u7ecf\u6709\u4e86 <code>cadvisor</code>\u3001<code>heapster</code>\u3001<code>metric-server</code>\uff0c\u51e0\u4e4e\u5bb9\u5668\u8fd0\u884c\u7684\u6240\u6709\u6307\u6807\u90fd\u80fd\u62ff\u5230\uff0c\u4f46\u662f\u4e0b\u9762\u8fd9\u79cd\u60c5\u51b5\u5374\u65e0\u80fd\u4e3a\u529b\uff1a</p> <ul> <li>\u6211\u8c03\u5ea6\u4e86\u591a\u5c11\u4e2a <code>replicas</code>\uff1f\u73b0\u5728\u53ef\u7528\u7684\u6709\u51e0\u4e2a\uff1f</li> <li>\u591a\u5c11\u4e2a <code>Pod</code> \u662f <code>running/stopped/terminated</code> \u72b6\u6001\uff1f</li> <li><code>Pod</code> \u91cd\u542f\u4e86\u591a\u5c11\u6b21\uff1f</li> <li>\u6211\u6709\u591a\u5c11 <code>job</code> \u5728\u8fd0\u884c\u4e2d</li> </ul> <p>\u800c\u8fd9\u4e9b\u5219\u662f <code>kube-state-metrics</code> \u63d0\u4f9b\u7684\u5185\u5bb9\uff0c\u5b83\u57fa\u4e8e <code>client-go</code> \u5f00\u53d1\uff0c\u8f6e\u8be2 <code>Kubernetes API</code>\uff0c\u5e76\u5c06 <code>Kubernetes</code>\u7684\u7ed3\u6784\u5316\u4fe1\u606f\u8f6c\u6362\u4e3a<code>metrics</code>\u3002</p>"},{"location":"chap1/k8s_adv39_kube_state_metrics/#2","title":"2 \u529f\u80fd","text":"<p><code>kube-state-metrics</code> \u63d0\u4f9b\u7684\u6307\u6807\uff0c\u6309\u7167\u9636\u6bb5\u5206\u4e3a\u4e09\u79cd\u7c7b\u522b\uff1a</p> <ul> <li>1.\u5b9e\u9a8c\u6027\u8d28\u7684\uff1a<code>k8s api</code> \u4e2d <code>alpha</code> \u9636\u6bb5\u7684\u6216\u8005 <code>spec</code> \u7684\u5b57\u6bb5\u3002</li> <li>2.\u7a33\u5b9a\u7248\u672c\u7684\uff1a<code>k8s</code> \u4e2d\u4e0d\u5411\u540e\u517c\u5bb9\u7684\u4e3b\u8981\u7248\u672c\u7684\u66f4\u65b0</li> <li>3.\u88ab\u5e9f\u5f03\u7684\uff1a\u5df2\u7ecf\u4e0d\u5728\u7ef4\u62a4\u7684\u3002</li> </ul> <p>\u6307\u6807\u7c7b\u522b\u5305\u62ec\uff1a</p> <ul> <li>CronJob Metrics</li> <li>DaemonSet Metrics</li> <li>Deployment Metrics</li> <li>Job Metrics</li> <li>LimitRange Metrics</li> <li>Node Metrics</li> <li>PersistentVolume Metrics</li> <li>PersistentVolumeClaim Metrics</li> <li>Pod Metrics</li> <li>Pod Disruption Budget Metrics</li> <li>ReplicaSet Metrics</li> <li>ReplicationController Metrics</li> <li>ResourceQuota Metrics</li> <li>Service Metrics</li> <li>StatefulSet Metrics</li> <li>Namespace Metrics</li> <li>Horizontal Pod Autoscaler Metrics</li> <li>Endpoint Metrics</li> <li>Secret Metrics</li> <li>ConfigMap Metrics</li> </ul> <p>\u4ee5 <code>Pod</code> \u4e3a\u4f8b\uff1a</p> <ul> <li><code>kube_pod_info</code></li> <li><code>kube_pod_owner</code></li> <li><code>kube_pod_status_phase</code></li> <li><code>kube_pod_status_ready</code></li> <li><code>kube_pod_status_scheduled</code></li> <li><code>kube_pod_container_status_waiting</code></li> <li><code>kube_pod_container_status_terminated_reason</code></li> <li>...</li> </ul>"},{"location":"chap1/k8s_adv39_kube_state_metrics/#3","title":"3 \u4f7f\u7528:","text":"<p>\u90e8\u7f72\u6e05\u5355\u5730\u5740\uff1ahttps://github.com/kubernetes/kube-state-metrics/tree/master/kubernetes</p> <pre><code>$ cd kube-state-metrics/kubernetes\n$ tree\n.\n\u251c\u2500\u2500 kube-state-metrics-cluster-role-binding.yaml\n\u251c\u2500\u2500 kube-state-metrics-cluster-role.yaml\n\u251c\u2500\u2500 kube-state-metrics-deployment.yaml\n\u251c\u2500\u2500 kube-state-metrics-role-binding.yaml\n\u251c\u2500\u2500 kube-state-metrics-role.yaml\n\u251c\u2500\u2500 kube-state-metrics-service-account.yaml\n\u2514\u2500\u2500 kube-state-metrics-service.yaml\n\n0 directories, 7 files\n</code></pre> <p>\u4e3b\u8981\u955c\u50cf\u6709\uff1a</p> <pre><code>image: quay.io/coreos/kube-state-metrics:v1.5.0\nimage: k8s.gcr.io/addon-resizer:1.8.3\uff08\u53c2\u8003metric-server\u6587\u7ae0\uff0c\u7528\u4e8e\u6269\u7f29\u5bb9\uff09\n</code></pre> <p>\u5bf9\u4e8e<code>pod</code>\u7684\u8d44\u6e90\u9650\u5236\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff1a</p> <pre><code>200MiB memory 0.1 cores\n</code></pre> <p>\u8d85\u8fc7<code>100</code>\u8282\u70b9\u7684\u96c6\u7fa4\uff1a</p> <pre><code>2MiB  memory per node 0.001 cores per node\n</code></pre> <p><code>kube-state-metrics</code> \u505a\u8fc7\u4e00\u6b21\u6027\u80fd\u4f18\u5316\uff0c\u5177\u4f53\u5185\u5bb9\u53c2\u8003\u4e0b\u6587</p> <p>\u90e8\u7f72\u6210\u529f\u540e\uff0c<code>prometheus</code>\u7684<code>target</code>\u4f1a\u51fa\u73b0\u5982\u4e0b\u6807\u5fd7</p> <p></p> <p>\u56e0\u4e3a <code>kube-state-metrics-service.yaml</code> \u4e2d\u6709 <code>prometheus.io/scrape:'true'</code>\u6807\u8bc6\uff0c\u56e0\u6b64\u4f1a\u5c06 <code>metric</code> \u66b4\u9732\u7ed9 <code>Prometheus</code>\uff0c\u800c <code>Prometheus</code> \u4f1a\u5728 <code>kubernetes-service-endpoints</code> \u8fd9\u4e2a <code>job</code> \u4e0b\u81ea\u52a8\u53d1\u73b0<code>kube-state-metrics</code>\uff0c\u5e76\u5f00\u59cb\u62c9\u53d6 <code>metrics</code>\uff0c\u65e0\u9700\u5176\u4ed6\u914d\u7f6e\u3002</p> <p><code>kube-state-metrics-service.yaml</code></p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: kube-state-metrics\n  namespace: kube-system\n  labels:\n    k8s-app: kube-state-metrics\n  annotations:\n    prometheus.io/scrape: 'true'\nspec:\n  ports:\n  - name: http-metrics\n    port: 8080\n    targetPort: http-metrics\n    protocol: TCP\n  - name: telemetry\n    port: 8081\n    targetPort: telemetry\n    protocol: TCP\n  selector:\n    k8s-app: kube-state-metrics\n</code></pre> <pre><code>annotations:\n    prometheus.io/scrape: 'true'\n</code></pre> <p>\u4f7f\u7528 <code>kube-state-metrics</code> \u540e\u7684\u5e38\u7528\u573a\u666f\u6709\uff1a</p> <ul> <li>\u5b58\u5728\u6267\u884c\u5931\u8d25\u7684 <code>Job</code>: <code>kube_job_status_failed{job=\"kubernetes-service-endpoints\",k8s_app=\"kube-state-metrics\"}==1</code></li> <li>\u96c6\u7fa4\u8282\u70b9\u72b6\u6001\u9519\u8bef: <code>kube_node_status_condition{condition=\"Ready\",status!=\"true\"}==1</code></li> <li>\u96c6\u7fa4\u4e2d\u5b58\u5728\u542f\u52a8\u5931\u8d25\u7684 <code>Pod</code>\uff1a <code>kube_pod_status_phase{phase=~\"Failed|Unknown\"}==1</code></li> <li>\u6700\u8fd130\u5206\u949f\u5185\u6709 <code>Pod</code> \u5bb9\u5668\u91cd\u542f: <code>changes(kube_pod_container_status_restarts[30m])&gt;0</code></li> </ul> <p>\u914d\u5408\u62a5\u8b66\u53ef\u4ee5\u66f4\u597d\u5730\u76d1\u63a7\u96c6\u7fa4\u7684\u8fd0\u884c</p>"},{"location":"chap1/k8s_adv39_kube_state_metrics/#4-metric-server","title":"4 \u4e0e<code>metric-server</code>\u7684\u5bf9\u6bd4","text":"<ul> <li><code>metric-server</code>\uff08\u6216<code>heapster</code>\uff09\u662f\u4ece <code>api-server</code> \u4e2d\u83b7\u53d6 <code>cpu</code>\u3001<code>\u5185\u5b58\u4f7f\u7528\u7387</code>\u8fd9\u79cd\u76d1\u63a7\u6307\u6807\uff0c\u5e76\u628a\u4ed6\u4eec\u53d1\u9001\u7ed9\u5b58\u50a8\u540e\u7aef\uff0c\u5982 <code>influxdb</code> \u6216\u4e91\u5382\u5546\uff0c\u4ed6\u5f53\u524d\u7684\u6838\u5fc3\u4f5c\u7528\u662f\uff1a\u4e3a <code>HPA</code>\u7b49\u7ec4\u4ef6\u63d0\u4f9b\u51b3\u7b56\u6307\u6807\u652f\u6301\u3002</li> <li><code>kube-state-metrics</code> \u5173\u6ce8\u4e8e\u83b7\u53d6 <code>k8s</code> \u5404\u79cd\u8d44\u6e90\u7684\u6700\u65b0\u72b6\u6001\uff0c\u5982 <code>deployment</code> \u6216\u8005 <code>daemonset</code>\uff0c</li> <li>\u4e4b\u6240\u4ee5\u6ca1\u6709\u628a<code>kube-state-metrics</code> \u7eb3\u5165\u5230 <code>metric-server</code> \u7684\u80fd\u529b\u4e2d\uff0c\u662f\u56e0\u4e3a\u4ed6\u4eec\u7684\u5173\u6ce8\u70b9\u672c\u8d28\u4e0a\u662f\u4e0d\u4e00\u6837\u7684\u3002<code>metric-server</code>\u4ec5\u4ec5\u662f\u83b7\u53d6\u3001\u683c\u5f0f\u5316\u73b0\u6709\u6570\u636e\uff0c\u5199\u5165\u7279\u5b9a\u7684\u5b58\u50a8\uff0c\u5b9e\u8d28\u4e0a\u662f\u4e00\u4e2a\u76d1\u63a7\u7cfb\u7edf\u3002\u800c <code>kube-state-metrics</code> \u662f\u5c06 <code>k8s</code> \u7684\u8fd0\u884c\u72b6\u51b5\u5728\u5185\u5b58\u4e2d\u505a\u4e86\u4e2a\u5feb\u7167\uff0c\u5e76\u4e14\u83b7\u53d6\u65b0\u7684\u6307\u6807\uff0c\u4f46\u4ed6\u6ca1\u6709\u80fd\u529b\u5bfc\u51fa\u8fd9\u4e9b\u6307\u6807</li> <li>\u6362\u4e2a\u89d2\u5ea6\u8bb2\uff0c<code>kube-state-metrics</code> \u672c\u8eab\u662f <code>metric-server</code> \u7684\u4e00\u79cd\u6570\u636e\u6765\u6e90\uff0c\u867d\u7136\u73b0\u5728\u6ca1\u6709\u8fd9\u4e48\u505a\u3002</li> <li>\u53e6\u5916\uff0c\u50cf <code>Prometheus</code> \u8fd9\u79cd\u76d1\u63a7\u7cfb\u7edf\uff0c\u5e76\u4e0d\u4f1a\u53bb\u7528 <code>metric-server</code> \u4e2d\u7684\u6570\u636e\uff0c\u4ed6\u90fd\u662f\u81ea\u5df1\u505a\u6307\u6807\u6536\u96c6\u3001\u96c6\u6210\u7684<code>\uff08Prometheus\u5305\u542b\u4e86metric-server\u7684\u80fd\u529b\uff09</code>\uff0c\u4f46 <code>Prometheus</code> \u53ef\u4ee5\u76d1\u63a7 <code>metric-server</code> \u672c\u8eab\u7ec4\u4ef6\u7684\u76d1\u63a7\u72b6\u6001\u5e76\u9002\u65f6\u62a5\u8b66\uff0c\u8fd9\u91cc\u7684\u76d1\u63a7\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>kube-state-metrics</code> \u6765\u5b9e\u73b0\uff0c\u5982 <code>metric-server pod</code> \u7684\u8fd0\u884c\u72b6\u6001\u3002</li> </ul>"},{"location":"chap1/k8s_adv39_kube_state_metrics/#5","title":"5 \u6df1\u5165\u89e3\u6790","text":"<p><code>kube-state-metrics</code> \u672c\u8d28\u4e0a\u662f\u4e0d\u65ad\u8f6e\u8be2 <code>api-server</code>\uff0c\u4ee3\u7801\u7ed3\u6784\u4e5f\u5f88\u7b80\u5355\uff0c\u4e3b\u8981\u4ee3\u7801\u76ee\u5f55\uff1a</p> <pre><code>$ cd /kube-state-metrics/pkg/\n$ tree \n.\n\u251c\u2500\u2500 collectors\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 builder.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 collectors.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 configmap.go\n\u2502\u00a0\u00a0 ...\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 statefulset_test.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 testutils.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 testutils_test.go\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 utils.go\n\u251c\u2500\u2500 constant\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 resource_unit.go\n\u251c\u2500\u2500 metrics\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 metrics.go\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 metrics_test.go\n\u251c\u2500\u2500 metrics_store\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 metrics_store.go\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 metrics_store_test.go\n\u251c\u2500\u2500 options\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 collector.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 options.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 options_test.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 types.go\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 types_test.go\n\u251c\u2500\u2500 version\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 version.go\n\u2514\u2500\u2500 whiteblacklist\n    \u251c\u2500\u2500 whiteblacklist.go\n    \u2514\u2500\u2500 whiteblacklist_test.go\n\n7 directories, 58 files\n</code></pre> <p>\u6240\u6709\u7c7b\u578b\uff1a</p> <pre><code>$ cd /kube-state-metrics/pkg/options\n$ less collectors.go\n\npackage options\n\nimport (\n    metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n)\n\nvar (\n    DefaultNamespaces = NamespaceList{metav1.NamespaceAll}\n    DefaultCollectors = CollectorSet{\n        \"daemonsets\":               struct{}{},\n        \"deployments\":              struct{}{},\n        \"limitranges\":              struct{}{},\n        \"nodes\":                    struct{}{},\n        \"pods\":                     struct{}{},\n        \"poddisruptionbudgets\":     struct{}{},\n        \"replicasets\":              struct{}{},\n        \"replicationcontrollers\":   struct{}{},\n        \"resourcequotas\":           struct{}{},\n        \"services\":                 struct{}{},\n        \"jobs\":                     struct{}{},\n        \"cronjobs\":                 struct{}{},\n        \"statefulsets\":             struct{}{},\n        \"persistentvolumes\":        struct{}{},\n        \"persistentvolumeclaims\":   struct{}{},\n        \"namespaces\":               struct{}{},\n        \"horizontalpodautoscalers\": struct{}{},\n        \"endpoints\":                struct{}{},\n        \"secrets\":                  struct{}{},\n        \"configmaps\":               struct{}{},\n    }\n)\n</code></pre> <p>\u6784\u5efa\u5bf9\u5e94\u7684\u6536\u96c6\u5668</p> <p><code>Family</code>\u5373\u4e00\u4e2a\u7c7b\u578b\u7684\u8d44\u6e90\u96c6\u5408\uff0c\u5982 <code>job</code> \u4e0b\u7684 <code>kubejobinfo</code>\u3001<code>kubejobcreated</code>\uff0c\u90fd\u662f\u4e00\u4e2a <code>FamilyGenerator</code> \u5b9e\u4f8b</p> <pre><code>        metrics.FamilyGenerator{\n            Name: \"kube_job_info\",\n            Type: metrics.MetricTypeGauge,\n            Help: \"Information about job.\",\n            GenerateFunc: wrapJobFunc(func(j *v1batch.Job) metrics.Family {\n                return metrics.Family{&amp;metrics.Metric{\n                    Name:  \"kube_job_info\",\n                    Value: 1,\n                }}\n            }),\n        },\n\nfunc (b *Builder) buildCronJobCollector() *Collector{\n  // \u8fc7\u6ee4\u4f20\u5165\u7684\u767d\u540d\u5355\n  filteredMetricFamilies := filterMetricFamilies(b.whiteBlackList, cronJobMetricFamilies)\n  composedMetricGenFuncs := composeMetricGenFuncs(filteredMetricFamilies)\n\n  // \u5c06\u53c2\u6570\u5199\u5230header\u4e2d\n  familyHeaders := extractMetricFamilyHeaders(filteredMetricFamilies)\n\n // NewMetricsStore\u5b9e\u73b0\u4e86client-go\u7684cache.Store\u63a5\u53e3\uff0c\u5b9e\u73b0\u672c\u5730\u7f13\u5b58\u3002\n  store := metricsstore.NewMetricsStore(\n     familyHeaders,\n     composedMetricGenFuncs,\n   )\n // \u6309namespace\u6784\u5efaReflector\uff0c\u76d1\u542c\u53d8\u5316\n\n reflectorPerNamespace(b.ctx, b.kubeClient, &amp;batchv1beta1.CronJob{}, store, b.namespaces, createCronJobListWatch)\n\nreturn NewCollector(store)\n}\n\n</code></pre> <p>\u6027\u80fd\u4f18\u5316\uff1a</p> <p><code>kube-state-metrics</code> \u5728\u4e4b\u524d\u7684\u7248\u672c\u4e2d\u66b4\u9732\u51fa\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ul> <li> <ol> <li><code>/metrics</code> \u63a5\u53e3\u54cd\u5e94\u6162(10-20s)</li> </ol> </li> <li> <ol> <li>\u5185\u5b58\u6d88\u8017\u592a\u5927\uff0c\u5bfc\u81f4\u8d85\u51fa <code>limit</code> \u88ab\u6740\u6389</li> </ol> </li> </ul> <p>\u95ee\u9898\u4e00\u7684\u65b9\u6848\u5c31\u662f\u57fa\u4e8e <code>client-go</code> \u7684 <code>cache tool</code> \u5b9e\u73b0\u672c\u5730\u7f13\u5b58\uff0c\u5177\u4f53\u7ed3\u6784\u4e3a\uff1a</p> <pre><code>var cache = map[uuid][]byte{}\n</code></pre> <p>\u95ee\u9898\u4e8c\u7684\u7684\u65b9\u6848\u662f\uff1a\u5bf9\u4e8e\u65f6\u95f4\u5e8f\u5217\u7684\u5b57\u7b26\u4e32\uff0c\u662f\u5b58\u5728\u5f88\u591a\u91cd\u590d\u5b57\u7b26\u7684\uff08\u5982 <code>namespace</code> \u7b49\u524d\u7f00\u7b5b\u9009\uff09\uff0c\u53ef\u4ee5\u7528\u6307\u9488\u6216\u8005\u7ed3\u6784\u5316\u8fd9\u4e9b\u91cd\u590d\u5b57\u7b26\u3002</p>"},{"location":"chap1/k8s_adv39_kube_state_metrics/#6","title":"6 \u4f18\u5316\u70b9\u548c\u95ee\u9898","text":"<ol> <li>\u56e0\u4e3a <code>kube-state-metrics</code> \u662f\u76d1\u542c\u8d44\u6e90\u7684 <code>add</code>\u3001<code>delete</code>\u3001<code>update</code> \u4e8b\u4ef6\uff0c\u90a3\u4e48\u5728 <code>kube-state-metrics</code> \u90e8\u7f72\u4e4b\u524d\u5df2\u7ecf\u8fd0\u884c\u7684\u8d44\u6e90\uff0c\u5c82\u4e0d\u662f\u62ff\u4e0d\u5230\u6570\u636e\uff1f<ul> <li><code>kube-state-metric</code> \u5229\u7528 <code>client-go</code> \u53ef\u4ee5\u521d\u59cb\u5316\u6240\u6709\u5df2\u7ecf\u5b58\u5728\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u786e\u4fdd\u6ca1\u6709\u4efb\u4f55\u9057\u6f0f</li> </ul> </li> <li><code>kube-state-metrics</code> \u5f53\u524d\u4e0d\u4f1a\u8f93\u51fa <code>metadata</code> \u4fe1\u606f(\u5982 <code>help</code> \u548c <code>description</code>\uff09</li> <li>\u7f13\u5b58\u5b9e\u73b0\u662f\u57fa\u4e8e <code>golang</code> \u7684 <code>map</code>\uff0c\u89e3\u51b3\u5e76\u53d1\u8bfb\u95ee\u9898\u5f53\u671f\u662f\u7528\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u4e92\u65a5\u9501\uff0c\u53ef\u4ee5\u89e3\u51b3\u95ee\u9898\uff0c\u540e\u7eed\u4f1a\u8003\u8651<code>golang</code> \u7684 <code>sync.Map</code> \u5b89\u5168 <code>map</code>\u3002</li> <li><code>kube-state-metrics</code> \u901a\u8fc7\u6bd4\u8f83 <code>resource version</code> \u6765\u4fdd\u8bc1 <code>event</code> \u7684\u987a\u5e8f</li> <li><code>kube-state-metrics</code> \u5e76\u4e0d\u4fdd\u8bc1\u5305\u542b\u6240\u6709\u8d44\u6e90</li> </ol>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/","title":"2 \u4f18\u79c0\u7684Grafana K8S \u63d2\u4ef6-DevOpsProdigy KubeGraf","text":"<p>DevOpsProdigy KubeGraf \u662f\u4e00\u4e2a\u975e\u5e38\u4f18\u79c0\u7684 Grafana Kubernetes \u63d2\u4ef6\uff0c\u662f Grafana \u5b98\u65b9\u7684 Kubernetes \u63d2\u4ef6 \u7684\u5347\u7ea7\u7248\u672c\uff0c\u8be5\u63d2\u4ef6\u53ef\u4ee5\u7528\u6765\u53ef\u89c6\u5316\u548c\u5206\u6790 <code>Kubernetes</code> \u96c6\u7fa4\u7684\u6027\u80fd\uff0c\u901a\u8fc7\u5404\u79cd\u56fe\u5f62\u76f4\u89c2\u7684\u5c55\u793a\u4e86 <code>Kubernetes</code> \u96c6\u7fa4\u7684\u4e3b\u8981\u670d\u52a1\u7684\u6307\u6807\u548c\u7279\u5f81\uff0c\u8fd8\u53ef\u4ee5\u7528\u4e8e\u68c0\u67e5\u5e94\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u5468\u671f\u548c\u9519\u8bef\u65e5\u5fd7\u3002</p>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#_1","title":"\u73af\u5883\u8981\u6c42","text":"<p>\u8981\u5b89\u88c5\u4f7f\u7528 <code>DevOpsProdigy KubeGraf</code> \u63d2\u4ef6\u9700\u8981\u6ee1\u8db3\u4ee5\u4e0b\u8981\u6c42\uff1a</p> <ul> <li>Grafana &gt; 5.0.0 \u7248\u672c</li> <li>\u9700\u8981\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u4e0a\u90e8\u7f72 <code>Prometheus + node-exporter + kube-state-metrics</code></li> <li>\u4f9d\u8d56 <code>Grafana-piechart-panel</code> \u63d2\u4ef6</li> </ul>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#1-prometheus-operator","title":"1 \u5b89\u88c5 Prometheus Operator","text":"<p>\u6211\u4eec\u8fd9\u91cc\u6765\u4f7f\u7528 <code>Prometheus Operator</code>\uff0c\u8fd9\u4e2a <code>Operator</code> \u901a\u8fc7\u62bd\u8c61\u5316 <code>Prometheus</code> \u7684\u90e8\u7f72\u6765\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u52a0\u7b80\u5355\u65b9\u4fbf\u7684\u65b9\u6cd5\u6765\u4f7f\u7528 <code>Prometheus</code>\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u5728 <code>monitoring</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5b89\u88c5 <code>Prometheus Operator</code>\uff1a</p> <pre><code>kubectl create ns monitoring\n</code></pre> <ul> <li>Enable grafana with peristent volume</li> </ul> <p><code>prometheus-operator-values.yml</code></p> <pre><code># We don't need the alertmanager for this demo\nalertmanager:\n  enabled: false\n\n# This configuration means all ServiceMonitors in the namespsace will be picked up\n# Use with caution!\nprometheus: \n  prometheusSpec:\n    serviceMonitorSelectorNilUsesHelmValues: false\n    serviceMonitorSelector: {}\ngrafana:\n  persistence:\n    enabled: true\n    type: pvc\n    size: 5G\n    storageClassName: \n</code></pre>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#1-1","title":"1-1 \u5b89\u88c5","text":"<pre><code>$ cd /k8s_sap/test/k8s-prometheus-custom-scaling\n$ helm install kube-prom stable/prometheus-operator -f helm-values/prometheus-operator-values.yml --namespace monitoring\n</code></pre> <pre><code>$ kubectl get pods -n monitoring \nNAME                                                   READY   STATUS    RESTARTS   AGE\nkube-prom-grafana-6d4c5bc7f4-qzk78                     3/3     Running   0          15m\nkube-prom-kube-state-metrics-76558456fc-gfmcd          1/1     Running   0          15m\nkube-prom-prometheus-node-exporter-r72xd               1/1     Running   0          15m\nkube-prom-prometheus-opera-operator-5c7bd49d7c-5xfs9   2/2     Running   0          15m\nprometheus-kube-prom-prometheus-opera-prometheus-0     3/3     Running   1          15m\n</code></pre> <pre><code>$ kubectl get svc -n monitoring \nNAME                                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)            AGE\nkube-prom-grafana                       ClusterIP   10.102.30.65    &lt;none&gt;        80/TCP             16m\nkube-prom-kube-state-metrics            ClusterIP   10.99.95.81     &lt;none&gt;        8080/TCP           16m\nkube-prom-prometheus-node-exporter      ClusterIP   10.98.248.155   &lt;none&gt;        9100/TCP           16m\nkube-prom-prometheus-opera-operator     ClusterIP   10.107.123.72   &lt;none&gt;        8080/TCP,443/TCP   16m\nkube-prom-prometheus-opera-prometheus   ClusterIP   10.99.222.171   &lt;none&gt;        9090/TCP           16m\nprometheus-operated                     ClusterIP   None            &lt;none&gt;        9090/\n</code></pre> <pre><code>kubectl port-forward svc/grafana -n monitoring 3000:3000\nadmin\nprom-operator\n</code></pre>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#2","title":"2 \u7279\u6027","text":"<p>\u8be5\u63d2\u4ef6\u5305\u542b3\u4e2a\u4e3b\u8981\u7684\u4fe1\u606f\u9875\u9762\uff0c\u5176\u4e2d\u5305\u542b\u6709\u5173 Kubernetes \u96c6\u7fa4\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</p>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#2-1","title":"2-1 \u5e94\u7528\u6982\u8ff0","text":"<p>\u8be5\u63d2\u4ef6\u53ef\u4ee5\u663e\u793a Kubernetes \u96c6\u7fa4\u4e0a\u9762\u7684\u5e94\u7528\u7684\u4e00\u4e9b\u57fa\u672c\u76d1\u63a7\u4fe1\u606f\uff1a</p> <ul> <li>\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u56fe</li> <li><code>Kubernetes</code> \u5bf9\u8c61\u7684\u5206\u5e03</li> <li>\u53ef\u89c6\u5316\u5e94\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u5468\u671f\u548c\u57fa\u672c\u7279\u5f81\u4fe1\u606f</li> <li>\u5728\u96c6\u7fa4\u4e2d\u5141\u8bb8\u8bbf\u95ee\u7684\u670d\u52a1\u7aef\u53e3\u7684\u63cf\u8ff0\u4fe1\u606f</li> </ul> <p></p>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#2-2","title":"2-2 \u96c6\u7fa4\u72b6\u6001","text":"<ul> <li>\u96c6\u7fa4\u548c\u96c6\u7fa4\u8282\u70b9\u7684\u72b6\u6001\u4fe1\u606f</li> <li>\u76d1\u63a7\u7684\u5e94\u7528\u7a0b\u5e8f\u751f\u547d\u5468\u671f\u7684\u8be6\u7ec6\u4fe1\u606f</li> <li>\u96c6\u7fa4\u4e2d\u670d\u52a1\u6240\u5728\u4f4d\u7f6e\u7684\u53ef\u89c6\u5316</li> </ul>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#2-3","title":"2-3 \u8282\u70b9\u6982\u8ff0","text":"<ul> <li>\u96c6\u7fa4\u8282\u70b9\u4fe1\u606f</li> <li>\u5df2\u4f7f\u7528\u548c\u5df2\u5206\u914d\u8d44\u6e90\uff08\u5185\u5b58\u3001CPU \u5229\u7528\u7387\uff09\u4ee5\u53ca\u5bb9\u5668\u6570\u91cf\u7684\u4fe1\u606f</li> <li><code>Pods</code> \u7684\u7269\u7406\u5206\u5e03</li> </ul>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#2-4-dashboards","title":"2-4 Dashboards","text":"<p>\u9664\u4e86\u5728\u63d2\u4ef6\u4e3b\u9875\u4e0a\u63d0\u4f9b\u4e86\u5e38\u89c1\u7684\u4fe1\u606f\u4e4b\u5916\uff0c\u8be5\u63d2\u4ef6\u8fd8\u63d0\u4f9b\u4e86\u53e6\u59165\u4e2a<code>Dashboard</code>\u4f9b\u6211\u4eec\u6765\u8ddf\u8e2a\u96c6\u7fa4\u7684\u5404\u79cd\u6027\u80fd\u6307\u6807\u3002</p> <ul> <li>node dashboard</li> </ul> <p>\u8fd9\u662f\u4e00\u4e2a\u5e26\u6709\u8282\u70b9\u6307\u6807\u7684 <code>Dashboard</code>\uff0c\u5b83\u53ef\u4ee5\u663e\u793a\u8d44\u6e90\u7684\u4f7f\u7528\u60c5\u51b5\uff0c\u4f8b\u5982 CPU \u5229\u7528\u7387\u3001\u5185\u5b58\u6d88\u8017\u3001\u7a7a\u95f2<code>/iowait</code> \u6a21\u5f0f\u4e0b\u7684 <code>CPU</code> \u65f6\u95f4\u767e\u5206\u6bd4\u4ee5\u53ca\u78c1\u76d8\u548c\u7f51\u7edc\u7684\u72b6\u6001\u3002</p> <p></p> <ul> <li>pod dashboard</li> </ul> <p>\u53ef\u4ee5\u6839\u636e\u6240\u9009\u62e9\u7684 <code>Pod</code> \u6765\u663e\u793a\u5bf9\u5e94\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3002</p> <p></p> <ul> <li>deployments dashboard</li> </ul> <p>\u4ee5 Deployment \u4e3a\u7ef4\u5ea6\u6765\u663e\u793a\u5bf9\u5e94\u7684\u8d44\u6e90\u5bf9\u8c61\u76f8\u5173\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3002</p> <p></p> <ul> <li>statefulsets dashboard</li> <li>daemonsets dashboard</li> </ul> <p>\u4e0a\u9762\u4e09\u4e2a <code>Dashboard</code> \u663e\u793a\u4e86\u53ef\u7528/\u4e0d\u53ef\u7528\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u526f\u672c\u6570\u91cf\u4ee5\u53ca\u8fd9\u4e9b\u5e94\u7528\u7a0b\u5e8f\u7684\u5bb9\u5668\u72b6\u6001\uff0c\u8fd8\u4f1a\u8ddf\u8e2a\u5bb9\u5668\u7684\u91cd\u542f\u3002</p>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#3","title":"3 \u5b89\u88c5","text":"<p>\u6211\u4eec\u8fd9\u91cc\u7684 <code>Grafana</code> \u540c\u6837\u662f\u5b89\u88c5\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u8fdb\u5165\u5230\u5bb9\u5668\u4e2d\u8fdb\u884c\u5b89\u88c5\uff1a</p> <pre><code>$ kubectl exec -it kube-prom-grafana-6d4c5bc7f4-qzk78  -n monitoring sh -c grafana\n\n/app $  grafana-cli plugins ls\n\nRestart grafana after installing plugins . &lt;service grafana-server restart&gt;\n\nusr/share/grafana $ grafana-cli plugins install devopsprodigy-kubegraf-app\ninstalling devopsprodigy-kubegraf-app @ 1.3.0\nfrom: https://grafana.com/api/plugins/devopsprodigy-kubegraf-app/versions/1.3.0/download\ninto: /var/lib/grafana/plugins\n\n\u2714 Installed devopsprodigy-kubegraf-app successfully \n\nRestart grafana after installing plugins . &lt;service grafana-server restart&gt;\n\n\n#  \u5982\u679c\u6ca1\u6709\u5b89\u88c5 Grafana-piechart-panel \u63d2\u4ef6\u540c\u6837\u9700\u8981\u5b89\u88c5\n$ grafana-cli plugins install Grafana-piechart-panel\ninstalling Grafana-piechart-panel @ 1.4.0\nfrom: https://grafana.com/api/plugins/Grafana-piechart-panel/versions/1.4.0/download\ninto: /var/lib/grafana/plugins\n\n\u2714 Installed Grafana-piechart-panel successfully \n\nRestart grafana after installing plugins . &lt;service grafana-server restart&gt;\n</code></pre> <p>\u63d2\u4ef6\u5b89\u88c5\u5b8c\u6210\u540e\u9700\u8981\u91cd\u542f <code>Grafana</code> \u624d\u4f1a\u751f\u6548\uff0c\u6211\u4eec\u8fd9\u91cc\u662f <code>Pod</code>\uff0c\u6240\u4ee5\u76f4\u63a5\u5220\u9664 <code>Pod</code> \u91cd\u5efa\u5373\u53ef\uff08\u5f53\u7136\u524d\u63d0\u662f\u9700\u8981\u5bf9\u63d2\u4ef6\u76ee\u5f55\u505a\u597d\u6301\u4e45\u5316\uff09:</p> <pre><code>kubectl scale deployment kube-prom-grafana  --replicas=0 -n monitoring\n\nkubectl scale deployment kube-prom-grafana  --replicas=1 -n monitoring\n</code></pre> <p>Pod \u5220\u9664\u91cd\u5efa\u5b8c\u6210\u540e\u63d2\u4ef6\u5c31\u5b89\u88c5\u6210\u529f\u4e86\u3002\u7136\u540e\u901a\u8fc7\u6d4f\u89c8\u5668\u6253\u5f00 Grafana \u627e\u5230\u8be5\u63d2\u4ef6\uff0c\u70b9\u51fb enable \u542f\u7528\u63d2\u4ef6\u3002</p> <p></p>"},{"location":"chap10/28Grafana_plugin_DevOpsProdigy/#set-up-your-first-k8s-cluster-kubernetes","title":"\u70b9\u51fb <code>Set up your first k8s-cluster</code> \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Kubernetes \u96c6\u7fa4:","text":"<ul> <li>URL \u4f7f\u7528 <code>Kubernetes Service</code> \u5730\u5740\u5373\u53ef\uff1a<code>https://kubernetes.default:443</code></li> <li>Access \u8bbf\u95ee\u6a21\u5f0f\u4f7f\u7528\uff1a<code>Server(default)</code></li> <li>\u7531\u4e8e\u63d2\u4ef6\u8bbf\u95ee <code>Kubernetes</code> \u96c6\u7fa4\u7684\u5404\u79cd\u8d44\u6e90\u5bf9\u8c61\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u914d\u7f6e\u8bbf\u95ee\u6743\u9650\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u4f7f\u7528 <code>kubectl</code> \u7684 <code>kubeconfig</code> \u6765\u8fdb\u884c\u914d\u7f6e\u5373\u53ef\u3002</li> <li>\u52fe\u9009 <code>Auth</code> \u4e0b\u9762\u7684 <code>TLS Client Auth</code> \u548c <code>With CA Cert</code> \u4e24\u4e2a\u9009\u9879</li> <li>\u5176\u4e2d <code>TLS Auth Details</code> \u4e0b\u9762\u7684\u503c\u5c31\u5bf9\u5e94 <code>kubeconfig</code> \u91cc\u9762\u7684\u8bc1\u4e66\u4fe1\u606f\u3002\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u7684 <code>kubeconfig</code> \u6587\u4ef6\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a</li> </ul> <pre><code>$  cat config \napiVersion: v1\nclusters:\n- cluster:\n    certificate-authority-data: &lt;certificate-authority-data&gt;\n    server: https://kubernetes.docker.internal:6443\n  name: docker-desktop\ncontexts:\n- context:\n    cluster: docker-desktop\n    user: docker-desktop\n  name: docker-desktop\n- context:\n    cluster: docker-desktop\n    user: docker-desktop\n  name: docker-for-desktop\ncurrent-context: docker-desktop\nkind: Config\npreferences: {}\nusers:\n- name: docker-desktop\n  user:\n    client-certificate-data: &lt;client-certificate-data&gt;\n    client-key-data: &lt;client-key-data&gt;\n</code></pre> <ul> <li>\u90a3\u4e48 <code>CA Cert</code> \u7684\u503c\u5c31\u5bf9\u5e94 <code>kubeconfig</code> \u91cc\u9762\u7684 <code>&lt;certificate-authority-data&gt;</code>\u8fdb\u884c <code>base64</code> \u89e3\u7801\u8fc7\u540e\u7684\u503c\uff1b</li> <li><code>Client Cert</code> \u7684\u503c\u5bf9\u5e94 <code>&lt;client-certificate-data&gt;</code> \u8fdb\u884c <code>base64</code> \u89e3\u7801\u8fc7\u540e\u7684\u503c\uff1b</li> <li><code>Client Key</code> \u7684\u503c\u5c31\u5bf9\u5e94 <code>&lt;client-key-data&gt;</code> \u8fdb\u884c <code>base64</code> \u89e3\u7801\u8fc7\u540e\u7684\u503c\u3002</li> </ul> <p>\u5bf9\u4e8e base64 \u89e3\u7801\u63a8\u8350\u4f7f\u7528\u4e00\u4e9b\u5728\u7ebf\u7684\u670d\u52a1\uff0c\u6bd4\u5982 https://www.base64decode.org/\uff0c\u975e\u5e38\u65b9\u4fbf\u3002</p> <ul> <li>\u6700\u540e\u5728 <code>additional datasources</code> \u4e0b\u62c9\u5217\u8868\u4e2d\u9009\u62e9 <code>prometheus</code> \u7684\u6570\u636e\u6e90\u3002</li> <li>\u70b9\u51fb <code>Save &amp; Test</code> \u6b63\u5e38\u5c31\u53ef\u4ee5\u4fdd\u5b58\u6210\u529f\u4e86\u3002</li> </ul> <p>\u63d2\u4ef6\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u5728\u5de6\u4fa7\u4fa7\u8fb9\u680f\u5c31\u4f1a\u51fa\u73b0 <code>DevOpsProdigy KubeGraf</code> \u63d2\u4ef6\u7684\u5165\u53e3\uff0c\u901a\u8fc7\u63d2\u4ef6\u9875\u9762\u53ef\u4ee5\u67e5\u770b\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\u4ee5\u53ca\u76f8\u5173\u7684 <code>Dashboard</code> \u76d1\u63a7\u56fe\u8868\u3002</p> <p></p>"},{"location":"chap10/30Create_Grafana_dashboards/","title":"3 \u7528 Kubernetes darks\u8d44\u6e90\u5bf9\u8c61\u521b\u5efaGrafana Dashboard","text":"<p>\u6211\u4eec\u5728\u4f7f\u7528 <code>Grafana Dashboard</code> \u6765\u5c55\u793a\u6211\u4eec\u7684\u76d1\u63a7\u56fe\u8868\u7684\u65f6\u5019\uff0c\u5f88\u591a\u65f6\u5019\u6211\u4eec\u90fd\u662f\u53bb\u627e\u522b\u4eba\u5df2\u7ecf\u505a\u597d\u7684 <code>Dashboard</code> \u62ff\u8fc7\u6765\u6539\u4e00\u6539\uff0c\u4f46\u662f\u8fd9\u6837\u4e5f\u9020\u6210\u4e86\u5f88\u591a\u4f7f\u7528 <code>Grafana</code> \u7684\u4eba\u5458\u538b\u6839\u4e0d\u77e5\u9053\u5982\u4f55\u53bb\u81ea\u5b9a\u4e49\u4e00\u4e2a <code>Dashboard</code>\uff0c\u867d\u7136\u8fd9\u5e76\u4e0d\u662f\u5f88\u56f0\u96be\u3002\u8fd9\u91cc\u6211\u4eec\u4ecb\u7ecd\u4e00\u4e2a\u6bd4\u8f83\u65b0\u9896\uff08\u9a9a\uff09\u7684\u5de5\u5177\uff1aDARK\uff0c\u5168\u79f0 <code>Dashboards As Resources in Kubernetes</code>.\uff0c\u610f\u601d\u5c31\u662f\u901a\u8fc7 <code>Kubernetes</code> \u7684\u8d44\u6e90\u5bf9\u8c61\u6765\u5b9a\u4e49 <code>Grafana Dashboard</code>\uff0c\u5b9e\u73b0\u539f\u7406\u4e5f\u5f88\u7b80\u5355\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7 <code>CRD</code> \u6765\u5b9a\u4e49 <code>Dashboard</code>\uff0c\u7136\u540e\u901a\u8fc7\u548c <code>Grafana</code> \u7684 <code>API Token</code> \u8fdb\u884c\u4ea4\u4e92\u5b9e\u73b0 <code>Dashboard</code> \u7684 <code>CRUD</code>\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u6765\u770b\u4e0b\u5982\u4f55\u4f7f\u7528 <code>DARK</code> \u5b9a\u4e49 <code>Grafana Dashboard</code>\u3002\u9996\u5148 <code>Clone</code>\u9879\u76ee\u4ee3\u7801\uff1a</p> <pre><code>$ git clone https://github.com/K-Phoen/dark.git\n</code></pre> <p>\u7136\u540e\u5b89\u88c5 CRD \u8d44\u6e90\uff1a</p> <pre><code>$ kubectl apply -f k8s/crd.yaml\ncustomresourcedefinition.apiextensions.k8s.io/grafanadashboards.k8s.kevingomez.fr created\n</code></pre> <p>\u7136\u540e\u901a\u8fc7 <code>Secre</code>t \u5bf9\u8c61\u521b\u5efa <code>Grafana</code> \u7684 <code>API KEYS</code>\uff0c\u5728 <code>Grafana</code> \u4e3b\u754c\u9762\u4e2d\uff0c\u9009\u62e9\u5de6\u4fa7\u7684\u914d\u7f6e\u83dc\u5355 -&gt; <code>API Keys</code> \u521b\u5efa <code>API Keys</code>\uff0c\u9009\u62e9 <code>Editor</code> \u7684\u89d2\u8272</p> <p></p> <p></p> <pre><code>kubectl port-forward svc/kube-prom-grafana -n monitoring 3000:80\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u4f1a\u5f39\u51fa\u4e00\u4e2a\u5bf9\u8bdd\u6846\u663e\u793a\u5bf9\u5e94\u7684 <code>API Keys</code>\uff0c\u4f7f\u7528\u8fd9\u4e2a <code>KEY</code> \u6765\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684<code>Secret</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create secret generic dark-tokens --from-literal=grafana=&lt;\u66ff\u6362\u6210APIKEY&gt;\n</code></pre> <pre><code>kubectl create secret generic dark-tokens --from-literal=grafana=eyJrIjoiNDR4S0swU1dTNHNlS3pnMTZaUDh3OG54cXhJTGFxQ1QiLCJuIjoiZGFyay10b2tlbiIsImlkIjoxfQ==\n\nsecret/dark-tokens created\n</code></pre> <p>\u7136\u540e\u4fee\u6539 <code>k8s/cluster-role.yaml</code>\u6587\u4ef6\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: dark\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: dashboards-viewer\nrules:\n- apiGroups: [\"k8s.kevingomez.fr\"]\n  resources: [\"grafanadashboards\"]\n  verbs: [\"get\", \"watch\", \"list\"]\n- apiGroups: [\"\"]\n  resources: [\"events\"]\n  verbs: [\"create\", \"patch\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: dashboards-viewer-cluster\nsubjects:\n  - kind: ServiceAccount\n    name: dark\n    namespace: default\nroleRef:\n  kind: ClusterRole\n  name: dashboards-viewer\n  apiGroup: rbac.authorization.k8s.io\n</code></pre> <pre><code>$ kubectl apply -f cluster-role.yaml \nserviceaccount/dark created\nclusterrole.rbac.authorization.k8s.io/dashboards-viewer created\nclusterrolebinding.rbac.authorization.k8s.io/dashboards-viewer-cluster created\n</code></pre> <p>\u4fee\u6539 <code>k8s/deployment.yaml</code>\u6587\u4ef6\uff0c\u5c06 <code>GRAFANA_HOST</code> \u73af\u5883\u53d8\u91cf\u4fee\u6539\u6210\u81ea\u5df1\u7684 <code>Grafana</code> \u7684\u5730\u5740\uff0c\u7531\u4e8e\u6211\u8fd9\u91cc <code>Grafana</code> \u4e5f\u5b89\u88c5\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u7684\uff0c\u6240\u4ee5\u76f4\u63a5\u7528 <code>DNS</code> \u5f62\u5f0f\u914d\u7f6e\uff0c\u7136\u540e\u52a0\u4e0a\u4e0a\u9762\u521b\u5efa\u7684 <code>dark</code> \u8fd9\u4e2a <code>ServiceAccount</code>\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dark\n  labels:\n    app: dark\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: dark\n  template:\n    metadata:\n      labels:\n        app: dark\n    spec:\n      serviceAccountName: dark\n      containers:\n        - name: dark\n          image: kphoen/dark:latest\n          env:\n            - name: GRAFANA_HOST\n              value: http://kube-prom-grafana.monitoring:80\n            - name: GRAFANA_TOKEN\n              valueFrom:\n                secretKeyRef:\n                  key: grafana\n                  name: dark-tokens\n      volumes:\n        - name: dark-tokens\n          secret:\n            secretName: dark-tokens\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Controller\uff1a</p> <pre><code>$ kubectl apply -f deployment.yaml \ndeployment.apps/dark created\n$ kubectl get pod -l app=dark\nNAME                   READY   STATUS    RESTARTS   AGE\ndark-849776f75-zz67c   1/1     Running   0          2m39s\n</code></pre> <p>\u73b0\u5728 Controller \u5b9a\u4e49\u597d\u8fc7\u540e\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u5c31\u53ef\u4ee5\u53bb\u901a\u8fc7 <code>CRD</code> \u5bf9\u8c61\u6765\u5b9a\u4e49 <code>Grafana Dashboard</code> \u4e86\uff0c\u5982\u4e0b\u6240\u793a\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>GrafanaDashboard</code> \u5bf9\u8c61\uff0c\u5728\u5bf9\u8c61\u4e2d\u6211\u4eec\u5b8c\u5168\u5c31\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u53bb\u5b9a\u4e49\u5185\u5bb9\u4e86\uff0c\u6bd4\u5982\u5b9a\u4e49 <code>annotations</code>\u3001<code>variables</code>\u3001<code>graph</code>\u3001<code>table</code> \u90fd\u53ef\u4ee5\uff0c\u5f53\u7136\u6700\u91cd\u8981\u7684\u8fd8\u662f\u6570\u636e\u6e90\u8981\u6b63\u786e\uff0c\u4ee5\u53ca\u67e5\u8be2\u8bed\u53e5\uff1a\uff08<code>example-dashboards.yaml</code>\uff09</p> <pre><code>apiVersion: k8s.kevingomez.fr/v1\nkind: GrafanaDashboard\nmetadata:\n  name: example-dashboard\nfolder: \"Test folder\"\nspec:\n  title: Awesome dashboard\n  editable: true\n  shared_crosshair: true\n  tags: [generated, yaml]\n  auto_refresh: 10s\n  tags_annotations:\n    - name: Deployments\n      datasource: \"Prometheus\"\n      color: \"#5794F2\"\n      tags: [\"deploy\", \"production\"]\n  variables:\n    - interval:\n        name: interval\n        label: Interval\n        values: [\"30s\", \"1m\", \"5m\", \"10m\", \"30m\", \"1h\", \"6h\", \"12h\"]\n    - query:\n        name: status\n        label: HTTP status\n        datasource: Prometheus\n        request: \"label_values(prometheus_http_requests_total, code)\"\n    - const:\n        name: percentile\n        label: Percentile\n        default: 80\n        values_map:\n          50th: \"50\"\n          75th: \"75\"\n          80th: \"80\"\n          85th: \"85\"\n          90th: \"90\"\n          95th: \"95\"\n          99th: \"99\"\n    - custom:\n        name: vX\n        default: v2\n        values_map:\n          v1: v1\n          v2: v2\n  rows:\n    - name: Prometheus\n      panels:\n        - graph:\n            title: HTTP Rate\n            height: 400px\n            datasource: Prometheus\n            targets:\n              - prometheus:\n                  query: \"rate(promhttp_metric_handler_requests_total[$interval])\"\n                  legend: \"{{handler}} - {{ code }}\"\n        - graph:\n            title: Heap allocations\n            height: 400px\n            datasource: Prometheus\n            targets:\n              - prometheus:\n                  query: \"go_memstats_heap_alloc_bytes\"\n                  legend: \"{{job}}\"\n                  ref: A\n        - table:\n            title: Threads\n            datasource: Prometheus\n            targets:\n              - prometheus:\n                  query: \"go_threads\"\n            hidden_columns: [\"Time\"]\n            time_series_aggregations:\n              - label: AVG\n                type: avg\n              - label: Current\n                type: current\n        - single_stat:\n            title: Heap Allocations\n            datasource: Prometheus\n            targets:\n              - prometheus:\n                  query: 'go_memstats_heap_alloc_bytes{job=\"prometheus\"}'\n            unit: bytes\n            thresholds: [\"26000000\", \"28000000\"]\n            color: [\"value\"]\n    - name: \"Some text, because it might be useful\"\n      panels:\n        - text:\n            title: Some awesome text?\n            markdown: \"Markdown syntax help: [commonmark.org/help](https://commonmark.org/help/)\\n${percentile}\"\n        - text:\n            title: Some awesome html?\n            html: \"Some &lt;b&gt;awesome&lt;/b&gt; html?\"\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u793a\u4f8b\u6587\u4ef6\uff1a</p> <pre><code>$ kubectl apply -f example-dashboards.yaml\ngrafanadashboard.k8s.kevingomez.fr/example-dashboard created\n\n$ kubectl get dashboards\nNAME                AGE\nexample-dashboard   10s\n</code></pre> <pre><code>$ kubectl logs dark-57c5c58bf8-llxqj \nW0327 07:58:12.389816       1 client_config.go:543] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.\nI0327 07:58:12.390943       1 controller.go:87] Setting up event handlers\nI0327 07:58:12.391669       1 controller.go:118] Starting dark-controller\nI0327 07:58:12.391702       1 controller.go:121] Waiting for informer caches to sync\nI0327 07:58:12.492291       1 controller.go:126] Starting workers\nI0327 07:58:12.492380       1 controller.go:132] Started workers\nI0327 07:58:12.657649       1 controller.go:197] Successfully synced 'default/example-dashboard'\nI0327 07:58:12.658620       1 event.go:278] Event(v1.ObjectReference{Kind:\"GrafanaDashboard\", Namespace:\"default\", Name:\"example-dashboard\", UID:\"5fd1337c-1ebb-41c6-b226-eaa500862073\", APIVersion:\"k8s.kevingomez.fr/v1\", ResourceVersion:\"1221348\", FieldPath:\"\"}): type: 'Normal' reason: 'Synced' GrafanaDashboard synced successfully\n</code></pre> <p>\u5728 <code>Controller</code> \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u8d44\u6e90\u5bf9\u8c61\u521b\u5efa\u6210\u529f\u4ee5\u540e\uff0c\u73b0\u5728\u53bb <code>Grafana</code>\u9875\u9762\u4e0a\u67e5\u770b\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u65b0\u589e\u4e86\u4e00\u4e2a <code>Test folder</code> \u7684\u6587\u4ef6\u5939\u4ee5\u53ca <code>Awesome dashboard</code>\uff1a</p> <p></p> <p>\u67e5\u770b Dashboard \u5c31\u53ef\u4ee5\u770b\u5230\u548c\u4e0a\u9762 CRD \u4e2d\u5b9a\u4e49\u7684\u5404\u79cd\u56fe\u8868\u4fe1\u606f\u4e86\uff1a</p> <p></p> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u4f7f\u7528 Kubernetes \u8d44\u6e90\u5bf9\u8c61\u53bb\u5b9a\u4e49\u4e86 <code>Grafana Dashboard</code> \u4e86\uff0c\u8fd9\u79cd\u65b9\u5f0f\u6bd4\u76f4\u63a5\u5728\u9875\u9762\u4e0a\u53bb\u624b\u52a8\u914d\u7f6e\u663e\u7136\u8981\u66f4\u4f18\u96c5\uff0c\u4e5f\u7b26\u5408 <code>everything as code</code>\u7684\u601d\u60f3</p>"},{"location":"chap10/48grafana_Trickster/","title":"4 Grafana \u56fe\u8868\u52a0\u901f\u795e\u5668 - Trickster","text":"<p>Trickster(tricksterproxy.io)\u662f\u4e00\u4e2a\u7528\u4e8e http \u5e94\u7528\u7684 HTTP \u53cd\u5411\u4ee3\u7406/\u7f13\u5b58\uff0c\u4e5f\u662f\u4e00\u4e2a\u7528\u4e8e\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\u7684\u4eea\u8868\u76d8\u67e5\u8be2\u52a0\u901f\u5668\u3002</p> <p></p> <p>\u76ee\u524d Trickster \u662f\u6709\u7531 CNCF \u4f5c\u4e3a\u6c99\u76d2\u7ea7\u9879\u76ee\u8fdb\u884c\u6258\u7ba1\u7684\uff0c\u76ee\u524d Trickster v1.1 \u662f\u751f\u4ea7\u7248\u672c\uff0c\u6765\u6e90\u4e8e v1.1.x \u5206\u652f\uff0c\u4e3b\u5206\u652f\u6765\u6e90 Trickster 2.0\uff0c\u76ee\u524d\u5904\u4e8e\u6d4b\u8bd5\u9636\u6bb5\u3002</p>"},{"location":"chap10/48grafana_Trickster/#1-http","title":"1 HTTP \u53cd\u5411\u4ee3\u7406\u7f13\u5b58","text":"<p>Trickster \u662f\u4e00\u4e2a\u529f\u80fd\u9f50\u5168\u7684 HTTP \u53cd\u5411\u4ee3\u7406\u7f13\u5b58\u5de5\u5177\uff0c\u9002\u7528\u4e8e HTTP \u5e94\u7528\uff0c\u5982\u9759\u6001\u6587\u4ef6\u670d\u52a1\u5668\u548c Web API\u3002</p>"},{"location":"chap10/48grafana_Trickster/#1-1","title":"1-1 \u529f\u80fd\u4eae\u70b9","text":"<ul> <li>\u4e00\u4e2a\u72ec\u7279\u800c\u5f3a\u5927\u7684\u5e94\u7528\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u7528\u4e8e\u65f6\u95f4\u5e8f\u5217\u548c\u901a\u7528 HTTP \u7aef\u70b9</li> <li>\u652f\u6301 TLS \u548c HTTP/2 *** \u4e3a\u7f13\u5b58\u5c42\u63d0\u4f9b\u4e86\u51e0\u79cd\u9009\u62e9\uff0c\u5305\u62ec\u5185\u5b58\u3001\u6587\u4ef6\u7cfb\u7edf\u3001Redis \u548c bbolt**</li> <li>\u9ad8\u5ea6\u53ef\u5b9a\u5236\uff0c\u4f7f\u7528\u7b80\u5355\u7684 yaml \u914d\u7f6e\u8bbe\u7f6e\uff0c\u5230 HTTP \u8def\u5f84\u3002</li> <li>\u5185\u7f6e\u7684 Prometheus \u6307\u6807\u548c\u53ef\u5b9a\u5236\u7684\u5065\u5eb7\u68c0\u67e5\u7aef\u70b9\uff0c\u7528\u4e8e\u7aef\u5230\u7aef\u76d1\u63a7</li> <li>\u9ad8\u6027\u80fd\u8f6c\u53d1</li> <li>Byte \u8303\u56f4\u5185\u8bf7\u6c42\u7f13\u5b58\u548c\u52a0\u901f</li> <li>\u901a\u8fc7 OpenTelemetry \u8fdb\u884c\u5206\u5e03\u5f0f\u8ddf\u8e2a\uff0c\u652f\u6301 Jaeger \u548c Zipkin</li> <li>\u7528\u4e8e\u81ea\u5b9a\u4e49\u8bf7\u6c42\u8def\u7531\u548c\u91cd\u5199\u7684\u89c4\u5219\u5f15\u64ce</li> </ul>"},{"location":"chap10/48grafana_Trickster/#2","title":"2 \u65f6\u5e8f\u6570\u636e\u5e93\u52a0\u901f\u5668","text":"<p>Trickster \u901a\u8fc7\u6d88\u9664 TSDB \u4e0a\u7684\u5197\u4f59\u8ba1\u7b97\uff0c\u6781\u5927\u5730\u6539\u5584\u4e86\u7ec8\u7aef\u7528\u6237\u7684\u4eea\u8868\u76d8\u56fe\u8868\u6e32\u67d3\u65f6\u95f4\u3002\u7b80\u800c\u8a00\u4e4b\uff0cTrickster \u5bf9\u4e8e\u8bfb\u53d6\u91cf\u5927\u7684 Dashboard/TSDB \u73af\u5883\uff0c\u4ee5\u53ca\u90a3\u4e9b\u5177\u6709\u9ad8\u5ea6\u6807\u51c6\u5316\u6570\u636e\u96c6\u7684\u73af\u5883\uff0c\u6781\u5927\u63d0\u9ad8\u4e86\u6027\u80fd\u548c\u53ef\u6269\u5c55\u6027\u3002</p> <p>Trickster \u517c\u5bb9 Prometheus\u3001ClickHouse\u3001InfluxDB\u3001Circonus IRONdb</p>"},{"location":"chap10/48grafana_Trickster/#2-1","title":"2-1 \u5982\u4f55\u52a0\u901f\u65f6\u95f4\u5e8f\u5217","text":"<p>1. \u65f6\u95f4\u5e8f\u5217 Delta \u4ee3\u7406\u7f13\u5b58\uff0c\u5927\u591a\u6570\u4eea\u8868\u76d8\u5728\u6bcf\u6b21\u7528\u6237\u7684\u4eea\u8868\u76d8\u52a0\u8f7d\u65f6\uff0c\u4ee5\u53ca\u6bcf\u6b21\u81ea\u52a8\u5237\u65b0\u65f6\uff0c\u90fd\u4f1a\u5411\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\u8bf7\u6c42\u4ed6\u4eec\u5e0c\u671b\u5448\u73b0\u7684\u6574\u4e2a\u6570\u636e\u65f6\u95f4\u8303\u56f4\u3002</p> <p>Trickster \u7684 Delta Proxy \u4f1a\u68c0\u67e5\u5ba2\u6237\u7aef\u67e5\u8be2\u7684\u65f6\u95f4\u8303\u56f4\uff0c\u4ee5\u786e\u5b9a\u54ea\u4e9b\u6570\u636e\u70b9\u5df2\u7ecf\u88ab\u7f13\u5b58\uff0c\u5e76\u4ece tsdb \u4e2d\u53ea\u8bf7\u6c42\u4ecd\u7136\u9700\u8981\u670d\u52a1\u4e8e\u5ba2\u6237\u7aef\u8bf7\u6c42\u7684\u6570\u636e\u70b9\u3002</p> <p>\u8fd9\u6837\u4e00\u6765\uff0c\u6bcf\u4e2a\u4eba\u7684\u56fe\u8868\u52a0\u8f7d\u65f6\u95f4\u90fd\u4f1a\u5927\u5927\u52a0\u5feb\uff0c\u56e0\u4e3a tsdb \u5728\u6bcf\u6b21\u52a0\u8f7d\u4eea\u8868\u76d8\u65f6\u53ea\u67e5\u8be2\u5fae\u5c0f\u7684\u589e\u91cf\u53d8\u5316\uff0c\u800c\u4e0d\u662f\u51e0\u767e\u4e2a\u6570\u636e\u70b9\u7684\u91cd\u590d\u6570\u636e\u3002</p> <p></p> <p>2. \u8fb9\u754c\u6807\u51c6\u5316\uff0c\u5f53 Trickster \u4ece tsdb \u8bf7\u6c42\u6570\u636e\u65f6\uff0c\u5b83\u4f1a\u7a0d\u5fae\u8c03\u6574\u5ba2\u6237\u8bf7\u6c42\u7684\u65f6\u95f4\u8303\u56f4\uff0c\u4ee5\u786e\u4fdd\u8fd4\u56de\u7684\u6240\u6709\u6570\u636e\u70b9\u90fd\u4e0e\u6807\u51c6\u5316\u7684\u6b65\u957f\u8fb9\u754c\u4e00\u81f4\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u6b65\u957f\u4e3a 300s\uff0c\u6240\u6709\u6570\u636e\u70b9\u5c06\u843d\u5728\u65f6\u949f 0 \u548c 5 \u4e0a\u3002\u8fd9\u786e\u4fdd\u4e86\u6570\u636e\u7684\u9ad8\u5ea6\u53ef\u7f13\u5b58\u6027\uff0c\u4ee5\u66f4\u76f4\u89c2\u5730\u4f20\u8fbe\u7ed9\u7528\u6237\uff0c\u5e76\u4e14\u6240\u6709\u4eea\u8868\u76d8\u7528\u6237\u5728\u5c4f\u5e55\u4e0a\u770b\u5230\u7684\u6570\u636e\u90fd\u662f\u76f8\u540c\u7684\u3002</p> <p></p> <p>3. Fast Forward\uff0cTrickster \u7684 Fast Forward \u529f\u80fd\u786e\u4fdd\u4e86\u5373\u4f7f\u5728\u6b65\u957f\u8fb9\u754c\u7edf\u4e00\u7684\u60c5\u51b5\u4e0b\uff0c\u5b9e\u65f6\u56fe\u8868\u4ecd\u7136\u603b\u662f\u663e\u793a\u6700\u65b0\u7684\u6570\u636e\uff0c\u800c\u4e0d\u7ba1\u4e0b\u4e00\u4e2a\u6b65\u957f\u8fb9\u754c\u6709\u591a\u8fdc\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u7684\u56fe\u8868\u6b65\u957f\u662f 300s\uff0c\u800c\u65f6\u95f4\u76ee\u524d\u662f 1:21p\uff0c\u901a\u5e38\u4f60\u4f1a\u5728 1:25p \u518d\u7b49 4 \u5206\u949f\u624d\u6709\u65b0\u7684\u6570\u636e\u70b9\u3002Trickster \u4f1a\u6253\u7834\u6700\u8fd1\u6570\u636e\u70b9\u7684\u6b65\u957f\u95f4\u9694\uff0c\u5e76\u59cb\u7ec8\u5c06\u5176\u5305\u542b\u5728\u5bf9\u5ba2\u6237\u8bf7\u6c42\u5b9e\u65f6\u6570\u636e\u7684\u54cd\u5e94\u4e2d\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7 https://helm.tricksterproxy.io/ \u5728 Kubernetes \u4e2d\u8fdb\u884c\u5b89\u88c5\u3002</p>"},{"location":"chap10/58grafana_init/","title":"1 \u4f7f\u7528 Grafana \u6784\u5efa\u4f60\u7684\u7b2c\u4e00\u4e2a\u4eea\u8868\u76d8","text":"<p>\u65f6\u5e38\u5bf9\u4e00\u4e9b\u5de5\u5177\u7684\u5b58\u5728\u89c9\u5f97\u7406\u6240\u5f53\u7136\u3002\u6bd4\u5982\u8bf4\uff0c\u9700\u8981\u8ba1\u7b97\u8d44\u6e90\u7684\u65f6\u5019\uff0c\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u5c31\u53ef\u4ee5\u8981\u6765\u4e24\u767e\u53f0\u865a\u62df\u5316\u597d\u7684\u673a\u5b50\u3002\u9700\u8981\u8bd5\u4e0b\u7f13\u5b58\uff1f\u70b9\u4e0b\u9f20\u6807\u5c31\u53ef\u4ee5\u8981\u5230\u51e0\u5341\u4e2a\u914d\u7f6e\u597d\u7684 Redis \u7ed3\u70b9\u3002\u6700\u7701\u5fc3\u7684\u662f\uff0c\u8fd9\u4e9b\u5de5\u5177\u90fd\u5df2\u7ecf\u6839\u636e\u5de5\u4f5c\u6d41\u914d\u7f6e\u597d\u4e86\uff1a\u9274\u6743\u3001\u4f18\u5316\u3001\u7f51\u7edc\u8fde\u63a5\u7b49\u7b49\u901a\u901a\u4e0d\u7528\u4f60\u64cd\u5fc3\u3002</p> <p>\u62ff Grafana \u548c\u670d\u52a1\u76d1\u63a7\u6765\u8bf4\uff1a</p> <ul> <li>\u670d\u52a1\u76d1\u63a7\u5230\u5e95\u548b\u914d\u7f6e\uff1f\u600e\u6837\u4fdd\u8bc1\u6570\u636e\u5b89\u5168\uff1f</li> <li>\u4fdd\u8bc1\u5065\u5eb7\u7684\u670d\u52a1\u5230\u5e95\u5e94\u8be5\u76d1\u63a7\u4e9b\u4ec0\u4e48\uff1f</li> <li>\u914d\u7f6e\u597d\u540e\u7684\u4eea\u8868\u76d8\u4e3a\u5565\u6d88\u5931\u4e86\uff1f</li> <li>\u67e5\u8be2 Query \u53c8\u8be5\u548b\u5199\uff1f</li> </ul>"},{"location":"chap10/58grafana_init/#1-grafana_1","title":"1 Grafana \u662f\u4ec0\u4e48","text":"<p>\u5f00\u59cb\u524d\u9996\u5148\u8981\u95ee\u4e00\u4e2a\u95ee\u9898\uff0cGrafana \u5230\u5e95\u662f\u4ec0\u4e48\u3002</p> <p>Grafana \u662f\u4e00\u4e2a\u76d1\u63a7\u4eea\u8868\u7cfb\u7edf\uff0c\u5b83\u662f\u7531 Grafana Labs \u516c\u53f8\u5f00\u6e90\u7684\u7684\u4e00\u4e2a\u7cfb\u7edf\u76d1\u6d4b (System Monitoring) \u5de5\u5177\u3002\u5b83\u53ef\u4ee5\u5927\u5927\u5e2e\u52a9\u4f60\u7b80\u5316\u76d1\u63a7\u7684\u590d\u6742\u5ea6\uff0c\u4f60\u53ea\u9700\u8981\u63d0\u4f9b\u4f60\u9700\u8981\u76d1\u63a7\u7684\u6570\u636e\uff0c\u5b83\u5c31\u53ef\u4ee5\u5e2e\u4f60\u751f\u6210\u5404\u79cd\u53ef\u89c6\u5316\u4eea\u8868\u3002\u540c\u65f6\u5b83\u8fd8\u6709\u62a5\u8b66\u529f\u80fd\uff0c\u53ef\u4ee5\u5728\u7cfb\u7edf\u51fa\u73b0\u95ee\u9898\u65f6\u901a\u77e5\u4f60\u3002</p> <p>Grafana \u4e0d\u5bf9\u6570\u636e\u6e90\u4f5c\u5047\u8bbe\uff0c\u5b83\u652f\u6301\u4ee5\u4e0b\u5404\u79cd\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u8bf4\u5982\u679c\u4f60\u7684\u6570\u636e\u6e90\u662f\u4ee5\u4e0b\u4efb\u610f\u4e00\u79cd\uff0c\u5b83\u90fd\u53ef\u4ee5\u5e2e\u52a9\u751f\u6210\u4eea\u8868\u3002\u540c\u65f6\u5728\u5e02\u9762\u4e0a\uff0c\u5982\u679c Grafana \u79f0\u7b2c\u4e8c\uff0c\u90a3\u4e48\u5e94\u8be5\u6ca1\u6709\u6562\u79f0\u7b2c\u4e00\u7684\u4eea\u8868\u53ef\u89c6\u5316\u5de5\u5177\u4e86\u3002\u56e0\u6b64\uff0c\u5982\u679c\u4f60\u641e\u5b9a\u4e86 Grafana\uff0c\u5b83\u51e0\u4e4e\u662f\u4e00\u4e2a\u4f1a\u966a\u4f34\u4f60\u5230\u5404\u4e2a\u516c\u53f8\u7684\u4e00\u4ef6\u79f0\u5fc3\u5e94\u624b\u7684\u5175\u5668\u3002</p> <p>Grafana \u652f\u6301\u7684\u6570\u636e\u6e90</p> <ul> <li>Prometheus \u672c\u6587\u4e2d\u7684\u4f8b\u5b50\uff0c\u4f60\u6ca1\u542c\u8fc7\u4e5f\u6ca1\u5173\u7cfb\u4e0d\u5f71\u54cd\u9605\u8bfb\uff0c\u628a\u5b83\u60f3\u8c61\u6210\u5e26\u65f6\u95f4\u6233\u7684 MySQL \u5c31\u597d</li> <li>Graphite</li> <li>OpenTSDB</li> <li>InfluxDB</li> <li>MySQL/PostgreSQL</li> <li>Microsoft SQL Server</li> <li>\u7b49\u7b49</li> </ul>"},{"location":"chap10/58grafana_init/#1-1-grafana","title":"1-1 \u4ec0\u4e48\u60c5\u51b5\u4e0b\u4f1a\u7528\u5230 Grafana","text":"<p>\u5728\u4efb\u4f55\u9700\u8981\u76d1\u63a7\u7cfb\u7edf\u8fd0\u884c\u72b6\u51b5\u7684\u5730\u65b9\u5c31\u5927\u6982\u7387\u4f1a\u7528\u5230\u4eea\u8868\u76d8\uff0c\u800c\u7528\u5230\u4eea\u8868\u76d8\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u7528 Grafana \uff08\u4e0d\u7ba1\u4f60\u7528\u4ec0\u4e48\u8bed\u8a00\uff09</p>"},{"location":"chap10/58grafana_init/#1-2-grafana","title":"1-2 \u5b89\u88c5\u548c\u914d\u7f6e Grafana","text":"<p>\u4e3a\u4e86\u7b80\u5316\u5404\u79cd\u7cfb\u7edf\u4e0d\u4e00\u81f4\u7684\u4e71\u4e03\u516b\u7cdf\u95ee\u9898\uff0c\u6211\u4eec\u7528 Docker \u6765\u5b89\u88c5 Grafana\u3002</p> <p>Docker \u7684\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff0c\u5c31\u7b97\u4f60\u4ece\u6765\u6ca1\u7528\u8fc7 docker \u4e5f\u4e0d\u7528\u64cd\u5fc3\uff0c\u6211\u4f1a\u5728\u4e0b\u6587\u91cc\u4e00\u884c\u4e00\u884c\u8bb2\u660e\u767d\u3002\u8bf7\u4e0d\u8981\u590d\u5236\u7c98\u8d34\u4ee3\u7801\uff0c\u76f4\u63a5\u5230\u672c\u6587\u7684 GitHub \u9875 clone \u4ee3\u7801\u5373\u53ef\uff0c\u6211\u4f1a\u4fdd\u8bc1 GitHub \u4e0a\u7684\u4ee3\u7801\u5904\u7406\u6700\u65b0\u72b6\u6001\uff1ahttps://github.com/Kalasearch/grafana-tutorial</p> <pre><code>version: '3.4'\nservices:\n  prometheus: \n    image: prom/prometheus\n    container_name: prometheus\n    hostname: prometheus\n    ports:\n      - 9090:9090\n    volumes:\n      - ./prometheus.yml:/etc/prometheus/prometheus.yml\n  prometheus-exporter:\n    image: prom/node-exporter\n    container_name: prometheus-exporter\n    hostname: prometheus-exporter\n    ports:\n      - 9100:9100\n  grafana:\n    image: grafana/grafana\n    container_name: grafana\n    hostname: grafana\n    ports:\n      - 3000:3000\n    volumes:\n      - ./grafana.ini:/etc/grafana/grafana.ini\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u542f\u52a8\u4e86\u4e09\u4e2a\u670d\u52a1</p> <ul> <li>Prometheus \u666e\u7f57\u7c73\u4fee\u65af\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u7528\u6765\u5b58\u50a8\u548c\u67e5\u8be2\u4f60\u7684\u76d1\u63a7\u6570\u636e</li> <li>Promethues-exporter \u4e00\u4e2a\u6a21\u62df\u6570\u636e\u6e90\uff0c\u7528\u6765\u76d1\u63a7\u4f60\u672c\u673a\u7684\u72b6\u6001\uff0c\u6bd4\u5982\u6709\u51e0\u4e2a CPU\uff0cCPU \u7684\u8d1f\u8f7d\u4e4b\u7c7b</li> <li>Grafana \u672c\u5c0a</li> </ul> <p>\u5728 clone \u4e86\u4ee3\u7801\u4e4b\u540e\uff0c\u5728\u4f60\u7684\u672c\u5730\u8fd0\u884c <code>docker-compose up</code>\uff0c\u5e94\u8be5\u4f1a\u770b\u5230\u7c7b\u4f3c\uff1a</p> <p>\u5728\u8dd1\u8d77\u6765\u670d\u52a1\u4e4b\u540e\uff0c\u5230\u4f60\u7684\u6d4f\u89c8\u5668\u4e2d\uff0c\u590d\u5236 <code>http://localhost:3000</code>\u5e94\u8be5\u5c31\u53ef\u4ee5\u770b\u5230 Grafana \u8dd1\u8d77\u6765\u7684\u521d\u59cb\u767b\u5f55\u754c\u9762\u3002\u521d\u59cb\u7684\u7528\u6237\u540d\u662f admin\uff0c\u5bc6\u7801\u4e5f\u662f admin\u3002\u8f93\u5165\u4e4b\u540e\uff0c\u4f1a\u8981\u6c42\u4f60\u6539\u5bc6\u7801</p> <p></p> <p>\u5230\u8fd9\u91cc\uff0c\u4f60\u7684 Grafana \u5c31\u5df2\u7ecf\u642d\u8d77\u6765\u4e86\u3002\u6ce8\u610f\u5230 Docker \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u521b\u5efa\u4e86\u4e09\u4e2a\u670d\u52a1\uff0c\u8fd9\u4e09\u4e2a\u670d\u52a1\u4e4b\u95f4\u5206\u522b\u6709\u4ec0\u4e48\u5173\u7cfb\u5462\uff1f</p>"},{"location":"chap10/58grafana_init/#2-grfana","title":"2 Grfana \u5de5\u4f5c\u539f\u7406","text":"<p>\u4e0a\u9762\u8bf4\u5230\uff0cGrafana \u662f\u4e00\u4e2a\u4eea\u8868\u76d8\uff0c\u800c\u4eea\u8868\u76d8\u5fc5\u7136\u662f\u7528\u6765\u663e\u793a\u6570\u636e\u7684\u3002</p> <p>Grafana \u672c\u8eab\u5e76\u4e0d\u8d1f\u8d23\u6570\u636e\u5c42\uff0c\u5b83\u53ea\u63d0\u4f9b\u4e86\u901a\u7528\u7684\u63a5\u53e3\uff0c\u8ba9\u5e95\u5c42\u7684\u6570\u636e\u5e93\u53ef\u4ee5\u628a\u6570\u636e\u7ed9\u5b83\u3002\u800c\u6211\u4eec\u8d77\u7684\u53e6\u4e00\u4e2a\u670d\u52a1\uff0c\u53eb Prometheus \uff08\u4e2d\u6587\u540d\u666e\u7f57\u7c73\u4fee\u65af\u6570\u636e\u5e93\uff09\u5219\u662f\u8d1f\u8d23\u5b58\u50a8\u548c\u67e5\u8be2\u6570\u636e\u7684\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0cGrafana \u6bcf\u6b21\u8981\u5c55\u73b0\u4e00\u4e2a\u4eea\u8868\u76d8\u7684\u65f6\u5019\uff0c\u4f1a\u5411 Prometheus \u53d1\u9001\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u3002</p> <p>\u90a3\u4e48\u914d\u7f6e\u91cc\u7684\u53e6\u4e00\u4e2a\u670d\u52a1 Prometheus-exporter \u53c8\u662f\u4ec0\u4e48\u5462\uff1f</p> <p>\u8fd9\u4e2a\u5c31\u662f\u4f60\u771f\u6b63\u76d1\u6d4b\u7684\u6570\u636e\u6765\u6e90\u4e86\uff0cPrometheus-exporter \u8fd9\u4e2a\u670d\u52a1\uff0c\u4f1a\u67e5\u8be2\u4f60\u7684\u672c\u5730\u7535\u8111\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\u5185\u5b58\u8fd8\u6709\u591a\u5c11\u3001CPU \u8d1f\u8f7d\u4e4b\u7c7b\uff0c\u7136\u540e\u5c06\u6570\u636e\u5bfc\u51fa\u81f3\u666e\u7f57\u7c73\u4fee\u65af\u6570\u636e\u5e93\u3002</p> <p>\u5728\u771f\u5b9e\u4e16\u754c\u4e2d\uff0c\u4f60\u7684\u76ee\u7684\u662f\u76d1\u63a7\u4f60\u81ea\u5df1\u7684\u670d\u52a1\uff0c\u6bd4\u5982\u4f60\u7684 Web \u670d\u52a1\u5668\uff0c\u4f60\u7684\u6570\u636e\u5e93\u4e4b\u7c7b\u3002</p> <p>\u90a3\u4e48\u4f60\u5c31\u9700\u8981\u5728\u4f60\u81ea\u5df1\u7684\u670d\u52a1\u5668\u4e2d\u628a\u6570\u636e\u53d1\u9001\u7ed9\u666e\u7f57\u7c73\u4fee\u65af\u6570\u636e\u5e93\u3002\u5f53\u7136\uff0c\u4f60\u5b8c\u5168\u53ef\u4ee5\u628a\u6570\u636e\u53d1\u9001\u7ed9 MySQL (Grafana \u4e5f\u652f\u6301)\uff0c\u4f46\u666e\u7f57\u7c73\u4fee\u65af\u51e0\u4e4e\u662f\u6807\u914d\u7684\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u5f3a\u70c8\u5efa\u8bae\u4f60\u7528\u3002</p> <p>\u7528\u4e00\u5f20\u56fe\u6765\u8bf4\u660e\u5b83\u4eec\u4e4b\u95f4\u7684\u5173\u7cfb\uff1a</p> <p></p> <p>\u8fd9\u91cc\uff0c\u6700\u5de6\u8fb9\u7684 Docker \u670d\u52a1\u4f1a\u5c06\u670d\u52a1\u7684\u6570\u636e\u53d1\u9001\u7ed9\u4e2d\u95f4\u7684\u666e\u7f57\u7c73\u4fee\u65af\uff08\u5bf9\u5e94\u4e0a\u6587\u7684 Prometheus-exporter\uff09\uff0c\u800c\u6700\u53f3\u8fb9\u7684 Grafana \u4f1a\u67e5\u8be2\u4e2d\u95f4\u7684\u666e\u7f57\u7c73\u4fee\u65af\uff0c\u6765\u5c55\u793a\u4eea\u8868\u76d8\u3002</p>"},{"location":"chap10/58grafana_init/#2","title":"2 \u642d\u5efa\u4f60\u7684\u7b2c\u4e00\u4e2a\u4eea\u8868\u76d8","text":""},{"location":"chap10/58grafana_init/#2-1-1-","title":"2-1 \u7b2c 1 \u6b65 - \u8bbe\u7f6e\u6570\u636e\u6e90","text":"<p>\u8fdb\u5165 Grafana \u540e\uff0c\u5728\u5de6\u4fa7\u4f60\u4f1a\u53d1\u73b0\u6709\u4e00\u4e2a Data Source \u5373\u6570\u636e\u6e90\u9009\u9879</p> <p></p> <p>\u70b9\u51fb\u540e\u8fdb\u5165\uff0c\u70b9 Add Data Source \u5373\u6dfb\u52a0\u6570\u636e\u6e90\uff0c\u9009\u62e9 Prometheus</p> <p></p> <p>\u4e4b\u540e\u8bbe\u7f6e\u6570\u636e\u6e90 URL\u3002\u8bf7\u6ce8\u610f\uff0cPromethues \u7684\u5de5\u4f5c\u539f\u7406\uff08\u4e0b\u4e00\u4e2a\u6559\u7a0b\u4e2d\u4f1a\u8bb2\uff09\u662f\u901a\u8fc7\u8f6e\u8be2\u4e00\u4e2a HTTP \u8bf7\u6c42\u6765\u83b7\u53d6\u6570\u636e\u7684\uff0c\u800c Grafana \u5728\u83b7\u53d6\u6570\u636e\u6e90\u7684\u65f6\u5019\u4e5f\u662f\u901a\u8fc7\u4e00\u4e2a HTTP \u8bf7\u6c42\uff0c\u56e0\u6b64\u8fd9\u4e2a\u5730\u65b9\u4f60\u9700\u8981\u544a\u8bc9 Grafana \u4f60\u7684 Prometheus \u7684\u6570\u636e\u7aef\u70b9\u662f\u4ec0\u4e48\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u586b\u5165 http://prometheus:9090 \u5c31\u53ef\u4ee5\u4e86\u3002</p> <p></p> <p>\u70b9\u786e\u8ba4\u65f6\u4e00\u5b9a\u8981\u786e\u8ba4\u51fa\u73b0 <code>Data source is working</code> \u8fd9\u4e2a\u68c0\u6d4b\uff0c\u8fd9\u65f6\u8868\u660e\u4f60\u7684 Grafana \u5df2\u7ecf\u8ddf\u666e\u7f57\u7c73\u4fee\u65af\u8bf4\u4e0a\u8bdd\u4e86</p>"},{"location":"chap10/58grafana_init/#2-2-2-dashboard","title":"2-2 \u7b2c 2 \u6b65 - \u5bfc\u5165 Dashboard","text":"<p>\u5728 Grafana \u91cc\uff0c\u4eea\u8868\u76d8\u7684\u914d\u7f6e\u53ef\u4ee5\u901a\u8fc7\u56fe\u5f62\u5316\u754c\u9762\u8fdb\u884c\uff0c\u4f46\u914d\u7f6e\u597d\u7684\u4eea\u8868\u76d8\u662f\u4ee5 JSON \u5b58\u50a8\u7684\u3002\u8fd9\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u4f60\u628a\u4f60\u7684 JSON \u6570\u636e\u5206\u4eab\u51fa\u53bb\uff0c\u522b\u4eba\u5bfc\u5165\u5c31\u53ef\u4ee5\u76f4\u63a5\u5bfc\u5165\u540c\u6837\u7684\u4eea\u8868\u76d8\uff08\u524d\u63d0\u662f\u4f60\u4eec\u7684\u76d1\u6d4b\u6570\u636e\u4e00\u6837\uff09\u3002</p> <p>\u5bf9\u4e8e\u6211\u4eec\u7684\u4f8b\u5b50\u6765\u8bf4\uff0c\u56de\u5fc6\u4e00\u4e0b\uff0c\u56e0\u4e3a\u6211\u4eec\u7528\u4e86 prometheus-exporter \u4e5f\u5c31\u662f\u672c\u673a\u7684\u7cfb\u7edf\u4fe1\u606f\u76d1\u63a7\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5148\u627e\u4e00\u4e2a\u540c\u6837\u7528\u4e86\u8fd9\u4e2a\u6570\u636e\u6e90\u7684\u4eea\u8868\u76d8\u3002\u5728 Grafana \u7f51\u7ad9\u4e0a\uff0c\u4f60\u5176\u5b9e\u53ef\u4ee5\u627e\u5230\u5f88\u591a\u522b\u4eba\u5df2\u7ecf\u505a\u597d\u7684\u4eea\u8868\uff0c\u53ef\u4ee5\u7528\u6765\u76d1\u6d4b\u975e\u5e38\u591a\u6807\u51c6\u5316\u7684\u670d\u52a1\u3002</p> <p>Grafana \u7684\u4eea\u8868\u76d8\u5e02\u573a\uff1ahttps://grafana.com/grafana/dashboards</p> <p>\u6bd4\u5982\u8bf4\u9488\u5bf9\u4ee5\u4e0b\u4e00\u4e9b\u670d\u52a1\u7684\u6807\u51c6\u4eea\u8868\u76d8\u5c31\u53ef\u4ee5\u5728\u8fd9\u91cc\u627e\u5230</p> <ul> <li>JVM</li> <li>Spring Boot</li> <li>MySQL \u76d1\u63a7</li> <li>Laravel \u76d1\u63a7</li> </ul> <p>\u90a3\u4e48\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u7528\u4e00\u4e2a\u6807\u51c6\u7684\u4eea\u8868\u76d8\uff1ahttps://grafana.com/grafana/dashboards/1860</p> <p>\u5728\u5de6\u4fa7\u7684\u52a0\u53f7\u91cc\uff0c\u70b9 Import \u5373\u5bfc\u5165\uff0c\u5728\u51fa\u73b0\u7684\u754c\u9762\u4e2d\u586b\u5165 1860 \u5373\u6211\u4eec\u8981\u5bfc\u5165\u7684\u4eea\u8868\u76d8\u7f16\u53f7\u5373\u53ef\u3002</p> <p></p> <p>\u7136\u540e\u586b\u5165\u4f60\u9700\u8981\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\u4eea\u8868\u76d8\u540d\u5b57\u7b49</p> <p></p> <p>\u786e\u8ba4\u4e4b\u540e Grafana \u5c31\u4f1a\u6839\u636e\u4f60\u7684\u672c\u673a\u4fe1\u606f\uff0c\u751f\u6210\u7c7b\u4f3c CPU \u8d1f\u8f7d\uff0c\u5185\u5b58\u548c I/O \u4e4b\u7c7b\u7684\u4fe1\u606f\u3002\u6211\u7684\u78c1\u76d8\u72b6\u51b5\u5982\u56fe\uff1a</p> <p></p> <p>\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u91cc\u7684\u4fe1\u606f\u771f\u6b63\u76d1\u63a7\u7684\u662f\u4f60\u7684 Docker \u4e2d\u7684\u7cfb\u7edf\u4fe1\u606f\u3002\u5982\u679c\u4f60\u53ea\u7ed9\u4f60\u7684 Docker \u5206\u914d 1 \u4e2a\u6838\u548c 2G \u5185\u5b58\uff0c\u90a3\u4e48\u8fd9\u91cc\u5e94\u8be5\u770b\u5230\u7684\u5c31\u662f 1 \u4e2a\u6838\u548c 2G \u5185\u5b58</p>"},{"location":"chap10/58grafana_init/#2-3-3-","title":"2-3 \u7b2c 3 \u6b65 - \u751f\u6210\u548c\u521b\u5efa\u65b0\u7684\u4eea\u8868\u76d8","text":"<p>\u5305\u62ec\u5982\u4f55\u7528 Prometheus \u67e5\u8be2\u6570\u636e</p> <p>\u666e\u7f57\u7c73\u4fee\u65af\u672c\u8eab\u4e5f\u662f\u4e2a\u975e\u5e38\u5927\u7684\u8bdd\u9898\uff0c\u6211\u4eec\u4f1a\u5728\u4e4b\u540e\u7684\u535a\u5ba2\u4e2d\u7ee7\u7eed\u8ba8\u8bba\u3002\u666e\u7f57\u7c73\u4fee\u65af\u5305\u62ec\u6240\u6709\u5176\u5b83\u65f6\u5e8f\u6570\u636e\u5e93\u901a\u5e38\u90fd\u4f1a\u5b9a\u4e49\u4e00\u4e2a\u67e5\u8be2\u8bed\u8a00\uff0c\u6bd4\u5982\u8bf4 PromQL\uff0c\u5982\u679c\u9700\u8981\u719f\u7ec3\u5730\u6784\u5efa\u4eea\u8868\u76d8\u7684\u8bdd\uff0c\u9700\u8981\u5bf9\u8fd9\u4e2a\u67e5\u8be2\u8bed\u8a00\u6709\u4e00\u5b9a\u4e86\u89e3\u3002</p> <p>\u5982\u4f55\u624b\u52a8\u751f\u6210\u4e00\u4e2a\u4eea\u8868\u76d8</p> <p>\u5047\u8bbe\u4f60\u5df2\u7ecf\u6309\u4e0a\u9762\u7684\u6b65\u9aa4\u751f\u6210\u4e86\u4e00\u4e2a\u57fa\u672c\u7684\u4eea\u8868\u76d8\uff0c\u90a3\u4e48\u73b0\u5728\u53ef\u4ee5\u5f00\u59cb\u624b\u52a8\u6dfb\u52a0\u4eea\u8868\u76d8\u4e86\u3002\u540c\u6837\u662f\u70b9\u5de6\u4fa7\u7684\u52a0\u53f7\uff0c\u70b9 Dashboard \u5c31\u53ef\u4ee5\u8fdb\u5165\u6dfb\u52a0\u4eea\u8868\u76d8\u7684\u754c\u9762\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u9009\u62e9\u4e00\u4e2a\u6570\u636e\u53eb <code>scrape_duration_seconds</code>\uff0c\u5148\u4e0d\u7528\u7ba1\u5b83\u7684\u542b\u4e49\u662f\u4ec0\u4e48\uff0c\u5c31\u5f53\u5b83\u662f\u53cc 11 \u7684\u9500\u552e\u989d\u597d\u4e86\uff1a</p> <p></p> <p>\u6dfb\u52a0\u597d\u540e\u70b9\u53f3\u4e0a\u89d2\u7684 Apply \u6216 Save \u4f60\u7684\u4eea\u8868\u76d8\u5c31\u88ab\u4fdd\u5b58\u4e86\u3002</p>"},{"location":"chap10/58grafana_init/#4-grafana","title":"4 \u4f7f\u7528 Grafana \u521b\u5efa\u53ef\u89c6\u5316\u9762\u677f","text":"<p>Grafana \u662f\u4e00\u4e2a\u76d1\u63a7\u4eea\u8868\u7cfb\u7edf\uff0c\u5b83\u662f\u7531 Grafana Labs \u516c\u53f8\u5f00\u6e90\u7684\u7684\u4e00\u4e2a\u7cfb\u7edf\u76d1\u6d4b\u5de5\u5177\uff0c\u5b83\u53ef\u4ee5\u5927\u5927\u5e2e\u52a9\u6211\u4eec\u7b80\u5316\u76d1\u63a7\u7684\u590d\u6742\u5ea6\uff0c\u6211\u4eec\u53ea\u9700\u8981\u63d0\u4f9b\u9700\u8981\u76d1\u63a7\u7684\u6570\u636e\uff0c\u5b83\u5c31\u53ef\u4ee5\u5e2e\u52a9\u751f\u6210\u5404\u79cd\u53ef\u89c6\u5316\u4eea\u8868\uff0c\u540c\u65f6\u5b83\u8fd8\u6709\u62a5\u8b66\u529f\u80fd\uff0c\u53ef\u4ee5\u5728\u7cfb\u7edf\u51fa\u73b0\u95ee\u9898\u65f6\u53d1\u51fa\u901a\u77e5\u3002</p> <p>Grafana \u652f\u6301\u8bb8\u591a\u4e0d\u540c\u7684\u6570\u636e\u6e90\uff0c\u6bcf\u4e2a\u6570\u636e\u6e90\u90fd\u6709\u4e00\u4e2a\u7279\u5b9a\u7684\u67e5\u8be2\u7f16\u8f91\u5668\uff0c\u6bcf\u4e2a\u6570\u636e\u6e90\u7684\u67e5\u8be2\u8bed\u8a00\u548c\u80fd\u529b\u90fd\u662f\u4e0d\u540c\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u6765\u81ea\u591a\u4e2a\u6570\u636e\u6e90\u7684\u6570\u636e\u7ec4\u5408\u5230\u4e00\u4e2a\u4eea\u8868\u677f\uff0c\u4f46\u6bcf\u4e00\u4e2a\u9762\u677f\u88ab\u7ed1\u5b9a\u5230\u4e00\u4e2a\u7279\u5b9a\u7684\u6570\u636e\u6e90\u3002\u76ee\u524d\u5b98\u65b9\u652f\u6301\u4ee5\u4e0b\u6570\u636e\u6e90\uff1a</p> <ul> <li>Alertmanager</li> <li>AWS CloudWatch</li> <li>Azure Monitor</li> <li>Elasticsearch</li> <li>Google Cloud Monitoring</li> <li>Graphite</li> <li>InfluxDB</li> <li>Loki</li> <li>Microsoft SQL Server (MSSQL)</li> <li>MySQL</li> <li>OpenTSDB</li> <li>PostgreSQL</li> <li>Prometheus</li> <li>Jaeger</li> <li>Zipkin</li> <li>Tempo</li> </ul> <p>\u6211\u4eec\u8fd9\u91cc\u5f53\u7136\u91cd\u70b9\u9700\u8981\u4ecb\u7ecd\u7684\u5c31\u662f Prometheus \u8fd9\u4e2a\u6570\u636e\u6e90\u4e86\u3002</p>"},{"location":"chap10/58grafana_init/#_1","title":"\u5b89\u88c5","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b89\u88c5 Grafana\uff0cGrafana \u672c\u8eab\u662f\u975e\u5e38\u8f7b\u91cf\u7ea7\u7684\uff0c\u4e0d\u4f1a\u5360\u7528\u5927\u91cf\u8d44\u6e90\uff0c\u6b64\u5916 Grafana \u9700\u8981\u4e00\u4e2a\u6570\u636e\u5e93\u6765\u5b58\u50a8\u5176\u914d\u7f6e\u6570\u636e\uff0c\u6bd4\u5982\u7528\u6237\u3001\u6570\u636e\u6e90\u548c\u4eea\u8868\u76d8\u7b49\uff0c\u76ee\u524d Grafana \u652f\u6301 SQLite\u3001MySQL\u3001PostgreSQL 3 \u79cd\u6570\u636e\u5e93\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7684\u662f SQLite\uff0c\u8be5\u6570\u636e\u5e93\u6587\u4ef6\u4f1a\u5b58\u50a8\u5728 Grafana \u7684\u5b89\u88c5\u4f4d\u7f6e\uff0c\u6240\u4ee5\u9700\u8981\u5bf9 Grafana \u7684\u5b89\u88c5\u76ee\u5f55\u8fdb\u884c\u6301\u4e45\u5316\u3002</p> <p>\u8981\u5b89\u88c5 Grafana \u7684\u65b9\u5f0f\u6709\u5f88\u591a\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f CentOS \u7cfb\u7edf\uff0c\u53ef\u4ee5\u5728 Grafana \u5b98\u65b9\u4e0b\u8f7d\u9875\u9762\u7b5b\u9009\u5408\u9002\u7684\u7248\u672c https://grafana.com/grafana/download?edition=oss&amp;platform=linux \u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528 rpm \u5305\u8fdb\u884c\u5b89\u88c5\uff1a</p> <pre><code>\u279c wget https://dl.grafana.com/oss/release/grafana-8.2.1-1.x86_64.rpm\n\u279c sudo yum install grafana-8.2.1-1.x86_64.rpm\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 systemd \u6765\u7ba1\u7406 Grafana\uff1a</p> <pre><code>\u2638 \u279c sudo systemctl daemon-reload\n\u2638 \u279c sudo systemctl enable grafana-server\n\u2638 \u279c sudo systemctl start grafana-server\n\u2638 \u279c sudo systemctl status grafana-server\n</code></pre> <p>\u9ed8\u8ba4\u7684\u542f\u52a8\u914d\u7f6e\u73af\u5883\u53d8\u91cf\u4f4d\u4e8e <code>/etc/sysconfig/grafana-server</code> \u6587\u4ef6\u4e2d\uff1a</p> <pre><code>\u2638 \u279c cat /etc/sysconfig/grafana-server\nGRAFANA_USER=grafana\n\nGRAFANA_GROUP=grafana\n\nGRAFANA_HOME=/usr/share/grafana\n\nLOG_DIR=/var/log/grafana\n\nDATA_DIR=/var/lib/grafana\n\nMAX_OPEN_FILES=10000\n\nCONF_DIR=/etc/grafana\n\nCONF_FILE=/etc/grafana/grafana.ini\n\nRESTART_ON_UPGRADE=true\n\nPLUGINS_DIR=/var/lib/grafana/plugins\n\nPROVISIONING_CFG_DIR=/etc/grafana/provisioning\n\n# Only used on systemd systems\nPID_FILE_DIR=/var/run/grafana\n</code></pre> <p>\u4ece\u4e0a\u9762\u6587\u4ef6\u4e2d\u53ef\u4ee5\u627e\u5230 Grafana \u7684\u5404\u79cd\u6570\u636e\u914d\u7f6e\u8def\u5f84\uff0c\u6bd4\u5982\u6570\u636e\u76ee\u5f55\u3001\u65e5\u5fd7\u76ee\u5f55\u3001\u63d2\u4ef6\u76ee\u5f55\u7b49\u7b49\uff0c\u6b63\u5e38\u542f\u52a8\u5b8c\u6210\u540e Grafana \u4f1a\u76d1\u542c\u5728 3000 \u7aef\u53e3\u4e0a\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 Grafana \u7684 WebUI\u3002</p> <p>\u9ed8\u8ba4\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u4e3a admin\uff0c\u4e5f\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6 <code>/etc/grafana/grafana.ini</code> \u4e2d\u914d\u7f6e <code>admin_user</code> \u548c <code>admin_password</code> \u4e24\u4e2a\u53c2\u6570\u6765\u8fdb\u884c\u8986\u76d6\u3002</p> <p>\u5f53\u7136\u5982\u679c\u6211\u4eec\u60f3\u8981\u90e8\u7f72\u4e00\u4e2a\u9ad8\u53ef\u7528\u7248\u672c\u7684 Grafana \u7684\u8bdd\uff0c\u90a3\u4e48\u4f7f\u7528 SQLite \u6570\u636e\u5e93\u5c31\u4e0d\u884c\u4e86\uff0c\u9700\u8981\u5207\u6362\u5230 MySQL \u6216\u8005 PostgreSQL\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Grafana \u914d\u7f6e\u7684 [database] \u90e8\u5206\u627e\u5230\u6570\u636e\u5e93\u7684\u76f8\u5173\u914d\u7f6e\uff0cGrafana \u4f1a\u5c06\u6240\u6709\u957f\u671f\u6570\u636e\u4fdd\u5b58\u5728\u6570\u636e\u5e93\u4e2d\uff0c\u7136\u540e\u90e8\u7f72\u591a\u4e2a Grafana \u5b9e\u4f8b\u4f7f\u7528\u540c\u4e00\u4e2a\u6570\u636e\u5e93\u5373\u53ef\u5b9e\u73b0\u9ad8\u53ef\u7528\u3002</p> <p></p>"},{"location":"chap10/58grafana_init/#_2","title":"\u521b\u5efa\u9762\u677f","text":"<p>\u9762\u677f\uff08Panel\uff09\u662f Grafana \u4e2d\u57fa\u672c\u53ef\u89c6\u5316\u6784\u5efa\u5757\uff0c\u6bcf\u4e2a\u9762\u677f\u90fd\u6709\u4e00\u4e2a\u7279\u5b9a\u4e8e\u9762\u677f\u4e2d\u9009\u62e9\u6570\u636e\u6e90\u7684\u67e5\u8be2\u7f16\u8f91\u5668\uff0c\u6bcf\u4e2a\u9762\u677f\u90fd\u6709\u5404\u79cd\u5404\u6837\u7684\u6837\u5f0f\u548c\u683c\u5f0f\u9009\u9879\uff0c\u9762\u677f\u53ef\u4ee5\u5728\u4eea\u8868\u677f\u4e0a\u62d6\u653e\u548c\u91cd\u65b0\u6392\u5217\uff0c\u5b83\u4eec\u4e5f\u53ef\u4ee5\u8c03\u6574\u5927\u5c0f\uff0c\u6240\u4ee5\u8981\u5728 Grafana \u4e0a\u521b\u5efa\u53ef\u89c6\u5316\u7684\u56fe\u8868\uff0c\u9762\u677f\u662f\u6211\u4eec\u5fc5\u987b\u8981\u638c\u63e1\u7684\u77e5\u8bc6\u70b9\u3002</p> <p>\u6570\u636e\u6e90</p> <p>\u5728\u521b\u5efa\u9762\u677f\u4e4b\u524d\u6211\u4eec\u9700\u8981\u6307\u5b9a\u6211\u4eec\u7684\u9762\u677f\u6570\u636e\u6765\u6e90\uff0c\u4e5f\u5c31\u662f\u6570\u636e\u6e90\uff0cGrafana \u652f\u6301\u591a\u79cd\u6570\u636e\u6e90\uff0c\u6211\u4eec\u8fd9\u91cc\u5f53\u7136\u4f7f\u7528 Prometheus \u4f5c\u4e3a\u6570\u636e\u6e90\u6765\u8fdb\u884c\u8bf4\u660e\u3002\u5728 Grafana \u5de6\u4fa7\u5de5\u5177\u680f\u9009\u62e9 Configuration\uff0c\u70b9\u51fb\u5230\u4e0b\u9762\u7684 Data sources\uff0c\u6253\u5f00\u6dfb\u52a0\u6570\u636e\u6e90\u7684\u9875\u9762\uff1a</p> <p></p> <p>\u9009\u62e9\u7b2c\u4e00\u9879 Prometheus \u6570\u636e\u6e90\u8fdb\u884c\u914d\u7f6e\uff1a</p> <p></p> <p>\u5728 HTTP \u9879\u4e2d\u914d\u7f6e URL \u5730\u5740\u4e3a <code>http://localhost:9090</code>\uff0c\u5176\u5b9e\u5c31\u662f Prometheus \u7684\u5730\u5740\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc Grafana \u548c Prometheus \u90fd\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u6240\u4ee5\u7528 localhost \u5373\u53ef\u8bbf\u95ee\uff0c\u5f53\u7136\u7528 IP \u4e5f\u53ef\u4ee5\uff0c<code>Access</code> \u9009\u62e9\u9ed8\u8ba4\u7684 Server \u4ee3\u7406\u65b9\u5f0f\uff0c\u8fd9\u6837\u5c31\u76f8\u5f53\u4e8e Grafana \u7a0b\u5e8f\u53bb\u8bbf\u95ee <code>Prometheus</code> \u800c\u4e0d\u662f\u5728\u6d4f\u89c8\u5668\u7aef\u53bb\u8bbf\u95ee\uff0c\u5982\u679c Prometheus \u914d\u7f6e\u6709\u8ba4\u8bc1\uff0c\u5219\u8fd8\u9700\u8981\u5728\u4e0b\u53d1\u914d\u7f6e Auth \u4fe1\u606f\uff0c\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u62c9\u5230\u6700\u4e0b\u65b9\u70b9\u51fb Save &amp; test\uff0c\u63d0\u793a\u6dfb\u52a0\u6210\u529f\u5373\u8868\u9762\u6570\u636e\u6e90\u6dfb\u52a0\u6210\u529f\u4e86\u3002\u7136\u540e\u5728\u6570\u636e\u6e90\u5217\u8868\u4e2d\u5c31\u4f1a\u51fa\u73b0\u6211\u4eec\u521a\u521a\u6dfb\u52a0\u7684 Prometheus \u8fd9\u4e2a\u6570\u636e\u6e90\u4e86\uff1a</p> <p>\u6dfb\u52a0\u9762\u677f</p> <p>\u9762\u677f\u662f\u5c5e\u4e8e\u67d0\u4e00\u4e2a Dashboard \u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5148\u521b\u5efa\u4e00\u4e2a Dashboard\uff0c\u5728\u4fa7\u8fb9\u680f\u70b9\u51fb + \u5207\u6362\u5230 Dashboard \u4e0b\u9762\u5f00\u59cb\u521b\u5efa Dashboard\uff1a</p> <p>\u5728\u9ed8\u8ba4\u521b\u5efa\u7684\u65b0\u7684 Dashboard \u4e2d\u5c31\u6709\u4e00\u4e2a\u7a7a\u7684\u9762\u677f\uff0c\u70b9\u51fb Add an empty panel \u5373\u53ef\u5f00\u59cb\u6dfb\u52a0\u9762\u677f\uff1a</p> <p></p> <p>\u8fdb\u5165\u9762\u677f\u7f16\u8f91\u5668\u540e\u5373\u53ef\u6dfb\u52a0\u9762\u677f\u4e86\uff0c\u4e2d\u95f4\u4f4d\u7f6e\u662f\u67e5\u8be2\u8bed\u53e5\u7684\u663e\u793a\u7ed3\u679c\uff0c\u4e0b\u65b9\u662f\u7528\u4e8e\u914d\u7f6e\u67e5\u8be2\u8bed\u53e5\u7684\u5730\u65b9\uff0c\u5de6\u4fa7\u53ef\u4ee5\u9009\u62e9\u9762\u677f\u663e\u793a\u7684\u7c7b\u578b\uff0c\u9762\u677f\u5143\u4fe1\u606f\uff0c\u6bd4\u5982\u6807\u9898\u3001\u63cf\u8ff0\u4fe1\u606f\u7b49\u3002</p> <p></p> <p>\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u5c31\u8981\u6765\u67e5\u8be2\u8282\u70b9\u7684 CPU \u4f7f\u7528\u7387\uff0c\u524d\u9762\u5728 <code>node_exporter</code> \u7ae0\u8282\u4e2d\u5df2\u7ecf\u5b66\u4e60\u4e86\u8be5\u76d1\u63a7\u6570\u636e\u7684\u67e5\u8be2\u8bed\u53e5\u4e3a<code>(1 - sum(rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) by (instance) / sum(rate(node_cpu_seconds_total[5m])) by (instance) ) * 100</code>\uff0c\u53ea\u9700\u8981\u5c06\u8be5\u8bed\u53e5\u586b\u5145\u5230\u67e5\u8be2\u7684 PromQL \u8bed\u53e5\u4e2d\u5373\u53ef\u5728\u4e0a\u9762\u663e\u793a\u51fa\u76d1\u63a7\u7684\u7ed3\u679c\uff1a</p> <p></p> <p>\u7528\u540c\u6837\u7684\u65b9\u5f0f\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e\u67e5\u8be2\u8282\u70b9\u5185\u5b58\u4f7f\u7528\u7387\u7684\u9762\u677f\uff1a</p> <p></p> <p>\u6dfb\u52a0\u53c2\u6570</p> <p>\u73b0\u5728\u6211\u4eec\u5728\u4e00\u4e2a Dashboard \u4e2d\u6dfb\u52a0\u4e86\u4e24\u4e2a Panel\uff0c\u6211\u4eec\u53ef\u4ee5\u5f88\u660e\u663e\u770b\u5230\u4f1a\u76f4\u63a5\u5c06\u6240\u6709\u7684\u8282\u70b9\u4fe1\u606f\u5c55\u793a\u5728\u540c\u4e00\u4e2a\u9762\u677f\u4e2d\uff0c\u4f46\u662f\u5982\u679c\u6709\u975e\u5e38\u591a\u7684\u8282\u70b9\u7684\u8bdd\u6570\u636e\u91cf\u5c31\u975e\u5e38\u5927\u4e86\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u6700\u597d\u7684\u65b9\u5f0f\u662f\u5c06\u8282\u70b9\u5f53\u6210\u53c2\u6570\uff0c\u53ef\u4ee5\u8ba9\u7528\u6237\u81ea\u5df1\u53bb\u9009\u62e9\u8981\u67e5\u770b\u54ea\u4e00\u4e2a\u8282\u70b9\u7684\u76d1\u63a7\u4fe1\u606f\uff0c\u8981\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff0c\u6211\u4eec\u5c31\u9700\u8981\u53bb\u6dfb\u52a0\u4e00\u4e2a\u4ee5\u8282\u70b9\u4e3a\u53c2\u6570\u7684\u53d8\u91cf\u6765\u53bb\u67e5\u8be2\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u70b9\u51fb Dashboard \u9875\u9762\u53f3\u4e0a\u65b9\u7684 Dashboard settings \u6309\u94ae\uff0c\u8fdb\u5165\u914d\u7f6e\u9875\u9762\uff1a</p> <p>\u5728\u8be5 Settings \u9875\u9762\u53ef\u4ee5\u6765\u5bf9\u6574\u4e2a Dashboard \u8fdb\u884c\u914d\u7f6e\uff0c\u6bd4\u5982\u540d\u79f0\u3001\u6807\u7b7e\u3001\u53d8\u91cf\u7b49\uff1a</p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u70b9\u51fb\u5de6\u8fb9\u7684 Variables \u6dfb\u52a0\u4e00\u4e2a\u53d8\u91cf\uff0c\u53d8\u91cf\u652f\u6301\u66f4\u5177\u4ea4\u4e92\u6027\u548c\u52a8\u6001\u6027\u7684\u4eea\u8868\u677f\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u5b83\u4eec\u7684\u4f4d\u7f6e\u4f7f\u7528\u53d8\u91cf\uff0c\u800c\u4e0d\u662f\u5728\u6307\u6807\u67e5\u8be2\u4e2d\u786c\u7f16\u7801\uff0c\u53d8\u91cf\u663e\u793a\u4e3a Dashboard \u9876\u90e8\u7684\u4e0b\u62c9\u5217\u8868\uff0c\u8fd9\u4e9b\u4e0b\u62c9\u5217\u8868\u53ef\u4ee5\u8f7b\u677e\u66f4\u6539\u4eea\u8868\u677f\u4e2d\u663e\u793a\u7684\u6570\u636e\u3002</p> <p></p> <p>\u4e3a\u4e86\u80fd\u591f\u9009\u62e9\u8282\u70b9\u6570\u636e\uff0c\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a instance \u7684\u53d8\u91cf\u540d\uff0c\u4f46\u662f\u5b9a\u4e49\u7684\u8fd9\u4e2a\u53d8\u91cf\u503c\u4ece\u54ea\u4e2a\u5730\u65b9\u83b7\u53d6\u5462\uff1f</p> <p></p> <p>\u76d1\u63a7\u8282\u70b9\u7684\u76f8\u5173\u6307\u6807\u662f\u6765\u6e90\u4e8e\u540d\u4e3a node-exporter \u7684\u4efb\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2 up \u6765\u83b7\u53d6\u6240\u6709\u7684\u76d1\u63a7\u5b9e\u4f8b\uff1a</p> <p></p> <p>\u8981\u60f3\u83b7\u53d6\u5230 instance \u6807\u7b7e\u4e2d\u7684\u503c\uff0c\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u6b63\u5219\u8868\u8fbe\u5f0f <code>.*instance=\"(.*?)\".*</code> \u6765\u83b7\u53d6\u5b9e\u4f8b\u6570\u636e\uff0c\u8fd9\u6837\u5c31\u6210\u529f\u5b9a\u4e49\u4e86\u4e00\u4e2a\u53d8\u91cf\uff0c\u56de\u5230 Dashboard \u9875\u9762\u5c31\u53ef\u4ee5\u770b\u5230\u591a\u4e86\u4e00\u4e2a\u9009\u62e9\u8282\u70b9\u7684\u4e0b\u62c9\u6846\uff1a</p> <p>\u4f46\u662f\u8fd9\u4e2a\u65f6\u5019\u7684\u9762\u677f\u5e76\u4e0d\u4f1a\u968f\u7740\u6211\u4eec\u4e0b\u62c9\u6846\u7684\u9009\u62e9\u800c\u53d8\u5316\uff0c\u6211\u4eec\u9700\u8981\u5c06 instance \u8fd9\u4e2a\u53d8\u91cf\u4f20\u5165\u67e5\u8be2\u8bed\u53e5\u4e2d\uff0c\u6bd4\u5982\u91cd\u65b0\u4fee\u6539CPU\u4f7f\u7528\u7387\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <p></p> <p>\u7528\u540c\u6837\u7684\u65b9\u5f0f\u7ed9\u5185\u5b58\u4f7f\u7528\u7387\u6dfb\u52a0\u6839\u636e\u8282\u70b9\u8fc7\u6ee4\u7684\u53c2\u6570\uff1a</p> <p></p> <p>\u56de\u5230 Dashboard \u9875\u9762\u5c31\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684\u4e0b\u62c9\u6846\u6765\u9009\u62e9\u9700\u8981\u76d1\u63a7\u7684\u8282\u70b9\u6570\u636e\u4e86\uff0c\u5b9a\u4e49\u53c2\u6570\u7684\u65f6\u5019\u5982\u679c\u9009\u62e9\u4e86\u53ef\u4ee5\u9009\u62e9\u6240\u6709\uff0c\u540c\u6837\u53ef\u4ee5\u67e5\u770b\u6240\u6709\u8282\u70b9\u7684\u6570\u636e\uff1a</p> <p></p>"},{"location":"chap10/5Grafana_Loki/","title":"5 \u4f7f\u7528\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u6269\u5c55 Grafana Loki","text":"<p>Loki \u7531\u591a\u4e2a\u5fae\u670d\u52a1\u7ec4\u4ef6\u6784\u5efa\u800c\u6210\uff0c\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u53ef\u6c34\u5e73\u6269\u5c55\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u8fd0\u884c\uff0cLoki \u7684\u72ec\u7279\u8bbe\u8ba1\u53ef\u4ee5\u5c06\u6574\u4e2a\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u4ee3\u7801\u7f16\u8bd1\u6210\u5355\u4e2a\u4e8c\u8fdb\u5236\u6216 Docker \u6620\u50cf\uff0c\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u884c\u4e3a\u7531 <code>-target</code> \u547d\u4ee4\u884c\u6807\u5fd7\u63a7\u5236\u3002</p>"},{"location":"chap10/5Grafana_Loki/#_1","title":"\u5355\u4f53\u6a21\u5f0f","text":"<p>\u6700\u7b80\u5355\u7684\u64cd\u4f5c\u6a21\u5f0f\u662f\u8bbe\u7f6e <code>-target=all</code>\uff0c\u8fd9\u662f\u9ed8\u8ba4\u7684\u65b9\u5f0f\uff0c\u4e0d\u9700\u8981\u6307\u5b9a\uff0c\u8fd9\u5c31\u662f\u5355\u4f53\u6a21\u5f0f\uff0c\u5b83\u4ee5\u5355\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u6216 Docker \u6620\u50cf\u7684\u5f62\u5f0f\u5728\u5355\u4e2a\u8fdb\u7a0b\u4e2d\u8fd0\u884c Loki \u7684\u6240\u6709\u5fae\u670d\u52a1\u7ec4\u4ef6\u3002</p> <p></p> <p>\u5355\u4f53\u6a21\u5f0f\u5bf9\u4e8e\u5feb\u901f\u5f00\u59cb\u4f7f\u7528 Loki \u4ee5\u53ca\u6bcf\u5929\u6570\u636e\u91cf\u7ea6100GB\u7684\u8bfb\u5199\u91cf\u975e\u5e38\u6709\u7528\u3002</p> <p>\u5c06\u5355\u4f53\u6a21\u5f0f\u90e8\u7f72\u6c34\u5e73\u6269\u5c55\u81f3\u66f4\u591a\u5b9e\u4f8b\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u5171\u4eab\u5bf9\u8c61\u5b58\u50a8\uff0c\u914d\u7f6e <code>memberlist_config</code> \u5c5e\u6027\u5728\u6240\u6709\u5b9e\u4f8b\u4e4b\u95f4\u5171\u4eab\u72b6\u6001\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 <code>memberlist_config</code> \u914d\u7f6e\u548c\u5171\u4eab\u5bf9\u8c61\u5b58\u50a8\u8fd0\u884c\u4e24\u4e2a Loki \u5b9e\u4f8b\u6765\u914d\u7f6e\u9ad8\u53ef\u7528\u6027\u3002\u4ee5\u5faa\u73af\u65b9\u5f0f\u5c06\u6d41\u91cf\u8def\u7531\u5230\u6240\u6709 Loki \u5b9e\u4f8b\u3002\u5e76\u884c\u67e5\u8be2\u53d7\u9650\u4e8e\u5b9e\u4f8b\u6570\u91cf\u548c\u5b9a\u4e49\u7684\u67e5\u8be2\u5e76\u884c\u5ea6\u3002</p> <p>\u5355\u4f53\u6a21\u5f0f\u7684\u5b89\u88c5\u975e\u5e38\u7b80\u5355\uff0c\u76f4\u63a5\u4f7f\u7528 grafana/loki-stack \u8fd9\u4e2a Helm Chart \u5305\u5b89\u88c5\u5373\u53ef\u3002</p>"},{"location":"chap10/5Grafana_Loki/#_2","title":"\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f","text":"<p>\u5982\u679c\u4f60\u6bcf\u5929\u7684\u65e5\u5fd7\u91cf\u8d85\u8fc7\u51e0\u767e GB\uff0c\u6216\u8005\u4f60\u60f3\u8fdb\u884c\u8bfb\u5199\u5206\u79bb\uff0cLoki \u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u53ef\u6269\u5c55\u90e8\u7f72\u6a21\u5f0f\u3002\u8fd9\u79cd\u90e8\u7f72\u6a21\u5f0f\u53ef\u4ee5\u6269\u5c55\u5230\u6bcf\u5929\u6570 TB \u751a\u81f3\u66f4\u591a\u7684\u65e5\u5fd7\u3002</p> <p></p> <p>\u5728\u8fd9\u79cd\u6a21\u5f0f\u4e0b\uff0cLoki \u7684\u7ec4\u4ef6\u5fae\u670d\u52a1\u88ab\u7ed1\u5b9a\u5230\u4e24\u4e2a\u76ee\u6807\u4e2d\uff1a<code>-target=read</code> \u548c <code>-target=write</code>\uff0cBoltDB compactor \u670d\u52a1\u5c06\u4f5c\u4e3a\u8bfb\u53d6\u76ee\u6807\u7684\u4e00\u90e8\u5206\u8fd0\u884c\u3002</p> <p>\u5206\u79bb\u8bfb\u5199\u8def\u5f84\u6709\u4ee5\u4e0b\u4f18\u70b9\uff1a</p> <ul> <li>\u901a\u8fc7\u63d0\u4f9b\u4e13\u7528\u8282\u70b9\u63d0\u9ad8\u5199\u5165\u8def\u5f84\u7684\u53ef\u7528\u6027</li> <li>\u53ef\u5355\u72ec\u6269\u5c55\u8bfb\u53d6\u8def\u5f84\u4ee5\u6309\u9700\u6dfb\u52a0/\u5220\u9664\u67e5\u8be2\u6027\u80fd</li> </ul> <p>\u8fd9\u79cd\u8bfb\u5199\u5206\u79bb\u7684\u6a21\u5f0f\u9700\u8981\u5728 Loki \u524d\u9762\u6709\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u5b83\u5c06 <code>/loki/api/v1/push</code> \u6d41\u91cf\u8def\u7531\u5230\u5199\u5165\u8282\u70b9\uff0c\u6240\u6709\u5176\u4ed6\u8bf7\u6c42\u90fd\u8f6c\u5230\u8bfb\u53d6\u8282\u70b9\uff0c\u6d41\u91cf\u5e94\u8be5\u4ee5\u5faa\u73af\u65b9\u5f0f\u53d1\u9001\u3002</p>"},{"location":"chap10/5Grafana_Loki/#_3","title":"\u5b89\u88c5","text":"<p>\u6211\u4eec\u540c\u6837\u4f7f\u7528 Helm Chart \u8fdb\u884c\u5b89\u88c5\uff0c\u9996\u5148\u83b7\u53d6\u8bfb\u5199\u5206\u79bb\u6a21\u578b\u7684 Chart \u5305\uff1a</p> <pre><code>\n$ helm repo add grafana https://grafana.github.io/helm-charts\n$ helm pull grafana/loki-simple-scalable --untar --version 1.4.1\n$ cd loki-simple-scalable\n</code></pre> <p>\u8be5 Chart \u5305\u652f\u6301\u4e0b\u8868\u4e2d\u663e\u793a\u7684\u7ec4\u4ef6\uff0cIngester\u3001distributor\u3001querier \u548c query-frontend \u90fd\u4f1a\u5b89\u88c5\uff0c\u5176\u4ed6\u7ec4\u4ef6\u662f\u53ef\u9009\u7684\u3002</p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 MinIO \u6765\u4f5c\u4e3a\u8fdc\u7a0b\u6570\u636e\u5b58\u50a8\uff0c\u5206\u522b\u914d\u7f6e\u8bfb\u548c\u5199\u7684 Loki \u5b9e\u4f8b\u526f\u672c\u6570\u4e3a2\uff0c\u4e3a\u4e86\u5728 Loki \u524d\u9762\u6dfb\u52a0\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u9700\u8981\u5f00\u542f Gateway\uff0c\u5bf9\u5e94\u7684 Values \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># ci/minio-values.yaml\nloki:\n  commonConfig:\n    path_prefix: /var/loki\n    replication_factor: 2\n  authEnabled: false\n\n# Configuration for the write\nwrite:\n  # -- Number of replicas for the write\n  replicas: 3\n  affinity: |\n    podAntiAffinity:\n      preferredDuringSchedulingIgnoredDuringExecution:\n        - weight: 1\n          podAffinityTerm:\n            labelSelector:\n              matchLabels:\n                {{- include \"loki.writeSelectorLabels\" . | nindent 12 }}\n            topologyKey: kubernetes.io/hostname\n  persistence:\n    size: 1Gi\n    storageClass: local-path\n\n# Configuration for the read node(s)\nread:\n  # -- Number of replicas for the read\n  replicas: 3\n  affinity: |\n    podAntiAffinity:\n      preferredDuringSchedulingIgnoredDuringExecution:\n        - weight: 1\n          podAffinityTerm:\n            labelSelector:\n              matchLabels:\n                {{- include \"loki.readSelectorLabels\" . | nindent 12 }}\n            topologyKey: kubernetes.io/hostname\n  persistence:\n    size: 1Gi\n    storageClass: local-path\n\n# Configuration for the gateway\ngateway:\n  # -- Specifies whether the gateway should be enabled\n  enabled: true\n# -------------------------------------\n# Configuration for `minio` child chart\n# -------------------------------------\nminio:\n  enabled: true\n  accessKey: enterprise-logs\n  secretKey: supersecret\n  service:\n    type: NodePort\n    nodePort: 32000\n  buckets:\n    - name: chunks\n      policy: none\n      purge: false\n    - name: ruler\n      policy: none\n      purge: false\n    - name: admin\n      policy: none\n      purge: false\n  persistence:\n    size: 1Gi\n    storageClass: local-path\n  resources:\n    requests:\n      cpu: 100m\n      memory: 256Mi\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u7684 Loki\uff1a</p> <pre><code>$ helm upgrade --install loki -n logging -f ci/minio-values.yaml .\nRelease \"loki\" does not exist. Installing it now.\nNAME: loki\nLAST DEPLOYED: Fri Jun 17 14:53:20 2022\nNAMESPACE: logging\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\n***********************************************************************\n Welcome to Grafana Loki\n Chart version: 1.4.1\n Loki version: 2.5.0\n***********************************************************************\n\nInstalled components:\n* gateway\n* read\n* write\n\nThis chart requires persistence and object storage to work correctly.\nQueries will not work unless you provide a `loki.config.common.storage` section with\na valid object storage (and the default `filesystem` storage set to `null`), as well\nas a valid `loki.config.schema_config.configs` with an `object_store` that\nmatches the common storage section.\n\nFor example, to use MinIO as your object storage backend:\n\nloki:\n  config:\n    common:\n      storage:\n        filesystem: null\n        s3:\n          endpoint: minio.minio.svc.cluster.local:9000\n          insecure: true\n          bucketnames: loki-data\n          access_key_id: loki\n          secret_access_key: supersecret\n          s3forcepathstyle: true\n    schema_config:\n      configs:\n        - from: \"2020-09-07\"\n          store: boltdb-shipper\n          object_store: s3\n          schema: v11\n          index:\n            period: 24h\n            prefix: loki_index_\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u67e5\u770b Pod \u72b6\u6001\u662f\u5426\u6b63\u5e38\uff1a</p> <pre><code>$ kubectl get pods -n logging\nNAME                            READY   STATUS    RESTARTS   AGE\nloki-gateway-67f76958d7-bq46l   1/1     Running   0          91m\nloki-minio-87c9bc6f5-jxdcn      1/1     Running   0          70m\nloki-read-0                     1/1     Running   0          81s\nloki-read-1                     1/1     Running   0          81s\nloki-read-2                     1/1     Running   0          81s\nloki-write-0                    1/1     Running   0          81s\nloki-write-1                    1/1     Running   0          81s\nloki-write-2                    1/1     Running   0          81s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5206\u522b\u90e8\u7f72\u4e86\u4e24\u4e2a\u526f\u672c\u7684 write \u548c read \u7684 Loki\uff0c\u53e6\u5916\u8fd8\u6709\u4e00\u4e2a gateway \u7684 Pod\uff0cgateway \u5b9e\u9645\u4e0a\u5c31\u662f\u4e00\u4e2a nginx \u5e94\u7528\uff0c\u7528\u6765\u5c06 <code>/loki/api/v1/push</code> \u8bf7\u6c42\u8def\u7531\u5230 <code>write</code> \u8282\u70b9\u53bb\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b <code>gateway</code> \u7684\u914d\u7f6e\u6765\u9a8c\u8bc1\uff1a</p> <pre><code>$ kubectl get cm -n logging loki-gateway -o yaml\napiVersion: v1\ndata:\n  nginx.conf: |\n    worker_processes  5;  ## Default: 1\n    error_log  /dev/stderr;\n    pid        /tmp/nginx.pid;\n    worker_rlimit_nofile 8192;\n\n    events {\n      worker_connections  4096;  ## Default: 1024\n    }\n\n    http {\n      client_body_temp_path /tmp/client_temp;\n      proxy_temp_path       /tmp/proxy_temp_path;\n      fastcgi_temp_path     /tmp/fastcgi_temp;\n      uwsgi_temp_path       /tmp/uwsgi_temp;\n      scgi_temp_path        /tmp/scgi_temp;\n\n      default_type application/octet-stream;\n      log_format   main '$remote_addr - $remote_user [$time_local]  $status '\n            '\"$request\" $body_bytes_sent \"$http_referer\" '\n            '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n      access_log   /dev/stderr  main;\n\n      sendfile     on;\n      tcp_nopush   on;\n      resolver kube-dns.kube-system.svc.cluster.local;\n\n      server {\n        listen             8080;\n\n        location = / {\n          return 200 'OK';\n          auth_basic off;\n        }\n\\\n        location = /api/prom/push {\n          proxy_pass       http://loki-write.logging.svc.cluster.local:3100$request_uri;\n        }\n\n        location = /api/prom/tail {\n          proxy_pass       http://loki-read.logging.svc.cluster.local:3100$request_uri;\n          proxy_set_header Upgrade $http_upgrade;\n          proxy_set_header Connection \"upgrade\";\n        }\n\n        location ~ /api/prom/.* {\n          proxy_pass       http://loki-read.logging.svc.cluster.local:3100$request_uri;\n        }\n\n        location = /loki/api/v1/push {\n          proxy_pass       http://loki-write.logging.svc.cluster.local:3100$request_uri;\n        }\n\n        location = /loki/api/v1/tail {\n          proxy_pass       http://loki-read.logging.svc.cluster.local:3100$request_uri;\n          proxy_set_header Upgrade $http_upgrade;\n          proxy_set_header Connection \"upgrade\";\n        }\n\n        location ~ /loki/api/.* {\n          proxy_pass       http://loki-read.logging.svc.cluster.local:3100$request_uri;\n        }\n      }\n    }\nkind: ConfigMap\nmetadata:\n  annotations:\n    meta.helm.sh/release-name: loki\n    meta.helm.sh/release-namespace: logging\n  creationTimestamp: \"2022-06-17T06:53:22Z\"\n  labels:\n    app.kubernetes.io/component: gateway\n    app.kubernetes.io/instance: loki\n    app.kubernetes.io/managed-by: Helm\n    app.kubernetes.io/name: loki\n    app.kubernetes.io/version: 2.5.0\n    helm.sh/chart: loki-simple-scalable-1.4.1\n  name: loki-gateway\n  namespace: logging\n  resourceVersion: \"4968787\"\n  uid: ba9ba1c0-8561-41cb-8b55-287f352b5ee8\n</code></pre> <p>\u4e0a\u9762\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u7684 Nginx \u914d\u7f6e\uff0c\u4ece\u914d\u7f6e\u53ef\u4ee5\u770b\u51fa\u4f1a\u628a\u8bf7\u6c42 <code>/api/prom/push</code> \u548c <code>/loki/api/v1/push</code> \u8fd9\u4e24\u4e2a Push API \u4ee3\u7406\u5230 <code>http://loki-write.logging.svc.cluster.local:3100$request_uri</code>;\uff0c</p> <p>\u4e5f\u5c31\u662f\u4e0a\u9762\u7684\u4e24\u4e2a <code>loki-write</code> \u8282\u70b9\uff0c\u800c\u8bfb\u53d6\u76f8\u5173\u7684\u63a5\u53e3\u88ab\u4ee3\u7406\u5230 <code>loki-read</code> \u8282\u70b9\uff0c\u7136\u540e <code>loki-write \u542f\u52a8\u53c2\u6570\u914d\u7f6e</code>-target=write<code>\uff0c</code>loki-read<code>\u542f\u52a8\u53c2\u6570\u914d\u7f6e</code>-target=read`\uff0c\u8fd9\u6837\u53bb\u5b9e\u73b0\u8bfb\u5199\u5206\u79bb \u4e0d\u8fc7\u8bfb\u5199\u7684\u5e94\u7528\u662f\u5171\u4eab\u540c\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u7684\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl get cm -n logging loki -o yaml\napiVersion: v1\ndata:\n  config.yaml: |\n    auth_enabled: false\n    common:\n      path_prefix: /var/loki\n      replication_factor: 2\n      storage:\n        s3:\n          access_key_id: enterprise-logs\n          bucketnames: chunks\n          endpoint: loki-minio.logging.svc:9000\n          insecure: true\n          s3forcepathstyle: true\n          secret_access_key: supersecret\n    limits_config:\n      enforce_metric_name: false\n      max_cache_freshness_per_query: 10m\n      reject_old_samples: true\n      reject_old_samples_max_age: 168h\n      split_queries_by_interval: 15m\n    memberlist:\n      join_members:\n      - loki-memberlist\n    ruler:\n      storage:\n        s3:\n          bucketnames: ruler\n    schema_config:\n      configs:\n      - from: \"2022-06-17\"\n        index:\n          period: 24h\n          prefix: loki_index_\n        object_store: s3\n        schema: v12\n        store: boltdb-shipper\n    server:\n      grpc_listen_port: 9095\n      http_listen_port: 3100\n......\n</code></pre> <p>\u5176\u4e2d <code>common.storage.s3</code>  \u6307\u5b9a\u7684\u662f MinIO \u7684\u76f8\u5173\u914d\u7f6e\uff0c\u901a\u8fc7 <code>memberlist.join_members</code> \u6765\u6307\u5b9a\u6210\u5458\uff0c\u5176\u5b9e\u5c31\u662f\u6240\u6709\u7684\u8bfb\u5199\u8282\u70b9\uff1a</p> <pre><code>$ kubectl get svc loki-memberlist -n logging -o wide\nNAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE   SELECTOR\nloki-memberlist   ClusterIP   None         &lt;none&gt;        7946/TCP   54m   app.kubernetes.io/instance=loki,app.kubernetes.io/name=loki,app.kubernetes.io/part-of=memberlist\n$ kubectl get pods -n logging -l app.kubernetes.io/part-of=memberlist\nNAME           READY   STATUS    RESTARTS   AGE\nloki-read-0    1/1     Running   0          32s\nloki-read-1    1/1     Running   0          72s\nloki-read-2    1/1     Running   0          115s\nloki-write-0   1/1     Running   0          4s\nloki-write-1   1/1     Running   0          55s\nloki-write-2   1/1     Running   0          116s\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Loki \u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u7684\u90e8\u7f72\u3002</p>"},{"location":"chap10/5Grafana_Loki/#promtail","title":"Promtail\u5199\u6570\u636e","text":"<p>\u4e3a\u4e86\u9a8c\u8bc1\u5e94\u7528\u662f\u5426\u6b63\u5e38\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u5b89\u88c5 Promtail \u548c Grafana \u6765\u8fdb\u884c\u6570\u636e\u7684\u8bfb\u5199\u3002</p> <p>\u83b7\u53d6 promtail \u7684 Chart \u5305\u5e76\u89e3\u538b\uff1a</p> <pre><code>$ helm pull grafana/promtail --untar\n$ cd promtail\n</code></pre> <p>\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 values \u6587\u4ef6\uff1a</p> <pre><code># ci/simple-values.yaml\nrbac:\n  pspEnabled: false\nconfig:\n  lokiAddress: http://loki-gateway/loki/api/v1/push\n</code></pre> <p>\u6ce8\u610f\u6211\u4eec\u9700\u8981\u5c06 Promtail \u4e2d\u914d\u7f6e\u7684 Loki \u5730\u5740\u4e3a <code>http://loki-gateway/loki/api/v1/push</code>\uff0c</p> <p>\u8fd9\u6837\u5c31\u662f Promtail \u5c06\u65e5\u5fd7\u6570\u636e\u9996\u5148\u53d1\u9001\u5230 Gateway \u4e0a\u9762\u53bb\uff0c\u7136\u540e Gateway \u6839\u636e\u6211\u4eec\u7684 Endpoints \u53bb\u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5 Promtail\uff1a</p> <pre><code>$ helm upgrade --install promtail -n logging -f ci/simple-values.yaml .\nRelease \"promtail\" does not exist. Installing it now.\nNAME: promtail\nLAST DEPLOYED: Fri Jun 17 16:01:08 2022\nNAMESPACE: logging\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\n***********************************************************************\n Welcome to Grafana Promtail\n Chart version: 5.1.0\n Promtail version: 2.5.0\n***********************************************************************\n\nVerify the application is working by running these commands:\n\n* kubectl --namespace logging port-forward daemonset/promtail 3101\n* curl http://127.0.0.1:3101/metrics\n</code></pre> <p>\u6b63\u5e38\u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a promtail\uff1a</p> <pre><code>\n$ kubectl get pods -n logging -l app.kubernetes.io/name=promtail\nNAME             READY   STATUS    RESTARTS   AGE\npromtail-5r9hl   1/1     Running   0          2m25s\npromtail-85mk4   1/1     Running   0          2m25s\npromtail-qlfnv   1/1     Running   0          2m25s\n</code></pre> <p>\u6b63\u5e38 promtail \u5c31\u5df2\u7ecf\u5728\u5f00\u59cb\u91c7\u96c6\u6240\u5728\u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\u4e86\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u6570\u636e Push \u7ed9 gateway\uff0cgateway \u8f6c\u53d1\u7ed9 write \u8282\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b gateway \u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs -f loki-gateway-67f76958d7-bq46l -n logging\n10.244.1.170 - - [17/Jun/2022:08:09:03 +0000]  204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\"\n10.244.1.170 - - [17/Jun/2022:08:09:04 +0000]  204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\"\n10.244.2.205 - - [17/Jun/2022:08:09:05 +0000]  204 \"POST /loki/api/v1/push HTTP/1.1\" 0 \"-\" \"promtail/2.5.0\" \"-\"\n......\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 gateway \u73b0\u5728\u5728\u4e00\u76f4\u63a5\u63a5\u6536\u7740 <code>/loki/api/v1/push</code> \u7684\u8bf7\u6c42\uff0c\u4e5f\u5c31\u662f <code>promtail</code> \u53d1\u9001\u8fc7\u6765\u7684\uff0c\u6b63\u5e38\u6765\u8bf4\u73b0\u5728\u65e5\u5fd7\u6570\u636e\u5df2\u7ecf\u5206\u53d1\u7ed9 <code>write</code> \u8282\u70b9\u4e86\uff0c<code>write</code> \u8282\u70b9\u5c06\u6570\u636e\u5b58\u50a8\u5728\u4e86 <code>minio</code> \u4e2d\uff0c\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b minio \u4e2d\u5df2\u7ecf\u6709\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u524d\u9762\u5b89\u88c5\u7684\u65f6\u5019\u4e3a <code>minio</code> \u670d\u52a1\u6307\u5b9a\u4e86\u4e00\u4e2a <code>32000</code> \u7684 <code>NodePort</code> \u7aef\u53e3\uff1a</p> <p></p> <p>\u767b\u5f55\u4fe1\u606f\u4e3a\uff1a</p> <ul> <li>accessKey: enterprise-logs</li> <li>secretKey: supersecret</li> </ul> <p></p> <p>\u53ef\u4ee5\u770b\u5230 minio \u7684 chunks \u8fd9\u4e2a bucket \u4e2d\u5e76\u6ca1\u6709\u65e5\u5fd7\u6570\u636e\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 bucket \u9ed8\u8ba4\u53ea\u6709\u8bfb\u53d6\u7684\u6743\u9650\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u8be5 bucket \u4fee\u6539\u4e3a\u5177\u6709\u8bfb\u5199\u7684\u6743\u9650\uff1a</p> <p></p> <p>\u6b63\u5e38\u4fee\u6539\u540e\u5c31\u4f1a\u4ea7\u751f\u4e00\u4e2a fake \u7684\u76ee\u5f55\u4e86\uff0c\u8fd9\u662f\u9ed8\u8ba4\u6ca1\u6709\u63d0\u4f9b\u591a\u79df\u6237\u7684\u6570\u636e\u76ee\u5f55\uff0c\u8be5\u76ee\u5f55\u4e0b\u9762\u5b58\u50a8\u7740\u65e5\u5fd7\u7684 chunk \u6570\u636e\uff1a</p> <p></p> <p>\u8fd9\u662f Loki \u65e5\u5fd7\u7684\u5199\u5165\u7684\u8def\u5f84\u3002</p>"},{"location":"chap10/5Grafana_Loki/#grafana","title":"Grafana\u8bfb\u6570\u636e","text":"<p>\u4e0b\u9762\u6211\u4eec\u6765\u9a8c\u8bc1\u4e0b\u8bfb\u53d6\u8def\u5f84\uff0c\u5b89\u88c5 Grafana \u5bf9\u63a5 Loki\uff1a</p> <pre><code>$ helm pull grafana/grafana --untar\n$ cd grafana\n</code></pre> <p>\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 values \u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>lues \u914d\u7f6e\u6587\u4ef6\uff1a\n\n# ci/simple-values.yaml\nservice:\n  type: NodePort\n  nodePort: 32001\nrbac:\n  pspEnabled: false\npersistence:\n  enabled: true\n  storageClassName: local-path\n  accessModes:\n    - ReadWriteOnce\n  size: 1Gi\n</code></pre> <p>\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 Grafana\uff1a</p> <pre><code>$ helm upgrade --install grafana -n logging -f ci/simple-values.yaml .\nRelease \"grafana\" has been upgraded. Happy Helming!\nNAME: grafana\nLAST DEPLOYED: Fri Jun 17 17:00:24 2022\nNAMESPACE: logging\nSTATUS: deployed\nREVISION: 2\nNOTES:\n1. Get your 'admin' user password by running:\n\n   kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo\n\n2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster:\n\n   grafana.logging.svc.cluster.local\n\n   Get the Grafana URL to visit by running these commands in the same shell:\nexport NODE_PORT=$(kubectl get --namespace logging -o jsonpath=\"{.spec.ports[0].nodePort}\" services grafana)\n     export NODE_IP=$(kubectl get nodes --namespace logging -o jsonpath=\"{.items[0].status.addresses[0].address}\")\n     echo http://$NODE_IP:$NODE_PORT\n\n\n3. Login with the password from step 1 and the username: admin\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u63d0\u793a\u4e2d\u7684\u547d\u4ee4\u83b7\u53d6\u767b\u5f55\u5bc6\u7801\uff1a</p> <pre><code>$ kubectl get secret --namespace logging grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u5bc6\u7801\u548c admin \u7528\u6237\u540d\u767b\u5f55 Grafana\uff1a</p> <p>\u767b\u5f55\u540e\u8fdb\u5165 Grafana \u6dfb\u52a0\u4e00\u4e2a\u6570\u636e\u6e90\uff0c\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u8981\u586b\u5199 gateway \u7684\u5730\u5740 http://loki-gateway\uff1a </p> <p>\u4fdd\u5b58\u6570\u636e\u6e90\u540e\uff0c\u53ef\u4ee5\u8fdb\u5165 Explore \u9875\u9762\u8fc7\u6ee4\u65e5\u5fd7\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6765\u5b9e\u65f6\u67e5\u770b gateway \u8fd9\u4e2a\u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5982\u679c\u4f60\u80fd\u770b\u5230\u6700\u65b0\u7684\u65e5\u5fd7\u6570\u636e\u90a3\u8bf4\u660e\u6211\u4eec\u90e8\u7f72\u6210\u529f\u4e86\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u7684 Loki\uff0c\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u53ef\u4ee5\u5927\u5927\u63d0\u9ad8 Loki \u7684\u6027\u80fd\u548c\u5bb9\u91cf\uff0c\u5982\u679c\u8fd9\u79cd\u6a21\u5f0f\u8fd8\u4e0d\u80fd\u6ee1\u8db3\u4f60\u7684\u6570\u636e\u91cf\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u5fae\u670d\u52a1\u6a21\u5f0f\u6765\u90e8\u7f72 Loki \u4e86</p>"},{"location":"chap10/6Prometheus_grafaa_docker/","title":"\u4f7f\u7528 Prometheus \u548c Grafana \u5b9e\u73b0\u670d\u52a1\u5668\u8fd0\u884c\u72b6\u6001\u76d1\u63a7\uff08\u57fa\u4e8e Docker\uff09","text":""},{"location":"chap10/6Prometheus_grafaa_docker/#_1","title":"\u5f15\u8a00","text":"<p>\u5728\u73b0\u4ee3\u8fd0\u7ef4\u4e2d\uff0c\u76d1\u63a7\u670d\u52a1\u5668\u7684\u8fd0\u884c\u72b6\u6001\u662f\u4fdd\u8bc1\u670d\u52a1\u7a33\u5b9a\u6027\u7684\u5173\u952e\u3002\u672c\u6587\u5c06\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528 Docker \u6765\u90e8\u7f72 Prometheus \u548c Grafana\uff0c\u5e76\u7ed3\u5408 <code>node_exporter</code> \u8fdb\u884c\u670d\u52a1\u5668\u72b6\u6001\u76d1\u63a7\u3002</p> <p>\u901a\u8fc7\u7b80\u5355\u7684\u914d\u7f6e\u548c\u90e8\u7f72\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9e\u65f6\u638c\u63e1\u670d\u52a1\u5668\u7684\u8fd0\u884c\u72b6\u51b5\uff0c\u63d0\u524d\u53d1\u73b0\u5e76\u5904\u7406\u6f5c\u5728\u95ee\u9898</p>"},{"location":"chap10/6Prometheus_grafaa_docker/#1","title":"1\u3001\u51c6\u5907\u5de5\u4f5c","text":"<p>\u9996\u5148\u786e\u4fdd\u4f60\u7684\u670d\u52a1\u5668\u5df2\u7ecf\u5b89\u88c5\u4e86 Docker \u548c Docker Compose\u3002\u5982\u679c\u6ca1\u6709\u5b89\u88c5\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5\uff1a</p> <pre><code># \u5b89\u88c5 Docker\ncurl -fsSL https://get.docker.com -o get-docker.sh\nsh get-docker.sh\n\n# \u5b89\u88c5 Docker Compose\nsudo curl -L \"https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\nsudo chmod +x /usr/local/bin/docker-compose\n</code></pre>"},{"location":"chap10/6Prometheus_grafaa_docker/#2-docker-compose","title":"2\u3001\u7f16\u5199 Docker Compose \u6587\u4ef6","text":"<p>\u6211\u4eec\u5c06\u4f7f\u7528 Docker Compose \u6765\u7f16\u6392 Prometheus\u3001Grafana \u548c <code>node_exporter</code> \u7684\u5bb9\u5668\u3002\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55\u5e76\u5728\u5176\u4e2d\u521b\u5efa <code>docker-compose.yml</code>\u6587\u4ef6\uff1a</p> <pre><code>version: '3.7'\n\nservices:\n  prometheus:\n    image: prom/prometheus:latest\n    container_name: prometheus\n    volumes:\n      - ./prometheus.yml:/etc/prometheus/prometheus.yml\n    ports:\n      - \"9090:9090\"\n\n  grafana:\n    image: grafana/grafana:latest\n    container_name: grafana\n    ports:\n      - \"3000:3000\"\n    environment:\n      - GF_SECURITY_ADMIN_PASSWORD=admin\n\n  node-exporter:\n    image: prom/node-exporter:latest\n    container_name: node-exporter\n    ports:\n      - \"9100:9100\"\n</code></pre>"},{"location":"chap10/6Prometheus_grafaa_docker/#3-prometheus","title":"3\u3001\u914d\u7f6e Prometheus","text":"<p>\u5728\u540c\u4e00\u76ee\u5f55\u4e0b\u521b\u5efa <code>prometheus.yml</code> \u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>global:\n  scrape_interval: 15s\n\nscrape_configs:\n  - job_name: 'node_exporter'\n    static_configs:\n      - targets: ['node-exporter:9100']\n</code></pre>"},{"location":"chap10/6Prometheus_grafaa_docker/#4","title":"4\u3001 \u542f\u52a8\u670d\u52a1","text":"<p>\u5728 docker-compose.yml \u6587\u4ef6\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u542f\u52a8\u6240\u6709\u670d\u52a1\uff1a</p> <pre><code>docker-compose up -d\n</code></pre>"},{"location":"chap10/6Prometheus_grafaa_docker/#5-grafana","title":"5\u3001\u8bbf\u95ee Grafana","text":"<p>\u670d\u52a1\u542f\u52a8\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u6d4f\u89c8\u5668\u8bbf\u95ee http://localhost:3000 \u6253\u5f00 Grafana\u3002\u9ed8\u8ba4\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u5747\u4e3a admin\u3002</p>"},{"location":"chap10/6Prometheus_grafaa_docker/#6-grafana-prometheus","title":"6\u3001\u914d\u7f6e Grafana \u6765\u663e\u793a Prometheus \u6570\u636e","text":""},{"location":"chap10/6Prometheus_grafaa_docker/#_2","title":"\u6dfb\u52a0\u6570\u636e\u6e90\uff1a","text":"<p>\u8fdb\u5165 Grafana \u4eea\u8868\u76d8\u3002</p> <p>\u70b9\u51fb\u5de6\u4fa7\u7684 \u201c\u9f7f\u8f6e\u201d \u56fe\u6807\uff08Configuration\uff09\u5e76\u9009\u62e9 \u201cData Sources\u201d\u3002</p> <p>\u70b9\u51fb \u201cAdd data source\u201d\uff0c\u9009\u62e9 \u201cPrometheus\u201d\uff0c\u7136\u540e\u8bbe\u7f6e URL \u4e3a http://prometheus:9090\u3002</p> <p>\u70b9\u51fb \u201cSave &amp; Test\u201d \u4ee5\u786e\u8ba4\u8fde\u63a5\u6210\u529f\u3002</p>"},{"location":"chap10/6Prometheus_grafaa_docker/#_3","title":"\u521b\u5efa\u4eea\u8868\u76d8\uff1a","text":"<p>\u70b9\u51fb\u5de6\u4fa7\u7684 \u201c\u52a0\u53f7\u201d \u56fe\u6807\uff08Create\uff09\u5e76\u9009\u62e9 \u201cDashboard\u201d\u3002</p> <p>\u70b9\u51fb \u201cAdd new panel\u201d\u3002</p> <p>\u5728\u67e5\u8be2\u90e8\u5206\uff0c\u9009\u62e9 Prometheus \u4f5c\u4e3a\u6570\u636e\u6e90\uff0c\u5e76\u8f93\u5165\u9002\u5f53\u7684 Prometheus \u67e5\u8be2\u8bed\u53e5\uff0c\u4f8b\u5982 <code>node_cpu_seconds_total</code>\u3002</p> <p>\u914d\u7f6e\u5b8c\u6bd5\u540e\uff0c\u70b9\u51fb \u201cSave\u201d \u4fdd\u5b58\u4eea\u8868\u76d8\u3002</p> <p></p> <p>granafa \u63d0\u4f9b\u5f88\u591a\u53ef\u89c6\u5316\u6a21\u7248\u53ef\u4f9b\u53c2\u8003\uff0c\u5730\u5740\uff1ahttps://grafana.com/grafana/dashboards/</p> <p></p>"},{"location":"chap10/7loki_promtail_grafana/","title":"Docker\u4e0a\u90e8\u7f72LPG\uff08loki+promtail+grafana\uff09\u8e29\u5751\u590d\u76d8","text":"<p>https://github.com/ruanbekker/docker-promtail-loki/tree/main</p> <p>\u6309\u7167\u6587\u7ae0\u63cf\u8ff0\uff0c\u4e3b\u8981\u51c6\u5907loki\u3001promtail\u3001docker-compose\u6587\u4ef6\uff0c\u4fee\u6539\u5176\u4e2d\u90e8\u5206\u914d\u7f6e\uff0c\u5f97\u5230\u5982\u4e0b\u6587\u4ef6\uff1a</p>"},{"location":"chap10/7loki_promtail_grafana/#_1","title":"\u7f51\u4e0a\u914d\u7f6e","text":"<p><code>loki.yml</code>\u4e0d\u7528\u4fee\u6539:</p> <pre><code>auth_enabled: false\n\nserver:\n  http_listen_port: 3100\n\ningester:\n  lifecycler:\n    address: 127.0.0.1\n    ring:\n      kvstore:\n        store: inmemory\n      replication_factor: 1\n    final_sleep: 0s\n  chunk_idle_period: 1h    # \u6b64\u65f6\u6ca1\u6709\u63a5\u6536\u5230\u65b0\u65e5\u5fd7\u7684\u4efb\u4f55\u5757\u90fd\u5c06\u88ab\u5237\u65b0\n  max_chunk_age: 1h      # \u6240\u6709\u7684\u5757\u5c06\u5237\u65b0\u65f6\uff0c\u4ed6\u4eec\u8fbe\u5230\u8fd9\u4e2a\u5e74\u9f84\uff0c\u9ed8\u8ba4\u662f1h\n  chunk_target_size: 1048576 # Loki\u5c06\u5c1d\u8bd5\u6784\u5efa\u6700\u5927\u4e3a1.5MB\u7684\u5757\uff0c\u5982\u679c\u5148\u8fbe\u5230chunk_idle_period\u6216max_chunk_age\uff0c\u5219\u9996\u5148\u5237\u65b0\n  chunk_retain_period: 30s  # \u5982\u679c\u4f7f\u7528\u7d22\u5f15\u7f13\u5b58\uff0c\u5fc5\u987b\u5927\u4e8e\u7d22\u5f15\u8bfb\u7f13\u5b58TTL(\u9ed8\u8ba4\u7d22\u5f15\u8bfb\u7f13\u5b58TTL\u4e3a5m)\n  max_transfer_retries: 0   # \u5757\u4f20\u8f93\u7981\u7528\n\nschema_config:\n  configs:\n    - from: 2021-9-8\n      store: boltdb-shipper\n      object_store: filesystem\n      schema: v11\n      index:\n        prefix: index_\n        period: 24h\n\nstorage_config:\n  boltdb_shipper:\n    active_index_directory: /loki/boltdb-shipper-active\n    cache_location: /loki/boltdb-shipper-cache\n    cache_ttl: 24h     # \u53ef\u4ee5\u5728\u66f4\u957f\u7684\u67e5\u8be2\u5468\u671f\u5185\u63d0\u9ad8\u66f4\u5feb\u7684\u6027\u80fd\uff0c\u4f7f\u7528\u66f4\u591a\u7684\u78c1\u76d8\u7a7a\u95f4\n    shared_store: filesystem\n  filesystem:\n    directory: /loki/chunks\n\ncompactor:\n  working_directory: /loki/boltdb-shipper-compactor\n  shared_store: filesystem\n\nlimits_config:\n  reject_old_samples: true\n  reject_old_samples_max_age: 168h\n\nchunk_store_config:\n  max_look_back_period: 0s\n\ntable_manager:\n  retention_deletes_enabled: false\n  retention_period: 0s\n\nruler:\n  storage:\n    type: local\n    local:\n      directory: /loki/rules\n  rule_path: /loki/rules-temp\n  alertmanager_url: http://localhost:9093\n  ring:\n    kvstore:\n      store: inmemory\n  enable_api: true\n</code></pre>"},{"location":"chap10/7loki_promtail_grafana/#2-promtailyml","title":"2 promtail.yml \u4e0d\u7528\u4fee\u6539:","text":"<pre><code>server:\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /tmp/positions.yaml\n\nclients:\n  - url: http://loki:3100/loki/api/v1/push\n\nscrape_configs:\n  - job_name: system\n    static_configs:\n      - targets:\n          - localhost\n        labels:\n          job: varlogs\n          __path__: /var/log/*log\n</code></pre>"},{"location":"chap10/7loki_promtail_grafana/#docker-composeyml-service","title":"<code>docker-compose.yml</code> \u4fee\u6539<code>service</code>\u6302\u8f7d\u90e8\u5206:","text":"<pre><code>version: \"3\"\n\nservices:\n  # \u65e5\u5fd7\u5b58\u50a8\u548c\u89e3\u6790\n  loki:\n    image: grafana/loki\n    container_name: lpg-loki\n    volumes:\n      - /opt/docker/loki/:/etc/loki/\n    # \u4fee\u6539loki\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\n    command: -config.file=/etc/loki/loki.yml\n    ports:\n      - 3100:3100\n\n  # \u65e5\u5fd7\u6536\u96c6\u5668\n  promtail:\n    image: grafana/promtail\n    container_name: lpg-promtail\n    volumes:\n      # \u5c06\u9700\u8981\u6536\u96c6\u7684\u65e5\u5fd7\u6240\u5728\u76ee\u5f55\u6302\u8f7d\u5230promtail\u5bb9\u5668\u4e2d\n      - /opt/logs/health-center/:/var/log/\n      - /opt/docker/promtail:/etc/promtail/\n    # \u4fee\u6539promtail\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\n    command: -config.file=/etc/promtail/promtail.yml\n\n  # \u65e5\u5fd7\u53ef\u89c6\u5316\n  grafana:\n    image: grafana/grafana\n    container_name: lpg-grafana\n    ports:\n      - 3000:3000\n</code></pre> <pre><code>/opt/docker\n- promtail\n- lpg\n- loki\n</code></pre>"},{"location":"chap10/7loki_promtail_grafana/#_2","title":"\u90e8\u7f72\u8e29\u5751","text":"<p>cd\u5230<code>docker-compose.yml</code>\u76ee\u5f55\u4e0b\uff0c\u540e\u53f0\u8fd0\u884c<code>docker compose up -d</code>\uff0c\u7b2c\u4e00\u6b21\u62c9\u53d6\u955c\u50cf\u8f83\u4e45</p> <p>\u8e29\u5751\u8fc7\u7a0b\u4e2d\u6211\u6ce8\u610f\u5230\u76f4\u63a5\u540e\u53f0\u8fd0\u884c\u7136\u540e\u7528logs\u547d\u4ee4\u6765\u770b\u65e5\u5fd7\u4f1a\u66f4\u597d\u4e00\u4e9b</p> <p>2. \u5b8c\u4e8b\u4e4b\u540e\u5148\u6765\u51e0\u4e2a\u547d\u4ee4\u6821\u9a8c\uff1a</p> <p>docker compose ps\uff0c\u53d1\u73b0\u53ea\u6709promtail\u662f\u8fd0\u884c\u7684</p> <p></p> <p><code>docker compose logs loki</code>\uff0c\u770b\u4e00\u4e0bloki\u65e5\u5fd7\uff0c\u63d0\u5230\u65e5\u671f\u89e3\u6790\u5f02\u5e38\u7684\u95ee\u9898\uff1a</p> <p></p> <p>\u7ecf\u8fc7\u4e00\u987fgpt\uff0c\u53d1\u73b0\u662floki\u914d\u7f6e\u4e2d\u7684\u65e5\u671f\u6ca1\u6709\u6309\u7167yyyy-MM-dd\u7684\u683c\u5f0f\uff0c\u4e8e\u662f\u4fee\u6539loki\u914d\u7f6e\uff1a</p> <pre><code>schema_config:\n  configs:\n    - from: 2024-07-01\n      store: boltdb-shipper\n      object_store: filesystem\n      schema: v11\n      index:\n        prefix: index_\n        period: 24h\n</code></pre> <p>\u5b8c\u4e8b\u540e\u5148<code>docker compose stop</code>\u505c\u4e0b\u6765\uff0c\u518d\u91cd\u8dd1\u4e00\u6b21\uff0c\u7136\u540e\u67e5\u770b\u8fdb\u7a0b\uff0c\u53d1\u73b0\uff0c\u8fd8\u662floki\u8d77\u4e0d\u6765 \u67e5\u770b\u65e5\u5fd7\uff0c\u8fd9\u6b21\u662f\u8fd9\u6837\uff1a</p> <p></p> <p>\u4e00\u987fgpt\u540e\u4ed6\u8bf4\u53ef\u80fd\u662f\u4ec0\u4e48\u76ee\u5f55\u6743\u9650\u95ee\u9898\uff0c\u4e0d\u8fc7\u7f51\u4e0a\u627e\u5230\u66f4\u7b80\u4fbf\u7684\u65b9\u5f0f\uff0c\u53ea\u9700\u8981\u5728loki\u4e2d\u6dfb\u52a0\u4e00\u53e5(wal)\uff1a</p> <pre><code>ingester:\n  lifecycler:\n    address: 127.0.0.1\n    ring:\n      kvstore:\n        store: inmemory\n      replication_factor: 1\n    final_sleep: 0s\n  chunk_idle_period: 1h    # \u6b64\u65f6\u6ca1\u6709\u63a5\u6536\u5230\u65b0\u65e5\u5fd7\u7684\u4efb\u4f55\u5757\u90fd\u5c06\u88ab\u5237\u65b0\n  max_chunk_age: 1h      # \u6240\u6709\u7684\u5757\u5c06\u5237\u65b0\u65f6\uff0c\u4ed6\u4eec\u8fbe\u5230\u8fd9\u4e2a\u5e74\u9f84\uff0c\u9ed8\u8ba4\u662f1h\n  chunk_target_size: 1048576 # Loki\u5c06\u5c1d\u8bd5\u6784\u5efa\u6700\u5927\u4e3a1.5MB\u7684\u5757\uff0c\u5982\u679c\u5148\u8fbe\u5230chunk_idle_period\u6216max_chunk_age\uff0c\u5219\u9996\u5148\u5237\u65b0\n  chunk_retain_period: 30s  # \u5982\u679c\u4f7f\u7528\u7d22\u5f15\u7f13\u5b58\uff0c\u5fc5\u987b\u5927\u4e8e\u7d22\u5f15\u8bfb\u7f13\u5b58TTL(\u9ed8\u8ba4\u7d22\u5f15\u8bfb\u7f13\u5b58TTL\u4e3a5m)\n  max_transfer_retries: 0   # \u5757\u4f20\u8f93\u7981\u7528\n  wal:\n    dir: /loki/.cache/loki/wal/\n</code></pre> <p>\u8fd8\u662f\u91cd\u6765\u4e00\u6b21\uff0c\u6682\u505c\uff0c\u542f\u52a8\uff0c\u68c0\u67e5\u8fdb\u7a0b\uff0c\u8fd9\u6b21\u53ef\u4ee5\u4e86\u3002</p> <p></p> <ol> <li>\u540e\u7eed\u5c31\u662f\u4e0agrafana\u914d\u7f6eloki\u4e86\u3002</li> </ol> <p>\u914d\u7f6e\u7684\u65f6\u5019\u4e5f\u9047\u5230\u4e00\u4e2a\u5927\u5751\u4e86\uff0c\u5c31\u662f\u4fdd\u5b58\u6d4b\u8bd5\u7684\u65f6\u5019\u63d0\u793a\uff1a</p> <p>Data source connected, but no labels received. Verify that Loki and Promtail is configured properly.</p> <p></p> <p>\u6700\u540e\u5728\u7f51\u4e0a\u770b\u5230\u8bf4\u52a0\u70b9\u65e5\u5fd7\u5c31\u89e3\u51b3\u4e86\uff0c\u679c\u7136\uff0c\u5728promtail\u653e\u65e5\u5fd7\u7684\u76ee\u5f55\u4e0b\u6dfb\u52a0\u65b0\u7684\u65e5\u5fd7\uff0c\u518dtest\uff0c\u5c31\u68c0\u6d4b\u5230\u4e86</p> <p></p> <p>\u540e\u7eed\u7ee7\u7eed\u7814\u7a76\u591a\u76ee\u5f55\u6536\u96c6\u4ee5\u53ca\u591a\u673a\u5668\u65e5\u5fd7\u6536\u96c6\uff0c\u8e29\u4e86\u5751\u518d\u7ee7\u7eed\u590d\u76d8\u3002</p> <p><code>http://loki:3100</code></p>"},{"location":"chap11/34Thanos_intro/","title":"\u7b2c\u4e8c\u8282 \u4f7f\u7528Thanos\u5b9e\u73b0Prometheus\u7684\u9ad8\u53ef\u7528\u4ecb\u7ecd","text":"<p>\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u4e86 Prometheus \u7684\u4f7f\u7528\uff0c\u4e86\u89e3\u4e86\u57fa\u672c\u7684 PromQL \u8bed\u53e5\u4ee5\u53ca\u7ed3\u5408 Grafana \u6765\u8fdb\u884c\u76d1\u63a7\u56fe\u8868\u5c55\u793a\uff0c\u901a\u8fc7 AlertManager \u6765\u8fdb\u884c\u62a5\u8b66\uff0c\u8fd9\u4e9b\u5de5\u5177\u7ed3\u5408\u8d77\u6765\u5df2\u7ecf\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u642d\u5efa\u4e00\u5957\u6bd4\u8f83\u5b8c\u6574\u7684\u76d1\u63a7\u62a5\u8b66\u7cfb\u7edf\u4e86\uff0c\u4f46\u662f\u4e5f\u4ec5\u4ec5\u5c40\u9650\u4e8e\u6d4b\u8bd5\u73af\u5883\uff0c\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u6765\u8bf4\u5219\u8fd8\u6709\u8bb8\u591a\u9700\u8981\u6539\u8fdb\u7684\u5730\u65b9\uff0c\u5176\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u5c31\u662f Prometheus \u7684\u9ad8\u53ef\u7528\u3002</p> <p>\u5355\u53f0\u7684 <code>Prometheus</code> \u5b58\u5728\u5355\u70b9\u6545\u969c\u7684\u98ce\u9669\uff0c\u968f\u7740\u76d1\u63a7\u89c4\u6a21\u7684\u6269\u5927\uff0c<code>Prometheus</code> \u4ea7\u751f\u7684\u6570\u636e\u91cf\u4e5f\u4f1a\u975e\u5e38\u5927\uff0c\u6027\u80fd\u548c\u5b58\u50a8\u90fd\u4f1a\u9762\u4e34\u95ee\u9898\u3002\u6bcb\u5eb8\u7f6e\u7591\uff0c\u6211\u4eec\u9700\u8981\u4e00\u5957\u9ad8\u53ef\u7528\u7684 <code>Prometheus</code> \u96c6\u7fa4\u3002</p>"},{"location":"chap11/34Thanos_intro/#1","title":"1 \u53ef\u7528\u6027","text":"<p>\u6211\u4eec\u77e5\u9053 <code>Prometheus</code> \u662f\u91c7\u7528\u7684 <code>Pull</code> \u673a\u5236\u83b7\u53d6\u76d1\u63a7\u6570\u636e\uff0c\u5373\u4f7f\u4f7f\u7528 <code>PushGateway</code> \u5bf9\u4e8e <code>Prometheus</code> \u4e5f\u662f<code>Pull</code>\uff0c\u4e3a\u4e86\u786e\u4fdd <code>Prometheus</code>\u670d\u52a1\u7684\u53ef\u7528\u6027\uff0c\u6211\u4eec\u53ea\u9700\u8981\u90e8\u7f72\u591a\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\uff0c\u7136\u540e\u91c7\u96c6\u76f8\u540c\u7684 <code>metrics</code> \u6570\u636e\u5373\u53ef\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u65b9\u5f0f\u6765\u6ee1\u8db3\u670d\u52a1\u7684\u53ef\u7528\u6027\u5e94\u8be5\u662f\u5e73\u65f6\u6211\u4eec\u4f7f\u7528\u5f97\u6700\u591a\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c\u5f53\u4e00\u4e2a\u5b9e\u4f8b\u6302\u6389\u540e\u4ece<code>LB</code> \u91cc\u9762\u81ea\u52a8\u5254\u9664\u6389\uff0c\u800c\u4e14\u8fd8\u6709\u8d1f\u8f7d\u5747\u8861\u7684\u4f5c\u7528\uff0c\u53ef\u4ee5\u964d\u4f4e\u4e00\u4e2a <code>Prometheus</code> \u7684\u538b\u529b\uff0c\u4f46\u8fd9\u79cd\u6a21\u5f0f\u7f3a\u70b9\u4e5f\u662f\u975e\u5e38\u660e\u663e\u7684\uff0c\u5c31\u662f\u4e0d\u6ee1\u8db3\u6570\u636e\u4e00\u81f4\u6027\u4ee5\u53ca\u6301\u4e45\u5316\u95ee\u9898\uff0c\u56e0\u4e3a <code>Prometheus</code> \u662f <code>Pull</code> \u7684\u65b9\u5f0f\uff0c\u5373\u4f7f\u591a\u4e2a\u5b9e\u4f8b\u6293\u53d6\u7684\u662f\u76f8\u540c\u7684\u76d1\u63a7\u6307\u6807\uff0c\u4e5f\u4e0d\u80fd\u4fdd\u8bc1\u6293\u53d6\u8fc7\u6765\u7684\u503c\u5c31\u662f\u4e00\u81f4\u7684\uff0c\u66f4\u4f55\u51b5\u5728\u5b9e\u9645\u7684\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u8fd8\u4f1a\u9047\u5230\u4e00\u4e9b\u7f51\u7edc\u5ef6\u8fdf\u95ee\u9898\uff0c\u6240\u4ee5\u4f1a\u9020\u6210\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\uff0c</p> <p>\u4e0d\u8fc7\u5bf9\u4e8e\u76d1\u63a7\u62a5\u8b66\u8fd9\u4e2a\u573a\u666f\u6765\u8bf4\uff0c\u4e00\u822c\u4e5f\u4e0d\u4f1a\u8981\u6c42\u6570\u636e\u5f3a\u4e00\u81f4\u6027\uff0c\u6240\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u4ece\u4e1a\u52a1\u4e0a\u6765\u8bf4\u662f\u53ef\u4ee5\u63a5\u53d7\u7684\uff0c\u56e0\u4e3a\u8fd9\u79cd\u6570\u636e\u4e0d\u4e00\u81f4\u6027\u5f71\u54cd\u57fa\u672c\u4e0a\u6ca1\u4ec0\u4e48\u5f71\u54cd\u3002\u8fd9\u79cd\u573a\u666f\u9002\u5408\u76d1\u63a7\u89c4\u6a21\u4e0d\u5927\uff0c\u53ea\u9700\u8981\u4fdd\u5b58\u77ed\u5468\u671f\u76d1\u63a7\u6570\u636e\u7684\u573a\u666f\u3002</p>"},{"location":"chap11/34Thanos_intro/#2","title":"2 \u6570\u636e\u6301\u4e45\u5316","text":"<p>\u4f7f\u7528\u4e0a\u9762\u7684\u57fa\u672c <code>HA</code> \u7684\u6a21\u5f0f\u57fa\u672c\u4e0a\u662f\u53ef\u4ee5\u6ee1\u8db3\u76d1\u63a7\u8fd9\u4e2a\u573a\u666f\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u95ee\u9898\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u5b9e\u4f8b\u6570\u636e\u4e22\u4e86\u5c31\u6ca1\u529e\u6cd5\u5462\u6062\u590d\u56de\u6765\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4e3a <code>Prometheus</code> \u6dfb\u52a0\u8fdc\u7a0b\u5b58\u50a8\u6765\u4fdd\u8bc1\u6570\u636e\u6301\u4e45\u5316\u3002</p> <p></p> <p>\u5728\u7ed9 Prometheus \u914d\u7f6e\u4e0a\u8fdc\u7a0b\u5b58\u50a8\u8fc7\u540e\uff0c\u6211\u4eec\u5c31\u4e0d\u7528\u62c5\u5fc3\u6570\u636e\u4e22\u5931\u7684\u95ee\u9898\u4e86\uff0c\u5373\u4f7f\u5f53\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u5b95\u673a\u6216\u8005\u6570\u636e\u4e22\u5931\u8fc7\u540e\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8fdc\u7a0b\u5b58\u50a8\u7684\u6570\u636e\u8fdb\u884c\u6062\u590d\u3002</p>"},{"location":"chap11/34Thanos_intro/#3-leader","title":"3 \u901a\u8fc7\u9501\u83b7\u53d6 Leader","text":"<p>\u5176\u5b9e\u4e0a\u9762\u7684\u57fa\u672c <code>HA</code> \u52a0\u4e0a\u8fdc\u7a0b\u5b58\u50a8\u7684\u65b9\u5f0f\u57fa\u672c\u4e0a\u53ef\u4ee5\u6ee1\u8db3 <code>Prometheus</code> \u7684\u9ad8\u53ef\u7528\u4e86\uff0c\u8fd9\u79cd\u65b9\u5f0f\u7684\u591a\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u90fd\u4f1a\u53bb\u5b9a\u65f6\u62c9\u53d6\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u7136\u540e\u5c06\u70ed\u6570\u636e\u5b58\u50a8\u5728\u672c\u5730\uff0c\u7136\u540e\u51b7\u6570\u636e\u540c\u6b65\u5230\u8fdc\u7a0b\u5b58\u50a8\u4e2d\u53bb\uff0c\u5bf9\u4e8e\u5927\u578b\u96c6\u7fa4\u6765\u8bf4\u9891\u7e41\u7684\u53bb\u62c9\u53d6\u6307\u6807\u6570\u636e\u52bf\u5fc5\u4f1a\u5bf9\u7f51\u7edc\u9020\u6210\u66f4\u5927\u7684\u538b\u529b\u3002\u6240\u4ee5\u6211\u4eec\u4e5f\u901a\u8fc7\u670d\u52a1\u6ce8\u518c\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0 <code>Prometheus</code> \u7684\u9ad8\u53ef\u7528\u6027\uff0c\u96c6\u7fa4\u542f\u52a8\u7684\u65f6\u5019\u6bcf\u4e2a\u8282\u70b9\u90fd\u5c1d\u8bd5\u53bb\u83b7\u53d6\u9501\uff0c\u83b7\u53d6\u6210\u529f\u7684\u8282\u70b9\u6210\u4e3a <code>Leader</code> \u6267\u884c\u4efb\u52a1\uff0c\u82e5\u4e3b\u8282\u70b9\u5b95\u673a\uff0c\u4ece\u8282\u70b9\u83b7\u53d6\u9501\u6210\u4e3a Leader \u5e76\u63a5\u7ba1\u670d\u52a1\u3002</p> <p></p> <p>\u4e0d\u8fc7\u8fd9\u79cd\u65b9\u6848\u9700\u8981\u6211\u4eec\u901a\u8fc7\u53bb\u5199\u4ee3\u7801\u8fdb\u884c\u6539\u9020\uff0c\u5982\u679c\u5728 <code>Kubernetes</code> \u4e2d\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u81ea\u5e26\u7684 <code>Lease</code> \u5bf9\u8c61\u6765\u83b7\u53d6\u5206\u5e03\u5f0f\u9501\ud83d\udd12\uff0c\u8fd9\u4e0d\u662f\u5f88\u56f0\u96be\uff0c\u53ea\u662f\u4ee5\u540e\u8981\u66f4\u65b0\u7248\u672c\u7a0d\u5fae\u9ebb\u70e6\u70b9\u3002</p> <p>\u4e0a\u9762\u7684\u51e0\u79cd\u65b9\u6848\u57fa\u672c\u4e0a\u90fd\u53ef\u4ee5\u6ee1\u8db3\u57fa\u672c\u7684 <code>Prometheus</code> \u9ad8\u53ef\u7528\uff0c\u4f46\u662f\u5bf9\u4e8e\u5927\u578b\u96c6\u7fa4\u6765\u8bf4\uff0c\u4e00\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u7684\u538b\u529b\u59cb\u7ec8\u975e\u5e38\u5927\u3002</p>"},{"location":"chap11/34Thanos_intro/#4","title":"4 \u8054\u90a6\u96c6\u7fa4","text":"<p>\u5f53\u5355\u4e2a <code>Promthues</code> \u5b9e\u4f8b \u65e0\u6cd5\u5904\u7406\u5927\u91cf\u7684\u91c7\u96c6\u4efb\u52a1\u65f6\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u57fa\u4e8e <code>Prometheus</code> \u8054\u90a6\u96c6\u7fa4\u7684\u65b9\u5f0f\u6765\u5c06\u76d1\u63a7\u4efb\u52a1\u5212\u5206\u5230\u4e0d\u540c\u7684 <code>Prometheus</code> \u5b9e\u4f8b\u4e2d\u53bb\u3002</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0d\u540c\u7c7b\u578b\u7684\u91c7\u96c6\u4efb\u52a1\u5212\u5206\u5230\u4e0d\u540c\u7684 <code>Prometheus</code> \u5b9e\u4f8b\u4e2d\u53bb\u6267\u884c\uff0c\u8fdb\u884c\u529f\u80fd\u5206\u7247\uff0c\u6bd4\u5982\u4e00\u4e2a <code>Prometheus</code> \u8d1f\u8d23\u91c7\u96c6\u8282\u70b9\u7684\u6307\u6807\u6570\u636e\uff0c\u53e6\u5916\u4e00\u4e2a <code>Prometheus</code> \u8d1f\u8d23\u91c7\u96c6\u5e94\u7528\u4e1a\u52a1\u76f8\u5173\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u6700\u540e\u5728\u4e0a\u5c42\u901a\u8fc7\u4e00\u4e2a <code>Prometheus</code> \u5bf9\u6570\u636e\u8fdb\u884c\u6c47\u603b\u3002</p> <p>\u5177\u4f53\u7684\u91c7\u96c6\u4efb\u52a1\u5982\u4f55\u53bb\u8fdb\u884c\u5206\u533a\u4e5f\u6ca1\u6709\u56fa\u5b9a\u7684\u6807\u51c6\uff0c\u9700\u8981\u7ed3\u5408\u5b9e\u9645\u7684\u4e1a\u52a1\u8fdb\u884c\u8003\u8651\uff0c\u9664\u4e86\u4e0a\u9762\u7684\u65b9\u5f0f\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u79cd\u60c5\u51b5\u5c31\u662f\u5355\u4e2a\u7684\u91c7\u96c6\u6570\u636e\u91cf\u5c31\u975e\u5e38\u975e\u5e38\u5927\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u91c7\u96c6\u4e0a\u4e07\u4e2a\u8282\u70b9\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u8fd9\u79cd\u60c5\u51b5\u5373\u4f7f\u6211\u4eec\u5df2\u7ecf\u8fdb\u884c\u4e86\u5206\u533a\uff0c\u4f46\u662f\u5bf9\u4e8e\u5355\u4e2a <code>Prometheus</code> \u6765\u8bf4\u538b\u529b\u4e5f\u662f\u975e\u5e38\u5927\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u6309\u7167\u4efb\u52a1\u7684\u4e0d\u540c\u5b9e\u4f8b\u8fdb\u884c\u5212\u5206\uff0c\u6211\u4eec\u901a\u8fc7 <code>Prometheus</code> \u7684 <code>relabel</code> \u529f\u80fd\uff0c\u901a\u8fc7 <code>hash</code> \u53d6\u6a21\u7684\u65b9\u5f0f\u53ef\u4ee5\u786e\u4fdd\u5f53\u524d <code>Prometheus</code> \u53ea\u91c7\u96c6\u5f53\u524d\u4efb\u52a1\u7684\u4e00\u90e8\u5206\u5b9e\u4f8b\u7684\u76d1\u63a7\u6307\u6807\u3002</p> <pre><code># \u7701\u7565\u5176\u4ed6\u914d\u7f6e......\nrelabel_configs:\n-   source_labels: [__address__]\n    modulus: 4   # \u5c06\u8282\u70b9\u5206\u7247\u6210 4 \u4e2a\u7ec4\n     target_label\uff1a __tmp_hash\n     action\uff1a hashmod\n-   source_labels\uff1a [__tmp_hash]\n    regex: ^1$   # \u53ea\u6293\u7b2c2\u4e2a\u7ec4\u4e2d\u8282\u70b9\u7684\u6570\u636e(\u5e8f\u53f70\u4e3a\u7b2c1\u4e2a\u7ec4)\n    action: keep\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u57fa\u672c\u4e0a\u5c31\u5b8c\u6210\u4e86 <code>Prometheus</code> \u9ad8\u53ef\u7528\u7684\u6539\u9020\u3002\u5bf9\u4e8e\u5c0f\u89c4\u6a21\u96c6\u7fa4\u548c\u5927\u89c4\u6a21\u96c6\u7fa4\u53ef\u4ee5\u91c7\u7528\u4e0d\u540c\u7684\u65b9\u6848\uff0c\u4f46\u662f\u5176\u4e2d\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u90e8\u5206\u5c31\u662f\u8fdc\u7a0b\u5b58\u50a8\uff0c\u6211\u4eec\u9700\u8981\u4fdd\u8bc1\u6570\u636e\u7684\u6301\u4e45\u5316\u5c31\u5fc5\u987b\u4f7f\u7528\u8fdc\u7a0b\u5b58\u50a8\u3002</p> <p>\u6240\u4ee5\u4e0b\u9762\u6211\u4eec\u5c06\u91cd\u70b9\u4ecb\u7ecd\u4e0b\u8fdc\u7a0b\u5b58\u50a8\u7684\u65f6\u5019\uff0c\u8fd9\u91cc\u6211\u4eec\u4e3b\u8981\u8bb2\u89e3\u76ee\u524d\u6bd4\u8f83\u6d41\u884c\u7684\u65b9\u6848\uff1a<code>Thanos</code>\uff0c\u5b83\u5b8c\u5168\u517c\u5bb9 P<code>rometheus API</code>\uff0c\u63d0\u4f9b\u7edf\u4e00\u67e5\u8be2\u805a\u5408\u5206\u5e03\u5f0f\u90e8\u7f72 <code>Prometheus</code> \u6570\u636e\u7684\u80fd\u529b\uff0c\u540c\u65f6\u4e5f\u652f\u6301\u6570\u636e\u957f\u671f\u5b58\u50a8\u5230\u5404\u79cd\u5bf9\u8c61\u5b58\u50a8\uff08\u6bd4\u5982 S3\u3001\u963f\u91cc\u4e91 OSS \u7b49\uff09\u4ee5\u53ca\u964d\u4f4e\u91c7\u6837\u7387\u6765\u52a0\u901f\u5927\u65f6\u95f4\u8303\u56f4\u7684\u6570\u636e\u67e5\u8be2\u3002</p>"},{"location":"chap11/34Thanos_intro/#5-thanos","title":"5 Thanos","text":"<p>Thanos \u662f\u4e00\u4e2a\u57fa\u4e8e Prometheus \u5b9e\u73b0\u7684\u76d1\u63a7\u65b9\u6848\uff0c\u5176\u4e3b\u8981\u8bbe\u8ba1\u76ee\u7684\u662f\u89e3\u51b3\u539f\u751f Prometheus \u4e0a\u7684\u75db\u70b9\uff0c\u5e76\u4e14\u505a\u8fdb\u4e00\u6b65\u7684\u63d0\u5347\uff0c\u4e3b\u8981\u7684\u7279\u6027\u6709\uff1a\u5168\u5c40\u67e5\u8be2\uff0c\u9ad8\u53ef\u7528\uff0c\u52a8\u6001\u62d3\u5c55\uff0c\u957f\u671f\u5b58\u50a8\u3002\u4e0b\u56fe\u662f Thanos \u5b98\u65b9\u7684\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>Thanos \u4e3b\u8981\u7531\u5982\u4e0b\u51e0\u4e2a\u7279\u5b9a\u529f\u80fd\u7684\u7ec4\u4ef6\u7ec4\u6210\uff1a</p> <ul> <li>\u8fb9\u8f66\u7ec4\u4ef6\uff08<code>Sidecar</code>\uff09\uff1a\u8fde\u63a5 <code>Prometheus</code>\uff0c\u5e76\u628a <code>Prometheus</code> \u66b4\u9732\u7ed9\u67e5\u8be2\u7f51\u5173\uff08<code>Querier/Query</code>\uff09\uff0c\u4ee5\u4f9b\u5b9e\u65f6\u67e5\u8be2\uff0c\u5e76\u4e14\u53ef\u4ee5\u4e0a\u4f20 <code>Prometheus</code> \u6570\u636e\u7ed9\u4e91\u5b58\u50a8\uff0c\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58</li> <li>\u67e5\u8be2\u7f51\u5173\uff08<code>Querier/Query</code>\uff09\uff1a\u5b9e\u73b0\u4e86 <code>Prometheus API</code>\uff0c\u4e0e\u6c47\u96c6\u5e95\u5c42\u7ec4\u4ef6\uff08\u5982\u8fb9\u8f66\u7ec4\u4ef6 Sidecar\uff0c\u6216\u662f\u5b58\u50a8\u7f51\u5173 Store Gateway\uff09\u7684\u6570\u636e</li> <li>\u5b58\u50a8\u7f51\u5173\uff08<code>Store Gateway</code>\uff09\uff1a\u5c06\u4e91\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u5185\u5bb9\u66b4\u9732\u51fa\u6765</li> <li>\u538b\u7f29\u5668\uff08<code>Compactor</code>\uff09\uff1a\u5c06\u4e91\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u538b\u7f29\u548c\u4e0b\u91c7\u6837</li> <li>\u63a5\u6536\u5668\uff08<code>Receiver</code>\uff09\uff1a\u4ece <code>Prometheus</code> \u7684 <code>remote-write WAL</code>\uff08Prometheus \u8fdc\u7a0b\u9884\u5199\u5f0f\u65e5\u5fd7\uff09\u83b7\u53d6\u6570\u636e\uff0c\u66b4\u9732\u51fa\u53bb\u6216\u8005\u4e0a\u4f20\u5230\u4e91\u5b58\u50a8</li> <li>\u89c4\u5219\u7ec4\u4ef6\uff08<code>Ruler</code>\uff09\uff1a\u9488\u5bf9\u76d1\u63a7\u6570\u636e\u8fdb\u884c\u8bc4\u4f30\u548c\u62a5\u8b66</li> <li><code>Bucket</code>\uff1a\u4e3b\u8981\u7528\u4e8e\u5c55\u793a\u5bf9\u8c61\u5b58\u50a8\u4e2d\u5386\u53f2\u6570\u636e\u7684\u5b58\u50a8\u60c5\u51b5\uff0c\u67e5\u770b\u6bcf\u4e2a\u6307\u6807\u6e90\u4e2d\u6570\u636e\u5757\u7684\u538b\u7f29\u7ea7\u522b\uff0c\u89e3\u6790\u5ea6\uff0c\u5b58\u50a8\u65f6\u6bb5\u548c\u65f6\u95f4\u957f\u5ea6\u7b49\u4fe1\u606f\u3002</li> </ul>"},{"location":"chap11/34Thanos_intro/#6","title":"6 \u5de5\u4f5c\u6d41\u7a0b","text":"<p>Thanos \u662f\u540c\u65f6\u652f\u6301 <code>Prometheus</code> \u8bfb\u548c\u5199\u7684\u8fdc\u7a0b\u5b58\u50a8\u65b9\u6848\uff0c\u9996\u5148\u6211\u4eec\u5148\u770b\u4e0b\u6307\u6807\u5199\u5165\u7684\u6574\u4e2a\u6d41\u7a0b\uff1a</p> <ul> <li>\u9996\u5148 <code>Prometheus</code> \u4ece\u6240\u91c7\u96c6\u670d\u52a1\u7684 <code>metrics</code> \u63a5\u53e3\u6293\u53d6\u6307\u6807\u6570\u636e\uff0c\u540c\u65f6\u6839\u636e\u81ea\u8eab\u6240\u914d\u7f6e\u7684 <code>recording rules</code> \u5b9a\u671f\u5bf9\u6293\u53d6\u5230\u7684\u6307\u6807\u6570\u636e\u8fdb\u884c\u8bc4\u4f30\uff0c\u5c06\u7ed3\u679c\u4ee5 <code>TSDB</code> \u683c\u5f0f\u5206\u5757\u5b58\u50a8\u5230\u672c\u5730\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u7684\u5b58\u50a8\u65f6\u957f\u4e3a2\u5c0f\u65f6\uff0c\u4e14\u9ed8\u8ba4\u7981\u7528\u4e86\u538b\u7f29\u529f\u80fd\u3002</li> <li>\u7136\u540e <code>sidecar</code> \u55c5\u63a2\u5230<code>Prometheus</code> \u7684\u6570\u636e\u5b58\u50a8\u76ee\u5f55\u751f\u6210\u4e86\u65b0\u7684\u53ea\u8bfb\u6570\u636e\u5757\u65f6\uff0c\u4f1a\u5c06\u8be5\u6570\u636e\u5757\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u6876\u4e2d\u505a\u4e3a\u957f\u671f\u5386\u53f2\u6570\u636e\u4fdd\u5b58\uff0c\u5728\u4e0a\u4f20\u65f6\u4f1a\u5c06\u6570\u636e\u5757\u4e2d\u7684 <code>meta.json</code>\u8fdb\u884c\u4fee\u6539\u6dfb\u52a0 <code>thanos</code> \u76f8\u5173\u7684\u5b57\u6bb5\uff0c\u5982 <code>external_labels</code>\u3002</li> <li><code>rule</code> \u6839\u636e\u6240\u914d\u7f6e\u7684 <code>recording rules</code> \u5b9a\u671f\u5730\u5411 <code>query</code> \u53d1\u8d77\u67e5\u8be2\u83b7\u53d6\u8bc4\u4f30\u6240\u9700\u7684\u6307\u6807\u503c\uff0c\u5e76\u5c06\u7ed3\u679c\u4ee5 <code>TSDB</code> \u683c\u5f0f\u5206\u5757\u5b58\u50a8\u5230\u672c\u5730\u3002\u6bcf\u4e2a\u6570\u636e\u5757\u7684\u5b58\u50a8\u65f6\u957f\u4e3a<code>2</code>\u5c0f\u65f6\uff0c\u4e14\u9ed8\u8ba4\u7981\u7528\u4e86\u538b\u7f29\u529f\u80fd\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u7684 <code>meta.json</code> \u4e5f\u9644\u5e26\u4e86 <code>thanos</code> \u62d3\u5c55\u7684 <code>external_lables</code> \u5b57\u6bb5\u3002\u5f53\u672c\u5730\u751f\u6210\u4e86\u65b0\u7684\u53ea\u8bfb\u6570\u636e\u5757\u65f6\uff0c\u5176\u81ea\u8eab\u4f1a\u5c06\u8be5\u6570\u636e\u5757\u4e0a\u4f20\u5230\u8fdc\u7aef\u5bf9\u8c61\u5b58\u50a8\u6876\u4e2d\u505a\u4e3a\u957f\u671f\u5386\u53f2\u6570\u636e\u4fdd\u5b58\u3002</li> <li><code>compact</code> \u5b9a\u671f\u5c06\u5bf9\u8c61\u5b58\u50a8\u4e2d\u5730\u6570\u636e\u5757\u8fdb\u884c\u538b\u7f29\u548c\u964d\u51c6\u91c7\u6837\uff0c\u8fdb\u884c\u538b\u7f29\u65f6\u6570\u636e\u5757\u4e2d\u7684 <code>truck</code>\u4f1a\u8fdb\u884c\u5408\u5e76\uff0c\u5bf9\u5e94\u7684 <code>meta.json</code> \u4e2d\u7684 <code>level</code> \u4e5f\u4f1a\u4e00\u540c\u589e\u957f\uff0c\u6bcf\u6b21\u538b\u7f29\u7d2f\u52a0<code>1</code>\uff0c\u521d\u59cb\u503c\u4e3a<code>1</code>\u3002\u5728\u8fdb\u884c\u964d\u51c6\u91c7\u6837\u65f6\u4f1a\u521b\u5efa\u65b0\u7684\u6570\u636e\u5757\uff0c\u6839\u636e\u91c7\u6837\u6b65\u957f\u4ece\u539f\u6709\u7684\u6570\u636e\u5757\u4e2d\u62bd\u53d6\u503c\u5b58\u50a8\u5230\u65b0\u7684\u6570\u636e\u5757\u4e2d\uff0c\u5728 <code>meta.json</code>\u4e2d\u8bb0\u5f55 <code>resolution</code> \u4e3a\u91c7\u6837\u6b65\u957f\u3002</li> </ul> <p>\u8bfb\u53d6\u6307\u6807\u7684\u6d41\u7a0b\u4e3a\uff1a</p> <ul> <li>\u9996\u5148\u5ba2\u6237\u7aef\u901a\u8fc7 <code>query API</code> \u5411 <code>query</code> \u53d1\u8d77\u67e5\u8be2\uff0c <code>query</code> \u5c06\u8bf7\u6c42\u8f6c\u6362\u6210 <code>StoreAPI</code>\u53d1\u9001\u5230\u5176\u4ed6\u7684 <code>query</code>\u3001 <code>sidecar</code>\u3001 <code>rule</code> \u548c <code>store</code> \u4e0a\u3002</li> <li><code>sidecar</code> \u63a5\u6536\u5230\u6765\u81ea\u4e8e <code>query</code> \u53d1\u8d77\u7684\u67e5\u8be2\u8bf7\u6c42\u540e\u5c06\u5176\u8f6c\u6362\u6210 <code>query API</code> \u8bf7\u6c42\uff0c\u53d1\u9001\u7ed9\u5176\u7ed1\u5b9a\u7684 <code>Prometheus</code>\uff0c\u7531<code>Prometheus</code> \u4ece\u672c\u5730\u8bfb\u53d6\u6570\u636e\u5e76\u54cd\u5e94\uff0c\u8fd4\u56de\u77ed\u671f\u7684\u672c\u5730\u91c7\u96c6\u548c\u8bc4\u4f30\u6570\u636e\u3002</li> <li><code>rule</code> \u63a5\u6536\u5230\u6765\u81ea\u4e8e <code>query</code> \u53d1\u8d77\u7684\u67e5\u8be2\u8bf7\u6c42\u540e\u76f4\u63a5\u4ece\u672c\u5730\u8bfb\u53d6\u6570\u636e\u5e76\u54cd\u5e94\uff0c\u8fd4\u56de\u77ed\u671f\u7684\u672c\u5730\u8bc4\u4f30\u6570\u636e\u3002</li> <li><code>store</code> \u63a5\u6536\u5230\u6765\u81ea\u4e8e <code>query</code> \u53d1\u8d77\u7684\u67e5\u8be2\u8bf7\u6c42\u540e\u9996\u5148\u4ece\u5bf9\u8c61\u5b58\u50a8\u6876\u4e2d\u904d\u5386\u6570\u636e\u5757\u7684 <code>meta.json</code>\uff0c\u6839\u636e\u5176\u4e2d\u8bb0\u5f55\u7684\u65f6\u95f4\u8303\u56f4\u548c\u6807\u7b7e\u5148\u8fdb\u884c\u4e00\u6b21\u8fc7\u6ee4\u3002\u63a5\u4e0b\u6765\u4ece\u5bf9\u8c61\u5b58\u50a8\u6876\u4e2d\u8bfb\u53d6\u6570\u636e\u5757\u7684 <code>index</code>\u548c <code>chunks</code> \u8fdb\u884c\u67e5\u8be2\uff0c\u90e8\u5206\u67e5\u8be2\u9891\u7387\u8f83\u9ad8\u7684 <code>index</code> \u4f1a\u88ab\u7f13\u5b58\u4e0b\u6765\uff0c\u4e0b\u6b21\u67e5\u8be2\u4f7f\u7528\u5230\u65f6\u53ef\u4ee5\u76f4\u63a5\u8bfb\u53d6\u3002\u6700\u7ec8\u8fd4\u56de\u957f\u671f\u7684\u5386\u53f2\u91c7\u96c6\u548c\u8bc4\u4f30\u6307\u6807\u3002</li> </ul> <p>\u5bf9\u4e8e\u53d1\u9001\u62a5\u8b66\u7684\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li><code>Prometheus</code> \u6839\u636e\u81ea\u8eab\u914d\u7f6e\u7684 <code>alerting</code> \u89c4\u5219\u5b9a\u671f\u5730\u5bf9\u81ea\u8eab\u91c7\u96c6\u7684\u6307\u6807\u8fdb\u884c\u8bc4\u4f30\uff0c\u5f53\u544a\u8b66\u6761\u4ef6\u6ee1\u8db3\u7684\u60c5\u51b5\u4e0b\u53d1\u8d77\u544a\u8b66\u5230 <code>Alertmanager</code> \u4e0a\u3002</li> <li><code>rule</code> \u6839\u636e\u81ea\u8eab\u914d\u7f6e\u7684 <code>alerting</code> \u89c4\u5219\u5b9a\u671f\u7684\u5411 <code>query</code> \u53d1\u8d77\u67e5\u8be2\u8bf7\u6c42\u83b7\u53d6\u8bc4\u4f30\u6240\u9700\u7684\u6307\u6807\uff0c\u5f53\u544a\u8b66\u6761\u4ef6\u6ee1\u8db3\u7684\u60c5\u51b5\u4e0b\u53d1\u8d77\u544a\u8b66\u5230 <code>Alertmanage</code>r \u4e0a\u3002</li> <li><code>Alertmanager</code> \u63a5\u6536\u5230\u6765\u81ea\u4e8e <code>Prometheus</code> \u548c <code>rule</code> \u7684\u544a\u8b66\u6d88\u606f\u540e\u8fdb\u884c\u5206\u7ec4\u5408\u5e76\u540e\u53d1\u51fa\u544a\u8b66\u901a\u77e5\u3002</li> </ul>"},{"location":"chap11/35Thanos_install/","title":"\u7b2c\u4e09\u8282 Prometheus\u9ad8\u53ef\u7528Thanos\u5b66\u4e60-sidercar\u548cquery &amp; Thanos\u90e8\u7f72","text":"<p><code>kubectl create namespace thanos</code></p> <p>\u6700\u8fd1\u5de5\u4f5c\u4e2d\u7684\u4e3b\u8981\u4efb\u52a1\u90fd\u662f\u5728\u4e1a\u52a1\u7684\u9ad8\u53ef\u7528\u4e0a\uff0c\u7531\u4e8e\u9879\u76ee\u4e2d\u4f7f\u7528\u5230\u4e86Promethues\uff0c\u6240\u4ee5\u4e5f\u82b1\u4e86\u4e00\u4e9b\u65f6\u95f4\u7814\u7a76\u4e86\u4e00\u4e0bPromethues\u7684\u9ad8\u53ef\u7528\u65b9\u6848\u3002\u53d1\u73b0\u4e5f\u6ca1\u6709blog\u544a\u8bc9\u600e\u4e48\u53bbdeploy\u4e00\u4e2aThanos\u7684\u96c6\u7fa4\uff0c\u6240\u4ee5\u672c\u6587\u4e5f\u4f1a\u7ed9\u51fadeploy\u7684\u65b9\u6cd5\u548c\u6e90\u6587\u4ef6</p> <p>\u7531\u4e8e<code>Promethues</code>\u672c\u8eab\u4ec5\u662f\u4e00\u4e2a\u91c7\u6837\u7cfb\u7edf\uff0c\u5982\u679c\u505a\u6210<code>master-slave\u6a21</code>\u5f0f\uff0c\u5b58\u5728\u5207\u6362\u5f00\u9500\uff0c\u5e76\u4e14\u589e\u52a0\u7cfb\u7edf\u7684\u590d\u6742\u6027\u3002\u56e0\u6b64\u5b98\u65b9\u7ed9\u51fa\u7684\u9ad8\u53ef\u7528\u5efa\u8bae\u65b9\u6848\u5982\u4e0b\u56fe\uff0c\u4f7f\u7528\u591a\u4e2a\u5bf9\u7b49\u7684<code>Promethues</code>\uff0c\u5bf9\u6240\u6709\u7684<code>DataSource</code>\u5747\u8fdb\u884c\u91c7\u6837\u3002\u8fd9\u91cc\u7684<code>Service</code>\u662f<code>K8S</code>\u7684<code>Service</code>\uff0c\u6240\u4ee5\u7406\u8bba\u4e0a\u8bbf\u95ee\u8be5<code>Service</code>\u4f1a\u968f\u673a\u5730\u8bbf\u95ee\u540e\u7aef\u7684\u4e24\u4e2a<code>Promethues</code>\u3002</p> <p></p> <p>\u4e0a\u9762\u65b9\u6848\u4e2d\uff0c\u5f53\u5176\u4e2d\u4e00\u4e2a<code>Promethues pod</code>\u4e2d\u65ad\u65f6\uff0c<code>K8S</code>\u4f1a\u5c06\u6d41\u91cf\u4ec5\u5bfc\u5411\u53e6\u5916\u4e00\u4e2a<code>pod</code>\u3002\u4f46\u662f<code>pod</code>\u4e2d\u65ad\u671f\u95f4\uff0c\u5176\u65e0\u6cd5\u83b7\u53d6\u6570\u636e\uff0c\u56e0\u6b64\u5f53\u4e2d\u65ad\u7684<code>pod</code>\u6062\u590d\u4e4b\u540e\uff0c\u5728\u5b58\u50a8\u7aef\uff0c\u9700\u8981\u8fdb\u884c<code>sync</code>\u3002\u53ef\u662f\uff0c\u4f55\u65f6<code>sync</code>\uff0c\u600e\u4e48<code>sync</code>\u662f\u4e00\u4e2a\u6bd4\u8f83\u590d\u6742\u7684\u95ee\u9898\uff0c\u5c31\u7b97\u80fd\u89e3\u51b3\u8fd9\u4e24\u4e2a\u95ee\u9898\uff0c\u5b9e\u9645\u751f\u4ea7\u73af\u5883\u4e2d\u8fdb\u884c\u6587\u4ef6<code>sync</code>\uff0c\u672c\u8eab\u4e5f\u4f1a\u5b58\u5728\u5404\u5f0f\u5404\u6837\u7684\u98ce\u9669\u3002</p> <p>\u6240\u4ee5<code>Thanos</code>\u5c31\u6ca1\u6709\u4f7f\u7528\u5b58\u50a8\u7aef<code>Sync</code>\u7684\u65b9\u6cd5\u6765\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\uff0c\u800c\u662f\u91c7\u7528\u624d<code>query</code>\u7aef\u5bf9\u67e5\u8be2\u5230\u7684\u6570\u636e\u8fdb\u884c\u5408\u5e76\u3002\u4e0b\u9762\u4f1a\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e0bThanos\u7684\u539f\u7406\u3002</p>"},{"location":"chap11/35Thanos_install/#1-thanos","title":"1. Thanos\u57fa\u672c\u539f\u7406","text":"<p>\u57fa\u4e8e\u5b98\u65b9\u7684\u4ecb\u7ecd\uff0c\u6211\u5c06<code>Thanos</code>\u7684\u67b6\u6784\u7b80\u5316\uff0c\u4ec5\u4fdd\u5b58\u6700\u57fa\u672c\u7684\uff0c\u6211\u6240\u5173\u5fc3\u7684\u90e8\u5206\u5982\u4e0b\uff0c \u4e3b\u8981\u5305\u542b3\u90e8\u5206\uff1a</p> <ol> <li>Thanos Query. \u4e3b\u8981\u662f\u5bf9\u4ece<code>Promethues Pod</code>\u91c7\u96c6\u6765\u7684\u6570\u636e\u8fdb\u884c<code>merge</code>\uff0c\u63d0\u4f9b\u67e5\u8be2\u63a5\u53e3\u7ed9\u5ba2\u6237\u7aef\uff08\u5b98\u65b9\u6587\u6863\u4e0a\u6682\u65f6\u6ca1\u770b\u5230<code>merge</code>\u7684\u539f\u7406\uff0c\u8fd9\u7bc7\u603b\u7ed3\u4e4b\u540e\u9700\u8981\u82b1\u4e9b\u65f6\u95f4\u770b\u6e90\u7801\u5b66\u4e60\u4e00\u4e0b\uff09\uff1b</li> <li>Thanos SideCar. \u5c06<code>Promethues container</code>\u7684\u6570\u636e\u8fdb\u884c\u5c01\u88c5\uff0c\u4ee5\u63d0\u4f9b\u63a5\u53e3\u7ed9<code>Thanos Query</code>\uff08\u5b9e\u9645\u4e0aSideCar\u8fd8\u80fd\u63d0\u4f9b\u66f4\u591a\u7528\u5904\uff0c\u4f46\u662f\u8fd9\u91cc\u6682\u65f6\u6211\u4eec\u4ec5\u5173\u5fc3\u6570\u636e\u67e5\u8be2\uff0c\u540e\u9762\u518d\u8fdb\u4e00\u6b65\u7814\u7a76\uff0c\u6682\u65f6\u4e0d\u8981\u56fe\u591a\uff09</li> <li><code>Prometheus Container</code>. \u91c7\u96c6\u6570\u636e\uff0c\u901a\u8fc7<code>Remote Read API</code>\u63d0\u4f9b\u63a5\u53e3\u7ed9<code>Thanos SideCar</code>\u3002</li> </ol> <p></p>"},{"location":"chap11/35Thanos_install/#2-thanos","title":"2. Thanos\u90e8\u7f72","text":"<p>\u672c\u6587\u805a\u7126 Thanos \u7684\u4e91\u539f\u751f\u90e8\u7f72\u65b9\u5f0f\uff0c\u5145\u5206\u5229\u7528 Kubernetes \u7684\u8d44\u6e90\u8c03\u5ea6\u4e0e\u52a8\u6001\u6269\u5bb9\u80fd\u529b\u3002\u4ece\u5b98\u65b9\u6587\u6863\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u524d Thanos \u5728 Kubernetes \u4e0a\u90e8\u7f72\u6709\u4ee5\u4e0b\u4e09\u79cd\uff1a</p> <ul> <li><code>prometheus-operator</code>\uff1a\u96c6\u7fa4\u4e2d\u5b89\u88c5\u4e86 <code>prometheus-operator</code> \u540e\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa CRD \u5bf9\u8c61\u6765\u90e8\u7f72 Thanos \u4e86\uff1b</li> <li>\u793e\u533a\u8d21\u732e\u7684\u4e00\u4e9b <code>helm charts</code>\uff1a\u5f88\u591a\u4e2a\u7248\u672c\uff0c\u76ee\u6807\u90fd\u662f\u80fd\u591f\u4f7f\u7528 helm \u6765\u4e00\u952e\u90e8\u7f72 thanos\uff1b</li> <li><code>kube-thanos\uff1aThanos</code> \u5b98\u65b9\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u5305\u542b\u90e8\u7f72 <code>thanos</code> \u5230 <code>kubernetes</code> \u7684 <code>jsonnet</code> \u6a21\u677f\u4e0e <code>yaml</code> \u793a\u4f8b\u3002</li> </ul> <p>\u672c\u6587\u5c06\u4f7f\u7528\u57fa\u4e8e kube-thanos \u63d0\u4f9b\u7684 yaml \u793a\u4f8b (<code>examples/all/manifests</code>) \u6765\u90e8\u7f72\uff0c\u539f\u56e0\u662f <code>prometheus-operator</code> \u4e0e\u793e\u533a\u7684 <code>helm chart</code> \u65b9\u5f0f\u90e8\u7f72\u591a\u4e86\u4e00\u5c42\u5c01\u88c5\uff0c\u5c4f\u853d\u4e86\u8bb8\u591a\u7ec6\u8282\uff0c\u5e76\u4e14\u5b83\u4eec\u7684\u5b9e\u73b0\u90fd\u8fd8\u4e0d\u592a\u6210\u719f\u3002</p> <p>\u76f4\u63a5\u4f7f\u7528 <code>kubernetes</code> \u7684 <code>yaml</code> \u8d44\u6e90\u6587\u4ef6\u90e8\u7f72\u66f4\u76f4\u89c2\uff0c\u4e5f\u66f4\u5bb9\u6613\u505a\u81ea\u5b9a\u4e49\uff0c\u800c\u4e14\u6211\u76f8\u4fe1 Thanos \u7528\u6237\u901a\u5e38\u90fd\u662f\u9ad8\u73a9\uff0c\u6709\u5fc5\u8981\u5bf9 <code>thanos</code> \u7406\u89e3\u900f\u5f7b\uff0c\u65e5\u540e\u624d\u80fd\u66f4\u597d\u5730\u6839\u636e\u5b9e\u9645\u573a\u666f\u505a\u67b6\u6784\u548c\u914d\u7f6e\u7684\u8c03\u6574\uff0c\u76f4\u63a5\u4f7f\u7528 <code>yaml</code> \u90e8\u7f72\u80fd\u591f\u8ba9\u6211\u4eec\u770b\u6e05\u7ec6\u8282\u3002</p>"},{"location":"chap11/35Thanos_install/#3","title":"3 \u65b9\u6848","text":"<p>\u6211\u4eec\u518d\u6765\u770b\u770b\u5982\u4f55\u9009\u578b\u90e8\u7f72\u65b9\u6848\u3002</p>"},{"location":"chap11/35Thanos_install/#3-1-sidecar-or-receiver","title":"3-1 Sidecar or Receiver","text":"<p><code>Receiver</code> \u65b9\u6848\u662f\u8ba9 <code>Prometheus</code> \u901a\u8fc7 <code>remote wirte API</code> \u5c06\u6570\u636e <code>push</code> \u5230 <code>Receiver</code>\u96c6\u4e2d\u5b58\u50a8\uff08\u540c\u6837\u4f1a\u6e05\u7406\u8fc7\u671f\u6570\u636e\uff09\uff1a</p> <p></p> <p>\u90a3\u4e48\u8be5\u9009\u54ea\u79cd\u65b9\u6848\u5462\uff1f\u6211\u7684\u5efa\u8bae\u662f\uff1a</p> <ul> <li>\u5982\u679c\u4f60\u7684 <code>Query</code> \u8ddf <code>Sidecar</code> \u79bb\u7684\u6bd4\u8f83\u8fdc\uff0c\u6bd4\u5982 <code>Sidecar</code> \u5206\u5e03\u5728\u591a\u4e2a\u6570\u636e\u4e2d\u5fc3\uff0c<code>Query</code> \u5411\u6240\u6709 <code>Sidecar</code> \u67e5\u6570\u636e\uff0c\u901f\u5ea6\u4f1a\u5f88\u6162\uff0c\u8fd9\u79cd\u60c5\u51b5\u53ef\u4ee5\u8003\u8651\u7528 <code>Receiver</code>\uff0c\u5c06\u6570\u636e\u96c6\u4e2d\u5410\u5230 <code>Receiver</code>\uff0c\u7136\u540e <code>Receiver</code> \u4e0e <code>Query</code> \u90e8\u7f72\u5728\u4e00\u8d77\uff0c<code>Query</code> \u76f4\u63a5\u5411 <code>Receiver</code> \u67e5\u6700\u65b0\u6570\u636e\uff0c\u63d0\u5347\u67e5\u8be2\u6027\u80fd\uff1b</li> <li>\u5982\u679c\u4f60\u7684\u4f7f\u7528\u573a\u666f\u53ea\u5141\u8bb8 <code>Prometheus</code> \u5c06\u6570\u636e <code>push</code> \u5230\u8fdc\u7a0b\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 <code>Receiver</code>\u3002\u6bd4\u5982 <code>IoT</code> \u8bbe\u5907\u6ca1\u6709\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u53ea\u80fd\u5c06\u6570\u636e <code>push</code> \u5230\u8fdc\u7a0b\u3002</li> </ul> <p>\u6b64\u5916\u7684\u573a\u666f\u5e94\u8be5\u90fd\u5c3d\u91cf\u4f7f\u7528 Sidecar \u65b9\u6848\u3002</p>"},{"location":"chap11/35Thanos_install/#3-2-ruler","title":"3-2 \u8bc4\u4f30\u662f\u5426\u9700\u8981 Ruler","text":"<p><code>Ruler</code> \u662f\u4e00\u4e2a\u53ef\u9009\u7ec4\u4ef6\uff0c\u539f\u5219\u4e0a\u63a8\u8350\u5c3d\u91cf\u4f7f\u7528 <code>Prometheus</code> \u81ea\u5e26\u7684 <code>rule</code> \u529f\u80fd\uff08\u751f\u6210\u65b0\u6307\u6807+\u544a\u8b66\uff09\uff0c\u8fd9\u4e2a\u529f\u80fd\u9700\u8981\u4e00\u4e9b <code>Prometheus</code> \u6700\u65b0\u6570\u636e\uff0c\u76f4\u63a5\u4f7f\u7528 <code>Prometheus</code> \u672c\u673a <code>rule</code> \u529f\u80fd\u548c\u6570\u636e\uff0c\u6027\u80fd\u5f00\u9500\u76f8\u6bd4 <code>Thanos Ruler</code> \u8fd9\u79cd\u5206\u5e03\u5f0f\u65b9\u6848\u5c0f\u5f97\u591a\uff0c\u5e76\u4e14\u51e0\u4e4e\u4e0d\u4f1a\u51fa\u9519\uff0c<code>Thanos Ruler</code> \u7531\u4e8e\u662f\u5206\u5e03\u5f0f\uff0c\u6240\u4ee5\u66f4\u5bb9\u6613\u51fa\u9519\u4e00\u4e9b\u3002</p> <p>\u5982\u679c\u67d0\u4e9b\u6709\u5173\u8054\u7684\u6570\u636e\u5206\u6563\u5728\u591a\u4e2a\u4e0d\u540c <code>Prometheus</code> \u4e0a\uff0c\u6bd4\u5982\u5bf9\u67d0\u4e2a\u5927\u89c4\u6a21\u670d\u52a1\u91c7\u96c6\u505a\u4e86\u5206\u7247\uff0c\u6bcf\u4e2a <code>Prometheus</code> \u4ec5\u91c7\u96c6\u4e00\u90e8\u5206 <code>endpoint</code> \u7684\u6570\u636e\uff0c\u5bf9\u4e8e <code>record</code>\u7c7b\u578b\u7684 <code>rule</code> \uff08\u751f\u6210\u7684\u65b0\u6307\u6807\uff09\uff0c\u8fd8\u662f\u53ef\u4ee5\u4f7f\u7528 <code>Prometheus</code> \u81ea\u5e26\u7684 <code>rule</code>\u529f\u80fd\uff0c\u5728\u67e5\u8be2\u65f6\u518d\u805a\u5408\u4e00\u4e0b\u5c31\u53ef\u4ee5\uff08\u5982\u679c\u53ef\u4ee5\u63a5\u53d7\u7684\u8bdd\uff09\u3002</p> <p>\u5bf9\u4e8e <code>alert</code> \u7c7b\u578b\u7684 <code>rule</code>\uff0c\u6211\u4eec\u5c31\u9700\u8981\u7528 <code>Thanos Ruler</code> \u6765\u505a\u4e86\uff0c\u56e0\u4e3a\u6709\u5173\u8054\u7684\u6570\u636e\u5206\u6563\u5728\u591a\u4e2a <code>Prometheus</code> \u4e0a\uff0c\u7528\u5355\u673a\u6570\u636e\u53bb\u505a <code>alert</code> \u8ba1\u7b97\u662f\u4e0d\u51c6\u786e\u7684\uff0c\u53ef\u80fd\u4f1a\u9020\u6210\u8bef\u544a\u8b66\u6216\u4e0d\u544a\u8b66\u3002</p>"},{"location":"chap11/35Thanos_install/#3-3-store-gatewaycompact","title":"3-3 \u8bc4\u4f30\u662f\u5426\u9700\u8981Store Gateway\u4e0eCompact","text":"<p>Store \u4e5f\u662f\u4e00\u4e2a\u53ef\u9009\u7ec4\u4ef6\uff0c\u4e5f\u662f Thanos \u7684\u4e00\u5927\u4eae\u70b9\u7684\u5173\u952e\uff1a\u6570\u636e\u957f\u671f\u4fdd\u5b58\u3002</p> <p>\u8bc4\u4f30\u662f\u5426\u9700\u8981 Store \u7ec4\u4ef6\u5b9e\u9645\u5c31\u662f\u8bc4\u4f30\u4e00\u4e0b\u81ea\u5df1\u662f\u5426\u6709\u6570\u636e\u957f\u671f\u5b58\u50a8\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u67e5\u770b\u4e00\u4e24\u4e2a\u6708\u524d\u7684\u76d1\u63a7\u6570\u636e\u3002\u5982\u679c\u6709\uff0c\u90a3\u4e48 Thanos \u53ef\u4ee5\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4fdd\u5b58\u3002</p> <p>Thanos \u652f\u6301\u4ee5\u4e0b\u5bf9\u8c61\u5b58\u50a8\uff1a</p> <ul> <li>Google Cloud Storage</li> <li>AWS/S3</li> <li>Azure Storage Account</li> <li>OpenStack Swift</li> <li>Tencent COS</li> <li>AliYun OSS</li> </ul> <p>\u5728\u56fd\u5185\uff0c\u6700\u65b9\u4fbf\u8fd8\u662f\u4f7f\u7528\u56fd\u5185\u4e3b\u6d41\u516c\u6709\u4e91\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u3002\u5982\u679c\u4f60\u7684\u670d\u52a1\u6ca1\u6709\u8dd1\u5728\u516c\u6709\u4e91\u4e0a\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8ddf\u4e91\u670d\u52a1\u5382\u5546\u62c9\u4e13\u7ebf\u7684\u65b9\u5f0f\u6765\u8d70\u5185\u7f51\u4f7f\u7528\u5bf9\u8c61\u5b58\u50a8\uff0c\u8fd9\u6837\u901f\u5ea6\u901a\u5e38\u4e5f\u662f\u53ef\u4ee5\u6ee1\u8db3\u9700\u6c42\u7684\uff1b\u5982\u679c\u5b9e\u5728\u7528\u4e0d\u4e86\u516c\u6709\u4e91\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\uff0c\u4e5f\u53ef\u4ee5\u81ea\u5df1\u5b89\u88c5 minio \u6765\u642d\u5efa\u517c\u5bb9 AWS \u7684 S3 \u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u3002</p> <p>\u641e\u5b9a\u4e86\u5bf9\u8c61\u5b58\u50a8\uff0c\u8fd8\u9700\u8981\u7ed9 <code>Thanos</code> \u591a\u4e2a\u7ec4\u4ef6\u914d\u7f6e\u5bf9\u8c61\u5b58\u50a8\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u4ee5\u4fbf\u80fd\u591f\u4e0a\u4f20\u4e0e\u8bfb\u53d6\u76d1\u63a7\u6570\u636e\u3002\u9664 Query \u4ee5\u5916\u7684\u6240\u6709 Thanos \u7ec4\u4ef6\uff08<code>Sidecar</code>\u3001<code>Receiver</code>\u3001<code>Ruler</code>\u3001<code>Store Gateway</code>\u3001<code>Compac</code>t\uff09\u90fd\u9700\u8981\u914d\u7f6e\u5bf9\u8c61\u5b58\u50a8\u4fe1\u606f\uff0c\u4f7f\u7528 <code>--objstore.config</code>\u76f4\u63a5\u914d\u7f6e\u5185\u5bb9\u6216 <code>--objstore.config-file</code> \u5f15\u7528\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e\u6587\u4ef6\uff0c\u4e0d\u540c\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e\u65b9\u5f0f\u4e0d\u4e00\u6837\uff0c\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff1ahttps://thanos.io/storage.md</p> <p>\u901a\u5e38\u4f7f\u7528\u4e86\u5bf9\u8c61\u5b58\u50a8\u6765\u957f\u671f\u4fdd\u5b58\u6570\u636e\u4e0d\u6b62\u8981\u5b89\u88c5 <code>Store Gateway</code>\uff0c\u8fd8\u9700\u8981\u5b89\u88c5 <code>Compact</code>  \u6765\u5bf9\u5bf9\u8c61\u5b58\u50a8\u91cc\u7684\u6570\u636e\u8fdb\u884c\u538b\u7f29\u4e0e\u964d\u91c7\u6837\uff0c\u8fd9\u6837\u53ef\u4ee5\u63d0\u5347\u67e5\u8be2\u5927\u65f6\u95f4\u8303\u56f4\u76d1\u63a7\u6570\u636e\u7684\u6027\u80fd\u3002</p> <p>\u6ce8\u610f\uff1a<code>Compact</code> \u5e76\u4e0d\u4f1a\u51cf\u5c11\u5bf9\u8c61\u5b58\u50a8\u7684\u4f7f\u7528\u7a7a\u95f4\uff0c\u800c\u662f\u4f1a\u589e\u52a0\uff0c\u589e\u52a0\u66f4\u957f\u91c7\u6837\u95f4\u9694\u7684\u76d1\u63a7\u6570\u636e\uff0c\u8fd9\u6837\u5f53\u67e5\u8be2\u5927\u65f6\u95f4\u8303\u56f4\u6570\u636e\u65f6\uff0c\u5c31\u81ea\u52a8\u62c9\u53d6\u66f4\u957f\u65f6\u95f4\u95f4\u9694\u91c7\u6837\u7684\u6570\u636e\u4ee5\u51cf\u5c11\u67e5\u8be2\u6570\u636e\u7684\u603b\u91cf\uff0c\u4ece\u800c\u52a0\u5feb\u67e5\u8be2\u901f\u5ea6 \uff08\u5927\u65f6\u95f4\u8303\u56f4\u7684\u6570\u636e\u4e0d\u9700\u8981\u90a3\u4e48\u7cbe\u7ec6\uff09\uff0c\u5f53\u653e\u5927\u67e5\u770b\u65f6\uff08\u9009\u62e9\u5176\u4e2d\u4e00\u5c0f\u6bb5\u65f6\u95f4\uff09\uff0c\u53c8\u81ea\u52a8\u9009\u62e9\u62c9\u53d6\u66f4\u77ed\u91c7\u6837\u95f4\u9694\u7684\u6570\u636e\uff0c\u4ece\u800c\u4e5f\u80fd\u663e\u793a\u51fa\u5c0f\u65f6\u95f4\u8303\u56f4\u7684\u76d1\u63a7\u7ec6\u8282\u3002</p>"},{"location":"chap11/35Thanos_install/#3-4","title":"3-4 \u90e8\u7f72\u5b9e\u8df5","text":"<p>\u8fd9\u91cc\u4ee5 Thanos \u6700\u65b0\u7248\u672c\u4e3a\u4f8b\uff0c\u9009\u62e9 Sidecar \u65b9\u6848\uff0c\u4ecb\u7ecd\u5404\u4e2a\u7ec4\u4ef6\u7684 K8s yaml \u5b9a\u4e49\u65b9\u5f0f\u5e76\u89e3\u91ca\u4e00\u4e9b\u91cd\u8981\u7ec6\u8282\uff08\u6839\u636e\u81ea\u8eab\u9700\u6c42\uff0c\u53c2\u8003\u4e0a\u4e00\u8282\u7684\u65b9\u6848\u9009\u578b\uff0c\u81ea\u884c\u8bc4\u4f30\u9700\u8981\u5b89\u88c5\u54ea\u4e9b\u7ec4\u4ef6\uff09\u3002</p> <p>\u51c6\u5907\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e</p> <p>\u5982\u679c\u6211\u4eec\u8981\u4f7f\u7528\u5bf9\u8c61\u5b58\u50a8\u6765\u957f\u671f\u4fdd\u5b58\u6570\u636e\uff0c\u90a3\u4e48\u5c31\u8981\u51c6\u5907\u4e0b\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\u4fe1\u606f \uff08<code>thanos-objectstorage-secret.yaml</code>\uff09\uff0c\u6bd4\u5982\u4f7f\u7528\u817e\u8baf\u4e91 COS \u6765\u5b58\u50a8\uff1a</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: thanos-objectstorage\n  namespace: thanos\ntype: Opaque\nstringData:\n  objectstorage.yaml: |\n    type: COS\n    config:\n      bucket: \"thanos\"\n      region: \"ap-singapore\"\n      app_id: \"12*******5\"\n      secret_key: \"tsY***************************Edm\"\n      secret_id: \"AKI******************************gEY\"\n</code></pre> <p>\u6216\u8005\u4f7f\u7528\u963f\u91cc\u4e91 OSS \u5b58\u50a8\uff1a</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: thanos-objectstorage\n  namespace: thanos\ntype: Opaque\nstringData:\n  objectstorage.yaml: |\n    type: ALIYUNOSS\n    config:\n      endpoint: \"oss-cn-hangzhou-internal.aliyuncs.com\"\n      bucket: \"thanos\"\n      access_key_id: \"LTA******************KBu\"\n      access_key_secret: \"oki************************2HQ\"\n</code></pre> <p>\u7ed9 <code>Prometheus</code> \u52a0\u4e0a <code>Sidecar</code></p> <p>\u5982\u679c\u9009\u7528 <code>Sidecar</code> \u65b9\u6848\uff0c\u5c31\u9700\u8981\u7ed9 <code>Prometheus</code> \u52a0\u4e0a <code>Thanos Sidecar</code>\uff0c\u51c6\u5907 <code>prometheus.yaml</code>\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: prometheus-headless\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: prometheus\nspec:\n  type: ClusterIP\n  clusterIP: None\n  selector:\n    app.kubernetes.io/name: prometheus\n  ports:\n  - name: web\n    protocol: TCP\n    port: 9090\n    targetPort: web\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n---\n\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: thanos\n\n---\n\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: prometheus\n  namespace: thanos\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - nodes/proxy\n  - nodes/metrics\n  - services\n  - endpoints\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\n  resources: [\"configmaps\"]\n  verbs: [\"get\"]\n- nonResourceURLs: [\"/metrics\"]\n  verbs: [\"get\"]\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nsubjects:\n  - kind: ServiceAccount\n    name: prometheus\n    namespace: thanos\nroleRef:\n  kind: ClusterRole\n  name: prometheus\n  apiGroup: rbac.authorization.k8s.io\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: prometheus\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  serviceName: prometheus-headless\n  podManagementPolicy: Parallel\n  replicas: 2\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: prometheus\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: prometheus\n    spec:\n      serviceAccountName: prometheus\n      securityContext:\n        fsGroup: 2000\n        runAsNonRoot: true\n        runAsUser: 1000\n      affinity:\n        podAntiAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:\n          - labelSelector:\n              matchExpressions:\n              - key: app.kubernetes.io/name\n                operator: In\n                values:\n                - prometheus\n            topologyKey: kubernetes.io/hostname\n      containers:\n      - name: prometheus\n        image: quay.io/prometheus/prometheus:v2.15.2\n        args:\n        - --config.file=/etc/prometheus/config_out/prometheus.yaml\n        - --storage.tsdb.path=/prometheus\n        - --storage.tsdb.retention.time=10d\n        - --web.route-prefix=/\n        - --web.enable-lifecycle\n        - --storage.tsdb.no-lockfile\n        - --storage.tsdb.min-block-duration=2h\n        - --storage.tsdb.max-block-duration=2h\n        - --log.level=debug\n        ports:\n        - containerPort: 9090\n          name: web\n          protocol: TCP\n        livenessProbe:\n          failureThreshold: 6\n          httpGet:\n            path: /-/healthy\n            port: web\n            scheme: HTTP\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 3\n        readinessProbe:\n          failureThreshold: 120\n          httpGet:\n            path: /-/ready\n            port: web\n            scheme: HTTP\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 3\n        volumeMounts:\n        - mountPath: /etc/prometheus/config_out\n          name: prometheus-config-out\n          readOnly: true\n        - mountPath: /prometheus\n          name: prometheus-storage\n        - mountPath: /etc/prometheus/rules\n          name: prometheus-rules\n      - name: thanos\n        image: quay.io/thanos/thanos:v0.11.0\n        args:\n        - sidecar\n        - --log.level=debug\n        - --tsdb.path=/prometheus\n        - --prometheus.url=http://127.0.0.1:9090\n        - --objstore.config-file=/etc/thanos/objectstorage.yaml\n        - --reloader.config-file=/etc/prometheus/config/prometheus.yaml.tmpl\n        - --reloader.config-envsubst-file=/etc/prometheus/config_out/prometheus.yaml\n        - --reloader.rule-dir=/etc/prometheus/rules/\n        env:\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        ports:\n        - name: http-sidecar\n          containerPort: 10902\n        - name: grpc\n          containerPort: 10901\n        livenessProbe:\n            httpGet:\n              port: 10902\n              path: /-/healthy\n        readinessProbe:\n          httpGet:\n            port: 10902\n            path: /-/ready\n        volumeMounts:\n        - name: prometheus-config-tmpl\n          mountPath: /etc/prometheus/config\n        - name: prometheus-config-out\n          mountPath: /etc/prometheus/config_out\n        - name: prometheus-rules\n          mountPath: /etc/prometheus/rules\n        - name: prometheus-storage\n          mountPath: /prometheus\n        - name: thanos-objectstorage\n          subPath: objectstorage.yaml\n          mountPath: /etc/thanos/objectstorage.yaml\n      volumes:\n      - name: prometheus-config-tmpl\n        configMap:\n          defaultMode: 420\n          name: prometheus-config-tmpl\n      - name: prometheus-config-out\n        emptyDir: {}\n      - name: prometheus-rules\n        configMap:\n          name: prometheus-rules\n      - name: thanos-objectstorage\n        secret:\n          secretName: thanos-objectstorage\n  volumeClaimTemplates:\n  - metadata:\n      name: prometheus-storage\n      labels:\n        app.kubernetes.io/name: prometheus\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 200Gi\n      volumeMode: Filesystem\n</code></pre> <ul> <li><code>Prometheus</code> \u4f7f\u7528 <code>StatefulSet</code> \u65b9\u5f0f\u90e8\u7f72\uff0c\u6302\u8f7d\u6570\u636e\u76d8\u4ee5\u4fbf\u5b58\u50a8\u6700\u65b0\u76d1\u63a7\u6570\u636e\uff1b</li> <li>\u7531\u4e8e <code>Prometheus</code> \u526f\u672c\u4e4b\u95f4\u6ca1\u6709\u542f\u52a8\u987a\u5e8f\u7684\u4f9d\u8d56\uff0c\u6240\u4ee5 <code>podManagementPolicy</code> \u6307\u5b9a\u4e3a <code>Parallel</code>\uff0c\u52a0\u5feb\u542f\u52a8\u901f\u5ea6\uff1b</li> <li>\u4e3a <code>Prometheus</code> \u7ed1\u5b9a\u8db3\u591f\u7684 RBAC \u6743\u9650\uff0c\u4ee5\u4fbf\u540e\u7eed\u914d\u7f6e\u4f7f\u7528 k8s \u7684\u670d\u52a1\u53d1\u73b0\uff08<code>kubernetes_sd_configs</code>\uff09\u65f6\u80fd\u591f\u6b63\u5e38\u5de5\u4f5c\u3002</li> <li>\u4e3a <code>Prometheus</code> \u521b\u5efa <code>headless</code> \u7c7b\u578b <code>service</code>\uff0c\u4e3a\u540e\u7eed <code>Thanos Query</code> \u901a\u8fc7 <code>DNS SRV</code> \u8bb0\u5f55\u6765\u52a8\u6001\u53d1\u73b0 <code>Sidecar</code> \u7684 <code>gRPC</code> \u7aef\u70b9\u505a\u51c6\u5907\uff08\u4f7f\u7528 <code>headless service</code>\u624d\u80fd\u8ba9<code>DNS SRV</code> \u6b63\u786e\u8fd4\u56de\u6240\u6709\u7aef\u70b9\uff09\u3002</li> <li>\u4f7f\u7528\u4e24\u4e2a <code>Prometheus</code> \u526f\u672c\uff0c\u7528\u4e8e\u5b9e\u73b0\u9ad8\u53ef\u7528\uff1b</li> <li>\u4f7f\u7528\u786c\u53cd\u4eb2\u548c\uff0c\u907f\u514d <code>Prometheus</code> \u90e8\u7f72\u5728\u540c\u4e00\u8282\u70b9\uff0c\u65e2\u53ef\u4ee5\u5206\u6563\u538b\u529b\u4e5f\u53ef\u4ee5\u907f\u514d\u5355\u70b9\u6545\u969c\uff1b</li> <li><code>Prometheus</code> \u4f7f\u7528 <code>--storage.tsdb.retention.time</code> \u6307\u5b9a\u6570\u636e\u4fdd\u7559\u65f6\u957f\uff0c\u9ed8\u8ba4<code>15</code>\u5929\uff0c\u53ef\u4ee5\u6839\u636e\u6570\u636e\u589e\u957f\u901f\u5ea6\u548c\u6570\u636e\u76d8\u5927\u5c0f\u505a\u9002\u5f53\u8c03\u6574\uff08\u6570\u636e\u589e\u957f\u53d6\u51b3\u4e8e\u91c7\u96c6\u7684\u6307\u6807\u548c\u76ee\u6807\u7aef\u70b9\u7684\u6570\u91cf\u548c\u91c7\u96c6\u9891\u7387\uff09\uff1b</li> <li><code>Sidecar</code> \u4f7f\u7528 <code>--objstore.config-file</code> \u5f15\u7528\u6211\u4eec\u521a\u521a\u521b\u5efa\u5e76\u6302\u8f7d\u7684\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e\u6587\u4ef6\uff0c\u7528\u4e8e\u4e0a\u4f20\u6570\u636e\u5230\u5bf9\u8c61\u5b58\u50a8\uff1b</li> <li>\u901a\u5e38\u4f1a\u7ed9 <code>Prometheus</code> \u9644\u5e26\u4e00\u4e2a <code>quay.io/coreos/prometheus-config-reloader</code> \u6765\u76d1\u542c\u914d\u7f6e\u53d8\u66f4\u5e76\u52a8\u6001\u52a0\u8f7d\uff0c\u4f46 <code>thanos sidecar</code> \u4e5f\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u8fd9\u4e2a\u529f\u80fd\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u7528 <code>thanos sidecar</code> \u6765\u5b9e\u73b0\u6b64\u529f\u80fd\uff0c\u4e5f\u652f\u6301\u914d\u7f6e\u6587\u4ef6\u6839\u636e\u6a21\u677f\u52a8\u6001\u751f\u6210\uff1a<code>--reloader.config-file</code> \u6307\u5b9a <code>Prometheus</code> \u914d\u7f6e\u6587\u4ef6\u6a21\u677f\uff0c<code>--reloader.config-envsubst-file</code> \u6307\u5b9a\u751f\u6210\u914d\u7f6e\u6587\u4ef6\u7684\u5b58\u653e\u8def\u5f84\uff0c\u5047\u8bbe\u662f <code>/etc/prometheus/config_out/prometheus.yaml</code>\uff0c\u90a3\u4e48 <code>/etc/prometheus/config_out</code> \u8fd9\u4e2a\u8def\u5f84\u4f7f\u7528 <code>emptyDir</code>\u8ba9 <code>Prometheus</code> \u4e0e <code>Sidecar</code>\u5b9e\u73b0\u914d\u7f6e\u6587\u4ef6\u5171\u4eab\u6302\u8f7d\uff0c<code>Prometheus</code> \u518d\u901a\u8fc7<code>--config.file</code> \u6307\u5b9a\u751f\u6210\u51fa\u6765\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5f53\u914d\u7f6e\u6709\u66f4\u65b0\u65f6\uff0c\u6302\u8f7d\u7684\u914d\u7f6e\u6587\u4ef6\u4e5f\u4f1a\u540c\u6b65\u66f4\u65b0\uff0c<code>Sidecar</code> \u4e5f\u4f1a\u901a\u77e5 <code>Prometheus</code> \u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u3002\u53e6\u5916\uff0c<code>Sidecar</code> \u4e0e <code>Prometheus</code> \u4e5f\u6302\u8f7d\u540c\u4e00\u4efd <code>rules</code> \u914d\u7f6e\u6587\u4ef6\uff0c\u914d\u7f6e\u66f4\u65b0\u540e <code>Sidecar</code> \u4ec5\u901a\u77e5 <code>Prometheus</code> \u52a0\u8f7d\u914d\u7f6e\uff0c\u4e0d\u652f\u6301\u6a21\u677f\uff0c\u56e0\u4e3a <code>rules</code> \u914d\u7f6e\u4e0d\u9700\u8981\u6a21\u677f\u6765\u52a8\u6001\u751f\u6210\u3002</li> </ul> <p>\u7136\u540e\u518d\u7ed9 <code>Prometheus</code> \u51c6\u5907\u914d\u7f6e \uff08<code>prometheus-config.yaml</code>\uff09\uff1a</p> <pre><code>\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config-tmpl\n  namespace: thanos\ndata:\n  prometheus.yaml.tmpl: |-\n    global:\n      scrape_interval: 5s\n      evaluation_interval: 5s\n      external_labels:\n        cluster: prometheus-ha\n        prometheus_replica: $(POD_NAME)\n    rule_files:\n    - /etc/prometheus/rules/*rules.yaml\n    scrape_configs:\n    - job_name: cadvisor\n      metrics_path: /metrics/cadvisor\n      scrape_interval: 10s\n      scrape_timeout: 10s\n      scheme: https\n      tls_config:\n        insecure_skip_verify: true\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n---\n\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-rules\n  labels:\n    name: prometheus-rules\n  namespace: thanos\ndata:\n  alert-rules.yaml: |-\n    groups:\n    - name: k8s.rules\n      rules:\n      - expr: |\n          sum(rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])) by (namespace)\n        record: namespace:container_cpu_usage_seconds_total:sum_rate\n      - expr: |\n          sum(container_memory_usage_bytes{job=\"cadvisor\", image!=\"\", container!=\"\"}) by (namespace)\n        record: namespace:container_memory_usage_bytes:sum\n      - expr: |\n          sum by (namespace, pod, container) (\n            rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])\n          )\n        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate\n</code></pre> <p>\u672c\u6587\u91cd\u70b9\u4e0d\u5728 prometheus \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6240\u4ee5\u8fd9\u91cc\u4ec5\u4ee5\u91c7\u96c6 kubelet \u6240\u66b4\u9732\u7684 cadvisor \u5bb9\u5668\u6307\u6807\u7684\u7b80\u5355\u914d\u7f6e\u4e3a\u4f8b\u3002</p> <p><code>Prometheus</code> \u5b9e\u4f8b\u91c7\u96c6\u7684\u6240\u6709\u6307\u6807\u6570\u636e\u91cc\u90fd\u4f1a\u989d\u5916\u52a0\u4e0a <code>external_labels</code> \u91cc\u6307\u5b9a\u7684 <code>label</code>\uff0c\u901a\u5e38\u7528 <code>cluster</code> \u533a\u5206\u5f53\u524d <code>Prometheus</code> \u6240\u5728\u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u518d\u52a0\u4e86\u4e2a <code>prometheus_replica</code>\uff0c\u7528\u4e8e\u533a\u5206\u76f8\u540c <code>Prometheus</code> \u526f\u672c\uff08\u8fd9\u4e9b\u526f\u672c\u6240\u91c7\u96c6\u7684\u6570\u636e\u9664\u4e86 <code>prometheus_replica</code> \u7684\u503c\u4e0d\u4e00\u6837\uff0c\u5176\u5b83\u51e0\u4e4e\u4e00\u81f4\uff0c\u8fd9\u4e2a\u503c\u4f1a\u88ab <code>Thanos Sidecar</code> \u66ff\u6362\u6210 <code>Pod</code> \u526f\u672c\u7684\u540d\u79f0\uff0c\u7528\u4e8e <code>Thanos</code> \u5b9e\u73b0 <code>Prometheus</code> \u9ad8\u53ef\u7528\uff09</p>"},{"location":"chap11/35Thanos_install/#3-5-query","title":"3-5 \u5b89\u88c5 Query","text":"<p>\u51c6\u5907 <code>thanos-query.yaml</code>\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-query\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  ports:\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n  - name: http\n    port: 9090\n    targetPort: http\n  selector:\n    app.kubernetes.io/name: thanos-query\n---\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: thanos-query\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-query\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-query\n    spec:\n      affinity:\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n          - podAffinityTerm:\n              labelSelector:\n                matchExpressions:\n                - key: app.kubernetes.io/name\n                  operator: In\n                  values:\n                  - thanos-query\n              topologyKey: kubernetes.io/hostname\n            weight: 100\n      containers:\n      - args:\n        - query\n        - --log.level=debug\n        - --query.auto-downsampling\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:9090\n        - --query.partial-response\n        - --query.replica-label=prometheus_replica\n        - --query.replica-label=rule_replica\n        - --store=dnssrv+_grpc._tcp.prometheus-headless.thanos.svc.cluster.local\n        - --store=dnssrv+_grpc._tcp.thanos-rule.thanos.svc.cluster.local\n        - --store=dnssrv+_grpc._tcp.thanos-store.thanos.svc.cluster.local\n        image: thanosio/thanos:v0.11.0\n        livenessProbe:\n          failureThreshold: 4\n          httpGet:\n            path: /-/healthy\n            port: 9090\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-query\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 9090\n          name: http\n        readinessProbe:\n          failureThreshold: 20\n          httpGet:\n            path: /-/ready\n            port: 9090\n            scheme: HTTP\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n      terminationGracePeriodSeconds: 120\n</code></pre> <p>\u914d\u7f6e\u5185\u5bb9\u4ec5\u4e3a\u793a\u4f8b\uff0c\u6839\u636e\u81ea\u8eab\u60c5\u51b5\u6765\u914d\u7f6e\uff0c\u683c\u5f0f\u57fa\u672c\u517c\u5bb9 <code>Prometheus</code> \u7684 <code>rule</code> \u914d\u7f6e\u683c\u5f0f\uff0c\u53c2\u8003\uff1ahttps://thanos.io/components/rule.md/#configuring-rules</p>"},{"location":"chap11/35Thanos_install/#3-6-compact","title":"3-6 \u5b89\u88c5 Compact","text":"<p>\u51c6\u5907 Compact \u90e8\u7f72\u914d\u7f6e <code>thanos-compact.yaml</code>\uff1a</p> <pre><code>\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-compact\n  name: thanos-compact\n  namespace: thanos\nspec:\n  ports:\n  - name: http\n    port: 10902\n    targetPort: http\n  selector:\n    app.kubernetes.io/name: thanos-compact\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-compact\n  name: thanos-compact\n  namespace: thanos\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-compact\n  serviceName: thanos-compact\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-compact\n    spec:\n      containers:\n      - args:\n        - compact\n        - --wait\n        - --objstore.config-file=/etc/thanos/objectstorage.yaml\n        - --data-dir=/var/thanos/compact\n        - --debug.accept-malformed-index\n        - --log.level=debug\n        - --retention.resolution-raw=90d\n        - --retention.resolution-5m=180d\n        - --retention.resolution-1h=360d\n        image: thanosio/thanos:v0.11.0\n        livenessProbe:\n          failureThreshold: 4\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-compact\n        ports:\n        - containerPort: 10902\n          name: http\n        readinessProbe:\n          failureThreshold: 20\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /var/thanos/compact\n          name: data\n          readOnly: false\n        - name: thanos-objectstorage\n          subPath: objectstorage.yaml\n          mountPath: /etc/thanos/objectstorage.yaml\n      terminationGracePeriodSeconds: 120\n      volumes:\n      - name: thanos-objectstorage\n        secret:\n          secretName: thanos-objectstorage\n  volumeClaimTemplates:\n  - metadata:\n      labels:\n        app.kubernetes.io/name: thanos-compact\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 100Gi\n</code></pre> <ul> <li><code>Compact</code> \u53ea\u80fd\u90e8\u7f72\u5355\u4e2a\u526f\u672c\uff0c\u56e0\u4e3a\u5982\u679c\u591a\u4e2a\u526f\u672c\u90fd\u53bb\u5bf9\u5bf9\u8c61\u5b58\u50a8\u7684\u6570\u636e\u505a\u538b\u7f29\u548c\u964d\u91c7\u6837\u7684\u8bdd\uff0c\u4f1a\u9020\u6210\u51b2\u7a81\uff1b</li> <li>\u4f7f\u7528 <code>StatefulSet</code> \u90e8\u7f72\uff0c\u65b9\u4fbf\u81ea\u52a8\u521b\u5efa\u548c\u6302\u8f7d\u78c1\u76d8\u3002\u78c1\u76d8\u7528\u4e8e\u5b58\u653e\u4e34\u65f6\u6570\u636e\uff0c\u56e0\u4e3a <code>Compact</code> \u9700\u8981\u4e00\u4e9b\u78c1\u76d8\u7a7a\u95f4\u6765\u5b58\u653e\u6570\u636e\u5904\u7406\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u4e2d\u95f4\u6570\u636e\u3002</li> <li><code>--wait</code> \u8ba9 <code>Compact</code> \u4e00\u76f4\u8fd0\u884c\uff0c\u8f6e\u8be2\u65b0\u6570\u636e\u6765\u505a\u538b\u7f29\u548c\u964d\u91c7\u6837\uff1b</li> <li><code>Compact</code> \u4e5f\u9700\u8981\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\uff0c\u7528\u4e8e\u8bfb\u53d6\u5bf9\u8c61\u5b58\u50a8\u6570\u636e\u4ee5\u53ca\u4e0a\u4f20\u538b\u7f29\u548c\u964d\u91c7\u6837\u540e\u7684\u6570\u636e\u5230\u5bf9\u8c61\u5b58\u50a8\uff1b</li> <li>\u521b\u5efa\u4e00\u4e2a\u666e\u901a <code>service</code>\uff0c\u4e3b\u8981\u7528\u4e8e\u88ab <code>Prometheus</code> \u4f7f\u7528 <code>kubernetes</code> \u7684 <code>endpoints</code> \u670d\u52a1\u53d1\u73b0\u6765\u91c7\u96c6\u6307\u6807\uff08\u5176\u5b83\u7ec4\u4ef6\u7684 <code>service</code> \u4e5f\u4e00\u6837\u6709\u8fd9\u4e2a\u7528\u9014\uff09\uff1b</li> <li><code>--retention.resolution-raw</code> \u6307\u5b9a\u539f\u59cb\u6570\u636e\u5b58\u653e\u65f6\u957f\uff0c<code>--retention.resolution-5m</code> \u6307\u5b9a\u964d\u91c7\u6837\u5230\u6570\u636e\u70b9 <code>5</code> \u5206\u949f\u95f4\u9694\u7684\u6570\u636e\u5b58\u653e\u65f6\u957f\uff0c<code>--retention.resolution-1h</code>  \u6307\u5b9a\u964d\u91c7\u6837\u5230\u6570\u636e\u70b9 <code>1</code> \u5c0f\u65f6\u95f4\u9694\u7684\u6570\u636e\u5b58\u653e\u65f6\u957f\uff0c\u5b83\u4eec\u7684\u6570\u636e\u7cbe\u7ec6\u7a0b\u5ea6\u9012\u51cf\uff0c\u5360\u7528\u7684\u5b58\u50a8\u7a7a\u95f4\u4e5f\u662f\u9012\u51cf\uff0c\u901a\u5e38\u5efa\u8bae\u5b83\u4eec\u7684\u5b58\u653e\u65f6\u95f4\u9012\u589e\u914d\u7f6e\uff08\u4e00\u822c\u53ea\u6709\u6bd4\u8f83\u65b0\u7684\u6570\u636e\u624d\u4f1a\u653e\u5927\u770b\uff0c\u4e45\u8fdc\u7684\u6570\u636e\u901a\u5e38\u53ea\u4f1a\u4f7f\u7528\u5927\u65f6\u95f4\u8303\u56f4\u67e5\u8be2\u6765\u770b\u4e2a\u5927\u81f4\uff0c\u6240\u4ee5\u5efa\u8bae\u5c06\u7cbe\u7ec6\u7a0b\u5ea6\u4f4e\u7684\u6570\u636e\u5b58\u653e\u66f4\u957f\u65f6\u95f4\uff09\u3002</li> </ul>"},{"location":"chap11/35Thanos_install/#3-7-receiver","title":"3-7 \u5b89\u88c5 Receiver","text":"<p>\u8be5\u7ec4\u4ef6\u5904\u4e8e\u8bd5\u9a8c\u9636\u6bb5\uff0c\u614e\u7528\u3002\u51c6\u5907 <code>Receiver</code> \u90e8\u7f72\u914d\u7f6e <code>thanos-receiver.yaml</code>\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: thanos-receive-hashrings\n  namespace: thanos\ndata:\n  thanos-receive-hashrings.json: |\n    [\n      {\n        \"hashring\": \"soft-tenants\",\n        \"endpoints\":\n        [\n          \"thanos-receive-0.thanos-receive.kube-system.svc.cluster.local:10901\",\n          \"thanos-receive-1.thanos-receive.kube-system.svc.cluster.local:10901\",\n          \"thanos-receive-2.thanos-receive.kube-system.svc.cluster.local:10901\"\n        ]\n      }\n    ]\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-receive\n  namespace: thanos\n  labels:\n    kubernetes.io/name: thanos-receive\nspec:\n  ports:\n  - name: http\n    port: 10902\n    protocol: TCP\n    targetPort: 10902\n  - name: remote-write\n    port: 19291\n    protocol: TCP\n    targetPort: 19291\n  - name: grpc\n    port: 10901\n    protocol: TCP\n    targetPort: 10901\n  selector:\n    kubernetes.io/name: thanos-receive\n  clusterIP: None\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    kubernetes.io/name: thanos-receive\n  name: thanos-receive\n  namespace: thanos\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      kubernetes.io/name: thanos-receive\n  serviceName: thanos-receive\n  template:\n    metadata:\n      labels:\n        kubernetes.io/name: thanos-receive\n    spec:\n      containers:\n      - args:\n        - receive\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:10902\n        - --remote-write.address=0.0.0.0:19291\n        - --objstore.config-file=/etc/thanos/objectstorage.yaml\n        - --tsdb.path=/var/thanos/receive\n        - --tsdb.retention=12h\n        - --label=receive_replica=\"$(NAME)\"\n        - --label=receive=\"true\"\n        - --receive.hashrings-file=/etc/thanos/thanos-receive-hashrings.json\n        - --receive.local-endpoint=$(NAME).thanos-receive.thanos.svc.cluster.local:10901\n        env:\n        - name: NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        image: thanosio/thanos:v0.11.0\n        livenessProbe:\n          failureThreshold: 4\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-receive\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 10902\n          name: http\n        - containerPort: 19291\n          name: remote-write\n        readinessProbe:\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          initialDelaySeconds: 10\n          periodSeconds: 30\n        resources:\n          limits:\n            cpu: \"4\"\n            memory: 8Gi\n          requests:\n            cpu: \"2\"\n            memory: 4Gi\n        volumeMounts:\n        - mountPath: /var/thanos/receive\n          name: data\n          readOnly: false\n        - mountPath: /etc/thanos/thanos-receive-hashrings.json\n          name: thanos-receive-hashrings\n          subPath: thanos-receive-hashrings.json\n        - mountPath: /etc/thanos/objectstorage.yaml\n          name: thanos-objectstorage\n          subPath: objectstorage.yaml\n      terminationGracePeriodSeconds: 120\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: thanos-receive-hashrings\n        name: thanos-receive-hashrings\n      - name: thanos-objectstorage\n        secret:\n          secretName: thanos-objectstorage\n  volumeClaimTemplates:\n  - metadata:\n      labels:\n        app.kubernetes.io/name: thanos-receive\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 200Gi\n</code></pre> <ul> <li>\u90e8\u7f72 <code>3</code>\u4e2a\u526f\u672c\uff0c \u914d\u7f6e <code>hashring</code>\uff0c <code>--label=receive_replica</code>\uff1b</li> <li>\u4e3a\u6570\u636e\u6dfb\u52a0 <code>receive_replica</code> \u8fd9\u4e2a <code>label</code>\uff08<code>Query</code> \u7684 <code>--query.replica-label</code>\u4e5f\u8981\u52a0\u4e0a\u8fd9\u4e2a\uff09\u6765\u5b9e\u73b0 <code>Receiver</code> \u7684\u9ad8\u53ef\u7528\uff1b</li> <li><code>Query</code> \u8981\u6307\u5b9a <code>Receiver</code> \u540e\u7aef\u5730\u5740\uff1a<code>--store=dnssrv+_grpc._tcp.thanos-receive.thanos.svc.cluster.local</code>\uff1b</li> <li><code>request</code>\u3001<code>limit</code> \u6839\u636e\u81ea\u8eab\u89c4\u6a21\u60c5\u51b5\u81ea\u884c\u505a\u9002\u5f53\u8c03\u6574\uff1b</li> <li><code>--tsdb.retention</code> \u6839\u636e\u81ea\u8eab\u9700\u6c42\u8c03\u6574\u6700\u65b0\u6570\u636e\u7684\u4fdd\u7559\u65f6\u95f4\uff1b</li> <li>\u5982\u679c\u6539\u547d\u540d\u7a7a\u95f4\uff0c\u8bb0\u5f97\u628a <code>Receiver</code> \u7684 <code>--receive.local-endpoint</code> \u53c2\u6570\u4e5f\u6539\u4e0b\uff0c\u4e0d\u7136\u4f1a\u75af\u72c2\u62a5\u9519\u76f4\u81f3 <code>OOMKilled</code>\u3002</li> </ul> <p>\u56e0\u4e3a\u4f7f\u7528\u4e86 <code>Receiver</code> \u6765\u7edf\u4e00\u63a5\u6536 <code>Prometheus</code> \u7684\u6570\u636e\uff0c\u6240\u4ee5 <code>Prometheus</code> \u4e5f\u4e0d\u9700\u8981 <code>Sidecar</code> \u4e86\uff0c\u4f46\u9700\u8981\u7ed9<code>Prometheus</code> \u914d\u7f6e\u6587\u4ef6\u91cc\u52a0\u4e0b <code>remote_write</code>\uff0c\u8ba9 <code>Prometheus</code> \u5c06\u6570\u636e <code>push</code>\u7ed9 <code>Receiver</code>\uff1a</p> <pre><code> remote_write:\n - url: http://thanos-receive.thanos.svc.cluster.local:19291/api/v1/receive\n</code></pre> <p>\u6307\u5b9a Query \u4e3a\u6570\u636e\u6e90</p> <p>\u67e5\u8be2\u76d1\u63a7\u6570\u636e\u65f6\u9700\u8981\u6307\u5b9a <code>Prometheus</code> \u6570\u636e\u6e90\u5730\u5740\uff0c\u7531\u4e8e\u6211\u4eec\u4f7f\u7528\u4e86 <code>Thanos</code>\u6765\u505a\u5206\u5e03\u5f0f\uff0c\u800c <code>Thanos</code> \u5173\u952e\u67e5\u8be2\u5165\u53e3\u5c31\u662f <code>Query</code>\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5c06\u6570\u636e\u6e90\u5730\u5740\u6307\u5b9a\u4e3a <code>Query</code> \u7684\u5730\u5740\uff0c\u5047\u5982\u4f7f\u7528 <code>Grafana</code> \u67e5\u8be2\uff0c\u8fdb\u5165 <code>Configuration-Data Sources-Add data source</code>\uff0c\u9009\u62e9 <code>Prometheus</code>\uff0c\u6307\u5b9a <code>thanos query</code> \u7684\u5730\u5740\uff1ahttp://thanos-query.thanos.svc.cluster.local:9090</p>"},{"location":"chap11/39Thanos_tutorial/","title":"\u7b2c\u4e00\u8282 \u5927\u89c4\u6a21\u573a\u666f\u4e0b Prometheus \u7684\u4f18\u5316\u624b\u6bb5 &amp; Thanos \u67b6\u6784\u8be6\u89e3","text":""},{"location":"chap11/39Thanos_tutorial/#1","title":"1 \u6982\u8ff0","text":"<p>Prometheus \u51e0\u4e4e\u5df2\u6210\u4e3a\u76d1\u63a7\u9886\u57df\u7684\u4e8b\u5b9e\u6807\u51c6\uff0c\u5b83\u81ea\u5e26\u9ad8\u6548\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u5b58\u50a8\uff0c\u53ef\u4ee5\u8ba9\u5355\u53f0 Prometheus \u80fd\u591f\u9ad8\u6548\u7684\u5904\u7406\u5927\u91cf\u7684\u6570\u636e\uff0c\u8fd8\u6709\u53cb\u597d\u5e76\u4e14\u5f3a\u5927\u7684 PromQL \u8bed\u6cd5\uff0c\u53ef\u4ee5\u7528\u6765\u7075\u6d3b\u7684\u67e5\u8be2\u5404\u79cd\u76d1\u63a7\u6570\u636e\u4ee5\u53ca\u914d\u7f6e\u544a\u8b66\u89c4\u5219\u3002</p> <p>\u540c\u65f6\u5b83\u7684 pull \u6a21\u578b\u6307\u6807\u91c7\u96c6\u65b9\u5f0f\u88ab\u5e7f\u6cdb\u91c7\u7eb3\uff0c\u975e\u5e38\u591a\u7684\u5e94\u7528\u90fd\u5b9e\u73b0\u4e86 Prometheus \u7684 metrics \u63a5\u53e3\u4ee5\u66b4\u9732\u81ea\u8eab\u5404\u9879\u6570\u636e\u6307\u6807\u8ba9 Prometheus \u53bb\u91c7\u96c6\uff0c\u5f88\u591a\u6ca1\u6709\u9002\u914d\u7684\u5e94\u7528\u4e5f\u4f1a\u6709\u7b2c\u4e09\u65b9 exporter \u5e2e\u5b83\u53bb\u9002\u914d Prometheus\uff0c\u6240\u4ee5\u76d1\u63a7\u7cfb\u7edf\u6211\u4eec\u901a\u5e38\u9996\u9009\u7528 Prometheus\u3002</p>"},{"location":"chap11/39Thanos_tutorial/#1-1-prometheus","title":"1-1 \u5927\u89c4\u6a21\u573a\u666f\u4e0bPrometheus\u7684\u75db\u70b9","text":"<p><code>Prometheus</code> \u672c\u8eab\u53ea\u652f\u6301\u5355\u673a\u90e8\u7f72\uff0c\u6ca1\u6709\u81ea\u5e26\u652f\u6301\u96c6\u7fa4\u90e8\u7f72\uff0c\u4e5f\u5c31\u4e0d\u652f\u6301\u9ad8\u53ef\u7528\u4ee5\u53ca\u6c34\u5e73\u6269\u5bb9\uff0c\u5728\u5927\u89c4\u6a21\u573a\u666f\u4e0b\uff0c\u6700\u8ba9\u4eba\u5173\u5fc3\u7684\u95ee\u9898\u662f\u5b83\u7684\u5b58\u50a8\u7a7a\u95f4\u4e5f\u53d7\u9650\u4e8e\u5355\u673a\u78c1\u76d8\u5bb9\u91cf\u3002</p> <p>\u78c1\u76d8\u5bb9\u91cf\u51b3\u5b9a\u4e86\u5355\u4e2a Prometheus \u6240\u80fd\u5b58\u50a8\u7684\u6570\u636e\u91cf\uff0c\u6570\u636e\u91cf\u5927\u5c0f\u53c8\u53d6\u51b3\u4e8e\u88ab\u91c7\u96c6\u670d\u52a1\u7684\u6307\u6807\u6570\u91cf\u3001\u670d\u52a1\u6570\u91cf\u3001\u91c7\u96c6\u901f\u7387\u4ee5\u53ca\u6570\u636e\u8fc7\u671f\u65f6\u95f4\u3002\u5728\u6570\u636e\u91cf\u5927\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u80fd\u5c31\u9700\u8981\u505a\u5f88\u591a\u53d6\u820d\uff0c\u6bd4\u5982\u4e22\u5f03\u4e0d\u91cd\u8981\u7684\u6307\u6807\u3001\u964d\u4f4e\u91c7\u96c6\u901f\u7387\u3001\u8bbe\u7f6e\u8f83\u77ed\u7684\u6570\u636e\u8fc7\u671f\u65f6\u95f4\uff08\u9ed8\u8ba4\u53ea\u4fdd\u755915\u5929\u7684\u6570\u636e\uff0c\u770b\u4e0d\u5230\u6bd4\u8f83\u4e45\u8fdc\u7684\u76d1\u63a7\u6570\u636e\uff09\u3002</p> <p>\u8fd9\u4e9b\u75db\u70b9\u5b9e\u9645\u4e5f\u662f\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e9b\u4f18\u5316\u624b\u6bb5\u6765\u6539\u5584\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u7ec6\u8bb2\u4e00\u4e0b\u3002</p>"},{"location":"chap11/39Thanos_tutorial/#1-2-prometheus","title":"1-2 \u4ece\u670d\u52a1\u7ef4\u5ea6\u62c6\u5206<code>Prometheus</code>","text":"<p><code>Prometheus</code> \u4e3b\u5f20\u6839\u636e\u529f\u80fd\u6216\u670d\u52a1\u7ef4\u5ea6\u8fdb\u884c\u62c6\u5206\uff0c\u5373\u5982\u679c\u8981\u91c7\u96c6\u7684\u670d\u52a1\u6bd4\u8f83\u591a\uff0c\u4e00\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u5c31\u914d\u7f6e\u6210\u4ec5\u91c7\u96c6\u548c\u5b58\u50a8\u67d0\u4e00\u4e2a\u6216\u67d0\u4e00\u90e8\u5206\u670d\u52a1\u7684\u6307\u6807\uff0c\u8fd9\u6837\u6839\u636e\u8981\u91c7\u96c6\u7684\u670d\u52a1\u5c06 <code>Prometheus</code> \u62c6\u5206\u6210\u591a\u4e2a\u5b9e\u4f8b\u5206\u522b\u53bb\u91c7\u96c6\uff0c\u4e5f\u80fd\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u8fbe\u5230\u6c34\u5e73\u6269\u5bb9\u7684\u76ee\u7684\u3002</p> <p></p> <p>\u901a\u5e38\u8fd9\u6837\u7684\u6269\u5bb9\u65b9\u5f0f\u5df2\u7ecf\u80fd\u6ee1\u8db3\u5927\u90e8\u5206\u573a\u666f\u7684\u9700\u6c42\u4e86\uff0c\u6bd5\u7adf\u5355\u673a <code>Prometheus</code> \u5c31\u80fd\u91c7\u96c6\u548c\u5904\u7406\u5f88\u591a\u6570\u636e\u4e86\uff0c\u5f88\u5c11\u6709 <code>Prometheus</code> \u6491\u4e0d\u4f4f\u5355\u4e2a\u670d\u52a1\u7684\u573a\u666f\u3002</p> <p>\u4e0d\u8fc7\u5728\u8d85\u5927\u89c4\u6a21\u96c6\u7fa4\u4e0b\uff0c\u6709\u4e9b\u5355\u4e2a\u670d\u52a1\u7684\u4f53\u91cf\u4e5f\u5f88\u5927\uff0c\u5c31\u9700\u8981\u8fdb\u4e00\u6b65\u62c6\u5206\u4e86\uff0c\u6211\u4eec\u4e0b\u9762\u6765\u7ee7\u7eed\u8bb2\u4e0b\u5982\u4f55\u518d\u62c6\u5206\u3002</p>"},{"location":"chap11/39Thanos_tutorial/#1-3","title":"1-3 \u5bf9\u8d85\u5927\u89c4\u6a21\u989d\u670d\u52a1\u505a\u5206\u7247","text":"<p>\u60f3\u8c61\u4e00\u4e0b\uff0c\u5982\u679c\u96c6\u7fa4\u8282\u70b9\u6570\u91cf\u8fbe\u5230\u4e0a\u5343\u751a\u81f3\u51e0\u5343\u7684\u89c4\u6a21\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u8282\u70b9\u7ea7\u670d\u52a1\u66b4\u9732\u7684\u6307\u6807\uff0c\u6bd4\u5982 <code>kubelet</code> \u5185\u7f6e\u7684 <code>cadvisor</code>\u66b4\u9732\u7684\u5bb9\u5668\u76f8\u5173\u7684\u6307\u6807\uff0c\u53c8\u6216\u8005\u90e8\u7f72\u7684 <code>DeamonSet node-exporter</code> \u66b4\u9732\u7684\u8282\u70b9\u76f8\u5173\u7684\u6307\u6807\uff0c\u5728\u96c6\u7fa4\u89c4\u6a21\u5927\u7684\u60c5\u51b5\u4e0b\uff0c\u5b83\u4eec\u8fd9\u79cd\u5355\u4e2a\u670d\u52a1\u80cc\u540e\u7684\u6307\u6807\u6570\u636e\u4f53\u91cf\u5f80\u5f80\u975e\u5e38\u5927\u3002</p> <p>\u5305\u62ec\u4e00\u4e9b\u7528\u6237\u91cf\u8d85\u5927\u7684\u4e1a\u52a1\uff0c\u5355\u4e2a\u670d\u52a1\u7684 Pod \u526f\u672c\u6570\u5c31\u53ef\u80fd\u8fc7\u5343\uff0c\u8fd9\u79cd\u670d\u52a1\u80cc\u540e\u7684\u6307\u6807\u6570\u636e\u4e5f\u975e\u5e38\u5927\u3002\u5f53\u7136\u8fd9\u662f\u6700\u7f55\u89c1\u7684\u573a\u666f\uff0c\u5bf9\u4e8e\u7edd\u5927\u591a\u6570\u7684\u4eba\u6765\u8bf4\u8fd9\u79cd\u573a\u666f\u90fd\u53ea\u6562 YY \u4e00\u4e0b\uff0c\u5b9e\u9645\u5f88\u5c11\u6709\u5355\u4e2a\u670d\u52a1\u5c31\u8fbe\u5230\u8fd9\u4e48\u5927\u89c4\u6a21\u7684\u4e1a\u52a1\u3002</p> <p>\u9488\u5bf9\u4e0a\u9762\u8fd9\u4e9b\u5927\u89c4\u6a21\u573a\u666f\uff0c\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u53ef\u80fd\u8fde\u8fd9\u5355\u4e2a\u670d\u52a1\u7684\u91c7\u96c6\u4efb\u52a1\u90fd\u625b\u4e0d\u4f4f\u3002Prometheus \u9700\u8981\u5411\u8fd9\u4e2a\u670d\u52a1\u6240\u6709\u540e\u7aef\u5b9e\u4f8b\u53d1\u8bf7\u6c42\u91c7\u96c6\u6570\u636e\uff0c\u7531\u4e8e\u540e\u7aef\u5b9e\u4f8b\u6570\u91cf\u89c4\u6a21\u592a\u5927\uff0c\u91c7\u96c6\u5e76\u53d1\u91cf\u5c31\u4f1a\u5f88\u9ad8\uff0c\u4e00\u65b9\u9762\u5bf9\u8282\u70b9\u7684\u5e26\u5bbd\u3001CPU\u3001\u78c1\u76d8 IO \u90fd\u6709\u4e00\u5b9a\u7684\u538b\u529b\uff0c\u53e6\u4e00\u65b9\u9762 Prometheus \u4f7f\u7528\u7684\u78c1\u76d8\u7a7a\u95f4\u6709\u9650\uff0c\u91c7\u96c6\u7684\u6570\u636e\u91cf\u8fc7\u5927\u5f88\u5bb9\u6613\u5c31\u5c06\u78c1\u76d8\u585e\u6ee1\u4e86\uff0c\u901a\u5e38\u8981\u505a\u4e00\u4e9b\u53d6\u820d\u624d\u80fd\u5c06\u6570\u636e\u91cf\u63a7\u5236\u5728\u4e00\u5b9a\u8303\u56f4\uff0c\u4f46\u8fd9\u79cd\u53d6\u820d\u4e5f\u4f1a\u964d\u4f4e\u6570\u636e\u5b8c\u6574\u548c\u7cbe\u786e\u7a0b\u5ea6\uff0c\u4e0d\u63a8\u8350\u8fd9\u6837\u505a\u3002</p> <p>\u90a3\u4e48\u5982\u4f55\u4f18\u5316\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u7ed9\u8fd9\u79cd\u5927\u89c4\u6a21\u7c7b\u578b\u7684\u670d\u52a1\u505a\u4e00\u4e0b\u5206\u7247\uff08<code>Sharding</code>\uff09\uff0c\u5c06\u5176\u62c6\u5206\u6210\u591a\u4e2a <code>group</code>\uff0c\u8ba9\u4e00\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u4ec5\u91c7\u96c6\u8fd9\u4e2a\u670d\u52a1\u80cc\u540e\u7684\u67d0\u4e00\u4e2a <code>group</code> \u7684\u6570\u636e\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5c06\u8fd9\u4e2a\u5927\u4f53\u91cf\u670d\u52a1\u7684\u76d1\u63a7\u6570\u636e\u62c6\u5206\u5230\u591a\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u4e0a\u3002</p> <p></p> <p>\u5982\u4f55\u5c06\u4e00\u4e2a\u670d\u52a1\u62c6\u6210\u591a\u4e2a group \u5462\uff1f\u4e0b\u9762\u4ecb\u7ecd\u4e24\u79cd\u65b9\u6848\uff0c\u4ee5\u5bf9 kubelet cadvisor \u6570\u636e\u505a\u5206\u7247\u4e3a\u4f8b\u3002</p> <p>\u7b2c\u4e00\uff0c\u6211\u4eec\u53ef\u4ee5\u4e0d\u7528 <code>Kubernetes</code> \u7684\u670d\u52a1\u53d1\u73b0\uff0c\u81ea\u884c\u5b9e\u73b0 <code>sharding</code> \u7b97\u6cd5\u3002</p> <p>\u6bd4\u5982\u9488\u5bf9\u8282\u70b9\u7ea7\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u5c06\u67d0\u4e2a\u8282\u70b9 <code>shard</code> \u5230\u67d0\u4e2a <code>group</code>\u91cc\uff0c\u7136\u540e\u518d\u5c06\u5176\u6ce8\u518c\u5230 <code>Prometheus</code> \u6240\u652f\u6301\u7684\u670d\u52a1\u53d1\u73b0\u6ce8\u518c\u4e2d\u5fc3\uff0c\u63a8\u8350 <code>consul</code>\uff0c\u6700\u540e\u5728 <code>Prometheus</code> \u914d\u7f6e\u6587\u4ef6\u52a0\u4e0a <code>consul_sd_config</code> \u7684\u914d\u7f6e\uff0c\u6307\u5b9a\u6bcf\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u8981\u91c7\u96c6\u7684 <code>group</code>\u3002</p> <pre><code>- job_name: 'cadvisor-1'\n  consul_sd_configs:\n    - server: 10.0.0.3:8500\n      services:\n        - cadvisor-1 # This is the 2nd slave\n</code></pre> <p>\u5728\u672a\u6765\uff0c\u4f60\u751a\u81f3\u53ef\u4ee5\u76f4\u63a5\u5229\u7528 <code>Kubernetes</code> \u7684 <code>EndpointSlice</code> \u7279\u6027\u6765\u505a\u670d\u52a1\u53d1\u73b0\u548c\u5206\u7247\u5904\u7406\uff0c\u5728\u8d85\u5927\u89c4\u6a21\u670d\u52a1\u573a\u666f\u4e0b\u5c31\u53ef\u4ee5\u4e0d\u9700\u8981\u5176\u5b83\u7684\u670d\u52a1\u53d1\u73b0\u548c\u5206\u7247\u673a\u5236\u3002\u4e0d\u8fc7\u6682\u65f6\u6b64\u7279\u6027\u8fd8\u4e0d\u591f\u6210\u719f\uff0c\u6ca1\u6709\u9ed8\u8ba4\u542f\u7528\uff0c\u4e0d\u63a8\u8350\u7528\uff08\u5f53\u524d Kubernentes \u6700\u65b0\u7248\u672c\u4e3a v1.18\uff09\u3002</p> <p>\u7b2c\u4e8c\uff0c\u7528 <code>Kubernetes</code> \u7684 <code>node</code> \u670d\u52a1\u53d1\u73b0\uff0c\u518d\u5229\u7528 <code>Prometheus relabel</code> \u914d\u7f6e\u7684 <code>hashmod</code>\u6765\u5bf9 <code>node</code> \u505a\u5206\u7247\u3002 \u6bcf\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u4ec5\u6293\u5176\u4e2d\u4e00\u4e2a\u5206\u7247\u4e2d\u7684\u6570\u636e:</p> <pre><code>- job_name: 'cadvisor-1'\n  metrics_path: /metrics/cadvisor\n  scheme: https\n\n  # \u8bf7\u6c42 kubelet metrics \u63a5\u53e3\u4e5f\u9700\u8981\u8ba4\u8bc1\u548c\u6388\u6743\uff0c\u901a\u5e38\u4f1a\u7528 webhook \u65b9\u5f0f\u8ba9 apiserver \u4ee3\u7406\u8fdb\u884c RBAC \u6821\u9a8c\uff0c\u6240\u4ee5\u8fd8\u662f\u7528 ServiceAccount \u7684 token\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n\n  kubernetes_sd_configs:\n  - role: node\n\n  # \u901a\u5e38\u4e0d\u6821\u9a8c kubelet \u7684 server \u8bc1\u4e66\uff0c\u907f\u514d\u62a5 x509: certificate signed by unknown authority\n  tls_config:\n    insecure_skip_verify: true\n\n  relabel_configs:\n  - source_labels: [__address__]\n    modulus:       4    # \u5c06\u8282\u70b9\u5206\u7247\u6210 4 \u4e2a group\n    target_label:  __tmp_hash\n    action:        hashmod\n  - source_labels: [__tmp_hash]\n    regex:         ^1$  # \u53ea\u6293\u7b2c 2 \u4e2a group \u4e2d\u8282\u70b9\u7684\u6570\u636e(\u5e8f\u53f7 0 \u4e3a\u7b2c 1 \u4e2a group)\n    action:        keep\n</code></pre>"},{"location":"chap11/39Thanos_tutorial/#2","title":"2 \u62c6\u5206\u5f15\u5165\u7684\u65b0\u95ee\u9898","text":"<p>\u524d\u9762\u6211\u4eec\u901a\u8fc7\u4e0d\u901a\u5c42\u9762\u5bf9 Prometheus \u8fdb\u884c\u4e86\u62c6\u5206\u90e8\u7f72\uff0c\u4e00\u65b9\u9762\u4f7f\u5f97 Prometheus \u80fd\u591f\u5b9e\u73b0\u6c34\u5e73\u6269\u5bb9\uff0c\u53e6\u4e00\u65b9\u9762\u4e5f\u52a0\u5267\u4e86\u76d1\u63a7\u6570\u636e\u843d\u76d8\u7684\u5206\u6563\u7a0b\u5ea6\uff0c\u4f7f\u7528 Grafana \u67e5\u8be2\u76d1\u63a7\u6570\u636e\u65f6\u6211\u4eec\u4e5f\u9700\u8981\u6dfb\u52a0\u8bb8\u591a\u6570\u636e\u6e90\uff0c\u800c\u4e14\u4e0d\u540c\u6570\u636e\u6e90\u4e4b\u95f4\u7684\u6570\u636e\u8fd8\u4e0d\u80fd\u805a\u5408\u67e5\u8be2\uff0c\u76d1\u63a7\u9875\u9762\u4e5f\u770b\u4e0d\u5230\u5168\u5c40\u7684\u89c6\u56fe\uff0c\u9020\u6210\u67e5\u8be2\u6df7\u4e71\u7684\u5c40\u9762\u3002</p> <p></p> <p>\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u4ece\u4e0b\u9762\u7684\u4e24\u65b9\u9762\u5165\u624b\uff0c\u4efb\u9009\u5176\u4e2d\u4e00\u79cd\u65b9\u6848\u3002</p>"},{"location":"chap11/39Thanos_tutorial/#2-1","title":"2-1 \u96c6\u4e2d\u6570\u636e\u5e93\u5b58\u50a8","text":"<p>\u6211\u4eec\u53ef\u4ee5\u8ba9 <code>Prometheus</code> \u4e0d\u8d1f\u8d23\u5b58\u50a8\uff0c\u4ec5\u91c7\u96c6\u6570\u636e\u5e76\u901a\u8fc7 <code>remote write</code> \u65b9\u5f0f\u5199\u5165\u8fdc\u7a0b\u5b58\u50a8\u7684 <code>adapter</code>\uff0c\u8fdc\u7a0b\u5b58\u50a8\u4f7f\u7528 <code>OpenTSDB</code> \u6216 <code>InfluxDB</code> \u8fd9\u4e9b\u652f\u6301\u96c6\u7fa4\u90e8\u7f72\u7684\u65f6\u5e8f\u6570\u636e\u5e93\uff0c<code>Prometheus</code> \u914d\u7f6e:</p> <pre><code>remote_write:\n- url: http://10.0.0.2:8888/write\n</code></pre> <p>\u7136\u540e Grafana \u6dfb\u52a0\u6211\u4eec\u4f7f\u7528\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u4f5c\u4e3a\u6570\u636e\u6e90\u6765\u67e5\u8be2\u76d1\u63a7\u6570\u636e\u6765\u5c55\u793a\uff0c\u67b6\u6784\u56fe:</p> <p></p> <p>\u8fd9\u79cd\u65b9\u5f0f\u76f8\u5f53\u4e8e\u66f4\u6362\u4e86\u5b58\u50a8\u5f15\u64ce\uff0c\u7531\u5176\u5b83\u652f\u6301\u5b58\u50a8\u6c34\u5e73\u6269\u5bb9\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u6765\u5b58\u50a8\u5e9e\u5927\u7684\u6570\u636e\u91cf\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u6570\u636e\u96c6\u4e2d\u5230\u4e00\u8d77\u3002<code>OpenTSDB</code> \u652f\u6301 <code>HBase,</code> <code>BigTable</code>\u4f5c\u4e3a\u5b58\u50a8\u540e\u7aef\uff0c<code>InfluxDB</code> \u4f01\u4e1a\u7248\u652f\u6301\u96c6\u7fa4\u90e8\u7f72\u548c\u6c34\u5e73\u6269\u5bb9\uff08\u5f00\u6e90\u7248\u4e0d\u652f\u6301\uff09\u3002\u4e0d\u8fc7\u8fd9\u6837\u7684\u8bdd\uff0c\u6211\u4eec\u5c31\u65e0\u6cd5\u4f7f\u7528\u53cb\u597d\u4e14\u5f3a\u5927\u7684 <code>PromQL</code> \u6765\u67e5\u8be2\u76d1\u63a7\u6570\u636e\u4e86\uff0c\u5fc5\u987b\u4f7f\u7528\u6211\u4eec\u5b58\u50a8\u6570\u636e\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u6240\u652f\u6301\u7684\u8bed\u6cd5\u6765\u67e5\u8be2\u3002</p>"},{"location":"chap11/39Thanos_tutorial/#2-2-prometheus","title":"2-2 Prometheus \u8054\u90a6","text":"<p>\u9664\u4e86\u4e0a\u9762\u66f4\u6362\u5b58\u50a8\u5f15\u64ce\u7684\u65b9\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u5c06 Prometheus \u8fdb\u884c\u8054\u90a6\u90e8\u7f72\u3002</p> <p></p> <p>\u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u5c06\u591a\u4e2a Prometheus \u5b9e\u4f8b\u91c7\u96c6\u7684\u6570\u636e\u518d\u7528\u53e6\u4e00\u4e2a <code>Prometheus</code> \u91c7\u96c6\u6c47\u603b\u5230\u4e00\u8d77\uff0c\u8fd9\u6837\u4e5f\u610f\u5473\u7740\u9700\u8981\u6d88\u8017\u66f4\u591a\u7684\u8d44\u6e90\u3002</p> <p>\u901a\u5e38\u6211\u4eec\u53ea\u628a\u9700\u8981\u805a\u5408\u7684\u6570\u636e\u6216\u8005\u9700\u8981\u5728\u4e00\u4e2a\u5730\u65b9\u5c55\u793a\u7684\u6570\u636e\u7528\u8fd9\u79cd\u65b9\u5f0f\u91c7\u96c6\u6c47\u603b\u5230\u4e00\u8d77\uff0c\u6bd4\u5982 <code>Kubernetes</code> \u8282\u70b9\u6570\u8fc7\u591a\uff0c<code>cadvisor</code> \u7684\u6570\u636e\u5206\u6563\u5728\u591a\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u4e0a\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u8fd9\u79cd\u65b9\u5f0f\u5c06 <code>cadvisor</code> \u66b4\u9732\u7684\u5bb9\u5668\u6307\u6807\u6c47\u603b\u8d77\u6765\uff0c\u4ee5\u4fbf\u4e8e\u5728\u4e00\u4e2a\u5730\u65b9\u5c31\u80fd\u67e5\u8be2\u5230\u96c6\u7fa4\u4e2d\u4efb\u610f\u4e00\u4e2a\u5bb9\u5668\u7684\u76d1\u63a7\u6570\u636e\u6216\u8005\u67d0\u4e2a\u670d\u52a1\u80cc\u540e\u6240\u6709\u5bb9\u5668\u7684\u76d1\u63a7\u6570\u636e\u7684\u805a\u5408\u6c47\u603b\u4ee5\u53ca\u914d\u7f6e\u544a\u8b66\u3002</p> <p>\u53c8\u6216\u8005\u591a\u4e2a\u670d\u52a1\u6709\u5173\u8054\uff0c\u6bd4\u5982\u901a\u5e38\u5e94\u7528\u53ea\u66b4\u9732\u4e86\u5b83\u5e94\u7528\u76f8\u5173\u7684\u6307\u6807\uff0c\u4f46\u5b83\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff08\u6bd4\u5982 CPU \u548c \u5185\u5b58\uff09\u7531 cadvisor \u6765\u611f\u77e5\u548c\u66b4\u9732\uff0c\u8fd9\u4e24\u90e8\u5206\u6307\u6807\u7531\u4e0d\u540c\u7684 Prometheus \u5b9e\u4f8b\u6240\u91c7\u96c6\uff0c\u8fd9\u65f6\u6211\u4eec\u4e5f\u53ef\u4ee5\u7528\u8fd9\u79cd\u65b9\u5f0f\u5c06\u6570\u636e\u6c47\u603b\uff0c\u5728\u4e00\u4e2a\u5730\u65b9\u5c55\u793a\u548c\u914d\u7f6e\u544a\u8b66\u3002</p> <p>\u66f4\u591a\u8bf4\u660e\u548c\u914d\u7f6e\u793a\u4f8b\u8bf7\u53c2\u8003\u5b98\u65b9\u6587\u6863:</p> <p>https://prometheus.io/docs/prometheus/latest/federation/</p>"},{"location":"chap11/39Thanos_tutorial/#2-3-prometheus","title":"2-3 Prometheus \u9ad8\u53ef\u7528","text":"<p>\u867d\u7136\u4e0a\u9762\u6211\u4eec\u901a\u8fc7\u4e00\u4e9b\u5217\u64cd\u4f5c\u5c06 <code>Prometheus</code> \u8fdb\u884c\u4e86\u5206\u5e03\u5f0f\u6539\u9020\uff0c\u4f46\u5e76\u6ca1\u6709\u89e3\u51b3 Prometheus \u672c\u8eab\u7684\u9ad8\u53ef\u7528\u95ee\u9898\uff0c\u5373\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u5b9e\u4f8b\u6302\u4e86\uff0c\u6570\u636e\u7684\u67e5\u8be2\u548c\u5b8c\u6574\u6027\u90fd\u5c06\u53d7\u5230\u5f71\u54cd\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5c06\u6240\u6709 <code>Prometheus</code> \u5b9e\u4f8b\u90fd\u4f7f\u7528\u4e24\u4e2a\u76f8\u540c\u526f\u672c\uff0c\u5206\u522b\u6302\u8f7d\u6570\u636e\u76d8\uff0c\u5b83\u4eec\u90fd\u91c7\u96c6\u76f8\u540c\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u5b83\u4eec\u7684\u6570\u636e\u662f\u4e00\u81f4\u7684\uff0c\u67e5\u8be2\u5b83\u4eec\u4e4b\u4e2d\u4efb\u610f\u4e00\u4e2a\u90fd\u53ef\u4ee5\uff0c\u6240\u4ee5\u53ef\u4ee5\u5728\u5b83\u4eec\u524d\u9762\u518d\u6302\u4e00\u5c42\u8d1f\u8f7d\u5747\u8861\uff08\u6bd4\u5982 <code>Nginx</code> \u6216 <code>HAProxy</code>\uff09\uff0c\u6240\u6709\u67e5\u8be2\u90fd\u5148\u7ecf\u8fc7\u8fd9\u4e2a\u8d1f\u8f7d\u5747\u8861\u518d\u5230\u5176\u4e2d\u4e00\u53f0 <code>Prometheus</code>\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u53f0\u6302\u6389\u5c31\u4ece\u8d1f\u8f7d\u5217\u8868\u91cc\u8e22\u6389\u4e0d\u518d\u8f6c\u53d1\u3002</p> <p></p> <p>\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86 Prometheus \u7684\u9ad8\u53ef\u7528\uff0c\u7b80\u5355\u8d77\u89c1\uff0c\u4e0a\u9762\u7684\u56fe\u4ec5\u5c55\u793a\u5355\u4e2a Prometheus \u7684\u9ad8\u53ef\u7528\uff0c\u5f53\u4f60\u53ef\u4ee5\u5c06\u5176\u62d3\u5c55\uff0c\u4ee3\u5165\u5e94\u7528\u5230\u4e0a\u9762\u5176\u5b83\u7684\u4f18\u5316\u624b\u6bb5\u4e2d\uff0c\u5b9e\u73b0\u6574\u4f53\u7684\u9ad8\u53ef\u7528\u3002</p> <p>\u6211\u4eec\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u89e3\u51b3\u4e86\u5355\u673a Prometheus \u5728\u5927\u89c4\u6a21\u573a\u666f\u4e0b\u7684\u75db\u70b9\uff0c\u4f46\u64cd\u4f5c\u548c\u8fd0\u7ef4\u590d\u6742\u5ea6\u6bd4\u8f83\u9ad8\uff0c\u5e76\u4e14\u4e0d\u80fd\u591f\u5f88\u597d\u7684\u652f\u6301\u6570\u636e\u7684\u957f\u671f\u5b58\u50a8\uff08long term storage\uff09\u3002</p> <p>\u5bf9\u4e8e\u4e00\u4e9b\u65f6\u95f4\u6bd4\u8f83\u4e45\u8fdc\u7684\u76d1\u63a7\u6570\u636e\uff0c\u6211\u4eec\u901a\u5e38\u67e5\u770b\u7684\u9891\u7387\u5f88\u4f4e\uff0c\u4f46\u4e5f\u5e0c\u671b\u80fd\u591f\u4f4e\u6210\u672c\u5730\u4fdd\u7559\u8db3\u591f\u957f\u65f6\u95f4\uff0c\u6570\u636e\u5982\u679c\u5168\u90e8\u843d\u76d8\u5230\u78c1\u76d8\u6210\u672c\u662f\u5f88\u9ad8\u7684\uff0c\u5e76\u4e14\u5bb9\u91cf\u6709\u9650\uff0c\u5373\u4fbf\u5229\u7528\u6c34\u5e73\u6269\u5bb9\u53ef\u4ee5\u589e\u52a0\u5b58\u50a8\u5bb9\u91cf\uff0c\u4f46\u8fd9\u5728\u540c\u65f6\u4e5f\u589e\u5927\u4e86\u8d44\u6e90\u6210\u672c\uff0c\u4e0d\u53ef\u80fd\u65e0\u9650\u6269\u5bb9\uff0c\u6240\u4ee5\u9700\u8981\u8bbe\u7f6e\u4e00\u4e2a\u6570\u636e\u8fc7\u671f\u7b56\u7565\uff0c\u4e5f\u5c31\u4f1a\u4e22\u5931\u65f6\u95f4\u6bd4\u8f83\u4e45\u8fdc\u7684\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u5bf9\u4e8e\u8fd9\u79cd\u4e0d\u5e38\u7528\u7684\u51b7\u6570\u636e\uff0c\u6700\u7406\u60f3\u7684\u65b9\u5f0f\u662f\u5b58\u5230\u5ec9\u4ef7\u7684\u5bf9\u8c61\u5b58\u50a8\u4e2d\uff0c\u7b49\u9700\u8981\u67e5\u8be2\u7684\u65f6\u5019\u80fd\u591f\u81ea\u52a8\u52a0\u8f7d\u51fa\u6765\u3002<code>Thanos</code> \u53ef\u4ee5\u5e2e\u6211\u4eec\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0c\u5b83\u5b8c\u5168\u517c\u5bb9 <code>Prometheus API</code>\uff0c\u63d0\u4f9b\u7edf\u4e00\u67e5\u8be2\u805a\u5408\u5206\u5e03\u5f0f\u90e8\u7f72\u7684 <code>Prometheus</code> \u6570\u636e\u7684\u80fd\u529b\uff0c\u540c\u65f6\u4e5f\u652f\u6301\u6570\u636e\u957f\u671f\u5b58\u50a8\u5230\u5404\u79cd\u5bf9\u8c61\u5b58\u50a8\uff08\u65e0\u9650\u5b58\u50a8\u80fd\u529b\uff09\u4ee5\u53ca\u964d\u4f4e\u91c7\u6837\u7387\u6765\u52a0\u901f\u5927\u65f6\u95f4\u8303\u56f4\u7684\u6570\u636e\u67e5\u8be2\u3002</p>"},{"location":"chap11/39Thanos_tutorial/#3-thanos","title":"3 Thanos \u67b6\u6784\u8be6\u89e3","text":"<p>Thanos\uff08\u6ca1\u9519\uff0c\u5c31\u662f\u706d\u9738\uff09\u53ef\u4ee5\u5e2e\u6211\u4eec\u7b80\u5316\u5206\u5e03\u5f0f Prometheus \u7684\u90e8\u7f72\u4e0e\u7ba1\u7406\uff0c\u5e76\u63d0\u4f9b\u4e86\u4e00\u4e9b\u7684\u9ad8\u7ea7\u7279\u6027\uff1a\u5168\u5c40\u89c6\u56fe\u3001\u957f\u671f\u5b58\u50a8\u3001\u9ad8\u53ef\u7528\u3002\u4e0b\u9762\u6211\u4eec\u6765\u8be6\u7ec6\u8bb2\u89e3\u4e00\u4e0b\u3002</p>"},{"location":"chap11/39Thanos_tutorial/#3-1-thanos","title":"3-1 Thanos \u673a\u6784","text":"<p>\u7b80\u5355\u4ecb\u7ecd\u4e0b\u56fe\u4e2d\u8fd9\u51e0\u4e2a\u7ec4\u4ef6\u7684\u4f5c\u7528\uff1a</p> <ul> <li><code>Thanos Query</code>\uff1a\u5b9e\u73b0\u4e86 Prometheus API\uff0c\u5c06\u6765\u81ea\u4e0b\u6e38\u7ec4\u4ef6\u63d0\u4f9b\u7684\u6570\u636e\u8fdb\u884c\u805a\u5408\u6700\u7ec8\u8fd4\u56de\u7ed9\u67e5\u8be2\u6570\u636e\u7684 client \uff08\u5982 grafana\uff09\uff0c\u7c7b\u4f3c\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u3002</li> <li><code>Thanos Sidecar</code>\uff1a\u8fde\u63a5 Prometheus\uff0c\u5c06\u5176\u6570\u636e\u63d0\u4f9b\u7ed9 Thanos Query \u67e5\u8be2\uff0c\u5e76\u4e14/\u6216\u8005\u5c06\u5176\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\uff0c\u4ee5\u4f9b\u957f\u671f\u5b58\u50a8\u3002</li> <li><code>Thanos Store Gateway</code>\uff1a\u5c06\u5bf9\u8c61\u5b58\u50a8\u7684\u6570\u636e\u66b4\u9732\u7ed9 <code>Thanos Query</code> \u53bb\u67e5\u8be2\u3002</li> <li><code>Thanos Ruler</code>\uff1a\u5bf9\u76d1\u63a7\u6570\u636e\u8fdb\u884c\u8bc4\u4f30\u548c\u544a\u8b66\uff0c\u8fd8\u53ef\u4ee5\u8ba1\u7b97\u51fa\u65b0\u7684\u76d1\u63a7\u6570\u636e\uff0c\u5c06\u8fd9\u4e9b\u65b0\u6570\u636e\u63d0\u4f9b\u7ed9 Thanos Query \u67e5\u8be2\u5e76\u4e14/\u6216\u8005\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\uff0c\u4ee5\u4f9b\u957f\u671f\u5b58\u50a8\u3002</li> <li><code>Thanos Compact</code>\uff1a\u5c06\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u538b\u7f29\u548c\u964d\u4f4e\u91c7\u6837\u7387\uff0c\u52a0\u901f\u5927\u65f6\u95f4\u533a\u95f4\u76d1\u63a7\u6570\u636e\u67e5\u8be2\u7684\u901f\u5ea6\u3002</li> </ul>"},{"location":"chap11/39Thanos_tutorial/#3-2","title":"3-2 \u673a\u6784\u8bbe\u8ba1\u5256\u6790","text":"<p>\u5982\u4f55\u7406\u89e3 Thanos \u7684\u67b6\u6784\u8bbe\u8ba1\u7684\uff1f\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u5148 YY \u4e00\u4e0b\uff0c\u8981\u662f\u81ea\u5df1\u6765\u8bbe\u8ba1\u4e00\u4e2a\u5206\u5e03\u5f0f Prometheus \u7ba1\u7406\u5e94\u7528\uff0c\u4f1a\u600e\u4e48\u505a\uff1f</p> <p>Query \u4e0e Sidecar</p> <p>\u9996\u5148\uff0c\u76d1\u63a7\u6570\u636e\u7684\u67e5\u8be2\u80af\u5b9a\u4e0d\u80fd\u76f4\u63a5\u67e5 Prometheus \u4e86\uff0c\u56e0\u4e3a\u4f1a\u5b58\u5728\u8bb8\u591a\u4e2a Prometheus \u5b9e\u4f8b\uff0c\u6bcf\u4e2a Prometheus \u5b9e\u4f8b\u53ea\u80fd\u611f\u77e5\u5b83\u81ea\u5df1\u6240\u91c7\u96c6\u7684\u6570\u636e\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u6bd4\u8f83\u5bb9\u6613\u8054\u60f3\u5230\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\uff0c\u6bcf\u4e2a\u6570\u636e\u5e93\u90fd\u53ea\u5b58\u4e86\u4e00\u90e8\u5206\u6570\u636e\uff0c\u4e2d\u95f4\u4ef6\u80fd\u611f\u77e5\u5230\u6240\u6709\u6570\u636e\u5e93\uff0c\u6570\u636e\u67e5\u8be2\u90fd\u7ecf\u8fc7\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u6765\u67e5\uff0c\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u6536\u5230\u67e5\u8be2\u8bf7\u6c42\u518d\u53bb\u67e5\u4e0b\u6e38\u5404\u4e2a\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\uff0c\u6700\u540e\u5c06\u8fd9\u4e9b\u6570\u636e\u805a\u5408\u6c47\u603b\u8fd4\u56de\u7ed9\u67e5\u8be2\u7684\u5ba2\u6237\u7aef\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u5c06\u5206\u5e03\u5f0f\u5b58\u50a8\u7684\u6570\u636e\u96c6\u4e2d\u67e5\u8be2\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c<code>Thanos</code> \u4e5f\u662f\u4f7f\u7528\u4e86\u7c7b\u4f3c\u7684\u8bbe\u8ba1\u601d\u60f3\uff0c<code>Thanos Query</code> \u5c31\u662f\u8fd9\u4e2a \u201c\u4e2d\u95f4\u4ef7\u201d \u7684\u5173\u952e\u5165\u53e3\uff0c\u5b83\u5b9e\u73b0\u4e86 <code>Prometheus</code>\u7684 <code>HTTP API</code>\uff0c\u80fd\u591f \u201c\u770b\u61c2\u201d <code>PromQL</code>\u3002</p> <p>\u8fd9\u6837\uff0c\u67e5\u8be2 <code>Prometheus</code> \u76d1\u63a7\u6570\u636e\u7684 <code>client</code>\u5c31\u4e0d\u76f4\u63a5\u67e5\u8be2 <code>Prometheus</code> \u672c\u8eab\u4e86\uff0c\u800c\u662f\u53bb\u67e5\u8be2 <code>Thanos Query</code>\uff0c<code>Thanos Query</code> \u518d\u53bb\u4e0b\u6e38\u591a\u4e2a\u5b58\u50a8\u4e86\u6570\u636e\u7684\u5730\u65b9\u67e5\u6570\u636e\uff0c\u6700\u540e\u5c06\u8fd9\u4e9b\u6570\u636e\u805a\u5408\u53bb\u91cd\u540e\u8fd4\u56de\u7ed9 client\uff0c\u4e5f\u5c31\u5b9e\u73b0\u4e86\u5206\u5e03\u5f0f Prometheus \u7684\u6570\u636e\u67e5\u8be2\u3002</p> <p>\u90a3\u4e48<code>Thanos Query</code> \u53c8\u5982\u4f55\u53bb\u67e5\u4e0b\u6e38\u5206\u6563\u7684\u6570\u636e\u5462\uff1f<code>Thanos</code> \u4e3a\u6b64\u62bd\u8c61\u4e86\u4e00\u5957\u53eb <code>Store API</code> \u7684\u5185\u90e8 <code>gRPC</code> \u63a5\u53e3\uff0c\u5176\u5b83\u4e00\u4e9b\u7ec4\u4ef6\u901a\u8fc7\u8fd9\u4e2a\u63a5\u53e3\u6765\u66b4\u9732\u6570\u636e\u7ed9 <code>Thanos Query</code>\uff0c\u5b83\u81ea\u8eab\u4e5f\u5c31\u53ef\u4ee5\u505a\u5230\u5b8c\u5168\u65e0\u72b6\u6001\u90e8\u7f72\uff0c\u5b9e\u73b0\u9ad8\u53ef\u7528\u4e0e\u52a8\u6001\u6269\u5c55\u3002</p> <p></p> <p>\u8fd9\u4e9b\u5206\u6563\u7684\u6570\u636e\u53ef\u80fd\u6765\u81ea\u54ea\u4e9b\u5730\u65b9\u5462\uff1f</p> <p>\u9996\u5148\uff0c<code>Prometheus</code> \u4f1a\u5c06\u91c7\u96c6\u7684\u6570\u636e\u5b58\u5230\u672c\u673a\u78c1\u76d8\u4e0a\uff0c\u5982\u679c\u6211\u4eec\u76f4\u63a5\u7528\u8fd9\u4e9b\u5206\u6563\u5728\u5404\u4e2a\u78c1\u76d8\u4e0a\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u7ed9\u6bcf\u4e2a <code>Prometheus</code> \u9644\u5e26\u90e8\u7f72\u4e00\u4e2a <code>Sidecar</code>\uff0c\u8fd9\u4e2a <code>Sidecar</code>\u5b9e\u73b0 <code>Thanos Store API</code>\uff0c\u5f53 <code>Thanos Query</code> \u5bf9\u5176\u53d1\u8d77\u67e5\u8be2\u65f6\uff0c<code>Sidecar</code> \u5c31\u8bfb\u53d6\u8ddf\u5b83\u7ed1\u5b9a\u90e8\u7f72\u7684 <code>Prometheus</code> \u5b9e\u4f8b\u4e0a\u7684\u76d1\u63a7\u6570\u636e\u8fd4\u56de\u7ed9 <code>Thanos Query</code>\u3002</p> <p></p> <p>\u7531\u4e8e <code>Thanos Query</code> \u53ef\u4ee5\u5bf9\u6570\u636e\u8fdb\u884c\u805a\u5408\u4e0e\u53bb\u91cd\uff0c\u6240\u4ee5\u53ef\u4ee5\u5f88\u8f7b\u677e\u5b9e\u73b0\u9ad8\u53ef\u7528\uff1a\u76f8\u540c\u7684 <code>Prometheus</code> \u90e8\u7f72\u591a\u4e2a\u526f\u672c\uff08\u90fd\u9644\u5e26 <code>Sidecar</code>\uff09\uff0c\u7136\u540e <code>Thanos Query</code> \u53bb\u6240\u6709 <code>Sidecar</code> \u67e5\u6570\u636e\uff0c\u5373\u4fbf\u6709\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u6302\u6389\u8fc7\u4e00\u6bb5\u65f6\u95f4\uff0c\u6570\u636e\u805a\u5408\u4e0e\u53bb\u91cd\u540e\u4ecd\u7136\u80fd\u5f97\u5230\u5b8c\u6574\u6570\u636e\u3002</p> <p>\u8fd9\u79cd\u9ad8\u53ef\u7528\u505a\u6cd5\u8fd8\u5f25\u8865\u4e86\u6211\u4eec\u4e0a\u7bc7\u6587\u7ae0\u4e2d\u7528\u8d1f\u8f7d\u5747\u8861\u53bb\u5b9e\u73b0 <code>Prometheus</code> \u9ad8\u53ef\u7528\u65b9\u6cd5\u7684\u7f3a\u9677\uff1a\u5982\u679c\u5176\u4e2d\u4e00\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u6302\u4e86\u4e00\u6bb5\u65f6\u95f4\u7136\u540e\u53c8\u6062\u590d\u4e86\uff0c\u5b83\u7684\u6570\u636e\u5c31\u4e0d\u5b8c\u6574\uff0c\u5f53\u8d1f\u8f7d\u5747\u8861\u8f6c\u53d1\u5230\u5b83\u4e0a\u9762\u53bb\u67e5\u6570\u636e\u65f6\uff0c\u8fd4\u56de\u7684\u7ed3\u679c\u5c31\u53ef\u80fd\u4f1a\u6709\u90e8\u5206\u7f3a\u5931\u3002</p> <p>\u4e0d\u8fc7\u56e0\u4e3a\u78c1\u76d8\u7a7a\u95f4\u6709\u9650\uff0c<code>Prometheus</code> \u5b58\u50a8\u76d1\u63a7\u6570\u636e\u7684\u80fd\u529b\u4e5f\u662f\u6709\u9650\u7684\uff0c\u901a\u5e38\u4f1a\u7ed9 <code>Prometheus</code> \u8bbe\u7f6e\u4e00\u4e2a\u6570\u636e\u8fc7\u671f\u65f6\u95f4\uff08\u9ed8\u8ba4 15 \u5929\uff09\u6216\u8005\u6700\u5927\u6570\u636e\u91cf\u5927\u5c0f\uff0c\u4e0d\u65ad\u6e05\u7406\u65e7\u6570\u636e\u4ee5\u4fdd\u8bc1\u78c1\u76d8\u4e0d\u88ab\u6491\u7206\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u65e0\u6cd5\u770b\u5230\u65f6\u95f4\u6bd4\u8f83\u4e45\u8fdc\u7684\u76d1\u63a7\u6570\u636e\uff0c\u6709\u65f6\u5019\u8fd9\u4e5f\u7ed9\u6211\u4eec\u7684\u95ee\u9898\u6392\u67e5\u548c\u6570\u636e\u7edf\u8ba1\u9020\u6210\u4e00\u4e9b\u56f0\u96be\u3002</p> <p>\u5bf9\u4e8e\u9700\u8981\u957f\u671f\u5b58\u50a8\u7684\u6570\u636e\uff0c\u5e76\u4e14\u4f7f\u7528\u9891\u7387\u4e0d\u90a3\u4e48\u9ad8\uff0c\u6700\u7406\u60f3\u7684\u65b9\u5f0f\u662f\u5b58\u8fdb\u5bf9\u8c61\u5b58\u50a8\uff0c\u5404\u5927\u4e91\u5382\u5546\u90fd\u6709\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\uff0c\u7279\u70b9\u662f\u4e0d\u9650\u5236\u5bb9\u91cf\uff0c\u4ef7\u683c\u975e\u5e38\u4fbf\u5b9c\u3002</p> <p>Thanos \u6709\u51e0\u4e2a\u7ec4\u4ef6\u90fd\u652f\u6301\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5404\u79cd\u5bf9\u8c61\u5b58\u50a8\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58\uff08<code>Prometheus TSDB</code> \u6570\u636e\u683c\u5f0f\uff09\uff0c\u6bd4\u5982\u6211\u4eec\u521a\u521a\u8bf4\u7684 Sidecar:</p> <p></p> <p>Store Gateway</p> <p>\u90a3\u4e48\u8fd9\u4e9b\u88ab\u4e0a\u4f20\u5230\u4e86\u5bf9\u8c61\u5b58\u50a8\u91cc\u7684\u76d1\u63a7\u6570\u636e\u8be5\u5982\u4f55\u67e5\u8be2\u5462\uff1f\u7406\u8bba\u4e0a <code>Thanos Query</code> \u4e5f\u53ef\u4ee5\u76f4\u63a5\u53bb\u5bf9\u8c61\u5b58\u50a8\u67e5\uff0c\u4f46\u8fd9\u4f1a\u8ba9 <code>Thanos Query</code> \u7684\u903b\u8f91\u53d8\u7684\u5f88\u91cd\u3002</p> <p>\u6211\u4eec\u521a\u624d\u4e5f\u770b\u5230\u4e86\uff0c<code>Thanos</code> \u62bd\u8c61\u51fa\u4e86<code>Store API</code>\uff0c\u53ea\u8981\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\u7684\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u4f5c\u4e3a <code>Thanos Query</code> \u67e5\u8be2\u7684\u6570\u636e\u6e90\uff0c<code>Thanos Store Gateway</code> \u8fd9\u4e2a\u7ec4\u4ef6\u4e5f\u5b9e\u73b0\u4e86 <code>Store API</code>\uff0c\u5411 <code>Thanos Query</code>\u66b4\u9732\u5bf9\u8c61\u5b58\u50a8\u7684\u6570\u636e\u3002</p> <p><code>Thanos Store Gateway</code> \u5185\u90e8\u8fd8\u505a\u4e86\u4e00\u4e9b\u52a0\u901f\u6570\u636e\u83b7\u53d6\u7684\u4f18\u5316\u903b\u8f91\uff0c\u4e00\u662f\u7f13\u5b58\u4e86 <code>TSDB</code> \u7d22\u5f15\uff0c\u4e8c\u662f\u4f18\u5316\u4e86\u5bf9\u8c61\u5b58\u50a8\u7684\u8bf7\u6c42 (\u7528\u5c3d\u53ef\u80fd\u5c11\u7684\u8bf7\u6c42\u91cf\u62ff\u5230\u6240\u6709\u9700\u8981\u7684\u6570\u636e)\u3002</p> <p></p> <p>\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u76d1\u63a7\u6570\u636e\u7684\u957f\u671f\u50a8\u5b58\uff0c\u7531\u4e8e\u5bf9\u8c61\u5b58\u50a8\u5bb9\u91cf\u65e0\u9650\uff0c\u6240\u4ee5\u7406\u8bba\u4e0a\u6211\u4eec\u53ef\u4ee5\u5b58\u4efb\u610f\u65f6\u957f\u7684\u6570\u636e\uff0c\u76d1\u63a7\u5386\u53f2\u6570\u636e\u4e5f\u5c31\u53d8\u5f97\u53ef\u8ffd\u6eaf\u67e5\u8be2\uff0c\u4fbf\u4e8e\u95ee\u9898\u6392\u67e5\u4e0e\u7edf\u8ba1\u5206\u6790\u3002</p> <p>Ruler</p> <p>\u6709\u4e00\u4e2a\u95ee\u9898\uff0c  <code>Prometheus</code> \u4e0d\u4ec5\u4ec5\u53ea\u652f\u6301\u5c06\u91c7\u96c6\u7684\u6570\u636e\u8fdb\u884c\u5b58\u50a8\u548c\u67e5\u8be2\u7684\u529f\u80fd\uff0c\u8fd8\u53ef\u4ee5\u914d\u7f6e\u4e00\u4e9b <code>rules</code>:</p> <p>\u6839\u636e\u914d\u7f6e\u4e0d\u65ad\u8ba1\u7b97\u51fa\u65b0\u6307\u6807\u6570\u636e\u5e76\u5b58\u50a8\uff0c\u540e\u7eed\u67e5\u8be2\u65f6\u76f4\u63a5\u4f7f\u7528\u8ba1\u7b97\u597d\u7684\u65b0\u6307\u6807\uff0c\u8fd9\u6837\u53ef\u4ee5\u51cf\u8f7b\u67e5\u8be2\u65f6\u7684\u8ba1\u7b97\u538b\u529b\uff0c\u52a0\u5feb\u67e5\u8be2\u901f\u5ea6\u3002</p> <p>\u4e0d\u65ad\u8ba1\u7b97\u548c\u8bc4\u4f30\u662f\u5426\u8fbe\u5230\u544a\u8b66\u9600\u503c\uff0c\u5f53\u8fbe\u5230\u9600\u503c\u65f6\u5c31\u901a\u77e5 <code>AlertManager</code>\u6765\u89e6\u53d1\u544a\u8b66\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u5c06 <code>Prometheus</code> \u8fdb\u884c\u5206\u5e03\u5f0f\u90e8\u7f72\uff0c\u6bcf\u4e2a <code>Prometheus</code> \u5b9e\u4f8b\u672c\u5730\u5e76\u6ca1\u6709\u5b8c\u6574\u6570\u636e\uff0c\u6709\u4e9b\u6709\u5173\u8054\u7684\u6570\u636e\u53ef\u80fd\u5b58\u5728\u591a\u4e2a <code>Prometheus</code>\u5b9e\u4f8b\u4e2d\uff0c\u5355\u673a <code>Prometheus</code> \u770b\u4e0d\u5230\u6570\u636e\u7684\u5168\u5c40\u89c6\u56fe\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u5c31\u4e0d\u80fd\u4f9d\u8d56 <code>Prometheus</code> \u6765\u505a\u8fd9\u4e9b\u5de5\u4f5c\u3002</p> <p>\u8fd9\u65f6\uff0c<code>Thanos Ruler</code> \u5c31\u80fd\u5927\u663e\u8eab\u624b\u4e86\u3002\u5b83\u901a\u8fc7\u67e5\u8be2 <code>Thanos Query</code> \u83b7\u53d6\u5168\u5c40\u6570\u636e\uff0c\u7136\u540e\u6839\u636e <code>rules</code> \u914d\u7f6e\u8ba1\u7b97\u65b0\u6307\u6807\u5e76\u5b58\u50a8\uff0c\u540c\u65f6\u4e5f\u901a\u8fc7 <code>Store API</code> \u5c06\u6570\u636e\u66b4\u9732\u7ed9 <code>Thanos Query</code>\uff0c\u540c\u6837\u8fd8\u53ef\u4ee5\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58\uff08\u8fd9\u91cc\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u4e00\u6837\u4e5f\u662f\u901a\u8fc7 <code>Thanos Store Gateway</code> \u66b4\u9732\u7ed9<code>Thanos Query</code>\uff09\u3002</p> <p></p> <p>\u770b\u8d77\u6765 <code>Thanos Query</code> \u8ddf<code>Thanos Ruler</code> \u4e4b\u95f4\u4f1a\u76f8\u4e92\u67e5\u8be2\uff0c\u4e0d\u8fc7\u8fd9\u4e2a\u4e0d\u51b2\u7a81\uff0c<code>Thanos Ruler</code> \u4e3a <code>Thanos Query</code> \u63d0\u4f9b\u8ba1\u7b97\u51fa\u7684\u65b0\u6307\u6807\u6570\u636e\uff0c\u800c <code>Thanos Query</code> \u4e3a <code>Thanos Ruler</code> \u63d0\u4f9b\u8ba1\u7b97\u65b0\u6307\u6807\u6240\u9700\u8981\u7684\u5168\u5c40\u539f\u59cb\u6307\u6807\u6570\u636e\u3002</p> <p>\u81f3\u6b64\uff0c<code>Thanos</code> \u7684\u6838\u5fc3\u80fd\u529b\u57fa\u672c\u5b9e\u73b0\u4e86\uff0c\u5b8c\u5168\u517c\u5bb9 <code>Prometheus</code> \u60c5\u51b5\u4e0b\u63d0\u4f9b\u6570\u636e\u67e5\u8be2\u7684\u5168\u5c40\u89c6\u56fe\u3001\u9ad8\u53ef\u7528\u4ee5\u53ca\u6570\u636e\u7684\u957f\u671f\u4fdd\u5b58\u3002</p> <p>\u90a3\u6211\u4eec\u8fd8\u53ef\u4ee5\u600e\u4e48\u8fdb\u4e00\u6b65\u505a\u4f18\u5316\u5462\uff1f</p> <p>Compact</p> <p>\u7531\u4e8e\u6211\u4eec\u6709\u6570\u636e\u957f\u671f\u5b58\u50a8\u7684\u80fd\u529b\uff0c\u4e5f\u5c31\u53ef\u4ee5\u5b9e\u73b0\u67e5\u8be2\u8f83\u5927\u65f6\u95f4\u8303\u56f4\u7684\u76d1\u63a7\u6570\u636e\uff0c\u5f53\u65f6\u95f4\u8303\u56f4\u5f88\u5927\u65f6\uff0c\u67e5\u8be2\u7684\u6570\u636e\u91cf\u4e5f\u4f1a\u5f88\u5927\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u67e5\u8be2\u901f\u5ea6\u975e\u5e38\u6162\u3002</p> <p>\u901a\u5e38\u5728\u67e5\u770b\u8f83\u5927\u65f6\u95f4\u8303\u56f4\u7684\u76d1\u63a7\u6570\u636e\u65f6\uff0c\u6211\u4eec\u5e76\u4e0d\u9700\u8981\u90a3\u4e48\u8be6\u7ec6\u7684\u6570\u636e\uff0c\u53ea\u9700\u8981\u770b\u5230\u5927\u81f4\u5c31\u884c\u3002\u8fd9\u65f6\u6211\u4eec\u53ef\u4ee5\u7528\u5230 <code>Thanos Compact</code>\uff0c\u5b83\u53ef\u4ee5\u8bfb\u53d6\u5bf9\u8c61\u5b58\u50a8\u7684\u6570\u636e\uff0c\u5bf9\u5176\u8fdb\u884c\u538b\u7f29\u4ee5\u53ca\u964d\u91c7\u6837\u518d\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\uff0c\u8fd9\u6837\u5728\u67e5\u8be2\u5927\u65f6\u95f4\u8303\u56f4\u6570\u636e\u65f6\u5c31\u53ef\u4ee5\u53ea\u8bfb\u53d6\u538b\u7f29\u548c\u964d\u91c7\u6837\u540e\u7684\u6570\u636e\uff0c\u6781\u5927\u5730\u51cf\u5c11\u4e86\u67e5\u8be2\u7684\u6570\u636e\u91cf\uff0c\u4ece\u800c\u52a0\u901f\u67e5\u8be2</p> <p></p> <p>\u518d\u770b\u67b6\u6784\u56fe</p> <p>\u4e0a\u9762\u6211\u4eec\u5256\u6790\u4e86\u5b98\u65b9\u67b6\u6784\u56fe\u4e2d\u5404\u4e2a\u7ec4\u4ef6\u7684\u8bbe\u8ba1\uff0c\u73b0\u5728\u518d\u6765\u56de\u5473\u4e00\u4e0b\u8fd9\u5f20\u56fe\uff1a</p> <p></p> <p>\u53e6\u5916\u8fd8\u6709 <code>Thanos Bucket</code> \u548c <code>Thanos Checker</code> \u4e24\u4e2a\u8f85\u52a9\u6027\u7684\u5de5\u5177\u7ec4\u4ef6\u6ca1\u753b\u51fa\u6765\uff0c\u5b83\u4eec\u4e0d\u662f\u6838\u5fc3\u7ec4\u4ef6\uff0c\u8fd9\u91cc\u4e5f\u5c31\u4e0d\u518d\u8d58\u8ff0\u3002</p>"},{"location":"chap11/39Thanos_tutorial/#3-3-sidecae-receiver","title":"3-3 Sidecae \u548c Receiver \u6a21\u5f0f","text":"<p>\u524d\u9762\u6211\u4eec\u7406\u89e3\u4e86\u5b98\u65b9\u7684\u67b6\u6784\u56fe\uff0c\u4f46\u5176\u4e2d\u8fd8\u7f3a\u5931\u4e00\u4e2a\u6838\u5fc3\u7ec4\u4ef6 Thanos Receiver\uff0c\u56e0\u4e3a\u5b83\u662f\u4e00\u4e2a\u8fd8\u672a\u5b8c\u5168\u53d1\u5e03\u7684\u7ec4\u4ef6\u3002</p> <p>\u8bbe\u8ba1\u6587\u6863:  https://thanos.io/proposals/201812_thanos-remote-receive.md/</p> <p>\u8fd9\u4e2a\u7ec4\u4ef6\u53ef\u4ee5\u5b8c\u5168\u6d88\u9664 <code>Sidecar</code>\uff0c\u6240\u4ee5 Thanos \u5b9e\u9645\u6709\u4e24\u79cd\u67b6\u6784\u56fe\uff0c\u53ea\u662f\u56e0\u4e3a\u6ca1\u6709\u5b8c\u5168\u53d1\u5e03\uff0c\u5b98\u65b9\u7684\u67b6\u6784\u56fe\u53ea\u7ed9\u7684 <code>Sidecar</code> \u6a21\u5f0f\u3002</p> <p><code>Receiver</code> \u662f\u505a\u4ec0\u4e48\u7684\u5462\uff1f\u4e3a\u4ec0\u4e48\u9700\u8981 <code>Receiver</code>\uff1f\u5b83\u8ddf Sidecar \u6709\u4ec0\u4e48\u533a\u522b\uff1f</p> <p>\u5b83\u4eec\u90fd\u53ef\u4ee5\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58\uff0c\u533a\u522b\u5728\u4e8e\u6700\u65b0\u6570\u636e\u7684\u5b58\u50a8\u3002</p> <p>\u7531\u4e8e\u6570\u636e\u4e0a\u4f20\u4e0d\u53ef\u80fd\u5b9e\u65f6\uff0c<code>Sidecar</code> \u6a21\u5f0f\u5c06\u6700\u65b0\u7684\u76d1\u63a7\u6570\u636e\u5b58\u5230 <code>Prometheus</code> \u672c\u673a\uff0c<code>Query</code> \u901a\u8fc7\u8c03\u6240\u6709 <code>Sidecar</code> \u7684<code>Store API</code> \u6765\u83b7\u53d6\u6700\u65b0\u6570\u636e\uff0c\u8fd9\u5c31\u6210\u4e00\u4e2a\u95ee\u9898\uff1a\u5982\u679c <code>Sidecar</code>\u6570\u91cf\u975e\u5e38\u591a\u6216\u8005 <code>Sidecar</code> \u8ddf <code>Query</code> \u79bb\u7684\u6bd4\u8f83\u8fdc\uff0c\u6bcf\u6b21\u67e5\u8be2 <code>Query</code> \u90fd\u8c03\u6240\u6709 <code>Sideca</code>r \u4f1a\u6d88\u8017\u5f88\u591a\u8d44\u6e90\uff0c\u5e76\u4e14\u901f\u5ea6\u5f88\u6162\uff0c\u800c\u6211\u4eec\u67e5\u770b\u76d1\u63a7\u5927\u591a\u6570\u60c5\u51b5\u90fd\u662f\u770b\u7684\u6700\u65b0\u6570\u636e\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c<code>Thanos Receiver</code> \u7ec4\u4ef6\u88ab\u63d0\u51fa\uff0c\u5b83\u9002\u914d\u4e86 <code>Prometheus</code> \u7684 <code>remote write API</code>\uff0c\u4e5f\u5c31\u662f\u6240\u6709 <code>Prometheus</code> \u5b9e\u4f8b\u53ef\u4ee5\u5b9e\u65f6\u5c06\u6570\u636e <code>push</code>\u5230 <code>Thanos Receiver</code>\uff0c\u6700\u65b0\u6570\u636e\u4e5f\u5f97\u4ee5\u96c6\u4e2d\u8d77\u6765\uff0c\u7136\u540e <code>Thanos Query</code> \u4e5f\u4e0d\u7528\u53bb\u6240\u6709 <code>Sidecar</code> \u67e5\u6700\u65b0\u6570\u636e\u4e86\uff0c\u76f4\u63a5\u67e5 <code>Thanos Receiver</code> \u5373\u53ef\u3002</p> <p>\u53e6\u5916\uff0c<code>Thanos Receiver</code> \u4e5f\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58\uff0c\u5f53\u7136\uff0c\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u540c\u6837\u7531 <code>Thanos Store Gateway</code> \u66b4\u9732\u7ed9 <code>Thanos Query</code>\u3002</p> <p></p> <p>\u6709\u540c\u5b66\u53ef\u80fd\u4f1a\u95ee\uff1a\u5982\u679c\u89c4\u6a21\u5f88\u5927\uff0cReceiver \u538b\u529b\u4f1a\u4e0d\u4f1a\u5f88\u5927\uff0c\u6210\u4e3a\u6027\u80fd\u74f6\u9888\uff1f\u5f53\u7136\uff0c\u8bbe\u8ba1\u8005\u5728\u8bbe\u8ba1\u8fd9\u4e2a\u7ec4\u4ef6\u65f6\u80af\u5b9a\u4f1a\u8003\u8651\u8fd9\u4e2a\u95ee\u9898\uff0cReceiver \u5b9e\u73b0\u4e86\u4e00\u81f4\u6027\u54c8\u5e0c\uff0c\u652f\u6301\u96c6\u7fa4\u90e8\u7f72\uff0c\u6240\u4ee5\u5373\u4f7f\u89c4\u6a21\u5f88\u5927\u4e5f\u4e0d\u4f1a\u6210\u4e3a\u6027\u80fd\u74f6\u9888\u3002</p>"},{"location":"chap11/61thanos_sidecar_receiver/","title":"\u7b2c\u56db\u8282\uff082022\uff09\u5982\u4f55\u9009\u62e9 Thanos \u7684 Sidecar \u548c Receiver \u4e24\u79cd\u6a21\u5f0f\uff1f","text":"<p>Prometheus \u65e0\u7591\u662f\u73b0\u5728\u6700\u70ed\u95e8\u7684\u76d1\u63a7\u7cfb\u7edf\uff0c\u5b83\u5df2\u88ab\u8bc1\u660e\u662f Kubernetes \u7cfb\u7edf\u4e2d\u76d1\u63a7\u548c\u62a5\u8b66\u7684\u9996\u9009\u89e3\u51b3\u65b9\u6848\uff0c\u4e0d\u8fc7\u867d\u7136 Prometheus \u6709\u4e00\u4e9b\u65b9\u6848\u6765\u5b9e\u73b0\u81ea\u8eab\u7684\u9ad8\u53ef\u7528\u6027\uff0c\u4f46\u5b83\u5728\u6570\u636e\u4fdd\u7559\u3001\u5386\u53f2\u6570\u636e\u68c0\u7d22\u548c\u591a\u79df\u6237\u65b9\u9762\u4e5f\u6709\u5176\u81ea\u8eab\u7684\u5c40\u9650\u6027\uff0c\u800c\u8fd9\u4e5f\u662f Thanos \u8bd5\u56fe\u53bb\u5f25\u8865 Prometheus \u4e0d\u8db3\u7684\u5730\u65b9\u3002</p> <p>\u672c\u6587\u6211\u4eec\u5c06\u4ecb\u7ecd\u5728 Kubernetes \u73af\u5883\u4e2d\u96c6\u6210 Thanos \u548c Prometheus \u7684\u4e24\u79cd\u4e0d\u540c\u65b9\u6cd5\uff0c\u5e76\u5c06\u5bf9\u6bd4\u8fd9\u4e24\u79cd\u65b9\u5f0f\u7684\u5f02\u540c\u70b9\u3002</p> <p>\u9664\u4e86 Thanos \u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u4e2a\u540d\u4e3a Cortex \u7684\u5f00\u6e90\u9879\u76ee\u4e5f\u662f\u4e00\u79cd\u6bd4\u8f83\u6d41\u884c\u7684\u89e3\u51b3 Prometheus \u4e0d\u8db3\u7684\u89e3\u51b3\u65b9\u6848\uff0cThanos \u6700\u521d\u53ea\u652f\u6301 sidecar \u7684\u5b89\u88c5\u6a21\u5f0f\uff0c\u800c Cortex \u66f4\u559c\u6b22\u57fa\u4e8e push \u6216\u8005\u8fdc\u7a0b\u5199\u7684\u65b9\u5f0f\u6765\u6536\u96c6\u6307\u6807\u6570\u636e\uff0c\u4f46\u65e9\u57282019\u5e74\uff0c\u8fd9\u4e24\u4e2a\u9879\u76ee\u5176\u5b9e\u5c31\u8fdb\u884c\u4e86\u5408\u4f5c\uff0c\u5728\u4e92\u76f8\u5b66\u4e60\u4e4b\u540e\uff0cThanos \u5f15\u5165\u4e86 Receiver \u7ec4\u4ef6\uff0c\u800c Cortex \u7684\u5757\u5b58\u50a8\u5219\u4e5f\u6784\u5efa\u5728\u4e86\u51e0\u4e2a\u6838\u5fc3\u7684 Thanos \u7ec4\u4ef6\u4e4b\u4e0a\u3002</p>"},{"location":"chap11/61thanos_sidecar_receiver/#1-thanos","title":"1 Thanos","text":"<p>Thanos \u652f\u6301\u4e24\u79cd\u65b9\u5f0f\u4e0e Prometheus \u8fdb\u884c\u96c6\u6210\uff1a</p> <p>sidecar / receiver</p> <p>Thanos \u4e2d\u5177\u6709\u4ee5\u4e0b\u51e0\u4e2a\u901a\u7528\u7684\u7ec4\u4ef6\uff1a</p> <p>Querier / Store / Compactor / Ruler</p> <p>\u53e6\u5916 Sidecar \u548c Receiver \u4e5f\u662f Thanos \u7684\u91cd\u8981\u7ec4\u4ef6\uff0c\u4ed6\u4eec\u6709\u5404\u81ea\u7684\u8fd0\u884c\u65b9\u5f0f\uff0c\u5728\u6bd4\u8f83\u8fd9\u4e24\u79cd\u65b9\u5f0f\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u6765\u7b80\u5355\u4e86\u89e3\u4e0b Sidecar \u548c Receiver \u7684\u5de5\u4f5c\u539f\u7406\u3002</p>"},{"location":"chap11/61thanos_sidecar_receiver/#1-1-thanos-sidecar","title":"1-1 Thanos Sidecar \u5de5\u4f5c\u539f\u7406","text":"<p>Thanos Sidecar \u7ec4\u4ef6\u987e\u540d\u601d\u4e49\u662f\u5728 Prometheus \u670d\u52a1\u7684 Pod \u4e2d\u4f5c\u4e3a sidecar \u8fd0\u884c\u7684\uff0c\u65e0\u8bba\u662f\u666e\u901a Prometheus \u8fd8\u662f\u7531 Prometheus Operator \u7ba1\u7406\u7684 Prometheus\uff0c\u90fd\u662f\u5982\u6b64\uff0c\u8be5\u7ec4\u4ef6\u8d1f\u8d23\u5c06\u6570\u636e\uff08\u4ece Prometheus TSDB\uff09\u4f20\u9012\u5230\u5bf9\u8c61\u5b58\u50a8\u4e2d\u3002</p> <p></p> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u4e3a\u4e86\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\uff0c\u591a\u4e2a Prometheus \u5b9e\u4f8b\u4e0e Sidecar \u7ec4\u4ef6\u4e00\u8d77\u8fd0\u884c\uff0c\u8fd9\u4e9b Prometheus \u5b9e\u4f8b\u90fd\u4ece\u76ee\u6807\u4e0a\u72ec\u7acb\u6293\u53d6\u6307\u6807\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6293\u53d6\u7684 TSDB \u5757\u6570\u636e\u5757\u88ab\u5b58\u50a8\u5728 Prometheus \u63d0\u4f9b\u7684\u6301\u4e45\u5316\u5377\u4e2d\u3002</p> <p>\u6b64\u5916 Sidecar \u5728 Prometheus \u7684\u8fdc\u7a0b\u8bfb API \u4e4b\u4e0a\u5b9e\u73b0\u4e86 Thanos \u7684 Store API\uff0c\u4ece\u800c\u53ef\u4ee5\u4ece Thanos Querier \u7ec4\u4ef6\u4e2d\u53bb\u67e5\u8be2 Prometheus \u4e2d\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0c</p> <p>\u6b64\u5916\uff0cSidecar \u8fd8\u53ef\u4ee5\u914d\u7f6e\u4e3a\u6bcf\u9694\u4e24\u5c0f\u65f6\u5c06 TSDB \u5757\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\uff0c\u6bcf\u4e24\u5c0f\u65f6\u521b\u5efa\u4e00\u6b21\u5757\uff0c\u5b58\u50a8\u5728 Bucket \u6876\u4e2d\u7684\u6570\u636e\u53ef\u4ee5\u4f7f\u7528 Thanos Store \u7ec4\u4ef6\u8fdb\u884c\u67e5\u8be2\uff0c\u8fd9\u540c\u6837\u5b9e\u73b0\u4e86 Store API\uff0c\u90fd\u53ef\u4ee5\u88ab Thanos Querier \u53d1\u73b0\u3002</p>"},{"location":"chap11/61thanos_sidecar_receiver/#1-2-thanos-receiver","title":"1-2 Thanos Receiver \u5de5\u4f5c\u539f\u7406","text":"<p>\u4e0e Sidecar \u4e0d\u540c\uff0cReceiver \u662f\u4f5c\u4e3a\u4e00\u4e2a\u5355\u72ec\u7684 StatefulSet \u6765\u8fd0\u884c\u7684\uff0c\u5728\u8fd9\u79cd\u65b9\u6cd5\u4e2d\uff0cThanos \u7684\u6240\u6709\u5176\u4ed6\u7ec4\u4ef6\u90fd\u4ee5\u4e0e Sidecar \u65b9\u5f0f\u76f8\u540c\u7684\u65b9\u5f0f\u5b58\u5728\u548c\u8fd0\u884c\uff0c\u4f46 Receiver \u53d6\u4ee3\u4e86 Sidecar \u7ec4\u4ef6\uff0cTSDB \u7684\u67e5\u8be2\u548c\u4f20\u8f93\u5230\u5bf9\u8c61\u5b58\u50a8\u7684\u65b9\u5f0f\u53d1\u751f\u4e86\u5de8\u5927\u7684\u53d8\u5316</p> <p></p> <p>Receiver \u7ec4\u4ef6\u5b9e\u73b0\u4e86 Prometheus \u7684\u8fdc\u7a0b\u5199 API\uff0c\u76f4\u63a5\u63a5\u6536 Prometheus \u7684\u6570\u636e\uff0cReceiver \u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8 Bucket \u4e2d\u53bb\uff0c\u5e76\u4e14\u4e5f\u6709\u81ea\u5df1\u7684\u4fdd\u7559\u671f\uff0cQuerier \u88ab\u914d\u7f6e\u4e3a\u901a\u8fc7 Store \u67e5\u8be2 Receiver \u548c\u5b58\u50a8\u6876\u4e0a\u7684\u6570\u636e\u3002</p>"},{"location":"chap11/61thanos_sidecar_receiver/#2-sidecar-receiver","title":"2 Sidecar \u548c Receiver \u5bf9\u6bd4","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5728\u9ad8\u53ef\u7528\u6027\u3001\u4e0e Prometheus \u96c6\u6210\u3001\u5b58\u50a8\u548c\u6570\u636e\u91c7\u96c6\u7b49\u65b9\u9762\u6765\u5168\u9762\u6bd4\u8f83\u4e0b Thanos Sidecar \u548c Receiver \u6a21\u5f0f\u7684\u5f02\u540c\u70b9\u3002</p> <p>\u9ad8\u53ef\u7528\u6027</p>"},{"location":"chap11/61thanos_sidecar_receiver/#2-1-sidecar","title":"2-1 Sidecar","text":"<p>\u9ad8\u53ef\u7528\u662f\u901a\u8fc7\u5c06 Sidecar \u5bb9\u5668\u4e0e Prometheus \u5b9e\u4f8b\u7684\u6bcf\u4e2a\u526f\u672c\u96c6\u6210\u5728\u4e00\u8d77\u6765\u5b9e\u73b0\u7684\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u90fd\u5355\u72ec\u7684\u6293\u53d6\u76ee\u6807\uff0cSidecar \u5c06 TSDB \u5757\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u3002</p> <p>Prometheus \u6bcf\u4e24\u5c0f\u65f6\u5199\u4e00\u4e2a TSDB \u5757\uff0c\u8003\u8651\u5230\u6709\u591a\u4e2a Prometheus \u526f\u672c\uff0c\u5176\u4e2d\u4e00\u4e2a\u53d1\u751f\u6545\u969c\uff0c\u6700\u65b0\u7684\u5757\u5c06\u4e22\u5931\uff0c\u5728\u7279\u5b9a\u7684 Prometheus \u5b9e\u4f8b\u7684\u56fe\u8868\u4e2d\u4f1a\u663e\u793a\u4e00\u4e2a\u7a7a\u767d\u51fa\u6765\uff0c\u4f46\u7531\u4e8e\u6709\u4e24\u4e2a\u526f\u672c\uff0c\u8fd9\u4e2a\u7a7a\u767d\u4f1a\u88ab\u53e6\u4e00\u4e2a\u5b9e\u4f8b\u7684\u5757\u6570\u636e\u586b\u8865\uff0cThanos Querier \u7ec4\u4ef6\u8d1f\u8d23\u586b\u8865\u8fd9\u4e9b\u7a7a\u767d\u548c\u91cd\u590d\u7684\u6570\u636e\u53bb\u91cd\u3002</p>"},{"location":"chap11/61thanos_sidecar_receiver/#2-2-receiver","title":"2-2 Receiver","text":"<p>\u4e0e Sidecar \u7c7b\u4f3c\uff0c\u591a\u4e2a Prometheus \u5b9e\u4f8b\u88ab\u90e8\u7f72\u6765\u6293\u53d6\u76f8\u540c\u7684\u76ee\u6807\uff0c\u5e76\u88ab\u914d\u7f6e\u4e3a\u8fdc\u7a0b\u5199\u5165 Receiver StatefulSet\uff0c\u5728\u8fd9\u91cc\uff0c\u4e0d\u4ec5\u662f Prometheus \u526f\u672c\uff0cReceiver \u526f\u672c\u4e5f\u5728 HA \u4e2d\u53d1\u6325\u4e86\u91cd\u8981\u4f5c\u7528\u3002</p> <p>\u9664\u6b64\u4ee5\u5916\uff0cReceiver \u8fd8\u652f\u6301\u591a\u79df\u6237\uff0c\u6bd4\u5982\u8bbe\u7f6e factor=2\uff0c\u8fd9\u5c06\u786e\u4fdd\u4f20\u5165\u7684\u6570\u636e\u5728\u4e24\u4e2a Receiver pod \u4e4b\u95f4\u8fdb\u884c\u590d\u5236\u3002\u5355\u4e2a Prometheus \u5b9e\u4f8b\u7684\u6545\u969c\u7531\u53e6\u4e00\u4e2a\u5b9e\u4f8b\u8986\u76d6\uff0c\u56e0\u4e3a\u4e24\u8005\u90fd\u662f\u8fdc\u7a0b\u5199\u5165Receiver \u7684\uff0c\u7531\u4e8e\u590d\u5236\u7cfb\u6570\u4e3a2\uff0c\u5355\u4e2a Receiver pod \u7684\u6545\u969c\u4f1a\u7531\u5176\u4ed6\u7684\u6765\u8865\u507f\u3002</p> <p>\u4e0e Prometheus \u96c6\u6210</p> <p>Sidecar</p> <p>\u53ea\u9700\u5728 Prometheus \u5b9e\u4f8b pod \u4e2d\u7b80\u5355\u5730\u6dfb\u52a0\u4e00\u4e2a sidecar \u5bb9\u5668\uff0c\u6240\u6709\u5176\u4ed6 Thanos \u7ec4\u4ef6\u5c31\u53ef\u4ee5\u548c\u5b83\u4e00\u8d77\u5de5\u4f5c\u4e86\uff0cSidecar \u53ef\u4ee5\u9009\u62e9\u6bcf\u4e24\u5c0f\u65f6\u5c06\u4e00\u4e2a TSDB \u5757\u5199\u5165\u5bf9\u8c61\u5b58\u50a8\uff0c\u53e6\u5916\u53ea\u9700\u5c06 Sidecar \u4f5c\u4e3a\u670d\u52a1\u66b4\u9732\u7ed9 Thanos Querier \u7ec4\u4ef6\uff0c\u5b58\u50a8\u5728\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u4f1a\u901a\u8fc7 Store \u7ec4\u4ef6\u66b4\u9732\u3002\u56e0\u6b64\uff0c\u96c6\u6210 Sidecar \u975e\u5e38\u7b80\u5355\uff0c\u9002\u7528\u4e8e\u5927\u591a\u6570\u573a\u666f\u3002</p> <p>Receiver</p> <p>Receiver \u6a21\u5f0f\u9700\u8981\u66f4\u6539 Prometheus \u5b9e\u4f8b\u7684\u914d\u7f6e\uff0c\u5c06 TSDB \u8fdc\u7a0b\u5199\u5165 Receiver\uff0c\u540c\u65f6\u90e8\u7f72\u4e00\u4e2a\u989d\u5916\u7684 Receiver StatefulSet\u3002</p> <p>Receiver \u5c06 TSDB \u4fdd\u7559\u5728\u672c\u5730\u5b58\u50a8\u4e2d\uff0c\u8981\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u548c\u6570\u636e\u590d\u5236\u9700\u8981\u8fd0\u884c\u591a\u4e2a Receiver \u5b9e\u4f8b\u4f5c\u4e3a\u54c8\u5e0c\u73af\u7684\u4e00\u90e8\u5206\uff0c\u9700\u8981\u5bf9\u54c8\u5e0c\u73af\u8fdb\u884c\u914d\u7f6e\uff0c\u4f7f HTTP \u8bf7\u6c42\u4e2d\u7684\u79df\u6237 Header \u53ef\u4ee5\u5339\u914d\u4e13\u5c5e\u7684 Receiver \u7aef\u70b9\uff0c\u6574\u5408 Receiver \u662f\u4e00\u9879\u590d\u6742\u800c\u7e41\u7410\u7684\u4efb\u52a1\u3002</p> <p>\u5b58\u50a8</p> <p>Sidecar</p> <p>Sidecar \u4ece Prometheus \u7684\u672c\u5730\u5b58\u50a8\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u56e0\u6b64 TSDB \u4e0d\u9700\u8981\u989d\u5916\u7684\u672c\u5730\u5b58\u50a8\u3002</p> <p>\u6b64\u5916\uff0c\u5b83\u8fd8\u53ef\u4ee5\u5927\u5927\u51cf\u5c11 TSDB \u5728 Prometheus \u672c\u5730\u5b58\u50a8\u4e2d\u7684\u4fdd\u7559\u65f6\u95f4\uff0c\u56e0\u4e3a\u5b83\u6bcf\u4e24\u5c0f\u65f6\u4e0a\u4f20\u4e00\u6b21\uff0c\u540c\u65f6\u5b83\u4eec\u7684\u5386\u53f2\u6570\u636e\u901a\u8fc7\u5bf9\u8c61\u5b58\u50a8\u53d8\u5f97\u6301\u4e45\u548c\u53ef\u67e5\u8be2\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cPrometheus \u5b58\u50a8\u7684\u6570\u636e\u4e3a15\u5929\uff0c\u5728\u76d1\u63a7\u4e00\u4e2a\u5927\u89c4\u6a21\u751f\u4ea7\u96c6\u7fa4\u7684\u60c5\u51b5\u4e0b\uff0c\u5b83\u9700\u8981\u76f8\u5f53\u5927\u7684\u672c\u5730\u5b58\u50a8\uff0c\u800c\u4e14\u672c\u5730\u5b58\u50a8\u6bd4\u5bf9\u8c61\u5b58\u50a8\u8981\u6602\u8d35\u5f97\u591a\u3002\u7531\u4e8e Sidecar \u6bcf2\u5c0f\u65f6\u5c06 Prometheus \u7684\u6307\u6807\u5bfc\u51fa\u5230\u5b58\u50a8\u6876\u4e2d\uff0c\u5b83\u4f7f Prometheus \u66f4\u63a5\u8fd1\u4e8e\u65e0\u72b6\u6001\u3002\u867d\u7136\u5728 Thanos \u6587\u6863\u4e2d\uff0c\u5efa\u8bae Prometheus \u7684\u4fdd\u7559\u65f6\u95f4\u4e0d\u8981\u4f4e\u4e8e\u6700\u5c0f\u5757\u6301\u7eed\u65f6\u95f4\u76843\u500d\uff0c\u6240\u4ee5\u5b83\u53d8\u6210\u4e866\u5c0f\u65f6\u3002</p> <p>Receiver</p> <p>Receiver \u662f\u4e00\u4e2a StatefulSet\uff0c\u9700\u8981\u4f7f\u7528 PV\uff0c\u9700\u8981\u7684\u672c\u5730\u5b58\u50a8\u5bb9\u91cf\u53d6\u51b3\u4e8e <code>--receive.replication-factor</code>\u3001<code>--tsdb.retention</code> \u8fd9\u4e24\u4e2a\u53c2\u6570\u4ee5\u53capod \u526f\u672c\u6570\uff0cTSDB \u4fdd\u7559\u8d8a\u9ad8\uff0c\u5f53\u7136\u5c31\u4f1a\u4f7f\u7528\u66f4\u591a\u7684\u672c\u5730\u5b58\u50a8\uff0c\u7531\u4e8e\u6570\u636e\u88ab\u6301\u7eed\u5199\u5165 Receiver\uff0c\u56e0\u6b64 Prometheus \u672c\u5730\u7684\u6570\u636e\u4fdd\u7559\u53ef\u4ee5\u4fdd\u6301\u5728\u6700\u5c0f\u503c\u3002\u4e0e Sidecar \u76f8\u6bd4\uff0c\u8fd9\u79cd\u65b9\u6848\u9700\u8981\u66f4\u591a\u7684\u672c\u5730\u5b58\u50a8\u3002</p> <p>\u6570\u636e\u91c7\u96c6</p> <p>Sidecar</p> <p>\u5728\u8fd9\u91cc\uff0cTSDB \u5757\u662f\u4ece Prometheus \u5b9e\u4f8b\u7684\u672c\u5730\u5b58\u50a8\u4e2d\u8bfb\u53d6\u7684\uff0c\u8981\u4e48\u63d0\u4f9b\u7ed9 Querier \u8fdb\u884c\u67e5\u8be2\uff0c\u8981\u4e48\u5bfc\u51fa\u5230\u5bf9\u8c61\u5b58\u50a8\u4e2d\u3002Sidecar \u4ee5 pull \u7684\u6a21\u5f0f\u4e0a\u8fd0\u884c\uff08Thanos Querier \u5728\u67e5\u8be2\u65f6\u4ece Prometheus \u62c9\u53d6\u5e8f\u5217\u6570\u636e\uff09\uff0c\u6570\u636e\u4e0d\u4f1a\u4e0d\u65ad\u5730\u5199\u5165\u5176\u4ed6\u5b9e\u4f8b\u4e2d\u3002</p> <p>Receiver</p> <p>Receiver \u5219\u662f\u57fa\u4e8e push \u7684\u6a21\u5f0f\uff0cTSDB \u7531 Prometheus \u5b9e\u4f8b\u672c\u8eab\u8fdc\u7a0b\u5199\u5165\u5230 Receiver\uff0c\u4ece\u800c\u4f7f Prometheus \u6700\u63a5\u8fd1\u65e0\u72b6\u6001\u3002\u7136\u540e\u6570\u636e\u4ece Receiver \u8fdb\u4e00\u6b65\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u3002</p>"},{"location":"chap11/61thanos_sidecar_receiver/#3","title":"3 \u7ed3\u8bba","text":"<p>\u9009\u62e9\u54ea\u79cd\u65b9\u6848\u5b8c\u5168\u53d6\u51b3\u4e8e\u8981\u5b9e\u73b0\u7684 Prometheus HA \u548c\u591a\u79df\u6237\u7684\u73af\u5883\u3002\u5728\u9700\u8981\u4e3a\u5355\u4e2a\u96c6\u7fa4\u5b9e\u73b0 Prometheus HA \u6216\u4f7f\u7528 Prometheus Operator \u8fdb\u884c\u7279\u5b9a\u5e94\u7528\u7a0b\u5e8f\u76d1\u63a7\u7684\u60c5\u51b5\u4e0b\uff0cSidecar \u4f3c\u4e4e\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9009\u62e9\uff0c\u56e0\u4e3a\u5b83\u6613\u4e8e\u64cd\u4f5c\u548c\u96c6\u6210\u8f7b\u91cf\u3002Sidecar \u4e5f\u53ef\u4ee5\u901a\u8fc7\u5206\u5c42\u7684 Thanos Querier \u65b9\u6cd5\u7528\u4e8e\u591a\u79df\u6237\u3002</p> <p>\u800c\u5982\u679c\u9700\u8981\u5bf9\u591a\u79df\u6237\u8fdb\u884c\u66f4\u96c6\u4e2d\u7684\u67e5\u770b\uff0c\u6216\u8005\u5728\u53ea\u6709\u51fa\u6d41\u91cf\u7684\u7f51\u7edc\u73af\u5883\u4e2d\uff0c\u5219\u53ef\u4ee5\u5728\u8003\u8651\u63a8\u9001\u6307\u6807\u65b9\u5f0f\u540e\u4f7f\u7528 Receiver\uff0c\u4e0d\u5efa\u8bae\u901a\u8fc7 Receiver \u5b9e\u73b0\u5355\u79df\u6237\u7684\u5168\u5c40\u89c6\u56fe\u3002\u5f53\u8bd5\u56fe\u5b9e\u73b0\u5177\u6709\u4e0d\u540c\u73af\u5883\u9650\u5236\u7684\u591a\u4e2a\u79df\u6237\u7684\u5168\u5c40\u89c6\u56fe\u65f6\uff0c\u53ef\u4ee5\u91c7\u7528\u540c\u65f6\u4f7f\u7528 Sidecar \u548c Receiver \u7684\u6df7\u5408\u65b9\u6cd5</p>"},{"location":"chap11/62thanos_query/","title":"\u7b2c\u4e94\u8282\uff082022\uff09\u4f7f\u7528Thanos\u67e5\u8be2\u524d\u7aef\u4f18\u5316\u67e5\u8be2\u6027\u80fd","text":"<p>Thanos \u4e2d\u7684 Query \u7ec4\u4ef6\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u7edf\u4e00\u7684\u67e5\u8be2\u5165\u53e3\uff0c\u4f46\u662f\u5f53\u67e5\u8be2\u7684\u6570\u636e\u89c4\u6a21\u8f83\u5927\u7684\u65f6\u5019\uff0c\u5bf9 querier \u7ec4\u4ef6\u4e5f\u4f1a\u6709\u5f88\u5927\u7684\u538b\u529b\uff0c\u4e3a\u6b64 Thanos \u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a <code>Query Frontend</code> \u7684\u7ec4\u4ef6\u6765\u63d0\u5347\u6027\u80fd\u3002</p> <p>Thanos Query Frontend \u662f Thanos Query \u7684\u524d\u7aef\uff0c\u5b83\u7684\u76ee\u6807\u662f\u5c06\u5927\u578b\u67e5\u8be2\u62c6\u5206\u4e3a\u591a\u4e2a\u8f83\u5c0f\u7684\u67e5\u8be2\uff0c\u5e76\u7f13\u5b58\u67e5\u8be2\u7ed3\u679c\u6765\u63d0\u5347\u6027\u80fd\u3002</p>"},{"location":"chap11/62thanos_query/#1","title":"1 \u6982\u8ff0","text":"<p><code>Thanos Query Frontend</code> \u7ec4\u4ef6\u901a\u8fc7 <code>thanos query-frontend</code> \u547d\u4ee4\u5b9e\u73b0\u4e86\u4e00\u4e2a\u653e\u5728 <code>querier</code> \u524d\u9762\u7684\u670d\u52a1\uff0c\u4ee5\u6539\u8fdb\u8bfb\u53d6\u8def\u5f84\u3002</p> <p>\u5b83\u57fa\u4e8e <code>Cortex Query Frontend</code> \u7ec4\u4ef6\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u627e\u5230\u4e00\u4e9b <code>Cortex</code> \u5e38\u89c1\u7684\u7279\u6027\uff0c\u5982\u67e5\u8be2\u62c6\u5206\u548c\u7ed3\u679c\u7f13\u5b58\u3002</p> <p>Thanos Query Frontend \u662f\u65e0\u72b6\u6001\u548c\u6c34\u5e73\u6269\u5c55\u7684\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u6765\u542f\u52a8 Thanos Query Frontend\uff1a</p> <pre><code>thanos query-frontend \\\n    --http-address     \"0.0.0.0:9090\" \\\n    --query-frontend.downstream-url=\"&lt;thanos-querier&gt;:&lt;querier-http-port&gt;\"\n</code></pre> <p>\u5728\u63a5\u6536\u5230\u67e5\u8be2\u8bf7\u6c42\u540e query frontend \u4e0d\u4f1a\u7acb\u5373\u54cd\u5e94\uff0c\u800c\u662f\u5c06\u67e5\u8be2\u8bf7\u6c42\u653e\u5165\u4e00\u4e2a\u67e5\u8be2\u961f\u5217\u4e2d\uff0cquerier \u4f1a\u8fde\u63a5\u5230 query frontend \u5e76\u6d88\u8d39\u8fd9\u4e2a\u961f\u5217\uff0c\u6267\u884c\u4ece\u961f\u5217\u4e2d\u83b7\u53d6\u7684\u67e5\u8be2\u8bf7\u6c42\u5e76\u54cd\u5e94\u7ed9 query frontend\uff0cquery frontend \u4f1a\u5bf9\u8fd9\u4e9b\u54cd\u5e94\u7684\u7ed3\u679c\u8fdb\u884c\u805a\u5408\u3002</p>"},{"location":"chap11/62thanos_query/#2","title":"2 \u7279\u6027","text":""},{"location":"chap11/62thanos_query/#2-1","title":"2-1 \u67e5\u8be2\u961f\u5217","text":"<p>query frontend \u7684\u961f\u5217\u673a\u5236\u6709\u4ee5\u4e0b\u7528\u9014\u3002</p> <ul> <li>\u786e\u4fdd\u53ef\u80fd\u5bfc\u81f4 OOM \u7684\u5927\u578b\u67e5\u8be2\u5728\u53d1\u751f\u9519\u8bef\u65f6\u80fd\u591f\u5f97\u5230\u91cd\u8bd5\u3002</li> <li>\u9632\u6b62\u591a\u4e2a\u5927\u7684\u67e5\u8be2\u8bf7\u6c42\u6253\u5728\u5355\u4e2a querier \u4e0a\u3002</li> <li>\u53ef\u4ee5\u5206\u914d\u79df\u6237\u6240\u5bf9\u5e94\u7684 querier\uff0c\u907f\u514d\u5355\u4e2a\u79df\u6237\u4f7f\u7528 DOS \u62d2\u7edd\u670d\u52a1\u653b\u51fb\u5176\u4ed6\u79df\u6237\u3002</li> </ul>"},{"location":"chap11/62thanos_query/#2-2","title":"2-2 \u67e5\u8be2\u62c6\u5206","text":"<p><code>query frontend</code> \u4f1a\u5c06\u591a\u5929\u7684\u7684\u67e5\u8be2\u62c6\u5206\u4e3a\u591a\u4e2a\u5355\u5929\u7684\u67e5\u8be2\uff0c\u6e38\u4e0b\u6e38\u7684 <code>querier</code> \u53bb\u5e76\u884c\u5904\u7406\u8fd9\u4e9b\u5df2\u62c6\u5206\u7684\u67e5\u8be2\u3002</p> <p>\u8fd4\u56de\u7684\u67e5\u8be2\u7ed3\u679c\u7531 <code>query frontend</code> \u8fdb\u884c\u6c47\u805a\u3002\u8fd9\u6837\u53ef\u4ee5\u9632\u6b62\u5927\u65f6\u95f4\u8de8\u5ea6\u7684\u67e5\u8be2\u5bfc\u81f4 queier \u53d1\u751f OOM\uff0c\u5e76\u4e14\u80fd\u591f\u66f4\u5feb\u7684\u6267\u884c\u67e5\u8be2\u4ee5\u53ca\u66f4\u597d\u7684\u67e5\u8be2\u8d1f\u8f7d\u5747\u8861\u3002</p> <p>\u67e5\u8be2\u524d\u7aef\u6839\u636e\u914d\u7f6e\u7684 <code>--query-range.split-interval</code> \u6807\u5fd7\u5c06\u957f\u67e5\u8be2\u62c6\u5206\u4e3a\u591a\u4e2a\u77ed\u67e5\u8be2\uff0c<code>--query-range.split-interva</code>l \u7684\u9ed8\u8ba4\u503c\u4e3a 24 \u5c0f\u65f6\uff0c\u542f\u7528\u7f13\u5b58\u65f6\uff0c\u5b83\u5e94\u8be5\u5927\u4e8e 0\u3002</p>"},{"location":"chap11/62thanos_query/#2-3","title":"2-3 \u91cd\u8bd5\u673a\u5236","text":"<p>query frontend \u652f\u6301\u5728 HTTP \u8bf7\u6c42\u5931\u8d25\u65f6\u91cd\u8bd5\u67e5\u8be2\u7684\u91cd\u8bd5\u673a\u5236\uff0c\u6709\u4e00\u4e2a <code>--query-range.max-retries-per-request</code> \u6807\u5fd7\u6765\u9650\u5236\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u3002</p>"},{"location":"chap11/62thanos_query/#2-4","title":"2-4 \u67e5\u8be2\u7f13\u5b58","text":"<p><code>query frontend</code> \u652f\u6301\u5c06\u67e5\u8be2\u7ed3\u679c\u8fdb\u884c\u7f13\u5b58\u7528\u4ee5\u52a0\u901f\u540e\u7eed\u7684\u67e5\u8be2\u3002</p> <p>\u5f53\u7f13\u5b58\u7684\u7ed3\u679c\u4e0d\u591f\u5b8c\u6574\u65f6\uff0c<code>query frontend</code> \u4f1a\u8ba1\u7b97\u51fa\u6240\u9700\u8981\u7684\u5b50\u67e5\u8be2\u5e76\u5206\u914d\u7ed9\u4e0b\u6e38\u7684 <code>querier</code> \u5e76\u884c\u6267\u884c\uff0c\u5b50\u67e5\u8be2\u7684\u6b65\u957f\u4f1a\u5bf9\u9f50\u4ee5\u63d0\u5347\u67e5\u8be2\u7ed3\u679c\u7684\u53ef\u7f13\u5b58\u6027\u3002\u5f53\u524d\u652f\u6301\u7684\u7f13\u5b58\u540e\u7aef\u6709\uff1a<code>memcached</code>\uff0c<code>redis</code> \u548c\u5185\u5b58\uff0c\u4e0b\u9762\u662f\u8fd9\u4e9b\u7f13\u5b58\u540e\u7aef\u7684\u4e00\u4e9b\u914d\u7f6e\u3002</p> <p>\u5185\u5b58\u7f13\u5b58</p> <pre><code>type: IN-MEMORY\nconfig:\n  max_size: \"\"\n  max_size_items: 0\n  validity: 0s\n</code></pre> <p><code>max_size</code>\u8868\u793a\u5728\u5185\u5b58\u4e2d\u7f13\u5b58\u7684\u6700\u5927\u5c3a\u5bf8\uff0c\u5355\u4f4d\u53ef\u4ee5\u662f KB\u3001MB\u3001GB\u3002\u5982\u679c max_size \u548c <code>max_size_items</code> \u90fd\u6ca1\u6709\u8bbe\u7f6e\uff0c\u5c31\u4e0d\u4f1a\u521b\u5efa\u7f13\u5b58\u3002\u5982\u679c\u53ea\u8bbe\u7f6e <code>max_size</code> \u6216 <code>max_size_items</code> \u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\uff0c\u5219\u5bf9\u5176\u4ed6\u5b57\u6bb5\u6ca1\u6709\u9650\u5236\u3002</p> <p>memcached</p> <pre><code>type: MEMCACHED\nconfig:\n  addresses: [your-memcached-addresses]\n  timeout: 500ms\n  max_idle_connections: 100\n  max_item_size: 1MiB\n  max_async_concurrency: 10\n  max_async_buffer_size: 10000\n  max_get_multi_concurrency: 100\n  max_get_multi_batch_size: 0\n  dns_provider_update_interval: 10s\n  expiration: 24h\n</code></pre> <p>expiration \u8868\u793a\u6307\u5b9a memcached \u7f13\u5b58\u6709\u6548\u65f6\u95f4\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a 0\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684 24 \u5c0f\u65f6\u8fc7\u671f\u65f6\u95f4\uff0c\u4e0a\u9762\u7684\u914d\u7f6e\u662f\u9ed8\u8ba4\u7684 memcached \u914d\u7f6e\u3002</p> <p>Redis</p> <pre><code>type: REDIS\nconfig:\n  addr: \"\"\n  username: \"\"\n  password: \"\"\n  db: 0\n  dial_timeout: 5s\n  read_timeout: 3s\n  write_timeout: 3s\n  pool_size: 100\n  min_idle_conns: 10\n  idle_timeout: 5m0s\n  max_conn_age: 0s\n  max_get_multi_concurrency: 100\n  get_multi_batch_size: 100\n  max_set_multi_concurrency: 100\n  set_multi_batch_size: 100\n  expiration: 24h0m0s\n</code></pre> <p>expiration \u8868\u793a\u6307\u5b9a Redis \u7f13\u5b58\u6709\u6548\u65f6\u95f4\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a 0\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684 24 \u5c0f\u65f6\u8fc7\u671f\u65f6\u95f4\u3002</p>"},{"location":"chap11/62thanos_query/#2-5","title":"2-5 \u6162\u67e5\u8be2\u65e5\u5fd7","text":"<p>query frontend \u8fd8\u652f\u6301\u901a\u8fc7\u914d\u7f6e <code>--query-frontend.log-queries-longer-than</code> \u6807\u5fd7\u6765\u8bb0\u5f55\u8fd0\u884c\u65f6\u95f4\u8d85\u8fc7\u67d0\u4e2a\u6301\u7eed\u65f6\u95f4\u7684\u67e5\u8be2\u3002</p> <p>\u5b89\u88c5</p> <p>\u5b89\u88c5 query frontend \u6700\u91cd\u8981\u7684\u5c31\u662f\u901a\u8fc7 <code>-query-frontend.downstream-url</code> \u6307\u5b9a\u4e0b\u6e38\u7684 querier\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># thanos-query-frontend.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: thanos-query-frontend\n  namespace: kube-mon\n  labels:\n    app: thanos-query-frontend\nspec:\n  selector:\n    matchLabels:\n      app: thanos-query-frontend\n  template:\n    metadata:\n      labels:\n        app: thanos-query-frontend\n    spec:\n      containers:\n        - name: thanos\n          image: thanosio/thanos:v0.25.1\n          imagePullPolicy: IfNotPresent\n          ports:\n            - containerPort: 9090\n              name: http\n          args:\n            - query-frontend\n            - --log.level=info\n            - --log.format=logfmt\n            - --query-frontend.compress-responses\n            - --http-address=0.0.0.0:9090\n            - --query-frontend.downstream-url=http://thanos-querier.kube-mon.svc.cluster.local:9090\n            - --query-range.split-interval=12h\n            - --query-range.max-retries-per-request=10\n            - --query-frontend.log-queries-longer-than=10s\n            - --labels.split-interval=12h\n            - --labels.max-retries-per-request=10\n            - |-\n              --query-range.response-cache-config=\"config\":\n                max_size: \"200MB\"\n                max_size_items: 0\n                validity: 0s\n              type: IN-MEMORY\n            - |-\n              --labels.response-cache-config=\"config\":\n                max_size: \"200MB\"\n                max_size_items: 0\n                validity: 0s\n              type: IN-MEMORY\n          env:\n            - name: HOST_IP_ADDRESS\n              valueFrom:\n                fieldRef:\n                  fieldPath: status.hostIP\n          livenessProbe:\n            failureThreshold: 4\n            httpGet:\n              path: /-/healthy\n              port: 9090\n              scheme: HTTP\n            periodSeconds: 30\n          readinessProbe:\n            failureThreshold: 20\n            httpGet:\n              path: /-/ready\n              port: 9090\n              scheme: HTTP\n            periodSeconds: 5\n          resources:\n            requests:\n              memory: 512Mi\n              cpu: 500m\n            limits:\n              memory: 512Mi\n              cpu: 500m\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-query-frontend\n  namespace: kube-mon\n  labels:\n    app: thanos-query-frontend\nspec:\n  ports:\n    - name: http\n      port: 9090\n      targetPort: 9090\n  selector:\n    app: thanos-query-frontend\n  type: NodePort\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5f00\u542f\u4e86\u7f13\u5b58\uff0c\u4f7f\u7528\u5185\u5b58\u7f13\u5b58\uff0c\u76f4\u63a5\u901a\u8fc7 <code>-query-range.response-cache-config</code> \u53c2\u6570\u6765\u914d\u7f6e\u7f13\u5b58\u914d\u7f6e\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>-query-range.response-cache-config-file</code>\u6307\u5b9a\u7f13\u5b58\u914d\u7f6e\u6587\u4ef6\uff0c\u4e24\u79cd\u65b9\u5f0f\u5747\u53ef\uff0c\u4e3a\u4e86\u9a8c\u8bc1\u7ed3\u679c\uff0c\u8fd9\u91cc\u521b\u5efa\u4e86\u4e00\u4e2a NodePort \u7c7b\u578b\u7684 Service\uff0c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>\n\u2638 \u279c kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-query-frontend.yaml\n\u2638 \u279c kubectl get pods -n kube-mon -l app=thanos-query-frontend\nNAME                                     READY   STATUS    RESTARTS   AGE\nthanos-query-frontend-78954bc857-nkxkk   1/1     Running   0          151m\n\u2638 \u279c kubectl get svc -n kube-mon -l app=thanos-query-frontend\nNAME                    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\nthanos-query-frontend   NodePort   10.97.182.150   &lt;none&gt;        9090:30514/TCP   152m\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u901a\u8fc7\u4efb\u610f\u8282\u70b9\u7684 30514 \u7aef\u53e3\u8bbf\u95ee\u5230\u67e5\u8be2\u524d\u7aef\uff1a</p> <p>\u8be5\u524d\u7aef\u9875\u9762\u548c Query \u7ec4\u4ef6\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u662f\u5728 Query \u524d\u9762\u7f13\u5b58\u5305\u88c5\u4e86\u4e00\u5c42\u3002</p> <p></p>"},{"location":"chap11/63prometheus_optimiztion/","title":"\u7b2c\u516d\u8282 (Thaos1-2022)\u5927\u89c4\u6a21\u573a\u666f\u4e0bPrometheus\u7684\u4f18\u5316\u624b\u6bb5","text":""},{"location":"chap11/63prometheus_optimiztion/#1","title":"1 \u6982\u8ff0","text":"<p>Prometheus \u51e0\u4e4e\u5df2\u6210\u4e3a\u76d1\u63a7\u9886\u57df\u7684\u4e8b\u5b9e\u6807\u51c6\uff0c\u5b83\u81ea\u5e26\u9ad8\u6548\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u5b58\u50a8\uff0c\u53ef\u4ee5\u8ba9\u5355\u53f0 Prometheus \u80fd\u591f\u9ad8\u6548\u7684\u5904\u7406\u5927\u91cf\u7684\u6570\u636e\uff0c\u8fd8\u6709\u53cb\u597d\u5e76\u4e14\u5f3a\u5927\u7684 PromQL \u8bed\u6cd5\uff0c\u53ef\u4ee5\u7528\u6765\u7075\u6d3b\u7684\u67e5\u8be2\u5404\u79cd\u76d1\u63a7\u6570\u636e\u4ee5\u53ca\u914d\u7f6e\u544a\u8b66\u89c4\u5219\uff0c\u540c\u65f6\u5b83\u7684 pull \u6a21\u578b\u6307\u6807\u91c7\u96c6\u65b9\u5f0f\u88ab\u5e7f\u6cdb\u91c7\u7eb3\uff0c\u975e\u5e38\u591a\u7684\u5e94\u7528\u90fd\u5b9e\u73b0\u4e86 Prometheus \u7684 metrics \u63a5\u53e3\u4ee5\u66b4\u9732\u81ea\u8eab\u5404\u9879\u6570\u636e\u6307\u6807\u8ba9 Prometheus \u53bb\u91c7\u96c6\uff0c\u5f88\u591a\u6ca1\u6709\u9002\u914d\u7684\u5e94\u7528\u4e5f\u4f1a\u6709\u7b2c\u4e09\u65b9 exporter \u5e2e\u5b83\u53bb\u9002\u914d Prometheus\uff0c\u6240\u4ee5\u76d1\u63a7\u7cfb\u7edf\u6211\u4eec\u901a\u5e38\u9996\u9009\u7528 Prometheus\uff0c\u672c\u7cfb\u5217\u6587\u7ae0\u4e5f\u5c06\u57fa\u4e8e Prometheus \u6765\u6253\u9020\u4e91\u539f\u751f\u73af\u5883\u4e0b\u7684\u5927\u578b\u5206\u5e03\u5f0f\u76d1\u63a7\u7cfb\u7edf\u3002</p>"},{"location":"chap11/63prometheus_optimiztion/#2-prometheus","title":"2 \u5927\u89c4\u6a21\u573a\u666f\u4e0b Prometheus \u7684\u75db\u70b9","text":"<p>Prometheus \u672c\u8eab\u53ea\u652f\u6301\u5355\u673a\u90e8\u7f72\uff0c\u6ca1\u6709\u81ea\u5e26\u652f\u6301\u96c6\u7fa4\u90e8\u7f72\uff0c\u4e5f\u5c31\u4e0d\u652f\u6301\u9ad8\u53ef\u7528\u4ee5\u53ca\u6c34\u5e73\u6269\u5bb9\uff0c\u5728\u5927\u89c4\u6a21\u573a\u666f\u4e0b\uff0c\u6700\u8ba9\u4eba\u5173\u5fc3\u7684\u95ee\u9898\u662f\u5b83\u7684\u5b58\u50a8\u7a7a\u95f4\u4e5f\u53d7\u9650\u4e8e\u5355\u673a\u78c1\u76d8\u5bb9\u91cf\uff0c\u78c1\u76d8\u5bb9\u91cf\u51b3\u5b9a\u4e86\u5355\u4e2a Prometheus \u6240\u80fd\u5b58\u50a8\u7684\u6570\u636e\u91cf\uff0c\u6570\u636e\u91cf\u5927\u5c0f\u53c8\u53d6\u51b3\u4e8e\u88ab\u91c7\u96c6\u670d\u52a1\u7684\u6307\u6807\u6570\u91cf\u3001\u670d\u52a1\u6570\u91cf\u3001\u91c7\u96c6\u901f\u7387\u4ee5\u53ca\u6570\u636e\u8fc7\u671f\u65f6\u95f4\u3002</p> <p>\u5728\u6570\u636e\u91cf\u5927\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u80fd\u5c31\u9700\u8981\u505a\u5f88\u591a\u53d6\u820d\uff0c\u6bd4\u5982\u4e22\u5f03\u4e0d\u91cd\u8981\u7684\u6307\u6807\u3001\u964d\u4f4e\u91c7\u96c6\u901f\u7387\u3001\u8bbe\u7f6e\u8f83\u77ed\u7684\u6570\u636e\u8fc7\u671f\u65f6\u95f4(\u9ed8\u8ba4\u53ea\u4fdd\u755915\u5929\u7684\u6570\u636e\uff0c\u770b\u4e0d\u5230\u6bd4\u8f83\u4e45\u8fdc\u7684\u76d1\u63a7\u6570\u636e)\u3002</p> <p>\u8fd9\u4e9b\u75db\u70b9\u5b9e\u9645\u4e5f\u662f\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e9b\u4f18\u5316\u624b\u6bb5\u6765\u6539\u5584\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u7ec6\u8bb2\u4e00\u4e0b\u3002</p>"},{"location":"chap11/63prometheus_optimiztion/#3-prometheus","title":"3 \u4ece\u670d\u52a1\u7ef4\u5ea6\u62c6\u5206 Prometheus","text":"<p>Prometheus \u4e3b\u5f20\u6839\u636e\u529f\u80fd\u6216\u670d\u52a1\u7ef4\u5ea6\u8fdb\u884c\u62c6\u5206\uff0c\u5373\u5982\u679c\u8981\u91c7\u96c6\u7684\u670d\u52a1\u6bd4\u8f83\u591a\uff0c\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u5c31\u914d\u7f6e\u6210\u4ec5\u91c7\u96c6\u548c\u5b58\u50a8\u67d0\u4e00\u4e2a\u6216\u67d0\u4e00\u90e8\u5206\u670d\u52a1\u7684\u6307\u6807\uff0c\u8fd9\u6837\u6839\u636e\u8981\u91c7\u96c6\u7684\u670d\u52a1\u5c06 Prometheus \u62c6\u5206\u6210\u591a\u4e2a\u5b9e\u4f8b\u5206\u522b\u53bb\u91c7\u96c6\uff0c\u4e5f\u80fd\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u8fbe\u5230\u6c34\u5e73\u6269\u5bb9\u7684\u76ee\u7684\u3002</p> <p></p> <p>\u901a\u5e38\u8fd9\u6837\u7684\u6269\u5bb9\u65b9\u5f0f\u5df2\u7ecf\u80fd\u6ee1\u8db3\u5927\u90e8\u5206\u573a\u666f\u7684\u9700\u6c42\u4e86\uff0c\u6bd5\u7adf\u5355\u673a Prometheus \u5c31\u80fd\u91c7\u96c6\u548c\u5904\u7406\u5f88\u591a\u6570\u636e\u4e86\uff0c\u5f88\u5c11\u6709 Prometheus \u6491\u4e0d\u4f4f\u5355\u4e2a\u670d\u52a1\u7684\u573a\u666f\u3002\u4e0d\u8fc7\u5728\u8d85\u5927\u89c4\u6a21\u96c6\u7fa4\u4e0b\uff0c\u6709\u4e9b\u5355\u4e2a\u670d\u52a1\u7684\u4f53\u91cf\u4e5f\u5f88\u5927\uff0c\u5c31\u9700\u8981\u8fdb\u4e00\u6b65\u62c6\u5206\u4e86\uff0c\u6211\u4eec\u4e0b\u9762\u6765\u7ee7\u7eed\u8bb2\u4e0b\u5982\u4f55\u518d\u62c6\u5206\u3002</p>"},{"location":"chap11/63prometheus_optimiztion/#4","title":"4 \u5bf9\u8d85\u5927\u89c4\u6a21\u7684\u670d\u52a1\u505a\u5206\u7247","text":"<p>\u60f3\u8c61\u4e00\u4e0b\uff0c\u5982\u679c\u96c6\u7fa4\u8282\u70b9\u6570\u91cf\u8fbe\u5230\u4e0a\u5343\u751a\u81f3\u51e0\u5343\u7684\u89c4\u6a21\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u8282\u70b9\u7ea7\u670d\u52a1\u66b4\u9732\u7684\u6307\u6807\uff0c\u6bd4\u5982 kubelet \u5185\u7f6e\u7684 cadvisor \u66b4\u9732\u7684\u5bb9\u5668\u76f8\u5173\u7684\u6307\u6807\uff0c\u53c8\u6216\u8005\u90e8\u7f72\u7684 <code>DeamonSet node-exporter</code> \u66b4\u9732\u7684\u8282\u70b9\u76f8\u5173\u7684\u6307\u6807\uff0c\u5728\u96c6\u7fa4\u89c4\u6a21\u5927\u7684\u60c5\u51b5\u4e0b\uff0c\u5b83\u4eec\u8fd9\u79cd\u5355\u4e2a\u670d\u52a1\u80cc\u540e\u7684\u6307\u6807\u6570\u636e\u4f53\u91cf\u5c31\u975e\u5e38\u5927\uff1b</p> <p>\u8fd8\u6709\u4e00\u4e9b\u7528\u6237\u91cf\u8d85\u5927\u7684\u4e1a\u52a1\uff0c\u5355\u4e2a\u670d\u52a1\u7684 pod \u526f\u672c\u6570\u5c31\u53ef\u80fd\u8fc7\u5343\uff0c\u8fd9\u79cd\u670d\u52a1\u80cc\u540e\u7684\u6307\u6807\u6570\u636e\u4e5f\u975e\u5e38\u5927\uff0c\u5f53\u7136\u8fd9\u662f\u6700\u7f55\u89c1\u7684\u573a\u666f\uff0c\u5bf9\u4e8e\u7edd\u5927\u591a\u6570\u7684\u4eba\u6765\u8bf4\u8fd9\u79cd\u573a\u666f\u90fd\u53ea\u6562 YY \u4e00\u4e0b\uff0c\u5b9e\u9645\u5f88\u5c11\u6709\u5355\u4e2a\u670d\u52a1\u5c31\u8fbe\u5230\u8fd9\u4e48\u5927\u89c4\u6a21\u7684\u4e1a\u52a1\u3002</p> <p>\u90a3\u4e48\u5982\u4f55\u4f18\u5316\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u7ed9\u8fd9\u79cd\u5927\u89c4\u6a21\u7c7b\u578b\u7684\u670d\u52a1\u505a\u4e00\u4e0b\u5206\u7247(Sharding)\uff0c\u5c06\u5176\u62c6\u5206\u6210\u591a\u4e2a group\uff0c\u8ba9\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u4ec5\u91c7\u96c6\u8fd9\u4e2a\u670d\u52a1\u80cc\u540e\u7684\u67d0\u4e00\u4e2a group \u7684\u6570\u636e\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5c06\u8fd9\u4e2a\u5927\u4f53\u91cf\u670d\u52a1\u7684\u76d1\u63a7\u6570\u636e\u62c6\u5206\u5230\u591a\u4e2a Prometheus \u5b9e\u4f8b\u4e0a\u3002</p> <p></p> <p>\u5982\u4f55\u5c06\u4e00\u4e2a\u670d\u52a1\u62c6\u6210\u591a\u4e2a group \u5462\uff1f\u4e0b\u9762\u4ecb\u7ecd\u4e24\u79cd\u65b9\u6848\uff0c\u4ee5\u5bf9 kubelet cadvisor \u6570\u636e\u505a\u5206\u7247\u4e3a\u4f8b\u3002</p> <p>\u7b2c\u4e00\uff0c\u6211\u4eec\u53ef\u4ee5\u4e0d\u7528 Kubernetes \u7684\u670d\u52a1\u53d1\u73b0\uff0c\u81ea\u884c\u5b9e\u73b0\u4e00\u4e0b sharding \u7b97\u6cd5\uff0c\u6bd4\u5982\u9488\u5bf9\u8282\u70b9\u7ea7\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u5c06\u67d0\u4e2a\u8282\u70b9 shard \u5230\u67d0\u4e2a group \u91cc\uff0c\u7136\u540e\u518d\u5c06\u5176\u6ce8\u518c\u5230 Prometheus \u6240\u652f\u6301\u7684\u670d\u52a1\u53d1\u73b0\u6ce8\u518c\u4e2d\u5fc3\uff0c\u63a8\u8350 <code>consul</code>\uff0c\u6700\u540e\u5728 Prometheus \u914d\u7f6e\u6587\u4ef6\u52a0\u4e0a <code>consul_sd_config</code> \u7684\u914d\u7f6e\uff0c\u6307\u5b9a\u6bcf\u4e2a Prometheus \u5b9e\u4f8b\u8981\u91c7\u96c6\u7684 group\u3002</p> <pre><code> - job_name: 'cadvisor-1'\n    consul_sd_configs:\n      - server: 10.0.0.3:8500\n        services:\n          - cadvisor-1 # This is the 2nd slave\n</code></pre> <p>\u5728\u672a\u6765\uff0c\u4f60\u751a\u81f3\u53ef\u4ee5\u76f4\u63a5\u5229\u7528 Kubernetes \u7684 EndpointSlice \u7279\u6027\u6765\u505a\u670d\u52a1\u53d1\u73b0\u548c\u5206\u7247\u5904\u7406\uff0c\u5728\u8d85\u5927\u89c4\u6a21\u670d\u52a1\u573a\u666f\u4e0b\u5c31\u53ef\u4ee5\u4e0d\u9700\u8981\u5176\u5b83\u7684\u670d\u52a1\u53d1\u73b0\u548c\u5206\u7247\u673a\u5236\u3002\u4e0d\u8fc7\u6682\u65f6\u6b64\u7279\u6027\u8fd8\u4e0d\u591f\u6210\u719f\uff0c\u6ca1\u6709\u9ed8\u8ba4\u542f\u7528\uff0c\u4e0d\u63a8\u8350\u7528(\u5f53\u524d Kubernentes \u6700\u65b0\u7248\u672c\u4e3a 1.18)\u3002</p> <p>\u7b2c\u4e8c\uff0c\u7528 Kubernetes \u7684 node \u670d\u52a1\u53d1\u73b0\uff0c\u518d\u5229\u7528 Prometheus relabel \u914d\u7f6e\u7684 hashmod \u6765\u5bf9 node \u505a\u5206\u7247\uff0c\u6bcf\u4e2a Prometheus \u5b9e\u4f8b\u4ec5\u6293\u5176\u4e2d\u4e00\u4e2a\u5206\u7247\u4e2d\u7684\u6570\u636e:</p> <pre><code>- job_name: 'cadvisor-1'\n  metrics_path: /metrics/cadvisor\n  scheme: https\n\n    # \u8bf7\u6c42 kubelet metrics \u63a5\u53e3\u4e5f\u9700\u8981\u8ba4\u8bc1\u548c\u6388\u6743\uff0c\u901a\u5e38\u4f1a\u7528 webhook \u65b9\u5f0f\u8ba9 apiserver \u4ee3\u7406\u8fdb\u884cRBAC \u6821\u9a8c\uff0c\u6240\u4ee5\u8fd8\u662f\u7528 ServiceAccount \u7684 token\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n\n  kubernetes_sd_configs:\n  - role: node\n\n  # \u901a\u5e38\u4e0d\u6821\u9a8c kubelet \u7684 server \u8bc1\u4e66\uff0c\u907f\u514d\u62a5 x509: certificate signed by unknown authority\n  tls_config:\n    insecure_skip_verify: true\n\n  relabel_configs:\n  - source_labels: [__address__]\n    modulus:       4    # \u5c06\u8282\u70b9\u5206\u7247\u6210 4 \u4e2a group\n    target_label:  __tmp_hash\n    action:        hashmod\n  - source_labels: [__tmp_hash]\n    regex:         ^1$  # \u53ea\u6293\u7b2c 2 \u4e2a group \u4e2d\u8282\u70b9\u7684\u6570\u636e(\u5e8f\u53f7 0 \u4e3a\u7b2c 1 \u4e2a group)\n    action:        keep\n</code></pre> <p>\u62c6\u5206\u5f15\u5165\u7684\u65b0\u95ee\u9898</p> <p>\u524d\u9762\u6211\u4eec\u901a\u8fc7\u4e0d\u901a\u5c42\u9762\u5bf9 Prometheus \u8fdb\u884c\u4e86\u62c6\u5206\u90e8\u7f72\uff0c\u4e00\u65b9\u9762\u4f7f\u5f97 Prometheus \u80fd\u591f\u5b9e\u73b0\u6c34\u5e73\u6269\u5bb9\uff0c\u53e6\u4e00\u65b9\u9762\u4e5f\u52a0\u5267\u4e86\u76d1\u63a7\u6570\u636e\u843d\u76d8\u7684\u5206\u6563\u7a0b\u5ea6\uff0c\u4f7f\u7528 Grafana \u67e5\u8be2\u76d1\u63a7\u6570\u636e\u65f6\u6211\u4eec\u4e5f\u9700\u8981\u6dfb\u52a0\u8bb8\u591a\u6570\u636e\u6e90\uff0c\u800c\u4e14\u4e0d\u540c\u6570\u636e\u6e90\u4e4b\u95f4\u7684\u6570\u636e\u8fd8\u4e0d\u80fd\u805a\u5408\u67e5\u8be2\uff0c\u76d1\u63a7\u9875\u9762\u4e5f\u770b\u4e0d\u5230\u5168\u5c40\u7684\u89c6\u56fe\uff0c\u9020\u6210\u67e5\u8be2\u6df7\u4e71\u7684\u5c40\u9762\u3002</p> <p></p> <p>\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u4ece\u4e0b\u9762\u7684\u4e24\u65b9\u9762\u5165\u624b\uff0c\u4efb\u9009\u5176\u4e2d\u4e00\u79cd\u65b9\u6848\u3002</p>"},{"location":"chap11/63prometheus_optimiztion/#4-1","title":"4-1 \u96c6\u4e2d\u6570\u636e\u5b58\u50a8","text":"<p>\u6211\u4eec\u53ef\u4ee5\u8ba9 Prometheus \u4e0d\u8d1f\u8d23\u5b58\u50a8\uff0c\u4ec5\u91c7\u96c6\u6570\u636e\u5e76\u901a\u8fc7 remote write \u65b9\u5f0f\u5199\u5165\u8fdc\u7a0b\u5b58\u50a8\u7684 adapter\uff0c\u8fdc\u7a0b\u5b58\u50a8\u4f7f\u7528 OpenTSDB \u6216 InfluxDB \u8fd9\u4e9b\u652f\u6301\u96c6\u7fa4\u90e8\u7f72\u7684\u65f6\u5e8f\u6570\u636e\u5e93\uff0cPrometheus \u914d\u7f6e:</p> <pre><code>remote_write:\n- url: http://10.0.0.2:8888/write\n</code></pre> <p>\u7136\u540e Grafana \u6dfb\u52a0\u6211\u4eec\u4f7f\u7528\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u4f5c\u4e3a\u6570\u636e\u6e90\u6765\u67e5\u8be2\u76d1\u63a7\u6570\u636e\u6765\u5c55\u793a\uff0c\u67b6\u6784\u56fe:</p> <p></p> <p>\u8fd9\u79cd\u65b9\u5f0f\u76f8\u5f53\u4e8e\u66f4\u6362\u4e86\u5b58\u50a8\u5f15\u64ce\uff0c\u7531\u5176\u5b83\u652f\u6301\u5b58\u50a8\u6c34\u5e73\u6269\u5bb9\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u6765\u5b58\u50a8\u5e9e\u5927\u7684\u6570\u636e\u91cf\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u6570\u636e\u96c6\u4e2d\u5230\u4e00\u8d77\u3002OpenTSDB \u652f\u6301 HBase, BigTable \u4f5c\u4e3a\u5b58\u50a8\u540e\u7aef\uff0cInfluxDB \u4f01\u4e1a\u7248\u652f\u6301\u96c6\u7fa4\u90e8\u7f72\u548c\u6c34\u5e73\u6269\u5bb9(\u5f00\u6e90\u7248\u4e0d\u652f\u6301)\u3002\u4e0d\u8fc7\u8fd9\u6837\u7684\u8bdd\uff0c\u6211\u4eec\u5c31\u65e0\u6cd5\u4f7f\u7528\u53cb\u597d\u4e14\u5f3a\u5927\u7684 PromQL \u6765\u67e5\u8be2\u76d1\u63a7\u6570\u636e\u4e86\uff0c\u5fc5\u987b\u4f7f\u7528\u6211\u4eec\u5b58\u50a8\u6570\u636e\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u6240\u652f\u6301\u7684\u8bed\u6cd5\u6765\u67e5\u8be2\u3002</p>"},{"location":"chap11/63prometheus_optimiztion/#4-2-prometheus","title":"4-2 Prometheus \u8054\u90a6","text":"<p>\u9664\u4e86\u4e0a\u9762\u66f4\u6362\u5b58\u50a8\u5f15\u64ce\u7684\u65b9\u5f0f\uff0c\u8fd8\u53ef\u4ee5\u5c06 Prometheus \u8fdb\u884c\u8054\u90a6\u90e8\u7f72\u3002</p> <p></p> <p>\u7b80\u5355\u6765\u8bf4\uff0c\u5c31\u662f\u5c06\u591a\u4e2a Prometheus \u5b9e\u4f8b\u91c7\u96c6\u7684\u6570\u636e\u518d\u7528\u53e6\u4e00\u4e2a Prometheus \u91c7\u96c6\u6c47\u603b\u5230\u4e00\u8d77\uff0c\u8fd9\u6837\u4e5f\u610f\u5473\u7740\u9700\u8981\u6d88\u8017\u66f4\u591a\u7684\u8d44\u6e90\u3002\u901a\u5e38\u6211\u4eec\u53ea\u628a\u9700\u8981\u805a\u5408\u7684\u6570\u636e\u6216\u8005\u9700\u8981\u5728\u4e00\u4e2a\u5730\u65b9\u5c55\u793a\u7684\u6570\u636e\u7528\u8fd9\u79cd\u65b9\u5f0f\u91c7\u96c6\u6c47\u603b\u5230\u4e00\u8d77\uff0c\u6bd4\u5982 Kubernetes \u8282\u70b9\u6570\u8fc7\u591a\uff0ccadvisor \u7684\u6570\u636e\u5206\u6563\u5728\u591a\u4e2a Prometheus \u5b9e\u4f8b\u4e0a\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u8fd9\u79cd\u65b9\u5f0f\u5c06 cadvisor \u66b4\u9732\u7684\u5bb9\u5668\u6307\u6807\u6c47\u603b\u8d77\u6765\uff0c\u4ee5\u4fbf\u4e8e\u5728\u4e00\u4e2a\u5730\u65b9\u5c31\u80fd\u67e5\u8be2\u5230\u96c6\u7fa4\u4e2d\u4efb\u610f\u4e00\u4e2a\u5bb9\u5668\u7684\u76d1\u63a7\u6570\u636e\u6216\u8005\u67d0\u4e2a\u670d\u52a1\u80cc\u540e\u6240\u6709\u5bb9\u5668\u7684\u76d1\u63a7\u6570\u636e\u7684\u805a\u5408\u6c47\u603b\u4ee5\u53ca\u914d\u7f6e\u544a\u8b66\uff1b</p> <p>\u53c8\u6216\u8005\u591a\u4e2a\u670d\u52a1\u6709\u5173\u8054\uff0c\u6bd4\u5982\u901a\u5e38\u5e94\u7528\u53ea\u66b4\u9732\u4e86\u5b83\u5e94\u7528\u76f8\u5173\u7684\u6307\u6807\uff0c\u4f46\u5b83\u7684\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5(\u6bd4\u5982 cpu \u548c \u5185\u5b58) \u7531 cadvisor \u6765\u611f\u77e5\u548c\u66b4\u9732\uff0c\u8fd9\u4e24\u90e8\u5206\u6307\u6807\u7531\u4e0d\u540c\u7684 Prometheus \u5b9e\u4f8b\u6240\u91c7\u96c6\uff0c\u8fd9\u65f6\u6211\u4eec\u4e5f\u53ef\u4ee5\u7528\u8fd9\u79cd\u65b9\u5f0f\u5c06\u6570\u636e\u6c47\u603b\uff0c\u5728\u4e00\u4e2a\u5730\u65b9\u5c55\u793a\u548c\u914d\u7f6e\u544a\u8b66\u3002</p> <p>\u66f4\u591a\u8bf4\u660e\u548c\u914d\u7f6e\u793a\u4f8b\u8bf7\u53c2\u8003\u5b98\u65b9\u6587\u6863: https://prometheus.io/docs/prometheus/latest/federation/</p>"},{"location":"chap11/63prometheus_optimiztion/#4-3-prometheus","title":"4-3 Prometheus \u9ad8\u53ef\u7528","text":"<p>\u867d\u7136\u4e0a\u9762\u6211\u4eec\u901a\u8fc7\u4e00\u4e9b\u5217\u64cd\u4f5c\u5c06 Prometheus \u8fdb\u884c\u4e86\u5206\u5e03\u5f0f\u6539\u9020\uff0c\u4f46\u5e76\u6ca1\u6709\u89e3\u51b3 Prometheus \u672c\u8eab\u7684\u9ad8\u53ef\u7528\u95ee\u9898\uff0c\u5373\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u5b9e\u4f8b\u6302\u4e86\uff0c\u6570\u636e\u7684\u67e5\u8be2\u548c\u5b8c\u6574\u6027\u90fd\u5c06\u53d7\u5230\u5f71\u54cd\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5c06\u6240\u6709 Prometheus \u5b9e\u4f8b\u90fd\u4f7f\u7528\u4e24\u4e2a\u76f8\u540c\u526f\u672c\uff0c\u5206\u522b\u6302\u8f7d\u6570\u636e\u76d8\uff0c\u5b83\u4eec\u90fd\u91c7\u96c6\u76f8\u540c\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u5b83\u4eec\u7684\u6570\u636e\u662f\u4e00\u81f4\u7684\uff0c\u67e5\u8be2\u5b83\u4eec\u4e4b\u4e2d\u4efb\u610f\u4e00\u4e2a\u90fd\u53ef\u4ee5\uff0c\u6240\u4ee5\u53ef\u4ee5\u5728\u5b83\u4eec\u524d\u9762\u518d\u6302\u4e00\u5c42\u8d1f\u8f7d\u5747\u8861\uff0c\u6240\u6709\u67e5\u8be2\u90fd\u7ecf\u8fc7\u8fd9\u4e2a\u8d1f\u8f7d\u5747\u8861\u5206\u6d41\u5230\u5176\u4e2d\u4e00\u53f0 Prometheus\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u53f0\u6302\u6389\u5c31\u4ece\u8d1f\u8f7d\u5217\u8868\u91cc\u8e22\u6389\u4e0d\u518d\u8f6c\u53d1\u3002</p> <p>\u8fd9\u91cc\u7684\u8d1f\u8f7d\u5747\u8861\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u73af\u5883\u9009\u62e9\u5408\u9002\u7684\u65b9\u6848\uff0c\u53ef\u4ee5\u7528 Nginx \u6216 HAProxy\uff0c\u5728 Kubernetes \u73af\u5883\uff0c\u901a\u5e38\u4f7f\u7528 Kubernentes \u7684 Service\uff0c\u7531 kube-proxy \u751f\u6210\u7684 iptables/ipvs \u89c4\u5219\u8f6c\u53d1\uff0c\u5982\u679c\u4f7f\u7528 Istio\uff0c\u8fd8\u53ef\u4ee5\u7528 VirtualService\uff0c\u7531 envoy sidecar \u53bb\u8f6c\u53d1\u3002</p> <p></p> <p>\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86 Prometheus \u7684\u9ad8\u53ef\u7528\uff0c\u7b80\u5355\u8d77\u89c1\uff0c\u4e0a\u9762\u7684\u56fe\u4ec5\u5c55\u793a\u5355\u4e2a Prometheus \u7684\u9ad8\u53ef\u7528\uff0c\u5f53\u4f60\u53ef\u4ee5\u5c06\u5176\u62d3\u5c55\uff0c\u4ee3\u5165\u5e94\u7528\u5230\u4e0a\u9762\u5176\u5b83\u7684\u4f18\u5316\u624b\u6bb5\u4e2d\uff0c\u5b9e\u73b0\u6574\u4f53\u7684\u9ad8\u53ef\u7528\u3002</p>"},{"location":"chap11/63prometheus_optimiztion/#5","title":"5 \u603b\u7ed3","text":"<p>\u901a\u8fc7\u672c\u6587\u4e00\u7cfb\u5217\u5bf9 Prometheus \u7684\u4f18\u5316\u624b\u6bb5\uff0c\u6211\u4eec\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u89e3\u51b3\u4e86\u5355\u673a Prometheus \u5728\u5927\u89c4\u6a21\u573a\u666f\u4e0b\u7684\u75db\u70b9\uff0c\u4f46\u64cd\u4f5c\u548c\u8fd0\u7ef4\u590d\u6742\u5ea6\u6bd4\u8f83\u9ad8\uff0c\u5e76\u4e14\u4e0d\u80fd\u591f\u5f88\u597d\u7684\u652f\u6301\u6570\u636e\u7684\u957f\u671f\u5b58\u50a8(long term storage)\u3002\u5bf9\u4e8e\u4e00\u4e9b\u65f6\u95f4\u6bd4\u8f83\u4e45\u8fdc\u7684\u76d1\u63a7\u6570\u636e\uff0c\u6211\u4eec\u901a\u5e38\u67e5\u770b\u7684\u9891\u7387\u5f88\u4f4e\uff0c\u4f46\u4e5f\u5e0c\u671b\u80fd\u591f\u4f4e\u6210\u672c\u7684\u4fdd\u7559\u8db3\u591f\u957f\u7684\u65f6\u95f4\uff0c\u6570\u636e\u5982\u679c\u5168\u90e8\u843d\u76d8\u5230\u78c1\u76d8\u6210\u672c\u662f\u5f88\u9ad8\u7684\uff0c\u5e76\u4e14\u5bb9\u91cf\u6709\u9650\uff0c\u5373\u4fbf\u5229\u7528\u6c34\u5e73\u6269\u5bb9\u53ef\u4ee5\u589e\u52a0\u5b58\u50a8\u5bb9\u91cf\uff0c\u4f46\u540c\u65f6\u4e5f\u589e\u5927\u4e86\u8d44\u6e90\u6210\u672c\uff0c\u4e0d\u53ef\u80fd\u65e0\u9650\u6269\u5bb9\uff0c\u6240\u4ee5\u9700\u8981\u8bbe\u7f6e\u4e00\u4e2a\u6570\u636e\u8fc7\u671f\u7b56\u7565\uff0c\u4e5f\u5c31\u4f1a\u4e22\u5931\u65f6\u95f4\u6bd4\u8f83\u4e45\u8fdc\u7684\u76d1\u63a7\u6570\u636e\u3002</p> <p>\u5bf9\u4e8e\u8fd9\u79cd\u4e0d\u5e38\u7528\u7684\u51b7\u6570\u636e\uff0c\u6700\u7406\u60f3\u7684\u65b9\u5f0f\u5c31\u662f\u5b58\u5230\u5ec9\u4ef7\u7684\u5bf9\u8c61\u5b58\u50a8\u4e2d\uff0c\u7b49\u9700\u8981\u67e5\u8be2\u7684\u65f6\u5019\u80fd\u591f\u81ea\u52a8\u52a0\u8f7d\u51fa\u6765\u3002Thanos \u53ef\u4ee5\u5e2e\u6211\u4eec\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0c\u5b83\u5b8c\u5168\u517c\u5bb9 Prometheus API\uff0c\u63d0\u4f9b\u7edf\u4e00\u67e5\u8be2\u805a\u5408\u5206\u5e03\u5f0f\u90e8\u7f72\u7684 Prometheus \u6570\u636e\u7684\u80fd\u529b\uff0c\u540c\u65f6\u4e5f\u652f\u6301\u6570\u636e\u957f\u671f\u5b58\u50a8\u5230\u5404\u79cd\u5bf9\u8c61\u5b58\u50a8(\u65e0\u9650\u5b58\u50a8\u80fd\u529b)\u4ee5\u53ca\u964d\u4f4e\u91c7\u6837\u7387\u6765\u52a0\u901f\u5927\u65f6\u95f4\u8303\u56f4\u7684\u6570\u636e\u67e5\u8be2\u3002</p>"},{"location":"chap11/64thanos_detail/","title":"\u7b2c\u4e03\u8282 (Thaos2-2022)Thanos\u67b6\u6784\u8be6\u89e3","text":"<p>Prometheus \u4f18\u5316\u5230\u9002\u914d\u5927\u89c4\u6a21\u573a\u666f\uff0c\u90e8\u7f72\u548c\u540e\u671f\u7ef4\u62a4\u9ebb\u70e6\u4e14\u590d\u6742\u4e0d\u8bf4\uff0c\u8fd8\u6709\u5f88\u591a\u4e0d\u5b8c\u7f8e\u7684\u5730\u65b9\uff0c\u5e76\u4e14\u8fd8\u65e0\u6cd5\u6ee1\u8db3\u4e00\u4e9b\u66f4\u9ad8\u7ea7\u7684\u8bc9\u6c42\uff0c\u6bd4\u5982\u67e5\u770b\u65f6\u95f4\u4e45\u8fdc\u7684\u76d1\u63a7\u6570\u636e\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u65f6\u95f4\u4e45\u8fdc\u4e0d\u5e38\u7528\u7684 \u201c\u51b7\u6570\u636e\u201d\uff0c\u6700\u7406\u60f3\u7684\u65b9\u5f0f\u5c31\u662f\u5b58\u5230\u5ec9\u4ef7\u7684\u5bf9\u8c61\u5b58\u50a8\u4e2d\uff0c\u7b49\u9700\u8981\u67e5\u8be2\u7684\u65f6\u5019\u80fd\u591f\u81ea\u52a8\u52a0\u8f7d\u51fa\u6765\u3002</p> <p>Thanos (\u6ca1\u9519\uff0c\u5c31\u662f\u706d\u9738) \u53ef\u4ee5\u5e2e\u6211\u4eec\u7b80\u5316\u5206\u5e03\u5f0f Prometheus \u7684\u90e8\u7f72\u4e0e\u7ba1\u7406\uff0c\u5e76\u63d0\u4f9b\u4e86\u4e00\u4e9b\u7684\u9ad8\u7ea7\u7279\u6027\uff1a\u5168\u5c40\u89c6\u56fe\uff0c\u957f\u671f\u5b58\u50a8\uff0c\u9ad8\u53ef\u7528\u3002\u4e0b\u9762\u6211\u4eec\u6765\u8be6\u7ec6\u8bb2\u89e3\u4e00\u4e0b\u3002</p>"},{"location":"chap11/64thanos_detail/#1-thanos","title":"1 Thanos \u67b6\u6784","text":"<p>\u8fd9\u662f\u5b98\u65b9\u7ed9\u51fa\u7684\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>\u8fd9\u5f20\u56fe\u4e2d\u5305\u542b\u4e86 Thanos \u7684\u51e0\u4e2a\u6838\u5fc3\u7ec4\u4ef6\uff0c\u4f46\u5e76\u4e0d\u5305\u62ec\u6240\u6709\u7ec4\u4ef6\uff0c\u4e3a\u4e86\u4fbf\u4e8e\u7406\u89e3\uff0c\u6211\u4eec\u5148\u4e0d\u7ec6\u8bb2\uff0c\u7b80\u5355\u4ecb\u7ecd\u4e0b\u56fe\u4e2d\u8fd9\u51e0\u4e2a\u7ec4\u4ef6\u7684\u4f5c\u7528\uff1a</p> <ul> <li>Thanos Query: \u5b9e\u73b0\u4e86 Prometheus API\uff0c\u5c06\u6765\u81ea\u4e0b\u6e38\u7ec4\u4ef6\u63d0\u4f9b\u7684\u6570\u636e\u8fdb\u884c\u805a\u5408\u6700\u7ec8\u8fd4\u56de\u7ed9\u67e5\u8be2\u6570\u636e\u7684 client (\u5982 grafana)\uff0c\u7c7b\u4f3c\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u3002</li> <li>Thanos Sidecar: <ul> <li>\u8fde\u63a5 Prometheus\uff0c\u5c06\u5176\u6570\u636e\u63d0\u4f9b\u7ed9 Thanos Query \u67e5\u8be2\uff0c</li> <li>\u5e76\u4e14/\u6216\u8005\u5c06\u5176\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\uff0c\u4ee5\u4f9b\u957f\u671f\u5b58\u50a8\u3002</li> </ul> </li> <li>Thanos Store Gateway: \u5c06\u5bf9\u8c61\u5b58\u50a8\u7684\u6570\u636e\u66b4\u9732\u7ed9 Thanos Query \u53bb\u67e5\u8be2\u3002</li> <li>Thanos Ruler: \u5bf9\u76d1\u63a7\u6570\u636e\u8fdb\u884c\u8bc4\u4f30\u548c\u544a\u8b66\uff0c\u8fd8\u53ef\u4ee5\u8ba1\u7b97\u51fa\u65b0\u7684\u76d1\u63a7\u6570\u636e\uff0c\u5c06\u8fd9\u4e9b\u65b0\u6570\u636e\u63d0\u4f9b\u7ed9 Thanos Query \u67e5\u8be2\u5e76\u4e14/\u6216\u8005\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\uff0c\u4ee5\u4f9b\u957f\u671f\u5b58\u50a8\u3002</li> <li>Thanos Compact: \u5c06\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u538b\u7f29\u548c\u964d\u4f4e\u91c7\u6837\u7387\uff0c\u52a0\u901f\u5927\u65f6\u95f4\u533a\u95f4\u76d1\u63a7\u6570\u636e\u67e5\u8be2\u7684\u901f\u5ea6\u3002</li> </ul>"},{"location":"chap11/64thanos_detail/#1-1","title":"1-1 \u67b6\u6784\u8bbe\u8ba1\u5256\u6790","text":"<p>\u5982\u4f55\u7406\u89e3 Thanos \u7684\u67b6\u6784\u8bbe\u8ba1\u7684\uff1f\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u5148 YY \u4e00\u4e0b\uff0c\u8981\u662f\u81ea\u5df1\u6765\u8bbe\u8ba1\u4e00\u4e2a\u5206\u5e03\u5f0f Prometheus \u7ba1\u7406\u5e94\u7528\uff0c\u4f1a\u600e\u4e48\u505a\uff1f</p> <p>Query \u4e0e Sidecar</p> <p>\u9996\u5148\uff0c\u76d1\u63a7\u6570\u636e\u7684\u67e5\u8be2\u80af\u5b9a\u4e0d\u80fd\u76f4\u63a5\u67e5 Prometheus \u4e86\uff0c\u56e0\u4e3a\u4f1a\u5b58\u5728\u8bb8\u591a\u4e2a Prometheus \u5b9e\u4f8b\uff0c\u6bcf\u4e2a Prometheus \u5b9e\u4f8b\u53ea\u80fd\u611f\u77e5\u5b83\u81ea\u5df1\u6240\u91c7\u96c6\u7684\u6570\u636e\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u6bd4\u8f83\u5bb9\u6613\u8054\u60f3\u5230\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\uff0c\u6bcf\u4e2a\u6570\u636e\u5e93\u90fd\u53ea\u5b58\u4e86\u4e00\u90e8\u5206\u6570\u636e\uff0c\u4e2d\u95f4\u4ef6\u80fd\u611f\u77e5\u5230\u6240\u6709\u6570\u636e\u5e93\uff0c\u6570\u636e\u67e5\u8be2\u90fd\u7ecf\u8fc7\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u6765\u67e5\uff0c\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u6536\u5230\u67e5\u8be2\u8bf7\u6c42\u518d\u53bb\u67e5\u4e0b\u6e38\u5404\u4e2a\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\uff0c\u6700\u540e\u5c06\u8fd9\u4e9b\u6570\u636e\u805a\u5408\u6c47\u603b\u8fd4\u56de\u7ed9\u67e5\u8be2\u7684\u5ba2\u6237\u7aef\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u5c06\u5206\u5e03\u5f0f\u5b58\u50a8\u7684\u6570\u636e\u96c6\u4e2d\u67e5\u8be2\u3002</p> <p>\u90a3\u4e48 Thanos Query \u53c8\u5982\u4f55\u53bb\u67e5\u4e0b\u6e38\u5206\u6563\u7684\u6570\u636e\u5462\uff1f</p> <p>Thanos \u4e3a\u6b64\u62bd\u8c61\u4e86\u4e00\u5957\u53eb Store API \u7684\u5185\u90e8 gRPC \u63a5\u53e3\uff0c\u5176\u5b83\u4e00\u4e9b\u7ec4\u4ef6\u901a\u8fc7\u8fd9\u4e2a\u63a5\u53e3\u6765\u66b4\u9732\u6570\u636e\u7ed9 Thanos Query\uff0c\u5b83\u81ea\u8eab\u4e5f\u5c31\u53ef\u4ee5\u505a\u5230\u5b8c\u5168\u65e0\u72b6\u6001\u90e8\u7f72\uff0c\u5b9e\u73b0\u9ad8\u53ef\u7528\u4e0e\u52a8\u6001\u6269\u5c55\u3002</p> <p></p> <p>\u8fd9\u4e9b\u5206\u6563\u7684\u6570\u636e\u53ef\u80fd\u6765\u81ea\u54ea\u4e9b\u5730\u65b9\u5462\uff1f</p> <p>\u9996\u5148\uff0cPrometheus \u4f1a\u5c06\u91c7\u96c6\u7684\u6570\u636e\u5b58\u5230\u672c\u673a\u78c1\u76d8\u4e0a\uff0c\u5982\u679c\u6211\u4eec\u76f4\u63a5\u7528\u8fd9\u4e9b\u5206\u6563\u5728\u5404\u4e2a\u78c1\u76d8\u4e0a\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u7ed9\u6bcf\u4e2a Prometheus \u9644\u5e26\u90e8\u7f72\u4e00\u4e2a Sidecar\uff0c\u8fd9\u4e2a Sidecar \u5b9e\u73b0 Thanos Store API\uff0c\u5f53 Thanos Query \u5bf9\u5176\u53d1\u8d77\u67e5\u8be2\u65f6\uff0cSidecar \u5c31\u8bfb\u53d6\u8ddf\u5b83\u7ed1\u5b9a\u90e8\u7f72\u7684 Prometheus \u5b9e\u4f8b\u4e0a\u7684\u76d1\u63a7\u6570\u636e\u8fd4\u56de\u7ed9 Thanos Query\u3002</p> <p></p> <p>\u7531\u4e8e Thanos Query \u53ef\u4ee5\u5bf9\u6570\u636e\u8fdb\u884c\u805a\u5408\u4e0e\u53bb\u91cd\uff0c\u6240\u4ee5\u53ef\u4ee5\u5f88\u8f7b\u677e\u5b9e\u73b0\u9ad8\u53ef\u7528\uff1a\u76f8\u540c\u7684 Prometheus \u90e8\u7f72\u591a\u4e2a\u526f\u672c(\u90fd\u9644\u5e26 Sidecar)\uff0c\u7136\u540e Thanos Query \u53bb\u6240\u6709 Sidecar \u67e5\u6570\u636e\uff0c\u5373\u4fbf\u6709\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u6302\u6389\u8fc7\u4e00\u6bb5\u65f6\u95f4\uff0c\u6570\u636e\u805a\u5408\u4e0e\u53bb\u91cd\u540e\u4ecd\u7136\u80fd\u5f97\u5230\u5b8c\u6574\u6570\u636e\u3002</p> <p>\u8fd9\u79cd\u9ad8\u53ef\u7528\u505a\u6cd5\u8fd8\u5f25\u8865\u4e86\u6211\u4eec\u4e0a\u7bc7\u6587\u7ae0\u4e2d\u7528\u8d1f\u8f7d\u5747\u8861\u53bb\u5b9e\u73b0 Prometheus \u9ad8\u53ef\u7528\u65b9\u6cd5\u7684\u7f3a\u9677\uff1a\u5982\u679c\u5176\u4e2d\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u6302\u4e86\u4e00\u6bb5\u65f6\u95f4\u7136\u540e\u53c8\u6062\u590d\u4e86\uff0c\u5b83\u7684\u6570\u636e\u5c31\u4e0d\u5b8c\u6574\uff0c\u5f53\u8d1f\u8f7d\u5747\u8861\u8f6c\u53d1\u5230\u5b83\u4e0a\u9762\u53bb\u67e5\u6570\u636e\u65f6\uff0c\u8fd4\u56de\u7684\u7ed3\u679c\u5c31\u53ef\u80fd\u4f1a\u6709\u90e8\u5206\u7f3a\u5931\u3002</p> <p>\u4e0d\u8fc7\u56e0\u4e3a\u78c1\u76d8\u7a7a\u95f4\u6709\u9650\uff0c\u6240\u4ee5 Prometheus \u5b58\u50a8\u76d1\u63a7\u6570\u636e\u7684\u80fd\u529b\u4e5f\u662f\u6709\u9650\u7684\uff0c\u901a\u5e38\u4f1a\u7ed9 Prometheus \u8bbe\u7f6e\u4e00\u4e2a\u6570\u636e\u8fc7\u671f\u65f6\u95f4 (\u9ed8\u8ba415\u5929) \u6216\u8005\u6700\u5927\u6570\u636e\u91cf\u5927\u5c0f\uff0c\u4e0d\u65ad\u6e05\u7406\u65e7\u6570\u636e\u4ee5\u4fdd\u8bc1\u78c1\u76d8\u4e0d\u88ab\u6491\u7206\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u65e0\u6cd5\u770b\u5230\u65f6\u95f4\u6bd4\u8f83\u4e45\u8fdc\u7684\u76d1\u63a7\u6570\u636e\uff0c\u6709\u65f6\u5019\u8fd9\u4e5f\u7ed9\u6211\u4eec\u7684\u95ee\u9898\u6392\u67e5\u548c\u6570\u636e\u7edf\u8ba1\u9020\u6210\u4e00\u4e9b\u56f0\u96be\u3002</p> <p>\u5bf9\u4e8e\u9700\u8981\u957f\u671f\u5b58\u50a8\u7684\u6570\u636e\uff0c\u5e76\u4e14\u4f7f\u7528\u9891\u7387\u4e0d\u90a3\u4e48\u9ad8\uff0c\u6700\u7406\u60f3\u7684\u65b9\u5f0f\u662f\u5b58\u8fdb\u5bf9\u8c61\u5b58\u50a8\uff0c\u5404\u5927\u4e91\u5382\u5546\u90fd\u6709\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\uff0c\u7279\u70b9\u662f\u4e0d\u9650\u5236\u5bb9\u91cf\uff0c\u4ef7\u683c\u975e\u5e38\u4fbf\u5b9c\u3002</p> <p>Thanos \u6709\u51e0\u4e2a\u7ec4\u4ef6\u90fd\u652f\u6301\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5404\u79cd\u5bf9\u8c61\u5b58\u50a8\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58 (Prometheus TSDB \u6570\u636e\u683c\u5f0f)\uff0c\u6bd4\u5982\u6211\u4eec\u521a\u521a\u8bf4\u7684 Sidecar:</p> <p></p>"},{"location":"chap11/64thanos_detail/#store-gateway","title":"Store Gateway","text":"<p>\u90a3\u4e48\u8fd9\u4e9b\u88ab\u4e0a\u4f20\u5230\u4e86\u5bf9\u8c61\u5b58\u50a8\u91cc\u7684\u76d1\u63a7\u6570\u636e\u8be5\u5982\u4f55\u67e5\u8be2\u5462\uff1f</p> <p>\u7406\u8bba\u4e0a Thanos Query \u4e5f\u53ef\u4ee5\u76f4\u63a5\u53bb\u5bf9\u8c61\u5b58\u50a8\u67e5\uff0c\u4f46\u4f1a\u8ba9 Thanos Query \u7684\u903b\u8f91\u53d8\u7684\u5f88\u91cd\u3002</p> <p>\u6211\u4eec\u521a\u624d\u4e5f\u770b\u5230\u4e86\uff0cThanos \u62bd\u8c61\u51fa\u4e86 Store API\uff0c\u53ea\u8981\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3\u7684\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u4f5c\u4e3a Thanos Query \u67e5\u8be2\u7684\u6570\u636e\u6e90\uff0cThanos Store Gateway \u8fd9\u4e2a\u7ec4\u4ef6\u4e5f\u5b9e\u73b0\u4e86 Store API\uff0c\u5411 Thanos Query \u66b4\u9732\u5bf9\u8c61\u5b58\u50a8\u7684\u6570\u636e\u3002</p> <p>Thanos Store Gateway \u5185\u90e8\u8fd8\u505a\u4e86\u4e00\u4e9b\u52a0\u901f\u6570\u636e\u83b7\u53d6\u7684\u4f18\u5316\u903b\u8f91\uff0c\u4e00\u662f\u7f13\u5b58\u4e86 TSDB \u7d22\u5f15\uff0c\u4e8c\u662f\u4f18\u5316\u4e86\u5bf9\u8c61\u5b58\u50a8\u7684\u8bf7\u6c42 (\u7528\u5c3d\u53ef\u80fd\u5c11\u7684\u8bf7\u6c42\u91cf\u62ff\u5230\u6240\u6709\u9700\u8981\u7684\u6570\u636e)\u3002</p> <p></p> <p>\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u76d1\u63a7\u6570\u636e\u7684\u957f\u671f\u50a8\u5b58\uff0c\u7531\u4e8e\u5bf9\u8c61\u5b58\u50a8\u5bb9\u91cf\u65e0\u9650\uff0c\u6240\u4ee5\u7406\u8bba\u4e0a\u6211\u4eec\u53ef\u4ee5\u5b58\u4efb\u610f\u65f6\u957f\u7684\u6570\u636e\uff0c\u76d1\u63a7\u5386\u53f2\u6570\u636e\u4e5f\u5c31\u53d8\u5f97\u53ef\u8ffd\u6eaf\u67e5\u8be2\uff0c\u4fbf\u4e8e\u95ee\u9898\u6392\u67e5\u4e0e\u7edf\u8ba1\u5206\u6790\u3002</p>"},{"location":"chap11/64thanos_detail/#ruler","title":"Ruler","text":"<p>\u6709\u4e00\u4e2a\u95ee\u9898\uff0cPrometheus \u4e0d\u4ec5\u4ec5\u53ea\u652f\u6301\u5c06\u91c7\u96c6\u7684\u6570\u636e\u8fdb\u884c\u5b58\u50a8\u548c\u67e5\u8be2\u7684\u529f\u80fd\uff0c\u8fd8\u53ef\u4ee5\u914d\u7f6e\u4e00\u4e9b rules:</p> <ul> <li>\u6839\u636e\u914d\u7f6e\u4e0d\u65ad\u8ba1\u7b97\u51fa\u65b0\u6307\u6807\u6570\u636e\u5e76\u5b58\u50a8\uff0c\u540e\u7eed\u67e5\u8be2\u65f6\u76f4\u63a5\u4f7f\u7528\u8ba1\u7b97\u597d\u7684\u65b0\u6307\u6807\uff0c\u8fd9\u6837\u53ef\u4ee5\u51cf\u8f7b\u67e5\u8be2\u65f6\u7684\u8ba1\u7b97\u538b\u529b\uff0c\u52a0\u5feb\u67e5\u8be2\u901f\u5ea6\u3002</li> <li>\u4e0d\u65ad\u8ba1\u7b97\u548c\u8bc4\u4f30\u662f\u5426\u8fbe\u5230\u544a\u8b66\u9600\u503c\uff0c\u5f53\u8fbe\u5230\u9600\u503c\u65f6\u5c31\u901a\u77e5 AlertManager \u6765\u89e6\u53d1\u544a\u8b66\u3002</li> </ul> <p>\u7531\u4e8e\u6211\u4eec\u5c06 Prometheus \u8fdb\u884c\u5206\u5e03\u5f0f\u90e8\u7f72\uff0c\u6bcf\u4e2a Prometheus \u5b9e\u4f8b\u672c\u5730\u5e76\u6ca1\u6709\u5b8c\u6574\u6570\u636e\uff0c\u6709\u4e9b\u6709\u5173\u8054\u7684\u6570\u636e\u53ef\u80fd\u5b58\u5728\u591a\u4e2a Prometheus \u5b9e\u4f8b\u4e2d\uff0c\u5355\u673a Prometheus \u770b\u4e0d\u5230\u6570\u636e\u7684\u5168\u5c40\u89c6\u56fe\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u5c31\u4e0d\u80fd\u4f9d\u8d56 Prometheus \u6765\u505a\u8fd9\u4e9b\u5de5\u4f5c\uff0cThanos Ruler \u5e94\u8fd0\u800c\u751f\uff0c\u5b83\u901a\u8fc7\u67e5\u8be2 Thanos Query \u83b7\u53d6\u5168\u5c40\u6570\u636e\uff0c\u7136\u540e\u6839\u636e rules \u914d\u7f6e\u8ba1\u7b97\u65b0\u6307\u6807\u5e76\u5b58\u50a8\uff0c\u540c\u65f6\u4e5f\u901a\u8fc7 Store API \u5c06\u6570\u636e\u66b4\u9732\u7ed9 Thanos Query\uff0c\u540c\u6837\u8fd8\u53ef\u4ee5\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58 (\u8fd9\u91cc\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u4e00\u6837\u4e5f\u662f\u901a\u8fc7 Thanos Store Gateway \u66b4\u9732\u7ed9 Thanos Query)\u3002</p> <p></p> <p>\u770b\u8d77\u6765 Thanos Query \u8ddf Thanos Ruler \u4e4b\u95f4\u4f1a\u76f8\u4e92\u67e5\u8be2\uff0c\u4e0d\u8fc7\u8fd9\u4e2a\u4e0d\u51b2\u7a81\uff0cThanos Ruler \u4e3a Thanos Query \u63d0\u4f9b\u8ba1\u7b97\u51fa\u7684\u65b0\u6307\u6807\u6570\u636e\uff0c\u800c Thanos Query \u4e3a Thanos Ruler \u63d0\u4f9b\u8ba1\u7b97\u65b0\u6307\u6807\u6240\u9700\u8981\u7684\u5168\u5c40\u539f\u59cb\u6307\u6807\u6570\u636e\u3002</p> <p>\u81f3\u6b64\uff0cThanos \u7684\u6838\u5fc3\u80fd\u529b\u57fa\u672c\u5b9e\u73b0\u4e86\uff0c\u5b8c\u5168\u517c\u5bb9 Prometheus \u7684\u60c5\u51b5\u4e0b\u63d0\u4f9b\u6570\u636e\u67e5\u8be2\u7684\u5168\u5c40\u89c6\u56fe\uff0c\u9ad8\u53ef\u7528\u4ee5\u53ca\u6570\u636e\u7684\u957f\u671f\u4fdd\u5b58\u3002</p> <p>\u770b\u4e0b\u8fd8\u53ef\u4ee5\u600e\u4e48\u8fdb\u4e00\u6b65\u505a\u4e0b\u4f18\u5316\u5462\uff1f</p>"},{"location":"chap11/64thanos_detail/#compact","title":"Compact","text":"<p>\u7531\u4e8e\u6211\u4eec\u6709\u6570\u636e\u957f\u671f\u5b58\u50a8\u7684\u80fd\u529b\uff0c\u4e5f\u5c31\u53ef\u4ee5\u5b9e\u73b0\u67e5\u8be2\u8f83\u5927\u65f6\u95f4\u8303\u56f4\u7684\u76d1\u63a7\u6570\u636e\uff0c\u5f53\u65f6\u95f4\u8303\u56f4\u5f88\u5927\u65f6\uff0c\u67e5\u8be2\u7684\u6570\u636e\u91cf\u4e5f\u4f1a\u5f88\u5927\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u67e5\u8be2\u901f\u5ea6\u975e\u5e38\u6162\u3002</p> <p>\u901a\u5e38\u5728\u67e5\u770b\u8f83\u5927\u65f6\u95f4\u8303\u56f4\u7684\u76d1\u63a7\u6570\u636e\u65f6\uff0c\u6211\u4eec\u5e76\u4e0d\u9700\u8981\u90a3\u4e48\u8be6\u7ec6\u7684\u6570\u636e\uff0c\u53ea\u9700\u8981\u770b\u5230\u5927\u81f4\u5c31\u884c\u3002Thanos Compact \u8fd9\u4e2a\u7ec4\u4ef6\u5e94\u8fd0\u800c\u751f\uff0c\u5b83\u8bfb\u53d6\u5bf9\u8c61\u5b58\u50a8\u7684\u6570\u636e\uff0c\u5bf9\u5176\u8fdb\u884c\u538b\u7f29\u4ee5\u53ca\u964d\u91c7\u6837\u518d\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\uff0c\u8fd9\u6837\u5728\u67e5\u8be2\u5927\u65f6\u95f4\u8303\u56f4\u6570\u636e\u65f6\u5c31\u53ef\u4ee5\u53ea\u8bfb\u53d6\u538b\u7f29\u548c\u964d\u91c7\u6837\u540e\u7684\u6570\u636e\uff0c\u6781\u5927\u5730\u51cf\u5c11\u4e86\u67e5\u8be2\u7684\u6570\u636e\u91cf\uff0c\u4ece\u800c\u52a0\u901f\u67e5\u8be2\u3002</p> <p></p>"},{"location":"chap11/64thanos_detail/#_1","title":"\u518d\u770b\u67b6\u6784\u56fe","text":"<p>\u4e0a\u9762\u6211\u4eec\u5256\u6790\u4e86\u5b98\u65b9\u67b6\u6784\u56fe\u4e2d\u5404\u4e2a\u7ec4\u4ef6\u7684\u8bbe\u8ba1\uff0c\u73b0\u5728\u518d\u6765\u56de\u5473\u4e00\u4e0b\u8fd9\u5f20\u56fe:</p> <p></p> <p>\u7406\u89e3\u662f\u5426\u66f4\u52a0\u6df1\u523b\u4e86\uff1f</p> <p>\u53e6\u5916\u8fd8\u6709 Thanos Bucket \u548c Thanos Checker \u4e24\u4e2a\u8f85\u52a9\u6027\u7684\u5de5\u5177\u7ec4\u4ef6\u6ca1\u753b\u51fa\u6765\uff0c\u5b83\u4eec\u4e0d\u662f\u6838\u5fc3\u7ec4\u4ef6\uff0c\u8fd9\u91cc\u4e5f\u5c31\u4e0d\u518d\u8d58\u8ff0\u3002</p>"},{"location":"chap11/64thanos_detail/#sidecar-receiver","title":"Sidecar \u6a21\u5f0f\u4e0e Receiver \u6a21\u5f0f","text":"<p>\u524d\u9762\u6211\u4eec\u7406\u89e3\u4e86\u5b98\u65b9\u7684\u67b6\u6784\u56fe\uff0c\u4f46\u5176\u4e2d\u8fd8\u7f3a\u5931\u4e00\u4e2a\u6838\u5fc3\u7ec4\u4ef6 Thanos Receiver\uff0c\u56e0\u4e3a\u5b83\u662f\u4e00\u4e2a\u8fd8\u672a\u5b8c\u5168\u53d1\u5e03\u7684\u7ec4\u4ef6\u3002\u8fd9\u662f\u5b83\u7684\u8bbe\u8ba1\u6587\u6863: https://thanos.io/proposals/201812_thanos-remote-receive.md/</p> <p>\u8fd9\u4e2a\u7ec4\u4ef6\u53ef\u4ee5\u5b8c\u5168\u6d88\u9664 Sidecar\uff0c\u6240\u4ee5 Thanos \u5b9e\u9645\u6709\u4e24\u79cd\u67b6\u6784\u56fe\uff0c\u53ea\u662f\u56e0\u4e3a\u6ca1\u6709\u5b8c\u5168\u53d1\u5e03\uff0c\u5b98\u65b9\u7684\u67b6\u6784\u56fe\u53ea\u7ed9\u7684 Sidecar \u6a21\u5f0f\u3002</p> <p>Receiver \u662f\u505a\u4ec0\u4e48\u7684\u5462\uff1f\u4e3a\u4ec0\u4e48\u9700\u8981 Receiver\uff1f\u5b83\u8ddf Sidecar \u6709\u4ec0\u4e48\u533a\u522b\uff1f</p> <p>\u5b83\u4eec\u90fd\u53ef\u4ee5\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58\uff0c\u533a\u522b\u5728\u4e8e\u6700\u65b0\u6570\u636e\u7684\u5b58\u50a8\u3002</p> <p>\u7531\u4e8e\u6570\u636e\u4e0a\u4f20\u4e0d\u53ef\u80fd\u5b9e\u65f6\uff0cSidecar \u6a21\u5f0f\u5c06\u6700\u65b0\u7684\u76d1\u63a7\u6570\u636e\u5b58\u5230 Prometheus \u672c\u673a\uff0cQuery \u901a\u8fc7\u8c03\u6240\u6709 Sidecar \u7684 Store API \u6765\u83b7\u53d6\u6700\u65b0\u6570\u636e\uff0c\u8fd9\u5c31\u6210\u4e00\u4e2a\u95ee\u9898\uff1a\u5982\u679c Sidecar \u6570\u91cf\u975e\u5e38\u591a\u6216\u8005 Sidecar \u8ddf Query \u79bb\u7684\u6bd4\u8f83\u8fdc\uff0c\u6bcf\u6b21\u67e5\u8be2 Query \u90fd\u8c03\u6240\u6709 Sidecar \u4f1a\u6d88\u8017\u5f88\u591a\u8d44\u6e90\uff0c\u5e76\u4e14\u901f\u5ea6\u5f88\u6162\uff0c\u800c\u6211\u4eec\u67e5\u770b\u76d1\u63a7\u5927\u591a\u6570\u60c5\u51b5\u90fd\u662f\u770b\u7684\u6700\u65b0\u6570\u636e\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cThanos Receiver \u7ec4\u4ef6\u88ab\u63d0\u51fa\uff0c\u5b83\u9002\u914d\u4e86 Prometheus \u7684 remote write API\uff0c\u4e5f\u5c31\u662f\u6240\u6709 Prometheus \u5b9e\u4f8b\u53ef\u4ee5\u5b9e\u65f6\u5c06\u6570\u636e push \u5230 Thanos Receiver\uff0c\u6700\u65b0\u6570\u636e\u4e5f\u5f97\u4ee5\u96c6\u4e2d\u8d77\u6765\uff0c\u7136\u540e Thanos Query \u4e5f\u4e0d\u7528\u53bb\u6240\u6709 Sidecar \u67e5\u6700\u65b0\u6570\u636e\u4e86\uff0c\u76f4\u63a5\u67e5 Thanos Receiver \u5373\u53ef\u3002\u53e6\u5916\uff0cThanos Receiver \u4e5f\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4ee5\u4f9b\u957f\u671f\u4fdd\u5b58\uff0c\u5f53\u7136\uff0c\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u540c\u6837\u7531 Thanos Store Gateway \u66b4\u9732\u7ed9 Thanos Query\u3002</p> <p></p> <p>\u5982\u679c\u89c4\u6a21\u5f88\u5927\uff0cReceiver \u538b\u529b\u4f1a\u4e0d\u4f1a\u5f88\u5927\uff0c\u6210\u4e3a\u6027\u80fd\u74f6\u9888\uff1f\u5f53\u7136\u8bbe\u8ba1\u8fd9\u4e2a\u7ec4\u4ef6\u65f6\u80af\u5b9a\u4f1a\u8003\u8651\u8fd9\u4e2a\u95ee\u9898\uff0cReceiver \u5b9e\u73b0\u4e86\u4e00\u81f4\u6027\u54c8\u5e0c\uff0c\u652f\u6301\u96c6\u7fa4\u90e8\u7f72\uff0c\u6240\u4ee5\u5373\u4f7f\u89c4\u6a21\u5f88\u5927\u4e5f\u4e0d\u4f1a\u6210\u4e3a\u6027\u80fd\u74f6\u9888\u3002</p>"},{"location":"chap11/65thanos_setup/","title":"\u7b2c\u516b\u8282 (Thaos3-2022)Thanos\u90e8\u7f72\u4e0e\u5b9e\u8df5","text":""},{"location":"chap11/65thanos_setup/#1","title":"1 \u90e8\u7f72\u65b9\u5f0f","text":"<p>\u672c\u6587\u805a\u7126 Thanos \u7684\u4e91\u539f\u751f\u90e8\u7f72\u65b9\u5f0f\uff0c\u5145\u5206\u5229\u7528 Kubernetes \u7684\u8d44\u6e90\u8c03\u5ea6\u4e0e\u52a8\u6001\u6269\u5bb9\u80fd\u529b\u3002\u4ece\u5b98\u65b9 \u8fd9\u91cc \u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u524d thanos \u5728 Kubernetes \u4e0a\u90e8\u7f72\u6709\u4ee5\u4e0b\u4e09\u79cd\uff1a</p> <ul> <li>prometheus-operator: \u96c6\u7fa4\u4e2d\u5b89\u88c5\u4e86 prometheus-operator \u540e\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa CRD \u5bf9\u8c61\u6765\u90e8\u7f72 Thanos \u4e86\u3002</li> <li>\u793e\u533a\u8d21\u732e\u7684\u4e00\u4e9b helm charts: \u5f88\u591a\u4e2a\u7248\u672c\uff0c\u76ee\u6807\u90fd\u662f\u80fd\u591f\u4f7f\u7528 helm \u6765\u4e00\u952e\u90e8\u7f72 thanos\u3002</li> <li>kube-thanos: Thanos \u5b98\u65b9\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u5305\u542b\u90e8\u7f72 thanos \u5230 kubernetes \u7684 jsonnet \u6a21\u677f\u4e0e yaml \u793a\u4f8b\u3002</li> </ul> <p></p> <p>\u672c\u6587\u5c06\u4f7f\u7528\u57fa\u4e8e kube-thanos \u63d0\u4f9b\u7684 yaml \u793a\u4f8b (<code>examples/all/manifests</code>) \u6765\u90e8\u7f72\uff0c\u539f\u56e0\u662f <code>prometheus-operator</code> \u4e0e\u793e\u533a\u7684 helm chart \u65b9\u5f0f\u90e8\u7f72\u591a\u4e86\u4e00\u5c42\u5c01\u88c5\uff0c\u5c4f\u853d\u4e86\u8bb8\u591a\u7ec6\u8282\uff0c\u5e76\u4e14\u5b83\u4eec\u7684\u5b9e\u73b0\u90fd\u8fd8\u4e0d\u592a\u6210\u719f\uff1b</p> <p>\u76f4\u63a5\u4f7f\u7528 kubernetes \u7684 yaml \u8d44\u6e90\u6587\u4ef6\u90e8\u7f72\u66f4\u76f4\u89c2\uff0c\u4e5f\u66f4\u5bb9\u6613\u505a\u81ea\u5b9a\u4e49\uff0c\u800c\u4e14\u6211\u76f8\u4fe1\u4f7f\u7528 thanos \u7684\u7528\u6237\u901a\u5e38\u90fd\u662f\u9ad8\u73a9\u4e86\uff0c\u4e5f\u6709\u5fc5\u8981\u5bf9 thanos \u7406\u89e3\u900f\u5f7b\uff0c\u65e5\u540e\u624d\u597d\u6839\u636e\u5b9e\u9645\u573a\u666f\u505a\u67b6\u6784\u548c\u914d\u7f6e\u7684\u8c03\u6574\uff0c\u76f4\u63a5\u4f7f\u7528 yaml \u90e8\u7f72\u80fd\u591f\u8ba9\u6211\u4eec\u770b\u6e05\u7ec6\u8282\u3002</p>"},{"location":"chap11/65thanos_setup/#2","title":"2 \u65b9\u6848\u9009\u578b","text":""},{"location":"chap11/65thanos_setup/#2-1-sidecar-or-receiver","title":"2-1 Sidecar or Receiver","text":"<p>\u76ee\u524d\u5b98\u65b9\u7684\u67b6\u6784\u56fe\u7528\u7684 Sidecar \u65b9\u6848\uff0cReceiver \u662f\u4e00\u4e2a\u6682\u65f6\u8fd8\u6ca1\u6709\u5b8c\u5168\u53d1\u5e03\u7684\u7ec4\u4ef6\u3002\u901a\u5e38\u6765\u8bf4\uff0cSidecar \u65b9\u6848\u76f8\u5bf9\u6210\u719f\u4e00\u4e9b\uff0c\u6700\u65b0\u7684\u6570\u636e\u5b58\u50a8\u548c\u8ba1\u7b97 (\u6bd4\u5982\u805a\u5408\u51fd\u6570) \u6bd4\u8f83 \u201c\u5206\u5e03\u5f0f\u201d\uff0c\u66f4\u52a0\u9ad8\u6548\u4e5f\u66f4\u5bb9\u6613\u6269\u5c55\u3002</p> <p></p> <p>Receiver \u65b9\u6848\u662f\u8ba9 Prometheus \u901a\u8fc7 remote wirte API \u5c06\u6570\u636e push \u5230 Receiver \u96c6\u4e2d\u5b58\u50a8 (\u540c\u6837\u4f1a\u6e05\u7406\u8fc7\u671f\u6570\u636e):</p> <p></p> <ul> <li>\u5982\u679c\u4f60\u7684 Query \u8ddf Sidecar \u79bb\u7684\u6bd4\u8f83\u8fdc\uff0c\u6bd4\u5982 Sidecar \u5206\u5e03\u5728\u591a\u4e2a\u6570\u636e\u4e2d\u5fc3\uff0cQuery \u5411\u6240\u6709 Sidecar \u67e5\u6570\u636e\uff0c\u901f\u5ea6\u4f1a\u5f88\u6162\uff0c\u8fd9\u79cd\u60c5\u51b5\u53ef\u4ee5\u8003\u8651\u7528 Receiver\uff0c\u5c06\u6570\u636e\u96c6\u4e2d\u5410\u5230 Receiver\uff0c\u7136\u540e Receiver \u4e0e Query \u90e8\u7f72\u5728\u4e00\u8d77\uff0cQuery \u76f4\u63a5\u5411 Receiver \u67e5\u6700\u65b0\u6570\u636e\uff0c\u63d0\u5347\u67e5\u8be2\u6027\u80fd\u3002</li> <li>\u5982\u679c\u4f60\u7684\u4f7f\u7528\u573a\u666f\u53ea\u5141\u8bb8 Prometheus \u5c06\u6570\u636e push \u5230\u8fdc\u7a0b\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 Receiver\u3002\u6bd4\u5982 IoT \u8bbe\u5907\u6ca1\u6709\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u53ea\u80fd\u5c06\u6570\u636e push \u5230\u8fdc\u7a0b\u3002</li> </ul> <p>\u6b64\u5916\u7684\u573a\u666f\u5e94\u8be5\u90fd\u5c3d\u91cf\u4f7f\u7528 Sidecar \u65b9\u6848\u3002</p>"},{"location":"chap11/65thanos_setup/#2-2-ruler","title":"2-2 \u8bc4\u4f30\u662f\u5426\u9700\u8981 Ruler","text":"<p>Ruler \u662f\u4e00\u4e2a\u53ef\u9009\u7ec4\u4ef6\uff0c\u539f\u5219\u4e0a\u63a8\u8350\u5c3d\u91cf\u4f7f\u7528 Prometheus \u81ea\u5e26\u7684 rule \u529f\u80fd (\u751f\u6210\u65b0\u6307\u6807+\u544a\u8b66)\uff0c\u8fd9\u4e2a\u529f\u80fd\u9700\u8981\u4e00\u4e9b Prometheus \u6700\u65b0\u6570\u636e\uff0c\u76f4\u63a5\u4f7f\u7528 Prometheus \u672c\u673a rule \u529f\u80fd\u548c\u6570\u636e\uff0c\u6027\u80fd\u5f00\u9500\u76f8\u6bd4 Thanos Ruler \u8fd9\u79cd\u5206\u5e03\u5f0f\u65b9\u6848\u5c0f\u5f97\u591a\uff0c\u5e76\u4e14\u51e0\u4e4e\u4e0d\u4f1a\u51fa\u9519\uff0cThanos Ruler \u7531\u4e8e\u662f\u5206\u5e03\u5f0f\uff0c\u6240\u4ee5\u66f4\u5bb9\u6613\u51fa\u9519\u4e00\u4e9b\u3002</p> <p>\u5982\u679c\u67d0\u4e9b\u6709\u5173\u8054\u7684\u6570\u636e\u5206\u6563\u5728\u591a\u4e2a\u4e0d\u540c Prometheus \u4e0a\uff0c\u6bd4\u5982\u5bf9\u67d0\u4e2a\u5927\u89c4\u6a21\u670d\u52a1\u91c7\u96c6\u505a\u4e86\u5206\u7247\uff0c\u6bcf\u4e2a Prometheus \u4ec5\u91c7\u96c6\u4e00\u90e8\u5206 endpoint \u7684\u6570\u636e\uff0c\u5bf9\u4e8e record \u7c7b\u578b\u7684 rule (\u751f\u6210\u7684\u65b0\u6307\u6807)\uff0c\u8fd8\u662f\u53ef\u4ee5\u4f7f\u7528 Prometheus \u81ea\u5e26\u7684 rule \u529f\u80fd\uff0c\u5728\u67e5\u8be2\u65f6\u518d\u805a\u5408\u4e00\u4e0b\u5c31\u53ef\u4ee5(\u5982\u679c\u53ef\u4ee5\u63a5\u53d7\u7684\u8bdd)\uff1b</p> <p>\u5bf9\u4e8e alert \u7c7b\u578b\u7684 rule\uff0c\u5c31\u9700\u8981\u7528 Thanos Ruler \u6765\u505a\u4e86\uff0c\u56e0\u4e3a\u6709\u5173\u8054\u7684\u6570\u636e\u5206\u6563\u5728\u591a\u4e2a Prometheus \u4e0a\uff0c\u7528\u5355\u673a\u6570\u636e\u53bb\u505a alert \u8ba1\u7b97\u662f\u4e0d\u51c6\u786e\u7684\uff0c\u5c31\u53ef\u80fd\u4f1a\u9020\u6210\u8bef\u544a\u8b66\u6216\u4e0d\u544a\u8b66\u3002</p>"},{"location":"chap11/65thanos_setup/#2-3-store-gateway-compact","title":"2-3 \u8bc4\u4f30\u662f\u5426\u9700\u8981 Store Gateway \u4e0e Compact","text":"<p>Store \u4e5f\u662f\u4e00\u4e2a\u53ef\u9009\u7ec4\u4ef6\uff0c\u4e5f\u662f Thanos \u7684\u4e00\u5927\u4eae\u70b9\u7684\u5173\u952e\uff1a\u6570\u636e\u957f\u671f\u4fdd\u5b58\u3002</p> <p>\u8bc4\u4f30\u662f\u5426\u9700\u8981 Store \u7ec4\u4ef6\u5b9e\u9645\u5c31\u662f\u8bc4\u4f30\u4e00\u4e0b\u81ea\u5df1\u662f\u5426\u6709\u6570\u636e\u957f\u671f\u5b58\u50a8\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u67e5\u770b\u4e00\u4e24\u4e2a\u6708\u524d\u7684\u76d1\u63a7\u6570\u636e\u3002\u5982\u679c\u6709\uff0c\u90a3\u4e48 Thanos \u53ef\u4ee5\u5c06\u6570\u636e\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u4fdd\u5b58\u3002Thanos \u652f\u6301\u4ee5\u4e0b\u5bf9\u8c61\u5b58\u50a8</p> <ul> <li>Google Cloud Storage</li> <li>AWS/S3</li> <li>Azure Storage Account</li> <li>OpenStack Swift</li> <li>Tencent COS</li> <li>AliYun OSS</li> </ul> <p>\u5728\u56fd\u5185\uff0c\u6700\u65b9\u4fbf\u8fd8\u662f\u4f7f\u7528\u817e\u8baf\u4e91 COS \u6216\u8005\u963f\u91cc\u4e91 OSS \u8fd9\u6837\u7684\u516c\u6709\u4e91\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u3002\u5982\u679c\u4f60\u7684\u670d\u52a1\u6ca1\u6709\u8dd1\u5728\u516c\u6709\u4e91\u4e0a\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8ddf\u4e91\u670d\u52a1\u5382\u5546\u62c9\u4e13\u7ebf\u7684\u65b9\u5f0f\u6765\u8d70\u5185\u7f51\u4f7f\u7528\u5bf9\u8c61\u5b58\u50a8\uff0c\u8fd9\u6837\u901f\u5ea6\u901a\u5e38\u4e5f\u662f\u53ef\u4ee5\u6ee1\u8db3\u9700\u6c42\u7684\uff1b\u5982\u679c\u5b9e\u5728\u7528\u4e0d\u4e86\u516c\u6709\u4e91\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\uff0c\u4e5f\u53ef\u4ee5\u81ea\u5df1\u5b89\u88c5 minio &amp; mino \u6765\u642d\u5efa\u517c\u5bb9 AWS \u7684 S3 \u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u3002</p> <p>\u641e\u5b9a\u4e86\u5bf9\u8c61\u5b58\u50a8\uff0c\u8fd8\u9700\u8981\u7ed9 Thanos \u591a\u4e2a\u7ec4\u4ef6\u914d\u7f6e\u5bf9\u8c61\u5b58\u50a8\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u4ee5\u4fbf\u80fd\u591f\u4e0a\u4f20\u4e0e\u8bfb\u53d6\u76d1\u63a7\u6570\u636e\u3002\u9664 Query \u4ee5\u5916\u7684\u6240\u6709 Thanos \u7ec4\u4ef6 (Sidecar\u3001Receiver\u3001Ruler\u3001Store Gateway\u3001Compact) \u90fd\u9700\u8981\u914d\u7f6e\u5bf9\u8c61\u5b58\u50a8\u4fe1\u606f\uff0c\u4f7f\u7528 <code>--objstore.config</code> \u76f4\u63a5\u914d\u7f6e\u5185\u5bb9\u6216 <code>--objstore.config-file</code> \u5f15\u7528\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e\u6587\u4ef6\uff0c\u4e0d\u540c\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e\u65b9\u5f0f\u4e0d\u4e00\u6837\uff0c\u53c2\u8003\u5b98\u65b9\u6587\u6863: https://thanos.io/storage.md</p>"},{"location":"chap11/65thanos_setup/#2-4","title":"2-4 \u51c6\u5907\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e","text":"<p>\u5982\u679c\u6211\u4eec\u8981\u4f7f\u7528\u5bf9\u8c61\u5b58\u50a8\u6765\u957f\u671f\u4fdd\u5b58\u6570\u636e\uff0c\u90a3\u4e48\u5c31\u8981\u51c6\u5907\u4e0b\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\u4fe1\u606f (<code>thanos-objectstorage-secret.yaml</code>)\uff0c\u6bd4\u5982\u4f7f\u7528\u817e\u8baf\u4e91 COS \u6765\u5b58\u50a8:</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: thanos-objectstorage\n  namespace: thanos\ntype: Opaque\nstringData:\n  objectstorage.yaml: |\n    type: COS\n    config:\n      bucket: \"thanos\"\n      region: \"ap-singapore\"\n      app_id: \"12*******5\"\n      secret_key: \"tsY***************************Edm\"\n      secret_id: \"AKI******************************gEY\"\n</code></pre> <p>\u6216\u8005\u4f7f\u7528\u963f\u91cc\u4e91 OSS \u5b58\u50a8:</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: thanos-objectstorage\n  namespace: thanos\ntype: Opaque\nstringData:\n  objectstorage.yaml: |\n    type: ALIYUNOSS\n    config:\n      endpoint: \"oss-cn-hangzhou-internal.aliyuncs.com\"\n      bucket: \"thanos\"\n      access_key_id: \"LTA******************KBu\"\n      access_key_secret: \"oki************************2HQ\"\n</code></pre> <pre><code>$ helm install minio minio/minio --set service.type=NodePort --set defaultBucket.enabled=true --set defaultBucket.name=thanos --set persistence.enabled=false --namespace thanos\nNAME: minio\nLAST DEPLOYED: Thu May 12 15:11:03 2022\nNAMESPACE: thanos\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\n...\n\n  2. Get the ACCESS_KEY=$(kubectl get secret minio -o jsonpath=\"{.data.accesskey}\" | base64 --decode) and the SECRET_KEY=$(kubectl get secret minio -o jsonpath=\"{.data.secretkey}\" | base64 --decode)\n...\n\nAlternately, you can use your browser or the Minio SDK to access the server - https://docs.minio.io/categories/17\n</code></pre> <pre><code>$ kubectl get secret minio -o jsonpath=\"{.data.accesskey}\" -n thanos | base64 --decode\n0iqANq2qwU6OJ4KgfuSb\n\n\n$ kubectl get secret minio -o jsonpath=\"{.data.secretkey}\" -n thanos | base64 --decode\n\nSr5Nmc8OV9RvGLywhW6TfA3E2vqM6R7jiOurixAI\n</code></pre> <p>Localfile system</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: thanos-objectstorage\n  namespace: thanos\ntype: Opaque\nstringData:\n  objectstorage.yaml: |\n    type: FILESYSTEM\n    config:\n        directory: \"/Users/.../data/thanos\"\n</code></pre> <pre><code>$ kubectl apply -f thanos-objectstorage-secret.yaml \nsecret/thanos-objectstorage created\n</code></pre>"},{"location":"chap11/65thanos_setup/#2-5-prometheus-sidecar","title":"2-5 \u7ed9 Prometheus \u52a0\u4e0a Sidecar","text":"<p>\u5982\u679c\u9009\u7528 Sidecar \u65b9\u6848\uff0c\u5c31\u9700\u8981\u7ed9 Prometheus \u52a0\u4e0a Thanos Sidecar\uff0c\u51c6\u5907 prometheus.yaml:</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: prometheus-headless\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: prometheus\nspec:\n  type: ClusterIP\n  clusterIP: None\n  selector:\n    app.kubernetes.io/name: prometheus\n  ports:\n  - name: web\n    protocol: TCP\n    port: 9090\n    targetPort: web\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n---\n\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: thanos\n\n---\n\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus\n  namespace: thanos\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - nodes/proxy\n  - nodes/metrics\n  - services\n  - endpoints\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\n  resources: [\"configmaps\"]\n  verbs: [\"get\"]\n- nonResourceURLs: [\"/metrics\"]\n  verbs: [\"get\"]\n\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nsubjects:\n  - kind: ServiceAccount\n    name: prometheus\n    namespace: thanos\nroleRef:\n  kind: ClusterRole\n  name: prometheus\n  apiGroup: rbac.authorization.k8s.io\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: prometheus\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  serviceName: prometheus-headless\n  podManagementPolicy: Parallel\n  replicas: 2\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: prometheus\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: prometheus\n    spec:\n      serviceAccountName: prometheus\n      securityContext:\n        fsGroup: 2000\n        runAsNonRoot: true\n        runAsUser: 1000\n      # affinity:\n      #   podAntiAffinity:\n      #     requiredDuringSchedulingIgnoredDuringExecution:\n      #     - labelSelector:\n      #         matchExpressions:\n      #         - key: app.kubernetes.io/name\n      #           operator: In\n      #           values:\n      #           - prometheus\n      #       topologyKey: kubernetes.io/hostname\n      containers:\n      - name: prometheus\n        image: quay.io/prometheus/prometheus:v2.15.2\n        args:\n        - --config.file=/etc/prometheus/config_out/prometheus.yaml\n        - --storage.tsdb.path=/prometheus\n        - --storage.tsdb.retention.time=10d\n        - --web.route-prefix=/\n        - --web.enable-lifecycle\n        - --storage.tsdb.no-lockfile\n        - --storage.tsdb.min-block-duration=2h\n        - --storage.tsdb.max-block-duration=2h\n        - --log.level=debug\n        ports:\n        - containerPort: 9090\n          name: web\n          protocol: TCP\n        livenessProbe:\n          failureThreshold: 6\n          httpGet:\n            path: /-/healthy\n            port: web\n            scheme: HTTP\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 3\n        readinessProbe:\n          failureThreshold: 120\n          httpGet:\n            path: /-/ready\n            port: web\n            scheme: HTTP\n          periodSeconds: 5\n          successThreshold: 1\n          timeoutSeconds: 3\n        volumeMounts:\n        - mountPath: /etc/prometheus/config_out\n          name: prometheus-config-out\n          readOnly: true\n        - mountPath: /prometheus\n          name: prometheus-storage\n        - mountPath: /etc/prometheus/rules\n          name: prometheus-rules\n      - name: thanos\n        image: quay.io/thanos/thanos:v0.11.0\n        args:\n        - sidecar\n        - --log.level=debug\n        - --tsdb.path=/prometheus\n        - --prometheus.url=http://127.0.0.1:9090\n        - --objstore.config-file=/etc/thanos/objectstorage.yaml\n        - --reloader.config-file=/etc/prometheus/config/prometheus.yaml.tmpl\n        - --reloader.config-envsubst-file=/etc/prometheus/config_out/prometheus.yaml\n        - --reloader.rule-dir=/etc/prometheus/rules/\n        env:\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        ports:\n        - name: http-sidecar\n          containerPort: 10902\n        - name: grpc\n          containerPort: 10901\n        livenessProbe:\n            httpGet:\n              port: 10902\n              path: /-/healthy\n        readinessProbe:\n          httpGet:\n            port: 10902\n            path: /-/ready\n        volumeMounts:\n        - name: prometheus-config-tmpl\n          mountPath: /etc/prometheus/config\n        - name: prometheus-config-out\n          mountPath: /etc/prometheus/config_out\n        - name: prometheus-rules\n          mountPath: /etc/prometheus/rules\n        - name: prometheus-storage\n          mountPath: /prometheus\n        - name: thanos-objectstorage\n          subPath: objectstorage.yaml\n          mountPath: /etc/thanos/objectstorage.yaml\n      volumes:\n      - name: prometheus-config-tmpl\n        configMap:\n          defaultMode: 420\n          name: prometheus-config-tmpl\n      - name: prometheus-config-out\n        emptyDir: {}\n      - name: prometheus-rules\n        configMap:\n          name: prometheus-rules\n      - name: thanos-objectstorage\n        secret:\n          secretName: thanos-objectstorage\n  volumeClaimTemplates:\n  - metadata:\n      name: prometheus-storage\n      labels:\n        app.kubernetes.io/name: prometheus\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 1Gi\n      volumeMode: hostpath\n</code></pre> <ul> <li>Prometheus \u4f7f\u7528 StatefulSet \u65b9\u5f0f\u90e8\u7f72\uff0c\u6302\u8f7d\u6570\u636e\u76d8\u4ee5\u4fbf\u5b58\u50a8\u6700\u65b0\u76d1\u63a7\u6570\u636e\u3002</li> <li>\u7531\u4e8e Prometheus \u526f\u672c\u4e4b\u95f4\u6ca1\u6709\u542f\u52a8\u987a\u5e8f\u7684\u4f9d\u8d56\uff0c\u6240\u4ee5 podManagementPolicy \u6307\u5b9a\u4e3a Parallel\uff0c\u52a0\u5feb\u542f\u52a8\u901f\u5ea6\u3002</li> <li>\u4e3a Prometheus \u7ed1\u5b9a\u8db3\u591f\u7684 RBAC \u6743\u9650\uff0c\u4ee5\u4fbf\u540e\u7eed\u914d\u7f6e\u4f7f\u7528 k8s \u7684\u670d\u52a1\u53d1\u73b0 (<code>kubernetes_sd_configs</code>) \u65f6\u80fd\u591f\u6b63\u5e38\u5de5\u4f5c\u3002</li> <li>\u4e3a Prometheus \u521b\u5efa headless \u7c7b\u578b service\uff0c\u4e3a\u540e\u7eed Thanos Query \u901a\u8fc7 DNS SRV \u8bb0\u5f55\u6765\u52a8\u6001\u53d1\u73b0 Sidecar \u7684 gRPC \u7aef\u70b9\u505a\u51c6\u5907 (\u4f7f\u7528 headless service \u624d\u80fd\u8ba9 DNS SRV \u6b63\u786e\u8fd4\u56de\u6240\u6709\u7aef\u70b9)\u3002</li> <li>\u4f7f\u7528\u4e24\u4e2a Prometheus \u526f\u672c\uff0c\u7528\u4e8e\u5b9e\u73b0\u9ad8\u53ef\u7528\u3002</li> <li>\u4f7f\u7528\u786c\u53cd\u4eb2\u548c\uff0c\u907f\u514d Prometheus \u90e8\u7f72\u5728\u540c\u4e00\u8282\u70b9\uff0c\u65e2\u53ef\u4ee5\u5206\u6563\u538b\u529b\u4e5f\u53ef\u4ee5\u907f\u514d\u5355\u70b9\u6545\u969c\u3002</li> <li>Prometheus \u4f7f\u7528 <code>--storage.tsdb.retention.time</code> \u6307\u5b9a\u6570\u636e\u4fdd\u7559\u65f6\u957f\uff0c\u9ed8\u8ba415\u5929\uff0c\u53ef\u4ee5\u6839\u636e\u6570\u636e\u589e\u957f\u901f\u5ea6\u548c\u6570\u636e\u76d8\u5927\u5c0f\u505a\u9002\u5f53\u8c03\u6574(\u6570\u636e\u589e\u957f\u53d6\u51b3\u4e8e\u91c7\u96c6\u7684\u6307\u6807\u548c\u76ee\u6807\u7aef\u70b9\u7684\u6570\u91cf\u548c\u91c7\u96c6\u9891\u7387)\u3002</li> <li>Sidecar \u4f7f\u7528 <code>--objstore.config-file</code> \u5f15\u7528\u6211\u4eec\u521a\u521a\u521b\u5efa\u5e76\u6302\u8f7d\u7684\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e\u6587\u4ef6\uff0c\u7528\u4e8e\u4e0a\u4f20\u6570\u636e\u5230\u5bf9\u8c61\u5b58\u50a8\u3002</li> <li>\u901a\u5e38\u4f1a\u7ed9 Prometheus \u9644\u5e26\u4e00\u4e2a <code>quay.io/coreos/prometheus-config-reloader</code> \u6765\u76d1\u542c\u914d\u7f6e\u53d8\u66f4\u5e76\u52a8\u6001\u52a0\u8f7d\uff0c\u4f46 <code>thanos sidecar</code> \u4e5f\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u8fd9\u4e2a\u529f\u80fd\uff0c<ul> <li>\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u7528 <code>thanos sidecar</code> \u6765\u5b9e\u73b0\u6b64\u529f\u80fd\uff0c\u4e5f\u652f\u6301\u914d\u7f6e\u6587\u4ef6\u6839\u636e\u6a21\u677f\u52a8\u6001\u751f\u6210\uff1a<code>--reloader.config-file</code> \u6307\u5b9a Prometheus \u914d\u7f6e\u6587\u4ef6\u6a21\u677f\uff0c<code>--reloader.config-envsubst-file</code> \u6307\u5b9a\u751f\u6210\u914d\u7f6e\u6587\u4ef6\u7684\u5b58\u653e\u8def\u5f84\uff0c\u5047\u8bbe\u662f <code>/etc/prometheus/config_out/prometheus.yaml</code> \uff0c\u90a3\u4e48 <code>/etc/prometheus/config_out</code> \u8fd9\u4e2a\u8def\u5f84\u4f7f\u7528 emptyDir \u8ba9 <code>Prometheus</code> \u4e0e Sidecar \u5b9e\u73b0\u914d\u7f6e\u6587\u4ef6\u5171\u4eab\u6302\u8f7d\uff0c<code>Prometheus</code> \u518d\u901a\u8fc7 <code>--config.file</code> \u6307\u5b9a\u751f\u6210\u51fa\u6765\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5f53\u914d\u7f6e\u6709\u66f4\u65b0\u65f6\uff0c\u6302\u8f7d\u7684\u914d\u7f6e\u6587\u4ef6\u4e5f\u4f1a\u540c\u6b65\u66f4\u65b0\uff0cSidecar \u4e5f\u4f1a\u901a\u77e5 Prometheus \u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u3002</li> </ul> </li> <li>\u53e6\u5916\uff0cSidecar \u4e0e Prometheus \u4e5f\u6302\u8f7d\u540c\u4e00\u4efd rules \u914d\u7f6e\u6587\u4ef6\uff0c\u914d\u7f6e\u66f4\u65b0\u540e Sidecar \u4ec5\u901a\u77e5 Prometheus \u52a0\u8f7d\u914d\u7f6e\uff0c\u4e0d\u652f\u6301\u6a21\u677f\uff0c\u56e0\u4e3a rules \u914d\u7f6e\u4e0d\u9700\u8981\u6a21\u677f\u6765\u52a8\u6001\u751f\u6210\u3002</li> </ul> <p>\u7136\u540e\u518d\u7ed9 Prometheus \u51c6\u5907\u914d\u7f6e (prometheus-config.yaml):</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config-tmpl\n  namespace: thanos\ndata:\n  prometheus.yaml.tmpl: |-\n    global:\n      scrape_interval: 5s\n      evaluation_interval: 5s\n      external_labels:\n        cluster: prometheus-ha\n        prometheus_replica: $(POD_NAME)\n    rule_files:\n    - /etc/prometheus/rules/*rules.yaml\n    scrape_configs:\n    - job_name: cadvisor\n      metrics_path: /metrics/cadvisor\n      scrape_interval: 10s\n      scrape_timeout: 10s\n      scheme: https\n      tls_config:\n        insecure_skip_verify: true\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n---\n\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-rules\n  labels:\n    name: prometheus-rules\n  namespace: thanos\ndata:\n  alert-rules.yaml: |-\n    groups:\n    - name: k8s.rules\n      rules:\n      - expr: |\n          sum(rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])) by (namespace)\n        record: namespace:container_cpu_usage_seconds_total:sum_rate\n      - expr: |\n          sum(container_memory_usage_bytes{job=\"cadvisor\", image!=\"\", container!=\"\"}) by (namespace)\n        record: namespace:container_memory_usage_bytes:sum\n      - expr: |\n          sum by (namespace, pod, container) (\n            rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])\n          )\n        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate\n</code></pre> <p>\u672c\u6587\u91cd\u70b9\u4e0d\u5728 prometheus \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6240\u4ee5\u8fd9\u91cc\u4ec5\u4ee5\u91c7\u96c6 kubelet \u6240\u66b4\u9732\u7684 cadvisor \u5bb9\u5668\u6307\u6807\u7684\u7b80\u5355\u914d\u7f6e\u4e3a\u4f8b\u3002</p> <ul> <li>Prometheus \u5b9e\u4f8b\u91c7\u96c6\u7684\u6240\u6709\u6307\u6807\u6570\u636e\u91cc\u90fd\u4f1a\u989d\u5916\u52a0\u4e0a <code>external_labels</code> \u91cc\u6307\u5b9a\u7684 label\uff0c\u901a\u5e38\u7528 cluster \u533a\u5206\u5f53\u524d Prometheus \u6240\u5728\u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u518d\u52a0\u4e86\u4e2a <code>prometheus_replica</code>\uff0c\u7528\u4e8e\u533a\u5206\u76f8\u540c Prometheus \u526f\u672c\uff08\u8fd9\u4e9b\u526f\u672c\u6240\u91c7\u96c6\u7684\u6570\u636e\u9664\u4e86 <code>prometheus_replica</code> \u7684\u503c\u4e0d\u4e00\u6837\uff0c\u5176\u5b83\u51e0\u4e4e\u4e00\u81f4\uff0c\u8fd9\u4e2a\u503c\u4f1a\u88ab Thanos Sidecar \u66ff\u6362\u6210 Pod \u526f\u672c\u7684\u540d\u79f0\uff0c\u7528\u4e8e Thanos \u5b9e\u73b0 Prometheus \u9ad8\u53ef\u7528\uff09</li> </ul>"},{"location":"chap11/65thanos_setup/#2-6-query","title":"2-6 \u5b89\u88c5 Query","text":"<p>\u51c6\u5907 <code>thanos-query.yaml</code>:</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-query\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  ports:\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n  - name: http\n    port: 9090\n    targetPort: http\n  selector:\n    app.kubernetes.io/name: thanos-query\n---\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: thanos-query\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-query\nspec:\n  replicas: 1\n  # replicas: 3\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-query\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-query\n    spec:\n      # affinity:\n      #   podAntiAffinity:\n      #     preferredDuringSchedulingIgnoredDuringExecution:\n      #     - podAffinityTerm:\n      #         labelSelector:\n      #           matchExpressions:\n      #           - key: app.kubernetes.io/name\n      #             operator: In\n      #             values:\n      #             - thanos-query\n      #         topologyKey: kubernetes.io/hostname\n      #       weight: 100\n      containers:\n      - args:\n        - query\n        - --log.level=debug\n        - --query.auto-downsampling\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:9090\n        - --query.partial-response\n        - --query.replica-label=prometheus_replica\n        - --query.replica-label=rule_replica\n        - --store=dnssrv+_grpc._tcp.prometheus-headless.thanos.svc.cluster.local\n        - --store=dnssrv+_grpc._tcp.thanos-rule.thanos.svc.cluster.local\n        - --store=dnssrv+_grpc._tcp.thanos-store.thanos.svc.cluster.local\n        image: thanosio/thanos:v0.11.0\n        livenessProbe:\n          failureThreshold: 4\n          httpGet:\n            path: /-/healthy\n            port: 9090\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-query\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 9090\n          name: http\n        readinessProbe:\n          failureThreshold: 20\n          httpGet:\n            path: /-/ready\n            port: 9090\n            scheme: HTTP\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n      terminationGracePeriodSeconds: 120\n</code></pre> <pre><code>$ kubectl get pod,svc -n thanos | grep query\npod/thanos-query-7b47b5c947-lsq7x   1/1     Running   0             45s\nservice/thanos-query          ClusterIP   10.96.231.202   &lt;none&gt;        10901/TCP,9090/TCP   45s\n</code></pre> <ul> <li>\u56e0\u4e3a Query \u662f\u65e0\u72b6\u6001\u7684\uff0c\u4f7f\u7528 Deployment \u90e8\u7f72\uff0c\u4e5f\u4e0d\u9700\u8981 headless service\uff0c\u76f4\u63a5\u521b\u5efa\u666e\u901a\u7684 service\u3002</li> <li>\u4f7f\u7528\u8f6f\u53cd\u4eb2\u548c\uff0c\u5c3d\u91cf\u4e0d\u8ba9 Query \u8c03\u5ea6\u5230\u540c\u4e00\u8282\u70b9\u3002</li> <li>\u90e8\u7f72\u591a\u4e2a\u526f\u672c\uff0c\u5b9e\u73b0 Query \u7684\u9ad8\u53ef\u7528\u3002</li> <li><code>--query.partial-response</code> \u542f\u7528 Partial Response\uff0c\u8fd9\u6837\u53ef\u4ee5\u5728\u90e8\u5206\u540e\u7aef Store API \u8fd4\u56de\u9519\u8bef\u6216\u8d85\u65f6\u7684\u60c5\u51b5\u4e0b\u4e5f\u80fd\u770b\u5230\u6b63\u786e\u7684\u76d1\u63a7\u6570\u636e(\u5982\u679c\u540e\u7aef Store API \u505a\u4e86\u9ad8\u53ef\u7528\uff0c\u6302\u6389\u4e00\u4e2a\u526f\u672c\uff0cQuery \u8bbf\u95ee\u6302\u6389\u7684\u526f\u672c\u8d85\u65f6\uff0c\u4f46\u7531\u4e8e\u8fd8\u6709\u6ca1\u6302\u6389\u7684\u526f\u672c\uff0c\u8fd8\u662f\u80fd\u6b63\u786e\u8fd4\u56de\u7ed3\u679c\uff1b\u5982\u679c\u6302\u6389\u7684\u67d0\u4e2a\u540e\u7aef\u672c\u8eab\u5c31\u4e0d\u5b58\u5728\u6211\u4eec\u9700\u8981\u7684\u6570\u636e\uff0c\u6302\u6389\u4e5f\u4e0d\u5f71\u54cd\u7ed3\u679c\u7684\u6b63\u786e\u6027\uff1b\u603b\u4e4b\u5982\u679c\u5404\u4e2a\u7ec4\u4ef6\u90fd\u505a\u4e86\u9ad8\u53ef\u7528\uff0c\u60f3\u83b7\u5f97\u9519\u8bef\u7684\u7ed3\u679c\u90fd\u96be\uff0c\u6240\u4ee5\u6211\u4eec\u6709\u4fe1\u5fc3\u542f\u7528 Partial Response \u8fd9\u4e2a\u529f\u80fd)\u3002</li> <li><code>--query.auto-downsampling</code> \u67e5\u8be2\u65f6\u81ea\u52a8\u964d\u91c7\u6837\uff0c\u63d0\u5347\u67e5\u8be2\u6548\u7387\u3002</li> <li><code>--query.replica-label</code> \u6307\u5b9a\u6211\u4eec\u521a\u521a\u7ed9 Prometheus \u914d\u7f6e\u7684 <code>prometheus_replica</code> \u8fd9\u4e2a external label\uff0cQuery \u5411 Sidecar \u62c9\u53d6 Prometheus \u6570\u636e\u65f6\u4f1a\u8bc6\u522b\u8fd9\u4e2a label \u5e76\u81ea\u52a8\u53bb\u91cd\uff0c\u8fd9\u6837\u5373\u4f7f\u6302\u6389\u4e00\u4e2a\u526f\u672c\uff0c\u53ea\u8981\u81f3\u5c11\u6709\u4e00\u4e2a\u526f\u672c\u6b63\u5e38\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u67e5\u8be2\u7ed3\u679c\uff0c\u4e5f\u5c31\u662f\u53ef\u4ee5\u5b9e\u73b0 Prometheus \u7684\u9ad8\u53ef\u7528\u3002\u540c\u7406\uff0c\u518d\u6307\u5b9a\u4e00\u4e2a <code>rule_replica</code> \u7528\u4e8e\u7ed9<code>Ruler</code> \u505a\u9ad8\u53ef\u7528\u3002</li> <li><code>--store</code> \u6307\u5b9a\u5b9e\u73b0\u4e86 Store API \u7684\u5730\u5740(Sidecar, Ruler, Store Gateway, Receiver)\uff0c\u901a\u5e38\u4e0d\u5efa\u8bae\u5199\u9759\u6001\u5730\u5740\uff0c\u800c\u662f\u4f7f\u7528\u670d\u52a1\u53d1\u73b0\u673a\u5236\u81ea\u52a8\u53d1\u73b0 Store API \u5730\u5740\uff0c\u5982\u679c\u662f\u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u96c6\u7fa4\uff0c\u53ef\u4ee5\u7528 DNS SRV \u8bb0\u5f55\u6765\u505a\u670d\u52a1\u53d1\u73b0\uff0c\u6bd4\u5982 <code>dnssrv+_grpc._tcp.prometheus-headless.thanos.svc.cluster.local</code>\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u521a\u521a\u4e3a\u5305\u542b <code>Sidecar</code> \u7684 Prometheus \u521b\u5efa\u7684 <code>headless service</code> (\u4f7f\u7528 headless service \u624d\u80fd\u6b63\u786e\u5b9e\u73b0\u670d\u52a1\u53d1\u73b0)\uff0c\u5e76\u4e14\u6307\u5b9a\u4e86\u540d\u4e3a grpc \u7684 tcp \u7aef\u53e3\uff0c\u540c\u7406\uff0c\u5176\u5b83\u7ec4\u4ef6\u4e5f\u53ef\u4ee5\u6309\u7167\u8fd9\u6837\u52a0\u5230 <code>--store</code> \u53c2\u6570\u91cc\uff1b</li> <li>\u5982\u679c\u662f\u5176\u5b83\u6709\u4e9b\u7ec4\u4ef6\u90e8\u7f72\u5728\u96c6\u7fa4\u5916\uff0c\u65e0\u6cd5\u901a\u8fc7\u96c6\u7fa4 dns \u89e3\u6790 DNS SRV \u8bb0\u5f55\uff0c\u53ef\u4ee5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u6765\u505a\u670d\u52a1\u53d1\u73b0\uff0c\u4e5f\u5c31\u662f\u6307\u5b9a <code>--store.sd-files</code> \u53c2\u6570\uff0c\u5c06\u5176\u5b83 Store API \u5730\u5740\u5199\u5728\u914d\u7f6e\u6587\u4ef6\u91cc (\u6302\u8f7d ConfigMap)\uff0c\u9700\u8981\u589e\u52a0\u5730\u5740\u65f6\u76f4\u63a5\u66f4\u65b0 ConfigMap (\u4e0d\u9700\u8981\u91cd\u542f Query)\u3002</li> </ul>"},{"location":"chap11/65thanos_setup/#2-7-store-gateway","title":"2-7 \u5b89\u88c5 Store Gateway","text":"<p>\u51c6\u5907 thanos-store.yaml:</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-store\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-store\nspec:\n  clusterIP: None\n  ports:\n  - name: grpc\n    port: 10901\n    targetPort: 10901\n  - name: http\n    port: 10902\n    targetPort: 10902\n  selector:\n    app.kubernetes.io/name: thanos-store\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: thanos-store\n  namespace: thanos\n  labels:\n    app.kubernetes.io/name: thanos-store\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-store\n  serviceName: thanos-store\n  podManagementPolicy: Parallel\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-store\n    spec:\n      containers:\n      - args:\n        - store\n        - --log.level=debug\n        - --data-dir=/var/thanos/store\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:10902\n        - --objstore.config-file=/etc/thanos/objectstorage.yaml\n        - --experimental.enable-index-header\n        image: thanosio/thanos:v0.11.0\n        livenessProbe:\n          failureThreshold: 8\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-store\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 10902\n          name: http\n        readinessProbe:\n          failureThreshold: 20\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /var/thanos/store\n          name: data\n          readOnly: false\n        - name: thanos-objectstorage\n          subPath: objectstorage.yaml\n          mountPath: /etc/thanos/objectstorage.yaml\n      terminationGracePeriodSeconds: 120\n      volumes:\n      - name: thanos-objectstorage\n        secret:\n          secretName: thanos-objectstorage\n  volumeClaimTemplates:\n  - metadata:\n      labels:\n        app.kubernetes.io/name: thanos-store\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 1Gi\n      storageClassName: hostpath\n</code></pre> <ul> <li>Store Gateway \u5b9e\u9645\u4e5f\u53ef\u4ee5\u505a\u5230\u4e00\u5b9a\u7a0b\u5ea6\u7684\u65e0\u72b6\u6001\uff0c\u5b83\u4f1a\u9700\u8981\u4e00\u70b9\u78c1\u76d8\u7a7a\u95f4\u6765\u5bf9\u5bf9\u8c61\u5b58\u50a8\u505a\u7d22\u5f15\u4ee5\u52a0\u901f\u67e5\u8be2\uff0c\u4f46\u6570\u636e\u4e0d\u90a3\u4e48\u91cd\u8981\uff0c\u662f\u53ef\u4ee5\u5220\u9664\u7684\uff0c\u5220\u9664\u540e\u4f1a\u81ea\u52a8\u53bb\u62c9\u5bf9\u8c61\u5b58\u50a8\u67e5\u6570\u636e\u91cd\u65b0\u5efa\u7acb\u7d22\u5f15\u3002\u8fd9\u91cc\u6211\u4eec\u907f\u514d\u6bcf\u6b21\u91cd\u542f\u90fd\u91cd\u65b0\u5efa\u7acb\u7d22\u5f15\uff0c\u6240\u4ee5\u7528 StatefulSet \u90e8\u7f72 Store Gateway\uff0c\u6302\u8f7d\u4e00\u5757\u5c0f\u5bb9\u91cf\u7684\u78c1\u76d8(\u7d22\u5f15\u5360\u7528\u4e0d\u5230\u591a\u5927\u7a7a\u95f4)\u3002</li> <li>\u540c\u6837\u521b\u5efa headless service\uff0c\u7528\u4e8e Query \u5bf9 Store Gateway \u8fdb\u884c\u670d\u52a1\u53d1\u73b0\u3002</li> <li>\u90e8\u7f72\u4e24\u4e2a\u526f\u672c\uff0c\u5b9e\u73b0 Store Gateway \u7684\u9ad8\u53ef\u7528\u3002</li> <li>Store Gateway \u4e5f\u9700\u8981\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\uff0c\u7528\u4e8e\u8bfb\u53d6\u5bf9\u8c61\u5b58\u50a8\u7684\u6570\u636e\uff0c\u6240\u4ee5\u8981\u6302\u8f7d\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\u6587\u4ef6\u3002</li> </ul>"},{"location":"chap11/65thanos_setup/#2-8-ruler","title":"2-8 \u5b89\u88c5 Ruler","text":"<p>\u51c6\u5907 Ruler \u90e8\u7f72\u914d\u7f6e thanos-ruler.yaml:</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-rule\n  name: thanos-rule\n  namespace: thanos\nspec:\n  clusterIP: None\n  ports:\n  - name: grpc\n    port: 10901\n    targetPort: grpc\n  - name: http\n    port: 10902\n    targetPort: http\n  selector:\n    app.kubernetes.io/name: thanos-rule\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-rule\n  name: thanos-rule\n  namespace: thanos\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-rule\n  serviceName: thanos-rule\n  podManagementPolicy: Parallel\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-rule\n    spec:\n      containers:\n      - args:\n        - rule\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:10902\n        - --rule-file=/etc/thanos/rules/*rules.yaml\n        - --objstore.config-file=/etc/thanos/objectstorage.yaml\n        - --data-dir=/var/thanos/rule\n        - --label=rule_replica=\"$(NAME)\"\n        - --alert.label-drop=\"rule_replica\"\n        - --query=dnssrv+_http._tcp.thanos-query.thanos.svc.cluster.local\n        env:\n        - name: NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        image: thanosio/thanos:v0.11.0\n        livenessProbe:\n          failureThreshold: 24\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 5\n        name: thanos-rule\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 10902\n          name: http\n        readinessProbe:\n          failureThreshold: 18\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          initialDelaySeconds: 10\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /var/thanos/rule\n          name: data\n          readOnly: false\n        - name: thanos-objectstorage\n          subPath: objectstorage.yaml\n          mountPath: /etc/thanos/objectstorage.yaml\n        - name: thanos-rules\n          mountPath: /etc/thanos/rules\n      volumes:\n      - name: thanos-objectstorage\n        secret:\n          secretName: thanos-objectstorage\n      - name: thanos-rules\n        configMap:\n          name: thanos-rules\n  volumeClaimTemplates:\n  - metadata:\n      labels:\n        app.kubernetes.io/name: thanos-rule\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 1Gi\n</code></pre> <p>\u518d\u51c6\u5907 Ruler \u914d\u7f6e\u6587\u4ef6 <code>thanos-ruler-config.yaml</code>:</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: thanos-rules\n  labels:\n    name: thanos-rules\n  namespace: thanos\ndata:\n  record.rules.yaml: |-\n    groups:\n    - name: k8s.rules\n      rules:\n      - expr: |\n          sum(rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])) by (namespace)\n        record: namespace:container_cpu_usage_seconds_total:sum_rate\n      - expr: |\n          sum(container_memory_usage_bytes{job=\"cadvisor\", image!=\"\", container!=\"\"}) by (namespace)\n        record: namespace:container_memory_usage_bytes:sum\n      - expr: |\n          sum by (namespace, pod, container) (\n            rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])\n          )\n        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate\n</code></pre> <p>\u914d\u7f6e\u5185\u5bb9\u4ec5\u4e3a\u793a\u4f8b\uff0c\u6839\u636e\u81ea\u8eab\u60c5\u51b5\u6765\u914d\u7f6e\uff0c\u683c\u5f0f\u57fa\u672c\u517c\u5bb9 Prometheus \u7684 rule \u914d\u7f6e\u683c\u5f0f\uff0c\u53c2\u8003: https://thanos.io/components/rule.md/#configuring-rules</p> <pre><code>kubectl apply -f thanos-ruler-config.yaml \nconfigmap/thanos-rules created\n</code></pre>"},{"location":"chap11/65thanos_setup/#2-9-compact","title":"2-9 \u5b89\u88c5 Compact","text":"<p>\u51c6\u5907 Compact \u90e8\u7f72\u914d\u7f6e thanos-compact.yaml:</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-compact\n  name: thanos-compact\n  namespace: thanos\nspec:\n  ports:\n  - name: http\n    port: 10902\n    targetPort: http\n  selector:\n    app.kubernetes.io/name: thanos-compact\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app.kubernetes.io/name: thanos-compact\n  name: thanos-compact\n  namespace: thanos\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: thanos-compact\n  serviceName: thanos-compact\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: thanos-compact\n    spec:\n      containers:\n      - args:\n        - compact\n        - --wait\n        - --objstore.config-file=/etc/thanos/objectstorage.yaml\n        - --data-dir=/var/thanos/compact\n        - --debug.accept-malformed-index\n        - --log.level=debug\n        - --retention.resolution-raw=90d\n        - --retention.resolution-5m=180d\n        - --retention.resolution-1h=360d\n        image: thanosio/thanos:v0.11.0\n        livenessProbe:\n          failureThreshold: 4\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-compact\n        ports:\n        - containerPort: 10902\n          name: http\n        readinessProbe:\n          failureThreshold: 20\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 5\n        terminationMessagePolicy: FallbackToLogsOnError\n        volumeMounts:\n        - mountPath: /var/thanos/compact\n          name: data\n          readOnly: false\n        - name: thanos-objectstorage\n          subPath: objectstorage.yaml\n          mountPath: /etc/thanos/objectstorage.yaml\n      terminationGracePeriodSeconds: 120\n      volumes:\n      - name: thanos-objectstorage\n        secret:\n          secretName: thanos-objectstorage\n  volumeClaimTemplates:\n  - metadata:\n      labels:\n        app.kubernetes.io/name: thanos-compact\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 1Gi\n      storageClassName: hostpath\n</code></pre> <ul> <li>Compact \u53ea\u80fd\u90e8\u7f72\u5355\u4e2a\u526f\u672c\uff0c\u56e0\u4e3a\u5982\u679c\u591a\u4e2a\u526f\u672c\u90fd\u53bb\u5bf9\u5bf9\u8c61\u5b58\u50a8\u7684\u6570\u636e\u505a\u538b\u7f29\u548c\u964d\u91c7\u6837\u7684\u8bdd\uff0c\u4f1a\u9020\u6210\u51b2\u7a81\u3002</li> <li>\u4f7f\u7528 StatefulSet \u90e8\u7f72\uff0c\u65b9\u4fbf\u81ea\u52a8\u521b\u5efa\u548c\u6302\u8f7d\u78c1\u76d8\u3002\u78c1\u76d8\u7528\u4e8e\u5b58\u653e\u4e34\u65f6\u6570\u636e\uff0c\u56e0\u4e3a Compact \u9700\u8981\u4e00\u4e9b\u78c1\u76d8\u7a7a\u95f4\u6765\u5b58\u653e\u6570\u636e\u5904\u7406\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u4e2d\u95f4\u6570\u636e\u3002</li> <li><code>--wait</code> \u8ba9 Compact \u4e00\u76f4\u8fd0\u884c\uff0c\u8f6e\u8be2\u65b0\u6570\u636e\u6765\u505a\u538b\u7f29\u548c\u964d\u91c7\u6837\u3002</li> <li>Compact \u4e5f\u9700\u8981\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\uff0c\u7528\u4e8e\u8bfb\u53d6\u5bf9\u8c61\u5b58\u50a8\u6570\u636e\u4ee5\u53ca\u4e0a\u4f20\u538b\u7f29\u548c\u964d\u91c7\u6837\u540e\u7684\u6570\u636e\u5230\u5bf9\u8c61\u5b58\u50a8\u3002</li> <li>\u521b\u5efa\u4e00\u4e2a\u666e\u901a service\uff0c\u4e3b\u8981\u7528\u4e8e\u88ab Prometheus \u4f7f\u7528 kubernetes \u7684 endpoints \u670d\u52a1\u53d1\u73b0\u6765\u91c7\u96c6\u6307\u6807(\u5176\u5b83\u7ec4\u4ef6\u7684 service \u4e5f\u4e00\u6837\u6709\u8fd9\u4e2a\u7528\u9014)\u3002</li> <li><code>--retention.resolution-raw</code> \u6307\u5b9a\u539f\u59cb\u6570\u636e\u5b58\u653e\u65f6\u957f\uff0c<ul> <li><code>--retention.resolution-5m</code> \u6307\u5b9a\u964d\u91c7\u6837\u5230\u6570\u636e\u70b9 5 \u5206\u949f\u95f4\u9694\u7684\u6570\u636e\u5b58\u653e\u65f6\u957f\uff0c</li> <li><code>--retention.resolution-1h</code> \u6307\u5b9a\u964d\u91c7\u6837\u5230\u6570\u636e\u70b9 1 \u5c0f\u65f6\u95f4\u9694\u7684\u6570\u636e\u5b58\u653e\u65f6\u957f\uff0c\u5b83\u4eec\u7684\u6570\u636e\u7cbe\u7ec6\u7a0b\u5ea6\u9012\u51cf\uff0c\u5360\u7528\u7684\u5b58\u50a8\u7a7a\u95f4\u4e5f\u662f\u9012\u51cf\uff0c\u901a\u5e38\u5efa\u8bae\u5b83\u4eec\u7684\u5b58\u653e\u65f6\u95f4\u9012\u589e\u914d\u7f6e (\u4e00\u822c\u53ea\u6709\u6bd4\u8f83\u65b0\u7684\u6570\u636e\u624d\u4f1a\u653e\u5927\u770b\uff0c\u4e45\u8fdc\u7684\u6570\u636e\u901a\u5e38\u53ea\u4f1a\u4f7f\u7528\u5927\u65f6\u95f4\u8303\u56f4\u67e5\u8be2\u6765\u770b\u4e2a\u5927\u81f4\uff0c\u6240\u4ee5\u5efa\u8bae\u5c06\u7cbe\u7ec6\u7a0b\u5ea6\u4f4e\u7684\u6570\u636e\u5b58\u653e\u66f4\u957f\u65f6\u95f4)</li> </ul> </li> </ul>"},{"location":"chap11/65thanos_setup/#2-10-quick-install-grafana","title":"2-10 Quick install grafana","text":"<pre><code>helm repo add bitnami https://charts.bitnami.com/bitnami\nhelm install grafana bitnami/grafana --namespace thanos\n</code></pre> <pre><code>echo \"User: admin\"\n    echo \"Password: $(kubectl get secret grafana-admin --namespace thanos -o jsonpath=\"{.data.GF_SECURITY_ADMIN_PASSWORD}\" | base64 --decode)\"\n</code></pre> <ul> <li>Password: iW7270HExB</li> </ul> <pre><code>kubectl port-forward svc/grafana 8083:3000 -n thanos\n</code></pre> <p>Add data source: thanos</p> <ul> <li><code>http://thanos-query.thanos.svc.cluster.local:9090</code></li> </ul> <p></p>"},{"location":"chap11/65thanos_setup/#3-receiver","title":"3 \u5b89\u88c5 Receiver","text":"<p>\u8be5\u7ec4\u4ef6\u5904\u4e8e\u8bd5\u9a8c\u9636\u6bb5\uff0c\u614e\u7528\u3002\u51c6\u5907 Receiver \u90e8\u7f72\u914d\u7f6e <code>thanos-receiver.yaml</code>:</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: thanos-receive-hashrings\n  namespace: thanos\ndata:\n  thanos-receive-hashrings.json: |\n    [\n      {\n        \"hashring\": \"soft-tenants\",\n        \"endpoints\":\n        [\n          \"thanos-receive-0.thanos-receive.kube-system.svc.cluster.local:10901\",\n          \"thanos-receive-1.thanos-receive.kube-system.svc.cluster.local:10901\",\n          \"thanos-receive-2.thanos-receive.kube-system.svc.cluster.local:10901\"\n        ]\n      }\n    ]\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: thanos-receive\n  namespace: thanos\n  labels:\n    kubernetes.io/name: thanos-receive\nspec:\n  ports:\n  - name: http\n    port: 10902\n    protocol: TCP\n    targetPort: 10902\n  - name: remote-write\n    port: 19291\n    protocol: TCP\n    targetPort: 19291\n  - name: grpc\n    port: 10901\n    protocol: TCP\n    targetPort: 10901\n  selector:\n    kubernetes.io/name: thanos-receive\n  clusterIP: None\n---\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    kubernetes.io/name: thanos-receive\n  name: thanos-receive\n  namespace: thanos\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      kubernetes.io/name: thanos-receive\n  serviceName: thanos-receive\n  template:\n    metadata:\n      labels:\n        kubernetes.io/name: thanos-receive\n    spec:\n      containers:\n      - args:\n        - receive\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:10902\n        - --remote-write.address=0.0.0.0:19291\n        - --objstore.config-file=/etc/thanos/objectstorage.yaml\n        - --tsdb.path=/var/thanos/receive\n        - --tsdb.retention=12h\n        - --label=receive_replica=\"$(NAME)\"\n        - --label=receive=\"true\"\n        - --receive.hashrings-file=/etc/thanos/thanos-receive-hashrings.json\n        - --receive.local-endpoint=$(NAME).thanos-receive.thanos.svc.cluster.local:10901\n        env:\n        - name: NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        image: thanosio/thanos:v0.11.0\n        livenessProbe:\n          failureThreshold: 4\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n          periodSeconds: 30\n        name: thanos-receive\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 10902\n          name: http\n        - containerPort: 19291\n          name: remote-write\n        readinessProbe:\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n          initialDelaySeconds: 10\n          periodSeconds: 30\n        resources:\n          limits:\n            cpu: \"4\"\n            memory: 8Gi\n          requests:\n            cpu: \"2\"\n            memory: 4Gi\n        volumeMounts:\n        - mountPath: /var/thanos/receive\n          name: data\n          readOnly: false\n        - mountPath: /etc/thanos/thanos-receive-hashrings.json\n          name: thanos-receive-hashrings\n          subPath: thanos-receive-hashrings.json\n        - mountPath: /etc/thanos/objectstorage.yaml\n          name: thanos-objectstorage\n          subPath: objectstorage.yaml\n      terminationGracePeriodSeconds: 120\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: thanos-receive-hashrings\n        name: thanos-receive-hashrings\n      - name: thanos-objectstorage\n        secret:\n          secretName: thanos-objectstorage\n  volumeClaimTemplates:\n  - metadata:\n      labels:\n        app.kubernetes.io/name: thanos-receive\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 200Gi\n</code></pre> <ul> <li>\u90e8\u7f72 3 \u4e2a\u526f\u672c\uff0c \u914d\u7f6e hashring\uff0c <code>--label=receive_replica</code> \u4e3a\u6570\u636e\u6dfb\u52a0 <code>receive_replica</code> \u8fd9\u4e2a label (Query \u7684 --query.replica-label \u4e5f\u8981\u52a0\u4e0a\u8fd9\u4e2a) \u6765\u5b9e\u73b0 Receiver \u7684\u9ad8\u53ef\u7528\u3002</li> <li>Query \u8981\u6307\u5b9a Receiver \u540e\u7aef\u5730\u5740: <code>--store=dnssrv+_grpc._tcp.thanos-receive.thanos.svc.cluster.local</code></li> <li>request, limit \u6839\u636e\u81ea\u8eab\u89c4\u6a21\u60c5\u51b5\u81ea\u884c\u505a\u9002\u5f53\u8c03\u6574\u3002</li> <li><code>--tsdb.retention</code> \u6839\u636e\u81ea\u8eab\u9700\u6c42\u8c03\u6574\u6700\u65b0\u6570\u636e\u7684\u4fdd\u7559\u65f6\u95f4\u3002</li> <li>\u5982\u679c\u6539\u547d\u540d\u7a7a\u95f4\uff0c\u8bb0\u5f97\u628a Receiver \u7684 <code>--receive.local-endpoint</code> \u53c2\u6570\u4e5f\u6539\u4e0b\uff0c\u4e0d\u7136\u4f1a\u75af\u72c2\u62a5\u9519\u76f4\u81f3 <code>OOMKilled</code>\u3002</li> </ul> <p>\u56e0\u4e3a\u4f7f\u7528\u4e86 Receiver \u6765\u7edf\u4e00\u63a5\u6536 Prometheus \u7684\u6570\u636e\uff0c\u6240\u4ee5 Prometheus \u4e5f\u4e0d\u9700\u8981 Sidecar \u4e86\uff0c\u4f46\u9700\u8981\u7ed9 Prometheus \u914d\u7f6e\u6587\u4ef6\u91cc\u52a0\u4e0b <code>remote_write</code>\uff0c\u8ba9 Prometheus \u5c06\u6570\u636e push \u7ed9 Receiver:</p> <pre><code>remote_write:\n- url: http://thanos-receive.thanos.svc.cluster.local:19291/api/v1/receive\n</code></pre>"},{"location":"chap11/65thanos_setup/#3-1-query","title":"3-1 \u6307\u5b9a Query \u4e3a\u6570\u636e\u6e90","text":"<p>\u67e5\u8be2\u76d1\u63a7\u6570\u636e\u65f6\u9700\u8981\u6307\u5b9a Prometheus \u6570\u636e\u6e90\u5730\u5740\uff0c\u7531\u4e8e\u6211\u4eec\u4f7f\u7528\u4e86 Thanos \u6765\u505a\u5206\u5e03\u5f0f\uff0c\u800c Thanos \u5173\u952e\u67e5\u8be2\u5165\u53e3\u5c31\u662f Query\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5c06\u6570\u636e\u6e90\u5730\u5740\u6307\u5b9a\u4e3a Query \u7684\u5730\u5740\uff0c\u5047\u5982\u4f7f\u7528 Grafana \u67e5\u8be2\uff0c\u8fdb\u5165 <code>Configuration-Data Sources-Add data source</code>\uff0c\u9009\u62e9 Prometheus\uff0c\u6307\u5b9a thanos query \u7684\u5730\u5740: </p> <p><code>http://thanos-query.thanos.svc.cluster.local:9090</code></p>"},{"location":"chap11/65thanos_setup/#_1","title":"\u603b\u7ed3","text":"<p>\u672c\u6587\u6559\u4e86\u5927\u5bb6\u5982\u4f55\u9009\u578b Thanos \u90e8\u7f72\u65b9\u6848\u5e76\u8be6\u7ec6\u8bb2\u89e3\u4e86\u5404\u4e2a\u7ec4\u4ef6\u7684\u5b89\u88c5\u65b9\u6cd5\uff0c\u5982\u679c\u4ed4\u7ec6\u9605\u8bfb\u5b8c\u672c\u7cfb\u5217\u6587\u7ae0\uff0c\u6211\u76f8\u4fe1\u4f60\u5df2\u7ecf\u6709\u80fd\u529b\u642d\u5efa\u5e76\u8fd0\u7ef4\u4e00\u5957\u5927\u578b\u76d1\u63a7\u7cfb\u7edf\u4e86\u3002</p>"},{"location":"chap11/66thanos_ruler/","title":"\u7b2c\u4e5d\u8282\uff082022\uff09Thanos Ruler\u7ec4\u4ef6\u7684\u4f7f\u7528","text":"<p>Thano Ruler \u7ec4\u4ef6\u662f\u7528\u4e8e\u8bc4\u4f30 Prometheus \u7684\u8bb0\u5f55\u89c4\u5219\u548c\u62a5\u8b66\u89c4\u5219\u7684\u7ec4\u4ef6\uff0c\u5176\u672c\u8eab\u4e0d\u4f1a\u6293\u53d6 metrics \u63a5\u53e3\u6570\u636e\uff0c\u800c\u662f\u901a\u8fc7 Query API \u4ece query \u7ec4\u4ef6\u5b9a\u671f\u5730\u83b7\u53d6\u6307\u6807\u6570\u636e\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u591a\u4e2a query \u5730\u5740\uff0c\u5219\u4f1a\u91c7\u7528\u8f6e\u8be2\u65b9\u5f0f\u83b7\u53d6\u3002</p> <p></p> <p>\u5176\u4e2d\u8bb0\u5f55\u89c4\u5219\u8bc4\u4f30\u751f\u6210\u7684\u6570\u636e\u4f1a\u4fdd\u5b58\u5728\u672c\u5730\uff0c\u5e76\u4e14\u5b9a\u671f\u5730\u626b\u63cf\u672c\u5730\u751f\u6210\u7684 TSDB \u6570\u636e\u5757\u4e0a\u4f20\u5230\u5bf9\u8c61\u5b58\u50a8\u6876\u4e2d\u4f5c\u4e3a\u5386\u53f2\u6570\u636e\u957f\u671f\u4fdd\u5b58\u3002\u540c\u65f6\u4e5f\u5b9e\u73b0\u4e86 Store API \u53ef\u7528\u4e8e\u67e5\u8be2\u672c\u5730\u4fdd\u5b58\u7684\u6570\u636e\u3002\u4e0e Prometheus \u8282\u70b9\u7c7b\u4f3c\uff0c\u6bcf\u4e2a ruler \u8282\u70b9\u90fd\u4f7f\u7528\u72ec\u7acb\u7684\u5b58\u50a8\uff0c\u53ef\u4ee5\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u526f\u672c\uff0c\u800c\u4e14\u9700\u8981\u4e3a\u6bcf\u4e2a\u526f\u672c\u5b9e\u4f8b\u5206\u914d\u4e0d\u540c\u7684\u6807\u7b7e\u4ee5\u4f5c\u533a\u5206\uff0c\u56e0\u4e3a store \u7ec4\u4ef6\u5728\u67e5\u8be2\u5bf9\u8c61\u5b58\u50a8\u4e2d\u7684\u5386\u53f2\u6570\u636e\u65f6\u662f\u4ee5\u8be5\u6807\u7b7e\u8fdb\u884c\u5206\u7ec4\u67e5\u8be2\u7684\u3002</p>"},{"location":"chap11/66thanos_ruler/#1","title":"1 \u5b89\u88c5","text":"<p>\u7531\u4e8e ruler \u7ec4\u4ef6\u4e5f\u5b9e\u73b0\u4e86 Store API\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5c06\u8be5\u7ec4\u4ef6\u5bf9\u63a5\u5230 store \u7ec4\u4ef6\u4e2d\u53bb\uff0c\u53ea\u9700\u8981\u7ed9\u521b\u5efa\u7684 Pod \u5e26\u4e0a <code>thanos-store-api: \"true\"</code> \u8fd9\u4e2a\u6807\u7b7e\u5373\u53ef\uff08Service \u4f1a\u8fdb\u884c\u81ea\u52a8\u5173\u8054\uff09\u88ab query \u7ec4\u4ef6\u670d\u52a1\u53d1\u73b0\u3002</p> <p>\u6574\u4f53\u4e0a\u6211\u4eec\u53ef\u4ee5\u628a ruler \u8282\u70b9\u7406\u89e3\u4e3a\u4e00\u4e2a\u7b80\u5355\u7684 Prometheus \u8282\u70b9\uff0c\u53ea\u662f\u4e0d\u9700\u8981 thanos sidecar\uff0c\u4e0d\u6293\u53d6\u6307\u6807\u6570\u636e\uff0c\u53ea\u8d1f\u8d23\u6267\u884c PromQL \u67e5\u8be2\uff0c\u7531\u4e8e\u672c\u8eab\u4f1a\u4fdd\u7559\u72ec\u7acb\u7684\u5b58\u50a8\uff0c\u6240\u4ee5\u540c\u6837\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u505a\u6570\u636e\u7684\u6301\u4e45\u5316\u3002</p> <p>\u7136\u540e\u53ef\u4ee5\u901a\u8fc7\u90e8\u7f72\u4e24\u4e2a\u526f\u672c\u6765\u5b9e\u73b0\u9ad8\u53ef\u7528\uff0c</p> <ul> <li>\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>--label=rule_replica</code> \u6807\u7b7e\u6765\u7ed9\u6570\u636e\u6dfb\u52a0\u4e00\u4e2a <code>rule_replica</code> \u7684\u6807\u7b7e, </li> <li>\u540c\u65f6\u6307\u5b9a <code>--alert.label-drop</code> \u4e3a <code>rule_replica</code>\uff0c\u8fd9\u6837\u5728\u89e6\u53d1\u544a\u8b66\u53d1\u9001\u901a\u77e5\u7ed9 AlertManager \u65f6\u53ef\u4ee5\u53bb\u6389\u8fd9\u4e2a label\uff0c\u4ee5\u4fbf\u8ba9 AlertManager \u81ea\u52a8\u53bb\u91cd\uff0c\u53ef\u4ee5\u907f\u514d\u91cd\u590d\u544a\u8b66\u3002</li> </ul> <p>\u7136\u540e\u901a\u8fc7 <code>--query</code> \u53c2\u6570\u6307\u5b9a query \u7ec4\u4ef6\u5730\u5740\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u4f7f\u7528 DNS SRV \u6765\u505a\u670d\u52a1\u53d1\u73b0\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4ece\u67e5\u8be2\u7ec4\u4ef6\u4e2d\u83b7\u53d6\u6307\u6807\u6570\u636e\u4e86\u3002</p> <p>ruler \u540c\u6837\u4e5f\u9700\u8981\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\uff0c\u7528\u4e8e\u4e0a\u4f20\u8ba1\u7b97\u51fa\u7684\u6570\u636e\u5230\u5bf9\u8c61\u5b58\u50a8\uff0c\u6240\u4ee5\u8981\u6302\u8f7d\u5bf9\u8c61\u5b58\u50a8\u7684\u914d\u7f6e\u6587\u4ef6\u3002<code>--rule-file</code> \u53c2\u6570\u53ef\u4ee5\u7528\u6765\u6307\u5b9a\u6302\u8f7d\u7684 rule \u914d\u7f6e\uff0c<code>ruler</code> \u7ec4\u4ef6\u4f1a\u6839\u636e\u914d\u7f6e\u6765\u751f\u6210\u6570\u636e\u548c\u89e6\u53d1\u62a5\u8b66\u3002</p> <p>\u5b8c\u6574\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># thanos-ruler.yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: thanos-ruler\n  namespace: kube-mon\n  labels:\n    app: thanos-ruler\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: thanos-ruler\n  serviceName: thanos-rule\n  podManagementPolicy: Parallel\n  template:\n    metadata:\n      labels:\n        app: thanos-ruler\n        thanos-store-api: \"true\"\n    spec:\n      affinity:\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n            - weight: 100\n              podAffinityTerm:\n                topologyKey: kubernetes.io/hostname\n                labelSelector:\n                  matchExpressions:\n                    - key: app\n                      operator: In\n                      values:\n                        - thanos-ruler\n      containers:\n      - name: thanos-ruler\n        image: thanosio/thanos:v0.25.1\n        args:\n        - rule\n        - --grpc-address=0.0.0.0:10901\n        - --http-address=0.0.0.0:10902\n        - --rule-file=/etc/thanos/rules/*rules.yaml\n        - --objstore.config-file=/etc/secret/thanos.yaml\n        - --data-dir=/var/thanos/rule\n        - --label=rule_replica=\"$(NAME)\"\n        - --alert.label-drop=rule_replica\n        - --query=dnssrv+_http._tcp.thanos-querier.kube-mon.svc.cluster.local\n        ports:\n        - containerPort: 10901\n          name: grpc\n        - containerPort: 10902\n          name: http\n        env:\n        - name: NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        livenessProbe:\n          httpGet:\n            path: /-/healthy\n            port: 10902\n            scheme: HTTP\n        readinessProbe:\n          httpGet:\n            path: /-/ready\n            port: 10902\n            scheme: HTTP\n        volumeMounts:\n        - mountPath: /var/thanos/rule\n          name: data\n          readOnly: false\n        - name: object-storage-config\n          mountPath: /etc/secret\n          readOnly: false\n        - name: thanos-rules\n          mountPath: /etc/thanos/rules\n      volumes:\n      - name: object-storage-config\n        secret:\n          secretName: thanos-objectstorage\n      - name: thanos-rules\n        configMap:\n          name: thanos-rules\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      storageClassName: longhorn\n      resources:\n        requests:\n          storage: 1Gi\n</code></pre> <p>\u8981\u6ce8\u610f\u4e0a\u9762\u6302\u8f7d\u7684\u5bf9\u8c61\u5b58\u50a8\u914d\u7f6e\u7684 Secret\uff0c\u53e6\u5916\u8fd8\u9700\u8981\u901a\u8fc7\u4e00\u4e2a ConfigMap \u6765\u914d\u7f6e rules \u89c4\u5219\uff1a</p> <pre><code># thanos-rules-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: thanos-rules\n  namespace: kube-mon\ndata:\n  record.rules.yaml: |-\n    groups:\n    - name: k8s.rules\n      rules:\n      - expr: |\n          sum(rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])) by (namespace)\n        record: namespace:container_cpu_usage_seconds_total:sum_rate\n      - expr: |\n          sum(container_memory_usage_bytes{job=\"cadvisor\", image!=\"\", container!=\"\"}) by (namespace)\n        record: namespace:container_memory_usage_bytes:sum\n      - expr: |\n          sum by (namespace, pod, container) (\n            rate(container_cpu_usage_seconds_total{job=\"cadvisor\", image!=\"\", container!=\"\"}[5m])\n          )\n        record: namespace_pod_container:container_cpu_usage_seconds_total:sum_rate\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u7b80\u5355\u914d\u7f6e\u4e86\u51e0\u4e2a\u8bb0\u5f55\u89c4\u5219\uff0c\u914d\u7f6e\u65b9\u5f0f\u548c\u4e4b\u524d\u7684\u89c4\u5219\u4e00\u6837\u7684\u3002\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>\u2638 \u279c kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-rules-config-0.yaml \n\u2638 \u279c kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-ruler-0.yaml \n\u2638 \u279c kubectl get pods -n kube-mon -l app=thanos-ruler\nNAME             READY   STATUS    RESTARTS   AGE\nthanos-ruler-0   1/1     Running   0          16m\nthanos-ruler-1   1/1     Running   0          16m\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b query \u7ec4\u4ef6\u9875\u9762\u7684 store \u4fe1\u606f\u662f\u5426\u5305\u542b\u4e0a\u9762\u7684 ruler \u5b9e\u4f8b\uff1a</p> <p></p> <p>\u540c\u6837\u5728 rules \u9875\u9762\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u5b9a\u4e49\u7684\u8bb0\u5f55\u89c4\u5219\u4fe1\u606f\uff1a</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u53bb\u67e5\u8be2\u4e0b\u4e0a\u9762\u7684\u8bb0\u5f55\u89c4\u5219\uff0c\u6bd4\u5982\u67e5\u8be2 </p> <p><code>namespace:container_cpu_usage_seconds_total:sum_rate</code>\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u6b63\u5e38\u83b7\u53d6\u5230\u8fd9\u6761\u8bb0\u5f55\u89c4\u5219\u7684\u6570\u636e\u3002</p>"},{"location":"chap11/66thanos_ruler/#2","title":"2 \u5bf9\u63a5\u544a\u8b66","text":"<p>\u5982\u679c\u8981\u8fdb\u884c\u62a5\u8b66\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u901a\u8fc7\u542f\u52a8\u53c2\u6570 <code>--alertmanagers.url</code> \u6765\u6307\u5b9a Alertmanager \u7684\u5730\u5740\uff0c\u5982\u679c\u9700\u8981\u66f4\u9ad8\u7ea7\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u542f\u52a8\u53c2\u6570 <code>--alertmanagers.config</code> \u6216\u8005 <code>--alertmanagers.config-file</code> \u6765\u6307\u5b9a\u5bf9\u63a5 <code>Alertmanager</code> \u7684\u914d\u7f6e\uff0c\u683c\u5f0f\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>alertmanagers:\n- http_config:\n    basic_auth:\n      username: \"\"\n      password: \"\"\n      password_file: \"\"\n    bearer_token: \"\"\n    bearer_token_file: \"\"\n    proxy_url: \"\"\n    tls_config:\n      ca_file: \"\"\n      cert_file: \"\"\n      key_file: \"\"\n      server_name: \"\"\n      insecure_skip_verify: false\n  static_configs: []\n  file_sd_configs:\n  - files: []\n    refresh_interval: 0s\n  scheme: http\n  path_prefix: \"\"\n  timeout: 10s\n  api_version: v1\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5bf9\u63a5\u524d\u9762\u7ae0\u8282\u4e2d\u7684 Alertmanager\uff0c\u5219\u76f4\u63a5\u8fd9\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5bb9\u5668\u542f\u52a8\u53c2\u6570\u4e2d\u589e\u52a0 <code>- --alertmanagers.url=http://alertmanager:9093</code> \u5373\u53ef\u3002\u7136\u540e\u5728\u4e0a\u9762\u7684 thanos-rules \u7684 ConfigMap \u4e2d\u65b0\u589e\u4e00\u4e2a <code>alert.rules.yaml</code> \u7684\u914d\u7f6e\uff0c\u7528\u6765\u914d\u7f6e\u62a5\u8b66\u89c4\u5219\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># thanos-rules-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: thanos-rules\n  namespace: kube-mon\ndata:\n  record.rules.yaml: |-\n  # ......\n  alert.rules.yaml: |-\n    groups:\n    - name: test-node-mem\n      rules:  \n      - alert: NodeMemoryUsage  \n        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 30\n        for: 1m\n        labels:\n          team: node\n          severity: critical\n        annotations:\n          summary: \"{{$labels.instance}}: High Memory usage detected\"\n          description: \"{{$labels.instance}}: Memory usage is above 30% (current value is: {{ $value }})\"\n</code></pre> <p>\u76f4\u63a5\u66f4\u65b0\u4e0a\u9762\u7684\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>\u2638 \u279c kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-rules-config.yaml \n\u2638 \u279c kubectl apply -f https://p8s.io/docs/thanos/manifests/thanos-ruler.yaml\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\u8fd9 query \u7684 rules \u9875\u9762\u4e5f\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u65b0\u589e\u7684\u62a5\u8b66\u89c4\u5219\u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u90e8\u7f72\u7684\u662f\u4e24\u4e2a\u526f\u672c\uff0c\u6240\u4ee5\u80fd\u770b\u5230\u4e24\u6761\u4e00\u6837\u7684\u89c4\u5219\uff1a</p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u8fd9 ruler \u7ec4\u4ef6\u542f\u52a8\u53c2\u6570\u4e2d\u914d\u7f6e\u4e86\u53c2\u6570 <code>- --alert.label-drop=rule_replica</code>\uff0c\u6240\u4ee5 Alertmanager \u4e2d\u4e0d\u4f1a\u6536\u5230\u91cd\u590d\u62a5\u8b66\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u7ecf\u6d4b\u8bd5\u8fd9\u91cc\u7684 <code>rule_replica</code> \u4e0d\u80fd\u52a0\u5f15\u53f7\uff0c\u52a0\u4e0a\u5f15\u53f7\u4f1a\u53bb\u91cd\u5931\u6548\uff0c\u6211\u4eec\u53ef\u4ee5\u524d\u5f80 Alertmanager \u67e5\u770b\u89e6\u53d1\u7684\u62a5\u8b66\u4fe1\u606f\uff1a</p> <p></p> <p>\u7531\u4e8e ruler \u7ec4\u4ef6\u83b7\u53d6\u8bc4\u4f30\u6570\u636e\u7684\u8def\u5f84\u662f <code>ruler --&gt; query --&gt; sidecar --&gt; prometheus</code>\uff0c\u9700\u8981\u7ecf\u6574\u4e2a\u67e5\u8be2\u94fe\u6761\uff0c\u8fd9\u4e5f\u63d0\u5347\u4e86\u53d1\u751f\u6545\u969c\u7684\u98ce\u9669\uff0c\u800c\u4e14\u8bc4\u4f30\u539f\u672c\u5c31\u53ef\u4ee5\u5728 Prometheus \u4e2d\u8fdb\u884c\uff0c\u6240\u4ee5\u5728\u975e\u5fc5\u8981\u7684\u60c5\u51b5\u4e0b\u66f4\u52a0\u63a8\u8350\u4f7f\u7528\u539f\u672c\u7684 Prometheus \u65b9\u5f0f\u6765\u505a\u62a5\u8b66\u548c\u8bb0\u5f55\u89c4\u5219\u7684\u8bc4\u4f30\u3002</p>"},{"location":"chap12/67vm_intro/","title":"\u7b2c\u4e00\u8282 Prometheus\u8fdc\u7a0b\u5b58\u50a8VictoriaMetrics\u7b80\u4ecb","text":"<p>VictoriaMetrics \u662f\u4e00\u4e2a\u5feb\u901f\u3001\u7ecf\u6d4e\u9ad8\u6548\u4e14\u53ef\u6269\u5c55\u7684\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\u548c\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\uff0c\u4e0d\u4ec5\u53ef\u4ee5\u4f5c\u4e3a Prometheus \u7684\u8fdc\u7a0b\u5b58\u50a8\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5176\u7ec4\u4ef6\u5b8c\u5168\u66ff\u6362 Prometheus\u3002</p> <p></p> <p>\u5b83\u4e3b\u8981\u6709\u4ee5\u4e0b\u7279\u6027:</p> <ul> <li>\u652f\u6301 Prometheus querying API,Graphite API. \u53ef\u4ee5\u5728 Grafana \u4e2d\u76f4\u63a5\u4f7f\u7528</li> <li>\u5b9e\u73b0\u4e86\u57fa\u4e8e PromQL \u7684\u67e5\u8be2\u8bed\u8a00 - MetricsQL, \u63d0\u4f9b\u4e86\u4e00\u4e9b\u9ad8\u7ea7\u529f\u80fd</li> <li>\u63d0\u4f9b\u4e86\u5168\u5c40\u89c6\u56fe\uff0c\u652f\u6301\u591a\u4e2a Prometheus \u5b9e\u4f8b\u6216\u4efb\u4f55\u5176\u4ed6\u6570\u636e\u6e90\u540c\u65f6\u5411 VictoriaMetrics \u5199\u5165\u6570\u636e\uff0c\u67e5\u8be2\u65f6\u6570\u636e\u53ef\u4ee5\u4fdd\u8bc1\u552f\u4e00</li> <li> <p>\u5360\u7528\u8d44\u6e90\u5c11\uff0c\u4e14\u9ad8\u6027\u80fd.</p> </li> <li> <p>\u652f\u6301\u591a\u79cd\u65b9\u5f0f\u83b7\u53d6 metrics. \u5982:</p> <ul> <li><code>file_sd_config</code></li> <li><code>kubernetes_sd_config</code></li> <li><code>consul_sd_config</code></li> <li>\u4ece exporter \u76f4\u63a5\u83b7\u53d6\uff0c\u4e0e prometheus \u5b8c\u5168\u517c\u5bb9\u3002\u9664 <code>static_config</code> \u5916\uff0c\u8fd8\u652f\u6301\u591a\u79cd\u670d\u52a1\u53d1\u73b0\u65b9\u5f0f\uff0c\u5982: <ul> <li>\u901a\u8fc7 Prometheus \u8fdc\u7a0b\u5199\u5165</li> <li>\u901a\u8fc7 Post \u8bf7\u6c42\u5c06\u6307\u5b9a JSON \u683c\u5f0f\u7684\u6570\u636e\u76f4\u63a5\u5199\u5165</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap12/67vm_intro/#2","title":"2 \u5355\u673a\u6a21\u5f0f","text":"<p>\u5355\u673a\u6a21\u5f0f\u6bd4\u8f83\u7b80\u5355\uff0c\u76f4\u63a5\u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6216 Docker \u955c\u50cf \u5e76\u4f7f\u7528\u6307\u5b9a\u7684\u547d\u4ee4\u884c\u542f\u52a8.</p> <p>\u5355\u673a\u6a21\u5f0f\u53ef\u80fd\u7528\u5230\u7684\u7ec4\u4ef6.</p> <pre><code>- victoria-metrics: metrics \u6570\u636e\u6293\u53d6\u6216\u5b58\u50a8\n- vmalert: \u6309\u7167\u6307\u5b9a\u7684\u89c4\u5219\u5c06 metrics \u6570\u636e\u805a\u5408\u6216\u5411 alertmanager \u53d1\u9001\u544a\u8b66\n- vmauth: \u542f\u7528\u7528\u6237\u8ba4\u8bc1\u529f\u80fd\n</code></pre> <p>\u4ee5\u4e8c\u8fdb\u5236\u4e3a\u4f8b\uff0c\u53ef\u4ee5\u901a\u8fc7</p> <ul> <li><code>-storageDataPath</code> \u53c2\u6570\u6307\u5b9a\u6570\u636e\u5b58\u50a8\u7684\u76ee\u5f55\u3002\u9ed8\u8ba4\u4e3a <code>victoria-metrics-data</code></li> <li><code>-retentionPeriod</code> \u53c2\u6570\u6307\u5b9a\u6570\u636e\u4fdd\u5b58\u7684\u65f6\u957f\u3002\u9ed8\u8ba4\u4e3a 1 month</li> <li><code>-httpListenAddr</code>\u53c2\u6570\u6307\u5b9a\u76d1\u542c\u7684 HTTP \u5957\u63a5\u5b57\u3002\u9ed8\u8ba4\u4e3a :8428</li> <li><code>-loggerTimezon</code> \u53c2\u6570\u6307\u5b9a\u65e5\u5fd7\u7684\u65f6\u533a\uff0c\u9ed8\u8ba4\u4e3a UTC. \u5efa\u8bae\u8bbe\u7f6e\u4e3a Asia/Shanghai</li> <li><code>-maxInsertRequestSize</code> \u53c2\u6570\u9650\u5236 <code>Prometheus remote_write API</code> \u7684\u8bf7\u6c42\u5927\u5c0f\u3002\u9ed8\u8ba4\u4e3a 33554432 byte. \u652f\u6301\u53ef\u9009\u7684\u5355\u4f4d\u4e3a KB, MB, GB, KiB, MiB, GiB</li> <li><code>-promscrape.config</code> \u53c2\u6570\u6307\u5b9a Prometheus \u914d\u7f6e\u6587\u4ef6\u8def\u5f84\u3002\u8be5\u914d\u7f6e\u6587\u4ef6\u53ea\u9700\u8981\u5305\u542b <code>scrape_configs</code> \u90e8\u5206\u914d\u7f6e\u5373\u53ef.(\u7ecf\u6d4b\u8bd5 <code>VictoriaMetrics</code> \u652f\u6301<code>scrape_configs</code> \u4e2d\u7684 <code>relabel_configs</code> \u548c <code>metric_relabel_configs</code> )</li> <li><code>-promscrape.config.strictParse</code> \u53c2\u6570\u8bbe\u7f6e\u662f\u5426\u4f1a\u4e25\u683c\u6821\u9a8c <code>-promscrape.config</code> \u6307\u5b9a\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e0d\u652f\u6301\u7684\u5b57\u6bb5\u4f1a\u8df3\u8fc7\uff0c\u517c\u5bb9 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6</li> <li><code>-promscrape.configCheckInterval</code> \u53c2\u6570\u8bbe\u7f6e\u68c0\u67e5 Prometheus \u914d\u7f6e\u6587\u4ef6\u662f\u5426\u53d8\u66f4\u7684\u65f6\u95f4\u95f4\u9694\u3002\u82e5\u53d8\u66f4\uff0c\u5219\u91cd\u65b0\u52a0\u8f7d\u3002\u9ed8\u8ba4\u5173\u95ed</li> <li><code>-relabelConfig</code> \u53c2\u6570\u6307\u5b9a relabel \u7684\u89c4\u5219.</li> <li><code>-relabelDebug</code> \u53c2\u6570\u6307\u5b9a\u65e5\u5fd7\u4e2d\u662f\u5426\u6307\u5b9a relabel \u524d\u540e\u7684 metrics. \u591a\u7528\u4e8e\u8c03\u8bd5.</li> <li><code>-selfScrapeInstance</code> \u53c2\u6570\u8bbe\u7f6e\u6293\u53d6\u81ea\u8eab metrics \u65f6\uff0cinstance \u6807\u7b7e\u7684\u503c\u3002\u9ed8\u8ba4 self</li> <li><code>-selfScrapeInterval</code> \u53c2\u6570\u8bbe\u7f6e\u6293\u53d6\u81ea\u8eab metrics \u7684\u65f6\u95f4\u95f4\u9694</li> <li><code>-selfScrapeJob</code> \u53c2\u6570\u8bbe\u7f6e\u8bbe\u7f6e\u6293\u53d6\u81ea\u8eab metrics \u65f6\uff0cinstance \u6807\u7b7e\u7684\u503c\u3002\u9ed8\u8ba4 <code>victoria-metrics</code></li> </ul> <p>\u4ece\u53c2\u6570\u770b\u6765\uff0c\u5355\u673a\u6a21\u5f0f\u4e0b\u7684 VictoriaMetrics \u53ef\u4ee5</p> <p>\u4f5c\u4e3a Prometheus \u7684\u8fdc\u7a0b\u5b58\u50a8</p> <p>\u542f\u52a8 VictoriaMetrics \u811a\u672c\u5982\u4e0b:</p> <pre><code># start_VictoriaMetrics.sh\ncd ${victoria-metrics-home}\n./victoria-metrics \\\n  -storageDataPath &lt;storageDataPath&gt; \\\n  -retentionPeriod &lt;dataKeepTime&gt; \\\n  -maxInsertRequestSize &lt;req_size&gt; \\\n  -httpListenAddr &lt;IP:port&gt; \\\n  -loggerTimezon Asia/Shanghai &amp;&gt; victoria-metrics.log &amp;\n</code></pre> <p>Prometheus \u8fdc\u7a0b\u5199\u5165\u76f8\u5173\u914d\u7f6e\u5982\u4e0b:</p> <pre><code># prometheus.yml\n# ...\nremote_write:\n  - url: http://&lt;victoriametrics-addr&gt;:8428/api/v1/write\n</code></pre> <ul> <li>\u6307\u5b9a <code>promscrape.config</code> \u76f4\u63a5\u6293\u53d6\u5e76\u5b58\u50a8 metrics.</li> </ul> <p>\u8fd9\u79cd\u65b9\u5f0f\u542f\u52a8\u4e0e\u4f5c\u4e3a\u8fdc\u7a0b\u5b58\u50a8\u542f\u52a8\u65b9\u5f0f\u57fa\u672c\u4e0e\u5b58\u50a8\u65b9\u5f0f\u5927\u540c\u5c0f\u5f02\uff0c\u53ea\u9700\u8981\u6307\u5b9a\u5bf9\u5e94\u914d\u7f6e\u6587\u4ef6\u5373\u53ef\u3002\u5728\u76f4\u63a5\u6293\u53d6 metrics \u8fc7\u7a0b\u4e2d\uff0c<code>VictoriaMetrics</code> \u9700\u8981\u4e00\u4e9b\u5176\u4ed6\u7684\u7ec4\u4ef6\u53bb\u5b9e\u73b0 Prometheus \u4e2d\u7684\u529f\u80fd\u3002\u6bd4\u5982</p> <ul> <li>Prometheus \u4e2d\u89c4\u5219 (\u5305\u62ec metrics \u805a\u5408\u89c4\u5219\u4e0e\u544a\u8b66\u89c4\u5219) \u9700\u8981 vmalert \u7ec4\u4ef6\u6765\u5b9e\u73b0\u3002\u4e14 <code>vmalert</code> \u53ea\u662f\u53d1\u9001\u544a\u8b66\u5230 <code>Alertmanager.vmalert</code> \u652f\u6301\u7684\u89c4\u5219\u4e0e Prometheus \u7684\u89c4\u5219\u4e00\u81f4\u3002\u6709\u5173 vmalert \u7684\u4f7f\u7528\uff0c\u53c2\u89c1\u5b98\u65b9\u6587\u6863</li> <li>Prometheus \u4e2d\u8ba4\u8bc1\u76f8\u914d\u7f6e \u9700\u8981 vmauth \u7ec4\u4ef6\u6765\u5b9e\u73b0\uff0c\u53c2\u89c1\u5b98\u65b9\u6587\u6863</li> </ul> <pre><code>cd ${victoria-metrics-home}\n\n./victoria-metrics \\\n  -storageDataPath &lt;storageDataPath&gt; \\\n  -retentionPeriod &lt;dataKeepTime&gt; \\\n  -maxInsertRequestSize &lt;req_size&gt; \\\n  -httpListenAddr &lt;metrics_IP:port&gt; \\\n  -promscrape.config &lt;prometheus.yml&gt; \\\n  -promscrape.configCheckInterval 1m \\\n  -loggerTimezon Asia/Shanghai &amp;&gt; victoria-metrics.log &amp;\n\n./vmalert \\\n  -httpListenAddr \":8880\" \\\n  -rule &lt;record_rule_file or alert_rule_file&gt; \\\n  -datasource.url &lt;metrics_IP:port&gt; \\\n  -notifier.url &lt;AlertManager URL&gt; \\ # AlertManager URL\n  -remoteWrite.url &lt;metrics_IP:port&gt; \\ # \u805a\u5408\u540e\u7684 metrics \u5199\u5165\u7684\u4f4d\u7f6e,\u4e00\u822c\u4e3a victoria-metrics \u7684\u7aef\u53e3\n  -remoteRead.url &lt;metrics_IP:port&gt; \\\n  -external.label &lt;key=value&gt; # \u4e3a\u805a\u5408\u540e\u7684 metrics \u6dfb\u52a0\u6807\u7b7e\n\n./vmauth \\\n  -httpListenAddr \":8427\" \\\n  -auth.config &lt;auth_config&gt;\n</code></pre> <p>\u4e3a\u4e86\u52a0\u5f3a\u6570\u636e\u7684\u5b89\u5168\u6027\uff0c\u53ef\u4ee5\u5c06 <code>victoria-metrics</code> \u5b58\u50a8\u76d1\u542c\u5728 localhost. \u542f\u7528 auth. \u914d\u7f6e\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7528\u6237\u4fe1\u606f. vmauth \u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\u5982\u4e0b. Grafana \u53ef\u4f7f\u7528\u8be5\u7528\u6237\u83b7\u53d6\u6570\u636e.</p>"},{"location":"chap12/67vm_intro/#3","title":"3 \u96c6\u7fa4\u6a21\u5f0f","text":"<p>VictoriaMetrics \u96c6\u7fa4\u6a21\u5f0f\u76f8\u5bf9\u6765\u8bf4\u6bd4\u8f83\u590d\u6742\u3002\u4e3b\u8981\u7531 vmstorage ,vminsert,vmselect \u4e09\u90e8\u5206\u7ec4\u6210\uff0c\u8fd9\u4e09\u4e2a\u7ec4\u4ef6\u6bcf\u4e2a\u7ec4\u4ef6\u90fd\u53ef\u4ee5\u5355\u72ec\u8fdb\u884c\u6269\u5c55\u3002\u5176\u4e2d:</p> <ul> <li>vmstorage \u8d1f\u8d23\u63d0\u4f9b\u6570\u636e\u5b58\u50a8\u670d\u52a1</li> <li>vminsert \u662f\u6570\u636e\u5b58\u50a8 vmstorage \u7684\u4ee3\u7406\uff0c\u4f7f\u7528\u4e00\u81f4\u6027 hash \u7b97\u6cd5\u8fdb\u884c\u5199\u5165\u5206\u7247</li> <li>vmselect \u8d1f\u8d23\u6570\u636e\u67e5\u8be2\uff0c\u6839\u636e\u8f93\u5165\u7684\u67e5\u8be2\u6761\u4ef6\u4ece vmstorage \u4e2d\u67e5\u8be2\u6570\u636e</li> </ul> <p>vmstorage \u91c7\u7528 shared-nothing \u67b6\u6784\uff0c\u4f18\u70b9\u662f vmstorage \u7684\u8282\u70b9\u76f8\u4e92\u4e4b\u95f4\u65e0\u611f\u77e5\uff0c\u76f8\u4e92\u4e4b\u95f4\u65e0\u9700\u901a\u4fe1\uff0c\u4e0d\u5171\u4eab\u4efb\u4f55\u6570\u636e\uff0c\u589e\u52a0\u4e86\u96c6\u7fa4\u7684\u53ef\u7528\u6027\uff0c\u7b80\u5316\u4e86\u96c6\u7fa4\u7684\u6269\u5c55\u7684\u96be\u5ea6\u4e0e\u8fd0\u7ef4\u5de5\u4f5c.</p>"},{"location":"chap12/67vm_intro/#3-1","title":"3-1 \u7279\u6027","text":"<p>VictoriaMetrics \u96c6\u7fa4\u6a21\u5f0f\u652f\u6301</p> <p>1 \u6027\u80fd\u548c\u5bb9\u91cf\u6c34\u5e73\u6269\u5c55</p> <ul> <li>vminsert \u548c vmselect \u662f\u65e0\u72b6\u6001\u7684\u3002\u53ef\u4ee5\u968f\u65f6\u6dfb\u52a0 / \u5220\u9664\u3002\u6dfb\u52a0\u66f4\u591a\u7684 vminsert \u548c vmselect \u8282\u70b9\u53ef\u4ee5\u6269\u5c55\u6570\u636e\u5199\u5165\u4e0e\u67e5\u8be2\u7684\u6548\u7387</li> <li>vmstorage \u8282\u70b9\u4fdd\u5b58\u6293\u53d6\u7684\u6570\u636e\uff0c\u56e0\u6b64\u65e0\u6cd5\u5728\u4e0d\u4e22\u5931\u6570\u636e\u7684\u60c5\u51b5\u4e0b\u5220\u9664\u5b83\u4eec\u3002\u6dfb\u52a0\u66f4\u591a vmstorage \u8282\u70b9\u53ef\u6269\u5c55\u96c6\u7fa4\u5bb9\u91cf\u3002\u6dfb\u52a0 vmstorage \u7684\u6b65\u9aa4\u5982\u4e0b:<ol> <li>\u4f7f\u7528\u4e0e\u96c6\u7fa4\u4e2d\u73b0\u6709\u8282\u70b9\u76f8\u540c\u7684 <code>-retentionPeriod</code> \u542f\u52a8\u65b0\u7684 vmstorage \u8282\u70b9</li> <li>\u4f7f\u7528\u5305\u542b <code>&lt;new_vmstorage_host&gt;</code> \u7684\u65b0 <code>-storageNode</code> \u53c2\u6570\u9010\u6e10\u91cd\u65b0\u542f\u52a8\u6240\u6709 <code>vmselect</code> \u8282\u70b9</li> <li>\u4f7f\u7528\u5305\u542b <code>&lt;new_vmstorage_host&gt;</code> \u7684\u65b0 <code>-storageNode</code> \u53c2\u6570\u9010\u6e10\u91cd\u65b0\u542f\u52a8\u6240\u6709 <code>vminsert</code> \u8282\u70b9</li> </ol> </li> </ul> <p>\u652f\u6301\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u7684\u591a\u4e2a\u540d\u79f0\u7a7a\u95f4 (\u79df\u6237). \u591a\u4e2a\u79df\u6237\u4e4b\u95f4\u76f8\u4e92\u9694\u79bb</p> <p>VictoriaMetrics \u96c6\u7fa4\u652f\u6301\u591a\u4e2a\u72ec\u7acb\u7684\u79df\u6237\u3002\u79df\u6237\u7531 accountID \u6216 <code>accountID:projectID</code>\u6807\u8bc6\uff0c\u4ed6\u4eec\u653e\u5728 url \u4e2d\u3002\u5982 </p> <p><code>http://&lt;vminsert&gt;:8480/insert/&lt;accountID&gt;/&lt;suffix&gt;,http://&lt;vmselect&gt;:8481/select/&lt;accountID&gt;/prometheus/&lt;suffix&gt;</code>.  \u7b49.</p> <ul> <li>\u6bcf\u4e2a accountID \u548c projectID \u7531\u8303\u56f4 <code>[0 .. 2^32)</code> \u4e2d\u7684\u4efb\u610f 32 \u4f4d\u6574\u6570\u6807\u8bc6\u3002\u5982\u679c\u4e0d\u6307\u5b9a\uff0c\u5219\u9ed8\u81ea\u52a8\u5206\u914d\u4e3a 0.</li> <li>\u5f53\u7b2c\u4e00\u4e2a\u6570\u636e\u70b9\u5199\u5165\u7ed9\u5b9a\u79df\u6237\u65f6\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u79df\u6237</li> <li>\u6240\u6709\u79df\u6237\u7684\u6570\u636e\u5747\u5300\u5206\u5e03\u5728\u53ef\u7528\u7684 vmstorage \u8282\u70b9\u4e2d\u3002\u8fd9\u4fdd\u8bc1\u4e86\u5f53\u4e0d\u540c\u79df\u6237\u5177\u6709\u4e0d\u540c\u7684\u6570\u636e\u91cf\u548c\u4e0d\u540c\u7684\u67e5\u8be2\u8d1f\u8f7d\u65f6\uff0cvmstorage \u8282\u70b9\u4e4b\u95f4\u7684\u8d1f\u8f7d\u5747\u5300</li> <li>\u6570\u636e\u5e93\u6027\u80fd\u4f9d\u8d56\u4e8e\u79df\u6237\u7684\u6570\u91cf\uff0c\u4e3b\u8981\u53d6\u51b3\u4e8e\u6240\u6709\u79df\u6237\u4e2d\u6d3b\u52a8\u7684\u65f6\u95f4\u5e8f\u5217\u7684\u603b\u6570.</li> <li>VictoriaMetrics \u4e0d\u652f\u6301\u5728\u5355\u4e2a\u8bf7\u6c42\u4e2d\u67e5\u8be2\u591a\u4e2a\u79df\u6237</li> </ul> <p>\u652f\u6301\u6570\u636e\u526f\u672c</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cVictoriaMetrics \u5c06\u526f\u672c\u5199\u5165\u5230 -storageDataPath \u6307\u5411\u7684\u5e95\u5c42\u5b58\u50a8.</p> <p>\u53ef\u4ee5\u901a\u8fc7 vminsert \u6307\u5b9a <code>-replicationFactor=N</code> \u6807\u5fd7\u4f4d\u6765\u542f\u7528\u6570\u636e\u526f\u672c\u3002\u8fd9\u4fdd\u8bc1\u5728\u6700\u591a N-1 \u4e2a vmstorage \u8282\u70b9\u4e0d\u53ef\u7528\u65f6\uff0c\u6240\u6709\u6570\u636e\u6254\u53ef\u7528\u4e8e\u67e5\u8be2\u3002\u96c6\u7fa4\u5fc5\u987b\u81f3\u5c11\u5305\u542b 2*N-1 \u4e2a vmstorage \u8282\u70b9.</p> <p>\u542f\u7528\u590d\u5236\u540e\uff0cvmselect \u5fc5\u987b\u6307\u5b9a <code>-dedup.minScrapeInterval=1ms</code> \u547d\u4ee4\u884c\u6807\u5fd7.</p>"},{"location":"chap12/67vm_intro/#3-2","title":"3-2 \u5feb\u901f\u90e8\u7f72","text":"<p>\u4f7f\u7528 3 \u4e2a\u8282\u70b9\u90e8\u7f72\u76f8\u5173\u670d\u52a1\u3002\u8282\u70b9 IP \u5206\u522b\u4e3a IP1, IP2, IP3</p> <p>\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u5982\u4e0b\u811a\u672c\u6765\u542f\u52a8 vmstroage,vminsert,vmselect</p> <pre><code>#!/bin/bash\n\nvictoria_home=\"/data1/victoria-metrics\"\nbin=${victoria_home}/bin\nconf=${victoria_home}/conf\ndata=${victoria_home}/data\nlog=${victoria_home}/log\n\nLOG_LEVEL=INFO\nTIMEZONE=\"Asia/Shanghai\"\n\ncd ${victoria_home}\n\n${bin}/vmstorage-prod \\\n  -httpListenAddr \"nodeIP:8482\" \\\n  -storageDataPath ${data} \\\n  -retentionPeriod 30d \\\n  -vminsertAddr \"nodeIP:8400\" \\  # insert \u7aef\u53e3,\u7531 vminsert \u8fde\u63a5\n  -vmselectAddr \"nodeIP:8401\" \\   # select \u7aef\u53e3,\u7531 vmselect \u8fde\u63a5\n  -loggerTimezone ${TIMEZONE} \\\n  -loggerLevel ${LOG_LEVEL} &amp;&gt; ${log}/storage.log &amp;\n\n${bin}/vminsert-prod \\\n  -httpListenAddr \"nodeIP:8480\" \\\n  -storageNode IP1:8400,IP2:8400,IP3:8400 \\\n  -loggerTimezone ${TIMEZONE} \\\n  -loggerLevel ${LOG_LEVEL} &amp;&gt; ${log}/insert.log &amp;\n\n${bin}/vmselect-prod \\\n  -httpListenAddr \"nodeIP:8481\" \\\n  -selectNode IP1:8481,IP2:8481,IP3:8481 \\\n  -storageNode IP1:8401,IP2:8401,IP3:8401 \\\n  -loggerTimezone ${TIMEZONE} \\\n  -loggerLevel ${LOG_LEVEL} &amp;&gt; ${log}/select.log &amp;\n</code></pre> <p>\u542f\u52a8\u540e\uff0c\u53ef\u4ee5\u5206\u522b\u914d\u7f6e Prometheus \u548c Grafana \u5bf9 metrics \u6570\u636e\u5199\u5165\u8bfb\u53d6\u3002\u8be6\u89c1\u5b98\u65b9\u6587\u6863</p> <pre><code># prometheus.yml\nremote_write:\n  - url: \"http://&lt;vminsert&gt;:8480/insert/&lt;accountID&gt;/&lt;suffix&gt;\"\n   # accountID \u9ed8\u8ba4\u4e3a 0\n   # suffix \u53ef\u4ee5\u4e3a `prometheus` \u6216 `prometheus/api/v1/write`\n    write_relabel_configs:\n      - source_labels: [__name__]\n        regex: 'go_.*'\n        action: drop\n</code></pre> <p>Grafana \u6570\u636e\u6e90\u5730\u5740\u53ef\u914d\u7f6e\u4e3a <code>http://&lt;vmselect&gt;:8481/select/&lt;accountID&gt;/prometheus</code>. \u6b64\u65f6 accountID \u5fc5\u987b\u4e0e prometheus.yml \u4e2d\u914d\u7f6e\u7684 accountID \u4e00\u81f4.</p> <p>\u6700\u540e\u53ef\u4f7f\u7528 vmauth \u5bf9\u6570\u636e\u8bfb\u53d6\u65f6\u8fdb\u884c\u9a8c\u8bc1\uff0c\u4fdd\u8bc1\u6570\u636e\u5b89\u5168\u6027.</p>"},{"location":"chap12/68vm_setup/","title":"\u7b2c\u4e8c\u8282 Prometheus\u957f\u671f\u8fdc\u7a0b\u5b58\u50a8\u65b9\u6848VictoriaMetrics\u5165\u95e8\u5b9e\u8df5","text":"<p>VictoriaMetrics(\u7b80\u79f0VM) \u662f\u4e00\u4e2a\u652f\u6301\u9ad8\u53ef\u7528\u3001\u7ecf\u6d4e\u9ad8\u6548\u4e14\u53ef\u6269\u5c55\u7684\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\u548c\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\uff0c\u53ef\u7528\u4e8e Prometheus \u76d1\u63a7\u6570\u636e\u505a\u957f\u671f\u8fdc\u7a0b\u5b58\u50a8\u3002</p> <p>\u524d\u9762\u7ae0\u8282\u6211\u4eec\u4ecb\u7ecd\u4e86 Thanos \u65b9\u6848\u4e5f\u53ef\u4ee5\u7528\u6765\u89e3\u51b3 Prometheus \u7684\u9ad8\u53ef\u7528\u548c\u8fdc\u7a0b\u5b58\u50a8\u7684\u95ee\u9898\uff0c\u90a3\u4e48\u4e3a\u4ec0\u4e48\u6211\u4eec\u8fd8\u8981\u4f7f\u7528 VictoriaMetrics \u5462\uff1f</p> <p>\u76f8\u5bf9\u4e8e Thanos\uff0cVictoriaMetrics \u4e3b\u8981\u662f\u4e00\u4e2a\u53ef\u6c34\u5e73\u6269\u5bb9\u7684\u672c\u5730\u5168\u91cf\u6301\u4e45\u5316\u5b58\u50a8\u65b9\u6848\uff0cVictoriaMetrics \u4e0d\u4ec5\u4ec5\u662f\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u5b83\u7684\u4f18\u52bf\u4e3b\u8981\u4f53\u73b0\u5728\u4ee5\u4e0b\u51e0\u70b9\u3002</p> <p>\u524d\u9762\u7ae0\u8282\u6211\u4eec\u4ecb\u7ecd\u4e86 Thanos \u65b9\u6848\u4e5f\u53ef\u4ee5\u7528\u6765\u89e3\u51b3 Prometheus \u7684\u9ad8\u53ef\u7528\u548c\u8fdc\u7a0b\u5b58\u50a8\u7684\u95ee\u9898\uff0c\u90a3\u4e48\u4e3a\u4ec0\u4e48\u6211\u4eec\u8fd8\u8981\u4f7f\u7528 VictoriaMetrics \u5462\uff1f</p> <p>\u76f8\u5bf9\u4e8e Thanos\uff0cVictoriaMetrics \u4e3b\u8981\u662f\u4e00\u4e2a\u53ef\u6c34\u5e73\u6269\u5bb9\u7684\u672c\u5730\u5168\u91cf\u6301\u4e45\u5316\u5b58\u50a8\u65b9\u6848\uff0cVictoriaMetrics \u4e0d\u4ec5\u4ec5\u662f\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u5b83\u7684\u4f18\u52bf\u4e3b\u8981\u4f53\u73b0\u5728\u4ee5\u4e0b\u51e0\u70b9\u3002</p> <ul> <li>\u5bf9\u5916\u652f\u6301 Prometheus \u76f8\u5173\u7684 API\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528\u4e8e Grafana \u4f5c\u4e3a Prometheus \u6570\u636e\u6e90\u4f7f\u7528</li> <li>\u6307\u6807\u6570\u636e\u6444\u53d6\u548c\u67e5\u8be2\u5177\u5907\u9ad8\u6027\u80fd\u548c\u826f\u597d\u7684\u53ef\u6269\u5c55\u6027\uff0c\u6027\u80fd\u6bd4 InfluxDB \u548c TimescaleDB \u9ad8\u51fa 20 \u500d</li> <li>\u8fd9\u5904\u7406\u9ad8\u57fa\u6570\u65f6\u95f4\u5e8f\u5217\u65f6\uff0c\u5185\u5b58\u65b9\u9762\u4e5f\u505a\u4e86\u4f18\u5316\uff0c\u6bd4 InfluxDB \u5c11 10x \u500d\uff0c\u6bd4 Prometheus\u3001Thanos \u6216 Cortex \u5c11 7 \u500d</li> <li>\u9ad8\u6027\u80fd\u7684\u6570\u636e\u538b\u7f29\u65b9\u5f0f\uff0c\u4e0e TimescaleDB \u76f8\u6bd4\uff0c\u53ef\u4ee5\u5c06\u591a\u8fbe 70 \u500d\u7684\u6570\u636e\u70b9\u5b58\u5165\u6709\u9650\u7684\u5b58\u50a8\u7a7a\u95f4\uff0c\u4e0e Prometheus\u3001Thanos \u6216 Cortex \u76f8\u6bd4\uff0c\u6240\u9700\u7684\u5b58\u50a8\u7a7a\u95f4\u51cf\u5c11 7 \u500d</li> <li>\u5b83\u9488\u5bf9\u5177\u6709\u9ad8\u5ef6\u8fdf IO \u548c\u4f4e IOPS \u7684\u5b58\u50a8\u8fdb\u884c\u4e86\u4f18\u5316</li> <li> <p>\u63d0\u4f9b\u5168\u5c40\u7684\u67e5\u8be2\u89c6\u56fe\uff0c\u591a\u4e2a Prometheus \u5b9e\u4f8b\u6216\u4efb\u4f55\u5176\u4ed6\u6570\u636e\u6e90\u53ef\u80fd\u4f1a\u5c06\u6570\u636e\u6444\u53d6\u5230 VictoriaMetrics</p> </li> <li> <p>\u64cd\u4f5c\u7b80\u5355</p> <ul> <li>VictoriaMetrics \u7531\u4e00\u4e2a\u6ca1\u6709\u5916\u90e8\u4f9d\u8d56\u7684\u5c0f\u578b\u53ef\u6267\u884c\u6587\u4ef6\u7ec4\u6210</li> <li>\u6240\u6709\u7684\u914d\u7f6e\u90fd\u662f\u901a\u8fc7\u660e\u786e\u7684\u547d\u4ee4\u884c\u6807\u5fd7\u548c\u5408\u7406\u7684\u9ed8\u8ba4\u503c\u5b8c\u6210\u7684</li> <li>\u6240\u6709\u6570\u636e\u90fd\u5b58\u50a8\u5728 - storageDataPath \u547d\u4ee4\u884c\u53c2\u6570\u6307\u5411\u7684\u76ee\u5f55\u4e2d</li> <li>\u53ef\u4ee5\u4f7f\u7528 vmbackup/vmrestore \u5de5\u5177\u8f7b\u677e\u5feb\u901f\u5730\u4ece\u5b9e\u65f6\u5feb\u7167\u5907\u4efd\u5230 S3 \u6216 GCS \u5bf9\u8c61\u5b58\u50a8\u4e2d</li> </ul> </li> <li> <p>\u652f\u6301\u4ece\u7b2c\u4e09\u65b9\u65f6\u5e8f\u6570\u636e\u5e93\u83b7\u53d6\u6570\u636e\u6e90</p> </li> <li>\u7531\u4e8e\u5b58\u50a8\u67b6\u6784\uff0c\u5b83\u53ef\u4ee5\u4fdd\u62a4\u5b58\u50a8\u5728\u975e\u6b63\u5e38\u5173\u673a\uff08\u5373 OOM\u3001\u786c\u4ef6\u91cd\u7f6e\u6216 kill -9\uff09\u65f6\u514d\u53d7\u6570\u636e\u635f\u574f</li> <li>\u540c\u6837\u652f\u6301\u6307\u6807\u7684 relabel \u64cd\u4f5c</li> </ul>"},{"location":"chap12/68vm_setup/#1","title":"1 \u67b6\u6784","text":"<p>VM \u5206\u4e3a\u5355\u8282\u70b9\u548c\u96c6\u7fa4\u4e24\u4e2a\u65b9\u6848\uff0c\u6839\u636e\u4e1a\u52a1\u9700\u6c42\u9009\u62e9\u5373\u53ef\u3002\u5355\u8282\u70b9\u7248\u76f4\u63a5\u8fd0\u884c\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u65e2\uff0c\u5b98\u65b9\u5efa\u8bae\u91c7\u96c6\u6570\u636e\u70b9(data points)\u4f4e\u4e8e 100w/s\uff0c\u63a8\u8350 VM \u5355\u8282\u70b9\u7248\uff0c\u7b80\u5355\u597d\u7ef4\u62a4\uff0c\u4f46\u4e0d\u652f\u6301\u544a\u8b66\u3002\u96c6\u7fa4\u7248\u652f\u6301\u6570\u636e\u6c34\u5e73\u62c6\u5206\u3002\u4e0b\u56fe\u662f VictoriaMetrics \u96c6\u7fa4\u7248\u5b98\u65b9\u7684\u67b6\u6784\u56fe\u3002</p> <p></p> <p>\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b\u51e0\u4e2a\u7ec4\u4ef6\uff1a</p> <ul> <li>vmstorage\uff1a\u6570\u636e\u5b58\u50a8\u4ee5\u53ca\u67e5\u8be2\u7ed3\u679c\u8fd4\u56de\uff0c\u9ed8\u8ba4\u7aef\u53e3\u4e3a 8482</li> <li>vminsert\uff1a\u6570\u636e\u5f55\u5165\uff0c\u53ef\u5b9e\u73b0\u7c7b\u4f3c\u5206\u7247\u3001\u526f\u672c\u529f\u80fd\uff0c\u9ed8\u8ba4\u7aef\u53e3 8480</li> <li>vmselect\uff1a\u6570\u636e\u67e5\u8be2\uff0c\u6c47\u603b\u548c\u6570\u636e\u53bb\u91cd\uff0c\u9ed8\u8ba4\u7aef\u53e3 8481</li> <li>vmagent\uff1a\u6570\u636e\u6307\u6807\u6293\u53d6\uff0c\u652f\u6301\u591a\u79cd\u540e\u7aef\u5b58\u50a8\uff0c\u4f1a\u5360\u7528\u672c\u5730\u78c1\u76d8\u7f13\u5b58\uff0c\u9ed8\u8ba4\u7aef\u53e3 8429</li> <li>vmalert\uff1a\u62a5\u8b66\u76f8\u5173\u7ec4\u4ef6\uff0c\u4e0d\u5982\u679c\u4e0d\u9700\u8981\u544a\u8b66\u529f\u80fd\u53ef\u4ee5\u4e0d\u4f7f\u7528\u8be5\u7ec4\u4ef6\uff0c\u9ed8\u8ba4\u7aef\u53e3\u4e3a 8880</li> </ul> <p>\u96c6\u7fa4\u65b9\u6848\u628a\u529f\u80fd\u62c6\u5206\u4e3a vmstorage\u3001 vminsert\u3001vmselect \u7ec4\u4ef6\uff0c\u5982\u679c\u8981\u66ff\u6362 Prometheus\uff0c\u8fd8\u9700\u8981\u4f7f\u7528 vmagent\u3001vmalert\u3002</p> <p>\u4ece\u4e0a\u56fe\u4e5f\u53ef\u4ee5\u770b\u51fa vminsert \u4ee5\u53ca vmselect \u90fd\u662f\u65e0\u72b6\u6001\u7684\uff0c\u6240\u4ee5\u6269\u5c55\u5f88\u7b80\u5355\uff0c\u53ea\u6709 vmstorage \u662f\u6709\u72b6\u6001\u7684\u3002</p> <p>vmagent \u7684\u4e3b\u8981\u76ee\u7684\u662f\u7528\u6765\u6536\u96c6\u6307\u6807\u6570\u636e\u7136\u540e\u5b58\u50a8\u5230 VM \u4ee5\u53ca Prometheus \u517c\u5bb9\u7684\u5b58\u50a8\u7cfb\u7edf\u4e2d\uff08\u652f\u6301 <code>remote_write</code> \u534f\u8bae\u5373\u53ef\uff09\u3002</p> <p>\u4e0b\u56fe\u662f vmagent \u7684\u4e00\u4e2a\u7b80\u5355\u67b6\u6784\u56fe\uff0c\u53ef\u4ee5\u770b\u51fa\u8be5\u7ec4\u4ef6\u4e5f\u5b9e\u73b0\u4e86 metrics \u7684 push \u529f\u80fd\uff0c\u6b64\u5916\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7279\u6027\uff1a</p> <ul> <li>\u66ff\u6362 prometheus \u7684 scraping target</li> <li>\u652f\u6301\u57fa\u4e8e prometheus relabeling \u7684\u6a21\u5f0f\u6dfb\u52a0\u3001\u79fb\u9664\u3001\u4fee\u6539 labels\uff0c\u53ef\u4ee5\u65b9\u4fbf\u5728\u6570\u636e\u53d1\u9001\u5230\u8fdc\u7aef\u5b58\u50a8\u4e4b\u524d\u8fdb\u884c\u6570\u636e\u7684\u8fc7\u6ee4</li> <li>\u652f\u6301\u591a\u79cd\u6570\u636e\u534f\u8bae\uff0cinflux line \u534f\u8bae\uff0cgraphite \u6587\u672c\u534f\u8bae\uff0copentsdb \u534f\u8bae\uff0cprometheus remote write \u534f\u8bae\uff0cjson lines \u534f\u8bae\uff0ccsv \u6570\u636e</li> <li>\u652f\u6301\u6536\u96c6\u6570\u636e\u7684\u540c\u65f6\uff0c\u5e76\u590d\u5236\u5230\u591a\u79cd\u8fdc\u7aef\u5b58\u50a8\u7cfb\u7edf</li> <li>\u652f\u6301\u4e0d\u53ef\u9760\u8fdc\u7aef\u5b58\u50a8\uff08\u901a\u8fc7\u672c\u5730\u5b58\u50a8 <code>~remoteWrite.tmpDataPath</code> )\uff0c\u540c\u65f6\u652f\u6301\u6700\u5927\u78c1\u76d8\u5360\u7528</li> <li>\u76f8\u6bd4 prometheus \u4f7f\u7528\u8f83\u5c11\u7684\u5185\u5b58\u3001cpu\u3001\u78c1\u76d8 io \u4ee5\u53ca\u7f51\u7edc\u5e26\u5bbd</li> </ul> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u5206\u522b\u6765\u4ecb\u7ecd\u4e86 VM \u7684\u5355\u8282\u70b9\u548c\u96c6\u7fa4\u4e24\u4e2a\u65b9\u6848\u7684\u4f7f\u7528\u3002</p>"},{"location":"chap12/68vm_setup/#2","title":"2 \u5355\u8282\u70b9","text":"<p>\u8fd9\u91cc\u6211\u4eec\u91c7\u96c6 node-exporter \u4e3a\u4f8b\u8fdb\u884c\u8bf4\u660e\uff0c\u9996\u5148\u4f7f\u7528 Prometheus \u91c7\u96c6\u6570\u636e\uff0c\u7136\u540e\u5c06 Prometheus \u6570\u636e\u8fdc\u7a0b\u5199\u5165 VM \u8fdc\u7a0b\u5b58\u50a8\uff0c\u7531\u4e8e VM \u63d0\u4f9b\u4e86 vmagent \u7ec4\u4ef6\uff0c\u6700\u540e\u6211\u4eec\u4f7f\u7528 VM \u6765\u5b8c\u5168\u66ff\u6362 Prometheus\uff0c\u53ef\u4ee5\u4f7f\u67b6\u6784\u66f4\u7b80\u5355\u3001\u66f4\u4f4e\u7684\u8d44\u6e90\u5360\u7528\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5c06\u6240\u6709\u8d44\u6e90\u8fd0\u884c\u5728 kube-vm \u547d\u540d\u7a7a\u95f4\u4e4b\u4e0b\uff1a</p> <pre><code>kubectl create ns kube-vm\n</code></pre> <p>\u9996\u5148\u6211\u4eec\u8fd9 <code>kube-vm</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u4f7f\u7528 DaemonSet \u63a7\u5236\u5668\u8fd0\u884c <code>node-exporter</code>\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># vm-node-exporter.yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\n  namespace: kube-vm\nspec:\n  selector:\n    matchLabels:\n      app: node-exporter\n  template:\n    metadata:\n      labels:\n        app: node-exporter\n    spec:\n      hostPID: true\n      hostIPC: true\n      hostNetwork: true\n      nodeSelector:\n        kubernetes.io/os: linux\n      containers:\n        - name: node-exporter\n          image: prom/node-exporter:v1.3.1\n          args:\n            - --web.listen-address=$(HOSTIP):9111\n            - --path.procfs=/host/proc\n            - --path.sysfs=/host/sys\n            - --path.rootfs=/host/root\n            - --no-collector.hwmon # \u7981\u7528\u4e0d\u9700\u8981\u7684\u4e00\u4e9b\u91c7\u96c6\u5668\n            - --no-collector.nfs\n            - --no-collector.nfsd\n            - --no-collector.nvme\n            - --no-collector.dmi\n            - --no-collector.arp\n            - --collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/containerd/.+|/var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)\n            - --collector.filesystem.ignored-fs-types=^(autofs|binfmt_misc|cgroup|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|mqueue|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|sysfs|tracefs)$\n          ports:\n            - containerPort: 9111\n          env:\n            - name: HOSTIP\n              valueFrom:\n                fieldRef:\n                  fieldPath: status.hostIP\n          resources:\n            requests:\n              cpu: 150m\n              memory: 180Mi\n            limits:\n              cpu: 150m\n              memory: 180Mi\n          securityContext:\n            runAsNonRoot: true\n            runAsUser: 65534\n          volumeMounts:\n            - name: proc\n              mountPath: /host/proc\n            - name: sys\n              mountPath: /host/sys\n            - name: root\n              mountPath: /host/root\n              mountPropagation: HostToContainer\n              readOnly: true\n      tolerations: # \u6dfb\u52a0\u5bb9\u5fcd\n        - operator: \"Exists\"\n      volumes:\n        - name: proc\n          hostPath:\n            path: /proc\n        - name: dev\n          hostPath:\n            path: /dev\n        - name: sys\n          hostPath:\n            path: /sys\n        - name: root\n          hostPath:\n            path: /\n</code></pre> <p>\u7531\u4e8e\u524d\u9762\u7ae0\u8282\u4e2d\u6211\u4eec\u4e5f\u521b\u5efa\u4e86 <code>node-exporter</code>\uff0c\u4e3a\u4e86\u9632\u6b62\u7aef\u53e3\u51b2\u7a81\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u53c2\u6570 <code>--web.listen-address=$(HOSTIP):9111</code> \u914d\u7f6e\u7aef\u53e3\u4e3a <code>9111</code>\u3002\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\u3002</p> <pre><code>kubectl apply -f vm-node-exporter.yaml\n\n\u2638 \u279c kubectl get pods -n kube-vm -owide\nNAME                  READY   STATUS    RESTARTS   AGE    IP              NODE      NOMINATED NODE   READINESS GATES\nnode-exporter-c4d76   1/1     Running   0          118s   192.168.0.109   node2     &lt;none&gt;           &lt;none&gt;\nnode-exporter-hzt8s   1/1     Running   0          118s   192.168.0.111   master1   &lt;none&gt;           &lt;none&gt;\nnode-exporter-zlxwb   1/1     Running   0          118s   192.168.0.110   node1     &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u90e8\u7f72\u4e00\u5957\u72ec\u7acb\u7684 Prometheus\uff0c\u4e3a\u4e86\u7b80\u5355\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 <code>static_configs</code> \u9759\u6001\u914d\u7f6e\u65b9\u5f0f\u6765\u6293\u53d6 <code>node-exporter</code> \u7684\u6307\u6807\uff0c\u914d\u7f6e\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># vm-prom-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-vm\ndata:\n  prometheus.yaml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n    scrape_configs:\n    - job_name: \"nodes\"\n      static_configs:\n      - targets: ['192.168.0.109:9111', '192.168.0.110:9111', '192.168.0.111:9111']\n      relabel_configs: # \u901a\u8fc7 relabeling \u4ece __address__ \u4e2d\u63d0\u53d6 IP \u4fe1\u606f\uff0c\u4e3a\u4e86\u540e\u9762\u9a8c\u8bc1 VM \u662f\u5426\u517c\u5bb9 relabeling\n      - source_labels: [__address__]\n        regex: \"(.*):(.*)\"\n        replacement: \"${1}\"\n        target_label: 'ip'\n        action: replace\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u4e2d\u901a\u8fc7 relabel \u64cd\u4f5c\u4ece <code>__address__</code> \u4e2d\u5c06 IP \u4fe1\u606f\u63d0\u53d6\u51fa\u6765\uff0c\u540e\u9762\u53ef\u4ee5\u7528\u6765\u9a8c\u8bc1 VM \u662f\u5426\u517c\u5bb9 relabel \u64cd\u4f5c\u3002</p> <p>\u540c\u6837\u8981\u7ed9 Prometheus \u6570\u636e\u505a\u6301\u4e45\u5316\uff0c\u6240\u4ee5\u4e5f\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 PVC \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code># apiVersion: storage.k8s.io/v1\n# kind: StorageClass\n# metadata:\n#   name: local-storage\n# provisioner: kubernetes.io/no-provisioner\n# volumeBindingMode: WaitForFirstConsumer\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: prometheus-data\nspec:\n  accessModes:\n    - ReadWriteOnce\n  capacity:\n    storage: 20Gi\n  storageClassName: local-storage\n  local:\n    path: /data/k8s/prometheus\n  persistentVolumeReclaimPolicy: Retain\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n        - matchExpressions:\n            - key: kubernetes.io/hostname\n              operator: In\n              values:\n                - node2\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: prometheus-data\n  namespace: kube-vm\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n  storageClassName: local-storage\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa Prometheus \u5373\u53ef\uff0c\u5c06\u4e0a\u9762\u7684 PVC \u548c ConfigMap \u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u901a\u8fc7 <code>--config.file</code> \u53c2\u6570\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\u6587\u4ef6\u8def\u5f84\uff0c\u6307\u5b9a TSDB \u6570\u636e\u8def\u5f84\u7b49\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># vm-prom-deploy.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: prometheus\n  namespace: kube-vm\nspec:\n  selector:\n    matchLabels:\n      app: prometheus\n  template:\n    metadata:\n      labels:\n        app: prometheus\n    spec:\n      volumes:\n        - name: data\n          persistentVolumeClaim:\n            claimName: prometheus-data\n        - name: config-volume\n          configMap:\n            name: prometheus-config\n      containers:\n        - image: prom/prometheus:v2.35.0\n          name: prometheus\n          args:\n            - \"--config.file=/etc/prometheus/prometheus.yaml\"\n            - \"--storage.tsdb.path=/prometheus\" # \u6307\u5b9atsdb\u6570\u636e\u8def\u5f84\n            - \"--storage.tsdb.retention.time=2d\"\n            - \"--web.enable-lifecycle\" # \u652f\u6301\u70ed\u66f4\u65b0\uff0c\u76f4\u63a5\u6267\u884clocalhost:9090/-/reload\u7acb\u5373\u751f\u6548\n          ports:\n            - containerPort: 9090\n              name: http\n          securityContext:\n            runAsUser: 0\n          volumeMounts:\n            - mountPath: \"/etc/prometheus\"\n              name: config-volume\n            - mountPath: \"/prometheus\"\n              name: data\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\n  namespace: kube-vm\nspec:\n  selector:\n    app: prometheus\n  type: NodePort\n  ports:\n    - name: web\n      port: 9090\n      targetPort: http\n</code></pre> <p>\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\u3002</p> <pre><code>\u2638 \u279c kubectl apply -f vm-prom-config.yaml\n\u2638 \u279c kubectl apply -f vm-prom-pvc.yaml\n\u2638 \u279c kubectl apply -f vm-prom-deploy.yaml\n\u2638 \u279c kubectl get pods -n kube-vm -owide\nNAME                      READY   STATUS    RESTARTS   AGE     IP              NODE      NOMINATED NODE   READINESS GATES\nnode-exporter-c4d76       1/1     Running   0          27m     192.168.0.109   node2     &lt;none&gt;           &lt;none&gt;\nnode-exporter-hzt8s       1/1     Running   0          27m     192.168.0.111   master1   &lt;none&gt;           &lt;none&gt;\nnode-exporter-zlxwb       1/1     Running   0          27m     192.168.0.110   node1     &lt;none&gt;           &lt;none&gt;\nprometheus-dfc9f6-2w2vf   1/1     Running   0          4m58s   10.244.2.102    node2     &lt;none&gt;           &lt;none&gt;\n\u2638 \u279c kubectl get svc -n kube-vm\nNAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\nprometheus   NodePort   10.103.38.114   &lt;none&gt;        9090:31890/TCP   4m10s\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u53ef\u4ee5\u901a\u8fc7 <code>http://&lt;node-ip&gt;:31890</code> \u8bbf\u95ee Prometheus\uff0c\u6b63\u5e38\u53ef\u4ee5\u770b\u5230\u91c7\u96c6\u7684 3 \u4e2a node \u8282\u70b9\u7684\u6307\u6807\u4efb\u52a1\u3002</p> <p></p> <p>\u540c\u6837\u7684\u65b9\u5f0f\u91cd\u65b0\u90e8\u7f72 Grafana\uff0c\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># vm-grafana.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: grafana\n  namespace: kube-vm\nspec:\n  selector:\n    matchLabels:\n      app: grafana\n  template:\n    metadata:\n      labels:\n        app: grafana\n    spec:\n      volumes:\n        - name: storage\n          persistentVolumeClaim:\n            claimName: grafana-data\n      containers:\n        - name: grafana\n          image: grafana/grafana:main\n          imagePullPolicy: IfNotPresent\n          ports:\n            - containerPort: 3000\n              name: grafana\n          securityContext:\n            runAsUser: 0\n          env:\n            - name: GF_SECURITY_ADMIN_USER\n              value: admin\n            - name: GF_SECURITY_ADMIN_PASSWORD\n              value: admin321\n          volumeMounts:\n            - mountPath: /var/lib/grafana\n              name: storage\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: grafana\n  namespace: kube-vm\nspec:\n  type: NodePort\n  ports:\n    - port: 3000\n  selector:\n    app: grafana\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: grafana-data\nspec:\n  accessModes:\n    - ReadWriteOnce\n  capacity:\n    storage: 1Gi\n  storageClassName: local-storage\n  local:\n    path: /data/k8s/grafana\n  persistentVolumeReclaimPolicy: Retain\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n        - matchExpressions:\n            - key: kubernetes.io/hostname\n              operator: In\n              values:\n                - node2\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: grafana-data\n  namespace: kube-vm\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n  storageClassName: local-storage\n</code></pre> <pre><code>\u2638 \u279c kubectl apply -f vm-grafana.yaml\n\u2638 \u279c kubectl get svc -n kube-vm |grep grafana\ngrafana      NodePort   10.97.111.153   &lt;none&gt;        3000:31800/TCP   62s\n</code></pre> <p>\u540c\u6837\u901a\u8fc7 <code>http://&lt;node-ip&gt;:31800</code> \u5c31\u53ef\u4ee5\u8bbf\u95ee Grafana \u4e86\uff0c\u8fdb\u5165 Grafana \u914d\u7f6e Prometheus \u6570\u636e\u6e90\u3002</p> <p></p> <p>\u7136\u540e\u5bfc\u5165 16098 \u8fd9\u4e2a Dashboard\uff0c\u5bfc\u5165\u540e\u6548\u679c\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p></p> <p>\u5230\u8fd9\u91cc\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Prometheus \u6536\u96c6\u8282\u70b9\u76d1\u63a7\u6307\u6807\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4f7f\u7528 VM \u6765\u6539\u9020\u73b0\u6709\u65b9\u6848\u3002</p>"},{"location":"chap12/68vm_setup/#3-victoriametrics","title":"3 \u8fdc\u7a0b\u5b58\u50a8 VictoriaMetrics","text":"<p>\u9996\u5148\u9700\u8981\u4e00\u4e2a\u5355\u8282\u70b9\u6a21\u5f0f\u7684 VM\uff0c\u8fd0\u884c VM \u5f88\u7b80\u5355\uff0c\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d\u5bf9\u5e94\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u542f\u52a8\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 docker \u955c\u50cf\u4e00\u952e\u542f\u52a8\uff0c\u6211\u4eec\u8fd9\u91cc\u540c\u6837\u90e8\u7f72\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u3002\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\u3002</p> <pre><code># vm-grafana.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: victoria-metrics\n  namespace: kube-vm\nspec:\n  selector:\n    matchLabels:\n      app: victoria-metrics\n  template:\n    metadata:\n      labels:\n        app: victoria-metrics\n    spec:\n      volumes:\n        - name: storage\n          persistentVolumeClaim:\n            claimName: victoria-metrics-data\n      containers:\n        - name: vm\n          image: victoriametrics/victoria-metrics:v1.76.1\n          imagePullPolicy: IfNotPresent\n          args:\n            - -storageDataPath=/var/lib/victoria-metrics-data\n            - -retentionPeriod=1w\n          ports:\n            - containerPort: 8428\n              name: http\n          volumeMounts:\n            - mountPath: /var/lib/victoria-metrics-data\n              name: storage\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: victoria-metrics\n  namespace: kube-vm\nspec:\n  type: NodePort\n  ports:\n    - port: 8428\n  selector:\n    app: victoria-metrics\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: victoria-metrics-data\nspec:\n  accessModes:\n    - ReadWriteOnce\n  capacity:\n    storage: 20Gi\n  storageClassName: local-storage\n  local:\n    path: /data/k8s/vm\n  persistentVolumeReclaimPolicy: Retain\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n        - matchExpressions:\n            - key: kubernetes.io/hostname\n              operator: In\n              values:\n                - node2\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: victoria-metrics-data\n  namespace: kube-vm\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n  storageClassName: local-storage\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 <code>-storageDataPath</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6570\u636e\u5b58\u50a8\u76ee\u5f55\uff0c\u7136\u540e\u540c\u6837\u5c06\u8be5\u76ee\u5f55\u8fdb\u884c\u4e86\u6301\u4e45\u5316\uff0c-<code>retentionPeriod</code> \u53c2\u6570\u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u6570\u636e\u7684\u4fdd\u6301\u5468\u671f\u3002\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\u3002</p> <pre><code>\u2638 \u279c kubectl apply -f vm-single-node-deploy.yaml\n\u2638 \u279c kubectl get svc victoria-metrics -n kube-vm\nNAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nvictoria-metrics   NodePort   10.106.216.248   &lt;none&gt;        8428:31953/TCP   75m\n\u2638 \u279c kubectl get pods -n kube-vm -l app=victoria-metrics\nNAME                                READY   STATUS    RESTARTS   AGE\nvictoria-metrics-57d47f4587-htb88   1/1     Running   0          3m12s\n\u2638 \u279c kubectl logs -f victoria-metrics-57d47f4587-htb88 -n kube-vm\n2022-04-22T08:59:14.431Z        info    VictoriaMetrics/lib/logger/flag.go:12   build version: victoria-metrics-20220412-134346-tags-v1.76.1-0-gf8de318bf\n2022-04-22T08:59:14.431Z        info    VictoriaMetrics/lib/logger/flag.go:13   command line flags\n2022-04-22T08:59:14.431Z        info    VictoriaMetrics/lib/logger/flag.go:20   flag \"retentionPeriod\"=\"1w\"\n2022-04-22T08:59:14.431Z        info    VictoriaMetrics/lib/logger/flag.go:20   flag \"storageDataPath\"=\"/var/lib/victoria-metrics-data\"\n2022-04-22T08:59:14.431Z        info    VictoriaMetrics/app/victoria-metrics/main.go:52 starting VictoriaMetrics at \":8428\"...\n2022-04-22T08:59:14.432Z        info    VictoriaMetrics/app/vmstorage/main.go:97        opening storage at \"/var/lib/victoria-metrics-data\" with -retentionPeriod=1w\n......\n2022-04-22T08:59:14.449Z        info    VictoriaMetrics/app/victoria-metrics/main.go:61 started VictoriaMetrics in 0.017 seconds\n2022-04-22T08:59:14.449Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:91 starting http server at http://127.0.0.1:8428/\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5355\u8282\u70b9\u7684 VictoriaMetrics \u5c31\u90e8\u7f72\u6210\u529f\u4e86\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ea\u9700\u8981\u5728 Prometheus \u4e2d\u914d\u7f6e\u8fdc\u7a0b\u5199\u5165\u6211\u4eec\u7684 VM \u5373\u53ef\uff0c\u66f4\u6539 Prometheus \u914d\u7f6e\uff1a</p> <pre><code># vm-prom-config2.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-vm\ndata:\n  prometheus.yaml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n    remote_write:    # \u8fdc\u7a0b\u5199\u5165\u5230\u8fdc\u7a0b VM \u5b58\u50a8\n    - url: http://victoria-metrics:8428/api/v1/write\n    scrape_configs:\n    - job_name: \"nodes\"\n      static_configs:\n      - targets: ['192.168.0.109:9111', '192.168.0.110:9111', '192.168.0.111:9111']\n      relabel_configs: # \u901a\u8fc7 relabeling \u4ece __address__ \u4e2d\u63d0\u53d6 IP \u4fe1\u606f\uff0c\u4e3a\u4e86\u540e\u9762\u9a8c\u8bc1 VM \u662f\u5426\u517c\u5bb9 relabeling\n      - source_labels: [__address__]\n        regex: \"(.*):(.*)\"\n        replacement: \"${1}\"\n        target_label: 'ip'\n        action: replace\n</code></pre> <p>\u91cd\u65b0\u66f4\u65b0 Prometheus \u7684\u914d\u7f6e\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>\u2638 \u279c kubectl apply -f vm-prom-config2.yaml\n# \u66f4\u65b0\u540e\u6267\u884c reload \u64cd\u4f5c\u91cd\u65b0\u52a0\u8f7d prometheus \u914d\u7f6e\n\u2638 \u279c curl -X POST \"http://192.168.0.111:31890/-/reload\"\n</code></pre> <p>\u914d\u7f6e\u751f\u6548\u540e Prometheus \u5c31\u4f1a\u5f00\u59cb\u5c06\u6570\u636e\u8fdc\u7a0b\u5199\u5165 VM \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b VM \u7684\u6301\u4e45\u5316\u6570\u636e\u76ee\u5f55\u662f\u5426\u6709\u6570\u636e\u4ea7\u751f\u6765\u9a8c\u8bc1\uff1a</p> <pre><code>\u2638 \u279c ll /data/k8s/vm/data/\ntotal 0\ndrwxr-xr-x 4 root root 38 Apr 22 17:15 big\n-rw-r--r-- 1 root root  0 Apr 22 16:59 flock.lock\ndrwxr-xr-x 4 root root 38 Apr 22 17:15 small\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53bb\u76f4\u63a5\u5c06 Grafana \u4e2d\u7684\u6570\u636e\u6e90\u5730\u5740\u4fee\u6539\u6210 VM \u7684\u5730\u5740\uff1a</p> <p></p> <p>\u4fee\u6539\u5b8c\u6210\u540e\u91cd\u65b0\u8bbf\u95ee node-exporter \u7684 dashboard\uff0c\u6b63\u5e38\u53ef\u4ee5\u663e\u793a\uff0c\u8bc1\u660e VM \u662f\u517c\u5bb9\u7684\u3002</p> <p></p>"},{"location":"chap12/68vm_setup/#prometheus","title":"\u66ff\u6362 Prometheus","text":"<p>\u4e0a\u9762\u6211\u4eec\u5c06 Prometheus \u6570\u636e\u8fdc\u7a0b\u5199\u5165\u5230\u4e86 VM\uff0c\u4f46\u662f Prometheus \u5f00\u542f remote write \u529f\u80fd\u540e\u4f1a\u589e\u52a0\u5176\u672c\u8eab\u7684\u8d44\u6e90\u5360\u7528\uff0c\u7406\u8bba\u4e0a\u5176\u5b9e\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b8c\u5168\u7528 VM \u6765\u66ff\u6362\u6389 Prometheus\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u8fdc\u7a0b\u5199\u5165\u4e86\uff0c\u800c\u4e14\u672c\u8eab VM \u5c31\u6bd4 Prometheus \u5360\u7528\u66f4\u5c11\u7684\u8d44\u6e90\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5148\u505c\u6389 Prometheus \u7684\u670d\u52a1\uff1a</p> <pre><code>\u2638 \u279c kubectl scale deploy prometheus --replicas=0 -n kube-vm\n</code></pre> <p>\u7136\u540e\u5c06 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\u6302\u8f7d\u5230 VM \u5bb9\u5668\u4e2d\uff0c\u4f7f\u7528\u53c2\u6570 <code>-promscrape.config</code> \u6765\u6307\u5b9a Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># vm-single-node-deploy2.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: victoria-metrics\n  namespace: kube-vm\nspec:\n  selector:\n    matchLabels:\n      app: victoria-metrics\n  template:\n    metadata:\n      labels:\n        app: victoria-metrics\n    spec:\n      volumes:\n        - name: storage\n          persistentVolumeClaim:\n            claimName: victoria-metrics-data\n        - name: prometheus-config\n          configMap:\n            name: prometheus-config\n      containers:\n        - name: vm\n          image: victoriametrics/victoria-metrics:v1.76.1\n          imagePullPolicy: IfNotPresent\n          args:\n            - -storageDataPath=/var/lib/victoria-metrics-data\n            - -retentionPeriod=1w\n            - -promscrape.config=/etc/prometheus/prometheus.yaml\n          ports:\n            - containerPort: 8428\n              name: http\n          volumeMounts:\n            - mountPath: /var/lib/victoria-metrics-data\n              name: storage\n            - mountPath: /etc/prometheus\n              name: prometheus-config\n</code></pre> <p>\u8bb0\u5f97\u5148\u5c06 Prometheus \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 <code>remote_write</code> \u6a21\u5757\u53bb\u6389\uff0c\u7136\u540e\u91cd\u65b0\u66f4\u65b0 VM \u5373\u53ef\uff1a</p> <pre><code>\n\u2638 \u279c kubectl apply -f vm-prom-config.yaml\n\u2638 \u279c kubectl apply -f vm-single-node-deploy2.yaml\n\u2638 \u279c kubectl get pods -n kube-vm -l app=victoria-metrics\nNAME                                READY   STATUS    RESTARTS       AGE\nvictoria-metrics-8466844968-ncfnp   1/1     Running   2 (3m3s ago)   3m45s\n\u2638 \u279c kubectl logs -f victoria-metrics-8466844968-ncfnp -n kube-vm\n......\n2022-04-22T10:01:59.837Z        info    VictoriaMetrics/app/victoria-metrics/main.go:61 started VictoriaMetrics in 0.022 seconds\n2022-04-22T10:01:59.837Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:91 starting http server at http://127.0.0.1:8428/\n2022-04-22T10:01:59.837Z        info    VictoriaMetrics/lib/httpserver/httpserver.go:92 pprof handlers are exposed at http://127.0.0.1:8428/debug/pprof/\n2022-04-22T10:01:59.838Z        info    VictoriaMetrics/lib/promscrape/scraper.go:103   reading Prometheus configs from \"/etc/prometheus/prometheus.yaml\"\n2022-04-22T10:01:59.838Z        info    VictoriaMetrics/lib/promscrape/config.go:96     starting service discovery routines...\n2022-04-22T10:01:59.839Z        info    VictoriaMetrics/lib/promscrape/config.go:102    started service discovery routines in 0.000 seconds\n2022-04-22T10:01:59.840Z        info    VictoriaMetrics/lib/promscrape/scraper.go:395   static_configs: added targets: 3, removed targets: 0; total targets: 3\n</code></pre> <p>\u4ece VM \u65e5\u5fd7\u4e2d\u53ef\u4ee5\u770b\u51fa\u6210\u529f\u8bfb\u53d6\u4e86 Prometheus \u7684\u914d\u7f6e\uff0c\u5e76\u6293\u53d6\u4e86 3 \u4e2a\u6307\u6807\uff08node-exporter\uff09\u3002\u73b0\u5728\u6211\u4eec\u518d\u53bb Grafana \u67e5\u770b node-exporter \u7684 Dashboard \u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u663e\u793a\u3002\u5148\u4fdd\u8bc1\u6570\u636e\u6e90\u662f VM \u7684\u5730\u5740\u3002</p> <p></p> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u4f7f\u7528 VM \u66ff\u6362\u6389\u4e86 Prometheus\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u8fd9 Grafana \u7684 Explore \u9875\u9762\u53bb\u63a2\u7d22\u91c7\u96c6\u5230\u7684\u6307\u6807\u3002</p> <p></p>"},{"location":"chap12/68vm_setup/#4-ui","title":"4 UI \u754c\u9762","text":"<p>VM \u5355\u8282\u70b9\u7248\u672c\u672c\u8eab\u81ea\u5e26\u4e86\u4e00\u4e2a Web UI \u754c\u9762 - vmui\uff0c\u4e0d\u8fc7\u76ee\u524d\u529f\u80fd\u6bd4\u8f83\u7b80\u5355\uff0c\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 VM \u7684 NodePort \u7aef\u53e3\u8fdb\u884c\u8bbf\u95ee\u3002</p> <pre><code>\u2638 \u279c kubectl get svc victoria-metrics -n kube-vm\nNAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nvictoria-metrics   NodePort   10.106.216.248   &lt;none&gt;        8428:31953/TCP   75m\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u901a\u8fc7 http://:31953 \u8bbf\u95ee\u5230 vmui\uff1a <p></p> <p>\u53ef\u4ee5\u901a\u8fc7 /vmui \u8fd9\u4e2a endpoint \u8bbf\u95ee UI \u754c\u9762\uff1a</p> <p></p> <p>\u5982\u679c\u4f60\u60f3\u67e5\u770b\u91c7\u96c6\u5230\u7684\u6307\u6807 targets\uff0c\u90a3\u4e48\u53ef\u4ee5\u901a\u8fc7 <code>/targets</code> \u8fd9\u4e2a endpoint \u6765\u83b7\u53d6\uff1a</p> <p></p> <p>\u8fd9\u4e9b\u529f\u80fd\u57fa\u672c\u4e0a\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u4e00\u4e9b\u9700\u6c42\uff0c\u4f46\u662f\u8fd8\u662f\u592a\u8fc7\u7b80\u5355\uff0c\u5982\u679c\u4f60\u4e60\u60ef\u4e86 Prometheus \u7684 UI \u754c\u9762\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 promxy \u6765\u4ee3\u66ff vmui\uff0c\u800c\u4e14 promxy \u8fd8\u53ef\u4ee5\u8fdb\u884c\u591a\u4e2a VM \u5355\u8282\u70b9\u7684\u6570\u636e\u805a\u5408\uff0c\u4ee5\u53ca targets \u67e5\u770b\u7b49\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>\n# vm-promxy.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: promxy-config\n  namespace: kube-vm\ndata:\n  config.yaml: |\n    promxy:\n      server_groups:\n      - static_configs:\n        - targets: [victoria-metrics:8428]  # \u6307\u5b9avm\u5730\u5740\uff0c\u6709\u591a\u4e2a\u5219\u5f80\u540e\u8ffd\u52a0\u5373\u53ef\n        path_prefix: /prometheus  # \u914d\u7f6e\u524d\u7f00\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: promxy\n  namespace: kube-vm\nspec:\n  selector:\n    matchLabels:\n      app: promxy\n  template:\n    metadata:\n      labels:\n        app: promxy\n    spec:\n      containers:\n        - args:\n            - \"--config=/etc/promxy/config.yaml\"\n            - \"--web.enable-lifecycle\"\n            - \"--log-level=trace\"\n          env:\n            - name: ROLE\n              value: \"1\"\n          command:\n            - \"/bin/promxy\"\n          image: quay.io/jacksontj/promxy\n          imagePullPolicy: Always\n          name: promxy\n          ports:\n            - containerPort: 8082\n              name: web\n          volumeMounts:\n            - mountPath: \"/etc/promxy/\"\n              name: promxy-config\n              readOnly: true\n        - args: # container to reload configs on configmap change\n            - \"--volume-dir=/etc/promxy\"\n            - \"--webhook-url=http://localhost:8082/-/reload\"\n          image: jimmidyson/configmap-reload:v0.1\n          name: promxy-server-configmap-reload\n          volumeMounts:\n            - mountPath: \"/etc/promxy/\"\n              name: promxy-config\n              readOnly: true\n      volumes:\n        - configMap:\n            name: promxy-config\n          name: promxy-config\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: promxy\n  namespace: kube-vm\nspec:\n  type: NodePort\n  ports:\n    - port: 8082\n  selector:\n    app: promxy\n</code></pre> <p>\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>\n\u2638 \u279c kubectl apply -f vm-promxy.yaml\n\u2638 \u279c kubectl get pods -n kube-vm -l app=promxy\nNAME                      READY   STATUS    RESTARTS   AGE\npromxy-5f7dfdbc64-l4kjq   2/2     Running   0          6m45s\n\u2638 \u279c kubectl get svc promxy -n kube-vm\nNAME               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\npromxy             NodePort   10.110.19.254    &lt;none&gt;        8082:30618/TCP   6m12s\n</code></pre> <p>\u8bbf\u95ee Promxy \u7684\u9875\u9762\u6548\u679c\u548c Prometheus \u81ea\u5e26\u7684 Web UI \u57fa\u672c\u4e00\u81f4\u7684\u3002</p> <p></p>"},{"location":"chap12/69vm_cluster/","title":"\u7b2c\u4e09\u8282 VictorialMetrics \u96c6\u7fa4\u6a21\u5f0f\u7684\u4f7f\u7528","text":"<p>\u5355\u8282\u70b9\u7248\u672c\u53ef\u6839\u636e CPU \u5185\u6838\u3001RAM \u548c\u53ef\u7528\u5b58\u50a8\u7a7a\u95f4\u7684\u6570\u91cf\u8fdb\u884c\u6269\u5c55\u3002\u5355\u8282\u70b9\u7248\u672c\u6bd4\u96c6\u7fa4\u7248\u672c\u66f4\u5bb9\u6613\u914d\u7f6e\u548c\u64cd\u4f5c\uff0c\u6240\u4ee5\u5728\u4f7f\u7528\u96c6\u7fa4\u7248\u672c\u4e4b\u524d\u8981\u4e09\u601d\u800c\u540e\u884c\u3002\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 VM \u7684\u5355\u8282\u70b9\u7248\u672c\u7684\u57fa\u672c\u4f7f\u7528\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4ecb\u7ecd\u4e0b\u5982\u4f55\u4f7f\u7528\u96c6\u7fa4\u7248\u3002</p> <p>\u96c6\u7fa4\u7248\u4e3b\u8981\u7279\u70b9\uff1a</p> <ul> <li>\u652f\u6301\u5355\u8282\u70b9\u7248\u672c\u7684\u6240\u6709\u529f\u80fd\u3002</li> <li>\u6027\u80fd\u548c\u5bb9\u91cf\u6c34\u5e73\u6269\u5c55\u3002</li> <li>\u652f\u6301\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u7684\u591a\u4e2a\u72ec\u7acb\u547d\u540d\u7a7a\u95f4\uff08\u591a\u79df\u6237\uff09\u3002</li> <li>\u652f\u6301\u591a\u526f\u672c\u3002</li> </ul>"},{"location":"chap12/69vm_cluster/#1-node-exporter","title":"1 Node-Exporter","text":"<pre><code>---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\n  namespace: kube-vm\n  labels:\n    k8s-app: node-exporter\nspec:\n  selector:\n    matchLabels:\n      k8s-app: node-exporter\n  template:\n    metadata:\n      labels:\n        k8s-app: node-exporter\n    spec:\n      containers:\n      - image: prom/node-exporter\n        name: node-exporter\n        ports:\n        - containerPort: 9100\n          protocol: TCP\n          name: http\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    k8s-app: node-exporter\n  name: node-exporter\n  namespace: kube-vm\nspec:\n  ports:\n  - name: http\n    port: 9100\n    targetPort: 9100\n    protocol: TCP\n  selector:\n    k8s-app: node-exporter\n</code></pre> <pre><code>$ kubectl apply -f cluster-prom-nodexpo.yaml \ndaemonset.apps/node-exporter created\nservice/node-exporter created\n</code></pre>"},{"location":"chap12/69vm_cluster/#2","title":"2 \u7ec4\u4ef6","text":"<p>\u524d\u9762\u6211\u4eec\u4e86\u89e3\u4e86 VM \u7684\u57fa\u672c\u67b6\u6784\uff0c\u5bf9\u4e8e\u96c6\u7fa4\u6a21\u5f0f\u4e0b\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b\u51e0\u4e2a\u670d\u52a1\uff1a</p> <ul> <li>vmstorage\uff1a\u5b58\u50a8\u539f\u59cb\u6570\u636e\u5e76\u8fd4\u56de\u6307\u5b9a\u6807\u7b7e\u8fc7\u6ee4\u5668\u5728\u7ed9\u5b9a\u65f6\u95f4\u8303\u56f4\u5185\u7684\u67e5\u8be2\u6570\u636e\uff0c\u5f53 <code>-storageDataPath</code> \u6307\u5411\u7684\u76ee\u5f55\u5305\u542b\u7684\u53ef\u7528\u7a7a\u95f4\u5c11\u4e8e <code>-storage.minFreeDiskSpaceBytes</code> \u65f6\uff0c<code>vmstorage</code> \u8282\u70b9\u4f1a\u81ea\u52a8\u5207\u6362\u5230\u53ea\u8bfb\u6a21\u5f0f\uff0c<code>vminsert</code> \u8282\u70b9\u4e5f\u4f1a\u505c\u6b62\u5411\u6b64\u7c7b\u8282\u70b9\u53d1\u9001\u6570\u636e\u5e76\u5f00\u59cb\u5c06\u6570\u636e\u91cd\u65b0\u8def\u7531\u5230\u5269\u4f59\u7684 vmstorage \u8282\u70b9\u3002</li> <li><code>vminsert</code>\uff1a\u63a5\u53d7\u6444\u53d6\u7684\u6570\u636e\u5e76\u6839\u636e\u6307\u6807\u540d\u79f0\u53ca\u5176\u6240\u6709\u6807\u7b7e\u7684\u4e00\u81f4\u6027\u54c8\u5e0c\u5c06\u5176\u5206\u6563\u5b58\u50a8\u5230 <code>vmstorage</code> \u8282\u70b9\u3002</li> <li>vmselect\uff1a\u901a\u8fc7\u4ece\u6240\u6709\u914d\u7f6e\u7684 <code>vmstorage</code> \u8282\u70b9\u83b7\u53d6\u6240\u9700\u6570\u636e\u6765\u6267\u884c\u67e5\u8be2\u3002</li> </ul> <p>\u6bcf\u4e2a\u670d\u52a1\u90fd\u53ef\u4ee5\u8fdb\u884c\u72ec\u7acb\u6269\u5c55\uff0cvmstorage \u8282\u70b9\u4e4b\u95f4\u4e92\u4e0d\u4e86\u89e3\u3001\u4e92\u4e0d\u901a\u4fe1\uff0c\u5e76\u4e14\u4e0d\u5171\u4eab\u4efb\u4f55\u6570\u636e\u3002\u8fd9\u6837\u53ef\u4ee5\u589e\u52a0\u96c6\u7fa4\u7684\u53ef\u7528\u6027\uff0c\u5e76\u4e14\u7b80\u5316\u4e86\u96c6\u7fa4\u7684\u7ef4\u62a4\u548c\u6269\u5c55\u3002\u6700\u5c0f\u7684\u96c6\u7fa4\u5fc5\u987b\u5305\u542b\u4ee5\u4e0b\u8282\u70b9\uff1a</p> <ul> <li>\u5e26\u6709 <code>-retentionPeriod</code>  \u548c <code>-storageDataPath</code> \u53c2\u6570\u7684\u5355 <code>vmstorage</code> \u8282\u70b9</li> <li>\u5e26\u6709 <code>-storageNode=&lt;vmstorage_host&gt;</code> \u7684\u5355 vminsert \u8282\u70b9</li> <li>\u5e26\u6709 <code>-storageNode=&lt;vmstorage_host&gt;</code> \u7684\u5355 vmselect \u8282\u70b9</li> </ul> <p>\u4f46\u662f\u6211\u4eec\u5efa\u8bae\u4e3a\u6bcf\u4e2a\u670d\u52a1\u7ec4\u4ef6\u8fd0\u884c\u81f3\u5c11\u4e24\u4e2a\u8282\u70b9\u4ee5\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\uff0c\u8fd9\u6837\u5f53\u5355\u4e2a\u8282\u70b9\u6682\u65f6\u4e0d\u53ef\u7528\u65f6\uff0c\u96c6\u7fa4\u4f1a\u7ee7\u7eed\u5de5\u4f5c\uff0c\u800c\u4e14\u5176\u4f59\u8282\u70b9\u8fd8\u53ef\u4ee5\u5904\u7406\u589e\u52a0\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002</p> <p>\u5982\u679c\u4f60\u7684\u96c6\u7fa4\u89c4\u6a21\u8f83\u5927\uff0c\u90a3\u4e48\u53ef\u4ee5\u8fd0\u884c\u591a\u4e2a\u5c0f\u578b\u7684 vmstorage \u8282\u70b9\uff0c\u56e0\u4e3a\u8fd9\u6837\u53ef\u4ee5\u5728\u67d0\u4e9b vmstorage \u8282\u70b9\u6682\u65f6\u4e0d\u53ef\u7528\u65f6\u51cf\u5c11\u5269\u4f59 vmstorage \u8282\u70b9\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u589e\u52a0\u3002</p> <p>\u5404\u4e2a\u670d\u52a1\u9664\u4e86\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570\u6807\u5fd7\u8fdb\u884c\u914d\u7f6e\u4e4b\u5916\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u7684\u65b9\u5f0f\u8fdb\u884c\u914d\u7f6e\uff1a</p> <ul> <li><code>-envflag.enable</code> \u6807\u5fd7\u5fc5\u987b\u8bbe\u7f6e</li> <li>\u6bcf\u4e2a\u6807\u5fd7\u4e2d\u7684 <code>.</code> \u5fc5\u987b\u66ff\u6362\u4e3a <code>_</code>\uff0c\u4f8b\u5982 <code>-insert.maxQueueDuration &lt;duration&gt;</code> \u53ef\u4ee5\u8f6c\u6362\u4e3a <code>insert_maxQueueDuration=&lt;duration&gt;</code></li> <li>\u5bf9\u4e8e\u91cd\u590d\u7684\u6807\u5fd7\uff0c\u53ef\u4ee5\u4f7f\u7528\u53e6\u4e00\u79cd\u8bed\u6cd5\uff0c\u901a\u8fc7\u4f7f\u7528 <code>,</code> \u4f5c\u4e3a\u5206\u9694\u7b26\u5c06\u4e0d\u540c\u7684\u503c\u8fde\u63a5\u6210\u4e00\u4e2a\uff0c\u4f8b\u5982 <code>-storageNode &lt;nodeA&gt; -storageNode &lt;nodeB&gt;</code> \u5c06\u8f6c\u6362\u4e3a <code>-storageNode=&lt;nodeA&gt;,&lt;nodeB&gt;</code></li> <li>\u53ef\u4ee5\u4f7f\u7528 <code>-envflag.prefix</code> \u4e3a\u73af\u5883\u53d8\u91cf\u8bbe\u7f6e\u524d\u7f00\uff0c\u4f8b\u5982\u8bbe\u7f6e\u4e86 <code>-envflag.prefix=VM*</code>\uff0c\u5219\u73af\u5883\u53d8\u91cf\u53c2\u6570\u5fc5\u987b\u4ee5 <code>VM*</code> \u5f00\u5934</li> </ul>"},{"location":"chap12/69vm_cluster/#2-1","title":"2-1 \u591a\u79df\u6237","text":"<p>VM \u96c6\u7fa4\u4e5f\u652f\u6301\u591a\u4e2a\u72ec\u7acb\u7684\u79df\u6237\uff08\u4e5f\u53eb\u547d\u540d\u7a7a\u95f4\uff09\uff0c\u79df\u6237\u7531 <code>accountID</code> \u6216 <code>accountID:projectID</code> \u6765\u6807\u8bc6\uff0c\u5b83\u4eec\u88ab\u653e\u5728\u8bf7\u6c42\u7684 urls \u4e2d\u3002</p> <ul> <li>\u6bcf\u4e2a <code>accountID</code> \u548c <code>projectID</code> \u90fd\u7531\u4e00\u4e2a <code>[0 .. 2^32]</code> \u8303\u56f4\u5185\u7684\u4efb\u610f 32 \u4f4d\u6574\u6570\u6807\u8bc6\uff0c\u5982\u679c\u7f3a\u5c11 projectID\uff0c\u5219\u81ea\u52a8\u5c06\u5176\u5206\u914d\u4e3a 0\u3002\u6709\u5173\u79df\u6237\u7684\u5176\u4ed6\u4fe1\u606f\uff0c\u4f8b\u5982\u8eab\u4efd\u9a8c\u8bc1\u4ee4\u724c\u3001\u79df\u6237\u540d\u79f0\u3001\u9650\u989d\u3001\u8ba1\u8d39\u7b49\uff0c\u5c06\u5b58\u50a8\u5728\u4e00\u4e2a\u5355\u72ec\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u3002\u6b64\u6570\u636e\u5e93\u5fc5\u987b\u7531\u4f4d\u4e8e VictoriaMetrics \u96c6\u7fa4\u524d\u9762\u7684\u5355\u72ec\u670d\u52a1\u7ba1\u7406\uff0c\u4f8b\u5982 <code>vmauth</code> \u6216 <code>vmgateway</code>\u3002</li> <li>\u5f53\u7b2c\u4e00\u4e2a\u6570\u636e\u70b9\u5199\u5165\u6307\u5b9a\u79df\u6237\u65f6\uff0c\u79df\u6237\u88ab\u81ea\u52a8\u521b\u5efa\u3002</li> <li>\u6240\u6709\u79df\u6237\u7684\u6570\u636e\u5747\u5300\u5206\u5e03\u5728\u53ef\u7528\u7684 vmstorage \u8282\u70b9\u4e2d\uff0c\u5f53\u4e0d\u540c\u79df\u6237\u6709\u4e0d\u540c\u7684\u6570\u636e\u91cf\u548c\u4e0d\u540c\u7684\u67e5\u8be2\u8d1f\u8f7d\u65f6\uff0c\u8fd9\u4fdd\u8bc1\u4e86 vmstorage \u8282\u70b9\u4e4b\u95f4\u7684\u5747\u5300\u8d1f\u8f7d\u3002</li> <li>\u6570\u636e\u5e93\u6027\u80fd\u548c\u8d44\u6e90\u4f7f\u7528\u4e0d\u4f9d\u8d56\u4e8e\u79df\u6237\u7684\u6570\u91cf\uff0c\u5b83\u4e3b\u8981\u53d6\u51b3\u4e8e\u6240\u6709\u79df\u6237\u4e2d\u6d3b\u8dc3\u65f6\u95f4\u5e8f\u5217\u7684\u603b\u6570\u3002\u5982\u679c\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u5728\u8fc7\u53bb\u4e00\u5c0f\u65f6\u5185\u81f3\u5c11\u6536\u5230\u4e00\u4e2a\u6837\u672c\uff0c\u6216\u8005\u5728\u8fc7\u53bb\u4e00\u5c0f\u65f6\u5185\u88ab\u67e5\u8be2\uff0c\u5219\u8ba4\u4e3a\u65f6\u95f4\u5e8f\u5217\u662f\u6d3b\u8dc3\u7684\u3002</li> <li>VictoriaMetrics \u4e0d\u652f\u6301\u5728\u5355\u4e2a\u8bf7\u6c42\u4e2d\u67e5\u8be2\u591a\u4e2a\u79df\u6237\u3002</li> </ul>"},{"location":"chap12/69vm_cluster/#2-2","title":"2-2 \u96c6\u7fa4\u6269\u5c55","text":"<p>VM \u96c6\u7fa4\u7684\u6027\u80fd\u548c\u5bb9\u91cf\u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u8fdb\u884c\u6269\u5c55\uff1a</p> <ul> <li>\u901a\u8fc7\u5411\u96c6\u7fa4\u4e2d\u7684\u73b0\u6709\u8282\u70b9\u6dfb\u52a0\u66f4\u591a\u8d44\u6e90\uff08CPU\u3001RAM\u3001\u78c1\u76d8 IO\u3001\u78c1\u76d8\u7a7a\u95f4\u3001\u7f51\u7edc\u5e26\u5bbd\uff09\uff0c\u4e5f\u53eb\u5782\u76f4\u53ef\u6269\u5c55\u6027\u3002</li> <li>\u901a\u8fc7\u5411\u96c6\u7fa4\u6dfb\u52a0\u66f4\u591a\u8282\u70b9\uff0c\u53c8\u53eb\u6c34\u5e73\u6269\u5c55\u6027\u3002</li> </ul> <p>\u5bf9\u4e8e\u96c6\u7fa4\u6269\u5c55\u6709\u4e00\u4e9b\u901a\u7528\u7684\u5efa\u8bae\uff1a</p> <ul> <li>\u5411\u73b0\u6709 vmselect \u8282\u70b9\u6dfb\u52a0\u66f4\u591a CPU \u548c\u5185\u5b58\uff0c\u53ef\u4ee5\u63d0\u9ad8\u590d\u6742\u67e5\u8be2\u7684\u6027\u80fd\uff0c\u8fd9\u4e9b\u67e5\u8be2\u53ef\u4ee5\u5904\u7406\u5927\u91cf\u7684\u65f6\u95f4\u5e8f\u5217\u548c\u5927\u91cf\u7684\u539f\u59cb\u6837\u672c\u3002</li> <li>\u6dfb\u52a0\u66f4\u591a vmstorage \u8282\u70b9\u53ef\u4ee5\u589e\u52a0\u96c6\u7fa4\u53ef\u4ee5\u5904\u7406\u7684\u6d3b\u8dc3\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u91cf\uff0c\u8fd9\u4e5f\u63d0\u9ad8\u4e86\u5bf9\u9ad8\u6d41\u5931\u7387(churn rate)\u7684\u65f6\u95f4\u5e8f\u5217\u7684\u67e5\u8be2\u6027\u80fd\u3002\u96c6\u7fa4\u7a33\u5b9a\u6027\u4e5f\u4f1a\u968f\u7740 vmstorage \u8282\u70b9\u6570\u91cf\u7684\u589e\u52a0\u800c\u63d0\u9ad8\uff0c\u5f53\u4e00\u4e9b vmstorage \u8282\u70b9\u4e0d\u53ef\u7528\u65f6\uff0c\u6d3b\u8dc3\u7684 vmstorage \u8282\u70b9\u9700\u8981\u5904\u7406\u8f83\u4f4e\u7684\u989d\u5916\u5de5\u4f5c\u8d1f\u8f7d\u3002</li> <li>\u5411\u73b0\u6709 vmstorage \u8282\u70b9\u6dfb\u52a0\u66f4\u591a CPU \u548c\u5185\u5b58\uff0c\u53ef\u4ee5\u589e\u52a0\u96c6\u7fa4\u53ef\u4ee5\u5904\u7406\u7684\u6d3b\u8dc3\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u91cf\u3002\u4e0e\u5411\u73b0\u6709 vmstorage \u8282\u70b9\u6dfb\u52a0\u66f4\u591a CPU \u548c\u5185\u5b58\u76f8\u6bd4\uff0c\u6700\u597d\u6dfb\u52a0\u66f4\u591a vmstorage \u8282\u70b9\uff0c\u56e0\u4e3a\u66f4\u591a\u7684 vmstorage \u8282\u70b9\u53ef\u4ee5\u63d0\u9ad8\u96c6\u7fa4\u7a33\u5b9a\u6027\uff0c\u5e76\u63d0\u9ad8\u5bf9\u9ad8\u6d41\u5931\u7387\u7684\u65f6\u95f4\u5e8f\u5217\u7684\u67e5\u8be2\u6027\u80fd\u3002</li> <li>\u6dfb\u52a0\u66f4\u591a\u7684 vminsert \u8282\u70b9\u4f1a\u63d0\u9ad8\u6570\u636e\u6444\u53d6\u7684\u6700\u5927\u901f\u5ea6\uff0c\u56e0\u4e3a\u6444\u53d6\u7684\u6570\u636e\u53ef\u4ee5\u5728\u66f4\u591a\u7684 vminsert \u8282\u70b9\u4e4b\u95f4\u8fdb\u884c\u62c6\u5206\u3002</li> </ul>"},{"location":"chap12/69vm_cluster/#_1","title":"\u96c6\u7fa4\u53ef\u7528\u6027","text":"<ul> <li>HTTP \u8d1f\u8f7d\u5747\u8861\u5668\u9700\u8981\u505c\u6b62\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u4e0d\u53ef\u7528\u7684 vminsert \u548c vmselect \u8282\u70b9\u3002</li> <li>\u5982\u679c\u81f3\u5c11\u5b58\u5728\u4e00\u4e2a vmstorage \u8282\u70b9\uff0c\u5219\u96c6\u7fa4\u4ecd\u7136\u53ef\u7528\uff1a<ul> <li>vminsert \u5c06\u4f20\u5165\u6570\u636e\u4ece\u4e0d\u53ef\u7528\u7684 vmstorage \u8282\u70b9\u91cd\u65b0\u8def\u7531\u5230\u5065\u5eb7\u7684 vmstorage \u8282\u70b9</li> <li>\u5982\u679c\u81f3\u5c11\u6709\u4e00\u4e2a vmstorage \u8282\u70b9\u53ef\u7528\uff0c\u5219 vmselect \u4f1a\u7ee7\u7eed\u63d0\u4f9b\u90e8\u5206\u54cd\u5e94\u3002\u5982\u679c\u4f18\u5148\u8003\u8651\u53ef\u7528\u6027\u7684\u4e00\u81f4\u6027\uff0c\u5219\u5c06 <code>-search.denyPartialResponse</code> \u6807\u5fd7\u4f20\u9012\u7ed9 vmselect \u6216\u5c06\u8bf7\u6c42\u4e2d\u7684 <code>deny_partial_response=1</code> \u67e5\u8be2\u53c2\u6570\u4f20\u9012\u7ed9 vmselect\u3002</li> </ul> </li> </ul>"},{"location":"chap12/69vm_cluster/#2-3","title":"2-3 \u53bb\u91cd","text":"<p>\u5982\u679c <code>-dedup.minScrapeInterval</code> \u547d\u4ee4\u884c\u6807\u5fd7\u8bbe\u7f6e\u4e3a\u5927\u4e8e 0 \u7684\u65f6\u95f4\uff0c<code>VictoriaMetrics</code> \u4f1a\u53bb\u9664\u91cd\u590d\u6570\u636e\u70b9\u3002\u4f8b\u5982\uff0c<code>-dedup.minScrapeInterval=60s</code>\u5c06\u5bf9\u540c\u4e00\u65f6\u95f4\u5e8f\u5217\u4e0a\u7684\u6570\u636e\u70b9\u8fdb\u884c\u91cd\u590d\u6570\u636e\u5220\u9664\uff0c\u5982\u679c\u5b83\u4eec\u4f4d\u4e8e\u540c\u4e00\u79bb\u6563\u7684 60 \u79d2\u5b58\u50a8\u6876\u5185\uff0c\u6700\u65e9\u7684\u6570\u636e\u70b9\u5c06\u88ab\u4fdd\u7559\u3002\u5728\u65f6\u95f4\u6233\u76f8\u7b49\u7684\u60c5\u51b5\u4e0b\uff0c\u5c06\u4fdd\u7559\u4efb\u610f\u6570\u636e\u70b9\u3002</p> <p><code>-dedup.minScrapeInterval</code> \u7684\u63a8\u8350\u503c\u662f\u7b49\u4e8e Prometheus \u914d\u7f6e\u4e2d\u7684 <code>scrape_interval</code> \u7684\u503c\uff0c\u5efa\u8bae\u5728\u6240\u6709\u6293\u53d6\u76ee\u6807\u4e2d\u4f7f\u7528\u4e00\u4e2a <code>scrape_interval</code> \u914d\u7f6e\u3002</p> <p>\u5982\u679c HA \u4e2d\u591a\u4e2a\u76f8\u540c\u914d\u7f6e\u7684 vmagent \u6216 Prometheus \u5b9e\u4f8b\u5c06\u6570\u636e\u5199\u5165\u540c\u4e00\u4e2a VictoriaMetrics \u5b9e\u4f8b\uff0c\u5219\u91cd\u590d\u6570\u636e\u5220\u9664\u4f1a\u51cf\u5c11\u78c1\u76d8\u7a7a\u95f4\u4f7f\u7528\u3002\u8fd9\u4e9b vmagent \u6216 Prometheus \u5b9e\u4f8b\u5728\u5176\u914d\u7f6e\u4e2d\u5fc5\u987b\u5177\u6709\u76f8\u540c\u7684 external_labels \u90e8\u5206\uff0c\u56e0\u6b64\u5b83\u4eec\u5c06\u6570\u636e\u5199\u5165\u76f8\u540c\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p>"},{"location":"chap12/69vm_cluster/#_2","title":"\u5bb9\u91cf\u89c4\u5212","text":"<p>\u96c6\u7fa4\u5bb9\u91cf\u968f\u7740\u53ef\u7528\u8d44\u6e90\u7684\u589e\u52a0\u800c\u7ebf\u6027\u6269\u5c55\uff0c\u6bcf\u4e2a\u8282\u70b9\u7c7b\u578b\u6240\u9700\u7684 CPU \u548c\u5185\u5b58\u6570\u91cf\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53d6\u51b3\u4e8e\u5de5\u4f5c\u8d1f\u8f7d - \u6d3b\u8dc3\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u91cf\u3001\u5e8f\u5217\u6d41\u5931\u7387\u3001\u67e5\u8be2\u7c7b\u578b\u3001\u67e5\u8be2 QPS \u7b49\u3002\u5efa\u8bae\u4e3a\u4f60\u7684\u751f\u4ea7\u5de5\u4f5c\u8d1f\u8f7d\u90e8\u7f72\u4e00\u4e2a\u6d4b\u8bd5\u7684 VictoriaMetrics \u96c6\u7fa4\uff0c\u5e76\u53cd\u590d\u8c03\u6574\u6bcf\u4e2a\u8282\u70b9\u7684\u8d44\u6e90\u548c\u6bcf\u4e2a\u8282\u70b9\u7c7b\u578b\u7684\u8282\u70b9\u6570\u91cf\uff0c\u76f4\u5230\u96c6\u7fa4\u53d8\u5f97\u7a33\u5b9a\u3002\u540c\u6837\u4e5f\u5efa\u8bae\u4e3a\u96c6\u7fa4\u8bbe\u7f6e\u76d1\u63a7\uff0c\u6709\u52a9\u4e8e\u786e\u5b9a\u96c6\u7fa4\u8bbe\u7f6e\u4e2d\u7684\u74f6\u9888\u95ee\u9898\u3002</p> <p>\u6307\u5b9a\u4fdd\u7559\u6240\u9700\u7684\u5b58\u50a8\u7a7a\u95f4\uff08\u53ef\u4ee5\u901a\u8fc7 vmstorage \u4e2d\u7684 <code>-retentionPeriod</code> \u547d\u4ee4\u884c\u6807\u5fd7\u8bbe\u7f6e\uff09\u53ef\u4ee5\u4ece\u6d4b\u8bd5\u8fd0\u884c\u4e2d\u7684\u78c1\u76d8\u7a7a\u95f4\u4f7f\u7528\u60c5\u51b5\u63a8\u65ad\u51fa\u6765\u3002\u4f8b\u5982\uff0c\u5982\u679c\u5728\u751f\u4ea7\u5de5\u4f5c\u8d1f\u8f7d\u4e0a\u8fd0\u884c\u4e00\u5929\u540e\u7684\u5b58\u50a8\u7a7a\u95f4\u4f7f\u7528\u91cf\u4e3a 10GB\uff0c\u90a3\u4e48\u5bf9\u4e8e <code>-retentionPeriod=100d</code>\uff08100 \u5929\u4fdd\u7559\u671f\uff09\u6765\u8bf4\uff0c\u5b83\u81f3\u5c11\u9700\u8981 <code>10GB*100=1TB</code> \u7684\u78c1\u76d8\u7a7a\u95f4\u3002\u53ef\u4ee5\u4f7f\u7528 VictoriaMetrics \u96c6\u7fa4\u7684\u5b98\u65b9 Grafana \u4eea\u8868\u677f(https://grafana.com/grafana/dashboards/11176)\u76d1\u63a7\u5b58\u50a8\u7a7a\u95f4\u4f7f\u7528\u60c5\u51b5\u3002</p> <p>\u5efa\u8bae\u7559\u51fa\u4ee5\u4e0b\u6570\u91cf\u7684\u5907\u7528\u8d44\u6e90\u3002</p> <ul> <li>\u6240\u6709\u8282\u70b9\u7c7b\u578b\u4e2d 50% \u7684\u7a7a\u95f2\u5185\u5b58\uff0c\u4ee5\u51cf\u5c11\u5de5\u4f5c\u8d1f\u8f7d\u4e34\u65f6\u6fc0\u589e\u65f6\u56e0\u4e3a OOM \u5d29\u6e83\u7684\u53ef\u80fd\u6027\u3002</li> <li>\u6240\u6709\u8282\u70b9\u7c7b\u578b\u4e2d 50% \u7684\u7a7a\u95f2 CPU\uff0c\u4ee5\u51cf\u5c11\u5de5\u4f5c\u8d1f\u8f7d\u4e34\u65f6\u9ad8\u5cf0\u671f\u95f4\u7684\u6162\u901f\u6982\u7387\u3002</li> <li>vmstorage \u8282\u70b9\u4e0a <code>-storageDataPath</code> \u547d\u4ee4\u884c\u6807\u5fd7\u6307\u5411\u7684\u76ee\u5f55\u4e2d\u81f3\u5c11\u6709 30% \u7684\u53ef\u7528\u5b58\u50a8\u7a7a\u95f4\u3002</li> </ul> <p>VictoriaMetrics \u96c6\u7fa4\u7684\u4e00\u4e9b\u5bb9\u91cf\u89c4\u5212\u6280\u5de7\uff1a</p> <ul> <li>\u526f\u672c\u96c6\u5c06\u96c6\u7fa4\u6240\u9700\u7684\u8d44\u6e90\u91cf\u6700\u591a\u589e\u52a0 N \u500d\uff0c\u5176\u4e2d N \u662f\u590d\u5236\u56e0\u5b50\u3002</li> <li>\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u66f4\u591a vmstorage \u8282\u70b9\u548c/\u6216\u901a\u8fc7\u589e\u52a0\u6bcf\u4e2a vmstorage \u8282\u70b9\u7684\u5185\u5b58\u548c CPU \u8d44\u6e90\u6765\u589e\u52a0\u6d3b\u8dc3\u65f6\u95f4\u5e8f\u5217\u7684\u96c6\u7fa4\u5bb9\u91cf\u3002</li> <li>\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0 vmstorage \u8282\u70b9\u7684\u6570\u91cf\u548c/\u6216\u901a\u8fc7\u589e\u52a0\u6bcf\u4e2a vmselect \u8282\u70b9\u7684\u5185\u5b58\u548c CPU \u8d44\u6e90\u6765\u51cf\u5c11\u67e5\u8be2\u5ef6\u8fdf\u3002</li> <li>\u6240\u6709 vminsert \u8282\u70b9\u6240\u9700\u7684 CPU \u5185\u6838\u603b\u6570\u53ef\u4ee5\u901a\u8fc7\u6444\u53d6\u7387\u8ba1\u7b97\uff1a<code>CPUs = ingestion_rate / 100K</code>\u3002</li> <li>vminsert \u8282\u70b9\u4e0a\u7684 <code>-rpc.disableCompression</code> \u547d\u4ee4\u884c\u6807\u5fd7\u53ef\u4ee5\u589e\u52a0\u6444\u53d6\u5bb9\u91cf\uff0c\u4f46\u4ee3\u4ef7\u662f vminsert \u548c vmstorage \u4e4b\u95f4\u7684\u7f51\u7edc\u5e26\u5bbd\u4f7f\u7528\u7387\u4f1a\u66f4\u9ad8\u3002</li> </ul>"},{"location":"chap12/69vm_cluster/#2-4","title":"2-4 \u526f\u672c\u548c\u6570\u636e\u5b89\u5168","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cVictoriaMetrics \u7684\u6570\u636e\u590d\u5236\u4f9d\u8d56 <code>-storageDataPath</code> \u6307\u5411\u7684\u5e95\u5c42\u5b58\u50a8\u6765\u5b8c\u6210\u3002</p> <p>\u4f46\u662f\u6211\u4eec\u4e5f\u53ef\u4ee5\u624b\u52a8\u901a\u8fc7\u5c06 <code>-replicationFactor=N</code> \u547d\u4ee4\u53c2\u6570\u4f20\u9012\u7ed9 vminsert \u6765\u542f\u7528\u590d\u5236\uff0c\u8fd9\u4fdd\u8bc1\u4e86\u5982\u679c\u591a\u8fbe N-1 \u4e2a <code>vmstorage</code> \u8282\u70b9\u4e0d\u53ef\u7528\uff0c\u6240\u6709\u6570\u636e\u4ecd\u53ef\u7528\u4e8e\u67e5\u8be2\u3002\u96c6\u7fa4\u5fc5\u987b\u81f3\u5c11\u5305\u542b <code>2*N-1</code> \u4e2a vmstorage \u8282\u70b9\uff0c\u5176\u4e2d N \u662f\u590d\u5236\u56e0\u5b50\uff0c\u4ee5\u4fbf\u5728 <code>N-1</code> \u4e2a\u5b58\u50a8\u8282\u70b9\u4e22\u5931\u65f6\u4e3a\u65b0\u6444\u53d6\u7684\u6570\u636e\u7ef4\u6301\u6307\u5b9a\u7684\u590d\u5236\u56e0\u5b50\u3002</p> <p>\u4f8b\u5982\uff0c\u5f53 <code>-replicationFactor=3</code> \u4f20\u9012\u7ed9 vminsert \u65f6\uff0c\u5b83\u5c06\u6240\u6709\u6444\u53d6\u7684\u6570\u636e\u590d\u5236\u5230 3 \u4e2a\u4e0d\u540c\u7684 <code>vmstorage</code> \u8282\u70b9\uff0c\u56e0\u6b64\u6700\u591a\u53ef\u4ee5\u4e22\u5931 2 \u4e2a vmstorage \u8282\u70b9\u800c\u4e0d\u4f1a\u4e22\u5931\u6570\u636e\u3002</p> <p><code>vmstorage</code> \u8282\u70b9\u7684\u6700\u5c0f\u6570\u91cf\u5e94\u8be5\u7b49\u4e8e <code>2*3-1 = 5</code>\uff0c\u56e0\u6b64\u5f53 2 \u4e2a <code>vmstorage</code> \u8282\u70b9\u4e22\u5931\u65f6\uff0c\u5269\u4f59\u7684 3 \u4e2a vmstorage \u8282\u70b9\u53ef\u4ee5\u4e3a\u65b0\u6444\u53d6\u7684\u6570\u636e\u63d0\u4f9b\u670d\u52a1\u3002</p> <p>\u542f\u7528\u590d\u5236\u540e\uff0c\u5fc5\u987b\u5c06 <code>-dedup.minScrapeInterval=1ms</code> \u547d\u4ee4\u884c\u6807\u5fd7\u4f20\u9012\u7ed9 <code>vmselect</code> \u8282\u70b9\uff0c\u5f53\u591a\u8fbe N-1 \u4e2a vmstorage \u8282\u70b9\u54cd\u5e94\u7f13\u6162\u548c/\u6216\u6682\u65f6\u4e0d\u53ef\u7528\u65f6\uff0c\u53ef\u4ee5\u5c06\u53ef\u9009\u7684 <code>-replicationFactor=N</code> \u53c2\u6570\u4f20\u9012\u7ed9 <code>vmselect</code> \u4ee5\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd\uff0c\u56e0\u4e3a <code>vmselect</code> \u4e0d\u7b49\u5f85\u6765\u81ea\u591a\u8fbe <code>N-1</code> \u4e2a vmstorage \u8282\u70b9\u7684\u54cd\u5e94\u3002\u6709\u65f6\uff0cvmselect \u8282\u70b9\u4e0a\u7684 <code>-replicationFactor</code> \u53ef\u80fd\u4f1a\u5bfc\u81f4\u90e8\u5206\u54cd\u5e94\u3002<code>-dedup.minScrapeInterval=1ms</code> \u5728\u67e5\u8be2\u671f\u95f4\u5bf9\u590d\u5236\u7684\u6570\u636e\u8fdb\u884c\u91cd\u590d\u6570\u636e\u5220\u9664\uff0c\u5982\u679c\u91cd\u590d\u6570\u636e\u4ece\u914d\u7f6e\u76f8\u540c\u7684 vmagent \u5b9e\u4f8b\u6216 Prometheus \u5b9e\u4f8b\u63a8\u9001\u5230 VictoriaMetrics\uff0c\u5219\u5fc5\u987b\u6839\u636e\u91cd\u590d\u6570\u636e\u5220\u9664\u6587\u6863\u5c06 <code>-dedup.minScrapeInterval</code> \u8bbe\u7f6e\u4e3a\u66f4\u5927\u7684\u503c\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u590d\u5236\u4e0d\u4f1a\u4ece\u707e\u96be\u4e2d\u4fdd\u5b58\uff0c\u56e0\u6b64\u5efa\u8bae\u6267\u884c\u5b9a\u671f\u5907\u4efd\u3002\u53e6\u5916 \u590d\u5236\u4f1a\u589e\u52a0\u8d44\u6e90\u4f7f\u7528\u7387 - CPU\u3001\u5185\u5b58\u3001\u78c1\u76d8\u7a7a\u95f4\u3001\u7f51\u7edc\u5e26\u5bbd - \u6700\u591a -replicationFactor \u500d\u3002\u6240\u4ee5\u53ef\u4ee5\u5c06\u590d\u5236\u8f6c\u79fb -storageDataPath \u6307\u5411\u7684\u5e95\u5c42\u5b58\u50a8\u6765\u505a\u4fdd\u8bc1\uff0c\u4f8b\u5982 Google Compute Engine \u6c38\u4e45\u78c1\u76d8\uff0c\u8be5\u78c1\u76d8\u53ef\u4ee5\u9632\u6b62\u6570\u636e\u4e22\u5931\u548c\u6570\u636e\u635f\u574f\uff0c\u5b83\u8fd8\u63d0\u4f9b\u59cb\u7ec8\u5982\u4e00\u7684\u9ad8\u6027\u80fd\uff0c\u5e76\u4e14\u53ef\u4ee5\u5728\u4e0d\u505c\u673a\u7684\u60c5\u51b5\u4e0b\u8c03\u6574\u5927\u5c0f\u3002\u5bf9\u4e8e\u5927\u591a\u6570\u7528\u4f8b\u6765\u8bf4\uff0c\u57fa\u4e8e HDD \u7684\u6c38\u4e45\u6027\u78c1\u76d8\u5e94\u8be5\u8db3\u591f\u4e86\u3002</p>"},{"location":"chap12/69vm_cluster/#2-5","title":"2-5 \u5907\u4efd","text":"<p>\u5efa\u8bae\u4ece\u5373\u65f6\u5feb\u7167\u6267\u884c\u5b9a\u671f\u5907\u4efd\uff0c\u4ee5\u9632\u6b62\u610f\u5916\u6570\u636e\u5220\u9664\u7b49\u9519\u8bef\u3002\u5fc5\u987b\u4e3a\u6bcf\u4e2a vmstorage \u8282\u70b9\u6267\u884c\u4ee5\u4e0b\u6b65\u9aa4\u6765\u521b\u5efa\u5907\u4efd\uff1a</p> <ul> <li>\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95ee <code>/snapshot/create</code> \u8fd9\u4e2a HTTP handler \u6765\u521b\u5efa\u5373\u65f6\u5feb\u7167\uff0c\u5b83\u5c06\u521b\u5efa\u5feb\u7167\u5e76\u8fd4\u56de\u5176\u540d\u79f0\u3002</li> <li>\u4f7f\u7528 vmbackup \u7ec4\u4ef6\u4ece <code>&lt;-storageDataPath&gt;/snapshots/&lt;snapshot_name&gt;</code> \u6587\u4ef6\u5939\u5f52\u6863\u521b\u5efa\u7684\u5feb\u7167\u3002\u5f52\u6863\u8fc7\u7a0b\u4e0d\u4f1a\u5e72\u6270 vmstorage \u5de5\u4f5c\uff0c\u56e0\u6b64\u53ef\u4ee5\u5728\u4efb\u4f55\u5408\u9002\u7684\u65f6\u95f4\u6267\u884c\u3002</li> <li>\u901a\u8fc7 <code>/snapshot/delete?snapshot=&lt;snapshot_name&gt;</code> \u6216 <code>/snapshot/delete_all</code> \u5220\u9664\u672a\u4f7f\u7528\u7684\u5feb\u7167\uff0c\u4ee5\u91ca\u653e\u5360\u7528\u7684\u5b58\u50a8\u7a7a\u95f4\u3002</li> <li>\u65e0\u9700\u5728\u6240\u6709 vmstorage \u8282\u70b9\u4e4b\u95f4\u540c\u6b65\u5907\u4efd\u3002</li> </ul> <p>\u4ece\u5907\u4efd\u6062\u590d\uff1a</p> <ul> <li>\u4f7f\u7528 kill -INT \u505c\u6b62 vmstorage \u8282\u70b9\u3002</li> <li>\u4f7f\u7528 <code>vmrestore</code> \u7ec4\u4ef6\u5c06\u5907\u4efd\u4e2d\u7684\u6570\u636e\u8fd8\u539f\u5230 <code>-storageDataPath</code> \u76ee\u5f55\u3002</li> <li>\u542f\u52a8 <code>vmstorage</code> \u8282\u70b9\u3002</li> </ul> <p>\u5728\u4e86\u89e3\u4e86 VM \u96c6\u7fa4\u7684\u4e00\u4e9b\u914d\u7f6e\u7ec6\u8282\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5f00\u59cb\u90e8\u7f72 VM \u96c6\u7fa4\u3002</p>"},{"location":"chap12/69vm_cluster/#3","title":"3 \u90e8\u7f72","text":"<p>\u5982\u679c\u4f60\u5df2\u7ecf\u5bf9 VM \u7ec4\u4ef6\u975e\u5e38\u4e86\u89e3\u4e86\uff0c\u90a3\u4e48\u63a8\u8350\u4f7f\u7528 Helm Chart \u7684\u65b9\u5f0f\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\u3002</p> <pre><code>\n\u2638 \u279c helm repo add vm https://victoriametrics.github.io/helm-charts/\n\u2638 \u279c helm repo update\n# \u5bfc\u51fa\u9ed8\u8ba4\u7684 values \u503c\u5230 values.yaml \u6587\u4ef6\u4e2d\n\u2638 \u279c helm show values vm/victoria-metrics-cluster &gt; values.yaml\n# \u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u4fee\u6539 values.yaml \u6587\u4ef6\u914d\u7f6e\n# \u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\n\u2638 \u279c helm install victoria-metrics vm/victoria-metrics-cluster -f values.yaml -n NAMESPACE\n# \u83b7\u53d6 vm \u8fd0\u884c\u7684 pods \u5217\u8868\n\u2638 \u279c kubectl get pods -A | grep 'victoria-metrics'\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u9009\u62e9\u624b\u52a8\u65b9\u5f0f\u8fdb\u884c\u90e8\u7f72\uff0c\u4e4b\u6240\u4ee5\u9009\u62e9\u624b\u52a8\u90e8\u7f72\u7684\u65b9\u5f0f\u662f\u4e3a\u4e86\u80fd\u591f\u4e86\u89e3\u5404\u4e2a\u7ec4\u4ef6\u7684\u66f4\u591a\u7ec6\u8282\u3002</p> <p>\u7531\u4e8e vmstorage \u7ec4\u4ef6\u662f\u65e0\u72b6\u6001\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u5148\u4f7f\u7528 StatefulSet \u8fdb\u884c\u90e8\u7f72\uff0c\u7531\u4e8e\u8be5\u7ec4\u4ef6\u4e5f\u662f\u53ef\u4ee5\u8fdb\u884c\u6269\u5c55\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u9996\u5148\u90e8\u7f72\u4e24\u4e2a\u526f\u672c\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># cluster-vmstorage.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: cluster-vmstorage\n  namespace: kube-vm\n  labels:\n    app: vmstorage\nspec:\n  clusterIP: None\n  ports:\n    - port: 8482\n      targetPort: http\n      name: http\n    - port: 8401\n      targetPort: vmselect\n      name: vmselect\n    - port: 8400\n      targetPort: vminsert\n      name: vminsert\n  selector:\n    app: vmstorage\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: vmstorage\n  namespace: kube-vm\n  labels:\n    app: vmstorage\nspec:\n  serviceName: cluster-vmstorage\n  selector:\n    matchLabels:\n      app: vmstorage\n  replicas: 2\n  podManagementPolicy: OrderedReady\n  template:\n    metadata:\n      labels:\n        app: vmstorage\n    spec:\n      containers:\n        - name: vmstorage\n          image: \"victoriametrics/vmstorage:v1.77.0-cluster\"\n          imagePullPolicy: \"IfNotPresent\"\n          args:\n            - \"--retentionPeriod=1\"\n            - \"--storageDataPath=/storage\"\n            - --envflag.enable=true\n            - --envflag.prefix=VM_\n            - --loggerFormat=json\n          ports:\n            - name: http\n              containerPort: 8482\n            - name: vminsert\n              containerPort: 8400\n            - name: vmselect\n              containerPort: 8401\n          livenessProbe:\n            failureThreshold: 10\n            initialDelaySeconds: 30\n            periodSeconds: 30\n            tcpSocket:\n              port: http\n            timeoutSeconds: 5\n          readinessProbe:\n            failureThreshold: 3\n            initialDelaySeconds: 5\n            periodSeconds: 15\n            timeoutSeconds: 5\n            httpGet:\n              path: /health\n              port: http\n          volumeMounts:\n            - name: storage\n              mountPath: /storage\n  volumeClaimTemplates:\n    - metadata:\n        name: storage\n      spec:\n        storageClassName: hostpath\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: \"1Gi\"\n ```\n\n \u9996\u5148\u9700\u8981\u521b\u5efa\u4e00\u4e2a Headless \u7684 Service\uff0c\u56e0\u4e3a\u540e\u9762\u7684\u7ec4\u4ef6\u9700\u8981\u8bbf\u95ee\u5230\u6bcf\u4e00\u4e2a\u5177\u4f53\u7684 Pod\uff0c\u5728 vmstorage \u542f\u52a8\u53c2\u6570\u4e2d\u901a\u8fc7 `--retentionPeriod` \u53c2\u6570\u6307\u5b9a\u6307\u6807\u6570\u636e\u4fdd\u7559\u65f6\u957f\uff0c1 \u8868\u793a\u4e00\u4e2a\u6708\uff0c\u8fd9\u4e5f\u662f\u9ed8\u8ba4\u7684\u65f6\u957f\uff0c\u7136\u540e\u901a\u8fc7 `--storageDataPath` \u53c2\u6570\u6307\u5b9a\u4e86\u6570\u636e\u5b58\u50a8\u8def\u5f84\uff0c\u8bb0\u5f97\u8981\u5c06\u8be5\u76ee\u5f55\u8fdb\u884c\u6301\u4e45\u5316\u3002\n\n ```\n$ kubectl apply -f cluster-vmstorage.yaml \nservice/cluster-vmstorage created\nstatefulset.apps/vmstorage created\n</code></pre> <pre><code>$ kubectl get pod -n kube-vm\nNAME          READY   STATUS    RESTARTS   AGE\nvmstorage-0   1/1     Running   0          31s\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u5e94\u7528\u8be5\u8d44\u6e90\u5373\u53ef\uff1a</p> <pre><code>\u2638 \u279c kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/cluster-vmstorage.yaml\n\u2638 \u279c kubectl get pods -n kube-vm -l app=vmstorage\nNAME          READY   STATUS    RESTARTS   AGE\nvmstorage-0   1/1     Running   0          5m40s\nvmstorage-1   1/1     Running   0          3m31s\n\u2638 \u279c kubectl get svc -n kube-vm -l app=vmstorage\nNAME                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                      AGE\ncluster-vmstorage   ClusterIP   None         &lt;none&gt;        8482/TCP,8401/TCP,8400/TCP   5m46s\n</code></pre> <p>\u63a5\u7740\u53ef\u4ee5\u90e8\u7f72 vmselect \u7ec4\u4ef6\uff0c\u7531\u4e8e\u8be5\u7ec4\u4ef6\u662f\u65e0\u72b6\u6001\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Deployment \u6765\u8fdb\u884c\u7ba1\u7406\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># cluster-vmselect.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: vmselect\n  namespace: kube-vm\n  labels:\n    app: vmselect\nspec:\n  ports:\n    - name: http\n      port: 8481\n      targetPort: http\n  selector:\n    app: vmselect\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: vmselect\n  namespace: kube-vm\n  labels:\n    app: vmselect\nspec:\n  selector:\n    matchLabels:\n      app: vmselect\n  template:\n    metadata:\n      labels:\n        app: vmselect\n    spec:\n      containers:\n        - name: vmselect\n          image: \"victoriametrics/vmselect:v1.77.0-cluster\"\n          imagePullPolicy: \"IfNotPresent\"\n          args:\n            - \"--cacheDataPath=/cache\"\n            - --storageNode=vmstorage-0.cluster-vmstorage.kube-vm.svc.cluster.local:8401\n            - --storageNode=vmstorage-1.cluster-vmstorage.kube-vm.svc.cluster.local:8401\n            - --envflag.enable=true\n            - --envflag.prefix=VM_\n            - --loggerFormat=json\n          ports:\n            - name: http\n              containerPort: 8481\n          readinessProbe:\n            httpGet:\n              path: /health\n              port: http\n            initialDelaySeconds: 5\n            periodSeconds: 15\n            timeoutSeconds: 5\n            failureThreshold: 3\n          livenessProbe:\n            tcpSocket:\n              port: http\n            initialDelaySeconds: 5\n            periodSeconds: 15\n            timeoutSeconds: 5\n            failureThreshold: 3\n          volumeMounts:\n            - mountPath: /cache\n              name: cache-volume\n      volumes:\n        - name: cache-volume\n          emptyDir: {}\n</code></pre> <pre><code>$ kubectl apply -f cluster-vmselect.yaml \nservice/vmselect created\ndeployment.apps/vmselect created\n\n$ kubectl get pod -n kube-vm\nNAME                       READY   STATUS    RESTARTS   AGE\nvmselect-bcb54965f-sfrcw   1/1     Running   0          39s\nvmstorage-0                1/1     Running   0          4m11s\n</code></pre> <p>\u5176\u4e2d\u6700\u91cd\u8981\u7684\u90e8\u5206\u662f\u901a\u8fc7 <code>--storageNode</code> \u53c2\u6570\u6307\u5b9a\u6240\u6709\u7684 <code>vmstorage</code> \u8282\u70b9\u5730\u5740\uff0c\u4e0a\u9762\u6211\u4eec\u4f7f\u7528\u7684 StatefulSet \u90e8\u7f72\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 FQDN \u7684\u5f62\u5f0f\u8fdb\u884c\u8bbf\u95ee\u3002\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u5bf9\u8c61\uff1a</p> <pre><code>\u2638 \u279c kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/cluster-vmselect.yaml\n\u2638 \u279c kubectl get pods -n kube-vm -l app=vmselect\nNAME                       READY   STATUS    RESTARTS   AGE\nvmselect-bcb54965f-5rkml   1/1     Running   0          2m4s\n\u2638 \u279c kubectl get svc -n kube-vm -l app=vmselect\nNAME       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nvmselect   ClusterIP   10.107.227.214   &lt;none&gt;        8481/TCP   2m17s\n</code></pre> <p>\u5982\u679c\u8981\u8fdb\u884c\u67e5\u8be2\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5bf9\u5916\u66b4\u9732 vmselect \u8fd9\u4e2a Service \u670d\u52a1\u5373\u53ef\uff0c\u4fee\u6539 Grafana \u6570\u636e\u6e90\u5730\u5740\u4e3a <code>http://&lt;select-service&gt;/select/0/prometheus/</code>\u3002</p> <p><code>vm-grafana.yaml</code></p> <pre><code># vm-grafana.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: grafana\n  namespace: kube-vm\nspec:\n  selector:\n    matchLabels:\n      app: grafana\n  template:\n    metadata:\n      labels:\n        app: grafana\n    spec:\n      volumes:\n        - name: storage\n          persistentVolumeClaim:\n            claimName: grafana-data\n      containers:\n        - name: grafana\n          image: grafana/grafana:main\n          imagePullPolicy: IfNotPresent\n          ports:\n            - containerPort: 3000\n              name: grafana\n          securityContext:\n            runAsUser: 0\n          env:\n            - name: GF_SECURITY_ADMIN_USER\n              value: admin\n            - name: GF_SECURITY_ADMIN_PASSWORD\n              value: admin321\n          volumeMounts:\n            - mountPath: /var/lib/grafana\n              name: storage\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: grafana\n  namespace: kube-vm\nspec:\n  type: NodePort\n  ports:\n    - port: 3000\n  selector:\n    app: grafana\n# ---\n# apiVersion: v1\n# kind: PersistentVolume\n# metadata:\n#   name: grafana-data\n# spec:\n#   accessModes:\n#     - ReadWriteOnce\n#   capacity:\n#     storage: 500Mi\n#   storageClassName: hostpath\n#   local:\n#     path: /data/k8s/grafana\n#   persistentVolumeReclaimPolicy: Retain\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: grafana-data\n  namespace: kube-vm\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 500Mi\n  storageClassName: hostpath\n</code></pre> <p>\u5982\u679c\u8981\u8fdb\u884c\u67e5\u8be2\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5bf9\u5916\u66b4\u9732 vmselect \u8fd9\u4e2a Service \u670d\u52a1\u5373\u53ef\uff0c\u4fee\u6539 Grafana \u6570\u636e\u6e90\u5730\u5740\u4e3a <code>http://&lt;select-service&gt;/select/0/prometheus/</code>\u3002</p> <p><code>http://vmselect:8481/select/0/prometheus/</code></p> <p></p> <p>\u63a5\u7740\u5c31\u9700\u8981\u90e8\u7f72\u7528\u6765\u63a5\u6536\u6307\u6807\u6570\u636e\u63d2\u5165\u7684 vminsert \u7ec4\u4ef6\uff0c\u540c\u6837\u8be5\u7ec4\u4ef6\u662f\u65e0\u72b6\u6001\u7684\uff0c\u5176\u4e2d\u6700\u91cd\u8981\u7684\u4e5f\u662f\u9700\u8981\u901a\u8fc7 <code>--storageNode</code> \u53c2\u6570\u6307\u5b9a\u6240\u6709\u7684 vmstorage \u8282\u70b9\uff1a</p> <pre><code># cluster-vminsert.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: vminsert\n  namespace: kube-vm\n  labels:\n    app: vminsert\nspec:\n  ports:\n    - name: http\n      port: 8480\n      targetPort: http\n  selector:\n    app: vminsert\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: vminsert\n  namespace: kube-vm\n  labels:\n    app: vminsert\nspec:\n  selector:\n    matchLabels:\n      app: vminsert\n  template:\n    metadata:\n      labels:\n        app: vminsert\n    spec:\n      containers:\n        - name: vminsert\n          image: \"victoriametrics/vminsert:v1.77.0-cluster\"\n          imagePullPolicy: \"IfNotPresent\"\n          args:\n            # - -replicationFactor=2 # \u53ef\u4ee5\u5f00\u542f\u6570\u636e\u526f\u672c\n            - --storageNode=vmstorage-0.cluster-vmstorage.kube-vm.svc.cluster.local:8400\n            - --storageNode=vmstorage-1.cluster-vmstorage.kube-vm.svc.cluster.local:8400\n            - --envflag.enable=true\n            - --envflag.prefix=VM_\n            - --loggerFormat=json\n          ports:\n            - name: http\n              containerPort: 8480\n          readinessProbe:\n            httpGet:\n              path: /health\n              port: http\n            initialDelaySeconds: 5\n            periodSeconds: 15\n            timeoutSeconds: 5\n            failureThreshold: 3\n          livenessProbe:\n            tcpSocket:\n              port: http\n            initialDelaySeconds: 5\n            periodSeconds: 15\n            timeoutSeconds: 5\n            failureThreshold: 3\n</code></pre> <p>\u7531\u4e8e\u672c\u8eab\u662f\u65e0\u72b6\u6001\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u6839\u636e\u9700\u8981\u589e\u52a0\u526f\u672c\u6570\u91cf\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e HPA \u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u3002\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\uff1a</p> <pre><code>$ kubectl apply -f cluster-vminsert.yaml \nservice/vminsert created\ndeployment.apps/vminsert created\n</code></pre> <pre><code>\n\u2638 \u279c kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/cluster-vminsert.yaml\n\u2638 \u279c kubectl get pods -n kube-vm -l app=vminsert\nNAME                        READY   STATUS    RESTARTS   AGE\nvminsert-66c88cd497-l64ps   1/1     Running   0          2m27s\n\u2638 \u279c kubectl get svc -n kube-vm -l app=vminsert\nNAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nvminsert   ClusterIP   10.96.125.134   &lt;none&gt;        8480/TCP   70s\n</code></pre> <pre><code>$ ifconfig | grep 192.168\n    inet 192.168.1.6 netmask 0xffffff00 broadcast 192.168.1.255\n</code></pre> <p>\u96c6\u7fa4\u6a21\u5f0f\u7684\u76f8\u5173\u7ec4\u4ef6\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u5148\u53bb\u914d\u7f6e\u524d\u9762\u7684 Prometheus\uff0c\u5c06\u5176\u6570\u636e\u8fdc\u7a0b\u5199\u5165\u5230 VM \u4e2d\u6765\uff0c\u4fee\u6539 <code>remote_write</code> \u7684\u5730\u5740\u4e3a <code>http://vminsert:8480/insert/0/prometheus/</code>\uff0c\u6ce8\u610f\u548c\u5355\u8282\u70b9\u6a21\u5f0f\u7684 API \u8def\u5f84\u4e0d\u4e00\u6837\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># vm-prom-config3.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-vm\ndata:\n  prometheus.yaml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n    remote_write:    # \u5199\u5165\u5230\u8fdc\u7a0b VM \u5b58\u50a8\uff0curl \u662f\u8fdc\u7a0b\u5199\u5165\u63a5\u53e3\u5730\u5740\n    - url: http://vminsert:8480/insert/0/prometheus/\n      # queue_config:    # \u5982\u679c Prometheus \u6293\u53d6\u6307\u6807\u5f88\u5927\uff0c\u53ef\u4ee5\u52a0\u8c03\u6574 queue\uff0c\u4f46\u662f\u4f1a\u63d0\u9ad8\u5185\u5b58\u5360\u7528\n      #   max_samples_per_send: 10000  # \u6bcf\u6b21\u53d1\u9001\u7684\u6700\u5927\u6837\u672c\u6570\n      #   capacity: 20000  \n      #   max_shards: 30   # \u6700\u5927\u5206\u7247\u6570\uff0c\u5373\u5e76\u53d1\u91cf\u3002\n    scrape_configs:\n    - job_name: \"nodes\"\n      static_configs:\n      # - targets: ['192.168.0.109:9111', '192.168.0.110:9111', '192.168.0.111:9111']\n      - targets: ['192.168.1.6:9100']\n      relabel_configs: # \u901a\u8fc7 relabeling \u4ece __address__ \u4e2d\u63d0\u53d6 IP \u4fe1\u606f\uff0c\u4e3a\u4e86\u540e\u9762\u9a8c\u8bc1 VM \u662f\u5426\u517c\u5bb9 relabeling\n      - source_labels: [__address__]\n        regex: \"(.*):(.*)\"\n        replacement: \"${1}\"\n        target_label: 'ip'\n        action: replace\n</code></pre> <pre><code>$ kubectl get pod -n kube-vm\nNAME                        READY   STATUS    RESTARTS   AGE\ngrafana-bbd99dc7-gv59q      1/1     Running   0          11m\nvminsert-66c88cd497-9k6fx   1/1     Running   0          88s\nvmselect-bcb54965f-sfrcw    1/1     Running   0          22m\nvmstorage-0                 1/1     Running   0          26m\n</code></pre> <pre><code>$ kubectl apply -f vm-prom-config3.yaml \nconfigmap/prometheus-config created\n</code></pre> <p>\u66f4\u65b0 Prometheus \u914d\u7f6e\uff0c\u7136\u540e\u542f\u52a8 Prometheus\uff0c\u524d\u9762\u7684\u5355\u673a\u6a21\u5f0f\u7684 VM \u53ef\u4ee5\u5148\u505c\u6389\uff1a</p> <pre><code>\u2638 \u279c kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vm-prom-config3.yaml\n\u2638 \u279c kubectl scale deploy victoria-metrics --replicas=0 -n kube-vm\n\u2638 \u279c kubectl scale deploy prometheus --replicas=1 -n kube-vm\n</code></pre> <pre><code># vm-prom-deploy.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: prometheus\n  namespace: kube-vm\nspec:\n  selector:\n    matchLabels:\n      app: prometheus\n  template:\n    metadata:\n      labels:\n        app: prometheus\n    spec:\n      volumes:\n        - name: data\n          persistentVolumeClaim:\n            claimName: prometheus-data\n        - name: config-volume\n          configMap:\n            name: prometheus-config\n      containers:\n        - image: prom/prometheus:v2.35.0\n          name: prometheus\n          args:\n            - \"--config.file=/etc/prometheus/prometheus.yaml\"\n            - \"--storage.tsdb.path=/prometheus\" # \u6307\u5b9atsdb\u6570\u636e\u8def\u5f84\n            - \"--storage.tsdb.retention.time=2d\"\n            - \"--web.enable-lifecycle\" # \u652f\u6301\u70ed\u66f4\u65b0\uff0c\u76f4\u63a5\u6267\u884clocalhost:9090/-/reload\u7acb\u5373\u751f\u6548\n          ports:\n            - containerPort: 9090\n              name: http\n          securityContext:\n            runAsUser: 0\n          volumeMounts:\n            - mountPath: \"/etc/prometheus\"\n              name: config-volume\n            - mountPath: \"/prometheus\"\n              name: data\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\n  namespace: kube-vm\nspec:\n  selector:\n    app: prometheus\n  type: NodePort\n  ports:\n    - name: web\n      port: 9090\n      targetPort: http\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: prometheus-data\n  namespace: kube-vm\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 500Mi\n  storageClassName: hostpath\n</code></pre> <p>\u914d\u7f6e\u6210\u529f\u540e\u6b63\u5e38\u6570\u636e\u5c31\u53ef\u4ee5\u5f00\u59cb\u5199\u5165\u5230 vmstorage \u4e86\uff0c\u67e5\u770b vmstorage \u65e5\u5fd7\u53ef\u4ee5\u770b\u5230\u6210\u529f\u521b\u5efa\u4e86 partition\uff0c\u8bc1\u660e\u73b0\u5728\u5df2\u7ecf\u5728\u5f00\u59cb\u63a5\u6536\u6570\u636e\u4e86\uff1a</p> <pre><code>\u2638 \u279c kubectl logs -f vmstorage-0 -n kube-vm\n......\n{\"ts\":\"2022-05-06T08:35:15.786Z\",\"level\":\"info\",\"caller\":\"VictoriaMetrics/lib/storage/partition.go:206\",\"msg\":\"creating a partition \\\"2022_05\\\" with smallPartsPath=\\\"/storage/data/small/2022_05\\\", bigPartsPath=\\\"/storage/data/big/2022_05\\\"\"}\n{\"ts\":\"2022-05-06T08:35:15.802Z\",\"level\":\"info\",\"caller\":\"VictoriaMetrics/lib/storage/partition.go:222\",\"msg\":\"partition \\\"2022_05\\\" has been created\"}\n</code></pre> <p>\u7136\u540e\u5bfc\u5165 16098 \u8fd9\u4e2a Dashboard\uff0c\u5bfc\u5165\u540e\u6548\u679c\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p></p> <p>\u7136\u540e\u53ef\u4ee5\u53bb Grafana \u91cd\u65b0\u67e5\u770b Dashboard \u662f\u5426\u6b63\u5e38\uff1a</p> <p></p> <p>\u5982\u679c\u73b0\u5728\u9700\u8981\u65b0\u589e vmstorage \u8282\u70b9\uff0c\u90a3\u4e48\u9700\u8981\u6309\u7167\u4e0b\u9762\u7684\u6b65\u9aa4\u8fdb\u884c\u64cd\u4f5c\uff1a</p> <ul> <li>\u4f7f\u7528\u4e0e\u96c6\u7fa4\u4e2d\u73b0\u6709\u8282\u70b9\u76f8\u540c\u7684 <code>-retentionPeriod</code> \u914d\u7f6e\u542f\u52a8\u65b0\u7684 vmstorage \u8282\u70b9\u3002</li> <li>\u9010\u6b65\u91cd\u65b0\u542f\u52a8\u6240\u6709\u7684 vmselect \u8282\u70b9\uff0c\u6dfb\u52a0\u65b0\u7684 <code>-storageNode</code> \u53c2\u6570\u5305\u542b <code>&lt;new_vmstorage_host&gt;</code>\u3002</li> <li>\u9010\u6b65\u91cd\u65b0\u542f\u52a8\u6240\u6709\u7684 vminsert \u8282\u70b9\uff0c\u6dfb\u52a0\u65b0\u7684 <code>-storageNode</code> \u53c2\u6570\u5305\u542b <code>&lt;new_vmstorage_host&gt;</code>\u3002</li> </ul>"},{"location":"chap12/70vm_vmagent/","title":"\u7b2c\u56db\u8282 \u4f7f\u7528vmagent\u4ee3\u66ffPrometheus\u91c7\u96c6\u76d1\u63a7\u6307\u6807","text":"<p>vmagent \u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u4ece\u5404\u79cd\u6765\u6e90\u6536\u96c6\u6307\u6807\u5e76\u5c06\u5b83\u4eec\u5b58\u50a8\u5728 VM \u6216\u8005\u4efb\u4f55\u5176\u4ed6\u652f\u6301 remote write \u534f\u8bae\u7684 Prometheus \u517c\u5bb9\u7684\u5b58\u50a8\u7cfb\u7edf\u4e2d\u3002</p>"},{"location":"chap12/70vm_vmagent/#1","title":"1 \u7279\u6027","text":"<p>vmagent \u76f8\u6bd4\u4e8e Prometheus \u6293\u53d6\u6307\u6807\u6765\u8bf4\u5177\u6709\u66f4\u591a\u7684\u7075\u6d3b\u6027\uff0c\u6bd4\u5982\u9664\u4e86\u62c9\u53d6\uff08pull\uff09\u6307\u6807\u8fd8\u53ef\u4ee5\u63a8\u9001\uff08push\uff09\u6307\u6807\uff0c\u6b64\u5916\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7279\u6027\uff1a</p> <ul> <li>\u53ef\u4ee5\u66ff\u6362 prometheus \u7684 scraping target</li> <li>\u652f\u6301\u4ece Kafka \u8bfb\u5199\u6570\u636e</li> <li>\u652f\u6301\u57fa\u4e8e prometheus relabeling \u7684\u6a21\u5f0f\u6dfb\u52a0\u3001\u79fb\u9664\u3001\u4fee\u6539 labels\uff0c\u53ef\u4ee5\u5728\u6570\u636e\u53d1\u9001\u5230\u8fdc\u7aef\u5b58\u50a8\u4e4b\u524d\u8fdb\u884c\u6570\u636e\u7684\u8fc7\u6ee4</li> <li>\u652f\u6301\u591a\u79cd\u6570\u636e\u534f\u8bae\uff0cinflux line \u534f\u8bae\uff0cgraphite \u6587\u672c\u534f\u8bae\uff0copentsdb \u534f\u8bae\uff0cprometheus remote write \u534f\u8bae\uff0cjson lines \u534f\u8bae\uff0ccsv \u6570\u636e\u7b49</li> <li>\u652f\u6301\u6536\u96c6\u6570\u636e\u7684\u540c\u65f6\uff0c\u5e76\u590d\u5236\u5230\u591a\u79cd\u8fdc\u7aef\u5b58\u50a8\u7cfb\u7edf</li> <li>\u652f\u6301\u4e0d\u53ef\u9760\u8fdc\u7aef\u5b58\u50a8\uff0c\u5982\u679c\u8fdc\u7a0b\u5b58\u50a8\u4e0d\u53ef\u7528\uff0c\u6536\u96c6\u7684\u6307\u6807\u4f1a\u5728 <code>-remoteWrite.tmpDataPath</code> \u7f13\u51b2\uff0c\u4e00\u65e6\u4e0e\u8fdc\u7a0b\u5b58\u50a8\u7684\u8fde\u63a5\u88ab\u4fee\u590d\uff0c\u7f13\u51b2\u7684\u6307\u6807\u5c31\u4f1a\u88ab\u53d1\u9001\u5230\u8fdc\u7a0b\u5b58\u50a8\uff0c\u7f13\u51b2\u533a\u7684\u6700\u5927\u78c1\u76d8\u7528\u91cf\u53ef\u4ee5\u7528 <code>-remoteWrite.maxDiskUsagePerURL</code> \u6765\u9650\u5236\u3002</li> <li>\u76f8\u6bd4 prometheus \u4f7f\u7528\u66f4\u5c11\u7684\u5185\u5b58\u3001cpu\u3001\u78c1\u76d8 io \u4ee5\u53ca\u7f51\u7edc\u5e26\u5bbd</li> <li>\u5f53\u9700\u8981\u6293\u53d6\u5927\u91cf\u76ee\u6807\u65f6\uff0c\u6293\u53d6\u76ee\u6807\u53ef\u4ee5\u5206\u6563\u5230\u591a\u4e2a vmagent \u5b9e\u4f8b\u4e2d</li> <li>\u53ef\u4ee5\u901a\u8fc7\u5728\u6293\u53d6\u65f6\u95f4\u548c\u5c06\u5176\u53d1\u9001\u5230\u8fdc\u7a0b\u5b58\u50a8\u7cfb\u7edf\u4e4b\u524d\u9650\u5236\u552f\u4e00\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u91cf\u6765\u5904\u7406\u9ad8\u57fa\u6570\u548c\u9ad8\u6d41\u5931\u7387\u95ee\u9898</li> <li>\u53ef\u4ee5\u4ece\u591a\u4e2a\u6587\u4ef6\u4e2d\u52a0\u8f7d scrape \u914d\u7f6e</li> </ul> <p></p>"},{"location":"chap12/70vm_vmagent/#1_1","title":"1 \u90e8\u7f72","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u4ee5\u6293\u53d6 Kubernetes \u96c6\u7fa4\u6307\u6807\u4e3a\u4f8b\u8bf4\u660e\u5982\u4f55\u4f7f\u7528 vmagent\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u81ea\u52a8\u53d1\u73b0\u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u914d\u7f6e\u3002vmagent \u662f\u517c\u5bb9 prometheus \u4e2d\u7684 <code>kubernetes_sd_configs</code> \u914d\u7f6e\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u4f7f\u7528\u3002</p> <p>\u8981\u8ba9 vmagent \u81ea\u52a8\u53d1\u73b0\u76d1\u63a7\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u9700\u8981\u8bbf\u95ee APIServer \u83b7\u53d6\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u9996\u5148\u9700\u8981\u914d\u7f6e rbac \u6743\u9650\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u6e05\u5355\u3002</p> <pre><code># vmagent-rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: vmagent\n  namespace: kube-vm\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: vmagent\nrules:\n  - apiGroups: [\"\", \"networking.k8s.io\", \"extensions\"]\n    resources:\n      - nodes\n      - nodes/metrics\n      - services\n      - endpoints\n      - endpointslices\n      - pods\n      - app\n      - ingresses\n    verbs: [\"get\", \"list\", \"watch\"]\n  - apiGroups: [\"\"]\n    resources:\n      - namespaces\n      - configmaps\n    verbs: [\"get\"]\n  - nonResourceURLs: [\"/metrics\", \"/metrics/resources\"]\n    verbs: [\"get\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: vmagent\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: vmagent\nsubjects:\n  - kind: ServiceAccount\n    name: vmagent\n    namespace: kube-vm\n</code></pre> <p>\u7136\u540e\u6dfb\u52a0 vmagent \u914d\u7f6e\uff0c\u6211\u4eec\u5148\u53ea\u914d\u7f6e\u81ea\u52a8\u53d1\u73b0 Kubernetes \u8282\u70b9\u7684\u4efb\u52a1\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 ConfigMap \u5bf9\u8c61\uff1a</p> <pre><code># vmagent-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: vmagent-config\n  namespace: kube-vm\ndata:\n  scrape.yml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n\n    scrape_configs:\n    - job_name: nodes\n      kubernetes_sd_configs:\n        - role: node\n      relabel_configs:\n      - source_labels: [__address__]\n        regex: \"(.*):10250\"\n        replacement: \"${1}:9111\"\n        target_label: __address__\n        action: replace\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7\u81ea\u52a8\u53d1\u73b0 Kubernetes \u8282\u70b9\u83b7\u53d6\u8282\u70b9\u76d1\u63a7\u6307\u6807\uff0c\u9700\u8981\u6ce8\u610f node \u8fd9\u79cd role \u7684\u81ea\u52a8\u53d1\u73b0\u9ed8\u8ba4\u83b7\u53d6\u7684\u662f\u8282\u70b9\u7684 10250 \u7aef\u53e3\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u901a\u8fc7 relabel \u5c06\u5176 replace \u4e3a 9111\u3002</p> <p>\u7136\u540e\u6dfb\u52a0 vmagent \u90e8\u7f72\u8d44\u6e90\u6e05\u5355\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># vmagent-deploy.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: vmagent-pvc\n  namespace: kube-vm\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n  storageClassName: nfs-client\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: vmagent\n  namespace: kube-vm\n  labels:\n    app: vmagent\nspec:\n  selector:\n    matchLabels:\n      app: vmagent\n  template:\n    metadata:\n      labels:\n        app: vmagent\n    spec:\n      serviceAccountName: vmagent\n      containers:\n        - name: agent\n          image: \"victoriametrics/vmagent:v1.77.0\"\n          imagePullPolicy: IfNotPresent\n          args:\n            - -promscrape.config=/config/scrape.yml\n            - -remoteWrite.tmpDataPath=/tmpData\n            - -remoteWrite.url=http://vminsert:8480/insert/0/prometheus\n            - -envflag.enable=true\n            - -envflag.prefix=VM_\n            - -loggerFormat=json\n          ports:\n            - name: http\n              containerPort: 8429\n          volumeMounts:\n            - name: tmpdata\n              mountPath: /tmpData\n            - name: config\n              mountPath: /config\n      volumes:\n        - name: tmpdata\n          persistentVolumeClaim:\n            claimName: vmagent-pvc\n        - name: config\n          configMap:\n            name: vmagent-config\n</code></pre> <p>\u6211\u4eec\u5c06 vmagent \u914d\u7f6e\u901a\u8fc7 ConfigMap \u6302\u8f7d\u5230\u5bb9\u5668 <code>/config/scrape.yml</code>\uff0c\u53e6\u5916\u901a\u8fc7 <code>-remoteWrite.url=http://vminsert:8480/insert/0/prometheus</code> \u6307\u5b9a\u8fdc\u7a0b\u5199\u5165\u7684\u5730\u5740\uff0c\u8fd9\u91cc\u6211\u4eec\u5199\u5165\u524d\u9762\u7684 <code>vminsert</code> \u670d\u52a1\uff0c\u53e6\u5916\u6709\u4e00\u4e2a\u53c2\u6570 <code>-remoteWrite.tmpDataPath</code>\uff0c\u8be5\u8def\u5f84\u4f1a\u5728\u8fdc\u7a0b\u5b58\u50a8\u4e0d\u53ef\u7528\u7684\u65f6\u5019\u7528\u6765\u7f13\u5b58\u6536\u96c6\u7684\u6307\u6807\uff0c\u5f53\u8fdc\u7a0b\u5b58\u50a8\u4fee\u590d\u540e\uff0c\u7f13\u5b58\u7684\u6307\u6807\u5c31\u4f1a\u88ab\u6b63\u5e38\u53d1\u9001\u5230\u8fdc\u7a0b\u5199\u5165\uff0c\u6240\u4ee5\u6700\u597d\u6301\u4e45\u5316\u8be5\u76ee\u5f55\u3002</p>"},{"location":"chap12/70vm_vmagent/#2","title":"2 \u96c6\u7fa4\u6a21\u5f0f","text":"<p>\u5355\u4e2a vmagent \u5b9e\u4f8b\u53ef\u4ee5\u6293\u53d6\u6570\u4e07\u4e2a\u6293\u53d6\u76ee\u6807\uff0c\u4f46\u662f\u6709\u65f6\u7531\u4e8e CPU\u3001\u7f51\u7edc\u3001\u5185\u5b58\u7b49\u65b9\u9762\u7684\u9650\u5236\uff0c\u8fd9\u8fd8\u4e0d\u591f\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6293\u53d6\u76ee\u6807\u53ef\u4ee5\u5728\u591a\u4e2a vmagent \u5b9e\u4f8b\u4e4b\u95f4\u8fdb\u884c\u62c6\u5206\u3002\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a vmagent \u5b9e\u4f8b\u5fc5\u987b\u4f7f\u7528\u5177\u6709\u4e0d\u540c <code>-promscrape.cluster.memberNum</code> \u503c\u7684\u76f8\u540c <code>-promscrape.config</code> \u914d\u7f6e\u6587\u4ef6\uff0c\u8be5\u53c2\u6570\u503c\u5fc5\u987b\u5728 <code>0 ... N-1</code> \u8303\u56f4\u5185\uff0c\u5176\u4e2d N \u662f\u96c6\u7fa4\u4e2d vmagent \u5b9e\u4f8b\u7684\u6570\u91cf\u3002\u96c6\u7fa4\u4e2d vmagent \u5b9e\u4f8b\u7684\u6570\u91cf\u5fc5\u987b\u4f20\u9012\u7ed9 <code>-promscrape.cluster.membersCount</code> \u547d\u4ee4\u884c\u6807\u5fd7\u3002</p> <p>\u4f8b\u5982\uff0c\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u5728\u4e24\u4e2a vmagent \u5b9e\u4f8b\u7684\u96c6\u7fa4\u4e2d\u4f20\u64ad\u6293\u53d6\u76ee\u6807\uff1a</p> <pre><code>\nvmagent -promscrape.cluster.membersCount=2 -promscrape.cluster.memberNum=0 -promscrape.config=/path/config.yml ...\nvmagent -promscrape.cluster.membersCount=2 -promscrape.cluster.memberNum=1 -promscrape.config=/path/config.yml ...\n</code></pre> <p>\u5f53 vmagent \u5728 Kubernetes \u4e2d\u8fd0\u884c\u65f6\uff0c\u53ef\u4ee5\u5c06 <code>-promscrape.cluster.memberNum</code> \u8bbe\u7f6e\u4e3a <code>StatefulSet pod</code> \u540d\u79f0\uff0cpod \u540d\u79f0\u5fc5\u987b\u4ee5 0 ... <code>promscrape.cluster.memberNum-1</code> \u8303\u56f4\u5185\u7684\u6570\u5b57\u7ed3\u5c3e\uff0c\u4f8b\u5982\uff0c<code>-promscrape.cluster.memberNum=vmagent-0</code>\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6bcf\u4e2a\u6293\u53d6\u76ee\u6807\u4ec5\u7531\u96c6\u7fa4\u4e2d\u7684\u5355\u4e2a <code>vmagent</code> \u5b9e\u4f8b\u6293\u53d6\u3002\u5982\u679c\u9700\u8981\u5728\u591a\u4e2a <code>vmagent</code> \u5b9e\u4f8b\u4e4b\u95f4\u590d\u5236\u6293\u53d6\u76ee\u6807\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7 <code>-promscrape.cluster.replicationFactor</code> \u53c2\u6570\u8bbe\u7f6e\u4e3a\u6240\u9700\u7684\u526f\u672c\u6570\u3002</p> <p>\u4f8b\u5982\uff0c\u4ee5\u4e0b\u547d\u4ee4\u542f\u52a8\u4e00\u4e2a\u5305\u542b\u4e09\u4e2a vmagent \u5b9e\u4f8b\u7684\u96c6\u7fa4\uff0c\u5176\u4e2d\u6bcf\u4e2a\u76ee\u6807\u7531\u4e24\u4e2a vmagent \u5b9e\u4f8b\u6293\u53d6\uff1a</p> <pre><code>vmagent -promscrape.cluster.membersCount=3 -promscrape.cluster.replicationFactor=2 -promscrape.cluster.memberNum=0 -promscrape.config=/path/to/config.yml ...\nvmagent -promscrape.cluster.membersCount=3 -promscrape.cluster.replicationFactor=2 -promscrape.cluster.memberNum=1 -promscrape.config=/path/to/config.yml ...\nvmagent -promscrape.cluster.membersCount=3 -promscrape.cluster.replicationFactor=2 -promscrape.cluster.memberNum=2 -promscrape.config=/path/to/config.yml ...\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u6bcf\u4e2a\u76ee\u6807\u88ab\u591a\u4e2a vmagent \u5b9e\u4f8b\u6293\u53d6\uff0c\u5219\u5fc5\u987b\u5728 <code>-remoteWrite.url</code> \u6307\u5411\u7684\u8fdc\u7a0b\u5b58\u50a8\u4e0a\u542f\u7528\u91cd\u590d\u6570\u636e\u5220\u9664\u3002</p> <p>\u6240\u4ee5\u5982\u679c\u4f60\u6293\u53d6\u7684\u76d1\u63a7\u76ee\u6807\u975e\u5e38\u5927\uff0c\u90a3\u4e48\u6211\u4eec\u5efa\u8bae\u4f7f\u7528 vmagent \u96c6\u7fa4\u6a21\u5f0f\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528 StatefulSet \u65b9\u5f0f\u8fdb\u884c\u90e8\u7f72</p> <pre><code># vmagent-sts.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: vmagent\n  namespace: kube-vm\n  annotations:\n    prometheus.io/scrape: \"true\"\n    prometheus.io/port: \"8429\"\nspec:\n  selector:\n    app: vmagent\n  clusterIP: None\n  ports:\n    - name: http\n      port: 8429\n      targetPort: http\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: vmagent\n  namespace: kube-vm\n  labels:\n    app: vmagent\nspec:\n  replicas: 2\n  serviceName: vmagent\n  selector:\n    matchLabels:\n      app: vmagent\n  template:\n    metadata:\n      labels:\n        app: vmagent\n    spec:\n      serviceAccountName: vmagent\n      containers:\n        - name: agent\n          image: victoriametrics/vmagent:v1.77.0\n          imagePullPolicy: IfNotPresent\n          args:\n            - -promscrape.config=/config/scrape.yml\n            - -remoteWrite.tmpDataPath=/tmpData\n            - -promscrape.cluster.membersCount=2\n            # - -promscrape.cluster.replicationFactor=2 # \u53ef\u4ee5\u914d\u7f6e\u526f\u672c\u6570\n            - -promscrape.cluster.memberNum=$(POD_NAME)\n            - -remoteWrite.url=http://vminsert:8480/insert/0/prometheus\n            - -envflag.enable=true\n            - -envflag.prefix=VM_\n            - -loggerFormat=json\n          ports:\n            - name: http\n              containerPort: 8429\n          env:\n            - name: POD_NAME\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.name\n          volumeMounts:\n            - name: tmpdata\n              mountPath: /tmpData\n            - name: config\n              mountPath: /config\n      volumes:\n        - name: config\n          configMap:\n            name: vmagent-config\n  volumeClaimTemplates:\n    - metadata:\n        name: tmpdata\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        storageClassName: nfs-client\n        resources:\n          requests:\n            storage: 1Gi\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u5c31\u4f7f\u7528 StatefulSet \u7684\u5f62\u5f0f\u6765\u7ba1\u7406 vmagent\uff0c\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u5373\u53ef\uff1a</p> <pre><code># \u5148\u5c06\u524d\u9762\u793a\u4f8b\u4e2d\u7684 prometheus \u505c\u6389\n\u2638 \u279c kubectl scale deploy prometheus --replicas=0 -n kube-vm\n\u2638 \u279c kubectl apply -f vmagent-rbac.yaml\n\u2638 \u279c kubectl apply -f vmagent-config.yaml\n\u2638 \u279c kubectl apply -f vmagent-sts.yaml\n\u2638 \u279c kubectl get pods -n kube-vm -l app=vmagent\nNAME        READY   STATUS    RESTARTS   AGE\nvmagent-0   1/1     Running   0          3m43s\nvmagent-1   1/1     Running   0          2m9s\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u90e8\u7f72\u4e86\u4e24\u4e2a vmagent \u5b9e\u4f8b\u6765\u6293\u53d6\u76d1\u63a7\u6307\u6807\uff0c\u6211\u4eec\u8fd9\u91cc\u4e00\u5171 3 \u4e2a\u8282\u70b9\u3002</p> <pre><code>\u2638 \u279c kubectl get nodes\nNAME      STATUS   ROLES                  AGE   VERSION\nmaster1   Ready    control-plane,master   44d   v1.22.8\nnode1     Ready    &lt;none&gt;                 44d   v1.22.8\nnode2     Ready    &lt;none&gt;                 44d   v1.22.8\n</code></pre> <p>\u6240\u4ee5\u4e24\u4e2a vmagent \u5b9e\u4f8b\u4f1a\u5206\u522b\u91c7\u96c6\u90e8\u5206\u6307\u6807\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b\u65e5\u5fd7\u6765\u8fdb\u884c\u9a8c\u8bc1\uff1a</p> <pre><code>\n\u2638 \u279c kubectl logs -f vmagent-0 -n kube-vm\n# ......\n{\"ts\":\"2022-05-10T04:44:44.004Z\",\"level\":\"info\",\"caller\":\"VictoriaMetrics/lib/promscrape/scraper.go:393\",\"msg\":\"static_configs: added targets: 1, removed targets: 0; total targets: 1\"}\n{\"ts\":\"2022-05-10T04:44:44.006Z\",\"level\":\"info\",\"caller\":\"VictoriaMetrics/lib/promscrape/scraper.go:393\",\"msg\":\"kubernetes_sd_configs: added targets: 2, removed targets: 0; total targets: 2\"}\n\u2638 \u279c kubectl logs -f vmagent-1 -n kube-vm\n# ......\n{\"ts\":\"2022-05-10T04:46:17.893Z\",\"level\":\"info\",\"caller\":\"VictoriaMetrics/lib/promscrape/scraper.go:393\",\"msg\":\"kubernetes_sd_configs: added targets: 1, removed targets: 0; total targets: 1\"}\n</code></pre> <p>\u4ece\u65e5\u5fd7\u53ef\u4ee5\u770b\u51fa <code>vmagent-0</code> \u5b9e\u4f8b\u53d1\u73b0\u4e86 2 \u4e2a targets\uff0c<code>vmagent-1</code> \u5b9e\u4f8b\u53d1\u73b0\u4e86 1 \u4e2a targets\uff0c\u8fd9\u4e5f\u7b26\u5408\u6211\u4eec\u9884\u671f\u7684\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u65b0\u589e\u5176\u4ed6\u5185\u5bb9\u7684\u76d1\u63a7\uff0c\u6bd4\u5982 APIServer\u3001\u5bb9\u5668\u7b49\u7b49\uff0c\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># vmagent-config2.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: vmagent-config\n  namespace: kube-vm\ndata:\n  scrape.yml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n\n    scrape_configs:\n\n    - job_name: nodes\n      kubernetes_sd_configs:\n        - role: node\n      relabel_configs:\n      - source_labels: [__address__]\n        regex: \"(.*):10250\"\n        replacement: \"${1}:9111\"\n        target_label: __address__\n        action: replace\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n\n    - job_name: apiserver\n      scheme: https\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n        insecure_skip_verify: true\n      kubernetes_sd_configs:\n      - role: endpoints\n      relabel_configs:\n      - action: keep\n        regex: default;kubernetes;https\n        source_labels:\n        - __meta_kubernetes_namespace\n        - __meta_kubernetes_service_name\n        - __meta_kubernetes_endpoint_port_name\n\n    - job_name: cadvisor\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n        insecure_skip_verify: true\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n      - replacement: /metrics/cadvisor\n        target_label: __metrics_path__\n\n    - job_name: endpoints\n      kubernetes_sd_configs:\n      - role: endpoints\n      relabel_configs:\n      - action: drop\n        regex: true\n        source_labels:\n        - __meta_kubernetes_pod_container_init\n      - action: keep_if_equal\n        source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n        - __meta_kubernetes_pod_container_port_number\n      - action: keep\n        regex: true\n        source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scrape\n      - action: replace\n        regex: (https?)\n        source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_scheme\n        target_label: __scheme__\n      - action: replace\n        regex: (.+)\n        source_labels:\n        - __meta_kubernetes_service_annotation_prometheus_io_path\n        target_label: __metrics_path__\n      - action: replace\n        regex: ([^:]+)(?::\\d+)?;(\\d+)\n        replacement: $1:$2\n        source_labels:\n        - __address__\n        - __meta_kubernetes_service_annotation_prometheus_io_port\n        target_label: __address__\n      - action: labelmap\n        regex: __meta_kubernetes_service_label_(.+)\n      - source_labels:\n        - __meta_kubernetes_pod_name\n        target_label: pod\n      - source_labels:\n        - __meta_kubernetes_namespace\n        target_label: namespace\n      - source_labels:\n        - __meta_kubernetes_service_name\n        target_label: service\n      - replacement: ${1}\n        source_labels:\n        - __meta_kubernetes_service_name\n        target_label: job\n      - action: replace\n        source_labels:\n        - __meta_kubernetes_pod_node_name\n        target_label: node\n</code></pre> <p>\u5927\u90e8\u5206\u7684\u914d\u7f6e\u5728\u524d\u9762 Prometheus \u7ae0\u8282\u90fd\u4ecb\u7ecd\u8fc7\u4e86\uff0c\u6838\u5fc3\u5c31\u662f\u901a\u8fc7 <code>relabel_configs</code> \u6765\u63a7\u5236\u6293\u53d6\u7684\u4efb\u52a1\uff0cvmagent \u662f\u517c\u5bb9\u4f20\u7edf\u7684 prometheus \u91cd\u65b0\u6807\u8bb0\u89c4\u5219\u7684\uff0c\u4f46\u4e5f\u6709\u4e00\u4e9b\u72ec\u7279\u7684 action\uff0c\u6bd4\u5982\u4e0a\u9762\u914d\u7f6e\u4e2d\u6211\u4eec\u4f7f\u7528\u4e86\u4e00\u4e2a <code>keep_if_equal</code> \u7684\u64cd\u4f5c\uff0c\u8be5\u64cd\u4f5c\u7684\u610f\u601d\u662f\u5982\u679c\u6307\u5b9a\u7684\u6807\u7b7e\u503c\u76f8\u7b49\u5219\u5c06\u8be5\u6761\u6570\u636e\u4fdd\u7559\u4e0b\u6765\u3002</p> <p>\u6709\u65f6\uff0c\u5982\u679c\u67d0\u4e2a\u6307\u6807\u5305\u542b\u4e24\u4e2a\u5177\u6709\u76f8\u540c\u503c\u7684\u6807\u7b7e\uff0c\u5219\u9700\u8981\u5220\u9664\u5b83\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7 <code>vmagent</code> \u652f\u6301\u7684 <code>drop_if_equal</code> \u64cd\u4f5c\u6765\u5b8c\u6210\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4ee5\u4e0b <code>relabel</code> \u89c4\u5219\u5305\u542b<code>real_port</code> \u548c <code>required_port</code> \u7684\u76f8\u540c\u6807\u7b7e\u503c\uff0c\u5219\u5b83\u4f1a\u5220\u9664\u6307\u6807\uff1a</p> <pre><code>- action: drop_if_equal\n  source_labels: [real_port, needed_port]\n</code></pre> <p>\u8be5\u89c4\u5219\u5c06\u5220\u9664\u4ee5\u4e0b\u6307\u6807\uff1a<code>foo{real_port=\"123\",needed_port=\"123\"}</code>\uff0c\u4f46\u4f1a\u4fdd\u7559\u4ee5\u4e0b\u6307\u6807\uff1a<code>foo{real_port=\"123\",needed_port=\"456\"}</code>\u3002</p> <p>\u6709\u65f6\u53ef\u80fd\u9700\u8981\u53ea\u5bf9\u6307\u6807\u5b50\u96c6\u5e94\u7528 relabel\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u5c06 if \u9009\u9879\u6dfb\u52a0\u5230 <code>relabel_configs</code> \u89c4\u5219\u4e2d\uff0c\u4f8b\u5982\u4ee5\u4e0b\u89c4\u5219\u4ec5\u5c06 <code>{foo=\"bar\"}</code> \u6807\u7b7e\u6dfb\u52a0\u5230\u4e0e <code>metric{label=~\"x|y\"}</code> \u5e8f\u5217\u9009\u62e9\u5668\u5339\u914d\u7684\u6307\u6807\uff1a</p> <pre><code>- if: 'metric{label=~\"x|y\"}'\n  target_label: \"foo\"\n  replacement: \"bar\"\n</code></pre> <p>if \u9009\u9879\u53ef\u4ee5\u7b80\u5316\u4f20\u7edf\u7684 <code>relabel_configs</code> \u89c4\u5219\uff0c\u4f8b\u5982\uff0c\u4ee5\u4e0b\u89c4\u5219\u53ef\u4ee5\u5220\u9664\u4e0e <code>foo{bar=\"baz\"}</code> \u5e8f\u5217\u9009\u62e9\u5668\u5339\u914d\u7684\u6307\u6807\uff1a</p> <pre><code>- if: 'foo{bar=\"baz\"}'\n  action: drop\n</code></pre> <p>\u8fd9\u76f8\u5f53\u4e8e\u4ee5\u4e0b\u4f20\u7edf\u7684\u89c4\u5219\uff1a</p> <pre><code>- action: drop\n  source_labels: [__name__, bar]\n  regex: \"foo;baz\"\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f Prometheus \u8fd8\u4e0d\u652f\u6301 if \u9009\u9879\uff0c\u73b0\u5728\u53ea\u652f\u6301 <code>VictoriaMetrics</code>\u3002</p> <p>\u73b0\u5728\u66f4\u65b0 vmagent \u7684\u914d\u7f6e\u3002</p> <pre><code>\u2638 \u279c kubectl apply -f vmagent-config2.yaml\n</code></pre> <p>\u914d\u7f6e\u5237\u65b0\u6709\u4e24\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>\u53d1\u9001 SUGHUP \u4fe1\u53f7\u7ed9 vmagent \u8fdb\u7a0b</li> <li>\u5411 <code>http://vmagent:8429/-/reload</code> \u53d1\u9001\u4e00\u4e2a http \u8bf7\u6c42</li> </ul> <p>\u5237\u65b0\u540e\u5c31\u53ef\u4ee5\u5f00\u59cb\u91c7\u96c6\u4e0a\u9762\u7684\u6307\u6807\u4e86\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>http://vmselect/select/0/vmui/</code> \u6765\u8bbf\u95ee vmui\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6765\u67e5\u8be2 pod \u7684\u5185\u5b58\u4f7f\u7528\u7387\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>sum(container_memory_working_set_bytes{image!=\"\"}) by(namespace, pod) / sum(container_spec_memory_limit_bytes{image!=\"\"}) by(namespace, pod) * 100 != +inf\n</code></pre> <p></p> <p>vmagent \u4f5c\u4e3a\u91c7\u96c6\u6307\u6807\u91cd\u8981\u7684\u4e00\u73af\uff0c\u5f53\u7136\u5bf9\u5b83\u7684\u76d1\u63a7\u4e5f\u4e0d\u53ef\u5c11\u3002vmagent \u901a\u8fc7 <code>http://vmagent:8429/metrics</code> \u66b4\u9732\u4e86\u5f88\u591a\u6307\u6807\uff0c\u5982 <code>vmagent_remotewrite_conns</code> \u8fdc\u7a0b\u5b58\u50a8\u8fde\u63a5\uff0c<code>vm_allowed_memory_bytes</code> \u53ef\u4f7f\u7528\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u6211\u4eec\u628a\u4e00\u4e9b\u91cd\u8981\u7684\u6307\u6807\u6536\u96c6\u8d77\u6765\uff0c\u901a\u8fc7 Grafana \u8fdb\u884c\u5c55\u793a\uff0c\u80fd\u591f\u66f4\u597d\u7684\u5e2e\u52a9\u6211\u4eec\u5206\u6790 vmagent \u7684\u72b6\u6001\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>https://grafana.com/grafana/dashboards/12683</code> \u6765\u5c55\u793a vmagent \u7684\u72b6\u6001\u3002</p> <p></p>"},{"location":"chap12/71vm_operator/","title":"\u7b2c\u4e94\u8282 \u4f7f\u7528Victoria Metrics Operator\u7ba1\u7406VM\u96c6\u7fa4","text":"<p>Operator \u6211\u4eec\u77e5\u9053\u662f Kubernetes \u7684\u4e00\u5927\u6740\u5668\uff0c\u53ef\u4ee5\u5927\u5927\u7b80\u5316\u5e94\u7528\u7684\u5b89\u88c5\u3001\u914d\u7f6e\u548c\u7ba1\u7406\uff0c\u540c\u6837\u5bf9\u4e8e <code>VictoriaMetrics</code> \u5b98\u65b9\u4e5f\u5f00\u53d1\u4e86\u4e00\u4e2a\u5bf9\u5e94\u7684 Operator \u6765\u8fdb\u884c\u7ba1\u7406 - <code>vm-operator</code>\uff0c\u5b83\u7684\u8bbe\u8ba1\u548c\u5b9e\u73b0\u7075\u611f\u6765\u81ea <code>prometheus-operator</code>\uff0c\u5b83\u662f\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u76d1\u63a7\u914d\u7f6e\u7684\u7edd\u4f73\u5de5\u5177\u3002</p> <p></p> <p>vm-operator \u5b9a\u4e49\u4e86\u5982\u4e0b\u4e00\u4e9b CRD\uff1a</p> <ul> <li>VMCluster\uff1a\u5b9a\u4e49 VM \u96c6\u7fa4</li> <li>VMAgent\uff1a\u5b9a\u4e49 vmagent \u5b9e\u4f8b</li> <li>VMServiceScrape\uff1a\u5b9a\u4e49\u4ece Service \u652f\u6301\u7684 Pod \u4e2d\u6293\u53d6\u6307\u6807\u914d\u7f6e</li> <li>VMPodScrape\uff1a\u5b9a\u4e49\u4ece Pod \u4e2d\u6293\u53d6\u6307\u6807\u914d\u7f6e</li> <li>VMRule\uff1a\u5b9a\u4e49\u62a5\u8b66\u548c\u8bb0\u5f55\u89c4\u5219</li> <li>VMProbe\uff1a\u4f7f\u7528 blackbox exporter \u4e3a\u76ee\u6807\u5b9a\u4e49\u63a2\u6d4b\u914d\u7f6e</li> </ul> <p>\u6b64\u5916\u8be5 Operator \u9ed8\u8ba4\u8fd8\u53ef\u4ee5\u8bc6\u522b <code>prometheus-operator</code> \u4e2d\u7684 <code>ServiceMonitor</code>\u3001<code>PodMonitor</code>\u3001<code>PrometheusRule</code> \u548c <code>Probe</code> \u5bf9\u8c61\uff0c\u8fd8\u5141\u8bb8\u4f60\u4f7f\u7528 CRD \u5bf9\u8c61\u6765\u7ba1\u7406 Kubernetes \u96c6\u7fa4\u5185\u7684 VM \u5e94\u7528\u3002</p>"},{"location":"chap12/71vm_operator/#1","title":"1 \u5b89\u88c5","text":"<p>vm-operator \u63d0\u4f9b\u4e86 Helm Charts \u5305\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528 Helm \u6765\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff1a</p> <pre><code>\u2638 \u279c helm repo add vm https://victoriametrics.github.io/helm-charts/\n\u2638 \u279c helm repo update\n</code></pre> <p>\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\u5b9a\u5236 values \u503c\uff0c\u9ed8\u8ba4\u7684 <code>values.yaml</code>\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u83b7\u5f97\uff1a</p> <pre><code>\u2638 \u279c helm show values vm/victoria-metrics-operator &gt; values.yaml\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u53ea\u5bf9\u4e0b\u9762\u7684\u5185\u5bb9\u505a\u4e86\u4fee\u6539\uff1a</p> <pre><code># values.yaml\nrbac:\n  create: true\n  pspEnabled: false # \u4e0d\u521b\u5efapsp\n\noperator:\n  # -- \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cvm-operator\u4f1a\u8f6c\u6362prometheus-operator\u5bf9\u8c61\n  disable_prometheus_converter: false\n  # -- \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cvm-operator\u4f1a\u4e3a\u5b83\u7684\u5bf9\u8c61\u521b\u5efapsp\n  psp_auto_creation_enabled: false\n  # -- \u542f\u7528\u8f6c\u6362\u540e\u7684 prometheus-operator \u5bf9\u8c61\u7684\u6240\u6709\u6743\u5f15\u7528\uff0c\u5982\u679c\u5220\u9664 prometheus \u5bf9\u8c61\uff0c\u5b83\u5c06\u5220\u9664\u76f8\u5e94\u7684 victoria-metrics \u5bf9\u8c61\u3002\n  enable_converter_ownership: false\n  # -- Enables custom config-reloader, bundled with operator.\n  # It should reduce  vmagent and vmauth config sync-time and make it predictable.\n  useCustomConfigReloader: true\n# -- \u662f\u5426\u5f00\u542f\u8d44\u6e90\u6821\u9a8c\u7684\u51c6\u5165\u63a7\u5236\u5668(\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u5f00\u542f)\n# admissionWebhooks:\n#   # -- Enables validation webhook.\n#   enabled: false\n#   # -- What to do in case, when operator not available to validate request.\n#   policy: Fail\n#   # -- Enables custom ca bundle, if you are not using cert-manager.\n#   # -- in case of custom ca, you have to create secret - {{chart-name}}-validation\n#   # -- with keys: tls.key, tls.crt, ca.crt\n#   caBundle: \"\"\n#   certManager:\n#     # -- Enables cert creation and injection by cert-manager.\n#     enabled: false\n#     # --If needed, provide own issuer. Operator will create self-signed if empty.\n#     issuer: {}\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u4e00\u952e\u5b89\u88c5 vm-operator\uff1a</p> <pre><code>\u2638 \u279c helm upgrade --install victoria-metrics-operator vm/victoria-metrics-operator -f values.yaml -n vm-operator --create-namespace\nNAME: victoria-metrics-operator\nLAST DEPLOYED: Tue May 17 15:51:40 2022\nNAMESPACE: vm-operator\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nvictoria-metrics-operator has been installed. Check its status by running:\n  kubectl --namespace vm-operator get pods -l \"app.kubernetes.io/instance=victoria-metrics-operator\"\n\nGet more information on https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-operator.\nSee \"Getting started guide for VM Operator\" on https://docs.victoriametrics.com/guides/getting-started-w\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b vm-operator \u7684\u72b6\u6001\u6765\u9a8c\u8bc1\u662f\u5426\u5b89\u88c5\u6210\u529f\uff1a</p> <pre><code>\n\u2638 \u279c helm ls -n vm-operator\nNAME                            NAMESPACE       REVISION        UPDATED                                 STATUS       CHART                           APP VERSION\nvictoria-metrics-operator       vm-operator     1               2022-05-17 15:53:14.60667 +0800 CST     deployed     victoria-metrics-operator-0.9.0 0.24.0\n\u2638 \u279c kubectl --namespace vm-operator get pods -l \"app.kubernetes.io/instance=victoria-metrics-operator\"\nNAME                                        READY   STATUS    RESTARTS   AGE\nvictoria-metrics-operator-d467cf69c-glh6v   1/1     Running   0          2m58s\n</code></pre>"},{"location":"chap12/71vm_operator/#2-vm","title":"2 \u90e8\u7f72 VM \u96c6\u7fa4","text":"<p>Operator \u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u5305\u542b\u5982\u4e0b\u6240\u793a\u7684\u4e00\u4e9b CRD\uff1a</p> <pre><code>\u2638 \u279c kubectl get crd |grep victoriametrics\nvmagents.operator.victoriametrics.com                2022-05-17T07:51:42Z\nvmalertmanagerconfigs.operator.victoriametrics.com   2022-05-17T07:51:42Z\nvmalertmanagers.operator.victoriametrics.com         2022-05-17T07:51:42Z\nvmalerts.operator.victoriametrics.com                2022-05-17T07:51:42Z\nvmauths.operator.victoriametrics.com                 2022-05-17T07:51:42Z\nvmclusters.operator.victoriametrics.com              2022-05-17T07:51:42Z\nvmnodescrapes.operator.victoriametrics.com           2022-05-17T07:51:42Z\nvmpodscrapes.operator.victoriametrics.com            2022-05-17T07:51:42Z\nvmprobes.operator.victoriametrics.com                2022-05-17T07:51:42Z\nvmrules.operator.victoriametrics.com                 2022-05-17T07:51:42Z\nvmservicescrapes.operator.victoriametrics.com        2022-05-17T07:51:42Z\nvmsingles.operator.victoriametrics.com               2022-05-17T07:51:42Z\nvmstaticscrapes.operator.victoriametrics.com         2022-05-17T07:51:42Z\nvmusers.operator.victoriametrics.com                 2022-05-17T07:51:42Z\n</code></pre> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u8981\u6765\u90e8\u7f72 VM\uff0c\u5982\u679c\u53ea\u662f\u60f3\u8981\u5355\u8282\u70b9\u6a21\u5f0f\u5219\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 VMSingle \u5bf9\u8c61\uff0c\u5982\u679c\u8981\u90e8\u7f72\u4e00\u5957 VM \u7684\u96c6\u7fa4\u5219\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 VMCluster \u6765\u5b9a\u4e49\u4e00\u4e2a\u5bf9\u8c61\u5373\u53ef\uff0c\u5b8c\u5168\u4e0d\u9700\u8981\u6211\u4eec\u53bb\u624b\u52a8\u521b\u5efa\u5404\u4e2a\u7ec4\u4ef6\uff0cOperator \u4f1a\u6839\u636e\u6211\u4eec\u7684\u5b9a\u4e49\u53bb\u5e2e\u6211\u4eec\u62c9\u8d77\u4e00\u5957\u96c6\u7fa4\u8d77\u6765\u3002</p> <p>\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 VMCluster \u5bf9\u8c61\uff1a</p> <pre><code># vmcluster-demo.yaml\napiVersion: operator.victoriametrics.com/v1beta1\nkind: VMCluster\nmetadata:\n  name: vmcluster-demo\nspec:\n  replicationFactor: 1\n  retentionPeriod: \"1w\"\n  vmstorage:\n    replicaCount: 2\n    storage:\n      volumeClaimTemplate:\n        spec:\n          accessModes:\n            - ReadWriteOnce\n          resources:\n            requests:\n              storage: 10G\n          storageClassName: nfs-client\n    storageDataPath: /vm-data\n  vmselect:\n    replicaCount: 2\n    cacheMountPath: /cache\n    storage:\n      volumeClaimTemplate:\n        spec:\n          storageClassName: nfs-client\n          accessModes:\n            - ReadWriteOnce\n          resources:\n            requests:\n              storage: 1G\n  vminsert:\n    replicaCount: 2\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>spec.retentionPeriod</code> \u6307\u5b9a\u4e86\u6570\u636e\u4fdd\u7559\u7684\u65f6\u957f\u4e3a 1 \u5468\uff0c<code>replicaCount</code> \u7528\u6765\u6307\u5b9a\u5404\u4e2a\u7ec4\u4ef6\u7684\u526f\u672c\u6570\u4e3a 2\uff0c\u901a\u8fc7<code>storage.volumeClaimTemplate</code> \u6307\u5b9a\u4e86\u6570\u636e\u6301\u4e45\u5316\u7684 PVC \u6a21\u677f\uff0c\u6574\u4e2a\u5bf9\u8c61\u53ef\u914d\u7f6e\u7684\u5c5e\u6027\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 kubectl explain \u6765\u83b7\u53d6\uff1a</p> <pre><code>\u2638 \u279c kubectl explain VMCluster.spec\nKIND:     VMCluster\nVERSION:  operator.victoriametrics.com/v1beta1\n\nRESOURCE: spec &lt;Object&gt;\n\nDESCRIPTION:\n     VMClusterSpec defines the desired state of VMCluster\n\nFIELDS:\n   clusterVersion       &lt;string&gt;\n     ClusterVersion defines default images tag for all components. it can be\n     overwritten with component specific image.tag value.\n\n   imagePullSecrets     &lt;[]Object&gt;\n     ImagePullSecrets An optional list of references to secrets in the same\n     namespace to use for pulling images from registries see\n     http://kubernetes.io/docs/user-guide/images#specifying-imagepullsecrets-on-a-pod\n\n   podSecurityPolicyName        &lt;string&gt;\n     PodSecurityPolicyName - defines name for podSecurityPolicy in case of empty\n     value, prefixedName will be used.\n\n   replicationFactor    &lt;integer&gt;\n     ReplicationFactor defines how many copies of data make among distinct\n     storage nodes\n\n   retentionPeriod      &lt;string&gt; -required-\n     RetentionPeriod for the stored metrics Note VictoriaMetrics has data/ and\n     indexdb/ folders metrics from data/ removed eventually as soon as partition\n     leaves retention period reverse index data at indexdb rotates once at the\n     half of configured retention period\n     https://docs.victoriametrics.com/Single-server-VictoriaMetrics.html#retention\n\n   serviceAccountName   &lt;string&gt;\n     ServiceAccountName is the name of the ServiceAccount to use to run the\n     VMSelect Pods.\n\n   vminsert     &lt;Object&gt;\n\n   vmselect     &lt;Object&gt;\n\n   vmstorage    &lt;Object&gt;\n</code></pre> <p>\u540c\u6837\u8981\u60f3\u83b7\u53d6\u7ec4\u4ef6\u53ef\u4ee5\u5b9a\u4e49\u7684\u5c5e\u6027\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8be5\u65b9\u5f0f\u6765\u83b7\u53d6\uff0c\u6bd4\u5982\u67e5\u770b vmstorage \u5bf9\u8c61\u53ef\u4ee5\u914d\u7f6e\u7684\u5c5e\u6027\uff1a</p> <pre><code>\u2638 \u279c kubectl explain VMCluster.spec.vmstorage\nKIND:     VMCluster\nVERSION:  operator.victoriametrics.com/v1beta1\n\nRESOURCE: vmstorage &lt;Object&gt;\n\nDESCRIPTION:\n     &lt;empty&gt;\n\nFIELDS:\n   affinity     &lt;&gt;\n     Affinity If specified, the pod's scheduling constraints.\n\n   configMaps   &lt;[]string&gt;\n     ConfigMaps is a list of ConfigMaps in the same namespace as the VMSelect\n     object, which shall be mounted into the VMSelect Pods. The ConfigMaps are\n     mounted into /etc/vm/configs/&lt;configmap-name&gt;.\n\n   containers   &lt;[]&gt;\n     Containers property allows to inject additions sidecars or to patch\n     existing containers. It can be useful for proxies, backup, etc.\n\n   dnsConfig    &lt;Object&gt;\n     Specifies the DNS parameters of a pod. Parameters specified here will be\n     merged to the generated DNS configuration based on DNSPolicy.\n\n   dnsPolicy    &lt;string&gt;\n     DNSPolicy sets DNS policy for the pod\n\n   extraArgs    &lt;map[string]string&gt;\n\n   extraEnvs    &lt;[]&gt;\n     ExtraEnvs that will be added to VMSelect pod\n\n   hostNetwork  &lt;boolean&gt;\n     HostNetwork controls whether the pod may use the node network namespace\n\n   image        &lt;Object&gt;\n     Image - docker image settings for VMStorage\n\n   initContainers       &lt;[]&gt;\n     InitContainers allows adding initContainers to the pod definition. Those\n     can be used to e.g. fetch secrets for injection into the VMSelect\n     configuration from external sources. Any errors during the execution of an\n     initContainer will lead to a restart of the Pod. More info:\n     https://kubernetes.io/docs/concepts/workloads/pods/init-containers/ Using\n     initContainers for any use case other then secret fetching is entirely\n     outside the scope of what the maintainers will support and by doing so, you\n     accept that this behaviour may break at any time without notice.\n\n   livenessProbe        &lt;&gt;\n     LivenessProbe that will be added CRD pod\n\n   logFormat    &lt;string&gt;\n     LogFormat for VMSelect to be configured with. default or json\n\n   logLevel     &lt;string&gt;\n     LogLevel for VMSelect to be configured with.\n\n   maintenanceInsertNodeIDs     &lt;[]integer&gt;\n     MaintenanceInsertNodeIDs - excludes given node ids from insert requests\n     routing, must contain pod suffixes - for pod-0, id will be 0 and etc. lets\n     say, you have pod-0, pod-1, pod-2, pod-3. to exclude pod-0 and pod-3 from\n     insert routing, define nodeIDs: [0,3]. Useful at storage expanding, when\n     you want to rebalance some data at cluster.\n\n   maintenanceSelectNodeIDs     &lt;[]integer&gt;\n     MaintenanceInsertNodeIDs - excludes given node ids from select requests\n     routing, must contain pod suffixes - for pod-0, id will be 0 and etc.\n\n   name &lt;string&gt;\n     Name is deprecated and will be removed at 0.22.0 release\n\n   nodeSelector &lt;map[string]string&gt;\n     NodeSelector Define which Nodes the Pods are scheduled on.\n\n   podDisruptionBudget  &lt;Object&gt;\n     PodDisruptionBudget created by operator\n\n   podMetadata  &lt;Object&gt;\n     PodMetadata configures Labels and Annotations which are propagated to the\n     VMSelect pods.\n\n   port &lt;string&gt;\n     Port for health check connetions\n\n   priorityClassName    &lt;string&gt;\n     Priority class assigned to the Pods\n\n   readinessProbe       &lt;&gt;\n     ReadinessProbe that will be added CRD pod\n\n   replicaCount &lt;integer&gt; -required-\n     ReplicaCount is the expected size of the VMStorage cluster. The controller\n     will eventually make the size of the running cluster equal to the expected\n     size.\n\n   resources    &lt;Object&gt;\n     Resources container resource request and limits,\n     https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/\n\n   rollingUpdateStrategy        &lt;string&gt;\n     RollingUpdateStrategy defines strategy for application updates Default is\n     OnDelete, in this case operator handles update process Can be changed for\n     RollingUpdate\n\n   runtimeClassName     &lt;string&gt;\n     RuntimeClassName - defines runtime class for kubernetes pod.\n     https://kubernetes.io/docs/concepts/containers/runtime-class/\n\n   schedulerName        &lt;string&gt;\n     SchedulerName - defines kubernetes scheduler name\n\n   secrets      &lt;[]string&gt;\n     Secrets is a list of Secrets in the same namespace as the VMSelect object,\n     which shall be mounted into the VMSelect Pods. The Secrets are mounted into\n     /etc/vm/secrets/&lt;secret-name&gt;.\n\n   securityContext      &lt;&gt;\n     SecurityContext holds pod-level security attributes and common container\n     settings. This defaults to the default PodSecurityContext.\n\n   serviceScrapeSpec    &lt;&gt;\n     ServiceScrapeSpec that will be added to vmselect VMServiceScrape spec\n\n   serviceSpec  &lt;Object&gt;\n     ServiceSpec that will be create additional service for vmstorage\n\n   startupProbe &lt;&gt;\n     StartupProbe that will be added to CRD pod\n\n   storage      &lt;Object&gt;\n     Storage - add persistent volume for StorageDataPath its useful for\n     persistent cache\n\n   storageDataPath      &lt;string&gt;\n     StorageDataPath - path to storage data\n\n   terminationGracePeriodSeconds        &lt;integer&gt;\n     TerminationGracePeriodSeconds period for container graceful termination\n\n   tolerations  &lt;[]Object&gt;\n     Tolerations If specified, the pod's tolerations.\n\n   topologySpreadConstraints    &lt;[]&gt;\n     TopologySpreadConstraints embedded kubernetes pod configuration option,\n     controls how pods are spread across your cluster among failure-domains such\n     as regions, zones, nodes, and other user-defined topology domains\n     https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/\n\n   vmBackup     &lt;Object&gt;\n     VMBackup configuration for backup\n\n   vmInsertPort &lt;string&gt;\n     VMInsertPort for VMInsert connections\n\n   vmSelectPort &lt;string&gt;\n     VMSelectPort for VMSelect connections\n\n   volumeMounts &lt;[]Object&gt;\n     VolumeMounts allows configuration of additional VolumeMounts on the output\n     Deployment definition. VolumeMounts specified will be appended to other\n     VolumeMounts in the VMSelect container, that are generated as a result of\n     StorageSpec objects.\n\n   volumes      &lt;[]&gt;\n     Volumes allows configuration of additional volumes on the output Deployment\n     definition. Volumes specified will be appended to other volumes that are\n     generated as a result of StorageSpec objects.\n</code></pre> <p>\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u5b9a\u4e49\u7684\u5bf9\u8c61\uff1a</p> <pre><code>\u2638 \u279c kubectl apply -f vmcluster-demo.yaml\n\u2638 \u279c kubectl get vmcluster\nNAME             INSERT COUNT   STORAGE COUNT   SELECT COUNT   AGE     STATUS\nvmcluster-demo   2              2               2              7m21s   expanding\n</code></pre> <p>\u5e94\u7528\u540e <code>vm-operator</code> \u4f1a watch \u5230\u6211\u4eec\u521b\u5efa\u4e86\u8be5 CRD \u5bf9\u8c61\uff0c\u7136\u540e\u4f1a\u6839\u636e\u6211\u4eec\u7684\u5b9a\u4e49\u53bb\u81ea\u52a8\u521b\u5efa\u5bf9\u5e94\u7684 VM \u96c6\u7fa4\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u63d0\u5230\u7684\u51e0\u4e2a\u7ec4\u4ef6\u670d\u52a1\uff1a</p> <pre><code>\n\u2638 \u279c kubectl get pods\nNAME                                       READY   STATUS    RESTARTS      AGE\nvminsert-vmcluster-demo-84956d98b5-5ckft   1/1     Running   0             93s\nvminsert-vmcluster-demo-84956d98b5-kpcj6   1/1     Running   0             93s\nvmselect-vmcluster-demo-0                  1/1     Running   0             3m7s\nvmselect-vmcluster-demo-1                  1/1     Running   0             3m7s\nvmstorage-vmcluster-demo-0                 1/1     Running   0             4m54s\nvmstorage-vmcluster-demo-1                 1/1     Running   0             4m54s\n\u2638 \u279c kubectl get svc\nNAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE\nvminsert-vmcluster-demo    ClusterIP   10.102.145.24   &lt;none&gt;        8480/TCP                     4m57s\nvmselect-vmcluster-demo    ClusterIP   None            &lt;none&gt;        8481/TCP                     6m31s\nvmstorage-vmcluster-demo   ClusterIP   None            &lt;none&gt;        8482/TCP,8400/TCP,8401/TCP   8m18s\n</code></pre> <p>\u6211\u4eec\u53ea\u901a\u8fc7\u5b9a\u4e49\u7b80\u5355\u7684 VMCluster \u5bf9\u8c61\u5c31\u53ef\u4ee5\u6765\u7ba1\u7406 VM \u96c6\u7fa4\u4e86\uff0c\u662f\u4e0d\u662f\u975e\u5e38\u65b9\u4fbf\uff0c\u7279\u522b\u662f\u5f53\u4f60\u7ec4\u4ef6\u526f\u672c\u6570\u91cf\u975e\u5e38\u591a\u7684\u65f6\u5019\u4e0d\u9700\u8981\u6211\u4eec\u53bb\u624b\u52a8\u914d\u7f6e <code>-storageNode</code> \u53c2\u6570\u4e86\u3002</p> <p>\u73b0\u5728 VM \u96c6\u7fa4\u5b89\u88c5\u6210\u529f\u4e86\uff0c\u4f46\u662f\u73b0\u5728\u8fd8\u6ca1\u6709\u4efb\u4f55\u6570\u636e\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u53bb\u914d\u7f6e\u76d1\u63a7\u6307\u6807\u7684\u6293\u53d6\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u53bb\u521b\u5efa\u4e00\u4e2a VMAgent \u5bf9\u8c61\u5373\u53ef\uff0c\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u5bf9\u8c61\uff1a</p> <pre><code># vmagent-demo.yaml\napiVersion: operator.victoriametrics.com/v1beta1\nkind: VMAgent\nmetadata:\n  name: vmagent-demo\nspec:\n  serviceScrapeNamespaceSelector: {}\n  podScrapeNamespaceSelector: {}\n  podScrapeSelector: {}\n  serviceScrapeSelector: {}\n  nodeScrapeSelector: {}\n  nodeScrapeNamespaceSelector: {}\n  staticScrapeSelector: {}\n  staticScrapeNamespaceSelector: {}\n  replicaCount: 1\n  remoteWrite:\n    - url: \"http://vminsert-vmcluster-demo.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write\"\n</code></pre> <p>\u540c\u6837\u8981\u83b7\u53d6 VMAgent \u7684\u6240\u6709\u53ef\u914d\u7f6e\u7684\u5c5e\u6027\u53ef\u4ee5\u901a\u8fc7 <code>kubectl explain VMAgent.spec</code> \u6765\u83b7\u53d6\uff0c\u8fd9\u91cc\u6700\u4e3b\u8981\u7684\u914d\u7f6e\u5c31\u662f\u901a\u8fc7 <code>remoteWrite.url</code> \u6765\u6307\u5b9a\u8fdc\u7a0b\u5199\u5165\u7684 URL \u5730\u5740\uff0c\u4e5f\u5c31\u662f vminsert \u7ec4\u4ef6\u7684\u670d\u52a1\u5730\u5740\uff0c\u5176\u4ed6\u51e0\u4e2a\u5c5e\u6027\u53ef\u4ee5\u7528\u6765\u5bf9\u8981\u6293\u53d6\u7684\u6307\u6807\u8fdb\u884c\u8fc7\u6ee4\u3002</p> <p>\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684 VMAgent \u5bf9\u8c61\u5373\u53ef\u5f00\u59cb\u6293\u53d6\u76d1\u63a7\u6570\u636e\uff1a</p> <pre><code>\u2638 \u279c kubectl apply -f vmagent-demo.yaml\n\u2638 \u279c kubectl get vmagent\nNAME           AGE\nvmagent-demo   6s\n</code></pre> <p>\u521b\u5efa\u540e vm-operator \u4f1a\u6839\u636e\u5bf9\u5e94\u7684\u63cf\u8ff0\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 vmagent \u5b9e\u4f8b\uff1a</p> <pre><code>\u2638 \u279c kubectl get pods -l app.kubernetes.io/name=vmagent\nNAME                                    READY   STATUS    RESTARTS   AGE\nvmagent-vmagent-demo-6dcc7f9dfd-hxsff   2/2     Running   0          4m24s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 vmagent \u6709\u4e24\u4e2a\u5bb9\u5668\uff0c\u4e00\u4e2a\u662f vmagent \u5e94\u7528\u5bb9\u5668\uff0c\u53e6\u5916\u4e00\u4e2a\u662f\u7528\u4e8e\u6302\u8f7d Secret \u5bf9\u8c61\u7684 config-reloader \u5bb9\u5668\uff0c\u5b83\u4f1a watch \u914d\u7f6e\u7684\u53d8\u5316\uff0c\u5e76\u53d1\u9001\u4fe1\u53f7\u4e3a vmagent \u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\uff0c\u8be5 Secret \u5bf9\u8c61\u4e2d\u5c31\u662f\u5b9a\u4e49\u7684 vmagent \u6293\u53d6\u6307\u6807\u7684\u914d\u7f6e\u5185\u5bb9\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f7f vmagent \u7684\u7aef\u53e3\u53ef\u4ee5\u4ece\u672c\u5730\u673a\u5668\u4e0a\u8bbf\u95ee\u3002</p> <pre><code>\u2638 \u279c kubectl port-forward svc/vmagent-vmagent-demo 8429:8429\nForwarding from 127.0.0.1:8429 -&gt; 8429\nForwarding from [::1]:8429 -&gt; 8429\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee <code>http://127.0.0.1:8429/targets</code> \u6765\u68c0\u67e5 vmagent \u91c7\u96c6\u7684\u96c6\u7fa4\u6307\u6807\uff1a</p> <p></p> <p>vmagent \u4f1a\u901a\u8fc7 Kubernetes \u670d\u52a1\u53d1\u73b0\u53bb\u83b7\u53d6\u9700\u8981\u6293\u53d6\u7684\u76ee\u6807\uff0c\u6b64\u670d\u52a1\u53d1\u73b0\u7531 vm-operator \u63a7\u5236</p>"},{"location":"chap12/71vm_operator/#3-vm","title":"3 \u9a8c\u8bc1 VM \u96c6\u7fa4","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5b89\u88c5 Grafana \u6765\u9a8c\u8bc1 VM \u96c6\u7fa4\uff0c\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5355\u6211\u4eec\u5c31\u76f4\u63a5\u4f7f\u7528 Helm Chart \u8fdb\u884c\u5b89\u88c5\uff1a</p> <pre><code>\u2638 \u279c helm repo add grafana https://grafana.github.io/helm-charts\n\u2638 \u279c helm repo update\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5728 values \u4e2d\u63d0\u524d\u5b9a\u4e49\u6570\u636e\u6e90\u548c\u5185\u7f6e\u4e00\u4e9b dashboard\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>cat &lt;&lt;EOF | helm install grafana grafana/grafana -f -\n  datasources:\n    datasources.yaml:\n      apiVersion: 1\n      datasources:\n        - name: victoriametrics\n          type: prometheus\n          orgId: 1\n          url: http://vmselect-vmcluster-demo.default.svc.cluster.local:8481/select/0/prometheus/\n          access: proxy\n          isDefault: true\n          updateIntervalSeconds: 10\n          editable: true\n\n  dashboardProviders:\n   dashboardproviders.yaml:\n     apiVersion: 1\n     providers:\n     - name: 'default'\n       orgId: 1\n       folder: ''\n       type: file\n       disableDeletion: true\n       editable: true\n       options:\n         path: /var/lib/grafana/dashboards/default\n\n  dashboards:\n    default:\n      victoriametrics:\n        gnetId: 11176\n        revision: 18\n        datasource: victoriametrics\n      vmagent:\n        gnetId: 12683\n        revision: 7\n        datasource: victoriametrics\n      kubernetes:\n        gnetId: 14205\n        revision: 1\n        datasource: victoriametrics\nEOF\nNAME: grafana\nLAST DEPLOYED: Tue May 17 17:13:14 2022\nNAMESPACE: default\nSTATUS: deployed\nREVISION: 1\nNOTES:\n1. Get your 'admin' user password by running:\n\n   kubectl get secret --namespace default grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo\n\n2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster:\n\n   grafana.default.svc.cluster.local\n\n   Get the Grafana URL to visit by running these commands in the same shell:\n\n     export POD_NAME=$(kubectl get pods --namespace default -l \"app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana\" -o jsonpath=\"{.items[0].metadata.name}\")\n     kubectl --namespace default port-forward $POD_NAME 3000\n\n3. Login with the password from step 1 and the username: admin\n#################################################################################\n######   WARNING: Persistence is disabled!!! You will lose your data when   #####\n######            the Grafana pod is terminated.                            #####\n#################################################################################\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u63d0\u793a\u7684\u547d\u4ee4\u5728\u672c\u5730\u66b4\u9732 Grafana \u670d\u52a1\uff1a</p> <pre><code>\n\u2638 \u279c export POD_NAME=$(kubectl get pods --namespace default -l \"app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana\" -o jsonpath=\"{.items[0].metadata.name}\")\n     kubectl --namespace default port-forward $POD_NAME 3000\nForwarding from 127.0.0.1:3000 -&gt; 3000\nForwarding from [::1]:3000 -&gt; 3000\n</code></pre> <p>\u767b\u5f55\u7684\u7528\u6237\u540d\u4e3a admin\uff0c\u5bc6\u7801\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u83b7\u53d6\uff1a</p> <pre><code>\u2638 \u279c kubectl get secret --namespace default grafana -o jsonpath=\"{.data.admin-password}\" | base64 --decode ; echo\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b victoriametrics cluster \u7684 dashboard\uff1a</p> <p></p> <p>\u6b63\u5e38\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u9875\u9762\uff1a</p> <p></p> <p>\u8fd9\u662f\u56e0\u4e3a\u9ed8\u8ba4\u60c5\u51b5\u4e0b VMAgent \u4f1a\u91c7\u96c6 VM \u96c6\u7fa4\u76f8\u5173\u7ec4\u4ef6\u7684\u6307\u6807\uff0c\u5305\u62ec vmagent \u672c\u8eab\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u6b63\u5e38\u770b\u5230 VM \u96c6\u7fa4\u7684 Dashboard\uff0c\u4f46\u662f\u6ca1\u6709\u91c7\u96c6\u5176\u4ed6\u7684\u6307\u6807\uff0c\u6bd4\u5982 <code>node-exporter</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Grafana \u4e2d\u5bfc\u5165 16098 \u8fd9\u4e2a dashboard\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 VMNodeScrape \u8fd9\u4e2a CRD \u5bf9\u8c61\u6765\u8fdb\u884c\u5b9a\u4e49\uff0cVMNodeScrape \u5bf9\u8c61\u53ef\u4ee5\u7528\u6765\u81ea\u52a8\u53d1\u73b0 Kubernetes \u8282\u70b9\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u5bf9\u8c61\u6765\u91c7\u96c6 node-exporter \u6307\u6807\uff1a</p> <pre><code># vmnode-exporter-scrape.yaml\napiVersion: operator.victoriametrics.com/v1beta1\nkind: VMNodeScrape\nmetadata:\n  name: node-exporter\nspec:\n  path: /metrics\n  port: \"9111\" # \u6307\u5b9a node-exporter \u7684\u7aef\u53e3\n  scrape_interval: 15s\n#   relabelConfigs\uff1a  # relabel\u914d\u7f6e\n#   selector:  # \u8fc7\u6ee4\u8282\u70b9\n</code></pre> <p>\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>\u2638 \u279c kubectl apply -f vmnode-exporter-scrape.yaml\n\u2638 \u279c kubectl get vmnodescrape\nNAME            AGE\nnode-exporter   19s\n</code></pre> <p>\u521b\u5efa\u540e vmagent \u5c31\u4f1a\u81ea\u52a8\u53bb\u8bc6\u522b\u8be5\u5bf9\u8c61\u53bb\u5bf9 node-exporter \u8fdb\u884c\u6293\u53d6\u4e86\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u65f6\u5019\u518d\u53bb\u67e5\u770b node-exporter \u7684 dashboard \u5c31\u6b63\u5e38\u4e86\uff1a</p> <p></p> <p>\u6b64\u5916\u8fd8\u53ef\u4ee5\u901a\u8fc7 <code>VMServiceScrape</code> \u53bb\u5b9a\u4e49\u8981\u6293\u53d6\u7684 Service \u670d\u52a1\uff08Endpoints\uff09\uff0c\u5b83\u57fa\u4e8e\u9009\u62e9\u5668\u4e3a vmagent \u751f\u6210\u6293\u53d6\u914d\u7f6e\uff0c\u5982\u679c\u60f3\u8981\u6293\u53d6\u6ca1\u6709\u5b9a\u4e49 Service \u7684 Pod \u7684\u6307\u6807\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7 VMPodScrape \u6765\u8fdb\u884c\u5b9a\u4e49\uff0c\u540c\u6837\u8fd8\u6709\u62a5\u8b66\u76f8\u5173\u7684\u4e5f\u90fd\u6709\u76f8\u5e94\u7684 CRD \u6765\u8fdb\u884c\u7ba1\u7406\u3002vm-operator \u5927\u5927\u964d\u4f4e\u4e86\u6211\u4eec\u5bf9 VM \u96c6\u7fa4\u7684\u7ba1\u7406\uff0c\u975e\u5e38\u63a8\u8350\u4f7f\u7528\u3002</p>"},{"location":"chap12/72vm_vmalert/","title":"\u7b2c\u516d\u8282 \u4f7f\u7528 vmalert \u4ee3\u66ff Prometheus \u76d1\u63a7\u62a5\u8b66","text":"<p>\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4ecb\u7ecd\u4e86\u53ef\u4ee5\u4f7f\u7528 vmagent \u4ee3\u66ff prometheus \u6293\u53d6\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u8981\u60f3\u5b8c\u5168\u66ff\u6362 prometheus \u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u90e8\u5206\u5c31\u662f\u62a5\u8b66\u6a21\u5757\uff0c\u4e4b\u524d\u6211\u4eec\u90fd\u662f\u5728 prometheus \u4e2d\u5b9a\u4e49\u62a5\u8b66\u89c4\u5219\u8bc4\u4f30\u540e\u53d1\u9001\u7ed9 alertmanager \u7684\uff0c\u540c\u6837\u5bf9\u5e94\u5230 vm \u4e2d\u4e5f\u6709\u4e00\u4e2a\u4e13\u95e8\u6765\u5904\u7406\u62a5\u8b66\u7684\u6a21\u5757\uff1avmalert\u3002</p> <p>vmalert \u4f1a\u9488\u5bf9 <code>-datasource.url</code> \u5730\u5740\u6267\u884c\u914d\u7f6e\u7684\u62a5\u8b66\u6216\u8bb0\u5f55\u89c4\u5219\uff0c\u7136\u540e\u53ef\u4ee5\u5c06\u62a5\u8b66\u53d1\u9001\u7ed9 <code>-notifier.url</code> \u914d\u7f6e\u7684 Alertmanager\uff0c\u8bb0\u5f55\u89c4\u5219\u7ed3\u679c\u4f1a\u901a\u8fc7\u8fdc\u7a0b\u5199\u5165\u7684\u534f\u8bae\u8fdb\u884c\u4fdd\u5b58\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e <code>-remoteWrite.url</code>\u3002</p>"},{"location":"chap12/72vm_vmalert/#1","title":"1 \u7279\u6027","text":"<ul> <li>\u4e0e VictoriaMetrics TSDB \u96c6\u6210</li> <li>VictoriaMetrics MetricsQL \u652f\u6301\u548c\u8868\u8fbe\u5f0f\u9a8c\u8bc1</li> <li>Prometheus \u544a\u8b66\u89c4\u5219\u5b9a\u4e49\u683c\u5f0f\u652f\u6301</li> <li>\u4e0e Alertmanager \u96c6\u6210</li> <li>\u5728\u91cd\u542f\u65f6\u53ef\u4ee5\u4fdd\u6301\u62a5\u8b66\u72b6\u6001</li> <li>Graphite \u6570\u636e\u6e90\u53ef\u7528\u4e8e\u8b66\u62a5\u548c\u8bb0\u5f55\u89c4\u5219</li> <li>\u652f\u6301\u8bb0\u5f55\u548c\u62a5\u8b66\u89c4\u5219\u91cd\u653e</li> <li>\u975e\u5e38\u8f7b\u91cf\u7ea7\uff0c\u6ca1\u6709\u989d\u5916\u7684\u4f9d\u8d56</li> </ul> <p>\u8981\u5f00\u59cb\u4f7f\u7528 vmalert\uff0c\u9700\u8981\u6ee1\u8db3\u4ee5\u4e0b\u6761\u4ef6\uff1a</p> <ul> <li>\u62a5\u8b66\u89c4\u5219\u5217\u8868\uff1a\u8981\u6267\u884c\u7684 PromQL/MetricsQL \u8868\u8fbe\u5f0f</li> <li>\u6570\u636e\u6e90\u5730\u5740\uff1a\u53ef\u8bbf\u95ee\u7684 VictoriaMetrics \u5b9e\u4f8b\uff0c\u7528\u4e8e\u89c4\u5219\u6267\u884c</li> <li>\u901a\u77e5\u7a0b\u5e8f\u5730\u5740\uff1a\u53ef\u8bbf\u95ee\u7684 Alertmanager \u5b9e\u4f8b\uff0c\u7528\u4e8e\u5904\u7406\uff0c\u6c47\u603b\u8b66\u62a5\u548c\u53d1\u9001\u901a\u77e5</li> </ul>"},{"location":"chap12/72vm_vmalert/#2","title":"2 \u5b89\u88c5","text":"<p>\u9996\u5148\u9700\u8981\u5b89\u88c5\u4e00\u4e2a Alertmanager \u7528\u6765\u63a5\u6536\u62a5\u8b66\u4fe1\u606f\uff0c\u524d\u9762\u7ae0\u8282\u4e2d\u6211\u4eec\u5df2\u7ecf\u8be6\u7ec6\u8bb2\u89e3\u8fc7\u4e86\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u4e86\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># alertmanager.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: alert-config\n  namespace: kube-vm\ndata:\n  config.yml: |-\n    global:\n      resolve_timeout: 5m\n      smtp_smarthost: 'smtp.163.com:465'\n      smtp_from: 'xxx@163.com'  \n      smtp_auth_username: 'xxx@163.com'\n      smtp_auth_password: '&lt;auth code&gt;'  # \u4f7f\u7528\u7f51\u6613\u90ae\u7bb1\u7684\u6388\u6743\u7801\n      smtp_hello: '163.com'\n      smtp_require_tls: false\n    route:\n      group_by: ['severity', 'source']\n      group_wait: 30s\n      group_interval: 5m\n      repeat_interval: 24h \n      receiver: email\n    receivers:\n    - name: 'email'\n      email_configs:\n      - to: 'xxxxxx@qq.com'\n        send_resolved: true\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: alertmanager\n  namespace: kube-vm\n  labels:\n    app: alertmanager\nspec:\n  selector:\n    app: alertmanager\n  type: NodePort\n  ports:\n    - name: web\n      port: 9093\n      targetPort: http\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: alertmanager\n  namespace: kube-vm\n  labels:\n    app: alertmanager\nspec:\n  selector:\n    matchLabels:\n      app: alertmanager\n  template:\n    metadata:\n      labels:\n        app: alertmanager\n    spec:\n      volumes:\n        - name: cfg\n          configMap:\n            name: alert-config\n      containers:\n        - name: alertmanager\n          image: prom/alertmanager:v0.21.0\n          imagePullPolicy: IfNotPresent\n          args:\n            - \"--config.file=/etc/alertmanager/config.yml\"\n          ports:\n            - containerPort: 9093\n              name: http\n          volumeMounts:\n            - mountPath: \"/etc/alertmanager\"\n              name: cfg\n</code></pre> <p>Alertmanager \u8fd9\u91cc\u6211\u4eec\u53ea\u914d\u7f6e\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u7684\u8def\u7531\u89c4\u5219\uff0c\u6839\u636e severity\u3001source \u4e24\u4e2a\u6807\u7b7e\u8fdb\u884c\u5206\u7ec4\uff0c\u7136\u540e\u5c06\u89e6\u53d1\u7684\u62a5\u8b66\u53d1\u9001\u5230 email \u63a5\u6536\u5668\u4e2d\u53bb\u3002</p> <p>\u63a5\u4e0b\u6765\u9700\u8981\u6dfb\u52a0\u7528\u4e8e\u62a5\u8b66\u7684\u89c4\u5219\u914d\u7f6e\uff0c\u914d\u7f6e\u65b9\u5f0f\u548c Prometheus \u4e00\u6837\u7684\uff1a</p> <pre><code># vmalert-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: vmalert-config\n  namespace: kube-vm\ndata:\n  record.yaml: |\n    groups:\n    - name: record\n      rules:\n      - record: job:node_memory_MemFree_bytes:percent  # \u8bb0\u5f55\u89c4\u5219\u540d\u79f0\n        expr: 100 - (100 * node_memory_MemFree_bytes / node_memory_MemTotal_bytes)\n  pod.yaml: |\n    groups:\n    - name: pod\n      rules:\n      - alert: PodMemoryUsage\n        expr: sum(container_memory_working_set_bytes{pod!=\"\"}) BY (instance, pod)  / sum(container_spec_memory_limit_bytes{pod!=\"\"} &gt; 0) BY (instance, pod) * 100 &gt; 60\n        for: 2m\n        labels:\n          severity: warning\n          source: pod\n        annotations:\n          summary: \"Pod {{ $labels.pod }} High Memory usage detected\"\n          description: \"{{$labels.instance}}: Pod {{ $labels.pod }} Memory usage is above 60% (current value is: {{ $value }})\"\n  node.yaml: |\n    groups:\n    - name: node\n      rules:  # \u5177\u4f53\u7684\u62a5\u8b66\u89c4\u5219\n      - alert: NodeMemoryUsage  # \u62a5\u8b66\u89c4\u5219\u7684\u540d\u79f0\n        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 30\n        for: 1m\n        labels:\n          source: node\n          severity: critical\n        annotations:\n          summary: \"Node {{$labels.instance}} High Memory usage detected\"\n          description: \"{{$labels.instance}}: Memory usage is above 30% (current value is: {{ $value }})\"\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u6761\u8bb0\u5f55\u89c4\u5219\uff0c\u4e24\u6761\u62a5\u8b66\u89c4\u5219\uff0c\u66f4\u591a\u62a5\u8b66\u89c4\u5219\u914d\u7f6e\u53ef\u53c2\u8003 https://awesome-prometheus-alerts.grep.to/\u3002</p> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u90e8\u7f72 vmalert \u7ec4\u4ef6\u670d\u52a1\u4e86\uff1a</p> <pre><code># vmalert.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: vmalert\n  namespace: kube-vm\n  labels:\n    app: vmalert\nspec:\n  ports:\n    - name: vmalert\n      port: 8080\n      targetPort: 8080\n  type: NodePort\n  selector:\n    app: vmalert\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: vmalert\n  namespace: kube-vm\n  labels:\n    app: vmalert\nspec:\n  selector:\n    matchLabels:\n      app: vmalert\n  template:\n    metadata:\n      labels:\n        app: vmalert\n    spec:\n      containers:\n        - name: vmalert\n          image: victoriametrics/vmalert:v1.77.0\n          imagePullPolicy: IfNotPresent\n          args:\n            - -rule=/etc/ruler/*.yaml\n            - -datasource.url=http://vmselect.kube-vm.svc.cluster.local:8481/select/0/prometheus\n            - -notifier.url=http://alertmanager.kube-vm.svc.cluster.local:9093\n            - -remoteWrite.url=http://vminsert.kube-vm.svc.cluster.local:8480/insert/0/prometheus\n            - -evaluationInterval=15s\n            - -httpListenAddr=0.0.0.0:8080\n          volumeMounts:\n            - mountPath: /etc/ruler/\n              name: ruler\n              readOnly: true\n      volumes:\n        - configMap:\n            name: vmalert-config\n          name: ruler\n</code></pre> <p>\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\u5c06\u62a5\u8b66\u89c4\u5219\u4ee5 volumes \u7684\u5f62\u5f0f\u6302\u8f7d\u5230\u4e86\u5bb9\u5668\u4e2d\uff0c\u901a\u8fc7 <code>-rule</code> \u6307\u5b9a\u4e86\u89c4\u5219\u6587\u4ef6\u8def\u5f84\uff0c<code>-datasource.url</code> \u6307\u5b9a\u4e86 <code>vmselect</code> \u7684\u8def\u5f84\uff0c<code>-notifier.url</code>\u6307\u5b9a\u4e86<code>Alertmanager</code>\u7684\u5730\u5740\uff0c\u5176\u4e2d <code>-evaluationInterval</code> \u53c2\u6570\u7528\u6765\u6307\u5b9a\u8bc4\u4f30\u7684\u9891\u7387\u7684\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u6dfb\u52a0\u4e86\u8bb0\u5f55\u89c4\u5219\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u901a\u8fc7 <code>-remoteWrite.url</code> \u6307\u5b9a\u4e00\u4e2a\u8fdc\u7a0b\u5199\u5165\u7684\u5730\u5740\u3002</p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\u5b8c\u6210\u90e8\u7f72\u3002</p> <pre><code>\u2638 \u279c kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/alertmanager.yaml\n\u2638 \u279c kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vmalert-config.yaml\n\u2638 \u279c kubectl apply -f https://p8s.io/docs/victoriametrics/manifests/vmalert.yaml\n\u2638 \u279c kubectl get pods -n kube-vm -l app=alertmanager\nNAME                           READY   STATUS    RESTARTS   AGE\nalertmanager-d88d95b4f-z2j8g   1/1     Running   0          30m\n\u2638 \u279c kubectl get svc -n kube-vm -l app=alertmanager\nNAME           TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE\nalertmanager   NodePort   10.100.230.2   &lt;none&gt;        9093:31282/TCP   31m\n\u2638 \u279c kubectl get pods -n kube-vm -l app=vmalert\nNAME                       READY   STATUS    RESTARTS   AGE\nvmalert-866674b966-675nb   1/1     Running   0          7m17s\n\u2638 \u279c kubectl get svc -n kube-vm -l app=vmalert\nNAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nvmalert   NodePort   10.104.193.183   &lt;none&gt;        8080:30376/TCP   22m\n</code></pre> <p>\u90e8\u7f72\u6210\u529f\u540e\uff0c\u5982\u679c\u6709\u62a5\u8b66\u89c4\u5219\u8fbe\u5230\u4e86\u9608\u503c\u5c31\u4f1a\u89e6\u53d1\u62a5\u8b66\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Alertmanager \u9875\u9762\u67e5\u770b\u89e6\u53d1\u7684\u62a5\u8b66\u89c4\u5219\uff1a</p> <p></p> <p>\u540c\u6837 vmalert \u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u9875\u9762\uff0c\u53ef\u4ee5\u67e5\u770b\u6240\u6709\u7684 Groups\uff1a</p> <p></p> <p>\u4e5f\u53ef\u4ee5\u67e5\u770b\u5230\u62a5\u8b66\u89c4\u5219\u5217\u8868\u7684\u72b6\u6001\uff1a</p> <p></p> <p>\u8fd8\u53ef\u4ee5\u67e5\u770b\u5230\u5177\u4f53\u7684\u4e00\u6761\u62a5\u8b66\u89c4\u5219\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u62a5\u8b66\u89c4\u5219\u89e6\u53d1\u540e\u600e\u4e48\u53d1\u9001\uff0c\u53d1\u9001\u5230\u54ea\u4e2a\u63a5\u6536\u5668\u5c31\u662f Alertmanager \u51b3\u5b9a\u7684\u4e86\u3002</p> <p>\u540c\u6837\u7684\u4e0a\u9762\u6211\u4eec\u6dfb\u52a0\u7684\u8bb0\u5f55\u89c4\u5219\u4f1a\u901a\u8fc7 remote write \u4f20\u9012\u7ed9 vminsert \u4fdd\u7559\u4e0b\u6765\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 vmselect \u67e5\u8be2\u5230\u3002</p> <p></p> <p>\u5230\u8fd9\u91cc\u57fa\u672c\u4e0a\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 vm \u4ee3\u66ff prometheus \u6765\u8fdb\u884c\u76d1\u63a7\u62a5\u8b66\u4e86\uff0cvmagent \u91c7\u96c6\u76d1\u63a7\u6307\u6807\uff0cvmalert \u7528\u4e8e\u62a5\u8b66\u76d1\u63a7\uff0cvmstorage \u5b58\u50a8\u6307\u6807\u6570\u636e\uff0cvminsert \u63a5\u6536\u6307\u6807\u6570\u636e\uff0cvmselect \u67e5\u8be2\u6307\u6807\u6570\u636e\uff0c\u5df2\u7ecf\u5b8c\u5168\u53ef\u4ee5\u4e0d\u4f7f\u7528 prometheus \u4e86\uff0c\u800c\u4e14\u6027\u80fd\u975e\u5e38\u9ad8\uff0c\u6240\u9700\u8d44\u6e90\u4e5f\u6bd4 prometheus \u4f4e\u5f88\u591a\u3002</p>"},{"location":"chap12/73vm_pressure/","title":"\u7b2c\u4e03\u8282 \u5bf9Prometheus\u517c\u5bb9\u7684\u65f6\u5e8f\u6570\u636e\u5e93\u8fdb\u884c\u538b\u529b\u6d4b\u8bd5","text":"<p>\u4e3a\u4e86\u5728\u4e0d\u540c VictoriaMetrics \u7248\u672c\u4e4b\u95f4\u6216 VictoriaMetrics \u4e0e\u5176\u4ed6\u652f\u6301 Prometheus <code>remote_write</code> \u534f\u8bae\u7684\u89e3\u51b3\u65b9\u6848\u4e4b\u95f4\u8fdb\u884c\u6bd4\u8f83\uff0cVictoriaMetrics \u4e13\u95e8\u63d0\u4f9b\u4e86\u4e00\u4e2a <code>Prometheus-benchmark</code> \u7684\u9879\u76ee\u3002</p>"},{"location":"chap12/73vm_pressure/#1","title":"1 \u5b9e\u73b0\u539f\u7406","text":"<p>\u8be5\u9879\u76ee\u7684\u5b9e\u73b0\u5176\u5b9e\u975e\u5e38\u7b80\u5355\uff1a</p> <ul> <li>\u4f7f\u7528 <code>node_exporter</code> \u7528\u4f5c\u7c7b\u4f3c\u751f\u4ea7\u73af\u5883\u6307\u6807\u7684\u6765\u6e90</li> <li>\u5728 <code>node_exporter</code> \u524d\u9762\u6302\u4e86\u4e00\u4e2a nginx \u7528\u4f5c\u7f13\u5b58\u4ee3\u7406\uff0c\u5f53\u6293\u53d6\u592a\u591a\u7684\u6307\u6807\u65f6\uff0c\u8fd9\u53ef\u4ee5\u51cf\u5c11 node_exporter \u7684\u8d1f\u8f7d</li> <li>\u4f7f\u7528 vmagent \u6765\u6293\u53d6 <code>node_exporter</code> \u6307\u6807\u5e76\u901a\u8fc7 <code>Prometheus remote_write</code> \u534f\u8bae\u5c06\u5b83\u4eec\u8f6c\u53d1\u5230\u914d\u7f6e\u7684\u76ee\u6807\u3002\u5982\u679c\u8bbe\u7f6e\u4e86\u591a\u4e2a\u76ee\u6807\uff0c\u5219\u591a\u4e2a vmagent \u5b9e\u4f8b\u72ec\u7acb\u5730\u5c06\u6293\u53d6\u7684\u6570\u636e\u63a8\u9001\u5230\u8fd9\u4e9b\u76ee\u6807\u53bb</li> </ul> <p></p> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\uff0c\u8be5\u6d4b\u8bd5\u5e76\u4e0d\u4f1a\u4ece\u914d\u7f6e\u7684 <code>remote_write</code> \u76ee\u6807\u6536\u96c6\u6307\u6807 \uff0c\u5b83\u53ea\u4f1a\u91c7\u96c6\u5185\u90e8\u7ec4\u4ef6 vmagent \u548c vmalert \u7684\u6307\u6807\uff0c\u4ed6\u4f1a\u5047\u8bbe\u5bf9\u6d4b\u8bd5\u7684 Prometheus \u5b58\u50a8\u7cfb\u7edf\u7684\u76d1\u63a7\u662f\u5355\u72ec\u8fdb\u884c\u7684\uff0c\u6bd4\u5982\u4e0b\u9762\u6211\u4eec\u4ee5\u5355\u8282\u70b9\u7684 VictoriaMetrics \u6765\u4f5c\u4e3a <code>remote_write</code> \u7684\u76ee\u6807\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u81ea\u884c\u5bf9\u5176\u8fdb\u884c\u76d1\u63a7\u3002</p> <p>\u8be5\u9879\u76ee\u7684\u6838\u5fc3\u5b9e\u73b0\u5c31\u662f\u6839\u636e\u4f20\u5165\u7684\u4e00\u7cfb\u5217\u53c2\u6570\u4e0d\u65ad\u53bb\u66f4\u65b0\u6293\u53d6\u6307\u6807\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u540e vmagent \u6839\u636e\u8be5\u9879\u76ee\u66b4\u9732\u7684\u63a5\u53e3\u83b7\u53d6\u5176\u914d\u7f6e <code>-promscrape.config</code> \u53bb\u6293\u53d6\u6307\u6807\uff0c\u6838\u5fc3\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>package main\n\nimport (\n \"flag\"\n \"fmt\"\n \"log\"\n \"math/rand\"\n \"net/http\"\n \"sync\"\n \"time\"\n\n \"gopkg.in/yaml.v2\"\n)\n\nvar (\n listenAddr                 = flag.String(\"httpListenAddr\", \":8436\", \"TCP address for incoming HTTP requests\")\n targetsCount               = flag.Int(\"targetsCount\", 100, \"The number of scrape targets to return from -httpListenAddr. Each target has the same address defined by -targetAddr\")\n targetAddr                 = flag.String(\"targetAddr\", \"demo.robustperception.io:9090\", \"Address with port to use as target address the scrape config returned from -httpListenAddr\")\n scrapeInterval             = flag.Duration(\"scrapeInterval\", time.Second*5, \"The scrape_interval to set at the scrape config returned from -httpListenAddr\")\n scrapeConfigUpdateInterval = flag.Duration(\"scrapeConfigUpdateInterval\", time.Minute*10, \"The -scrapeConfigUpdatePercent scrape targets are updated in the scrape config returned from -httpListenAddr every -scrapeConfigUpdateInterval\")\n scrapeConfigUpdatePercent  = flag.Float64(\"scrapeConfigUpdatePercent\", 1, \"The -scrapeConfigUpdatePercent scrape targets are updated in the scrape config returned from -httpListenAddr ever -scrapeConfigUpdateInterval\")\n)\n\nfunc main() {\n flag.Parse()\n flag.VisitAll(func(f *flag.Flag) {\n  log.Printf(\"-%s=%s\", f.Name, f.Value)\n })\n c := newConfig(*targetsCount, *scrapeInterval, *targetAddr)\n var cLock sync.Mutex\n p := *scrapeConfigUpdatePercent / 100\n r := rand.New(rand.NewSource(time.Now().UnixNano()))\n go func() {\n  rev := 0\n  for range time.Tick(*scrapeConfigUpdateInterval) {\n   rev++\n   revStr := fmt.Sprintf(\"r%d\", rev)\n   cLock.Lock()\n   for _, sc := range c.ScrapeConfigs {\n    for _, stc := range sc.StaticConfigs {\n     if r.Float64() &gt;= p {\n      continue\n     }\n     stc.Labels[\"revision\"] = revStr\n    }\n   }\n   cLock.Unlock()\n  }\n }()\n rh := func(w http.ResponseWriter, r *http.Request) {\n  cLock.Lock()\n  data := c.marshalYAML()\n  cLock.Unlock()\n  w.Header().Set(\"Content-Type\", \"text/yaml\")\n  w.Write(data)\n }\n hf := http.HandlerFunc(rh)\n log.Printf(\"starting scrape config updater at http://%s/\", *listenAddr)\n if err := http.ListenAndServe(*listenAddr, hf); err != nil {\n  log.Fatalf(\"unexpected error when running the http server: %s\", err)\n }\n}\n\nfunc (c *config) marshalYAML() []byte {\n data, err := yaml.Marshal(c)\n if err != nil {\n  log.Fatalf(\"BUG: unexpected error when marshaling config: %s\", err)\n }\n return data\n}\n\nfunc newConfig(targetsCount int, scrapeInterval time.Duration, targetAddr string) *config {\n scs := make([]*staticConfig, 0, targetsCount)\n for i := 0; i &lt; targetsCount; i++ {\n  scs = append(scs, &amp;staticConfig{\n   Targets: []string{targetAddr},\n   Labels: map[string]string{\n    \"instance\": fmt.Sprintf(\"host-%d\", i),\n    \"revision\": \"r0\",\n   },\n  })\n }\n return &amp;config{\n  Global: globalConfig{\n   ScrapeInterval: scrapeInterval,\n  },\n  ScrapeConfigs: []*scrapeConfig{\n   {\n    JobName:       \"node_exporter\",\n    StaticConfigs: scs,\n   },\n  },\n }\n}\n\n// config represents essential parts from Prometheus config defined at https://prometheus.io/docs/prometheus/latest/configuration/configuration/\ntype config struct {\n Global        globalConfig    `yaml:\"global\"`\n ScrapeConfigs []*scrapeConfig `yaml:\"scrape_configs\"`\n}\n\n// globalConfig represents essential parts for `global` section of Prometheus config.\n//\n// See https://prometheus.io/docs/prometheus/latest/configuration/configuration/\ntype globalConfig struct {\n ScrapeInterval time.Duration `yaml:\"scrape_interval\"`\n}\n\n// rapeConfig represents essential parts for `scrape_config` section of Prometheus config.\n//\n// See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config\ntype scrapeConfig struct {\n JobName       string          `yaml:\"job_name\"`\n StaticConfigs []*staticConfig `yaml:\"static_configs\"`\n}\n\n// staticConfig represents essential parts for `static_config` section of Prometheus config.\n//\n// See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#static_config\ntype staticConfig struct {\n Targets []string          `yaml:\"targets\"`\n Labels  map[string]string `yaml:\"labels\"`\n}\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u4e0b\u9762\u7684\u4e00\u4e9b\u53c2\u6570\u6765\u63a7\u5236\u538b\u529b\u6d4b\u8bd5\uff1a</p> <p>targetsCount</p> <p>targetsCount \u5b9a\u4e49\u6709\u591a\u5c11 <code>node_exporter</code> \u6293\u53d6\u76ee\u6807\u88ab\u6dfb\u52a0\u5230 vmagent \u7684\u6293\u53d6\u914d\u7f6e\u4e2d\uff0c\u6bcf\u4e2a\u90fd\u5305\u542b\u4e00\u4e2a\u552f\u4e00\u7684 instance \u6807\u7b7e\uff0c\u8be5\u53c2\u6570\u4f1a\u5f71\u54cd\u6293\u53d6\u6307\u6807\u7684\u6570\u91cf\u548c\u57fa\u6570\u3002\u901a\u5e38\uff0c\u4e00\u4e2a <code>node_exporter</code> \u4f1a\u4ea7\u751f\u5927\u7ea6 815 \u4e2a\u552f\u4e00\u6307\u6807\uff0c\u56e0\u6b64\u5f53 targetsCount \u8bbe\u7f6e\u4e3a1000\u65f6\uff0c\u6d4b\u8bd5\u4f1a\u751f\u6210\u5927\u7ea6 <code>815*100=815K</code> \u7684\u6d3b\u8dc3\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>scrapeInterval</p> <p>scrapeInterval \u5b9a\u4e49\u4e86\u6293\u53d6\u6bcf\u4e2a\u76ee\u6807\u7684\u9891\u7387\uff0c\u6b64\u53c2\u6570\u4f1a\u5f71\u54cd\u6570\u636e\u6444\u53d6\u7387\uff0c\u95f4\u9694\u8d8a\u5c0f\uff0c\u6570\u636e\u6444\u53d6\u7387\u8d8a\u9ad8\u3002</p> <p>\u8fdc\u7a0b\u5b58\u50a8</p> <p><code>remoteStorages</code> \u5305\u542b\u4e00\u4e2a\u6d4b\u8bd5\u7684\u7cfb\u7edf\u5217\u8868\uff0c\u5c06\u6293\u53d6\u7684\u6307\u6807\u63a8\u9001\u8fc7\u53bb\uff0c\u5982\u679c\u8bbe\u7f6e\u4e86\u591a\u4e2a\u76ee\u6807\uff0c\u5219\u591a\u4e2a vmagent \u5b9e\u4f8b\u4f1a\u5206\u522b\u5c06\u76f8\u540c\u7684\u6570\u636e\u63a8\u9001\u5230\u591a\u4e2a\u76ee\u6807\u3002</p> <p>Churn rate</p> <p>scrapeConfigUpdatePercent \u548c scrapeConfigUpdateInterval \u53ef\u7528\u4e8e\u751f\u6210\u975e\u96f6\u7684\u65f6\u95f4\u5e8f\u5217\u6d41\u5931\u7387\uff0c\u8fd9\u5728 Kubernetes \u76d1\u63a7\u4e2d\u662f\u975e\u5e38\u5178\u578b\u7684\u573a\u666f\u3002</p>"},{"location":"chap12/73vm_pressure/#2","title":"2 \u5982\u4f55\u4f7f\u7528","text":"<p>\u4e00\u4e2a\u5178\u578b\u7684\u573a\u666f\u662f\u53ef\u4ee5\u8fd0\u884c\u591a\u4e2a VictoriaMetrics\uff0c\u7136\u540e\u5728 remoteStorages \u90e8\u5206\u5217\u51fa\u5b83\u4eec\u7684\u5730\u5740\uff0c\u8be5\u6d4b\u8bd5\u7684\u9ed8\u8ba4\u914d\u7f6e\u662f targetsCount=1000 \u548c scrapeInterval=10s \u5bfc\u81f4\u5927\u7ea6 80k \u6837\u672c/\u79d2\uff1a</p> <pre><code>800 metrics-per-target * 1k targets / 10s = 80k samples/s\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 VictoriaMetrics \u5b98\u65b9\u7684 Grafana dasbhoards \u6bd4\u8f83\u8d44\u6e90\u4f7f\u7528\u3001\u6570\u636e\u538b\u7f29\u548c\u6574\u4f53\u6027\u80fd\u3002</p> <p>\u8be5\u9879\u76ee\u9ed8\u8ba4\u901a\u8fc7 Helm Chart \u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u9ed8\u8ba4\u4f1a\u5b89\u88c5\u4e00\u4e2a single \u6a21\u5f0f\u7684 VictoriaMetrics \u5b9e\u4f8b\uff0c\u76f4\u63a5 Clone \u9879\u76ee\uff1a</p> <pre><code>$ git clone https://github.com/VictoriaMetrics/prometheus-benchmark\n$ cd prometheus-benchmark\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u4fee\u6539 <code>chart/values.yaml</code> \u914d\u7f6e\u53c2\u6570\uff0c\u6211\u8fd9\u91cc\u7684\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>vmtag: \"v1.77.1\"\n\n# targetsCount defines the number of nodeexporter instances to scrape.\n# This option allows to configure the number of active time series to push\n# to remoteStorages.\n# Every nodeexporter exposes around 815 unique metrics, so when targetsCount\n# is set to 1000, then the benchmark generates around 815*100=815K active time series.\ntargetsCount: 2000\n\n# scrapeInterval defines how frequently to scrape nodeexporter targets.\n# This option allows to configure data ingestion rate per every remoteStorages.\n# For example, if the benchmark generates 815K active time series and scrapeInterval\n# is set to 10s, then the data ingestion rate equals to 815K/10s = 81.5K samples/sec.\nscrapeInterval: 10s\n\n# queryInterval is how often to send queries from files/alerts.yaml to remoteStorages.readURL\n# This option can be used for tuning read load at remoteStorages.\n# It is a good rule of thumb to keep it in sync with scrapeInterval.\nqueryInterval: 10s\n\n# scrapeConfigUpdatePercent is the percent of nodeexporter targets\n# which are updated with unique label on every scrape config update\n# (see scrapeConfigUpdateInterval).\n# This option allows tuning time series churn rate.\n# For example, if scrapeConfigUpdatePercent is set to 1 for targetsCount=1000,\n# then around 10 targets gets updated labels on every scrape config update.\n# This generates around 815*10=8150 new time series every scrapeConfigUpdateInterval.\nscrapeConfigUpdatePercent: 1\n\n# scrapeConfigUpdateInterval specifies how frequently to update labels\n# across scrapeConfigUpdatePercent nodeexporter targets.\n# This option allows tuning time series churn rate.\n# For example, if scrapeConfigUpdateInterval is set to 10m for targetsCount=1000\n# and scrapeConfigUpdatePercent=1, then around 10 targets gets updated labels every 10 minutes.\n# This generates around 815*10=8150 new time series every 10 minutes.\nscrapeConfigUpdateInterval: 10m\n\n# writeConcurrenty is the number of concurrent tcp connections to use\n# for sending the data to the tested remoteStorages.\n# Increase this value if there is a high network latency between prometheus-benchmark\n# components and the tested remoteStorages.\nwriteConcurrency: 16\n\n# remoteStorages contains a named list of Prometheus-compatible systems to test.\n# These systems must support data ingestion via Prometheus remote_write protocol.\n# These systems must also support Prometheus querying API if query performance\n# needs to be measured additionally to data ingestion performance.\nremoteStorages:\n  vm-0:\n    # writeURL \u8868\u793a\u7528\u6765\u63a5\u6536 Prometheus remote_write \u534f\u8bae\u7684\u8fdc\u7a0b\u5b58\u50a8\n    # \u4f8b\u5982\uff1a\n    # - \u5355\u8282\u70b9VictoriaMetrics\u6a21\u5f0f\uff1ahttp://&lt;victoriametrics-addr&gt;:8428/api/v1/write for single-node \n    # - \u96c6\u7fa4VictoriaMetrics\u6a21\u5f0f\uff1ahttp://&lt;vminsert-addr&gt;:8480/insert/0/prometheus/api/v1/write\n    writeURL: \"http://my-bench-prometheus-benchmark-vmsingle.default.svc.cluster.local:8428/api/v1/write\"\n\n    # readURL \u662f\u53ef\u9009\u7684\uff0c\u5982\u679c\u9700\u8981\u6d4b\u8bd5\u6d4b\u8bd5\u7684\u6027\u80fd\u5219\u9700\u8981\u914d\u7f6e\uff0c\u901a\u8fc7\u53d1\u9001\u62a5\u8b66\u89c4\u5219\uff08files/alerts.yaml\uff09\u7ed9 readURL \u8fdb\u884c\u6d4b\u8bd5\n    # \u4f8b\u5982\uff1a\n    # - \u5355\u8282\u70b9VictoriaMetrics\u6a21\u5f0f\uff1ahttp://&lt;victoriametrics-addr&gt;:8428/\n    # - \u96c6\u7fa4VictoriaMetrics\u6a21\u5f0f\uff1ahttp://&lt;vmselect-addr&gt;:8481/select/0/prometheus/\n    readURL: \"http://my-bench-prometheus-benchmark-vmsingle.default.svc.cluster.local:8428/\"\n    writeBearerToken: \"\"\n    readBearerToken: \"\"\n  # vm-1:  # \u5982\u679c\u6709\u591a\u4e2a\u8fdc\u7a0b\u5b58\u50a8\u7cfb\u7edf\u53ef\u4ee5\u7ee7\u7eed\u914d\u7f6e\u5373\u53ef\n  #   writeURL: \"http://victoria-metrics-victoria-metrics-cluster-vminsert.default.svc.cluster.local:8480/insert/1/prometheus/api/v1/write\"\n  #   readURL: \"http://victoria-metrics-victoria-metrics-cluster-vmselect.default.svc.cluster.local:8481/select/1/prometheus/\"\n</code></pre> <p>\u73b0\u5728\u9879\u76ee\u4ee3\u7801\u4e2d\u9ed8\u8ba4\u5e26\u4e00\u4e2a\u5355\u8282\u70b9\u7684 VictoriaMetrics\uff0c\u4f46\u662f Charts \u6a21\u677f\u4e2d\u6ca1\u6709\u6dfb\u52a0 Service \u5bf9\u8c61\uff0c\u64cd\u4f5c\u4e0d\u662f\u5f88\u65b9\u4fbf\uff0c\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a <code>chart/templates/vmsingle/service.yaml</code> \u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: {{ include \"prometheus-benchmark.fullname\" . }}-vmsingle\n  namespace: {{ .Release.Namespace }}\n  labels:\n    {{- include \"prometheus-benchmark.labels\" . | nindent 4 }}\nspec:\n  type: ClusterIP\n  selector:\n    job: vmsingle\n    {{- include \"prometheus-benchmark.selectorLabels\" . | nindent 4 }}\n  ports:\n  - port: 8428\n    targetPort: 8428\n</code></pre> <p>\u914d\u7f6e\u5b8c\u8fc7\u540e\u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u9762\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u5f00\u59cb\u6d4b\u8bd5\uff1a</p> <pre><code>$ make install\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528 Helm \u8fdb\u884c\u5b89\u88c5\uff1a</p> <pre><code>\n$ kubectl get pods         \nNAME                                                          READY   STATUS    RESTARTS   AGE\ngrafana-db468ccf9-mtn87                                       1/1     Running   0          90m\nmy-bench-prometheus-benchmark-nodeexporter-76c497cf59-m5k66   2/2     Running   0          49m\nmy-bench-prometheus-benchmark-vmagent-vm-0-6bcbbb5fd8-8rhcx   2/2     Running   0          49m\nmy-bench-prometheus-benchmark-vmalert-vm-0-6f6b565ccc-snsk5   2/2     Running   0          49m\nmy-bench-prometheus-benchmark-vmsingle-585579fbf5-cpzhg       1/1     Running   0          49m\n\n$ kubectl get svc \nNAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nmy-bench-prometheus-benchmark-nodeexporter   ClusterIP   10.96.156.144   &lt;none&gt;        9102/TCP   50m\nmy-bench-prometheus-benchmark-vmsingle       ClusterIP   10.96.75.242    &lt;none&gt;        8428/TCP   50m\n</code></pre> <p>\u5176\u4e2d\u7684 node-exporter \u5e94\u7528\u5305\u542b\u4e24\u4e2a\u5bb9\u5668\uff0c\u4e00\u4e2a\u662f\u5e94\u7528\u672c\u8eab\uff0c\u53e6\u5916\u4e00\u4e2a\u662f nginx \u5305\u88c5\u4e86\u4e00\u5c42\u7528\u4e8e\u7f13\u89e3 node-exporter \u7684\u538b\u529b\u3002\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u7ed9 Grafana \u914d\u7f6e\u76d1\u63a7\u6570\u636e\u6e90 <code>http://my-bench-prometheus-benchmark-vmsingle:8428</code>\uff0c\u5bfc\u5165\u51e0\u4e2a VictorialMetrics \u5b98\u65b9\u63d0\u4f9b\u7684 Grafana Dashboard\uff1ahttps://grafana.com/orgs/victoriametrics\u3002</p> <p>\u4e0b\u56fe\u4e3a vmagent \u7684\u76d1\u63a7\u56fe\u8868\uff0c\u4ece\u56fe\u8868\u4e0a\u53ef\u4ee5\u770b\u51fa\u73b0\u5728\u6293\u53d6\u7684\u6307\u6807\u76ee\u6807\u4e3a2000\uff0c\u548c\u4e0a\u9762\u914d\u7f6e\u4e00\u81f4\uff0c\u800c\u4e14\u6ca1\u4eba\u51fa\u73b0\u4efb\u4f55\u9519\u8bef\uff0c\u8bc1\u660e\u73b0\u5728 vmagent \u8fd8\u5728\u538b\u529b\u8303\u56f4\u5185\u3002</p> <p></p> <p>\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u67e5\u770b\u4e0b VictoriaMetrics \u8fd9\u4e2a\u5355\u8282\u70b9\u7684\u8fdc\u7a0b\u5b58\u50a8\u7684\u76d1\u63a7\u56fe\u8868\uff0c\u53ef\u4ee5\u770b\u5230\u76ee\u524d\u4e5f\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff0c\u6d3b\u8dc3\u7684\u65f6\u95f4\u5e8f\u5217\u4e5f\u8fbe\u5230\u4e86\u4e00\u767e\u591a\u4e07\u3002</p> <p></p> <p>\u9664\u4e86\u53ef\u4ee5\u4ece\u4e0a\u9762\u7684\u76d1\u63a7\u56fe\u8868\u6765\u67e5\u770b\u538b\u529b\u6d4b\u8bd5\u7684\u7ed3\u679c\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u53bb\u901a\u8fc7\u4e0b\u9762\u7684\u4e00\u4e9b\u6307\u6807\u6765\u9a8c\u8bc1\u662f\u5426\u8fbe\u5230\u4e86\u538b\u529b\u4f4d\u4e86\uff1a</p> <ul> <li>\u6570\u636e\u6444\u53d6\u7387:</li> </ul> <pre><code>sum(rate(vm_promscrape_scraped_samples_sum{job=\"vmagent\"})) by (remote_storage_name)\n</code></pre> <ul> <li>\u5c06\u6570\u636e\u5305\u53d1\u9001\u5230\u914d\u7f6e\u7684\u8fdc\u7a0b\u5b58\u50a8\u65f6\u4e22\u5f03\u7684\u6570\u636e\u5305\u6570\u3002\u5982\u679c\u8be5\u503c\u5927\u4e8e\u96f6\uff0c\u5219\u8fdc\u7a0b\u5b58\u50a8\u62d2\u7edd\u63a5\u53d7\u4f20\u5165\u7684\u6570\u636e\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5efa\u8bae\u68c0\u67e5\u8fdc\u7a0b\u5b58\u50a8\u65e5\u5fd7\u548c vmagent \u65e5\u5fd7\u3002</li> </ul> <pre><code>sum(rate(vmagent_remotewrite_packets_dropped_total{job=\"vmagent\"})) by (remote_storage_name)\n</code></pre> <ul> <li>\u5c06\u6570\u636e\u53d1\u9001\u5230\u8fdc\u7a0b\u5b58\u50a8\u65f6\u7684\u91cd\u8bd5\u6b21\u6570\u3002\u5982\u679c\u8be5\u503c\u5927\u4e8e\u96f6\uff0c\u90a3\u4e48\u8fd9\u8868\u660e\u8fdc\u7a0b\u5b58\u50a8\u65e0\u6cd5\u5904\u7406\u5de5\u4f5c\u8d1f\u8f7d\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5efa\u8bae\u68c0\u67e5\u8fdc\u7a0b\u5b58\u50a8\u65e5\u5fd7\u548c vmagent \u65e5\u5fd7\u3002</li> </ul> <pre><code>sum(rate(vmagent_remotewrite_retries_count_total{job=\"vmagent\"})) by (remote_storage_name)\n</code></pre> <ul> <li>vmagent \u7aef\u5c1a\u672a\u53d1\u9001\u5230\u8fdc\u7a0b\u5b58\u50a8\u7684\u6302\u8d77\u6570\u636e\u91cf\u3002\u5982\u679c\u56fe\u5f62\u589e\u957f\uff0c\u5219\u8fdc\u7a0b\u5b58\u50a8\u65e0\u6cd5\u8ddf\u4e0a\u7ed9\u5b9a\u7684\u6570\u636e\u6444\u53d6\u7387\u3002\u53ef\u4ee5\u5c1d\u8bd5\u5728 <code>chart/values.yaml</code> \u4e2d\u589e\u52a0 <code>writeConcurrency</code>\uff0c\u5982\u679c prometheus benchmark \u7684 vmagent \u4e4b\u95f4\u5b58\u5728\u8f83\u9ad8\u7684\u7f51\u7edc\u5ef6\u8fdf\uff0c\u5219\u53ef\u80fd\u4f1a\u6709\u6240\u5e2e\u52a9\u3002</li> </ul> <pre><code>sum(vm_persistentqueue_bytes_pending{job=\"vmagent\"}) by (remote_storage_name)\n</code></pre> <ul> <li>\u4ece <code>chart/files/alerts.yaml</code> \u6267\u884c\u67e5\u8be2\u65f6\u7684\u9519\u8bef\u6570\u3002\u5982\u679c\u8be5\u503c\u5927\u4e8e\u96f6\uff0c\u5219\u8fdc\u7a0b\u5b58\u50a8\u65e0\u6cd5\u5904\u7406\u67e5\u8be2\u5de5\u4f5c\u8d1f\u8f7d\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5efa\u8bae\u68c0\u67e5\u8fdc\u7a0b\u5b58\u50a8\u65e5\u5fd7\u548c vmalert \u65e5\u5fd7\u3002</li> </ul> <pre><code>sum(rate(vmalert_execution_errors_total{job=\"vmalert\"})) by (remote_storage_name)\n</code></pre> <p>\u8fd9\u4e9b\u6307\u6807\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6267\u884c <code>make monitor</code> \u547d\u4ee4\u6765\u8fdb\u884c\u67e5\u8be2\uff1a</p> <pre><code>$ make monitor\nkubectl port-forward `kubectl -n default get pods -n default -l 'job=vmsingle,chart-name=my-bench-prometheus-benchmark' -o name` 8428\nForwarding from 127.0.0.1:8428 -&gt; 8428\nForwarding from [::1]:8428 -&gt; 8428\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee http://127.0.0.1:8428/vmui \u6765\u9a8c\u8bc1\u4e0a\u9762\u7684\u6307\u6807\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u4ece\u6211\u4eec\u8fd9\u91cc\u7684\u6d4b\u8bd5\u6765\u770b 2000 \u4e2a\u6293\u53d6\u76ee\u6807\u5e76\u6ca1\u6709\u8fbe\u5230\u4e0a\u9650\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u589e\u52a0\u8be5\u503c\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6bd4\u5982\u589e\u52a0\u5230 2500\uff0c\u5982\u679c\u5404\u4e2a\u7ec4\u4ef6\u90fd\u8fd8\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff0c\u90a3\u4e48\u518d\u589e\u52a0\u5230 3000 \u7ee7\u7eed\u6d4b\u8bd5\uff1a</p> <pre><code>$ make install\n</code></pre> <p>\u6bd4\u5982\u6211\u8fd9\u91cc\u6d4b\u8bd5 4000 \u4e2a\u6293\u53d6\u76ee\u5f55\uff0c\u4e5f\u5c31\u662f <code>800 metrics-per-target * 4k targets / 10s = 320k samples/s</code> \u4ecd\u7136\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff0c\u770b\u6765 VictoriaMetrics \u5b98\u65b9\u8bf4\u7684\u5355\u8282\u70b9\u6a21\u5f0f\u53ef\u4ee5\u652f\u6301\u6bcf\u79d2\u4e00\u767e\u4e07\u6837\u672c\u7684\u6570\u636e\u5e94\u8be5\u8fd8\u662f\u76f8\u5bf9\u9760\u8c31\u7684\u3002</p> <p></p> <p>\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\u7ed3\u675f\u6d4b\u8bd5\uff1a</p> <pre><code>make delete\n</code></pre>"},{"location":"chap12/73vm_pressure/#2_1","title":"2 \u603b\u7ed3","text":"<p>\u5728\u901a\u8fc7\u5bf9 Prometheus <code>remote_write</code> \u534f\u8bae\u63a5\u53d7\u6570\u636e\u7684\u4e0d\u540c\u89e3\u51b3\u65b9\u6848\u6216\u540c\u4e00\u89e3\u51b3\u65b9\u6848\u7684\u4e0d\u540c\u7248\u672c\u8fdb\u884c\u538b\u529b\u6d4b\u8bd5\u6bd4\u8f83\u65f6\uff0c\u6211\u4eec\u5e94\u8be5\u4f1a\u5f97\u51fa\u4e00\u4e2a\u5927\u81f4\u7684\u7ed3\u8bba\u4e86\u3002\u4f8b\u5982\uff0cPrometheus \u672c\u8eab\u3001Cortex\u3001Thanos\u3001M3DB \u548c TimescaleDB \u7b49\u65b9\u6848\u7684\u6027\u80fd\u8868\u73b0\u5982\u4f55\uff0c\u4f46\u662f\uff0c\u6211\u4eec\u59cb\u7ec8\u5efa\u8bae\u4e0d\u8981\u7b80\u5355\u5730\u76f8\u4fe1\u8fd9\u4e9b\u57fa\u51c6\u6d4b\u8bd5\uff0c\u800c\u662f\u8981\u9a8c\u8bc1\u751f\u4ea7\u6570\u636e\u7684\u6570\u91cf\u548c\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\u3002</p>"},{"location":"chap13/1deepflow/","title":"1 DeepFlow AutoTagging \u4e4b Prometheus \u6807\u7b7e\u6807\u51c6\u5316","text":"<p>DeepFlow \u662f\u4e00\u4e2a\u9ad8\u5ea6\u81ea\u52a8\u5316\u7684\u53ef\u89c2\u6d4b\u6027\u534f\u4f5c\u5e73\u53f0\uff0c\u5176\u4e2d\u7684\u534f\u4f5c\u4f53\u73b0\u5728\u5bf9\u5404\u7c7b\u6570\u636e\u7684\u6807\u51c6\u5316\u4e0a\u3002</p> <p>\u5bf9\u4e8e\u53ef\u89c2\u6d4b\u6027\u4e09\u5927\u652f\u67f1\u4e4b\u4e00\u7684 Metrics\uff0cDeepFlow \u4e0d\u4ec5\u53ef\u5229\u7528 eBPF \u81ea\u52a8\u91c7\u96c6\u5e94\u7528\u7a0b\u5e8f\u7684\u7cfb\u7edf\u3001\u7f51\u7edc\u3001\u5e94\u7528\u5168\u6808\u9ec4\u91d1\u6307\u6807\uff08AutoMetrics\uff09\uff0c</p> <p>\u4e5f\u53ef\u96c6\u6210\u76ee\u524d\u4e3b\u6d41\u7684\u6307\u6807\u6570\u636e\u6e90\uff0c\u4f8b\u5982\u4e91\u539f\u751f\u73af\u5883\u4e0b\u7684 Prometheus\uff0c\u4f20\u7edf\u73af\u5883\u4e2d\u7684 Telegraf \u7b49\u3002</p> <p>DeepFlow \u7684 AutoTagging \u548c SmartEncoding \u673a\u5236\u4e3a\u6240\u6709\u6570\u636e\u6e90\u81ea\u52a8\u6ce8\u5165\u4e30\u5bcc\u7684\u6807\u51c6\u5316\u6807\u7b7e\uff0c\u964d\u4f4e\u4e86\u5f00\u53d1\u8fd0\u7ef4\u4eba\u5458\u6784\u9020\u6570\u636e\u6807\u7b7e\u7684\u5de5\u4f5c\u8d1f\u62c5\uff0c\u4e5f\u4f7f\u5f97\u53ef\u89c2\u6d4b\u6027\u4ece\u6b64\u544a\u522b\u4e86\u6570\u636e\u5b64\u5c9b\u3002</p> <p>\u6211\u4eec\u7684\u7cfb\u5217\u6587\u7ae0\u5c06\u4f1a\u9010\u4e00\u5256\u6790 DeepFlow AutoTagging \u7684\u80fd\u529b\uff0c\u4f5c\u4e3a\u5f00\u59cb\uff0c\u672c\u6587\u4e3b\u8981\u4ecb\u7ecd\u4ee5\u4e0b\u56db\u65b9\u9762\u7684\u5185\u5bb9\uff1a</p> <ul> <li>DeepFlow \u5982\u4f55\u96c6\u6210 Prometheus/Telegraf \u7684\u6307\u6807\u6570\u636e</li> <li>DeepFlow \u5982\u4f55\u6807\u51c6\u5316\u6ce8\u5165 \u4e30\u5bcc\u7684\u6807\u7b7e\uff0c\u544a\u522b\u6570\u636e\u5b64\u5c9b</li> <li>DeepFlow \u5982\u4f55\u81ea\u52a8\u5316\u6ce8\u5165\u7684\u6807\u7b7e\uff0c\u964d\u4f4e\u6807\u7b7e\u6ce8\u5165\u8d1f\u62c5</li> <li>DeepFlow \u5982\u4f55\u63d0\u5347\u6027\u80fd\uff0c\u4e30\u5bcc\u5316\u6807\u51c6\u5316\u4e0e\u8282\u80fd\u51cf\u6392\u4e24\u4e0d\u8bef</li> </ul>"},{"location":"chap13/1deepflow/#prometheustelegraf","title":"\u96c6\u6210 Prometheus/Telegraf","text":"<p>DeepFlow \u76ee\u524d\u652f\u6301\u96c6\u6210 Prometheus \u548c Telegraf \u7684\u6307\u6807\uff0c\u5e76\u81ea\u52a8\u4e3a\u5176\u6ce8\u5165\u4e30\u5bcc\u7684\u6807\u51c6\u5316\u6807\u7b7e\u3002\u96c6\u6210 Prometheus/Telegraf \u7684\u6570\u636e\u6d41\u5982\u4e0b\uff1a</p> <p></p> <p>\u96c6\u6210 Prometheus \u7684\u914d\u7f6e\u89c1\u4e0b\uff1a\u6211\u4eec\u552f\u4e00\u8981\u505a\u7684\u53ea\u662f\u914d\u7f6e <code>prometheus-server</code> \u7684 <code>remote_write</code>\uff08\u5bf9 remote_read \u7684\u652f\u6301\u4e5f\u5728\u6392\u671f\u4e2d\uff09</p> <pre><code>remote_write:\n  - url: http://${DEEPFLOW_AGENT_SVC}/api/v1/prometheus\n</code></pre> <p>\u96c6\u6210 Telegraf \u7684\u914d\u7f6e\u89c1\u4e0b\uff1a\u4e5f\u53ea\u662f\u9700\u8981\u6307\u5b9a <code>output.http</code> \u7684\u7aef\u70b9\u3002</p> <pre><code>[[outputs.http]]\n  url = \"http://${DEEPFLOW_AGENT_SVC}/api/v1/telegraf\"\n  data_format = \"influx\"\n</code></pre> <p><code>deepflow-agent</code> \u9700\u8981\u6253\u5f00\u6570\u636e\u63a5\u6536\uff08\u9ed8\u8ba4\u5173\u95ed\uff0c\u51cf\u5c11\u76d1\u542c\u7aef\u53e3\uff09\uff0c\u8be6\u7ec6\u914d\u7f6e\u547d\u4ee4\u8bf7\u53c2\u8003\u5728\u7ebf\u6587\u6863[1]\uff1a</p> <pre><code>vtap_group_id: &lt;your-agent-group-id&gt;\nexternal_agent_http_proxy_enabled: 1\n</code></pre> <p>\u4e0d\u8d85\u8fc7\u4e94\u884c\u914d\u7f6e\uff0c\u5373\u53ef\u5b8c\u6210 Prometheus \u6216 Telegraf \u7684\u96c6\u6210\uff0c\u5e76\u53ef\u4ee5\u57fa\u4e8e\u96c6\u6210\u6570\u636e\u5728 Grafana \u4e2d\u5feb\u901f\u6784\u5efa Dashboard\u3002\u4f8b\u5982\u57fa\u4e8e Prometheus \u6570\u636e\u7684\u5bb9\u5668\u73af\u5883 Dashboard\uff1a</p> <p></p> <p>\u57fa\u4e8e Telegraf \u6570\u636e\u7684 Host \u73af\u5883 Dashaboard\uff1a</p> <p></p>"},{"location":"chap13/1deepflow/#_1","title":"\u6807\u7b7e\u6807\u51c6\u5316\uff0c\u544a\u522b\u6570\u636e\u5b64\u5c9b","text":"<ul> <li>K8s \u81ea\u5b9a\u4e49 Label\uff1a\u5de5\u4f5c\u8d1f\u8f7d Label\u3001ReplicaSet Label\u3001Pod Label\uff0c\u5e38\u89c1\u7684 Label \u4f8b\u5982 owner\u3001commitId\u3001version\u3001env\u3001group \u7b49</li> <li>K8s \u8d44\u6e90\u4fe1\u606f\uff1a\u96c6\u7fa4\u3001\u8282\u70b9\u3001\u547d\u540d\u7a7a\u95f4\u3001\u670d\u52a1\u3001Ingress\u3001\u5de5\u4f5c\u8d1f\u8f7d\uff08Deployment/StatefulSet/DaemonSet\uff09\u3001ReplicaSet\u3001Pod</li> <li>\u4e91\u8d44\u6e90\u4fe1\u606f\uff1a\u652f\u6301\u5404\u5927\u516c\u6709\u4e91 API\uff0c\u533a\u57df\u3001\u53ef\u7528\u533a\u3001\u4e91\u670d\u52a1\u5668\u3001VPC\u3001\u5b50\u7f51\u3001\u8def\u7531\u5668\u3001\u5b89\u5168\u7ec4\u3001NAT\u7f51\u5173\u3001\u8d1f\u8f7d\u5747\u8861\u5668\u3001\u5bf9\u7b49\u8fde\u63a5\u3001\u4e91\u4f01\u4e1a\u7f51\u3001RDS\u3001Redis</li> </ul> <p>\u8fd9\u4e9b\u6807\u7b7e\u7684\u6570\u91cf\u8fd8\u5728\u6301\u7eed\u589e\u957f\u4e2d\uff0c\u672a\u6765\u6211\u4eec\u4e5f\u4f1a\u589e\u52a0\u5bf9\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\u4fe1\u606f\u3001\u8fdb\u7a0b\u4fe1\u606f\u7b49\u76f8\u5173\u7684\u6807\u7b7e\uff0c\u6b63\u5728\u6301\u7eed\u8fed\u4ee3\u4e2d\u3002</p> <p>\u4e0d\u540c\u6570\u636e\u6e90\u7684\u6307\u6807\u6570\u636e\uff0c\u4ec5\u9700\u4f20\u9012\u4e00\u4e2a\u552f\u4e00\u6807\u7b7e\u5230 DeepFlow\uff0c\u5373\u53ef\u5168\u81ea\u52a8\u5f62\u5f0f\u6ce8\u5165 DeepFlow \u7684\u6240\u6709\u6807\u51c6\u5316\u6807\u7b7e\u3002</p> <p></p> <p>\u5bf9\u4e8e eBPF/cBPF \u91c7\u96c6\u5230\u7684\u5e94\u7528\u6027\u80fd\u5168\u6808\u6307\u6807\uff0c\u901a\u8fc7 IP \u5173\u8054\u81f3\u6240\u6709\u7684\u6807\u7b7e\uff1b\u5bf9\u4e8e Prometheus \u6570\u636e\uff0c\u901a\u8fc7 pod\u3001instance \u7b49\u6807\u7b7e\u6269\u5c55\uff1b\u5bf9\u4e8e Telegraf \u6570\u636e\uff0c\u901a\u8fc7 <code>pod_name</code>\u3001\u8fd0\u884cIP \u7b49\u6807\u7b7e\u6269\u5c55\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u7ed3\u5408 DeepFlow \u7684 SQL API \u548c Grafana Panel\uff0c\u5b9e\u9645\u6765\u770b\u770b\u6ce8\u5165\u7684\u6807\u51c6\u5316\u6807\u7b7e\u5728\u5b9e\u6218\u4e2d\u4ea7\u751f\u7684\u4e1d\u6ed1\u6548\u679c\u3002</p> <p>\u6253\u901a AutoMetrics \u548c Integration Metrics\uff1a</p> <p>\u4e0b\u56fe\u5de6\u56fe\u4e3a\u901a\u8fc7 Prometheus \u96c6\u6210\u7684\u6570\u636e\uff0c\u53f3\u56fe\u4e3a DeepFlow eBPF/cBPF AutoMetrics\u3002\u5f97\u76ca\u4e8e\u6807\u7b7e\u7684\u6807\u51c6\u5316\uff0c\u6211\u4eec\u57fa\u4e8e\u5bb9\u5668 Pod\u3001K8s \u81ea\u5b9a\u4e49 Label \u7b49\u4fe1\u606f\u7684\u4e00\u4e2a\u67e5\u8be2\u6761\u4ef6\u53ef\u4ee5\u67e5\u8be2\u4e0d\u540c\u6570\u636e\u6e90\u3002</p> <p></p> <p>\u4e0b\u56fe\u5de6\u56fe\u4e3a\u901a\u8fc7 Telegraf \u96c6\u6210\u7684\u6570\u636e\uff0c\u53f3\u56fe\u4e3a DeepFlow eBPF/cBPF AutoMetrics\u3002\u540c\u6837\uff0c\u6211\u4eec\u57fa\u4e8e\u4e91\u670d\u52a1\u5668\u3001VPC \u7b49\u8d44\u6e90\u4fe1\u606f\u7684\u4e00\u4e2a\u67e5\u8be2\u6761\u4ef6\u53ef\u4ee5\u67e5\u8be2\u4e0d\u540c\u6570\u636e\u6e90\u3002</p> <p></p> <p>\u6253\u901a Metrics\u3001Tracing\u3001Logging \u4e09\u5927\u652f\u67f1\uff1a</p> <p>\u5f97\u76ca\u4e8e DeepFlow \u4e2d\u6240\u6709\u6570\u636e\u7684\u6807\u7b7e\u6807\u51c6\u5316\uff0c\u4f7f\u7528\u8005\u4e0d\u7528\u5173\u5fc3\u4e0d\u540c\u6570\u636e\u6e90\u7684\u5dee\u5f02\uff0c\u771f\u6b63\u7684\u6253\u7834\u6570\u636e\u5b64\u5c9b\u3002\u5229\u7528\u76f8\u540c\u7684\u6807\u7b7e\u3001\u65f6\u95f4\u8303\u56f4\uff0c\u5373\u4f7f\u5728\u4e0d\u61c2\u5e95\u5c42\u539f\u7406\u3001\u4e0d\u61c2\u4e1a\u52a1\u903b\u8f91\u3001\u4e0d\u61c2\u7ec4\u4ef6\u67b6\u6784\u7b49\u60c5\u51b5\u4e0b\uff0c\u4e5f\u80fd\u5feb\u901f\u5c06\u6574\u4e2a\u7cfb\u7edf\u76f8\u5173\u7684\u6570\u636e\u5173\u8054\u8d77\u6765\uff0c\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898\u53d1\u73b0\u6839\u56e0\u3002</p> <p></p>"},{"location":"chap13/1deepflow/#_2","title":"\u6807\u7b7e\u81ea\u52a8\u5316\uff0c\u964d\u4f4e\u5de5\u4f5c\u8d1f\u62c5","text":"<p>Prometheus \u7684 relabeling \u673a\u5236\u80fd\u591f\u5bf9 Metrics \u7684\u6807\u7b7e\u8fdb\u884c\u7075\u6d3b\u7684\u7ba1\u7406\uff0cMetrics \u7684\u6240\u6709\u6807\u7b7e\u90fd\u662f\u5728\u8fd9\u4e2a\u9636\u6bb5\u7edf\u4e00\u6ce8\u5165\u6216\u8f6c\u6362\u7684\uff0c\u7279\u522b\u662f K8s \u8d44\u6e90\u76f8\u5173\u7684\u4fe1\u606f\u3002\u4f46\u662f relabeling \u7684\u914d\u7f6e\u975e\u5e38\u590d\u6742\uff0c\u4ee5\u9ed8\u8ba4\u7684 <code>kubernetes-service-endpoints</code> \u914d\u7f6e\u4e3a\u4f8b\u6211\u4eec\u6765\u611f\u53d7\u4e00\u4e0b\uff08\u671f\u671b\u6ca1\u6709\u6233\u4e2d\u4f60\u7684\u4f24\u5fc3\u5904\uff09\uff1a</p> <p><code>- job_name: kubernetes-service-endpoints   # ...   relabel_configs:   - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]     separator: ;     regex: \"true\"     replacement: $1     action: keep   - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape_slow]     separator: ;     regex: \"true\"     replacement: $1     action: drop   - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]     separator: ;     regex: (https?)     target_label: __scheme__     replacement: $1     action: replace   - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]     separator: ;     regex: (.+)     target_label: __metrics_path__     replacement: $1     action: replace   - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]     separator: ;     regex: (.+?)(?::\\d+)?;(\\d+)     target_label: __address__     replacement: $1:$2     action: replace   - separator: ;     regex: __meta_kubernetes_service_annotation_prometheus_io_param_(.+)     replacement: __param_$1     action: labelmap   - separator: ;     regex: __meta_kubernetes_service_label_(.+)     replacement: $1     action: labelmap   - source_labels: [__meta_kubernetes_namespace]     separator: ;     regex: (.*)     target_label: namespace     replacement: $1     action: replace   - source_labels: [__meta_kubernetes_service_name]     separator: ;     regex: (.*)     target_label: service     replacement: $1     action: replace   - source_labels: [__meta_kubernetes_pod_node_name]     separator: ;     regex: (.*)     target_label: node     replacement: $1     action: replace</code></p> <p>\u53ef\u4ee5\u60f3\u8c61\u5982\u679c\u6211\u4eec\u8981\u52a0\u66f4\u591a\u7684\u6807\u7b7e\uff0c\u6216\u8005\u6211\u4eec\u8981\u7ed9\u81ea\u5df1\u7684\u4e1a\u52a1\u52a0\u6807\u7b7e\uff0c\u4f1a\u53d8\u5f97\u66f4\u590d\u6742\u3002\u6240\u4ee5\u4e00\u822c relabeling \u8fd9\u79cd\u4e8b\uff0c\u6211\u662f\u65ad\uff08\u8ba9\uff09\u7136\uff08\u5f00\uff09\u62d2\uff08\u53d1\uff09\u7edd\uff08\u5e72\uff09\u7684\uff01</p> <p>\u5f53\u4f7f\u7528 DeepFlow \u96c6\u6210 Prometheus \u6570\u636e\u65f6\uff0c\u5f97\u76ca\u4e8e AutoTagging \u673a\u5236\uff0c\u6211\u4eec\u80fd\u591f\u6839\u636e instance \u6216 pod \u81ea\u52a8\u6269\u5c55\u4e30\u5bcc\u7684 K8s \u81ea\u5b9a\u4e49 Label\u3001K8s \u8d44\u6e90\u3001\u4e91\u8d44\u6e90\u6807\u7b7e\uff0c\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u7684\u914d\u7f6e\uff08\u53c8\u80fd\u548c\u5f00\u53d1\u505a\u670b\u53cb\u4e86\uff09\u3002</p> <p>\u90a3\u4e48\uff0c\u73b0\u5728\u4f60\u53ef\u4ee5\u5c06 relabeling \u914d\u7f6e\u8fdb\u884c\u7cbe\u7b80\u4e86\uff08instance \u6807\u7b7e\u603b\u662f\u4f1a\u5b58\u5728\uff0c\u5bf9\u4e8e HostNet Pod \u4fdd\u7559 pod \u6807\u7b7e\u5373\u53ef\uff09\uff0c\u7cbe\u7b80\u4e4b\u540e\u7684 Prometheus \u53d8\u5f97\u975e\u5e38\u6e05\u723d\uff1a</p> <p></p> <p>\u600e\u4e48\u67e5\u8fd9\u4e9b\u6807\u7b7e\u5462\uff0c\u5207\u6362\u5230 Grafana \u4e2d\uff0cDeepFlow \u5df2\u7ecf\u81ea\u52a8\u7ed9 kubernetes-service-endpoints \u6307\u6807\u91cf\u6ce8\u5165\u4e86\u975e\u5e38\u4e30\u5bcc\u7684\u6807\u7b7e\uff1a</p> <p></p>"},{"location":"chap13/1deepflow/#smartencoding","title":"SmartEncoding\uff0c\u6781\u81f4\u6027\u80fd","text":"<p>\u4e1a\u52a1\u5f00\u53d1\u4ee5\u53ca Prometheus relabeling \u4e3a\u6570\u636e\u6ce8\u5165\u7684\u6807\u7b7e\u8fc7\u591a\u65f6\uff0c\u901a\u5e38\u4f1a\u9020\u6210 Prometheus \u5de8\u5927\u7684\u5b58\u7b97\u538b\u529b\u3002\u76f8\u4fe1\u9aa8\u7070\u7ea7 Prometheus \u73a9\u5bb6\u75db\u82e6\u7684\u56de\u5fc6\u5c31\u662f\u5728 keep\u3001drop\u3001replace \u4e4b\u95f4\u8fdb\u884c\u8270\u96be\u7684\u6289\u62e9\u3002\u63a5\u5165 DeepFlow \u540e\uff0cClickHouse \u7684\u7a00\u758f\u7d22\u5f15\u76f4\u63a5\u89e3\u51b3\u4e86\u9ad8\u57fa\u6807\u7b7e\u95ee\u9898\uff0c\u518d\u4e5f\u4e0d\u7528 drop \u5f00\u53d1\u8f9b\u82e6\u6253\u7684\u6807\u7b7e\u4e86\u3002</p> <p>\u90a3\u4e48\u5927\u5bb6\u53ef\u80fd\u4f1a\u601d\u8003\uff0cDeepFlow \u81ea\u52a8\u6ce8\u5165\u4e86\u8fd9\u4e48\u591a\u6807\u7b7e\uff0c\u4f1a\u4e0d\u4f1a\u5bfc\u81f4\u81ea\u8eab agent \u548c server \u7684\u8d44\u6e90\u6d88\u8017\u98d9\u5347\uff1f\u5229\u7528 SmartEncoding\u673a\u5236\uff0c\u6211\u4eec\u5c06\u6240\u6709\u4e91\u8d44\u6e90\u3001\u5bb9\u5668\u8d44\u6e90\u6807\u7b7e\u7684\u6ce8\u5165\u6210\u672c\u964d\u4f4e\u4e86 10 \u500d\uff0c\u5c06 K8s \u81ea\u5b9a\u4e49 Label \u7684\u6ce8\u5165\u6210\u672c\u964d\u5230\u4e86 0\u3002\u76f8\u5173\u7ec6\u8282\u548c\u53ef\u91cd\u73b0\u7684 Benchmark \u4ee3\u7801\u6211\u4eec\u4e5f\u4f1a\u5728\u540e\u7eed\u7684\u6587\u7ae0\u4e2d\u9010\u6b65\u5206\u4eab\uff0c\u540c\u65f6\u4e5f\u6b22\u8fce\u793e\u533a\u7684\u5c0f\u4f19\u4f34\u8bd5\u7528\u3001\u538b\u6d4b\u3001\u53cd\u9988\u3002</p>"},{"location":"chap13/1deepflow/#_3","title":"\u672a\u6765\u5c55\u671b","text":"<p>Remote Read\uff1a\u662f\u7684\uff0c\u4e0d\u652f\u6301 <code>remote_read</code> \u63a5\u53e3\u7684 Prometheus \u65b9\u6848\u662f\u6ca1\u6709\u7075\u9b42\u7684\uff0c\u6211\u4eec\u5c06\u4f1a\u5728\u540e\u7eed\u7248\u672c\u4e2d\u5b8c\u5584\u6b64\u80fd\u529b\u3002\u5b9e\u73b0\u8fd9\u4e2a\u80fd\u529b\u540e\uff0c\u5927\u5bb6\u4e5f\u53ef\u4ee5\u5207\u6362\u4e3a\u66f4\u52a0\u8f7b\u91cf\u7ea7\u7684 Prometheus Agent Mode \u4e86\u3002</p> <p>PromQL\uff1a\u4e3a\u4e86\u964d\u4f4e\u5927\u5bb6\u7684\u4f7f\u7528\u95e8\u69db\uff0c\u5e76\u4e14\u8ba9\u6307\u6807\u3001\u8ffd\u8e2a\u3001\u65e5\u5fd7\u6709\u7edf\u4e00\u7684\u67e5\u8be2\u4f53\u9a8c\uff0cDeepFlow \u4f7f\u7528\u6807\u51c6\u7684 SQL API\u3002\u4f46 PromQL \u5b9e\u5728\u592a\u706b\u4e86\uff0c\u800c\u4e14\u6709\u5927\u91cf\u5df2\u7ecf\u5b58\u5728\u7684\u544a\u8b66\u7b56\u7565\u3001Grafana Dashaboard \u57fa\u4e8e\u6b64\u5efa\u7acb\u3002DeepFlow \u5c06\u4f1a\u63d0\u4f9b PromQL \u4f5c\u4e3a\u4e00\u79cd\u67e5\u8be2\u65b9\u8a00\u3002</p> <p>\u4e91\u8d44\u6e90\u6807\u7b7e\u3001\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\uff1a\u9664\u4e86\u81ea\u52a8\u6ce8\u5165\u4e91\u8d44\u6e90\u3001\u5bb9\u5668\u8d44\u6e90\u3001K8s \u81ea\u5b9a\u4e49 Label \u4ee5\u5916\uff0c\u6211\u4eec\u4e5f\u4f1a\u5728\u540e\u7eed\u7248\u672c\u4e2d\u652f\u6301\u516c\u6709\u4e91\u8d44\u6e90\u6807\u7b7e\u4ee5\u53ca\u670d\u52a1\u6ce8\u518c\u4e2d\u5fc3\u4fe1\u606f\u7684\u540c\u6b65\u3002</p> <p>\u8fdb\u7a0b\u4fe1\u606f\uff1aeBPF \u662f DeepFlow \u7684\u770b\u5bb6\u672c\u9886\uff0c\u65e0\u8bba\u662f\u5426\u5728\u5bb9\u5668\u73af\u5883\u4e2d\uff0c\u6211\u4eec\u90fd\u4f1a\u5c06\u901a\u8fc7 eBPF \u91c7\u96c6\u5230\u7684\u8fdb\u7a0b\u4fe1\u606f\u6ce8\u5165\u5230\u6240\u6709\u89c2\u6d4b\u6570\u636e\u4e2d\u3002</p>"},{"location":"chap13/1deepflow/#deepflow","title":"\u5173\u4e8e DeepFlow","text":"<p>DeepFlow \u662f\u4e00\u6b3e\u5f00\u6e90\u7684\u9ad8\u5ea6\u81ea\u52a8\u5316\u7684\u53ef\u89c2\u6d4b\u6027\u5e73\u53f0\uff0c\u662f\u4e3a\u4e91\u539f\u751f\u5e94\u7528\u5f00\u53d1\u8005\u5efa\u8bbe\u53ef\u89c2\u6d4b\u6027\u80fd\u529b\u800c\u91cf\u8eab\u6253\u9020\u7684\u5168\u6808\u3001\u5168\u94fe\u8def\u3001\u9ad8\u6027\u80fd\u6570\u636e\u5f15\u64ce\u3002DeepFlow \u4f7f\u7528 eBPF\u3001WASM\u3001OpenTelemetry \u7b49\u65b0\u6280\u672f\uff0c\u521b\u65b0\u7684\u5b9e\u73b0\u4e86 AutoTracing\u3001AutoMetrics\u3001AutoTagging\u3001SmartEncoding \u7b49\u6838\u5fc3\u673a\u5236\uff0c\u5e2e\u52a9\u5f00\u53d1\u8005\u63d0\u5347\u57cb\u70b9\u63d2\u7801\u7684\u81ea\u52a8\u5316\u6c34\u5e73\uff0c\u964d\u4f4e\u53ef\u89c2\u6d4b\u6027\u5e73\u53f0\u7684\u8fd0\u7ef4\u590d\u6742\u5ea6\u3002\u5229\u7528 DeepFlow \u7684\u53ef\u7f16\u7a0b\u80fd\u529b\u548c\u5f00\u653e\u63a5\u53e3\uff0c\u5f00\u53d1\u8005\u53ef\u4ee5\u5feb\u901f\u5c06\u5176\u878d\u5165\u5230\u81ea\u5df1\u7684\u53ef\u89c2\u6d4b\u6027\u6280\u672f\u6808\u4e2d\u3002</p> <p>GitHub \u5730\u5740\uff1ahttps://github.com/deepflowys/deepflow</p>"},{"location":"chap13/2Prometheus_opentele/","title":"2 Prometheus\u4e0eOpenTelemetry\u8be5\u9009\u54ea\u4e2a\uff1f","text":""},{"location":"chap13/2Prometheus_opentele/#1-prometheus-vs-opentelemetry","title":"1 Prometheus vs. OpenTelemetry\u6307\u6807\uff1a\u5171\u540c\u70b9","text":"<p>Prometheus\u662f\u4e00\u4e2a\u53ef\u89c2\u6d4b\u6027\u5de5\u5177\uff08\u5305\u62ec\u6536\u96c6\u3001\u5b58\u50a8\u548c\u67e5\u8be2\uff09\uff0c\u5b83\u4f7f\u7528\u7684\u6307\u6807\u6a21\u578b\u662f\u4e3a\u9002\u5e94\u81ea\u5df1\u7684\u9700\u8981\u800c\u8bbe\u8ba1\u7684</p> <p>\u53e6\u4e00\u65b9\u9762\uff0cOpenTelemetry\u7684\u6307\u6807\u7ec4\u4ef6\u5c06\u8bb8\u591a\u4e0d\u540c\u7684\u6570\u636e\u6a21\u578b\u8f6c\u5316\u4e3a\u4e00\u4e2a\u5355\u4e00\u7684\u6846\u67b6\uff08\u63d0\u4f9b\u65e0\u5b58\u50a8\u6216\u67e5\u8be2\u7684\u96c6\u5408\uff09\u3002</p> <p>\u8fd9\u4e9b\u6838\u5fc3\u5dee\u5f02\u53cd\u6620\u4e86\u7cfb\u7edf\u7684\u590d\u6742\u6027\uff1aPrometheus\u662f\u4e00\u4e2a\u76f4\u63a5\u7684\u6a21\u578b\uff0c\u901a\u5e38\u4ee5\u6587\u672c\u5f62\u5f0f\u66b4\u9732\u51fa\u6765\uff0c\u800cOpenTelemetry\u662f\u7531\u4e09\u79cd\u6a21\u578b\u7ec4\u6210\u7684\u66f4\u590d\u6742\u7684\u7cfb\u5217\uff0c\u4f7f\u7528\u4e8c\u8fdb\u5236\u683c\u5f0f\u8fdb\u884c\u4f20\u8f93\u3002</p> <p>\u8fd9\u4e24\u4e2a\u7cfb\u7edf\u4e5f\u5141\u8bb8\u901a\u8fc7SDK\u8fdb\u884c\u4ee3\u7801\u7ea7\u7684\u76d1\u63a7\uff0c\u4f46OpenTelemetry\u4e5f\u4e13\u6ce8\u4e8e\u652f\u6301\u81ea\u52a8\u57cb\u70b9\uff0c\u5c3d\u53ef\u80fd\u4e0d\u4f1a\u4fb5\u5165\u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>\u90a3\u4e48\uff0c\u4f60\u53ef\u4ee5\u521b\u5efa\u7684\u6307\u6807\u4e4b\u95f4\u6709\u4ec0\u4e48\u91cd\u53e0\uff1f</p> <p>\u672c\u8d28\u4e0a\uff0cOpenTelemetry\u5141\u8bb8\u8868\u793a\u6240\u6709Prometheus\u6307\u6807\u7c7b\u578b\uff08Counters\u3001Gauges\u3001Summaries\u548cHistograms\uff09\u3002</p> <p>\u5c3d\u7ba1\u5982\u6b64\uff0cPrometheus\u4ecd\u7136\u4e0d\u80fd\u8868\u793aOpenTelemetry\u6307\u6807\u7684\u67d0\u4e9b\u914d\u7f6e\uff0c\u5305\u62ecDelta\u8868\u793a\u6cd5\u548c\u6307\u6570Histograms\uff08\u5c3d\u7ba1\u8fd9\u4e9b\u5c06\u5f88\u5feb\u5728Prometheus\u4e2d\u88ab\u652f\u6301\uff09\uff0c\u4ee5\u53ca\u6574\u6570\u6570\u503c\u7c7b\u578b\u3002</p> <p>\u6362\u53e5\u8bdd\u8bf4\uff0cPrometheus\u6307\u6807\u662fOpenTelemetry\u6307\u6807\u7684\u4e00\u4e2a\u4e25\u683c\u5b50\u96c6\u3002</p>"},{"location":"chap13/2Prometheus_opentele/#2","title":"2 \u4e3b\u8981\u533a\u522b","text":"<p>\u867d\u7136\u5185\u90e8\u6a21\u578b\u7684\u5de5\u4f5c\u65b9\u5f0f\u6709\u4e00\u4e9b\u5dee\u5f02\uff0c\u4f46\u4ece\u5f00\u53d1\u8005\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u4e24\u8005\u4e4b\u95f4\u7684\u5b9e\u9645\u5dee\u5f02\u66f4\u591a\u662f\u4e0e\u751f\u6001\u7cfb\u7edf\u6709\u5173\u3002</p> <p>Prometheus\u63d0\u4f9b\u6307\u6807\u6536\u96c6\u3001\u5b58\u50a8\u548c\u67e5\u8be2\u3002\u5b83\u901a\u5e38\u901a\u8fc7\u4e00\u4e2a\u7b80\u5355\u7684\u722c\u866b\u7cfb\u7edf\u6536\u96c6\u6307\u6807\uff0c\u4ece\u4e3b\u673a\u4e2d\u63d0\u53d6\u6570\u636e\u3002</p> <p>Prometheus\u6570\u636e\u5e93\u5b58\u50a8\u8fd9\u4e9b\u6570\u636e\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u7528Prometheus\u67e5\u8be2\u8bed\u8a00PromQL\u6765\u67e5\u8be2\u3002</p> <p>Prometheus\u6570\u636e\u5e93\u53ef\u4ee5\u5904\u7406\u5927\u91cf\u7684\u6570\u636e\uff0c\u4f46\u5b83\u5e76\u4e0d\u662f\u6b63\u5f0f\u610f\u4e49\u4e0a\u7684\u957f\u671f\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\uff0c\u6240\u4ee5\u6570\u636e\u901a\u5e38\u5728\u4e00\u6bb5\u65f6\u95f4\u540e\u88ab\u53d1\u9001\u5230\u53e6\u4e00\u4e2a\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\uff0c\u5982Promsale\uff0c\u4f46\u4ecd\u7136\u53ef\u4ee5\u901a\u8fc7PromQL\u8fdb\u884c\u8bfb\u53d6\u3002</p> <p>OpenTelemetry\u7684\u9886\u57df\u8981\u5c0f\u5f97\u591a\u3002\u5b83\u901a\u8fc7\u63a8\u9001\u6216\u62c9\u52a8\uff0c\u4f7f\u7528\u7edf\u4e00\u7684API\u6536\u96c6\u6307\u6807\uff08\u4ee5\u53ca\u94fe\u8def\u8ffd\u8e2a\u548c\u65e5\u5fd7\uff09\uff0c\u53ef\u80fd\u4f1a\u5bf9\u5b83\u4eec\u8fdb\u884c\u8f6c\u6362\uff0c\u5e76\u5c06\u5b83\u4eec\u53d1\u9001\u5230\u5176\u4ed6\u7cfb\u7edf\u8fdb\u884c\u5b58\u50a8\u6216\u67e5\u8be2\u3002</p> <p>\u901a\u8fc7\u53ea\u5173\u6ce8\u53ef\u89c2\u6d4b\u6027\u4e2d\u4e0e\u5e94\u7528\u7a0b\u5e8f\u4ea4\u4e92\u7684\u90e8\u5206\uff0cOpenTelemetry\u5c06Signal\u7684\u521b\u5efa\u4e0e\u5b58\u50a8\u3001\u67e5\u8be2\u95ee\u9898\u89e3\u8026\u3002</p> <p>\u5177\u6709\u8bbd\u523a\u610f\u5473\u7684\u662f\uff0c\u8fd9\u610f\u5473\u7740OpenTelemetry\u7684\u6307\u6807\u5f80\u5f80\u6700\u7ec8\u4f1a\u56de\u5230Prometheus\u6216\u4e0ePrometheus\u517c\u5bb9\u7684\u7cfb\u7edf\u4e2d\u3002</p> <p>\u5f53\u6211\u4eec\u5728\u770b\u5b9e\u9645\u7684\u6307\u6807\u7c7b\u578b\u65f6\uff0c\u6709\u51e0\u4e2a\u533a\u522b\uff1a</p> <ul> <li>OpenTelemetry\u53ef\u4ee5\u5c06\u6307\u6807\u8868\u793a\u4e3a\u5dee\u503c\uff0c\u800c\u4e0d\u662f\u7d2f\u79ef\u503c\uff0c\u5b58\u50a8\u6bcf\u4e2a\u6570\u636e\u70b9\u4e4b\u95f4\u7684\u5dee\u5f02\uff0c\u800c\u4e0d\u662f\u7d2f\u79ef\u503c\u3002Prometheus\u5728\u8bbe\u8ba1\u4e0a\u4e0d\u5141\u8bb8\u8fd9\u6837\u505a\uff0c\u5c3d\u7ba1\u4f60\u53ef\u4ee5\u5728\u67e5\u8be2\u65f6\u8ba1\u7b97\u51fa\u8fd9\u4e9b\u503c\u3002\u8fd9\u4e0d\u662fOpenTelemetry\u7684\u9ed8\u8ba4\u9009\u9879\uff0c\u4e3b\u8981\u7528\u4e8e\u90a3\u4e9b\u53ea\u8868\u793a\u4e3a\u901f\u7387\u7684\u6307\u6807\u3002</li> <li>OpenTelemetry\u8fd8\u5141\u8bb8\u6307\u6807\u70b9\u503c\u662f\u6574\u6570\u800c\u4e0d\u662f\u6d6e\u70b9\u6570\uff0c\u8fd9\u662fPrometheus\u65e0\u6cd5\u8868\u8fbe\u7684\u3002</li> <li>OpenTelemetry\u53ef\u4ee5\u7ed9Histogram\u9644\u52a0\u4e00\u4e9b\u989d\u5916\u7684\u5143\u6570\u636e\uff0c\u5141\u8bb8\u8ddf\u8e2a\u6700\u5927\u548c\u6700\u5c0f\u503c\u3002</li> <li>\u6700\u540e\uff0cOpenTelemetry\u6709\u4e00\u4e2a\u6307\u6570\u76f4\u65b9\u56fe\u805a\u5408\u7c7b\u578b\uff08\u5b83\u4f7f\u7528\u4e00\u4e2a\u516c\u5f0f\u548c\u4e00\u4e2a\u6bd4\u4f8b\u6765\u8ba1\u7b97\u6876\u7684\u5927\u5c0f\uff09\u3002Prometheus\u76ee\u524d\u8fd8\u4e0d\u80fd\u8868\u793a\u8fd9\u4e2a\uff0c\u4f46\u786e\u5b9e\u6709\u4e00\u4e2a\u5b8c\u5168\u517c\u5bb9\u7684\u6307\u6807\u7c7b\u578b\u6b63\u5728\u5f00\u53d1\u4e2d\u3002</li> </ul>"},{"location":"chap13/2Prometheus_opentele/#3","title":"3 \u2014 \u9009\u62e9\u5176\u4e00","text":"<p>\u5982\u679c\u4f60\u8fd8\u6ca1\u6709\u5bf9\u8fd9\u4e24\u79cd\u6280\u672f\u4e2d\u7684\u4e00\u79cd\u8fdb\u884c\u6295\u8d44\uff0c\u5728Prometheus\u548cOpenTelemetry\u4e4b\u95f4\u7684\u9009\u62e9\u53ef\u80fd\u4f1a\u5f52\u7ed3\u4e3a\u56db\u4e2a\u95ee\u9898\uff1a</p> <ul> <li> <p>\u4f60\u662f\u5426\u8ba1\u5212\u6355\u83b7\u94fe\u8def\u8ffd\u8e2a\u3001\u65e5\u5fd7\u548c\u6307\u6807\uff1f\u5982\u679c\u662f\u8fd9\u6837\uff0cOpenTelemetry\u5c06\u5141\u8bb8\u4f60\u4f7f\u7528\u76f8\u540c\u7684\u5e93\u6765\u6d4b\u91cf\u6240\u6709\u4e09\u79cd\u4fe1\u53f7\u7c7b\u578b\uff0c\u8fd9\u662f\u4e00\u4e2a\u5f88\u5927\u7684\u597d\u5904\u3002\u4f60\u751a\u81f3\u53ef\u4ee5\u628a\u6240\u6709\u8fd9\u4e09\u79cd\u4fe1\u53f7\u53d1\u9001\u5230\u540c\u4e00\u4e2a\u540e\u7aef\uff0c\u5e76\u4f7f\u7528\u4e00\u79cd\u8bed\u8a00\u6765\u67e5\u8be2\u5b83\u4eec\uff08\u4f8b\u5982\uff0cPromscale\u548cSQL\uff09\u3002</p> </li> <li> <p>\u4f60\u662f\u5426\u91cd\u89c6\u7a33\u5b9a\u6027\u548c\u7ecf\u8fc7\u6218\u6597\u8003\u9a8c\u7684\u7cfb\u7edf\uff1f\u5982\u679c\u662f\u8fd9\u6837\uff0c\u968f\u7740OpenTelemetry\u5728\u751f\u4ea7\u4e0a\u7684\u9010\u6b65\u63a8\u5e7f\uff0cPrometheus\u6216\u8bb8\u662f\u6700\u8fd1\u8fd9\u51e0\u5e74\u7684\u6b63\u786e\u7b54\u6848\u3002</p> </li> <li> <p>\u4f60\u60f3\u4f7f\u7528\u4e00\u4e2a\u591a\u6b65\u9aa4\u7684\u8def\u7531\u548c\u8f6c\u6362\u7ba1\u9053\u5417\uff1f\u5982\u679c\u662f\u8fd9\u6837\uff0c\u4e5f\u8bb8OpenTelemetry\u53ef\u80fd\u503c\u5f97\u4e00\u770b\u3002</p> </li> </ul> <p>\u4f60\u5e0c\u671b\u80fd\u591f\u4fdd\u6301\u5c3d\u53ef\u80fd\u7684\u7075\u6d3b\u6027\u5417\uff1f\u90a3\u4e48OpenTelemetry\u5c31\u9002\u5408\u4f60\uff0c\u56e0\u4e3a\u5b83\u4e0d\u5b9e\u73b0\u4efb\u4f55\u5b58\u50a8\u6216\u67e5\u8be2\uff0c\u7ed9\u4f60\u6700\u5927\u7684\u7075\u6d3b\u6027\u3002</p> <p>\u5927\u591a\u6570\u7ec4\u7ec7\u53ef\u80fd\u4f1a\u6df7\u5408\u4f7f\u7528\u4e24\u79cd\u6807\u51c6\u3002Prometheus\u7528\u4e8e\u57fa\u7840\u8bbe\u65bd\u76d1\u63a7\uff0c\u5229\u7528\u66f4\u6210\u719f\u7684\u96c6\u6210\u751f\u6001\u7cfb\u7edf\u4ece\u6570\u767e\u4e2a\u7ec4\u4ef6\u4e2d\u63d0\u53d6\u6307\u6807\uff0c\u800cOpenTelemetry\u7528\u4e8e\u5df2\u5f00\u53d1\u7684\u670d\u52a1</p> <p>\u8bb8\u591a\u5de5\u7a0b\u5e08\u53ef\u80fd\u4f1a\u4f7f\u7528Prometheus\u4f5c\u4e3a\u540e\u7aef\u6765\u5b58\u50a8Prometheus\u548cOpenTelemetry\u6307\u6807\uff0c\u5e76\u9700\u8981\u786e\u4fdd\u4ed6\u4eec\u4ea7\u751f\u7684OpenTelemetry\u6307\u6807\u4e0ePrometheus\u517c\u5bb9\u3002</p> <p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u8fd9\u610f\u5473\u7740\u9009\u62e9\u65f6\u95f4\u7684\u7d2f\u79ef\u805a\u5408\uff0c\u5e76\u4e14\u53ea\u4f7f\u7528Prometheus\u652f\u6301\u7684OpenTelemetry\u6307\u6807\u7c7b\u578b\uff08\u5728Prometheus\u589e\u52a0\u5bf9OpenTelemetry\u6307\u6570\u76f4\u65b9\u56fe\u7684\u652f\u6301\u4e4b\u524d\uff0c\u6682\u4e0d\u8003\u8651\u8fd9\u4e9b\u6307\u6807\uff09\u3002</p>"},{"location":"chap13/2Prometheus_opentele/#4-prometheusopentelemetry","title":"4 \u2014 \u5728Prometheus\u548cOpenTelemetry\u4e4b\u95f4\u8f6c\u6362","text":"<p>\u5982\u679c\u4f60\u65e2\u60f3\u6df7\u5408\u4f7f\u7528\uff0c\u540c\u65f6\u4e5f\u60f3\u5339\u914d\u6807\u51c6\uff0c\u90a3\u4e48\u597d\u6d88\u606f\u662fOpenTelemetry\u63d0\u4f9b\u4e86OpenTelemetry\u6536\u96c6\u5668\uff0c\u5b83\u53ef\u4ee5\u5e2e\u52a9\u540c\u65f6\u517c\u987e\u4e24\u4e2a\u65b9\u5411\uff08\u5982\u679c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u9700\u8981\uff0c\u751a\u81f3\u5728\u7c7b\u578b\u4e4b\u95f4\u8fdb\u884c\u8f6c\u6362\uff09\u3002</p> <p>OpenTelemetry Collector\u662f\u53ef\u63d2\u62d4\u7684\uff0c\u5141\u8bb8\u5728\u8fd0\u884c\u65f6\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u6765\u542f\u7528Receiver\u548cExporter\u7ec4\u4ef6\u3002</p> <p>\u6211\u4eec\u5c06\u4f7f\u7528contrib\u5305\uff0c\u5176\u4e2d\u5305\u62ec\u8bb8\u591aReceiver\u548cExporter\u3002\u4f60\u53ef\u4ee5\u4eceGitHub\u7684Release\u9875\u9762 \u4e0b\u8f7d\u76f8\u5e94\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002\u53e6\u5916\uff0c\u5982\u679c\u4f60\u5728\u751f\u4ea7\u4e2d\u8fd0\u884c\u91c7\u96c6\u5668\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528OpenTelemetry\u6536\u96c6\u5668\u6784\u5efa\u5de5\u5177 \u7f16\u8bd1\u4e00\u4e2a\u53ea\u5305\u542b\u4f60\u9700\u8981\u7684\u7ec4\u4ef6\u7684\u7248\u672c\u3002</p> <p>\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u7528\u4ee5\u4e0b\u7684\u914d\u7f6e\u6587\u4ef6\u8fd0\u884c\u91c7\u96c6\u5668\uff0c\u8be5\u6587\u4ef6\u4fdd\u5b58\u4e3aconfig.yaml\uff1a</p> <pre><code>receivers:\nprometheus:\nconfig:\n  scrape_configs:\n    - job_name: demo\n      scrape_interval: 15s\n      static_configs:\n        - targets: ['localhost:9090']\n\nexporters:\nprometheus:\n endpoint: \"0.0.0.0:1234\"\nlogging:\nloglevel: debug\n\nservice:\ntelemetry:\nlogs:\n  level: debug\npipelines:\nmetrics:\n  receivers: [prometheus]\n  processors: []\n  exporters: [logging,prometheus]\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u542f\u52a8\u91c7\u96c6\u5668\uff1a</p> <pre><code>otelcol \u2013config config.yaml\n</code></pre> <p>\u91c7\u96c6\u5668\u5c06\u4f7f\u7528Prometheus Receiver\u6765\u5c1d\u8bd5\u6293\u53d6Prometheus\u670d\u52a1\uff0c\u5730\u5740\u662f<code>http://localhost:9100</code>\u3002\u5982\u679c\u4f60\u9700\u8981\u4e00\u4e9b\u4e1c\u897f\u6765\u6d4b\u8bd5\uff0c\u4f60\u53ef\u4ee5\u542f\u52a8\u4e00\u4e2a\u4f7f\u7528\u8fd9\u4e2a\u7aef\u53e3\u7684\u672c\u5730<code>node_exporter</code>\u3002</p> <p>\u5f53\u6570\u636e\u4ece\u8fd9\u4e2a\u670d\u52a1\u4e2d\u88ab\u6293\u53d6\u65f6\uff0c\u4f60\u4f1a\u770b\u5230\u5b83\u663e\u793a\u5728\u6536\u96c6\u5668\u7684\u65e5\u5fd7\u8f93\u51fa\u4e2d\uff0c\u800c\u4e14\u5b83\u4e5f\u53ef\u4ee5\u4ecePrometheus Exporter\u7684\u7aef\u70b9\u4e2d\u83b7\u5f97\uff0c\u6536\u96c6\u5668\u8fd0\u884c\u5728<code>http://localhost:1234</code>\u3002</p> <p>Prometheus\u7684\u8fdc\u7a0b\u5199\u5165\uff08Remote Write\uff09Exporter\u4e5f\u662f\u4e00\u4e2a\u9009\u62e9\uff0c\u4f46\u5728\u73b0\u9636\u6bb5\u5b83\u7684\u5e94\u7528\u8303\u56f4\u6bd4\u8f83\u6709\u9650\uff0c\u53ea\u80fd\u5904\u7406\u79ef\u7d2fCounters\u548cGauges\u3002</p> <p></p> <p>\u8bf4\u660ePrometheus\u5982\u4f55\u4e0eOpenTelemetry\u6536\u96c6\u5668\u4e92\u52a8</p> <p>\u5728Prometheus\u7684\u4e0a\u4e0b\u6587\u4e2d\uff0cCounter\u662f\u5355\u8c03\u7684\uff08\u6301\u7eed\u589e\u52a0\uff09\uff0c\u800cGauge\u5219\u4e0d\u662f\uff08\u5b83\u53ef\u4ee5\u4e0a\u5347\u548c\u4e0b\u964d\uff09</p> <p>Summary\u62a5\u544a\u767e\u5206\u4f4d\uff0c\u4e0d\u9700\u8981\u90a3\u4e48\u591a\u7684\u5ba2\u6237\u7aef\u8ba1\u7b97\u3002\u53e6\u4e00\u65b9\u9762\uff0cHistogram\u66f4\u7075\u6d3b\uff0c\u63d0\u4f9b\u539f\u59cb\u6876\u7684\u5bbd\u5ea6\u548c\u8ba1\u6570\u503c</p> <p>\u76f8\u6bd4\u4e4b\u4e0b\uff0cOpenTelemetry\u6709\u4e94\u79cd\u6307\u6807\u7c7b\u578b\uff1aSums\u3001Gauges\u3001Summaries\u3001Histograms\u548c\u6307\u6570Histograms\u3002</p> <p>\u5982\u679c\u4f60\u662f\u4e00\u4e2a\u521b\u5efaOpenTelemetry\u6307\u6807\u7684\u5f00\u53d1\u8005\uff0c\u4f60\u5904\u7406\u7684\u662f\u4e8b\u4ef6\u6a21\u578b\uff08Event Model\uff09\uff0c\u7136\u540e\u7531OpenTelemetry SDK\u7ffb\u8bd1\uff08\u7528\u4e8e\u4f20\u8f93\uff09\u4e3aOpenTelemetry\u534f\u8bae\uff08OTLP\uff09\u6d41\u6a21\u578b\u3002</p> <p>\u6211\u4eec\u5728\u8fd9\u91cc\u5f15\u7528\u7684\u6307\u6807\u7c7b\u578b\u662fOTPL\u6a21\u578b\u7684\u4e00\u90e8\u5206\uff0cPrometheus Receiver\u76f4\u63a5\u7ffb\u8bd1\u6210\u8fd9\u79cd\u6a21\u578b\u3002</p> <p>\u5e78\u8fd0\u7684\u662f\uff0c\u8fd9\u4e9b\u65b0\u7684\u6307\u6807\u7c7b\u578b\u662f\u4e0d\u8a00\u81ea\u660e\u7684\uff0c\u76f4\u63a5\u6620\u5c04\u5230Prometheus\u7684\u6307\u6807\u7c7b\u578b\u4e0a\uff08Summary\u53ea\u4e3aPrometheus\u517c\u5bb9\u800c\u5b9e\u73b0\uff0c\u4f60\u4e0d\u4f1a\u5728\u5176\u4ed6\u5730\u65b9\u770b\u5230\u5b83\u7684\u4f7f\u7528\uff09\u3002\u6307\u6570Histogram\u662f\u4e2a\u4f8b\u5916\uff0c\u5b83\u76ee\u524d\u4e0d\u80fd\u88ab\u8f6c\u6362\u5230Prometheus\u6307\u6807\uff08\u4f46\u5c06\u6765\u53ef\u4ee5\u88ab\u8f6c\u6362\uff09\u3002</p> <p>\u4e0b\u56fe\u63cf\u8ff0\u4e86\u6bcf\u4e2a\u65b9\u5411\u4e0a\u7684\u6620\u5c04\u662f\u5982\u4f55\u5de5\u4f5c\u7684</p> <p></p> <p>OpenTelemetry\u627f\u8bfa\u5bf9Prometheus\u6307\u6807\u8fdb\u884c\u65e0\u635f\u8f6c\u6362\uff0c\u4f7f\u7528\u6237\u80fd\u591f\u6839\u636e\u9700\u8981\u8fdb\u884c\u8f6c\u6362\u800c\u4e0d\u5fc5\u62c5\u5fc3\u6570\u636e\u4e22\u5931\u3002</p>"},{"location":"chap13/2Prometheus_opentele/#5-prometheusopentelemetry","title":"5 \u2014 \u5c06Prometheus\u8f6c\u6362\u6210OpenTelemetry","text":"<p>\u8ba9\u6211\u4eec\u901a\u8fc7\u770bPrometheus\u6293\u53d6\u548cOpenTelemetry\u6307\u6807\u7684\u4f8b\u5b50\u6765\u63a2\u7d22Prometheus\u5230OpenTelemetry\u7684\u8f6c\u6362\u662f\u5982\u4f55\u8fdb\u884c\u7684\u3002</p> <p>\u867d\u7136OpenTelemetry\u6ca1\u6709\u50cfPrometheus\u90a3\u6837\u7684\u6587\u672c\u534f\u8bae\uff0c\u4f46\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528Logging Exporter\u6765\u53d1\u5c04\u6355\u83b7\u5230\u7684\u6307\u6807\u7684\u6587\u672c\u8f6c\u50a8\u5f62\u5f0f\u3002</p> <p>OpenTelemetry\u5c06\u4ece\u6293\u53d6\u4efb\u52a1\u672c\u8eab\u63d0\u53d6\u4e00\u4e9b\u4fe1\u606f\u5e76\u5b58\u50a8\u8d77\u6765\uff0c\u4ea7\u751f\u4ee5\u4e0b\u8f93\u51fa\uff0c\u5176\u4e2d\u5b9a\u4e49\u4e86\u5c06\u9644\u52a0\u5230\u6240\u6709\u6307\u6807\u7684\u8d44\u6e90\u6807\u7b7e\u3002</p> <pre><code>Resource SchemaURL:\nResource labels:\n -&gt; service.name: STRING(node-exporter)\n -&gt; service.instance.id: STRING(127.0.0.1:9100)\n -&gt; net.host.port: STRING(9100)\n -&gt; http.scheme: STRING(http)\nCounters\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u6709\u5982\u4e0b\u7684Prometheus\u6293\u53d6\u6570\u636e\uff0c\u5e76\u628a\u91c7\u96c6\u5668\u6307\u5411\u5b83\uff1a</p> <pre><code>HELP http_requests_total Total HTTP requests served\nTYPE http_requests_total counter\nhttp_requests_total{method=\"post\",code=\"200\"} 1028\nhttp_requests_total{method=\"post\",code=\"400\"}    5\n</code></pre> <p>\u7136\u540e\u6536\u96c6\u5668\u5c06\u4ece\u65e5\u5fd7Exporter\u4e2d\u8f93\u51fa\u4ee5\u4e0b\u6307\u6807\u3002</p> <pre><code>Metric #0\nDescriptor:\n -&gt; Name: http_requests_total\n -&gt; Description: Total HTTP requests served\n -&gt; Unit:\n -&gt; DataType: Sum\n -&gt; IsMonotonic:true-&gt; AggregationTemporality: AGGREGATION_TEMPORALITY_CUMULATIVE\nNumberDataPoints #0\nData point attributes:\n -&gt; code: STRING(200)\n -&gt; method: STRING(post)\nStartTimestamp: 2022-06-16 11:49:22.117 +0000 UTC\nTimestamp: 2022-06-16 11:49:22.117 +0000 UTC\nValue: 1028.000000\nNumberDataPoints #1\nData point attributes:\n -&gt; code: STRING(400)\n -&gt; method: STRING(post)\nStartTimestamp: 2022-06-16 11:49:22.117 +0000 UTC\nTimestamp: 2022-06-16 11:49:22.117 +0000 UTC\nValue: 5.00000\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6307\u6807\u7684\u7c7b\u578b\uff08DataType\uff09\u662fSum\uff0cAggregationTemporality\u662fCumulative\uff08Prometheus\u652f\u6301\u7684\u552f\u4e00\u805a\u5408\u65b9\u5f0f\uff09\u3002</p> <p>\u6bcf\u4e2a\u6570\u636e\u70b9\u6709\u4e24\u4e2a\u65f6\u95f4\u6233\uff0c\u4ee5\u8ddf\u8e2aCounter\u7684\u590d\u4f4d\u3002Timestamp\u662f\u8bb0\u5f55\u7684\u65f6\u95f4\uff0cStartTimestamp\u662f\u6536\u5230\u7b2c\u4e00\u4e2a\u6837\u672c\u7684\u65f6\u95f4\u6216\u6700\u540e\u4e00\u6b21\u8ba1\u6570\u5668\u590d\u4f4d\u7684\u65f6\u95f4\uff0c\u6ca1\u6709\u6307\u5b9a\u5355\u4f4d\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3aPrometheus\u6307\u5b9a\u5355\u4f4d\u7684\u65b9\u5f0f\u662f\u5c06\u5176\u4f5c\u4e3a\u6587\u672c\u5ea6\u91cf\u540d\u79f0\u7684\u4e00\u90e8\u5206\uff0c\u8fd9\u4e0d\u80fd\u88abOpenTelemetry Collector\u51c6\u786e\u89e3\u7801</p>"},{"location":"chap13/2Prometheus_opentele/#gauges","title":"Gauges","text":"<p>\u5982\u679c\u6211\u4eec\u6709\u4e00\u4e2aPrometheus\u7684Gauge\u6570\u636e\uff0c\u5e76\u6293\u53d6\u5b83\uff1a</p> <pre><code>HELP node_filesystem_avail_bytes Available bytes in filesystems\nTYPE node_filesystem_avail_bytes gauge\nnode_filesystem_avail_bytes{method=\"/data\",fstype=\"ext4\"} 250294\n</code></pre> <p>\u6211\u4eec\u4f1a\u5728\u91c7\u96c6\u5668\u4e0a\u770b\u5230\u5982\u4e0b\u6570\u636e\uff1a</p> <pre><code>Metric #0\nDescriptor:\n -&gt; Name: node_filesystem_avail_bytes\n -&gt; Description: Available bytes in filesystems\n -&gt; Unit:\n -&gt; DataType: Gauge\nNumberDataPoints #0\nData point attributes:\n -&gt; fstype: STRING(ext4)\n -&gt; method: STRING(/data)\nStartTimestamp: 1970-01-01 00:00:00 +0000 UTC\nTimestamp: 2022-06-23 07:42:07.117 +0000 UTC\nValue: 250294.000000\n</code></pre> <p>\u8fd9\u91cc\uff0c\u6570\u636e\u7c7b\u578b\u88ab\u8bbe\u7f6e\u4e3aGauge\u3002Gauge\u662fOpenTelemetry\u5c06\u8f6c\u6362\u4e3a\u7684\u9ed8\u8ba4\u6307\u6807\u7c7b\u578b\uff0c\u6240\u4ee5\u5728Prometheus\u7684\u6570\u636e\u4e2d\u7f3a\u5c11# TYPE\u884c\uff0c\u5c06\u5bfc\u81f4\u51fa\u73b0\u4e00\u4e2aGauge\u3002</p> <p>Prometheus\u672c\u8eab\u5b9e\u9645\u4e0a\u5e76\u4e0d\u4f1a\u4f7f\u7528\u7c7b\u578b\u4fe1\u606f\uff08\u5b83\u5728\u5185\u90e8\u5e76\u4e0d\u533a\u5206Counter\u548cGauge\uff09\uff0c\u6240\u4ee5\u4e00\u4e9bExporter\u4f1a\u653e\u5f03\u8fd9\u4e24\u884c\u6ce8\u91ca\uff0c\u4ee5\u4f7f\u6293\u53d6\u884c\u4e3a\u66f4\u6709\u6548\u7387\u3002\u8fd9\u5c06\u5bfc\u81f4\u6240\u6709OpenTelemetry\u6307\u6807\u90fd\u662fGauge\u3002</p>"},{"location":"chap13/2Prometheus_opentele/#histograms","title":"Histograms","text":"<p>Prometheus\u7684histogram\u6570\u636e\u5982\u4e0b\uff1a</p> <pre><code>HELP http_request_duration_seconds Histogram of latencies for HTTP requests.\nTYPE http_request_duration_seconds histogram\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"0.1\"} 25547\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"0.2\"} 26688\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"0.4\"} 27760\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"1\"} 28641\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"3\"} 28782\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"8\"} 28844\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"20\"} 28855\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"60\"} 28860\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"120\"} 28860\nhttp_request_duration_seconds_bucket{handler=\"/\",le=\"+Inf\"} 28860\nhttp_request_duration_seconds_sum{handler=\"/\"} 1863.80491025699\nhttp_request_duration_seconds_count{handler=\"/\"} 28860\n</code></pre> <p>\u5728OpenTelemetry\u7684\u65e5\u5fd7Exporter\u4e2d\u4f1a\u4ee5\u5982\u4e0b\u683c\u5f0f\u8868\u793a\uff1a</p> <pre><code>Metric #0\nDescriptor:\n -&gt; Name: prometheus_http_request_duration_seconds\n -&gt; Description: Histogram of latencies for HTTP requests.\n -&gt; Unit:\n -&gt; DataType: Histogram\n -&gt; AggregationTemporality: AGGREGATION_TEMPORALITY_CUMULATIVE\nHistogramDataPoints #0\nData point attributes:\n -&gt; handler: STRING(/)\nStartTimestamp: 2022-06-23 07:54:07.117 +0000 UTC\nTimestamp: 2022-06-23 07:54:07.117 +0000 UTC\nCount: 28860\nSum: 1863.804910\nExplicitBounds #0: 0.100000\nExplicitBounds #1: 0.200000\nExplicitBounds #2: 0.400000\nExplicitBounds #3: 1.000000\nExplicitBounds #4: 3.000000\nExplicitBounds #5: 8.000000\nExplicitBounds #6: 20.000000\nExplicitBounds #7: 60.000000\nExplicitBounds #8: 120.000000\nBuckets #0, Count: 25547\nBuckets #1, Count: 1141\nBuckets #2, Count: 1072\nBuckets #3, Count: 881\nBuckets #4, Count: 141\nBuckets #5, Count: 62\nBuckets #6, Count: 11\nBuckets #7, Count: 5\nBuckets #8, Count: 0\nBuckets #9, Count: 0\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5728OpenTelemetry\u4e2d\u521b\u5efa\u4e86\u4e00\u4e2aHistogram\uff0c\u4f46\u6709\u4e00\u70b9\u6211\u4eec\u4e0d\u80fd\u505a\u7684\u662f\u5305\u62ec\u6700\u5c0f\u503c\u548c\u6700\u5927\u503c\uff08OpenTelemetry\u652f\u6301\uff0c\u4f46Prometheus\u4e0d\u652f\u6301\uff09\u3002</p>"},{"location":"chap13/2Prometheus_opentele/#summaries","title":"Summaries","text":"<p>Prometheus\u7684summary\u6570\u636e\u5982\u4e0b\uff1a</p> <pre><code>HELP prometheus_rule_evaluation_duration_seconds The duration for a rule to execute.\nTYPE prometheus_rule_evaluation_duration_seconds summary\nprometheus_rule_evaluation_duration_seconds{quantile=\"0.5\"} 6.4853e-05\nprometheus_rule_evaluation_duration_seconds{quantile=\"0.9\"} 0.00010102\nprometheus_rule_evaluation_duration_seconds{quantile=\"0.99\"} 0.000177367\nprometheus_rule_evaluation_duration_seconds_sum 1.623860968846092e+06\nprometheus_rule_evaluation_duration_seconds_count 1.112293682e+09\n</code></pre> <p>\u5728OpenTelemetry\u7684\u65e5\u5fd7Exporter\u4e2d\u4f1a\u4ee5\u5982\u4e0b\u683c\u5f0f\u8868\u793a\uff1a</p> <pre><code>Metric #3\nDescriptor:\n -&gt; Name: prometheus_rule_evaluation_duration_seconds\n -&gt; Description: The duration for a rule to execute.\n -&gt; Unit:\n -&gt; DataType: Summary\nSummaryDataPoints #0\nStartTimestamp: 2022-06-23 07:50:22.117 +0000 UTC\nTimestamp: 2022-06-23 07:50:22.117 +0000 UTC\nCount: 1112293682\nSum: 1623860.968846\nQuantileValue #0: Quantile 0.500000, Value 0.000065\nQuantileValue #1: Quantile 0.900000, Value 0.000101\nQuantileValue #2: Quantile 0.990000, Value 0.000177\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u9009\u62e9\u4e86OpenTelemetry Summary\u6307\u6807\u7c7b\u578b\u2014\u2014\u8bb0\u4f4f\u8fd9\u662f\u4e3aPrometheus\u96c6\u6210\u660e\u786e\u521b\u5efa\u7684\uff0c\u4e0d\u5e94\u8be5\u5728\u5176\u4ed6\u5730\u65b9\u4f7f\u7528\u3002\u5b83\u7c7b\u4f3c\u4e8e\u76f4\u65b9\u56fe\u7684\u8f93\u51fa\uff0c\u4f46\u662f\u5217\u51fa\u4e86\u767e\u5206\u4f4d\uff0c\u800c\u4e0d\u662f\u660e\u786e\u7684\u6876\u548c\u6876\u8ba1\u6570\u3002</p>"},{"location":"chap13/2Prometheus_opentele/#6-opentelemetryprometheus","title":"6 \u5c06OpenTelemetry\u8f6c\u6362\u6210Prometheus","text":"<p>\u4f7f\u7528Prometheus Exporter\u5141\u8bb8\u6293\u53d6\uff0c\u6216\u8005\u4f7f\u7528Prometheus Remote Write Exporter\u76f4\u63a5\u63a8\u9001\u5230\u53e6\u4e00\u4e2aPrometheus\u5b9e\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u6307\u6807\u4eceOpenTelemetry\u53d1\u9001\u5230Prometheus\u3002\u8fd9\u65b9\u9762\u6ca1\u6709\u4efb\u4f55\u610f\u5916\uff1a\u5982\u679c\u8f6c\u6362\u88ab\u652f\u6301\uff0c\u5b83\u7684\u53d1\u751f\u4e0d\u4f1a\u6709\u4efb\u4f55\u7cbe\u5ea6\u7684\u635f\u5931\u3002</p> <p>\u9700\u8981\u8bb0\u4f4f\u7684\u4e00\u70b9\u662f\uff0c\u6709\u4e00\u4e9bOpenTelemetry\u6307\u6807\u7684\u914d\u7f6e\uff0c\u6211\u4eec\u4e0d\u80fd\u76f4\u63a5\u8f6c\u5316\u4e3aPrometheus\u6307\u6807\uff0c\u56e0\u4e3aPrometheus\u6709\u4e00\u4e2a\u66f4\u53d7\u7ea6\u675f\u7684\u6a21\u578b\u3002</p> <p>\u4efb\u4f55AggregationTemporality\u4e3aDELTA\u7684\u6307\u6807\u5c06\u88abPrometheus Exporter\u8f6c\u6362\u56deCUMULATIVE\uff08\u5e76\u4e14\u5c06\u88abPrometheus Remote Write Exporter\u62d2\u7edd\uff09\u3002Prometheus Remote Write Exporter\u4e5f\u4f1a\u62d2\u7eddSummary\u548cHistogram\u6307\u6807\uff0c\u4f46\u8fd9\u4e9b\u6307\u6807\u7531Prometheus Exporter\u5b8c\u7f8e\u7ba1\u7406\u3002 \u5e26\u6709\u6574\u6570\u503c\u7684OpenTelemetry\u6307\u6807\u5c06\u88ab\u8f6c\u6362\u4e3a\u6d6e\u70b9\u6570\u3002</p> <p>\u4f8b\u5982\uff0c\u4ecePrometheus Exporter\uff08\u5f53\u4ee5\u4e0a\u90e8\u5206\u7684\u6240\u6709\u4f8b\u5b50\u90fd\u88ab\u6d88\u8d39\u540e\uff09\u8fdb\u884c\u7684\u6293\u53d6\u4f1a\u4ea7\u751f\u4ee5\u4e0b\u7ed3\u679c\u3002\u4f60\u4f1a\u770b\u5230\uff0c\u6bcf\u4e2a\u503c\u90fd\u4e0e\u524d\u9762\u51e0\u8282\u4e2d\u8f93\u5165\u7684Prometheus\u503c\u5b8c\u5168\u76f8\u540c\uff0c\u6ca1\u6709\u4efb\u4f55\u4fdd\u771f\u5ea6\u7684\u635f\u5931\u3002</p> <pre><code>HELP http_request_duration_seconds Histogram of latencies for HTTP requests.\nTYPE http_request_duration_seconds histogram\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"0.1\"} 25547\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"0.2\"} 26688\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"0.4\"} 27760\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"1\"} 28641\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"3\"} 28782\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"8\"} 28844\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"20\"} 28855\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"60\"} 28860\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"120\"} 28860\nhttp_request_duration_seconds_bucket{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",le=\"+Inf\"} 28860\nhttp_request_duration_seconds_sum{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\"} 1863.80491025699\nhttp_request_duration_seconds_count{handler=\"/\",instance=\"127.0.0.1:9100\",job=\"node-exporter\"} 28860\nHELP http_requests_total Total HTTP requests served\nTYPE http_requests_total counter\nhttp_requests_total{code=\"200\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",method=\"post\"} 907\nhttp_requests_total{code=\"400\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",method=\"post\"} 5\nHELP node_filesystem_avail_bytes Available bytes in filesystems\nTYPE node_filesystem_avail_bytes gauge\nnode_filesystem_avail_bytes{fstype=\"ext4\",instance=\"127.0.0.1:9100\",job=\"node-exporter\",method=\"/data\"} 250294\nHELP prometheus_rule_evaluation_duration_seconds The duration for a rule to execute.\nTYPE prometheus_rule_evaluation_duration_seconds summary\nprometheus_rule_evaluation_duration_seconds{instance=\"127.0.0.1:9100\",job=\"node-exporter\",quantile=\"0.5\"} 6.4853e-05\nprometheus_rule_evaluation_duration_seconds{instance=\"127.0.0.1:9100\",job=\"node-exporter\",quantile=\"0.9\"} 0.00010102\nprometheus_rule_evaluation_duration_seconds{instance=\"127.0.0.1:9100\",job=\"node-exporter\",quantile=\"0.99\"} 0.000177367\nprometheus_rule_evaluation_duration_seconds_sum{instance=\"127.0.0.1:9100\",job=\"node-exporter\"} 1.623860968846092e+06\nprometheus_rule_evaluation_duration_seconds_count{instance=\"127.0.0.1:9100\",job=\"node-exporter\"} 1.112293682e+09\nHELP scrape_duration_seconds Duration of the scrape\nTYPE scrape_duration_seconds gauge\nscrape_duration_seconds{instance=\"127.0.0.1:9100\",job=\"node-exporter\"} 0.003231334\nHELP scrape_samples_post_metric_relabeling The number of samples remaining after metric relabeling was applied\nTYPE scrape_samples_post_metric_relabeling gauge\nscrape_samples_post_metric_relabeling{instance=\"127.0.0.1:9100\",job=\"node-exporter\"} 20\nHELP scrape_samples_scraped The number of samples the target exposed\nTYPE scrape_samples_scraped gauge\nscrape_samples_scraped{instance=\"127.0.0.1:9100\",job=\"node-exporter\"} 20\nHELP scrape_series_added The approximate number of new series in this scrape\nTYPE scrape_series_added gauge\nscrape_series_added{instance=\"127.0.0.1:9100\",job=\"node-exporter\"} 20\nHELP up The scraping was successful\nTYPE up gauge\nup{instance=\"127.0.0.1:9100\",job=\"node-exporter\"} 1\n</code></pre> <p>\u5f53\u8f6c\u6362\u5230Prometheus\u65f6\uff0c\u8bf7\u8bb0\u4f4f\u6211\u4eec\u76ee\u524d\u53ea\u6709\u4e24\u79cd\u9009\u62e9\uff1a</p> <ul> <li>\u4e00\u79cd\u662f\u4f7f\u7528Prometheus Exporter\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u6240\u6709\u7684\u6570\u636e\u90fd\u4ee5\u5355\u4e00\u7684\u6293\u53d6\u7684\u65b9\u5f0f\u66b4\u9732\u51fa\u6765\uff0c\u5982\u679c\u4f60\u6709\u5927\u91cf\u7684\u5e8f\u5217\uff0c\u5c31\u4e0d\u80fd\u5f88\u597d\u5730\u6269\u5c55\u3002</li> <li>\u7b2c\u4e8c\u4e2a\u9009\u9879\u662f\u4f7f\u7528Prometheus Remote Write Exporter\uff0c\u6211\u4eec\u5e0c\u671b\u5b83\u6709\u66f4\u597d\u7684\u6269\u5c55\u6027\uff0c\u4f46\u4ec5\u9650\u4e8eCounter\u548cGauge\uff0c\u5e76\u4e14\u4e0d\u4f1a\u8fdb\u884cDELTA\u5230CUMULATIVE\u7684\u8f6c\u6362\uff08\u5b83\u5c06\u4e22\u5f03\u8fd9\u4e9b\u6307\u6807\uff09\u3002</li> </ul>"},{"location":"chap13/2Prometheus_opentele/#7","title":"7  \u51b3\u5b9a\u65f6\u523b","text":"<p>\u603b\u7ed3\u4e00\u4e0b\uff0cPrometheus\u548cOpenTelemetry\u63d0\u4f9b\u7684\u6307\u6807\u5b9e\u73b0\u7684\u89d2\u5ea6\u7565\u6709\u4e0d\u540c\u3002Prometheus\u662f\u4e8b\u5b9e\u4e0a\u7684\u6807\u51c6\uff0c\u6db5\u76d6\u4e86\u6307\u6807\u7684\u521b\u5efa\u3001\u5b58\u50a8\u548c\u67e5\u8be2\uff0c\u800cOpenTelemetry\u6bd4\u8f83\u65b0\uff0c\u53ea\u6db5\u76d6\u6307\u6807\u7684\u751f\u6210\u3002\u4e0d\u8fc7\uff0c\u5b83\u4e5f\u652f\u6301\u4f7f\u7528\u76f8\u540c\u7684SDK\u8fdb\u884c\u8ddf\u8e2a\u548c\u8bb0\u5f55\u3002</p> <p>\u4f60\u4e3b\u8981\u53ef\u4ee5\u5728\u4e24\u8005\u4e4b\u95f4\u8fdb\u884c\u8f6c\u6362\uff0c\u800c\u4e0d\u4f1a\u6709\u4efb\u4f55\u7cbe\u5ea6\u4e0a\u7684\u635f\u5931\u2014\u2014\u4f46\u662f\u4f60\u8981\u77e5\u9053\uff0c\u6709\u4e9b\u6307\u6807\u7c7b\u578b\u4f1a\u6709\u8f7b\u5fae\u7684\u53d8\u5316\u3002</p> <p>\u4f8b\u5982\uff0c\u6240\u6709OpenTelemetry\u7684DELTA\u6307\u6807\u5728\u5bfc\u51fa\u4e3aPrometheus\u6307\u6807\u4e4b\u524d\u5c06\u88ab\u8f6c\u6362\u4e3aCUMULATIVE\uff0c\u800c\u4e14Prometheus\u5728\u589e\u52a0\u652f\u6301\u4e4b\u524d\u4e0d\u80fd\u8868\u793aOpenTelemetry\u7684\u6307\u6570\u76f4\u65b9\u56fe</p> <p>Prometheus\u4f1a\u7ed9\u4f60\u4e00\u4e2a\u4e45\u7ecf\u8003\u9a8c\u7684\u7cfb\u7edf\u3002\u800cOpenTelemetry\uff0c\u5219\u662f\u4e00\u4e2a\u66f4\u5e7f\u6cdb\u548c\u7075\u6d3b\u7684\u6807\u51c6\u3002</p>"},{"location":"chap13/3Prometheus_index/","title":"L3 Prometheus\u7684\u56db\u79cd\u6307\u6807\u7c7b\u578b","text":"<p>\u6307\u6807\u662f\u7528\u6765\u8861\u91cf\u6027\u80fd\u3001\u6d88\u8017\u3001\u6548\u7387\u548c\u8bb8\u591a\u5176\u4ed6\u8f6f\u4ef6\u5c5e\u6027\u968f\u65f6\u95f4\u7684\u53d8\u5316\u8d8b\u52bf\u3002\u5b83\u4eec\u5141\u8bb8\u5de5\u7a0b\u5e08\u901a\u8fc7\u8b66\u62a5\u548c\u4eea\u8868\u76d8\u6765\u76d1\u63a7\u4e00\u7cfb\u5217\u6d4b\u91cf\u503c\u7684\u6f14\u53d8\uff08\u5982CPU\u6216\u5185\u5b58\u4f7f\u7528\u91cf\u3001\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u3001\u5ef6\u8fdf\u7b49\uff09\u3002</p> <p>\u5728\u5176\u6700\u57fa\u672c\u7684\u5f62\u5f0f\u4e2d\uff0c\u4e00\u4e2a\u6307\u6807\u6570\u636e\u70b9\u662f\u7531\u4ee5\u4e0b\u4e09\u4e2a\u90e8\u5206\u6784\u6210\uff1a</p> <ul> <li>\u4e00\u4e2a\u6307\u6807\u540d\u79f0</li> <li>\u6536\u96c6\u8be5\u6570\u636e\u70b9\u7684\u65f6\u95f4\u6233</li> <li>\u4e00\u4e2a\u7531\u6570\u5b57\u8868\u793a\u7684\u6d4b\u91cf\u503c</li> </ul> <p>\u5728\u8fc7\u53bb\u7684\u5341\u5e74\u91cc\uff0c\u968f\u7740\u7cfb\u7edf\u53d8\u5f97\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u51fa\u73b0\u4e86\u7ef4\u5ea6\u5ea6\u91cf\u7684\u6982\u5ff5\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5ea6\u91cf\u8fd8\u5305\u62ec\u4e00\u7ec4\u6807\u7b7e\u6216\u6807\u8bc6\uff08\u5373\u7ef4\u5ea6\uff09\uff0c\u4ee5\u63d0\u4f9b\u989d\u5916\u7684\u4e0a\u4e0b\u6587\u3002\u652f\u6301\u7ef4\u5ea6\u6307\u6807\u7684\u76d1\u63a7\u7cfb\u7edf\u5141\u8bb8\u5de5\u7a0b\u5e08\u901a\u8fc7\u67e5\u8be2\u7279\u5b9a\u7684\u6307\u6807\u540d\u79f0\uff0c\u5e76\u901a\u8fc7\u6807\u7b7e\u8fdb\u884c\u8fc7\u6ee4\u548c\u5206\u7ec4\uff0c\u4ece\u800c\u8f7b\u6613\u5730\u5728\u591a\u4e2a\u7ec4\u4ef6\u548c\u7ef4\u5ea6\u4e0a\u6c47\u603b\u548c\u5206\u6790\u4e00\u4e2a\u6307\u6807\u3002</p> <p>Prometheus\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5ea6\u91cf\u8bf4\u660e\u683c\u5f0f\u548c\u4e00\u4e2a\u8fdc\u7a0b\u5199\u5165\u534f\u8bae\uff0c\u793e\u533a\u548c\u8bb8\u591a\u4f9b\u5e94\u5546\u90fd\u91c7\u7528\u8fd9\u4e2a\u534f\u8bae\u6765\u8bf4\u660e\u548c\u6536\u96c6\u5ea6\u91cf\u6210\u4e3a\u4e8b\u5b9e\u4e0a\u7684\u6807\u51c6\u3002</p> <p>OpenMetrics\u662f\u53e6\u4e00\u4e2aCNCF\u9879\u76ee\uff0c\u5b83\u5efa\u7acb\u5728Prometheus\u5bfc\u51fa\u683c\u5f0f\u7684\u57fa\u7840\u4e0a\uff0c\u4e3a\u6536\u96c6\u5ea6\u91cf\u6807\u51c6\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4e0e\u5382\u5546\u65e0\u5173\u7684\u6807\u51c6\u5316\u6a21\u578b\uff0c\u65e8\u5728\u6210\u4e3a\u4e92\u8054\u7f51\u5de5\u7a0b\u4efb\u52a1\u7ec4\uff08IEFT\uff09\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u6700\u8fd1\uff0c\u53e6\u4e00\u4e2aCNCF\u9879\u76eeOpenTelemetry\u51fa\u73b0\u4e86\uff0c\u5b83\u7684\u76ee\u6807\u662f\u63d0\u4f9b\u4e00\u4e2a\u65b0\u7684\u6807\u51c6\uff0c\u80fd\u591f\u7edf\u4e00\u6307\u6807\u3001\u94fe\u8def\u8ddf\u8e2a\u548c\u65e5\u5fd7\u7684\u6536\u96c6\uff0c\u4f7f\u8de8\u9886\u57df\u7684\u9065\u6d4b\u4fe1\u53f7\u6536\u96c6\u548c\u5173\u8054\u66f4\u5bb9\u6613\u3002</p>"},{"location":"chap13/3Prometheus_index/#prometheus","title":"Prometheus\u6307\u6807","text":"<p>\u9996\u5148\u8981\u505a\u7684\u4e8b\u3002Prometheus\u6536\u96c6\u7684\u6307\u6807\u6709\u56db\u79cd\uff0c\u4f5c\u4e3a\u5176\u66b4\u9732\u683c\u5f0f\u7684\u4e00\u90e8\u5206\u3002</p> <ul> <li>Counters</li> <li>Gauges</li> <li>Histograms</li> <li>Summaries</li> </ul> <p>Prometheus\u4f7f\u7528\u62c9\u53d6\u6a21\u578b\u6765\u6536\u96c6\u8fd9\u4e9b\u6307\u6807\uff1b\u4e5f\u5c31\u662f\u8bf4\uff0cPrometheus\u4e3b\u52a8\u6293\u53d6\u66b4\u9732\u6307\u6807\u7684HTTP\u7aef\u70b9\u3002</p> <p>\u8fd9\u4e9b\u7aef\u70b9\u53ef\u4ee5\u662f\u7531\u88ab\u76d1\u63a7\u7684\u7ec4\u4ef6\u81ea\u7136\u66b4\u9732\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u793e\u533a\u5efa\u7acb\u7684\u6570\u767e\u4e2aPrometheus\u5bfc\u51fa\u5668\u4e4b\u4e00\u66b4\u9732\u51fa\u6765\u3002Prometheus\u63d0\u4f9b\u4e86\u4e0d\u540c\u7f16\u7a0b\u8bed\u8a00\u7684\u5ba2\u6237\u7aef\u5e93\uff0c\u4f60\u53ef\u4ee5\u7528\u5b83\u6765\u76d1\u63a7\u4f60\u7684\u4ee3\u7801</p> <p>\u7531\u4e8e\u670d\u52a1\u53d1\u73b0\u673a\u5236\u548c\u96c6\u7fa4\u5185\u7684\u5171\u4eab\u7f51\u7edc\u8bbf\u95ee\uff0c\u62c9\u53d6\u6a21\u578b\u5728\u76d1\u63a7Kubernetes\u96c6\u7fa4\u65f6\u6548\u679c\u5f88\u597d\uff0c\u4f46\u7528Prometheus\u76d1\u63a7\u52a8\u6001\u7684\u865a\u62df\u673a\u96c6\u7fa4\u3001AWS Fargate\u5bb9\u5668\u6216Lambda\u51fd\u6570\u5c31\u6bd4\u8f83\u56f0\u96be\u4e86\u3002</p> <p>\u4e3a\u4ec0\u4e48\u5462\uff1f\u4e3b\u8981\u539f\u56e0\u662f\u4ea4\u6613\u786e\u5b9a\u8981\u6293\u53d6\u7684\u6307\u6807\u7aef\u70b9\uff0c\u800c\u4e14\u5bf9\u8fd9\u4e9b\u7aef\u70b9\u7684\u8bbf\u95ee\u53ef\u80fd\u53d7\u5230\u7f51\u7edc\u5b89\u5168\u7b56\u7565\u7684\u9650\u5236\u3002\u4e3a\u4e86\u89e3\u51b3\u5176\u4e2d\u7684\u4e00\u4e9b\u95ee\u9898\uff0c\u793e\u533a\u57282021\u5e74\u5e95\u53d1\u5e03\u4e86Prometheus Agent Mode\uff0c\u5b83\u53ea\u6536\u96c6\u6307\u6807\u5e76\u4f7f\u7528\u8fdc\u7a0b\u5199\u5165\u534f\u8bae\u5c06\u5176\u53d1\u9001\u5230\u76d1\u63a7\u540e\u7aef\u3002</p> <p>Prometheus\u53ef\u4ee5\u6293\u53d6Prometheus\u66b4\u9732\u683c\u5f0f\u548cOpenMetrics\u683c\u5f0f\u7684\u6307\u6807\u3002\u5728\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u6307\u6807\u901a\u8fc7HTTP\u63a5\u53e3\u66b4\u9732\uff0c\u4f7f\u7528\u7b80\u5355\u7684\u57fa\u4e8e\u6587\u672c\u7684\u683c\u5f0f\uff08\u66f4\u5e38\u7528\u548c\u5e7f\u6cdb\u652f\u6301\uff09\u6216\u66f4\u6709\u6548\u548c\u5f3a\u5927\u7684Protobuf\u683c\u5f0f\u3002\u6587\u672c\u683c\u5f0f\u7684\u4e00\u5927\u4f18\u52bf\u662f\u5b83\u7684\u53ef\u8bfb\u6027\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u5b83\u6216\u4f7f\u7528\u50cfcurl\u8fd9\u6837\u7684\u5de5\u5177\u6765\u68c0\u7d22\u5f53\u524d\u66b4\u9732\u7684\u6307\u6807\u96c6\u3002</p> <p>Prometheus\u4f7f\u7528\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u6307\u6807\u6a21\u578b\uff0c\u6709\u56db\u79cd\u6307\u6807\u7c7b\u578b\uff0c\u53ea\u5728\u5ba2\u6237\u7aefSDK\u4e2d\u652f\u6301\u3002\u6240\u6709\u7684\u6307\u6807\u7c7b\u578b\u90fd\u662f\u7528\u4e00\u79cd\u6570\u636e\u7c7b\u578b\u6216\u7531\u591a\u4e2a\u5355\u4e00\u6570\u636e\u7c7b\u578b\u7684\u7ec4\u5408\u5728\u66b4\u9732\u683c\u5f0f\u4e2d\u8868\u793a\u3002\u8fd9\u4e2a\u6570\u636e\u7c7b\u578b\u5305\u62ec\u4e00\u4e2a\u6307\u6807\u540d\u79f0\u3001\u4e00\u7ec4\u6807\u7b7e\u548c\u4e00\u4e2a\u6d6e\u70b9\u6570\u3002\u65f6\u95f4\u6233\u662f\u7531\u76d1\u63a7\u540e\u7aef\uff08\u4f8b\u5982Prometheus\uff09\u6216\u4ee3\u7406\u5728\u6293\u53d6\u6307\u6807\u65f6\u6dfb\u52a0\u7684\u3002</p> <p>\u6307\u6807\u540d\u79f0\u548c\u6807\u7b7e\u96c6\u7684\u6bcf\u4e2a\u552f\u4e00\u7ec4\u5408\u5b9a\u4e49\u4e86\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\uff0c\u800c\u6bcf\u4e2a\u65f6\u95f4\u6233\u548c\u6d6e\u70b9\u6570\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7cfb\u5217\u4e2d\u7684\u6837\u672c\uff08\u5373\u4e00\u4e2a\u6570\u636e\u70b9\uff09\u3002</p> <p>\u4e00\u4e9b\u60ef\u4f8b\u88ab\u7528\u6765\u8868\u793a\u4e0d\u540c\u7684\u5ea6\u91cf\u7c7b\u578b\u3002</p> <p>Prometheus\u66b4\u9732\u683c\u5f0f\u7684\u4e00\u4e2a\u975e\u5e38\u6709\u7528\u7684\u7279\u70b9\u662f\u80fd\u591f\u5c06\u5143\u6570\u636e\u4e0e\u5ea6\u91cf\u76f8\u5173\u8054\uff0c\u4ee5\u5b9a\u4e49\u5176\u7c7b\u578b\u5e76\u63d0\u4f9b\u63cf\u8ff0\u3002\u4f8b\u5982\uff0cPrometheus\u63d0\u4f9b\u4e86\u8fd9\u4e9b\u4fe1\u606f\uff0cGrafana\u5229\u7528\u8fd9\u4e9b\u4fe1\u606f\u5411\u7528\u6237\u663e\u793a\u989d\u5916\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u5e2e\u52a9\u4ed6\u4eec\u9009\u62e9\u6b63\u786e\u7684\u5ea6\u91cf\u5e76\u5e94\u7528\u6b63\u786e\u7684PromQL\u51fd\u6570\u3002</p> <p></p> <p>Grafana\u4e2d\u7684\u6307\u6807\u6d4f\u89c8\u5668\u663e\u793aPrometheus\u6307\u6807\u7684\u5217\u8868\uff0c\u5e76\u663e\u793a\u6709\u5173\u8fd9\u4e9b\u6307\u6807\u7684\u989d\u5916\u80cc\u666f\u3002</p> <p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u901a\u8fc7Prometheus\u66b4\u9732\u683c\u5f0f\u66b4\u9732\u7684\u6307\u6807\u7684\u6848\u4f8b\u3002</p> <pre><code># HELP http_requests_total Total number of http api requests\n# TYPE http_requests_total counter\nhttp_requests_total{api=\"add_product\"} 4633433\n\n# HELP\u7528\u6765\u4e3a\u6307\u6807\u63d0\u4f9b\u63cf\u8ff0\uff0c# TYPE\u4e3a\u6307\u6807\u63d0\u4f9b\u7c7b\u578b\u3002\n</code></pre> <p>\u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u6765\u66f4\u8be6\u7ec6\u5730\u4ecb\u7ecd\u4e00\u4e0b\u6bcf\u4e2aPrometheus\u6307\u6807\u7c7b\u578b\u3002</p>"},{"location":"chap13/3Prometheus_index/#counter","title":"\u8ba1\u6570\u5668\uff08Counter\uff09","text":"<p>Counter\u7c7b\u578b\u6307\u6807\u88ab\u7528\u4e8e\u5355\u8c03\u589e\u52a0\u7684\u6d4b\u91cf\u7ed3\u679c\u3002\u56e0\u6b64\u5b83\u4eec\u603b\u662f\u7d2f\u79ef\u7684\u6570\u503c\uff0c\u503c\u53ea\u80fd\u4e0a\u5347\u3002\u552f\u4e00\u7684\u4f8b\u5916\u662fCounter\u91cd\u542f\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5b83\u7684\u503c\u4f1a\u88ab\u91cd\u7f6e\u4e3a\u96f6\u3002</p> <p>Counter\u7684\u5b9e\u9645\u503c\u901a\u5e38\u672c\u8eab\u5e76\u4e0d\u5341\u5206\u6709\u7528\u3002\u4e00\u4e2a\u8ba1\u6570\u5668\u7684\u503c\u7ecf\u5e38\u88ab\u7528\u6765\u8ba1\u7b97\u4e24\u4e2a\u65f6\u95f4\u6233\u4e4b\u95f4\u7684delta\u6216\u8005\u968f\u65f6\u95f4\u53d8\u5316\u7684\u901f\u7387\u3002</p> <p>\u4f8b\u5982\uff0cCounter\u7684\u4e00\u4e2a\u5178\u578b\u7528\u4f8b\u662f\u8bb0\u5f55API\u8c03\u7528\u6b21\u6570\uff0c\u8fd9\u662f\u4e00\u4e2a\u603b\u662f\u4f1a\u589e\u52a0\u7684\u6d4b\u91cf\u503c\u3002</p> <pre><code># HELP http_requests_total Total number of http api requests\n# TYPE http_requests_total counter\nhttp_requests_total{api=\"add_product\"} 4633433\n</code></pre> <p>\u6307\u6807\u540d\u79f0\u662f<code>http_requests_total</code>\uff0c\u5b83\u6709\u4e00\u4e2a\u540d\u4e3aapi\u7684\u6807\u7b7e\uff0c\u503c\u4e3a<code>add_product</code>\uff0cCounter\u7684\u503c\u4e3a4633433\u3002</p> <p>\u8fd9\u610f\u5473\u7740\u81ea\u4ece\u4e0a\u6b21\u670d\u52a1\u542f\u52a8\u6216Counter\u91cd\u7f6e\u4ee5\u6765\uff0c<code>add_product</code>\u7684API\u5df2\u7ecf\u88ab\u8c03\u7528\u4e864633433\u6b21\u3002\u6309\u7167\u60ef\u4f8b\uff0cCounter\u7c7b\u578b\u7684\u6307\u6807\u901a\u5e38\u4ee5<code>_total</code>\u4e3a\u540e\u7f00\u3002</p> <p>\u8fd9\u4e2a\u7edd\u5bf9\u6570\u5b57\u5e76\u6ca1\u6709\u7ed9\u6211\u4eec\u63d0\u4f9b\u591a\u5c11\u4fe1\u606f\uff0c\u4f46\u5f53\u4e0ePromQL\u7684rate\u51fd\u6570\uff08\u6216\u5176\u4ed6\u76d1\u63a7\u540e\u7aef\u7684\u7c7b\u4f3c\u51fd\u6570\uff09\u4e00\u8d77\u4f7f\u7528\u65f6\uff0c\u5b83\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u8be5API\u6bcf\u79d2\u6536\u5230\u7684\u8bf7\u6c42\u6570\u3002\u4e0b\u9762\u7684PromQL\u67e5\u8be2\u8ba1\u7b97\u4e86\u8fc7\u53bb5\u5206\u949f\u5185\u6bcf\u79d2\u7684\u5e73\u5747\u8bf7\u6c42\u6570\u3002</p> <pre><code>rate(http_requests_total{api=\"add_product\"}[5m])\n</code></pre> <p>\u4e3a\u4e86\u8ba1\u7b97\u4e00\u6bb5\u65f6\u671f\u5185\u7684\u7edd\u5bf9\u53d8\u5316\uff0c\u6211\u4eec\u5c06\u4f7f\u7528delta\u51fd\u6570\uff0c\u5728PromQL\u4e2d\u79f0\u4e3aincreate()\uff1a</p> <pre><code>increase(http_requests_total{api=\"add_product\"}[5m])\n</code></pre> <p>\u8fd9\u5c06\u8fd4\u56de\u8fc7\u53bb5\u5206\u949f\u5185\u7684\u603b\u8bf7\u6c42\u6570\uff0c\u8fd9\u76f8\u5f53\u4e8e\u7528\u6bcf\u79d2\u7684\u901f\u7387\u4e58\u4ee5\u95f4\u9694\u65f6\u95f4\u7684\u79d2\u6570\uff08\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\u662f5\u5206\u949f\uff09\uff1a</p> <pre><code>rate(http_requests_total{api=\"add_product\"}[5m]) * 5 * 60\n</code></pre> <p>\u5176\u4ed6\u4f60\u53ef\u80fd\u4f1a\u4f7f\u7528Counter\u7c7b\u578b\u6307\u6807\u7684\u4f8b\u5b50\uff1a\u6d4b\u91cf\u7535\u5b50\u5546\u52a1\u7f51\u7ad9\u7684\u8ba2\u5355\u6570\u91cf\uff0c\u5728\u7f51\u7edc\u63a5\u53e3\u4e0a\u53d1\u9001\u548c\u63a5\u6536\u7684\u5b57\u8282\u6570\uff0c\u6216\u8005\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u9519\u8bef\u6570\u91cf\u3002</p> <p>\u5982\u679c\u5b83\u662f\u4e00\u4e2a\u4f1a\u4e00\u76f4\u4e0a\u5347\u7684\u6307\u6807\uff0c\u90a3\u4e48\u5c31\u4f7f\u7528\u4e00\u4e2aCounter\u3002</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff0c\u8bf4\u660e\u5982\u4f55\u4f7f\u7528Prometheus\u5ba2\u6237\u7aef\u5e93\u5728Python\u4e2d\u521b\u5efa\u548c\u589e\u52a0\u4e00\u4e2a\u8ba1\u6570\u5668\u6307\u6807\uff1a</p> <pre><code>from prometheus_client import Counter\napi_requests_counter = Counter(\n                        'http_requests_total',\n                        'Total number of http api requests',\n                        ['api']\n                       )\napi_requests_counter.labels(api='add_product').inc()\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7531\u4e8eCounter\u53ef\u4ee5\u88ab\u91cd\u7f6e\u4e3a\u96f6\uff0c\u4f60\u8981\u786e\u4fdd\u4f60\u7528\u6765\u5b58\u50a8\u548c\u67e5\u8be2\u6307\u6807\u7684\u540e\u7aef\u80fd\u591f\u652f\u6301\u8fd9\u79cd\u60c5\u51b5\uff0c\u5e76\u4e14\u5728Counter\u91cd\u542f\u7684\u60c5\u51b5\u4e0b\u4ecd\u7136\u63d0\u4f9b\u51c6\u786e\u7684\u7ed3\u679c\u3002Prometheus\u548c\u517c\u5bb9PromQL\u7684Prometheus\u8fdc\u7a0b\u5b58\u50a8\u7cfb\u7edf\uff0c\u5982Promscale\uff0c\u53ef\u4ee5\u6b63\u786e\u5904\u7406Counter\u91cd\u542f\u3002</p>"},{"location":"chap13/3Prometheus_index/#gauge","title":"\u4eea\u8868\uff08Gauge\uff09","text":"<p>Gauge\u6307\u6807\u7528\u4e8e\u53ef\u4ee5\u4efb\u610f\u589e\u52a0\u6216\u51cf\u5c11\u7684\u6d4b\u91cf\u3002</p> <p>\u8fd9\u662f\u4f60\u53ef\u80fd\u66f4\u719f\u6089\u7684\u6307\u6807\u7c7b\u578b\uff0c\u56e0\u4e3a\u5373\u4f7f\u6ca1\u6709\u7ecf\u8fc7\u989d\u5916\u5904\u7406\u7684\u5b9e\u9645\u503c\u4e5f\u662f\u6709\u610f\u4e49\u7684\uff0c\u5b83\u4eec\u7ecf\u5e38\u88ab\u4f7f\u7528\u5230\u3002\u4f8b\u5982\uff0c\u6d4b\u91cf\u6e29\u5ea6\u3001CPU\u548c\u5185\u5b58\u4f7f\u7528\u7684\u6307\u6807\uff0c\u6216\u8005\u961f\u5217\u7684\u5927\u5c0f\u90fd\u662fGauge\u3002</p> <p>\u4f8b\u5982\uff0c\u4e3a\u4e86\u6d4b\u91cf\u4e00\u53f0\u4e3b\u673a\u7684\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2aGauge\u6307\u6807\uff0c\u6bd4\u5982\uff1a</p> <pre><code># HELP node_memory_used_bytes Total memory used in the node in bytes\n# TYPE node_memory_used_bytes gauge\nnode_memory_used_bytes{hostname=\"host1.domain.com\"} 943348382\n</code></pre> <p>\u4e0a\u9762\u7684\u6307\u6807\u8868\u660e\uff0c\u5728\u6d4b\u91cf\u65f6\uff0c\u8282\u70b9<code>host1.domain.com</code>\u4f7f\u7528\u7684\u5185\u5b58\u7ea6\u4e3a900 MB\u3002</p> <p>\u8be5\u6307\u6807\u7684\u503c\u662f\u6709\u610f\u4e49\u7684\uff0c\u4e0d\u9700\u8981\u4efb\u4f55\u989d\u5916\u7684\u8ba1\u7b97\uff0c\u56e0\u4e3a\u5b83\u544a\u8bc9\u6211\u4eec\u8be5\u8282\u70b9\u4e0a\u6d88\u8017\u4e86\u591a\u5c11\u5185\u5b58\u3002</p> <p>\u4e0e\u4f7f\u7528Counter\u6307\u6807\u65f6\u4e0d\u540c\uff0crate\u548cdelta\u51fd\u6570\u5bf9Gauge\u6ca1\u6709\u610f\u4e49\u3002\u7136\u800c\uff0c\u8ba1\u7b97\u7279\u5b9a\u65f6\u95f4\u5e8f\u5217\u7684\u5e73\u5747\u6570\u3001\u6700\u5927\u503c\u3001\u6700\u5c0f\u503c\u6216\u767e\u5206\u6bd4\u7684\u51fd\u6570\u7ecf\u5e38\u4e0e<code>Gauge</code>\u4e00\u8d77\u4f7f\u7528\u3002</p> <p>\u5728Prometheus\u4e2d\uff0c\u8fd9\u4e9b\u51fd\u6570\u7684\u540d\u79f0\u662f<code>avg_over_time</code>\u3001<code>max_over_time</code>\u3001<code>min_over_time</code>\u548c<code>quantile_over_time</code>\u3002</p> <p>\u8981\u8ba1\u7b97\u8fc7\u53bb10\u5206\u949f\u5185\u5728host1.domain.com\u4e0a\u4f7f\u7528\u7684\u5e73\u5747\u5185\u5b58\uff0c\u4f60\u53ef\u4ee5\u8fd9\u6837\u505a\uff1a</p> <pre><code>avg_over_time(node_memory_used_bytes{hostname=\"host1.domain.com\"}[10m])\n</code></pre> <p>\u8981\u4f7f\u7528Prometheus\u5ba2\u6237\u7aef\u5e93\u5728Python\u4e2d\u521b\u5efa\u4e00\u4e2aGauge\u6307\u6807\uff0c\u4f60\u53ef\u4ee5\u8fd9\u6837\u505a\uff1a</p> <pre><code>from prometheus_client import Gauge\nmemory_used = Gauge(\n                'node_memory_used_bytes',\n                'Total memory used in the node in bytes',\n                ['hostname']\n              )\nmemory_used.labels(hostname='host1.domain.com').set(943348382)\n</code></pre>"},{"location":"chap13/3Prometheus_index/#histogram","title":"\u76f4\u65b9\u56fe\uff08Histogram\uff09","text":"<p>Histogram\u6307\u6807\u5bf9\u4e8e\u8868\u793a\u6d4b\u91cf\u7684\u5206\u5e03\u5f88\u6709\u7528\u3002\u5b83\u4eec\u7ecf\u5e38\u88ab\u7528\u6765\u6d4b\u91cf\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u6216\u54cd\u5e94\u5927\u5c0f\u3002</p> <p>\u76f4\u65b9\u56fe\u5c06\u6574\u4e2a\u6d4b\u91cf\u8303\u56f4\u5212\u5206\u4e3a\u4e00\u7ec4\u533a\u95f4\uff0c\u79f0\u4e3a\u6876\uff0c\u5e76\u8ba1\u7b97\u6bcf\u4e2a\u6876\u4e2d\u6709\u591a\u5c11\u6d4b\u91cf\u503c\u3002</p> <p>\u4e00\u4e2a\u76f4\u65b9\u56fe\u6307\u6807\u5305\u62ec\u51e0\u4e2a\u9879\u76ee\uff1a</p> <ol> <li>\u4e00\u4e2a\u5305\u542b\u6d4b\u91cf\u6b21\u6570\u7684Counter\u3002\u6307\u6807\u540d\u79f0\u4f7f\u7528<code>_count</code>\u540e\u7f00\u3002</li> <li>\u4e00\u4e2a\u5305\u542b\u6240\u6709\u6d4b\u91cf\u503c\u4e4b\u548c\u7684Counter\u3002\u6307\u6807\u540d\u79f0\u4f7f\u7528<code>_sum</code>\u540e\u7f00\u3002</li> <li>\u76f4\u65b9\u56fe\u6876\u88ab\u66b4\u9732\u4e3a\u4e00\u7cfb\u5217\u7684Counter\uff0c\u4f7f\u7528\u6307\u6807\u540d\u79f0\u7684\u540e\u7f00<code>_bucket</code>\u548c\u8868\u793a\u6876\u7684\u4e0a\u9650\u7684le label\u3002</li> </ol> <p>Prometheus\u4e2d\u7684\u6876\u662f\u5305\u542b\u6876\u7684\u8fb9\u754c\u7684\uff0c\u5373\u4e00\u4e2a\u4e0a\u9650\u4e3aN\u7684\u6876\uff08\u5373le label\uff09\u5305\u62ec\u6240\u6709\u6570\u503c\u5c0f\u4e8e\u6216\u7b49\u4e8eN\u7684\u6570\u636e\u70b9\u3002</p> <p>\u4f8b\u5982\uff0c\u6d4b\u91cf\u8fd0\u884c\u5728<code>host1.domain.com</code>\u5b9e\u4f8b\u4e0a\u7684<code>add_productAPI</code>\u7aef\u70b9\u5b9e\u4f8b\u7684\u54cd\u5e94\u65f6\u95f4\u7684Histogram\u6307\u6807\u53ef\u4ee5\u8868\u793a\u4e3a\uff1a</p> <pre><code># HELP http_request_duration_seconds Api requests response time in seconds\n# TYPE http_request_duration_seconds histogram\nhttp_request_duration_seconds_sum{api=\"add_product\" instance=\"host1.domain.com\"} 8953.332\nhttp_request_duration_seconds_count{api=\"add_product\" instance=\"host1.domain.com\"} 27892\nhttp_request_duration_seconds_bucket{api=\"add_product\" instance=\"host1.domain.com\" le=\"0\"}\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"0.01\"} 0\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"0.025\"} 8\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"0.05\"} 1672\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"0.1\"} 8954\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"0.25\"} 14251\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"0.5\"} 24101\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"1\"} 26351\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"2.5\"} 27534\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"5\"} 27814\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"10\"} 27881\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"25\"} 27890\nhttp_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\", le=\"+Inf\"} 27892\n</code></pre> <p>\u4e0a\u9762\u7684\u4f8b\u5b50\u5305\u62ecsum\u3001counter\u548c12\u4e2a\u6876\u3002sum\u548ccounter\u53ef\u4ee5\u7528\u6765\u8ba1\u7b97\u4e00\u4e2a\u6d4b\u91cf\u503c\u968f\u65f6\u95f4\u53d8\u5316\u7684\u5e73\u5747\u503c\u3002\u5728PromQL\u4e2d\uff0c\u8fc7\u53bb5\u5206\u949f\u7684\u5e73\u5747\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u65b9\u5f0f\u8ba1\u7b97\u5f97\u5230\u3002</p> <pre><code>rate(http_request_duration_seconds_sum{api=\"add_product\", instance=\"host1.domain.com\"}[5m]) / rate(http_request_duration_seconds_count{api=\"add_product\", instance=\"host1.domain.com\"}[5m])\n</code></pre> <p>\u5b83\u4e5f\u53ef\u4ee5\u88ab\u7528\u6765\u8ba1\u7b97\u5404\u65f6\u95f4\u5e8f\u5217\u7684\u5e73\u5747\u6570\u3002\u4e0b\u9762\u7684PromQL\u67e5\u8be2\u5c06\u8ba1\u7b97\u51fa\u6240\u6709API\u548c\u5b9e\u4f8b\u5728\u8fc7\u53bb5\u5206\u949f\u5185\u7684\u5e73\u5747\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4\u3002</p> <pre><code>sum(rate(http_request_duration_seconds_sum[5m])) / sum(rate(http_request_duration_seconds_count[5m]))\n</code></pre> <p>\u5229\u7528Histogram\uff0c\u4f60\u53ef\u4ee5\u5728\u67e5\u8be2\u65f6\u8ba1\u7b97\u5355\u4e2a\u65f6\u95f4\u5e8f\u5217\u4ee5\u53ca\u591a\u4e2a\u65f6\u95f4\u5e8f\u5217\u7684\u767e\u5206\u4f4d\u3002</p> <p>\u5728PromQL\u4e2d\uff0c\u6211\u4eec\u5c06\u4f7f\u7528<code>histogram_quantile</code>\u51fd\u6570\u3002Prometheus\u4f7f\u7528\u5206\u4f4d\u6570\u800c\u4e0d\u662f\u767e\u5206\u4f4d\u6570\u3002\u5b83\u4eec\u672c\u8d28\u4e0a\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u4ee50\u52301\u7684\u6bd4\u4f8b\u8868\u793a\u7684\uff0c\u800c\u767e\u5206\u4f4d\u6570\u662f\u4ee50\u5230100\u7684\u6bd4\u4f8b\u8868\u793a\u7684\u3002</p> <p>\u8981\u8ba1\u7b97\u5728<code>host1.domain.com</code>\u4e0a\u8fd0\u884c\u7684<code>add_product API</code>\u54cd\u5e94\u65f6\u95f4\u7684\u7b2c99\u767e\u5206\u4f4d\u6570\uff080.99\u56db\u5206\u4f4d\u6570\uff09\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8be2\u3002</p> <pre><code>histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{api=\"add_product\", instance=\"host1.domain.com\"}[5m]))\n</code></pre> <p>Histograms\u7684\u4e00\u5927\u4f18\u52bf\u662f\u53ef\u4ee5\u8fdb\u884c\u6c47\u603b\u3002\u4e0b\u9762\u7684\u67e5\u8be2\u8fd4\u56de\u6240\u6709API\u548c\u5b9e\u4f8b\u7684\u54cd\u5e94\u65f6\u95f4\u7684\u7b2c99\u4e2a\u767e\u5206\u70b9\u200d\uff1a</p> <pre><code>histogram_quantile(0.99, sum by (le) (rate(http_request_duration_seconds_bucket[5m])))\n</code></pre> <p>\u5728\u4e91\u539f\u751f\u73af\u5883\u4e2d\uff0c\u901a\u5e38\u6709\u8bb8\u591a\u76f8\u540c\u7ec4\u4ef6\u7684\u591a\u4e2a\u5b9e\u4f8b\u5728\u8fd0\u884c\uff0c\u80fd\u5426\u8de8\u5b9e\u4f8b\u6c47\u603b\u6570\u636e\u662f\u5173\u952e\u3002</p> <p>Histograms\u6709\u4e09\u4e2a\u4e3b\u8981\u7684\u7f3a\u70b9\uff1a</p> <ul> <li>\u9996\u5148\uff0c\u6876\u5fc5\u987b\u662f\u9884\u5b9a\u4e49\u7684\uff0c\u8fd9\u9700\u8981\u4e00\u4e9b\u524d\u671f\u7684\u8bbe\u8ba1\u3002\u5982\u679c\u4f60\u7684\u6876\u6ca1\u6709\u88ab\u5f88\u597d\u5730\u5b9a\u4e49\uff0c\u4f60\u53ef\u80fd\u65e0\u6cd5\u8ba1\u7b97\u51fa\u4f60\u9700\u8981\u7684\u767e\u5206\u6bd4\uff0c\u6216\u8005\u4f1a\u6d88\u8017\u4e0d\u5fc5\u8981\u7684\u8d44\u6e90\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u6709\u4e00\u4e2a\u603b\u662f\u9700\u8981\u8d85\u8fc7\u4e00\u79d2\u949f\u7684API\uff0c\u90a3\u4e48\u62e5\u6709\u4e0a\u9650\uff08le label\uff09\u5c0f\u4e8e\u4e00\u79d2\u949f\u7684\u6876\u5c06\u662f\u65e0\u7528\u7684\uff0c\u53ea\u4f1a\u6d88\u8017\u76d1\u63a7\u540e\u7aef\u670d\u52a1\u5668\u7684\u8ba1\u7b97\u548c\u5b58\u50a8\u8d44\u6e90\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u5982\u679c99.9%\u7684API\u8bf7\u6c42\u8017\u65f6\u5c11\u4e8e50\u6beb\u79d2\uff0c\u90a3\u4e48\u62e5\u6709\u4e00\u4e2a\u4e0a\u9650\u4e3a100\u6beb\u79d2\u7684\u521d\u59cb\u6876\u5c06\u65e0\u6cd5\u8ba9\u4f60\u51c6\u786e\u6d4b\u91cfAPI\u7684\u6027\u80fd\u3002</li> <li>\u7b2c\u4e8c\uff0c\u4ed6\u4eec\u63d0\u4f9b\u7684\u662f\u8fd1\u4f3c\u7684\u767e\u5206\u4f4d\u6570\uff0c\u800c\u4e0d\u662f\u7cbe\u786e\u7684\u767e\u5206\u4f4d\u6570\u3002\u8fd9\u901a\u5e38\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u53ea\u8981\u4f60\u7684\u6876\u88ab\u8bbe\u8ba1\u4e3a\u63d0\u4f9b\u5177\u6709\u5408\u7406\u51c6\u786e\u6027\u7684\u7ed3\u679c\u3002</li> <li>\u7b2c\u4e09\uff0c\u7531\u4e8e\u767e\u5206\u4f4d\u6570\u9700\u8981\u5728\u670d\u52a1\u5668\u7aef\u8ba1\u7b97\uff0c\u5f53\u6709\u5927\u91cf\u6570\u636e\u9700\u8981\u5904\u7406\u65f6\uff0c\u5b83\u4eec\u7684\u8ba1\u7b97\u6210\u672c\u4f1a\u975e\u5e38\u9ad8\u3002\u5728Prometheus\u4e2d\u51cf\u8f7b\u8fd9\u79cd\u60c5\u51b5\u7684\u4e00\u4e2a\u65b9\u6cd5\u662f\u4f7f\u7528\u5f55\u5236\u89c4\u5219\u6765\u9884\u5148\u8ba1\u7b97\u6240\u9700\u7684\u767e\u5206\u4f4d\u6570\u3002</li> </ul> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u663e\u793a\u4e86\u5982\u4f55\u4f7f\u7528Prometheus\u7684Python\u5ba2\u6237\u7aef\u5e93\u521b\u5efa\u4e00\u4e2a\u5e26\u6709\u81ea\u5b9a\u4e49\u6876\u7684\u76f4\u65b9\u56fe\u6307\u6807\u3002</p> <pre><code>from prometheus_client import Histogram\napi_request_duration = Histogram(\n                        name='http_request_duration_seconds',\n                        documentation='Api requests response time in seconds',\n                        labelnames=['api', 'instance'],\n                        buckets=(0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10, 25 )\n                       )\napi_request_duration.labels(\n    api='add_product',\n    instance='host1.domain.com'\n).observe(0.3672)\n</code></pre>"},{"location":"chap13/3Prometheus_index/#summary","title":"\u6c47\u603b\uff08Summary\uff09","text":"<p>\u50cf\u76f4\u65b9\u56fe\u4e00\u6837\uff0cSummary\u6307\u6807\u5bf9\u4e8e\u6d4b\u91cf\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u548c\u54cd\u5e94\u4f53\u5927\u5c0f\u5f88\u6709\u7528\u3002</p> <p>\u50cf\u76f4\u65b9\u56fe\u4e00\u6837\uff0c\u6c47\u603b\u5ea6\u91cf\u5bf9\u4e8e\u6d4b\u91cf\u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u548c\u54cd\u5e94\u5927\u5c0f\u5f88\u6709\u7528\u3002</p> <p>\u4e00\u4e2aSummary\u6307\u6807\u5305\u62ec\u8fd9\u4e9b\u6307\u6807\uff1a</p> <ul> <li>\u4e00\u4e2a\u5305\u542b\u603b\u6d4b\u91cf\u6b21\u6570\u7684Counter\u3002\u6307\u6807\u540d\u79f0\u4f7f\u7528_count\u540e\u7f00\u3002</li> <li>\u4e00\u4e2a\u5305\u542b\u6240\u6709\u6d4b\u91cf\u503c\u4e4b\u548c\u7684Counter\u3002\u6307\u6807\u540d\u79f0\u4f7f\u7528_sum\u540e\u7f00\u3002\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528\u5e26\u6709\u5206\u4f4d\u6570\u6807\u7b7e\u7684\u6307\u6807\u540d\u79f0\uff0c\u6765\u66b4\u9732\u4e00\u4e9b\u6d4b\u91cf\u503c\u7684\u5206\u4f4d\u6570\u6307\u6807\u3002\u7531\u4e8e\u4f60\u4e0d\u5e0c\u671b\u8fd9\u4e9b\u91cf\u503c\u662f\u4ece\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u7684\u6574\u4e2a\u65f6\u95f4\u5185\u6d4b\u5f97\u7684\uff0cPrometheus\u5ba2\u6237\u7aef\u5e93\u901a\u5e38\u4f1a\u4f7f\u7528\u6d41\u5f0f\u7684\u5206\u4f4d\u503c\uff0c\u8fd9\u4e9b\u5206\u4f4d\u503c\u662f\u5728\u4e00\u4e2a\u6ed1\u52a8\u7684\uff08\u901a\u5e38\u662f\u53ef\u914d\u7f6e\u7684\uff09\u65f6\u95f4\u7a97\u53e3\u4e0a\u8ba1\u7b97\u5f97\u5230\u7684\u3002</li> </ul> <p>\u4f8b\u5982\uff0c\u6d4b\u91cf\u5728host1.domain.com\u4e0a\u8fd0\u884c\u7684<code>add_productAPI</code>\u7aef\u70b9\u5b9e\u4f8b\u7684\u54cd\u5e94\u65f6\u95f4\u7684Summary\u6307\u6807\u53ef\u4ee5\u8868\u793a\u4e3a\uff1a</p> <pre><code># HELP http_request_duration_seconds Api requests response time in seconds\n# TYPE http_request_duration_seconds summary\nhttp_request_duration_seconds_sum{api=\"add_product\" instance=\"host1.domain.com\"} 8953.332\nhttp_request_duration_seconds_count{api=\"add_product\" instance=\"host1.domain.com\"} 27892\nhttp_request_duration_seconds{api=\"add_product\" instance=\"host1.domain.com\" quantile=\"0\"}\nhttp_request_duration_seconds{api=\"add_product\" instance=\"host1.domain.com\" quantile=\"0.5\"} 0.232227334\nhttp_request_duration_seconds{api=\"add_product\" instance=\"host1.domain.com\" quantile=\"0.90\"} 0.821139321\nhttp_request_duration_seconds{api=\"add_product\" instance=\"host1.domain.com\" quantile=\"0.95\"} 1.528948804\nhttp_request_duration_seconds{api=\"add_product\" instance=\"host1.domain.com\" quantile=\"0.99\"} 2.829188272\nhttp_request_duration_seconds{api=\"add_product\" instance=\"host1.domain.com\" quantile=\"1\"} 34.283829292\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u5305\u62ec\u603b\u548c\u548c\u8ba1\u6570\u4ee5\u53ca\u4e94\u4e2a\u5206\u4f4d\u6570\u3002\u5206\u4f4d\u65700\u76f8\u5f53\u4e8e\u6700\u5c0f\u503c\uff0c\u5206\u4f4d\u65701\u76f8\u5f53\u4e8e\u6700\u5927\u503c\u3002\u5206\u4f4d\u65700.5\u662f\u4e2d\u4f4d\u6570\uff0c\u5206\u4f4d\u65700.90\u30010.95\u548c0.99\u76f8\u5f53\u4e8e\u5728<code>host1.domain.com</code>\u4e0a\u8fd0\u884c\u7684<code>add_product API</code>\u7aef\u70b9\u54cd\u5e94\u65f6\u95f4\u7684\u7b2c90\u300195\u548c99\u4e2a\u767e\u5206\u4f4d\u3002</p> <p>\u50cf\u76f4\u65b9\u56fe\u4e00\u6837\uff0cSummary\u6307\u6807\u5305\u62ec\u603b\u548c\u548c\u8ba1\u6570\uff0c\u53ef\u7528\u4e8e\u8ba1\u7b97\u968f\u65f6\u95f4\u7684\u5e73\u5747\u503c\u4ee5\u53ca\u4e0d\u540c\u65f6\u95f4\u5e8f\u5217\u7684\u5e73\u5747\u503c\u3002</p> <p>Summary\u63d0\u4f9b\u4e86\u6bd4Histogram\u66f4\u7cbe\u786e\u7684\u767e\u5206\u4f4d\u8ba1\u7b97\u7ed3\u679c\uff0c\u4f46\u8fd9\u4e9b\u767e\u5206\u4f4d\u6709\u4e09\u4e2a\u4e3b\u8981\u7f3a\u70b9\uff1a</p> <ul> <li>\u9996\u5148\uff0c\u5ba2\u6237\u7aef\u8ba1\u7b97\u767e\u5206\u4f4d\u662f\u5f88\u6602\u8d35\u7684\u3002\u8fd9\u662f\u56e0\u4e3a\u5ba2\u6237\u7aef\u5e93\u5fc5\u987b\u4fdd\u6301\u4e00\u4e2a\u6709\u5e8f\u7684\u6570\u636e\u70b9\u5217\u8868\uff0c\u4ee5\u8fdb\u884c\u8fd9\u79cd\u8ba1\u7b97\u3002\u5728Prometheus SDK\u4e2d\u7684\u5b9e\u73b0\u9650\u5236\u4e86\u5185\u5b58\u4e2d\u4fdd\u7559\u548c\u6392\u5e8f\u7684\u6570\u636e\u70b9\u7684\u6570\u91cf\uff0c\u8fd9\u964d\u4f4e\u4e86\u51c6\u786e\u6027\u4ee5\u6362\u53d6\u6548\u7387\u7684\u63d0\u9ad8\u3002\u6ce8\u610f\uff0c\u5e76\u975e\u6240\u6709\u7684Prometheus\u5ba2\u6237\u7aef\u5e93\u90fd\u652f\u6301\u6c47\u603b\u6307\u6807\u4e2d\u7684\u91cf\u503c\u3002\u4f8b\u5982\uff0cPython SDK\u5c31\u4e0d\u652f\u6301\u3002</li> <li>\u7b2c\u4e8c\uff0c\u4f60\u8981\u67e5\u8be2\u7684\u91cf\u503c\u5fc5\u987b\u7531\u5ba2\u6237\u7aef\u9884\u5148\u5b9a\u4e49\u3002\u53ea\u6709\u90a3\u4e9b\u5df2\u7ecf\u63d0\u4f9b\u4e86\u6307\u6807\u7684\u91cf\u503c\u624d\u80fd\u901a\u8fc7\u67e5\u8be2\u8fd4\u56de\u3002\u6ca1\u6709\u529e\u6cd5\u5728\u67e5\u8be2\u65f6\u8ba1\u7b97\u5176\u4ed6\u767e\u5206\u4f4d\u3002\u589e\u52a0\u4e00\u4e2a\u65b0\u7684\u767e\u5206\u4f4d\u6307\u6807\u9700\u8981\u4fee\u6539\u4ee3\u7801\uff0c\u8be5\u6307\u6807\u624d\u53ef\u4ee5\u88ab\u4f7f\u7528\u3002</li> <li>\u7b2c\u4e09\uff0c\u4e5f\u662f\u6700\u91cd\u8981\u7684\u4e00\u70b9\uff0c\u4e0d\u53ef\u80fd\u628a\u591a\u4e2aSummary\u6307\u6807\u8fdb\u884c\u805a\u5408\u8ba1\u7b97\u3002\u8fd9\u4f7f\u5f97\u5b83\u4eec\u5bf9\u52a8\u6001\u73b0\u4ee3\u7cfb\u7edf\u4e2d\u7684\u5927\u591a\u6570\u7528\u4f8b\u6beb\u65e0\u7528\u5904\uff0c\u5728\u8fd9\u4e9b\u7528\u4f8b\u4e2d\uff0c\u901a\u5e38\u6211\u4eec\u5bf9\u4e00\u4e2a\u7279\u5b9a\u7684\u7ec4\u4ef6\u611f\u5174\u8da3\uff0c\u8fd9\u4e2a\u89c6\u89d2\u662f\u5168\u5c40\u7684\uff0c\u5b83\u4e0d\u4e0e\u7279\u5b9a\u7684\u5b9e\u4f8b\u5173\u8054</li> </ul> <p>\u4e0b\u9762\u7684\u4ee3\u7801\u4f7f\u7528Prometheus\u7684Python\u5ba2\u6237\u7aef\u5e93\u521b\u5efa\u4e86\u4e00\u4e2aSummary\u6307\u6807\u3002</p> <pre><code>from prometheus_client import Summary\napi_request_duration = Summary(\n                        'http_request_duration_seconds',\n                        'Api requests response time in seconds',\n                        ['api', 'instance']\n                       )\napi_request_duration.labels(api='add_product', instance='host1.domain.com').observe(0.3672)\n</code></pre> <p>\u4e0a\u9762\u7684\u4ee3\u7801\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u91cf\u5316\u6307\u6807\uff0c\u53ea\u4f1a\u4ea7\u751f\u603b\u548c\u548c\u8ba1\u6570\u6307\u6807\u3002Prometheus\u7684Python SDK\u4e0d\u652f\u6301Summary\u6307\u6807\u4e2d\u7684\u5206\u4f4d\u6570\u8ba1\u7b97\u3002</p>"},{"location":"chap13/3Prometheus_index/#histogramsummary","title":"Histogram\u8fd8\u662fSummary\uff1f","text":"<p>\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u76f4\u65b9\u56fe\u662f\u9996\u9009\uff0c\u56e0\u4e3a\u5b83\u66f4\u7075\u6d3b\uff0c\u5e76\u5141\u8bb8\u6c47\u603b\u767e\u5206\u4f4d\u6570\u3002</p> <p>\u5728\u4e0d\u9700\u8981\u767e\u5206\u4f4d\u6570\u800c\u53ea\u9700\u8981\u5e73\u5747\u6570\u7684\u60c5\u51b5\u4e0b\uff0c\u6216\u8005\u5728\u9700\u8981\u975e\u5e38\u7cbe\u786e\u7684\u767e\u5206\u4f4d\u6570\u7684\u60c5\u51b5\u4e0b\uff0c\u6c47\u603b\u662f\u6709\u7528\u7684\u3002\u4f8b\u5982\uff0c\u5728\u5c65\u884c\u5173\u952e\u7cfb\u7edf\u7684\u5408\u7ea6\u8d23\u4efb\u7684\u60c5\u51b5\u4e0b\u3002</p> <p>\u4e0b\u8868\u603b\u7ed3\u4e86\u76f4\u65b9\u56fe\u548c\u6c47\u603b\u8868\u7684\u4f18\u70b9\u548c\u7f3a\u70b9\u3002</p> <p></p>"},{"location":"chap13/4OpenTelemetry/","title":"4 \u900f\u5f7b\u7406\u89e3OpenTelemetry","text":"<p>OpenTelemetry\u662f\u7531\u4e91\u539f\u751f\u8ba1\u7b97\u57fa\u91d1\u4f1a\uff08CNCF\uff09\u6258\u7ba1\u7684\u4e00\u4e2a\u7528\u4e8e\u57fa\u7840\u8bbe\u65bd\u6027\u80fd\u68c0\u6d4b\u7684\u5f00\u6e90\u53ef\u89c2\u6d4b\u6027\u6846\u67b6\u3002</p> <p>\u8be5\u9879\u76ee\u5728\u51e0\u4e4e\u6240\u6709\u4e3b\u8981\u7684\u4e91\u4f9b\u5e94\u5546\uff08AWS\u3001Google\u3001Microsoft\uff09\u4ee5\u53ca\u53ef\u89c2\u6d4b\u6027\u4f9b\u5e94\u5546\uff08\u5305\u62ecTimescale\uff09\u7684\u8d21\u732e\u4e0b\u5f97\u5230\u4e86\u6781\u5927\u7684\u53d1\u5c55\uff0c\u4ee5\u81f3\u4e8e\u5b83\u6210\u4e3a\u6309\u6d3b\u8dc3\u5ea6\u548c\u8d21\u732e\u8005\u6392\u540d\u7b2c\u4e8c\u7684CNCF\u9879\u76ee\uff0c\u4ec5\u6b21\u4e8eKubernetes\u672c\u8eab\u3002</p> <p>OpenTelemetry\u65e8\u5728\u4e3a\u6240\u6709\u7c7b\u578b\u7684\u53ef\u89c2\u6d4b\u6570\u636e\u5b9a\u4e49\u4e00\u4e2a\u5355\u4e00\u7684\u6807\u51c6\uff08\u5728OpenTelemetry\u7684\u672f\u8bed\u4e2d\u88ab\u79f0\u4f5cSignals\u4fe1\u53f7\uff09\uff0c\u5305\u62ec\u76d1\u63a7\u6307\u6807\u3001\u65e5\u5fd7\u548c\u94fe\u8def\u8ffd\u8e2a\u3002</p> <p>\u901a\u8fc7\u4e00\u7cfb\u5217\u7684\u5de5\u5177\u3001\u5e93\u3001API\u3001SDK\u548cexporters\uff0cOpenTelemetry\u4ece\u6839\u672c\u4e0a\u7b80\u5316\u4e86\u4ece\u670d\u52a1\u4e2d\u6536\u96c6\u4fe1\u53f7\u5e76\u5c06\u5176\u53d1\u9001\u5230\u4f60\u6240\u9009\u7528\u7684\u540e\u7aef\u670d\u52a1\u7684\u8fc7\u7a0b\uff0c\u4e3a\u66f4\u591a\u7684\u7528\u6237\u548c\u4f9b\u5e94\u5546\u6253\u5f00\u4e86\u53ef\u89c2\u6d4b\u6027\u7684\u5927\u95e8\u3002</p> <p>\u5728\u8bbe\u8ba1OpenTelemetry\u6307\u6807\u6807\u51c6\u65f6\uff0c\u6709\u4e09\u4e2a\u8bbe\u8ba1\u76ee\u6807\u88ab\u91c7\u7eb3\uff1a</p> <ul> <li>\u63d0\u4f9b\u5c06\u76d1\u63a7\u6307\u6807\u4e0e\u5176\u4ed6\u7c7b\u578b\u7684\u53ef\u89c2\u5bdf\u6027\u6570\u636e\u76f8\u8fde\u63a5\u7684\u80fd\u529b\uff1a\u8981\u4e48\u662f\u901a\u8fc7Exemplars\u5728\u94fe\u8def\u8ffd\u8e2a\u548c\u76d1\u63a7\u6307\u6807\u4e4b\u95f4\u76f4\u63a5\u8fde\u63a5\uff0c\u8981\u4e48\u662f\u901a\u8fc7Baggage\u548cContext\u63d0\u4f9b\u4e0e\u65e5\u5fd7\u548c\u94fe\u8def\u8ffd\u8e2a\u4eab\u6709\u76f8\u540c\u7684\u76f8\u5173\u5143\u6570\u636e\uff0c\u95f4\u63a5\u5730\u8fde\u63a5\u3002</li> <li>\u5141\u8bb8\u4eceOpenCensus\u6807\u51c6\u8f7b\u677e\u8fc1\u79fb\u5230OpenTelemetry\u6807\u51c6\u3002</li> <li>\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\u63d0\u4f9b\u5bf9\u5176\u4ed6\u4e3b\u8981\u6307\u6807\u5b9e\u73b0\u7684\u5168\u9762\u652f\u6301\u3002Prometheus\u548cStatsD\u662f\u4e13\u95e8\u9002\u914d\u7684\uff0c\u80fd\u591f\u5b8c\u5168\u652f\u6301\uff1a\u90a3\u4e9b\u8fc1\u79fb\u5230OpenTelemetry\u7684\u7528\u6237\u53ef\u4ee5\u770b\u5230\u4e0e\u4f7f\u7528\u5176\u539f\u751f\u5ba2\u6237\u7aef\u7c7b\u4f3c\u7684\u7ed3\u679c\u3002</li> </ul> <p>OpenTelemetry\u63d0\u4f9b\u4e86\u4e00\u4e2a\u91c7\u96c6\u5668\uff0c\u53ef\u4ee5\u7528\u6765\u91cd\u65b0\u805a\u5408\u548c\u91cd\u5b9a\u5411\u6307\u6807\u6570\u636e\uff0c\u7ecf\u5e38\u88ab\u7528\u6765\u521b\u5efa\u4fe1\u53f7\u7ba1\u9053\u3002\u7531\u4e8eOpenTelemetry\u4e0d\u63d0\u4f9b\u540e\u7aef\u5b9e\u73b0\uff08\u5b83\u5173\u6ce8\u7684\u662f\u521b\u5efa\u3001\u6536\u96c6\u548c\u53d1\u9001\u4fe1\u53f7\uff09\uff0c\u6570\u636e\u5c06\u6d41\u5411\u53e6\u4e00\u4e2a\u6216\u591a\u4e2a\u7cfb\u7edf\u8fdb\u884c\u5b58\u50a8\u5e76\u6700\u7ec8\u80fd\u591f\u88ab\u67e5\u8be2\u3002</p> <p>\u4e4b\u6240\u4ee5OpenTelemetry\u6709\u65f6\u4f1a\u4ee4\u4eba\u611f\u5230\u590d\u6742\uff0c\u662f\u56e0\u4e3a\u5b83\u53ef\u4ee5\u7528\u6765\u6a21\u62df\u8bb8\u591a\u4e0d\u540c\u7684\u4fe1\u53f7\u5b9e\u73b0\u3002\u5728\u8fd9\u7bc7\u535a\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u805a\u7126\u4e8e\u201d\u8868\u9762\u201d\uff0c\u5373\u5f00\u53d1\u8005\u5728OpenTelemetry\u4e2d\u4f7f\u7528\u6307\u6807\u65f6\u53ef\u80fd\u9047\u5230\u7684\u8981\u7d20</p>"},{"location":"chap13/4OpenTelemetry/#1-opentelemetry","title":"1 OpenTelemetry\u6307\u6807","text":"<p>OpenTelemetry\u6307\u6807\u4e0ePrometheus\u6307\u6807\u7565\u6709\u4e0d\u540c\uff0c\u5b83\u5141\u8bb8\u5728\u91c7\u96c6\u8fc7\u7a0b\u4e2d\u8fdb\u884c\u66f4\u52a0\u7075\u6d3b\u7684\u8f6c\u6362\uff0c\u5e76\u652f\u6301\u8bb8\u591a\u5bfc\u51fa\u7c7b\u578b\uff0c\u5305\u62ecPull\u548cPush\u6a21\u5f0f\u3002</p> <p>\u7531\u4e8e\u8fd9\u79cd\u7075\u6d3b\u6027\uff0c\u8bb8\u591a\u73b0\u6709\u7684\u6307\u6807\u7cfb\u7edf\u90fd\u53ef\u4ee5\u7528OpenTelemetry\u5efa\u6a21\uff0c\u800c\u4e0d\u4f1a\u635f\u5931\u8bed\u4e49\u6216\u7cbe\u786e\u6027\uff0c\u8fd9\u4f7f\u5b83\u6210\u4e3a\u4e92\u64cd\u4f5c\u6027\u7684\u5b8c\u7f8e\u6307\u6807\u7cfb\u7edf\u3002</p> <p>OpenTelemetry\u6709\u4e09\u4e2a\u6a21\u578b\uff1a</p> <ul> <li>\u4e8b\u4ef6\u6a21\u578b\uff1a\u5728\u8fd9\u4e2a\u6a21\u578b\u4e2d\uff0c\u4f60\u4f5c\u4e3a\u4e00\u4e2a\u5f00\u53d1\u8005\u6765\u521b\u5efa\u6307\u6807\uff0c</li> <li>\u6d41\u6a21\u578b\uff1aOpenTelemetry\u4f7f\u7528\u8be5\u6a21\u578b\u8fdb\u884c\u4f20\u8f93\uff0c</li> <li>\u65f6\u95f4\u5e8f\u5217\u6a21\u578b\uff1aOpenTelemetry\u5c06\u5176\u7528\u4e8e\u5b58\u50a8\u3002</li> </ul> <p>\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u8ba8\u8bba\u7684\u6307\u6807\u90fd\u662f\u4e8b\u4ef6\u6a21\u578b\u7684\u4e00\u90e8\u5206\uff0c\u800c\u8f6c\u6362\u5219\u662f\u4ece\u4e8b\u4ef6\u6a21\u578b\u5230\u6d41\u6a21\u578b\u7684\u8f6c\u6362\u7684\u4e00\u90e8\u5206\u3002(\u4f5c\u4e3a\u4e00\u4e2a\u5f00\u53d1\u8005\uff0c\u4f60\u5176\u5b9e\u4e0d\u9700\u8981\u62c5\u5fc3\u8fd9\u4e9b\u6a21\u578b\uff0c\u4f46\u6709\u4e00\u4e2a\u57fa\u672c\u7684\u4e86\u89e3\u4f1a\u66f4\u6709\u5e2e\u52a9\uff09\u3002</p> <ul> <li>\u901a\u8fc7\u65f6\u95f4\u4e0a\u7684\u805a\u5408\uff08\u6539\u53d8\u5206\u8fa8\u7387\uff09\u51cf\u5c11\u4f20\u8f93\u7684\u6307\u6807\u6570\u91cf</li> <li>\u901a\u8fc7\u7a7a\u95f4\u805a\u5408\u51cf\u5c11\u4f20\u8f93\u7684\u6307\u6807\u6570\u91cf\uff08\u53bb\u9664\u4e0d\u9700\u8981\u7684\u5c5e\u6027\uff09</li> <li>\u4ece\u7d2f\u79ef\u8868\u793a\u6cd5\uff08Prometheus\u4f7f\u7528\u7684\uff09\u6539\u4e3a\u5dee\u503c\u8868\u793a\u6cd5\uff08\u8868\u8fbe\u6570\u503c\u4e4b\u95f4\u7684\u53d8\u5316\uff0c\u800c\u4e0d\u662f\u7edd\u5bf9\u6d4b\u91cf\u503c\uff09</li> </ul> <p>OpenTelemetry\u6307\u6807\u7684\u5de5\u4f5c\u65b9\u5f0f\u662f\u4f7f\u7528\u5168\u5c40\u7684MeterProvider\u6765\u521b\u5efa\u4e00\u4e2aMeter\uff0c\u5e76\u5c06\u5176\u4e0e\u4e00\u4e2a\u6216\u591a\u4e2aInstrument\u76f8\u5173\u8054\uff0c<code>&lt;mark&gt;</code>\u6bcf\u4e00\u4e2aInstrument\u90fd\u88ab\u7528\u6765\u521b\u5efa\u4e00\u7cfb\u5217\u7684Measurements<code>&lt;/mark&gt;</code>\u3002</p> <p>\u8fd9\u4e9b\u6d4b\u91cf\u503c\u5728View\u4e2d\u88ab\u6c47\u603b\u4e3a\u4e00\u4e2a\u6307\u6807\u3002\u7136\u540e\u901a\u8fc7Metric Reader\u548cMetric Exporter\u7684\u7ec4\u5408\u6765\u89c2\u5bdf\u548c\u5bfc\u51fa\u6307\u6807\uff08\u53ef\u4ee5\u662f\u62c9\u6216\u63a8\uff09</p> <p></p> <p>\u56fe\u793a\u8bf4\u660eOpenTelemetry\u4e2dMeterProvider\u7684\u8981\u7d20</p> <p><code>&lt;mark&gt;</code>Instrument\u6216Measurements\u662f\u6211\u4eec\u5728\u5e94\u7528\u4e2d\u521b\u5efa\u6216\u89c2\u5bdf\u5230\u7684\u4e1c\u897f\uff0c\u800c\u6307\u6807\u5219\u8868\u8fbe\u4e86\u6211\u4eec\u4e0e\u53ef\u89c2\u6d4b\u6027\u6570\u636e\u7684\u6d88\u8d39\u8005\u5206\u4eab\u7684\u8be5\u76d1\u6d4b\u7684\u5f53\u524d\u805a\u5408\u503c\u3002<code>&lt;/mark&gt;</code></p> <p>OpenTelemetry\u5141\u8bb8\u4ee5\u591a\u79cd\u65b9\u5f0f\u5c06\u5c5e\u6027\uff08\u6807\u7b7e\uff09\u9644\u52a0\u5230\u6307\u6807\u4e0a\u3002\u6700\u5e38\u89c1\u7684\u6709\uff1a</p> <ul> <li>\u6765\u81ea\u4efb\u4f55\u9644\u52a0\u7684\u8d44\u6e90\uff0c\u5b83\u53ef\u80fd\u6301\u6709\u5b9a\u4e49\u4e3b\u673a\u7684\u6807\u7b7e\u3002\u4f8b\u5982\uff0c\u4e00\u4e2aKubernetes Pod\u6216\u4e00\u4e2a\u865a\u62df\u673a</li> <li>\u6765\u81ea\u5f53\u524d\u7684\u4e0a\u4e0b\u6587\uff0c\u5b83\u5c06\u88ab\u9644\u52a0\u5230\u6240\u6709\u540c\u6b65\u7684Instrument\u4e0a</li> <li>Measurement\u672c\u8eab\u6240\u5177\u5907\u7684</li> </ul>"},{"location":"chap13/4OpenTelemetry/#2-measurementsmetrics","title":"2  \u4eceMeasurements\u5230Metrics","text":"<p>Measurements\u7684\u521b\u5efa\u975e\u5e38\u5feb\uff0c\u5c24\u5176\u662f\u5728\u540c\u6b65\u7684\u60c5\u51b5\u4e0b\uff0c\u4f46\u8fd9\u53ef\u80fd\u4f1a\u8fc5\u901f\u538b\u57ae\u4e00\u4e2a\u6307\u6807\u7ba1\u9053\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cPrometheus\u4f7f\u7528\u4e86\u4e00\u4e2a\u5e26\u6709\u6293\u53d6\u95f4\u9694\u7684Pull\u673a\u5236\uff0c</p> <p>\u800cOpenTelemetry\u901a\u8fc7\u7ed9\u6bcf\u4e2aInstrument\u9644\u52a0\u4e00\u4e2aAggregation View\u6765\u89e3\u51b3\u6536\u96c6\u8def\u5f84\u4e2d\u7684\u95ee\u9898\uff0c\u7136\u540e\u5c06\u6570\u636e\u4f20\u9012\u7ed9\u89c2\u5bdf\u5b83\u4eec\u7684MetricReader\u548c\u8f93\u51fa\u5b83\u4eec\u7684MetricExporter\uff1a</p> <p></p> <p>\u4ece\u6d4b\u91cf\u5230\u6307\u6807\uff1aOpenTelemetry\u4e2d\u6307\u6807\u7684\u6536\u96c6\u8def\u5f84\u56fe</p> <p>MetricReader\u8d1f\u8d23\u5728Instrument\u6ca1\u6709View\u7684\u60c5\u51b5\u4e0b\u9644\u52a0\u9ed8\u8ba4\u7684View\uff0c\u4e5f\u8d1f\u8d23\u5b9a\u4e49MetricExporters\uff0c\u7136\u540e\u5411\u5176\u53d1\u9001\u8fd9\u4e9b\u89c2\u6d4b\u503c\u3002</p> <p>MetricReader\u8fd8\u5c06\u6539\u53d8\u6307\u6807\u7684\u65f6\u95f4\u6027\uff0c\u4ece\u9ed8\u8ba4\u7684Cumulative\uff08\u65b0\u503c\u7d2f\u52a0\u5230\u6700\u540e\u4e00\u4e2a\u503c\u4e0a\uff0c\u8fd9\u4e0e\u6211\u4eec\u5728Prometheus\u4e2d\u770b\u5230\u7684\u76f8\u540c\uff09\u6539\u4e3aDelta\uff08\u5ea6\u91cf\u503c\u662f\u65b0\u65e7\u503c\u4e4b\u5dee\uff09</p> <p>MetricReader\u548cMetricExporter\u7684\u7ec4\u5408\u51b3\u5b9a\u4e86\u6570\u636e\u5982\u4f55\u88ab\u53d1\u9001\u5230\u4e0b\u6e38\u3002</p> <p>\u4e00\u4e2a\u975e\u5e38\u6d41\u884c\u7684\u65b9\u6cd5\u662f\u4f7f\u7528PeriodicExportingMetricReader\u548cOTLPMetricExporter\uff0c\u6bcf\u9694\u4e00\u6bb5\u65f6\u95f4\uff08\u9ed8\u8ba4\u4e3a60\u79d2\uff09\u5bf9\u6307\u6807\u8fdb\u884c\u91c7\u6837\uff0c\u5e76\u5c06\u5176\u53d1\u9001\u5230OpenTelemetry\u91c7\u96c6\u5668\uff08\u5b83\u5c06\u4f7f\u7528\u53e6\u4e00\u4e2aExporter\uff09\u8fdb\u884c\u8fdb\u4e00\u6b65\u5904\u7406\u3002\u8bb8\u591a\u5176\u4ed6\u7684\u5bfc\u51fa\u5668\u53ef\u7528\u4e8e\u5404\u79cd\u8bed\u8a00\u3002</p> <p>\u4e00\u4e9b\u6d41\u884c\u7684\u5bfc\u51fa\u5668\u6709\uff1a</p> <ul> <li>Prometheus Metric Exporter\uff1a\u4e00\u4e2a\u57fa\u4e8ePull\u6a21\u5f0f\u7684\u5bfc\u51fa\u5668\uff0cPrometheus\u5ba2\u6237\u7aef\u53ef\u4ee5\u6293\u53d6\u5b83\u7684\u7aef\u70b9</li> <li>Prometheus Remote Write Exporter\uff1a\u4e00\u4e2a\u57fa\u4e8ePush\u6a21\u5f0f\u7684\u5bfc\u51fa\u5668\uff0c\u901a\u8fc7Prometheus\u8fdc\u7a0b\u5199\u5165\u534f\u8bae\u53d1\u9001\u6570\u636e</li> <li>OTLPMetricExporter\uff1a\u5b83\u53ef\u4ee5\u5411\u4efb\u4f55\u7406\u89e3OpenTelemetry\u534f\u8bae\u7684\u8bbe\u5907\u63a8\u9001\u6307\u6807</li> <li>ConsoleMetricExporter\uff1a\u5b83\u88ab\u7528\u6765\u5411\u63a7\u5236\u53f0\u8f93\u51fa\u8c03\u8bd5\u4fe1\u606f</li> </ul> <p>\u5728Python\u4e2d\uff0c\u521d\u59cb\u5316OpenTelemetry\u6307\u6807\u5e76\u9644\u52a0\u4e00\u4e2a\u9ed8\u8ba4\u7684MetricReader\u548cMetricExporter\uff08\u53d1\u9001\u6307\u6807\u5230\u672c\u5730OpenTelemetry\u91c7\u96c6\u5668\uff09\uff0c\u4ee3\u7801\u770b\u8d77\u6765\u50cf\u8fd9\u6837\uff1a</p> <pre><code>from opentelemetry._metrics import get_meter_provider, set_meter_provider\nfrom opentelemetry.exporter.otlp.proto.grpc._metric_exporter import (\n    OTLPMetricExporter,\n)\nfrom opentelemetry.sdk._metrics import MeterProvider\nfrom opentelemetry.sdk._metrics.export import PeriodicExportingMetricReader\n\nexporter = OTLPMetricExporter(insecure=True)\nreader = PeriodicExportingMetricReader(exporter)\nprovider = MeterProvider(metric_readers=[reader])\nset_meter_provider(provider)\n</code></pre>"},{"location":"chap13/4OpenTelemetry/#3-measurements","title":"3 \u2014\u76d1\u6d4b\u5e76\u53d1\u9001Measurements","text":"<p>OpenTelemetry\u63d0\u4f9b\u4e86\u516d\u79cd\u7c7b\u578b\u7684Instruments\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u4eec\u6765\u6355\u83b7\u6d4b\u91cf\u7ed3\u679c\u3002\u5b83\u4eec\u53ef\u4ee5\u88ab\u5206\u4e3a\u4e24\u5927\u7c7b\uff1a\u540c\u6b65\u548c\u5f02\u6b65\u3002</p> <p>\u6bcf\u4e2aInstrument\u90fd\u53ef\u4ee5\u53d1\u9001\u6d4b\u91cf\u503c\uff0c\u6bcf\u4e2aInstrument\u90fd\u53ef\u4ee5\u4e0e\u5c5e\u6027\u76f8\u5173\u8054\u3002</p> <p>\u540c\u6b65Instrument\u4ee5\u7c7b\u4f3c\u4e8ePrometheus\u6307\u6807\u7684\u65b9\u5f0f\u5728\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u4e2d\u5b9e\u73b0\uff0c\u901a\u8fc7\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u63d2\u5165\u4ee3\u7801\uff0c\u6bcf\u6b21\u6267\u884c\u65f6\u90fd\u4f1a\u66f4\u65b0\u4e00\u4e2a\u503c\u3002\u5b83\u4eec\u53ef\u4ee5\u4e0e\u5f53\u524d\u7684Context\u4e0a\u4e0b\u6587\u76f8\u5173\u8054\uff08\u8fd9\u6709\u52a9\u4e8e\u63cf\u8ff0\u5f53\u524d\u7684\u5e94\u7528\u72b6\u6001\uff09\u3002</p> <p>\u5f02\u6b65Instrument\u5219\u4f1a\u6ce8\u518c\u4e00\u4e2a\u56de\u8c03\u51fd\u6570\uff0c\u53ea\u5728\u89c2\u5bdf\u65f6\u53d1\u9001\u6570\u503c\u3002\u4f8b\u5982\uff0c\u53ef\u4ee5\u6ce8\u518c\u4e00\u4e2a\u5f02\u6b65Instrument\uff0c\u6bcf10\u79d2\u62a5\u544a\u4e00\u4e2a\u4f20\u611f\u5668\u7684\u503c\u3002\u8fd9\u4e9bInstrument\u4e0d\u80fd\u4e0e\u5f53\u524d\u7684Context\u76f8\u5173\u8054\uff0c\u56e0\u4e3a\u5b83\u4eec\u4f4d\u4e8e\u4e3b\u7a0b\u5e8f\u7684\u5916\u90e8\uff0c\u800c\u4e0d\u662f\u5728\u4e3b\u7a0b\u5e8f\u8fd0\u884c\u65f6\u88ab\u8c03\u7528\uff0c\u5b83\u4eec\u6839\u636e\u89c2\u5bdf\u8005\u7684\u8981\u6c42\u89c2\u5bdf\u4fe1\u53f7\u6570\u636e\u3002\u5728\u67d0\u4e9b\u65b9\u9762\uff0c\u5b83\u4eec\u7c7b\u4f3c\u4e8ePrometheus\u901a\u8fc7Exporter\u5bf9\u4e00\u4e2a\u672a\u88ab\u68c0\u6d4b\u7684\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u76d1\u63a7\u3002</p> <p>\u6240\u6709Instrument\u7684\u521b\u5efa\u90fd\u6709\u4e00\u4e2a\u540d\u79f0\u3001\u4e00\u4e2a\u63cf\u8ff0\u548c\u4e00\u4e2a\u6d4b\u91cf\u5355\u4f4d\uff08\u5fc5\u987b\u9075\u5faaInstrument\u5355\u4f4d\u89c4\u5219\uff09\u3002</p> <p>\u5f02\u6b65Instrument\u8fd8\u6307\u5b9a\u4e86\u56de\u8c03\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u88ab\u8c03\u7528\u4ee5\u89c2\u5bdf\u6d4b\u91cf\u7ed3\u679c\u3002\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u4f7f\u7528\u7684OpenTelemetry Instrument\u7c7b\u578b\uff0c\u5982\u4e0b\u8868\u6240\u793a\u3002\uff08\u4ee4\u4eba\u56f0\u60d1\u7684\u662f\uff0c\u8bed\u8a00\u5448\u73b0\u7ed9\u7528\u6237\u7684\u5efa\u8bae\u540d\u79f0\u4e0e\u6d4b\u91cf\u540d\u79f0\u4e0d\u4e00\u6837\uff0c\u7528Observable\u6765\u4ee3\u66ffAsynchronous\u3002\u5373 <code>observable_counter</code>\u3002\uff09</p> <p>\u4e0b\u8868\u6982\u8ff0\u4e86OpenTelemetry\u4e2dInstrument\u7c7b\u578b\u7684\u540d\u79f0\u548c\u7279\u70b9\u3002</p> <p></p> <p>\u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u6765\u8bb2\u4e00\u4e0b\u6bcf\u4e00\u79cdInstrument\u7c7b\u578b\u3002</p>"},{"location":"chap13/4OpenTelemetry/#counter-asynchronous-counter","title":"Counter / Asynchronous Counter","text":"<p>Counter\u53ef\u8bd1\u4e3a\u201d\u8ba1\u6570\u5668\u201d\uff0c\u5219Asynchronous Counter\u8bd1\u4e3a\u201d\u5f02\u6b65\u8ba1\u6570\u5668\u201d</p> <p>Counter\u662f\u4e00\u4e2a\u540c\u6b65Instrument\uff0c\u5b83\u603b\u662f\u5728\u589e\u52a0\uff0c\u5373\u5b83\u662f\u5355\u8c03\u7684\uff0c\u53ea\u63a5\u53d7\u975e\u8d1f\u7684\u503c\u3002</p> <p>\u4e0d\u51fa\u6240\u6599\uff0c\u5b83\u4e0ePrometheus\u7684Counter\u662f\u76f8\u540c\u7684\u3002Counter\u901a\u8fc7\u63a5\u6536\u589e\u91cf\u6216Delta\u5dee\u503c\u6765\u5de5\u4f5c\u3002</p> <p>\u5f53\u4f7f\u7528\u8ba1\u6570\u5668\u65f6\uff0c\u8bed\u8a00SDK\u4e2d\u4f1a\u6709\u4e00\u4e2aadd\u7684\u64cd\u4f5c\uff0c\u5fc5\u987b\u63d0\u4f9b\u4e00\u4e2a\u975e\u8d1f\u6570\u6765\u589e\u52a0\u8ba1\u6570\u5668\u7684\u503c\u3002\u540c\u65f6\u53ef\u4ee5\u9644\u52a0\u4e00\u7ec4\u53ef\u9009\u7684\u5c5e\u6027\u3002\u8fd9\u4e9b\u5c5e\u6027\u7c7b\u4f3c\u4e8ePrometheus\u7684\u6807\u7b7e\u3002</p> <p>\u5f02\u6b65\u8ba1\u6570\u5668\u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\u901a\u8fc7\u56de\u8c03\u800c\u4e0d\u662fadd\u51fd\u6570\u6765\u64cd\u4f5c\u3002\u5f53\u89c2\u5bdfInstrument\u65f6\uff0c\u56de\u8c03\u51fd\u6570\u4f1a\u88ab\u6267\u884c\uff0c\u5e76\u5c06\u4f20\u56de\u4e00\u4e2a\u6216\u591a\u4e2a\u6d4b\u91cf\u503c\uff0c\u8868\u793a\u4e3a\u7edd\u5bf9\u503c\uff08\u4e0d\u662fdelta\u503c\uff09\u3002\u4e00\u65e6\u8fd9\u4e9b\u503c\u88ab\u4f20\u9012\uff0c\u5b83\u4eec\u5c06\u5728\u5185\u90e8\u901a\u8fc7\u8ba1\u7b97\u5f97\u5230delta\u503c\u3002</p> <p>\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a\u5f02\u6b65\u8ba1\u6570\u5668\uff0c\u62a5\u544a\u5e94\u7528\u7a0b\u5e8f\u81ea\u542f\u52a8\u4ee5\u6765\u6240\u6d88\u8017\u7684CPU\u65f6\u95f4\u3002\u8fd9\u4e00\u4fe1\u606f\u5c06\u5728\u56de\u8c03\u4e2d\u4ece\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u63d0\u53d6\u5e76\u8fd4\u56de\u3002\u53ef\u4ee5\u4e00\u6b21\u6027\u8fd4\u56de\u51e0\u4e2a\u503c\uff0c\u6bd4\u5982\u6bcf\u4e2aCPU\u6216\u7ebf\u7a0b\u90fd\u6709\u4e00\u4e2a\u503c\u3002\u8fd9\u4e9b\u6d4b\u91cf\u503c\u603b\u662f\u88ab\u671f\u671b\u80fd\u591f\u901a\u8fc7\u4e00\u79cd\u6709\u610f\u4e49\u7684\u65b9\u5f0f\u8fdb\u884c\u8de8\u5c5e\u6027\u6c42\u548c\uff08\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u7cfb\u7edf\u4f7f\u7528\u7684\u603bCPU\u65f6\u95f4\uff09\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u7531\u4e8ePython SDK\u8fd8\u4e0d\u7a33\u5b9a\uff0c\u6211\u4eec\u9700\u8981\u5bfc\u5165 <code>_metrics</code>\uff0c\u800c\u4e0d\u662f\u672c\u6587\u4ee3\u7801\u793a\u4f8b\u7684metrics\u3002\u672a\u6765\u53ef\u80fd\u8fd8\u4f1a\u6709\u4e00\u4e9b\u7834\u574f\u6027\u7684\u53d8\u66f4\u3002\u968f\u7740\u9879\u76ee\u7684\u8fdb\u5c55\uff0c\u6211\u4eec\u4f1a\u4fdd\u6301\u66f4\u65b0\u3002\u76ee\u524d\u7684\u4f8b\u5b50\u662f\u7528OpenTelemetry Python SDK v1.11.1\u7f16\u5199\u7684\u3002</p> <p>\u5728Python\u4e2d\uff0c\u521b\u5efa\u548c\u4f7f\u7528\u8ba1\u6570\u5668\u548c\u5f02\u6b65\u8ba1\u6570\u5668\u7684\u4f8b\u5b50\u770b\u8d77\u6765\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>from opentelemetry._metrics import get_meter_provider\nfrom opentelemetry._metrics.observation import Observation\n\nmeter = get_meter_provider().get_meter(\"otel-demo\")\n\n# Counter\ncounter = meter.create_counter(\"counter\")\n\n# This adds 100 to the total (a delta value)\ncounter.add(100,{\"app\": \"timescale\"})\n\n# Callback function for Async counter\ndef observable_counter_func() -&gt; [Observation]:\n    # This reports that the current value is 10, which will be\n    # converted to a delta internally\n    return [Observation(10, {\"app\": \"timescale\"}]\n\n# Async Counter\nobservable_counter = meter.create_observable_counter(\n    \"observable_counter\", [observable_counter_func]\n)\n</code></pre>"},{"location":"chap13/4OpenTelemetry/#updowncounter-asynchronous-updowncounter","title":"UpDownCounter / Asynchronous UpDownCounter","text":"<p>UpDownCounter\u662f\u4e00\u4e2a\u7c7b\u4f3c\u4e8eCounter\u7684\u540c\u6b65Instrument\uff0c\u4f46\u5b83\u5141\u8bb8\u4f20\u9012\u8d1f\u7684delta\u503c\uff08\u5b83\u53ef\u4ee5\u4e0d\u662f\u5355\u8c03\u7684\uff09\u3002</p> <p>Counter\u9002\u5408\u8868\u793a\u5df2\u7ecf\u63d0\u4ea4\u7684\u4f5c\u4e1a\u6570\u91cf\uff0c\u800cUpDownCounter\u5219\u9002\u5408\u8868\u793a\u5f53\u524d\u6b63\u5728\u5904\u7406\u7684\u4f5c\u4e1a\u6570\u91cf\uff08\u5b83\u53ef\u4ee5\u5411\u4e0a\u548c\u5411\u4e0b\u79fb\u52a8\uff09\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u4e0ePrometheus\u4e2d\u7684Gauge\u7684\u7528\u6cd5\u4e0d\u4e00\u6837\uff0c\u56e0\u4e3a\u6211\u4eec\u8bb0\u5f55\u7684\u662f\u53d8\u5316\uff0c\u800c\u4e0d\u662f\u7edd\u5bf9\u503c</p> <p>\u4e00\u4e2aUpDownCounter\u63d0\u4f9b\u4e86\u4e00\u4e2aadd\u64cd\u4f5c\uff0c\u4e0eCounter\u64cd\u4f5c\u76f8\u540c\uff1a\u4e0e\u4e4b\u76f8\u53cd\u7684\u662f\u5b83\u63a5\u53d7\u8d1f\u7684\u6570\u636e\u503c\u3002\u7531\u5c5e\u6027\u6570\u636e\u5173\u8054\u7684\u503c\u88ab\u671f\u671b\u662f\u53ef\u4ee5\u6c42\u548c\u7684\u3002</p> <p>\u4e0d\u51fa\u6240\u6599\uff0c\u5f02\u6b65UpDownCounter\u63d0\u4f9b\u4e86\u4e00\u4e2a\u56de\u8c03\u63a5\u53e3\uff0c\u8fd4\u56de\u4e00\u4e2a\u6216\u591a\u4e2a\u6d4b\u91cf\u503c\uff0c\u5c06\u6bcf\u4e2a\u6d4b\u91cf\u503c\u8868\u8fbe\u4e3a\u4e00\u4e2a\u7edd\u5bf9\u503c\uff0c\u8be5\u503c\u5c06\u5728\u5185\u90e8\u88ab\u8ba1\u7b97\u4e3adelta\u503c\u3002</p> <p>OpenTelemetry\u89c4\u8303\u6307\u51fa\uff0c\u5f53\u88ab\u8fd4\u56de\u7684\u503c\u5f88\u5bb9\u6613\u88ab\u89c2\u5bdf\u5230\u65f6\uff0c\u4e0d\u5e94\u8be5\u4f7f\u7528\u540c\u6b65\u7684UpDownCounter\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5e94\u8be5\u4f7f\u7528\u4e00\u4e2a\u5f02\u6b65UpDownCounter\u6765\u4ee3\u66ff\u3002</p> <p>\u5728Python\u4e2d\uff0c\u521b\u5efa\u548c\u4f7f\u7528UpDownCounter\u548cAsynchronous UpDownCounter\u7684\u4f8b\u5b50\u770b\u8d77\u6765\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>from opentelemetry._metrics import get_meter_provider\nfrom opentelemetry._metrics.observation import Observation\n\nmeter = get_meter_provider().get_meter(\"otel-demo\")\n\n# UpDownCounter\nup_down_counter = meter.create_up_down_counter(\"up_down_counter\")\n\n# This adds 100, then removes 10 from the total (both delta values)\nup_down_counter.add(100,{\"app\": \"timescale\"})\nup_down_counter.add(-10,{\"app\": \"timescale\"})\n\n# Callback function for Async counter\ndef observable_up_down_counter_func() -&gt; [Observation]:\n    # This reports that the current value is 10, which will be\n    # converted to a delta internally\n    return [Observation(10, {\"app\": \"timescale\"})]\n\n# Async UpDownCounter, note the observable prefix\nobservable_up_down_counter = meter.create_observable_up_down_counter(\n    \"observable_up_down_counter\", [observable_up_down_counter_func]\n)\n</code></pre>"},{"location":"chap13/4OpenTelemetry/#histogram","title":"Histogram","text":"<p>Histogram\u53ef\u8bd1\u4e3a\u76f4\u65b9\u56fe\u3002</p> <p>Histogram\u662f\u4e00\u79cd\u540c\u6b65Instrument\uff0c\u5b83\u5141\u8bb8\u8bb0\u5f55\u5728\u7edf\u8ba1\u4e0a\u76f8\u4e92\u5173\u8054\u7684\u591a\u4e2a\u6570\u503c\u3002\u5f53\u4f60\u4e0d\u60f3\u5b64\u7acb\u5730\u5206\u6790\u6570\u636e\u70b9\uff0c\u800c\u662f\u60f3\u901a\u8fc7\u8ddf\u8e2a\u843d\u5728\u6bcf\u4e2a\u9884\u5b9a\u4e49\u6876\u4e2d\u7684\u503c\u7684\u6570\u91cf\u4ee5\u53ca\u6700\u5c0f\u503c\u548c\u6700\u5927\u503c\uff08\u5982\u679c\u6709\u8fdb\u884c\u914d\u7f6e\uff09\u6765\u751f\u6210\u5173\u4e8e\u5176\u5206\u5e03\u7684\u7edf\u8ba1\u4fe1\u606f\u65f6\uff0c\u4f60\u4f1a\u9009\u62e9Histogram\u3002</p> <p>\u76f4\u65b9\u56fe\u53ea\u6709\u4e00\u4e2a\u5355\u4e00\u7684\u65b9\u6cd5\u88ab\u66b4\u9732\u51fa\u6765\uff1arecord\u3002\u8bb0\u5f55\u9700\u8981\u4e00\u4e2a\u975e\u8d1f\u7684\u89c2\u5bdf\u503c\uff0c\u5e76\u53ef\u4ee5\u9644\u52a0\u4e00\u7ec4\u53ef\u9009\u7684\u5c5e\u6027\u3002</p> <p>\u5f53\u4f60\u67e5\u770bHTTP\u54cd\u5e94\u65f6\u95f4\u65f6\uff0c\u4f60\u53ef\u80fd\u4f1a\u9009\u62e9\u76f4\u65b9\u56fe\uff1a\u77e5\u9053\u6bcf\u4e2a\u8bf7\u6c42\u53d1\u751f\u65f6\u7684\u786e\u5207\u54cd\u5e94\u65f6\u95f4\u53ef\u80fd\u5e76\u4e0d\u90a3\u4e48\u6709\u7528\uff08\u800c\u4e14\u66f4\u9002\u5408\u94fe\u8def\u8ffd\u8e2a\u6570\u636e\uff0c\u5b83\u5c06\u66b4\u9732\u6bcf\u4e2a\u8bf7\u6c42\u7684\u5f00\u59cb\u548c\u7ed3\u675f\u65f6\u95f4\uff09\uff0c\u4f46\u4ece\u670d\u52a1\u5c42\u9762\u6765\u770b\uff0c\u80fd\u591f\u62a5\u544a\u4e2d\u4f4d\u54cd\u5e94\u65f6\u95f4\u548c\u8d85\u8fc795\u5206\u4f4d\u6570\u7684HTTP\u8bf7\u6c42\u6570\u91cf\u53ef\u80fd\u66f4\u6709\u610f\u601d\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8bb0\u5f55\u6d4b\u91cf\u7ed3\u679c\u5e76\u4e0d\u80fd\u521b\u5efaHistogram\uff1b\u9ed8\u8ba4\u7684Aggregation\uff08Explicit Bucket Histogram Aggregation\uff09\u53ef\u4ee5\u3002\u5f53\u4f7f\u7528Histogram Instrument\u65f6\uff0c\u91cd\u8981\u7684\u662f\u786e\u4fdd\u6876\u4e5f\u88ab\u914d\u7f6e\u4e86\u3002\u9ed8\u8ba4\u503c\u662f <code>[ 0, 5, 10, 25, 50, 75, 100, 250, 500, 1000 ]</code>\uff0c\u800c\u8fd9\u5e76\u4e0d\u603b\u662f\u7406\u60f3\u7684\u3002\u4f60\u53ef\u4ee5\u5728\u4e0b\u9762\u51e0\u6bb5\u770b\u5230\u4e00\u4e9b\u521b\u5efaView\u7684\u4f8b\u5b50\u3002</p> <p>\u5728Python\u4e2d\uff0c\u4e00\u4e2a\u521b\u5efa\u548c\u4f7f\u7528\u76f4\u65b9\u56fe\u7684\u4f8b\u5b50\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>from opentelemetry._metrics import get_meter_provider\nfrom opentelemetry._metrics.observation import Observation\n\nmeter = get_meter_provider().get_meter(\"otel-demo\")\n\n# Histogram\nhistogram = meter.create_histogram(\"histogram\")\n\n# This records a value of 100\nhistogram.record(100,{\"app\": \"timescale\"})\n</code></pre>"},{"location":"chap13/4OpenTelemetry/#asynchronous-gauge","title":"Asynchronous Gauge","text":"<p>\u5f02\u6b65Gauge\u5728OpenTelemetry API\u4e2d\u7684\u72ec\u7279\u4e4b\u5904\u5728\u4e8e\u4e24\u4e2a\u65b9\u9762\uff1a\u5b83\u6ca1\u6709\u540c\u6b65\u7684\u5b9e\u73b0\uff0c\u5e76\u4e14\u88ab\u8bbe\u8ba1\u7528\u6765\u8868\u793a\u90a3\u4e9b\u76f8\u52a0\u6ca1\u6709\u610f\u4e49\u7684\u503c\uff0c\u5373\u4f7f\u5b83\u4eec\u5171\u4eab\u5c5e\u6027\u6570\u636e\u3002</p> <p>\u8fd9\u65b9\u9762\u7684\u4e00\u4e2a\u4f8b\u5b50\u662f\u4e00\u4e2a\u623f\u5b50\u7684\u5404\u4e2a\u623f\u95f4\u7684\u6e29\u5ea6\u3002\u8fd9\u662f\u5e38\u89c1\u7684\u6570\u636e\uff0c\u4f46\u662f\u628a\u5b83\u4f5c\u4e3a\u4e00\u4e2a\u603b\u503c\u6765\u62a5\u544a\u6ca1\u6709\u4efb\u4f55\u610f\u4e49\u2013\u4f60\u53ef\u80fd\u50cf\u6c42\u4e00\u4e2a\u5e73\u5747\u503c\u6216\u6700\u5927\u503c\uff0c\u4f46\u7edd\u4e0d\u662f\u4e00\u4e2a\u603b\u548c\u3002\u8fd9\u662f\u4e0ePrometheus\u4e0d\u540c\u7684\u65b9\u6cd5\uff0cPrometheus\u5c06\u8fd9\u4e9b\u7c7b\u578b\u7684\u8981\u6c42\u7f16\u7801\u5230\u6307\u6807\u7684\u547d\u540d\u89c4\u5219\u4e2d\u3002</p> <p>\u5728OpenTelemetry\u4e2d\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u4e00\u4e2aAsynchronous Gauge\uff0c\u4f60\u4e0d\u80fd\u50cf\u4f7f\u7528\u5176\u4ed6\u6307\u6807\u7c7b\u578b\u90a3\u6837\u5bf9\u5176\u8fdb\u884c\u6c47\u603b\u3002</p> <p>\u4e0e\u6240\u6709\u7684\u5f02\u6b65Instrument\u4e00\u6837\uff0c\u5728\u521b\u5efa\u5f02\u6b65Instrument\u65f6\uff0c\u9700\u8981\u4f20\u9012\u4e00\u4e2a\u56de\u8c03\uff0c\u5b83\u53ef\u4ee5\u8fd4\u56de\u4e00\u4e2a\u6216\u591a\u4e2a\uff08\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u662f\u5b8c\u5168\u79bb\u6563\u7684\uff09\u6d4b\u91cf\u503c\u3002</p> <p>\u5728Python\u4e2d\uff0c\u521b\u5efa\u548c\u4f7f\u7528Asynchronous Gauge\u7684\u4f8b\u5b50\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>from opentelemetry._metrics import get_meter_provider\nfrom opentelemetry._metrics.observation import Observation\n\nmeter = get_meter_provider().get_meter(\"otel-demo\")\n\n# Callback function for Async gauge\ndef observable_gauge_func() -&gt; [Observation]:\n    # This reports that the current value is 10\n    return [Observation(10, {\"app\": \"timescale\"})]\n\n# Async Gauge, note the observable prefix\nobservable_gauge = meter.create_observable_gauge(\n    \"observable_gauge\", [observable_gauge_func]\n)\n</code></pre>"},{"location":"chap13/4OpenTelemetry/#4-viewsaggregations","title":"4 Views\u548cAggregations","text":"<p>OpenTelemetry\u4e2d\u7684View\u5b9a\u4e49\u4e86\u4e00\u4e2aAggregation\u64cd\u4f5c\uff0c\u5b83\u63a5\u53d7\u4e00\u7cfb\u5217\u7684Measurements\uff0c\u5e76\u5728\u8be5\u65f6\u95f4\u70b9\u4e0a\u5c06\u5176\u8868\u8fbe\u4e3a\u4e00\u4e2a\u5355\u4e00\u7684\u6307\u6807\u503c\u3002</p> <p>\u968f\u7740\u66f4\u591a\u7684Measurements\u88ab\u521b\u5efa\uff0c\u6307\u6807\u7684\u503c\u4f1a\u88ab\u6301\u7eed\u66f4\u65b0\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u4e3a\u4e00\u4e2aInstrument\u521b\u5efaView\uff0c\u90a3\u4e48\u5c31\u4f1a\u6839\u636eInstrument\u7c7b\u578b\u9009\u62e9\u4e00\u4e2a\u9ed8\u8ba4\u7684Aggregation\u3002</p> <p>\u81ea\u5b9a\u4e49View\u53ef\u4ee5\u901a\u8fc7Meter\u540d\u79f0\u3001Instrument\u540d\u79f0\u3001Instrument\u7c7b\u578b\u6216\u901a\u914d\u7b26\u6765\u5b9a\u4f4d\u3002</p> <p>\u5728OpenTelemetry\u4e2d\uff0c\u6709\u4e09\u79cdAggregation\u7c7b\u578b\uff1a</p> <ul> <li>Sum Aggregation\uff1a\u7b80\u5355\u5730\u8ddf\u8e2a\u4f20\u5165\u7684\u6d4b\u91cf\u503c\u7684\u603b\u548c\uff08\u5c0a\u91cd\u8f93\u5165Instrument\u7684\u5355\u8c03\u6027\uff09\uff0c</li> <li>Last Value Aggregation\uff1a\u8ddf\u8e2a\u6700\u540e\u62a5\u544a\u7684\u503c\uff0c</li> <li>Explicit Bucket Histogram Aggregation\uff1a\u8ddf\u8e2a\u5c5e\u4e8e\u6bcf\u4e2a\u9884\u5b9a\u4e49\u6876\uff08\u5fc5\u987b\u5728\u521b\u5efaView\u65f6\u9884\u5b9a\u4e49\uff09\u7684\u6d4b\u91cf\u6570\u91cf\uff0c\u5e76\u53ef\u4ee5\u8ddf\u8e2a\u6700\u5c0f\u548c\u6700\u5927\u503c\u3002</li> </ul> <p>\u4e0b\u8868\u5b9a\u4e49\u4e86\u6bcf\u79cdOpenTelemetry Instrument\u7c7b\u578b\u7684\u9ed8\u8ba4Aggregation\uff1a</p> <p></p> <p>\u8fd9\u6bb5Python\u4ee3\u7801\u4f7f\u7528ConsoleMetricExporter\u5199\u5165\u63a7\u5236\u53f0\uff0c\u4e5f\u6539\u53d8\u4e86\u6240\u6709\u67f1\u72b6\u56feInstrument\u7684\u6876\u72b6\u7ed3\u6784\uff1a</p> <pre><code>from opentelemetry._metrics import get_meter_provider, set_meter_provider\nfrom opentelemetry.sdk._metrics import MeterProvider\nfrom opentelemetry.sdk._metrics.export import PeriodicExportingMetricReader\nfrom opentelemetry.sdk._metrics.export import ConsoleMetricExporter\nfrom opentelemetry.sdk._metrics.aggregation import ExplicitBucketHistogramAggregation\n\nexporter = ConsoleMetricExporter()\nreader = PeriodicExportingMetricReader(exporter)\nprovider = MeterProvider(\n    metric_readers=[reader],\n    views=[View(\n        instrument_name=\"*\u201d,\n        aggregation=ExplicitBucketHistogramAggregation(\n            (1,20,50,100,1000)\n    ))],\n)\nset_meter_provider(provider)\n</code></pre>"},{"location":"chap13/4OpenTelemetry/#_1","title":"\u603b\u7ed3","text":"<p>OpenTelemetry\u6807\u51c6\uff0c\u91cd\u70b9\u662f\u5b83\u7684\u516d\u79cdInstrument\u7c7b\u578b\uff1acounters\u3001asynchronous counters\u3001UpDownCounters\u3001asynchronous UpDownCounters\u3001histograms\u548casynchronous gauges\u3002</p>"},{"location":"chap13/4OpenTelemetry_tracing/","title":"\u4f7f\u7528 OpenTelemetry Tracing \u6700\u5927\u5316 Kubernetes \u6548\u7387","text":"<p>OpenTelemetry \u662f\u4e00\u79cd\u5f00\u6e90\u7684\u53ef\u89c2\u6d4b\u6027\u6846\u67b6\uff0c\u63d0\u4f9b\u4e00\u7ec4 API \u548c\u5e93\uff0c\u7528\u4e8e\u6536\u96c6\u3001\u5904\u7406\u548c\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\uff0c\u5982\u8ffd\u8e2a\u3001\u6307\u6807\u548c\u65e5\u5fd7\u3002</p> <p>\u5b83\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u4ee5\u6700\u5c0f\u7684\u5f00\u9500\u6765\u68c0\u6d4b\u4ed6\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5e76\u63d0\u4f9b\u4e00\u79cd\u6536\u96c6\u548c\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\u7684\u6807\u51c6\u5316\u65b9\u6cd5\u3002</p> <p>\u5728 Kubernetes \u73af\u5883\u4e2d\uff0c\u7531\u4e8e\u5176\u590d\u6742\u548c\u52a8\u6001\u7684\u7279\u6027\uff0c\u5982\u679c\u6ca1\u6709\u9002\u5f53\u7684\u53ef\u89c2\u6d4b\u6027\u5de5\u5177\uff0c\u5f88\u96be\u8bc6\u522b\u6027\u80fd\u95ee\u9898\u548c\u74f6\u9888\u3002</p>"},{"location":"chap13/4OpenTelemetry_tracing/#kubernetes","title":"\u7406\u89e3 Kubernetes \u4e2d\u7684\u8ffd\u8e2a","text":"<p>\u8ffd\u8e2a\u662f\u901a\u8fc7\u6355\u83b7\u548c\u5b58\u50a8\u6709\u5173\u5355\u4e2a\u8bf7\u6c42\u5728\u7cfb\u7edf\u4e2d\u79fb\u52a8\u7684\u8be6\u7ec6\u4fe1\u606f\u6765\u5de5\u4f5c\u7684\u3002\u8fd9\u5305\u62ec\u6709\u5173\u8bf7\u6c42\u5904\u7406\u6240\u9700\u65f6\u95f4\u3001\u5904\u7406\u8bf7\u6c42\u6240\u6d89\u53ca\u7684\u7ec4\u4ef6\u4ee5\u53ca\u6cbf\u9014\u53d1\u751f\u7684\u4efb\u4f55\u9519\u8bef\u7684\u4fe1\u606f\u3002</p> <p>\u7136\u540e\u5bf9\u6b64\u4fe1\u606f\u8fdb\u884c\u805a\u5408\u548c\u5206\u6790\uff0c\u4ee5\u8bc6\u522b\u6a21\u5f0f\u548c\u8d8b\u52bf\uff0c\u5e2e\u52a9\u5f00\u53d1\u4eba\u5458\u548c DevOps \u56e2\u961f\u4f18\u5316\u5e94\u7528\u7a0b\u5e8f\u7684\u6027\u80fd\u3002</p> <p>\u7136\u800c\uff0c\u5728 Kubernetes \u7f16\u6392\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u8fdb\u884c\u8ffd\u8e2a\u53ef\u80fd\u662f\u5177\u6709\u6311\u6218\u6027\u7684\u3002\u5206\u5e03\u5f0f\u7cfb\u7edf\u672c\u8d28\u4e0a\u662f\u590d\u6742\u7684\uff0c\u8bf7\u6c42\u901a\u8fc7\u591a\u4e2a\u7ec4\u4ef6\u8def\u7531\uff0c\u6bcf\u4e2a\u7ec4\u4ef6\u5728\u4e0d\u540c\u7684\u8282\u70b9\u6216 Pod \u4e0a\u8fd0\u884c\uff0c\u8fd9\u4f7f\u5f97\u83b7\u53d6\u6709\u5173\u8bf7\u6c42\u5728\u7cfb\u7edf\u4e2d\u5982\u4f55\u6d41\u52a8\u7684\u5b8c\u6574\u56fe\u50cf\u53d8\u5f97\u56f0\u96be\u3002</p> <p>\u6b64\u5916\uff0c\u4e0d\u540c\u7684\u7ec4\u4ef6\u53ef\u80fd\u4f7f\u7528\u4e0d\u540c\u7684\u8ffd\u8e2a\u6846\u67b6\uff0c\u8fd9\u4f7f\u5f97\u5728\u5b83\u4eec\u4e4b\u95f4\u8fdb\u884c\u5173\u8054\u4fe1\u606f\u53d8\u5f97\u56f0\u96be\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u6311\u6218\uff0c\u5f00\u53d1\u4e86\u8bf8\u5982 OpenTelemetry \u4e4b\u7c7b\u7684\u5de5\u5177\uff0c\u4ee5\u63d0\u4f9b\u5728 Kubernetes \u4e2d\u8de8\u4e0d\u540c\u7ec4\u4ef6\u548c\u6846\u67b6\u6355\u83b7\u548c\u5173\u8054\u8ffd\u8e2a\u4fe1\u606f\u7684\u6807\u51c6\u5316\u65b9\u5f0f\u3002</p>"},{"location":"chap13/4OpenTelemetry_tracing/#opentelemetry","title":"OpenTelemetry \u8ffd\u8e2a\u7684\u4f18\u52bf","text":"<p>OpenTelemetry \u4e3a Kubernetes \u8ffd\u8e2a\u63d0\u4f9b\u4e86\u591a\u79cd\u7279\u6027\u548c\u4f18\u52bf\uff0c\u5305\u62ec\uff1a</p> <ol> <li>\u4eea\u8868\u5316\u5e93\uff1aOTEL \u63d0\u4f9b\u4e86\u591a\u79cd\u8bed\u8a00\u7279\u5b9a\u7684\u5e93\uff0c\u5141\u8bb8\u8f7b\u677e\u4eea\u8868\u5316\u5728 Kubernetes \u4e2d\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u786e\u4fdd\u6536\u96c6\u6240\u6709\u76f8\u5173\u7684\u9065\u6d4b\u6570\u636e\u3002</li> <li>\u6807\u51c6\u5316API\uff1a\u9065\u6d4b\u6570\u636e\u7684\u4e00\u81f4 API \u5141\u8bb8\u4e0e\u5404\u79cd\u8ffd\u8e2a\u548c\u76d1\u6d4b\u5de5\u5177\u8f7b\u677e\u96c6\u6210</li> <li>\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1a\u8fd9\u4e9b\u529f\u80fd\u5141\u8bb8\u5728 Kubernetes \u73af\u5883\u4e2d\u8ffd\u8e2a\u8de8\u591a\u4e2a\u670d\u52a1\u7684\u8bf7\u6c42\uff0c\u63d0\u4f9b\u6709\u5173\u8bf7\u6c42\u5904\u7406\u65b9\u5f0f\u7684\u89c1\u89e3\uff0c\u5e76\u8bc6\u522b\u6f5c\u5728\u7684\u74f6\u9888\u3002</li> <li>\u4f9b\u5e94\u5546\u65e0\u5173\uff1aOpenTelemetry \u662f\u4f9b\u5e94\u5546\u4e2d\u7acb\u7684\uff0c\u5e76\u53ef\u4ee5\u4e0e\u5404\u79cd\u8ffd\u8e2a\u548c\u76d1\u6d4b\u5e73\u53f0\u96c6\u6210\uff0c\u63d0\u4f9b\u7075\u6d3b\u6027\u5e76\u907f\u514d\u4f9b\u5e94\u5546\u9501\u5b9a\u3002</li> </ol> <p>OTEL \u53ef\u4ee5\u4e0e\u6d41\u884c\u7684 Kubernetes \u5de5\u5177\u548c\u5e73\u53f0\u96c6\u6210\uff0c\u5982 Prometheus\u3001Jaeger \u548c Grafana\u3002</p> <p>\u4f8b\u5982\uff0cOpenTelemetry Collector \u53ef\u7528\u4e8e\u6536\u96c6\u548c\u5bfc\u51fa\u5230 Prometheus \u7684\u9065\u6d4b\u6570\u636e\uff0c\u800c Jaeger \u548c Grafana \u540e\u7aef\u53ef\u7528\u4e8e\u53ef\u89c6\u5316\u548c\u5206\u6790\u7531 OTEL \u6536\u96c6\u7684\u8ffd\u8e2a\u6570\u636e\u3002</p> <p>\u6b64\u5916\uff0cOpenTelemetry \u8fd8\u53ef\u4ee5\u901a\u8fc7 OpenTelemetry Operator \u4e0e Kubernetes \u96c6\u6210\uff0c\u63d0\u4f9b\u4e00\u79cd\u65e0\u7f1d\u7684\u65b9\u5f0f\u6765\u90e8\u7f72\u548c\u7ba1\u7406 Kubernetes \u96c6\u7fa4\u4e2d\u7684OTEL\u7ec4\u4ef6\u3002</p>"},{"location":"chap13/4OpenTelemetry_tracing/#kubernetes-otel","title":"\u5728 Kubernetes \u4e2d\u5b9e\u73b0 OTEL \u8ffd\u8e2a","text":"<p>\u5728 Kubernetes \u4e2d\u5b9e\u73b0 OTEL \u8ffd\u8e2a\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6b65\u9aa4\u5b9e\u73b0\uff1a</p> <ol> <li>\u5b89\u88c5 OpenTelemetry Collector\uff1a\u9996\u5148\uff0c\u60a8\u9700\u8981\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5 OpenTelemetry Collector\u3002\u53ef\u4ee5\u4f7f\u7528\u5404\u79cd\u65b9\u6cd5\u6765\u5b8c\u6210\u6b64\u4efb\u52a1\uff0c\u5305\u62ec Helm\u3001Kubernetes \u6e05\u5355\u6216 Operator\u3002</li> <li>\u914d\u7f6e\u6536\u96c6\u5668\uff1a\u4e00\u65e6\u5b89\u88c5\u4e86\u6536\u96c6\u5668\uff0c\u60a8\u9700\u8981\u914d\u7f6e\u5b83\u4ee5\u4ece\u5e94\u7528\u7a0b\u5e8f\u6536\u96c6\u8ffd\u8e2a\uff0c\u5e76\u5c06\u5176\u53d1\u9001\u5230\u60a8\u9996\u9009\u7684\u8ffd\u8e2a\u540e\u7aef\u3002<ul> <li>\u8fd9\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u5b8c\u6210\uff0c\u8be5\u6587\u4ef6\u6307\u5b9a\u6240\u9700\u7684 exporters\u3001receivers \u548c processors\u3002</li> </ul> </li> </ol> <p>\u4ee5\u4e0b\u662f\u7528\u4e8e\u8ffd\u8e2a\u7684\u57fa\u672c OpenTelemetry Collector \u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\uff1a</p> <pre><code>receivers:\n otlp:\n  protocols:\n   grpc:\n\nexporters:\n jaeger:\n  endpoint: &lt;jaeger-endpoint&gt;\n  insecure: true\n\nprocessors:\n batch:\n\nextensions:\n health_check:\n\nservice:\n pipelines:\n  traces:\n   receivers: [otlp]\n   processors: [batch]\n   exporters: [jaeger]\n</code></pre> <p>\u8bf7\u6ce8\u610f\uff0c\u6b64\u793a\u4f8b\u4f7f\u7528 OTLP \u4f5c\u4e3a\u63a5\u6536\u5668\uff0c\u5e76\u4f7f\u7528 gRPC \u534f\u8bae\u8fdb\u884c\u901a\u4fe1\u3002\u5b83\u4f7f\u7528 Jaeger \u4f5c\u4e3a exporter\uff0c\u5e76\u6307\u5b9a\u4e86 endpoint \u548c insecure \u9009\u9879\u3002\u5b83\u8fd8\u4f7f\u7528\u4e86 batch processor\uff0c\u5e76\u542f\u7528\u4e86 <code>health_check</code>\u6269\u5c55\u7a0b\u5e8f\u3002</p> <p>\u6700\u540e\uff0c\u5b83\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7ba1\u9053\uff0c\u8be5\u7ba1\u9053\u5c06 OTLP \u63a5\u6536\u5668\u3001\u6279\u5904\u7406\u5668\u548cJaeger exporter \u94fe\u63a5\u5728\u4e00\u8d77\u4ee5\u6536\u96c6\u8ffd\u8e2a\u6570\u636e\u3002</p> <p>3 \u68c0\u6d4b\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\uff1a\u914d\u7f6e\u6536\u96c6\u5668\u540e\uff0c\u60a8\u9700\u8981\u4f7f\u7528 OpenTelemetry SDK \u6216\u517c\u5bb9\u7684\u8ffd\u8e2a\u5e93\u6765\u68c0\u6d4b\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee5\u751f\u6210\u8ffd\u8e2a\u3002\u8fd9\u6d89\u53ca\u5c06\u4ee3\u7801\u6dfb\u52a0\u5230\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee5\u521b\u5efa\u8de8\u5ea6\u5e76\u5c06\u5b83\u4eec\u9644\u52a0\u5230\u8ffd\u8e2a\u4e0a\u4e0b\u6587\u3002</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u793a\u4f8b\uff0c\u8bf4\u660e\u5982\u4f55\u4f7f\u7528 OpenTelemetry SDK \u68c0\u6d4b\u4e00\u4e2a\u7b80\u5355\u7684 Go \u5e94\u7528\u7a0b\u5e8f\u3002</p> <pre><code>package main\n\nimport (\n \"context\"\n\n \"go.opentelemetry.io/otel\"\n \"go.opentelemetry.io/otel/trace\"\n\n)\n\n\nfunc main() {\n      // Create a tracer provider with the default configuration\n      provider := otel.GetTracerProvider()\n\n      // Get a tracer instance from the provider\n      tracer := provider.Tracer(\"my-app\")\n\n      // Create a span\n      ctx, span := tracer.Start(context.Background(), \"my-span\")\n      defer span.End()\n\n      // Do some work\n}\n</code></pre> <p>\u5728\u6b64\u793a\u4f8b\u4e2d\uff0cOpenTelemetry SDK \u7528\u4e8e\u521b\u5efa\u8ffd\u8e2a\u5668\u63d0\u4f9b\u7a0b\u5e8f\u548c\u8ffd\u8e2a\u5668\u5b9e\u4f8b\u3002\u7136\u540e\u521b\u5efa\u4e00\u4e2a Span\uff0c\u5e76\u5728\u8be5 Span \u7684\u4e0a\u4e0b\u6587\u4e2d\u6267\u884c\u5de5\u4f5c\u3002\u9a8c\u8bc1\u8ffd\u8e2a\u662f\u5426\u5df2\u53d1\u9001\u5230\u540e\u7aef\u3002</p> <p>\u6700\u540e\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u540e\u7aef\u63d0\u4f9b\u7684\u8ffd\u8e2a UI \u9a8c\u8bc1\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u751f\u6210\u8ffd\u8e2a\u5e76\u5c06\u5b83\u4eec\u53d1\u9001\u5230\u540e\u7aef\u3002\u8fd9\u4f7f\u60a8\u53ef\u4ee5\u53ef\u89c6\u5316\u8ffd\u8e2a\u5e76\u8bc6\u522b\u6027\u80fd\u74f6\u9888\u548c\u5176\u4ed6\u95ee\u9898\u3002</p>"},{"location":"chap13/4OpenTelemetry_tracing/#opentelemetry-kubernetes","title":"\u4f7f\u7528 OpenTelemetry \u4e0e Kubernetes \u7684\u6700\u4f73\u5b9e\u8df5","text":"<p>\u4ee5\u4e0b\u662f\u4f7f\u7528 OpenTelemetry \u4e0e Kubernetes \u6700\u4f73\u5b9e\u8df5\u7684\u4e00\u4e9b\u5efa\u8bae\u548c\u6280\u5de7\uff0c\u4ee5\u6700\u5927\u5316\u8ffd\u8e2a\u6548\u7387\u548c\u51c6\u786e\u6027\u3002</p> <p>\u9996\u5148\u8981\u6e05\u695a\u4e86\u89e3\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u67b6\u6784\u3002\u5f00\u59cb\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b9e\u73b0 OpenTelemetry \u8ffd\u8e2a\u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u60a8\u5145\u5206\u4e86\u89e3\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u67b6\u6784\uff0c\u5305\u62ec\u5176\u5fae\u670d\u52a1\u3001API\u548c\u4f9d\u8d56\u5173\u7cfb\u3002\u8fd9\u5c06\u5e2e\u52a9\u60a8\u786e\u5b9a\u8ffd\u8e2a\u6700\u91cd\u8981\u7684\u5173\u952e\u9886\u57df\u4ee5\u53ca\u5e94\u8be5\u96c6\u4e2d\u7cbe\u529b\u7684\u5730\u65b9\u3002</p> <p>\u4e3a\u60a8\u7684\u8ffd\u8e2a\u5de5\u4f5c\u5b9a\u4e49\u660e\u786e\u7684\u76ee\u6807\u3002\u786e\u5b9a\u60a8\u60f3\u8981\u901a\u8fc7\u8ffd\u8e2a\u5de5\u4f5c\u5b9e\u73b0\u7684\u76ee\u6807\uff0c\u4f8b\u5982\u8bc6\u522b\u6027\u80fd\u74f6\u9888\u6216\u76d1\u89c6\u670d\u52a1\u5065\u5eb7\u72b6\u51b5\u3002\u8fd9\u5c06\u5e2e\u52a9\u60a8\u5b9a\u4e49\u60a8\u7684\u8ffd\u8e2a\u4eea\u5668\u7b56\u7565\u5e76\u9009\u62e9\u6b63\u786e\u7684\u8ffd\u8e2a\u540e\u7aef\u3002</p> <p>\u9075\u5faaOTEL\u6700\u4f73\u5b9e\u8df5\u3002\u4e3a\u786e\u4fdd\u60a8\u7684\u8ffd\u8e2a\u5de5\u4f5c\u80fd\u591f\u53d6\u5f97\u6700\u4f73\u7ed3\u679c\uff0c\u8bf7\u9075\u5faa OpenTelemetry \u63a8\u8350\u7684\u6700\u4f73\u5b9e\u8df5\uff0c\u4f8b\u5982\u4f7f\u7528\u8bed\u4e49\u7ea6\u5b9a\u8fdb\u884c\u8ffd\u8e2a\u5c5e\u6027\uff0c\u5e76\u907f\u514d\u8fc7\u5ea6\u4eea\u5668\u5316\u3002</p> <p>\u5728\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6808\u4e0a\u5b9e\u73b0\u5206\u5e03\u5f0f\u8ffd\u8e2a\u3002\u4e3a\u4e86\u5168\u9762\u4e86\u89e3\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\uff0c\u4f7f\u7528\u5206\u5e03\u5f0f\u8ffd\u8e2a\u8986\u76d6\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6808\uff0c\u5305\u62ec\u6240\u6709\u5fae\u670d\u52a1\u3001API\u548c\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p>\u9009\u62e9\u9002\u5408\u60a8\u9700\u6c42\u7684\u6b63\u786e\u8ffd\u8e2a\u540e\u7aef\u3002\u9009\u62e9\u9002\u5408\u60a8\u9700\u6c42\u5e76\u63d0\u4f9b\u6240\u9700\u529f\u80fd\u7684\u8ffd\u8e2a\u540e\u7aef\u3002\u53ef\u9009\u9879\u5305\u62ec Jaeger\u3001Zipkin \u548c Amazon Web Services X-Ray\u3002</p> <p>\u5b9a\u671f\u76d1\u89c6\u548c\u5206\u6790\u60a8\u7684\u8ffd\u8e2a\u6570\u636e\u3002\u4f7f\u7528 OpenTelemetry \u6536\u96c6\u7684\u8ffd\u8e2a\u6570\u636e\u5b9a\u671f\u76d1\u89c6\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\uff1b\u5206\u6790\u6570\u636e\u4ee5\u786e\u5b9a\u6539\u8fdb\u7684\u9886\u57df\u3002</p>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/","title":"\u7b2c\u4e00\u8282 Centos7 Prometheus\u5b89\u88c5\u90e8\u7f72+\u76d1\u63a7+\u7ed8\u56fe+\u544a\u8b66","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#1","title":"1 \u51c6\u5907","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#1-1","title":"1-1 \u90e8\u7f72\u67b6\u6784\u56fe","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#1-2","title":"1-2 \u51c6\u5907\u673a\u5668","text":"<pre><code>master machine: 192.168.33.10\n\n$ cat /etc/os-release\nNAME=\"CentOS Linux\"\nVERSION=\"7 (Core)\"\nID=\"centos\"\nID_LIKE=\"rhel fedora\"\nVERSION_ID=\"7\"\nPRETTY_NAME=\"CentOS Linux 7 (Core)\"\nANSI_COLOR=\"0;31\"\nCPE_NAME=\"cpe:/o:centos:centos:7\"\nHOME_URL=\"https://www.centos.org/\"\nBUG_REPORT_URL=\"https://bugs.centos.org/\"\n\nCENTOS_MANTISBT_PROJECT=\"CentOS-7\"\nCENTOS_MANTISBT_PROJECT_VERSION=\"7\"\nREDHAT_SUPPORT_PRODUCT=\"centos\"\nREDHAT_SUPPORT_PRODUCT_VERSION=\"7\"\n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#2","title":"2 \u5b89\u88c5\u90e8\u5206","text":"<p>\u5728\u5b98\u7f51\u4e0b\u8f7d\u5bf9\u5e94\u7684\u538b\u7f29\u5305\u6587\u4ef6\uff0c\u89e3\u538b\u3001\u6dfb\u52a0\u7cfb\u7edf\u670d\u52a1\u5668\u3001\u542f\u52a8\u3002</p>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#2-1-node_exporter","title":"2-1 <code>Node_exporter</code>","text":"<pre><code>$ wget https://github.com/prometheus/node_exporter/releases/download/v0.18.1/node_exporter-0.18.1.linux-amd64.tar.gz\n$ sudo tar zxf node_exporter-0.18.1.linux-amd64.tar.gz -C /usr/local\n$ sudo vim /etc/systemd/system/node_exporter.service\n</code></pre> <pre><code>[Unit]\nDescription=node_exporter\nAfter=network.target\n\n[Service]\nRestart=on-failure\nExecStart=/usr/local/node_exporter-0.18.1.linux-amd64/node_exporter\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <pre><code>$ sudo systemctl start node_exporter\n$ systemctl status node_exporter\n$ sudo systemctl enable node_exporter\n</code></pre> <pre><code>$ systemctl status node_exporter\n\u25cf node_exporter.service - node_exporter\n   Loaded: loaded (/etc/systemd/system/node_exporter.service; enabled; vendor preset: disabled)\n   Active: active (running) since Sun 2019-06-23 07:56:53 UTC; 6min ago\n Main PID: 7492 (node_exporter)\n   CGroup: /system.slice/node_exporter.service\n           \u2514\u25007492 /usr/local/node_exporter-0.18.1.linux-amd64/node_exporter\n</code></pre> <p>\u9a8c\u8bc1</p> <p></p>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#2-alertmanager","title":"2 AlertManager","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#2-1","title":"2-1 \u5b89\u88c5\u547d\u4ee4","text":"<pre><code>$ wget https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz\n$ sudo tar zxf alertmanager-0.17.0.linux-amd64.tar.gz  -C /usr/local\n$ sudo vim /etc/systemd/system/alertmanager.service\n</code></pre> <pre><code>[Unit]\nDescription=Alertmanager\nAfter=network-online.target\n\n[Service]\nRestart=on-failure\nExecStart=/usr/local/alertmanager-0.17.0.linux-amd64/alertmanager --config.file=/usr/local/alertmanager-0.17.0.linux-amd64/alertmanager.yml\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <pre><code>$ sudo systemctl start alertmanager\n$ systemctl status alertmanager\n$ sudo systemctl enable alertmanager\n\n$ netstat -anlpt | grep 9093\ntcp        0      0 192.168.33.10:39518     192.168.33.10:9093      ESTABLISHED -\ntcp6       0      0 :::9093                 :::*                    LISTEN      -\n</code></pre> <pre><code>$ systemctl status alertmanager\n\u25cf alertmanager.service - Alertmanager\n   Loaded: loaded (/etc/systemd/system/alertmanager.service; enabled; vendor preset: disabled)\n   Active: active (running) since Sun 2019-06-23 07:50:39 UTC; 22min ago\n Main PID: 7404 (alertmanager)\n   CGroup: /system.slice/alertmanager.service\n           \u2514\u25007404 /usr/local/alertmanager-0.17.0.linux-amd64/alertmanager --config.file=/usr/local/alertmanager-0.17.0.linux-amd64/alertmanager.yml\n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#2-2","title":"2-2 \u9a8c\u8bc1","text":"<pre><code>192.168.33.10:9093 \n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#3-prometheus","title":"3 Prometheus","text":"<pre><code>$ wget https://github.com/prometheus/prometheus/releases/download/v2.10.0/prometheus-2.10.0.linux-amd64.tar.gz\n$ sudo tar zxf prometheus-2.9.2.linux-amd64.tar.gz -C /usr/local\n$ sudo vim /etc/systemd/system/prometheus.service\n</code></pre> <pre><code>[Unit]\nDescription=Prometheus Server\nDocumentation=https://prometheus.io/docs/introduction/overview/\nAfter=network-online.target\n\n[Service]\nRestart=on-failure\nExecStart=/usr/local/prometheus-2.10.0.linux-amd64/prometheus --config.file=/usr/local/prometheus-2.10.0.linux-amd64/prometheus.yml --storage.tsdb.path=/var/lib/prometheus --web.external-url=http://0.0.0.0:9090\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <pre><code>$ sudo systemctl start prometheus\n$ systemctl status prometheus\n$ sudo systemctl enable prometheus\n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#4-grafana","title":"4 Grafana","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#4-1","title":"4-1 \u5b89\u88c5","text":"<pre><code>$ wget https://mirrors.tuna.tsinghua.edu.cn/grafana/yum/el7/grafana-5.4.2-1.x86_64.rpm\n$ sudo yum install initscripts fontconfig\n$ sudo yum install -y urw-fonts\n</code></pre> <ul> <li>\u7f3a\u5c11 <code>urw-fonts</code></li> <li><code>initscripts fontconfig</code></li> </ul> <pre><code>$ rpm -ivh grafana-5.4.2-1.x86_64.rpm\n\n$ sudo systemctl start grafana-server\n$ systemctl status grafana-server\n$ systemctl enable grafana-server\n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#4-2","title":"4-2 \u9a8c\u8bc1","text":"<pre><code>$ sudo vim /etc/grafana/grafana.ini\n/security\n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#5","title":"5 \u914d\u7f6e\u90e8\u5206","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#5-1-alertmanager","title":"5-1 AlertManager","text":"<ul> <li>\u914d\u7f6e\u6587\u4ef6</li> </ul> <pre><code>global:\n  resolve_timeout: 5m\n  smtp_smarthost: 'smtp-mail.outlook.com:587'\n  smtp_from: 'xichao2015@outlook.com'\n  smtp_auth_username: '###'\n  smtp_auth_password: '###'\n  smtp_require_tls: false\n\nroute:\n  group_by: ['alertname']\n  group_wait: 10s\n  group_interval: 10s\n  repeat_interval: 1h\n  receiver: 'toemail'\nreceivers:\n- name: 'toemail'\n  email_configs:\n  - to: 'jacob.xi@sap.com'\n    send_resolved: true\n- name: 'web.hook'\n  webhook_configs:\n  - url: 'http://192.168.33.10:5001/'\ninhibit_rules:\n  - source_match:\n      severity: 'critical'\n    target_match:\n      severity: 'warning'\n    equal: ['alertname', 'dev', 'instance']\n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#5-2-prometheus","title":"5-2 Prometheus","text":"<pre><code>$ sudo vim /usr/local/prometheus-2.10.0.linux-amd64/prometheus.yml\n</code></pre> <pre><code># my global config\nglobal:\n  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets:\n       - 192.168.33.10:9093\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  - \"rules/host_rules.yml\"\n  # - \"first_rules.yml\"\n  # - \"second_rules.yml\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.\n  - job_name: 'prometheus'\n\n    # metrics_path defaults to '/metrics'\n    # scheme defaults to 'http'.\n    scrape_interval: 5s\n    static_configs:\n    - targets: ['192.168.33.10:9090']\n  - job_name: 'my target'\n    static_configs:\n    - targets: ['192.168.33.10:9100']\n</code></pre> <pre><code>$ cd /usr/local/prometheus-2.10.0.linux-amd64\n$ sudo mkdir {configs,rules}\n$ sudo vim host_rules.yml\n\ngroups:\n- name: 'Linux Instances'\n  rules:\n  - alert: InstanceDown\n    expr: up == 0\n    for: 5s\n    labels:\n      severity: page\n    # Prometheus templates apply here in the annotation and label fields of the alert.\n    #     annotations:\n    #           description: '{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 s.'\n</code></pre> <pre><code>$ sudo systemctl restart prometheus\n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#6","title":"6 \u9a8c\u8bc1","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#6-1","title":"6-1 \u67e5\u770b\u76ee\u6807","text":"<pre><code>Prometheus  =&gt;  status =&gt; rules\n</code></pre> <pre><code>Prometheus  =&gt;  Alerts\n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#6-2","title":"6-2 \u67e5\u770b\u76d1\u63a7\u6570\u636e","text":"<p><code>https://grafana.com/dashboards/9276</code></p> <p>Import Data sources</p> <p></p> <p>Import Dashboard</p> <p><code>https://grafana.com/dashboards/9276</code> </p> <p></p>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#7","title":"7 \u544a\u8b66","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#7-1-node_exporter","title":"7-1 \u6a21\u62df<code>node_exporter</code>\u5b95\u673a","text":"<pre><code>$ sudo systemctl stop node_exporter\n</code></pre>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#_1","title":"\u67e5\u770b\u90ae\u7bb1\u6536\u4ef6\u7bb1","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#7-2","title":"7-2 \u53c2\u8003\u6587\u7ae0","text":"<p><code>https://www.jianshu.com/p/e59cfd15612e</code></p>"},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#8","title":"8 \u62a5\u9519","text":""},{"location":"chap2/19centos7_Prometheus_Alertmanager_Grafana/#grafana-showing-no-data-points","title":"Grafana showing No data points","text":"<pre><code>We need sync datetime\n</code></pre> <pre><code>$ sudo reboot\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/","title":"\u7b2c\u4e09\u8282 \u57fa\u4e8ePrometheus\u6784\u5efaMySQL\u53ef\u89c6\u5316\u76d1\u63a7\u5e73\u53f0","text":"<p>\u9009\u578b\u662f<code>Prometheus + Grafana</code>\u7684\u5b9e\u73b0\u65b9\u5f0f\u3002\u7b80\u800c\u8a00\u4e4b\u5c31\u662f\u6211\u73b0\u5728\u7684\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u7684\u662f<code>Prometheus</code>\uff0c\u8fd8\u6709\u5c31\u662f<code>Grafana</code>\u6ee1\u8db3\u7684\u6211\u7684\u65e5\u5e38\u5de5\u4f5c\u9700\u8981\u3002</p> <p>\u9996\u5148\u770b\u4e0b\u6211\u4eec\u7684\u76d1\u63a7\u6548\u679c\u3001MySQL\u4e3b\u4ece\uff1a</p> <p></p> <p>MySQL\u72b6\u6001\uff1a </p> <p></p> <p>\u7f13\u51b2\u6c60\u72b6\u6001\uff1a</p> <p></p>"},{"location":"chap2/36Prometheus_Mysql/#1-exporter","title":"1 exporter \u76f8\u5173\u90e8\u7f72","text":""},{"location":"chap2/36Prometheus_Mysql/#1-1-exporter","title":"1-1 \u5b89\u88c5exporter","text":"<pre><code>$ https://github.com/prometheus/mysqld_exporter/releases/download/v0.10.0/mysqld_exporter-0.10.0.linux-amd64.tar.gz\n$  tar -xf mysqld_exporter-0.10.0.linux-amd64.tar.gz \n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#1-2-mysql","title":"1-2 \u6dfb\u52a0mysql \u8d26\u6237\uff1a","text":"<pre><code>GRANT SELECT, PROCESS, SUPER, REPLICATION CLIENT, RELOAD ON *.* TO 'exporter'@'%' IDENTIFIED BY 'localhost';\nflush privileges;\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#1-3","title":"1-3 \u7f16\u8f91\u914d\u7f6e\u6587\u4ef6\uff1a","text":"<pre><code>mysqld_exporter-0.10.0.linux-amd64# cat /opt/mysqld_exporter-0.10.0.linux-amd64/.my.cnf \n[client]\nuser=exporter\npassword=123456\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#1-4","title":"1-4 \u8bbe\u7f6e\u914d\u7f6e\u6587\u4ef6\uff1a","text":"<pre><code># cat /etc/systemd/system/mysql_exporter.service \n[Unit]\nDescription=mysql Monitoring System\nDocumentation=mysql Monitoring System\n\n[Service]\nExecStart=/opt/mysqld_exporter-0.10.0.linux-amd64/mysqld_exporter \\\n         -collect.info_schema.processlist \\\n         -collect.info_schema.innodb_tablespaces \\\n         -collect.info_schema.innodb_metrics  \\\n         -collect.perf_schema.tableiowaits \\\n         -collect.perf_schema.indexiowaits \\\n         -collect.perf_schema.tablelocks \\\n         -collect.engine_innodb_status \\\n         -collect.perf_schema.file_events \\\n         -collect.info_schema.processlist \\\n         -collect.binlog_size \\\n         -collect.info_schema.clientstats \\\n         -collect.perf_schema.eventswaits \\\n         -config.my-cnf=/opt/mysqld_exporter-0.10.0.linux-amd64/.my.cnf\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#1-5-prometheus-server","title":"1-5 \u6dfb\u52a0\u914d\u7f6e\u5230prometheus server","text":"<pre><code>- job_name: 'mysql'\nstatic_configs:\n  - targets: ['192.168.1.11:9104','192.168.1.12:9104']\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#1-6","title":"1-6 \u6d4b\u8bd5\u770b\u6709\u6ca1\u6709\u8fd4\u56de\u6570\u503c","text":"<p><code>http://192.168.1.12:9104/metrics</code></p> <p>\u6b63\u5e38\u6211\u4eec\u901a\u8fc7<code>mysql_up</code>\u53ef\u4ee5\u67e5\u8be2\u5012mysql\u76d1\u63a7\u662f\u5426\u5df2\u7ecf\u751f\u6548\uff0c\u662f\u5426\u8d77\u8d77\u6765</p> <pre><code>#HELP mysql_up Whether the MySQL server is up.\n#TYPE mysql_up gauge\nmysql_up 1\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#2","title":"2 \u76d1\u63a7\u76f8\u5173\u6307\u6807","text":"<p>\u5728\u505a\u4efb\u4f55\u4e00\u4e2a\u4e1c\u897f\u76d1\u63a7\u7684\u65f6\u5019\uff0c\u6211\u4eec\u8981\u65f6\u523b\u660e\u767d\u6211\u4eec\u8981\u76d1\u63a7\u7684\u662f\u4ec0\u4e48\uff0c\u6307\u6807\u662f\u5565\u624d\u80fd\u66f4\u597d\u7684\u53bb\u76d1\u63a7\u6211\u4eec\u7684\u670d\u52a1\uff0c\u5728mysql\u91cc\u9762\u6211\u4eec\u901a\u5e38\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e0b\u6307\u6807\u53bb\u8861\u91cf<code>mysql</code>\u7684\u8fd0\u884c\u60c5\u51b5\uff1a</p> <ul> <li>mysql\u4e3b\u4ece\u8fd0\u884c\u60c5\u51b5\u3001</li> <li>\u67e5\u8be2\u541e\u5410\u91cf\u3001</li> <li>\u6162\u67e5\u8be2\u60c5\u51b5\u3001</li> <li>\u8fde\u63a5\u6570\u60c5\u51b5\u3001</li> <li>\u7f13\u51b2\u6c60\u4f7f\u7528\u60c5\u51b5\u4ee5\u53ca\u67e5\u8be2\u6267\u884c\u6027\u80fd\u7b49\u3002</li> </ul>"},{"location":"chap2/36Prometheus_Mysql/#2-1","title":"2-1 \u4e3b\u4ece\u590d\u5236\u8fd0\u884c\u6307\u6807","text":"<p>1\u3001\u4e3b\u4ece\u590d\u5236\u7ebf\u7a0b\u76d1\u63a7\uff1a</p> <p>\u5927\u90e8\u5206\u60c5\u51b5\u4e0b\uff0c\u5f88\u591a\u4f01\u4e1a\u4f7f\u7528\u7684\u90fd\u662f\u4e3b\u4ece\u590d\u5236\u7684\u73af\u5883\uff0c\u76d1\u63a7\u4e24\u4e2a\u7ebf\u7a0b\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u5728mysql\u91cc\u9762\u6211\u4eec\u901a\u5e38\u662f\u901a\u8fc7\u547d\u4ee4\uff1a</p> <pre><code>MariaDB [(none)]&gt; show slave status\\G;\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: 172.16.1.1\n                  Master_User: repl\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000045\n          Read_Master_Log_Pos: 72904854\n               Relay_Log_File: mariadb-relay-bin.000127\n                Relay_Log_Pos: 72905142\n        Relay_Master_Log_File: mysql-bin.000045\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n</code></pre> <ul> <li><code>#Slave_IO_Running</code>\u3001<code>Slave_SQL_Running</code>\u4e24\u4e2a\u7ebf\u7a0b\u6b63\u5e38\u90a3\u4e48\u8bf4\u660e\u6211\u4eec\u7684\u590d\u5236\u96c6\u7fa4\u662f\u5065\u5eb7\u72b6\u6001\u7684\u3002</li> <li><code>MySQLD Exporter</code>\u4e2d\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\u901a\u8fc7<code>mysql_slave_status_slave_sql_running</code>\u6765\u83b7\u53d6\u4e3b\u4ece\u96c6\u7fa4\u7684\u5065\u5eb7\u72b6\u51b5\u3002</li> </ul> <pre><code># HELP mysql_slave_status_slave_sql_running Generic metric from SHOW SLAVE STATUS.\n# TYPE mysql_slave_status_slave_sql_running untyped\nmysql_slave_status_slave_sql_running{channel_name=\"\",connection_name=\"\",master_host=\"172.16.1.1\",master_uuid=\"\"} 1\n</code></pre> <p>2\u3001\u4e3b\u4ece\u590d\u5236\u843d\u540e\u65f6\u95f4\uff1a</p> <p>\u5728\u4f7f\u7528<code>show slave status</code> \u91cc\u9762\u8fd8\u6709\u4e00\u4e2a\u5173\u952e\u7684\u53c2\u6570<code>Seconds_Behind_Master</code>\u3002</p> <p><code>Seconds_Behind_Master</code>\u8868\u793a<code>slave</code>\u4e0a<code>SQL thread</code>\u4e0e<code>IO thread</code>\u4e4b\u95f4\u7684\u5ef6\u8fdf\uff0c\u6211\u4eec\u90fd\u77e5\u9053\u5728<code>MySQL</code>\u7684\u590d\u5236\u73af\u5883\u4e2d\uff0c<code>slave</code>\u5148\u4ece<code>master</code>\u4e0a\u5c06<code>binlog</code>\u62c9\u53d6\u5230\u672c\u5730\uff08\u901a\u8fc7IO thread\uff09\uff0c\u7136\u540e\u901a\u8fc7<code>SQL thread</code>\u5c06<code>binlog</code>\u91cd\u653e, \u800c<code>Seconds_Behind_Master</code>\u8868\u793a\u672c\u5730<code>relaylog</code>\u4e2d\u672a\u88ab\u6267\u884c\u5b8c\u7684\u90a3\u90e8\u5206\u7684\u5dee\u503c\u3002</p> <p>\u6240\u4ee5\u5982\u679c<code>slave</code>\u62c9\u53d6\u5230\u672c\u5730\u7684<code>relaylog</code>\uff08\u5b9e\u9645\u4e0a\u5c31\u662f<code>binlog</code>\uff0c\u53ea\u662f\u5728<code>slave</code>\u4e0a\u4e60\u60ef\u79f0\u547c<code>relaylog</code>\u800c\u5df2\uff09\u90fd\u6267\u884c\u5b8c\uff0c\u6b64\u65f6\u901a\u8fc7<code>show slave status</code>\u770b\u5230\u7684\u4f1a\u662f<code>0</code></p> <p><code>Seconds_Behind_Master: 0</code></p> <ul> <li><code>MySQLD Exporter</code>\u4e2d\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\u901a\u8fc7<code>mysql_slave_status_seconds_behind_master</code>\u6765\u83b7\u53d6\u76f8\u5173\u72b6\u6001\u3002</li> </ul> <pre><code># HELP mysql_slave_status_seconds_behind_master Generic metric from SHOW SLAVE STATUS.\n# TYPE mysql_slave_status_seconds_behind_master untyped\nmysql_slave_status_seconds_behind_master{channel_name=\"\",connection_name=\"\",master_host=\"172.16.1.1\",master_uuid=\"\"} 0\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#3","title":"3 \u67e5\u8be2\u541e\u5410\u91cf","text":"<p>\u8bf4\u5230\u541e\u5410\u91cf\uff0c\u90a3\u4e48\u6211\u4eec\u5982\u4f55\u4ece\u90a3\u65b9\u9762\u6765\u8861\u91cf\u5462\uff1f \u901a\u5e38\u6765\u8bf4\u6211\u4eec\u53ef\u4ee5\u6839\u636emysql \u7684\u63d2\u5165\u3001\u67e5\u8be2\u3001\u5220\u9664\u3001\u66f4\u65b0\u7b49\u64cd\u4f5c\u6765</p> <p>\u4e3a\u4e86\u83b7\u53d6\u541e\u5410\u91cf\uff0c<code>MySQL</code> \u6709\u4e00\u4e2a\u540d\u4e3a <code>Questions</code> \u7684\u5185\u90e8\u8ba1\u6570\u5668\uff08\u6839\u636e <code>MySQL</code>\u7528\u8bed\uff0c\u8fd9\u662f\u4e00\u4e2a\u670d\u52a1\u5668\u72b6\u6001\u53d8\u91cf\uff09\uff0c\u5ba2\u6237\u7aef\u6bcf\u53d1\u9001\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\uff0c\u5176\u503c\u5c31\u4f1a\u52a0\u4e00\u3002\u7531 <code>Questions</code>\u6307\u6807\u5e26\u6765\u7684\u4ee5\u5ba2\u6237\u7aef\u4e3a\u4e2d\u5fc3\u7684\u89c6\u89d2\u5e38\u5e38\u6bd4\u76f8\u5173\u7684<code>Queries</code> \u8ba1\u6570\u5668\u66f4\u5bb9\u6613\u89e3\u91ca\u3002</p> <p>\u4f5c\u4e3a\u5b58\u50a8\u7a0b\u5e8f\u7684\u4e00\u90e8\u5206\uff0c\u540e\u8005\u4e5f\u4f1a\u8ba1\u7b97\u5df2\u6267\u884c\u8bed\u53e5\u7684\u6570\u91cf\uff0c\u4ee5\u53ca\u8bf8\u5982<code>PREPARE</code> \u548c <code>DEALLOCATE PREPARE</code> \u6307\u4ee4\u8fd0\u884c\u7684\u6b21\u6570\uff0c\u4f5c\u4e3a\u670d\u52a1\u5668\u7aef\u9884\u5904\u7406\u8bed\u53e5\u7684\u4e00\u90e8\u5206\u3002\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\u6765\u67e5\u8be2\uff1a</p> <pre><code>MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE \"Questions\";\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| Questions     | 15071 |\n+---------------+-------+\n</code></pre> <p><code>MySQLD Exporter</code>\u4e2d\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\u901a\u8fc7<code>mysql_global_status_questions</code>\u53cd\u6620\u5f53\u524d<code>Questions</code>\u8ba1\u6570\u5668\u7684\u5927\u5c0f\uff1a</p> <pre><code># HELP mysql_global_status_questions Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_questions untyped\nmysql_global_status_questions 13253\n</code></pre> <p>\u5f53\u7136\u7531\u4e8eprometheus \u5177\u6709\u975e\u5e38\u4e30\u5bcc\u7684\u67e5\u8be2\u8bed\u8a00\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u7d2f\u52a0\u7684\u8ba1\u6570\u5668\u6765\u67e5\u8be2\u67d0\u4e00\u77ed\u65f6\u95f4\u5185\u7684\u67e5\u8be2\u589e\u957f\u7387\u60c5\u51b5\uff0c\u53ef\u4ee5\u505a\u76f8\u5173\u7684\u9608\u503c\u544a\u8b66\u5904\u7406\u3001\u4f8b\u5982\u4e00\u4e0b\u67e5\u8be22\u5206\u949f\u65f6\u95f4\u5185\u7684\u67e5\u8be2\u60c5\u51b5\uff1a</p> <pre><code>rate(mysql_global_status_questions[2m])\n</code></pre> <p>\u5f53\u7136\u4e0a\u9762\u662f\u603b\u91cf\uff0c\u6211\u4eec\u53ef\u4ee5\u5206\u522b\u4ece\u76d1\u63a7\u8bfb\u3001\u5199\u6307\u4ee4\u7684\u5206\u89e3\u60c5\u51b5\uff0c\u4ece\u800c\u66f4\u597d\u5730\u7406\u89e3\u6570\u636e\u5e93\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3001\u627e\u5230\u53ef\u80fd\u7684\u74f6\u9888\u3002\u901a\u5e38\uff0c\u901a\u5e38\uff0c\u8bfb\u53d6\u67e5\u8be2\u4f1a\u7531 <code>Com_select</code> \u6307\u6807\u6293\u53d6\uff0c\u800c\u5199\u5165\u67e5\u8be2\u5219\u53ef\u80fd\u589e\u52a0\u4e09\u4e2a\u72b6\u6001\u53d8\u91cf\u4e2d\u67d0\u4e00\u4e2a\u7684\u503c\uff0c\u8fd9\u53d6\u51b3\u4e8e\u5177\u4f53\u7684\u6307\u4ee4\uff1a</p> <pre><code>Writes = Com_insert + Com_update + Com_delete\n</code></pre> <p>\u4e0b\u9762\u6211\u4eec\u901a\u8fc7\u547d\u4ee4\u83b7\u53d6\u63d2\u5165\u7684\u60c5\u51b5\uff1a</p> <pre><code>MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE \"Com_insert\";\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| Com_insert    | 10578 |\n+---------------+-------+\n</code></pre> <p>\u4ece<code>MySQLD Exporter</code>\u7684<code>/metrics</code>\u8fd4\u56de\u7684\u76d1\u63a7\u6837\u672c\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7<code>global_status_commands_total</code>\u83b7\u53d6\u5f53\u524d\u5b9e\u4f8b\u5404\u7c7b\u6307\u4ee4\u6267\u884c\u7684\u6b21\u6570\uff1a</p> <pre><code># HELP mysql_global_status_commands_total Total number of executed MySQL commands.\n# TYPE mysql_global_status_commands_total counter\nmysql_global_status_commands_total{command=\"create_trigger\"} 0\nmysql_global_status_commands_total{command=\"create_udf\"} 0\nmysql_global_status_commands_total{command=\"create_user\"} 1\nmysql_global_status_commands_total{command=\"create_view\"} 0\nmysql_global_status_commands_total{command=\"dealloc_sql\"} 0\nmysql_global_status_commands_total{command=\"delete\"} 3369\nmysql_global_status_commands_total{command=\"delete_multi\"} 0\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#4","title":"4 \u6162\u67e5\u8be2\u6027\u80fd","text":"<p>\u67e5\u8be2\u6027\u80fd\u65b9\u9762\uff0c\u6162\u67e5\u8be2\u4e5f\u662f\u67e5\u8be2\u544a\u8b66\u7684\u4e00\u4e2a\u91cd\u8981\u7684\u6307\u6807\u3002<code>MySQL</code>\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a<code>Slow_queries</code>\u7684\u8ba1\u6570\u5668\uff0c\u5f53\u67e5\u8be2\u7684\u6267\u884c\u65f6\u95f4\u8d85\u8fc7<code>long_query_time</code>\u7684\u503c\u540e\uff0c\u8ba1\u6570\u5668\u5c31\u4f1a<code>+1</code>\uff0c\u5176\u9ed8\u8ba4\u503c\u4e3a<code>10</code>\u79d2\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u5728<code>MySQL</code>\u4e2d\u67e5\u8be2\u5f53\u524d<code>long_query_time</code>\u7684\u8bbe\u7f6e\uff1a</p> <pre><code>MariaDB [(none)]&gt; SHOW VARIABLES LIKE 'long_query_time';\n+-----------------+-----------+\n| Variable_name   | Value     |\n+-----------------+-----------+\n| long_query_time | 10.000000 |\n+-----------------+-----------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u4fee\u6539\u65f6\u95f4</p> <pre><code>MariaDB [(none)]&gt; SET GLOBAL long_query_time = 5;\nQuery OK, 0 rows affected (0.00 sec)\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u800c\u5df2\u901a\u8fc7sql\u8bed\u8a00\u67e5\u8be2MySQL\u5b9e\u4f8b\u4e2d<code>Slow_queries</code>\u7684\u6570\u91cf\uff1a</p> <pre><code>MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE \"Slow_queries\";\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| Slow_queries  | 0     |\n+---------------+-------+\n1 row in set (0.00 sec)\n</code></pre> <p><code>MySQLD Exporter</code>\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\uff0c\u901a\u8fc7<code>mysql_global_status_slow_queries</code>\u6307\u6807\u5c55\u793a\u5f53\u524d\u7684<code>Slow_queries</code>\u7684\u503c\uff1a</p> <pre><code># HELP mysql_global_status_slow_queries Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_slow_queries untyped\nmysql_global_status_slow_queries 0\n</code></pre> <p>\u540c\u6837\u7684\uff0c\u66f4\u5177\u6839\u636ePrometheus \u6162\u67e5\u8be2\u8bed\u53e5\u6211\u4eec\u4e5f\u53ef\u4ee5\u67e5\u8be2\u5012\u4ed6\u67d0\u6bb5\u65f6\u95f4\u5185\u7684\u589e\u957f\u7387\uff1a</p> <pre><code>rate(mysql_global_status_slow_queries[5m])\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#5","title":"5 \u8fde\u63a5\u6570\u76d1\u63a7","text":"<p>\u76d1\u63a7\u5ba2\u6237\u7aef\u8fde\u63a5\u60c5\u51b5\u76f8\u5f53\u91cd\u8981\uff0c\u56e0\u4e3a\u4e00\u65e6\u53ef\u7528\u8fde\u63a5\u8017\u5c3d\uff0c\u65b0\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u5c31\u4f1a\u906d\u5230\u62d2\u7edd\u3002MySQL \u9ed8\u8ba4\u7684\u8fde\u63a5\u6570\u9650\u5236\u4e3a <code>151</code>\u3002</p> <pre><code>MariaDB [(none)]&gt; SHOW VARIABLES LIKE 'max_connections';\n+-----------------+-------+\n| Variable_name   | Value |\n+-----------------+-------+\n| max_connections | 151   |\n+-----------------+-------+\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u7684\u5f62\u5f0f\u6765\u589e\u52a0\u8fd9\u4e2a\u6570\u503c\u3002\u4e0e\u4e4b\u5bf9\u5e94\u7684\u5c31\u662f\u5f53\u524d\u8fde\u63a5\u6570\u91cf\uff0c\u5f53\u6211\u4eec\u5f53\u524d\u8fde\u63a5\u51fa\u6765\u8d85\u8fc7\u7cfb\u7edf\u8bbe\u7f6e\u7684\u6700\u5927\u503c\u4e4b\u540e\u5e38\u4f1a\u51fa\u73b0\u6211\u4eec\u770b\u5230\u7684<code>Too many connections</code>(\u8fde\u63a5\u6570\u8fc7\u591a)\uff0c\u4e0b\u9762\u6211\u67e5\u627e\u4e00\u4e0b\u5f53\u524d\u8fde\u63a5\u6570\uff1a</p> <pre><code>MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE \"Threads_connected\";\n+-------------------+-------+\n| Variable_name     | Value |\n+-------------------+-------+\n| Threads_connected | 41     |\n+-------------------+-------\n</code></pre> <p>\u5f53\u7136<code>mysql</code> \u8fd8\u63d0\u4f9b<code>Threads_running</code> \u8fd9\u4e2a\u6307\u6807\uff0c\u5e2e\u52a9\u4f60\u5206\u9694\u5728\u4efb\u610f\u65f6\u95f4\u6b63\u5728\u79ef\u6781\u5904\u7406\u67e5\u8be2\u7684\u7ebf\u7a0b\u4e0e\u90a3\u4e9b\u867d\u7136\u53ef\u7528\u4f46\u662f\u95f2\u7f6e\u7684\u8fde\u63a5\u3002</p> <pre><code>MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE \"Threads_running\";\n+-----------------+-------+\n| Variable_name   | Value |\n+-----------------+-------+\n| Threads_running | 10     |\n+-----------------+-------+\n</code></pre> <p>\u5982\u679c\u670d\u52a1\u5668\u771f\u7684\u8fbe\u5230 <code>max_connections</code>\u9650\u5236\uff0c\u5b83\u5c31\u4f1a\u5f00\u59cb\u62d2\u7edd\u65b0\u7684\u8fde\u63a5\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c<code>Connection_errors_max_connections</code> \u6307\u6807\u5c31\u4f1a\u5f00\u59cb\u589e\u52a0\uff0c\u540c\u65f6\uff0c\u8ffd\u8e2a\u6240\u6709\u5931\u8d25\u8fde\u63a5\u5c1d\u8bd5\u7684<code>Aborted_connects</code> \u6307\u6807\u4e5f\u4f1a\u5f00\u59cb\u589e\u52a0\u3002</p> <p><code>MySQLD Exporter</code>\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d:</p> <pre><code># HELP mysql_global_variables_max_connections Generic gauge metric from SHOW GLOBAL VARIABLES.\n# TYPE mysql_global_variables_max_connections gauge\nmysql_global_variables_max_connections 151     \n</code></pre> <p>\u8868\u793a\u6700\u5927\u8fde\u63a5\u6570</p> <pre><code># HELP mysql_global_status_threads_connected Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_threads_connected untyped\nmysql_global_status_threads_connected 41\n</code></pre> <p>\u8868\u793a\u5f53\u524d\u7684\u8fde\u63a5\u6570</p> <pre><code># HELP mysql_global_status_threads_running Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_threads_running untyped\nmysql_global_status_threads_running 1\n</code></pre> <p>\u8868\u793a\u5f53\u524d\u6d3b\u8dc3\u7684\u8fde\u63a5\u6570</p> <pre><code># HELP mysql_global_status_aborted_connects Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_aborted_connects untyped\nmysql_global_status_aborted_connects 31\n</code></pre> <p>\u7d2f\u8ba1\u6240\u6709\u7684\u8fde\u63a5\u6570</p> <pre><code># HELP mysql_global_status_connection_errors_total Total number of MySQL connection errors.\n# TYPE mysql_global_status_connection_errors_total counter\nmysql_global_status_connection_errors_total{error=\"internal\"} 0\n#\u670d\u52a1\u5668\u5185\u90e8\u5f15\u8d77\u7684\u9519\u8bef\u3001\u5982\u5185\u5b58\u786c\u76d8\u7b49\nmysql_global_status_connection_errors_total{error=\"max_connections\"} 0\n#\u8d85\u51fa\u8fde\u63a5\u5904\u5f15\u8d77\u7684\u9519\u8bef\n</code></pre> <p>\u5f53\u7136\u6839\u636e<code>prom</code>\u8868\u8fbe\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u5f53\u524d\u5269\u4f59\u53ef\u7528\u7684\u8fde\u63a5\u6570\uff1a</p> <pre><code>mysql_global_variables_max_connections - mysql_global_status_threads_connected\n</code></pre> <p>\u67e5\u8be2<code>mysql</code>\u62d2\u7edd\u8fde\u63a5\u6570</p> <pre><code>mysql_global_status_aborted_connects\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#6","title":"6 \u7f13\u51b2\u6c60\u60c5\u51b5\uff1a","text":"<p><code>MySQL</code> \u9ed8\u8ba4\u7684\u5b58\u50a8\u5f15\u64ce <code>InnoDB</code> \u4f7f\u7528\u4e86\u4e00\u7247\u79f0\u4e3a\u7f13\u51b2\u6c60\u7684\u5185\u5b58\u533a\u57df\uff0c\u7528\u4e8e\u7f13\u5b58\u6570\u636e\u8868\u4e0e\u7d22\u5f15\u7684\u6570\u636e\u3002\u7f13\u51b2\u6c60\u6307\u6807\u5c5e\u4e8e\u8d44\u6e90\u6307\u6807\uff0c\u800c\u975e\u5de5\u4f5c\u6307\u6807\uff0c\u524d\u8005\u66f4\u591a\u5730\u7528\u4e8e\u8c03\u67e5\uff08\u800c\u975e\u68c0\u6d4b\uff09\u6027\u80fd\u95ee\u9898\u3002\u5982\u679c\u6570\u636e\u5e93\u6027\u80fd\u5f00\u59cb\u4e0b\u6ed1\uff0c\u800c\u78c1\u76d8<code>I/O</code> \u5728\u4e0d\u65ad\u6500\u5347\uff0c\u6269\u5927\u7f13\u51b2\u6c60\u5f80\u5f80\u80fd\u5e26\u6765\u6027\u80fd\u56de\u5347\u3002</p> <p>\u9ed8\u8ba4\u8bbe\u7f6e\u4e0b\uff0c\u7f13\u51b2\u6c60\u7684\u5927\u5c0f\u901a\u5e38\u76f8\u5bf9\u8f83\u5c0f\uff0c\u4e3a <code>128MiB</code>\u3002\u4e0d\u8fc7\uff0c<code>MySQL</code> \u5efa\u8bae\u53ef\u5c06\u5176\u6269\u5927\u81f3\u4e13\u7528\u6570\u636e\u5e93\u670d\u52a1\u5668\u7269\u7406\u5185\u5b58\u7684 <code>80%</code> \u5927\u5c0f\u3002\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e00\u4e0b\uff1a</p> <pre><code>MariaDB [(none)]&gt; show global variables like 'innodb_buffer_pool_size';\n+-------------------------+-----------+\n| Variable_name           | Value     |\n+-------------------------+-----------+\n| innodb_buffer_pool_size | 134217728 |\n+-------------------------+-----------+\n</code></pre> <p><code>MySQLD Exporter</code>\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\uff0c\u4f7f\u7528<code>mysql_global_variables_innodb_buffer_pool_size</code>\u6765\u8868\u793a\u3002</p> <pre><code># HELP mysql_global_variables_innodb_buffer_pool_size Generic gauge metric from SHOW GLOBAL VARIABLES.\n# TYPE mysql_global_variables_innodb_buffer_pool_size gauge\nmysql_global_variables_innodb_buffer_pool_size 1.34217728e+08\n\nInnodb_buffer_pool_read_requests\u8bb0\u5f55\u4e86\u6b63\u5e38\u4ece\u7f13\u51b2\u6c60\u8bfb\u53d6\u6570\u636e\u7684\u8bf7\u6c42\u6570\u91cf\u3002\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6307\u4ee4\u67e5\u770b\n\nMariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE \"Innodb_buffer_pool_read_requests\";\n+----------------------------------+-------------+\n| Variable_name                    | Value       |\n+----------------------------------+-------------+\n| Innodb_buffer_pool_read_requests | 38465 |\n+----------------------------------+-------------+\n</code></pre> <p><code>MySQLD Exporter</code>\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\uff0c\u4f7f\u7528<code>mysql_global_status_innodb_buffer_pool_read_requests</code>\u6765\u8868\u793a</p> <pre><code># HELP mysql_global_status_innodb_buffer_pool_read_requests Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_innodb_buffer_pool_read_requests untyped\nmysql_global_status_innodb_buffer_pool_read_requests 2.7711547168e+10\n</code></pre> <p>\u5f53\u7f13\u51b2\u6c60\u65e0\u6cd5\u6ee1\u8db3\u65f6\uff0c<code>MySQL</code>\u53ea\u80fd\u4ece\u78c1\u76d8\u4e2d\u8bfb\u53d6\u6570\u636e\u3002<code>Innodb_buffer_pool_reads</code>\u5373\u8bb0\u5f55\u4e86\u4ece\u78c1\u76d8\u8bfb\u53d6\u6570\u636e\u7684\u8bf7\u6c42\u6570\u91cf\u3002\u901a\u5e38\u6765\u8bf4\u4ece\u5185\u5b58\u4e2d\u8bfb\u53d6\u6570\u636e\u7684\u901f\u5ea6\u8981\u6bd4\u4ece\u78c1\u76d8\u4e2d\u8bfb\u53d6\u5feb\u5f88\u591a\uff0c\u56e0\u6b64\uff0c\u5982\u679c<code>Innodb_buffer_pool_reads</code>\u7684\u503c\u5f00\u59cb\u589e\u52a0\uff0c\u53ef\u80fd\u610f\u5473\u7740\u6570\u636e\u5e93\u7684\u6027\u80fd\u6709\u95ee\u9898\u3002 \u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u53ea\u80fd\u67e5\u770b<code>Innodb_buffer_pool_reads</code>\u7684\u6570\u91cf</p> <pre><code>MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE \"Innodb_buffer_pool_reads\";\n+--------------------------+-------+\n| Variable_name            | Value |\n+--------------------------+-------+\n| Innodb_buffer_pool_reads | 138  |\n+--------------------------+-------+\n1 row in set (0.00 sec)\n</code></pre> <p>MySQLD Exporter\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u4e2d\uff0c\u4f7f\u7528<code>mysql_global_status_innodb_buffer_pool_read_requests</code>\u6765\u8868\u793a\u3002</p> <pre><code># HELP mysql_global_status_innodb_buffer_pool_reads Generic metric from SHOW GLOBAL STATUS.\n# TYPE mysql_global_status_innodb_buffer_pool_reads untyped\nmysql_global_status_innodb_buffer_pool_reads 138\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0a\u76d1\u63a7\u6307\u6807\uff0c\u4ee5\u53ca\u5b9e\u9645\u76d1\u63a7\u7684\u573a\u666f\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528<code>PromQL</code>\u5feb\u901f\u5efa\u7acb\u591a\u4e2a\u76d1\u63a7\u9879\u3002\u53ef\u4ee5\u67e5\u770b\u4e24\u5206\u949f\u5185\u8bfb\u53d6\u78c1\u76d8\u7684\u589e\u957f\u7387\u7684\u589e\u957f\u7387\uff1a</p> <pre><code>rate(mysql_global_status_innodb_buffer_pool_reads[2m])\n</code></pre>"},{"location":"chap2/36Prometheus_Mysql/#7-id","title":"7 \u5b98\u65b9\u6a21\u677fID","text":"<p>\u4e0a\u9762\u662f\u6211\u4eec\u7b80\u5355\u5217\u4e3e\u7684\u4e00\u4e9b\u6307\u6807\uff0c\u4e0b\u9762\u6211\u4eec\u4f7f\u7528granafa\u7ed9<code>MySQLD_Exporter</code>\u6dfb\u52a0\u76d1\u63a7\u56fe\u8868\uff1a</p> <ul> <li>\u4e3b\u4ece\u4e3b\u7fa4\u76d1\u63a7(\u6a21\u677f7371)\uff1a</li> <li>\u76f8\u5173mysql \u72b6\u6001\u76d1\u63a77362\uff1a</li> <li>\u7f13\u51b2\u6c60\u72b6\u60017365\uff1a</li> </ul>"},{"location":"chap2/36Prometheus_Mysql/#7-1","title":"7-1 \u7b80\u5355\u7684\u544a\u8b66\u89c4\u5219","text":"<p>\u9664\u4e86\u76f8\u5173\u6a21\u677f\u4e4b\u5916\uff0c\u6ca1\u6709\u544a\u8b66\u89c4\u5219\u90a3\u4e48\u6211\u4eec\u7684\u76d1\u63a7\u5c31\u662f\u4e0d\u5b8c\u7f8e\u7684\uff0c\u4e0b\u9762\u5217\u4e00\u4e0b\u6211\u4eec\u7684\u76d1\u63a7\u544a\u8b66\u89c4\u5219</p> <pre><code>groups:\n- name: MySQL-rules\n  rules:\n  - alert: MySQL Status \n    expr: up == 0\n    for: 5s \n    labels:\n      severity: warning\n    annotations:\n      summary: \"{{$labels.instance}}: MySQL has stop !!!\"\n      description: \"\u68c0\u6d4bMySQL\u6570\u636e\u5e93\u8fd0\u884c\u72b6\u6001\"\n\n  - alert: MySQL Slave IO Thread Status\n    expr: mysql_slave_status_slave_io_running == 0\n    for: 5s \n    labels:\n      severity: warning\n    annotations: \n      summary: \"{{$labels.instance}}: MySQL Slave IO Thread has stop !!!\"\n      description: \"\u68c0\u6d4bMySQL\u4e3b\u4eceIO\u7ebf\u7a0b\u8fd0\u884c\u72b6\u6001\"\n\n  - alert: MySQL Slave SQL Thread Status \n    expr: mysql_slave_status_slave_sql_running == 0\n    for: 5s \n    labels:\n      severity: warning\n    annotations: \n      summary: \"{{$labels.instance}}: MySQL Slave SQL Thread has stop !!!\"\n      description: \"\u68c0\u6d4bMySQL\u4e3b\u4eceSQL\u7ebf\u7a0b\u8fd0\u884c\u72b6\u6001\"\n\n  - alert: MySQL Slave Delay Status \n    expr: mysql_slave_status_sql_delay == 30\n    for: 5s \n    labels:\n      severity: warning\n    annotations: \n      summary: \"{{$labels.instance}}: MySQL Slave Delay has more than 30s !!!\"\n      description: \"\u68c0\u6d4bMySQL\u4e3b\u4ece\u5ef6\u65f6\u72b6\u6001\"\n\n  - alert: Mysql_Too_Many_Connections\n    expr: rate(mysql_global_status_threads_connected[5m]) &gt; 200\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"{{$labels.instance}}: \u8fde\u63a5\u6570\u8fc7\u591a\"\n      description: \"{{$labels.instance}}: \u8fde\u63a5\u6570\u8fc7\u591a\uff0c\u8bf7\u5904\u7406 ,(current value is: {{ $value }})\"  \n\n  - alert: Mysql_Too_Many_slow_queries\n    expr: rate(mysql_global_status_slow_queries[5m]) &gt; 3\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: \"{{$labels.instance}}: \u6162\u67e5\u8be2\u6709\u70b9\u591a\uff0c\u8bf7\u68c0\u67e5\u5904\u7406\"\n      description: \"{{$labels.instance}}: Mysql slow_queries is more than 3 per second ,(current value is: {{ $value }})\"\n</code></pre> <p>2.\u6dfb\u52a0\u89c4\u5219\u5230prometheus\uff1a</p> <pre><code>rule_files:\n  - \"rules/*.yml\" \n</code></pre> <p>3.\u6253\u5f00web ui\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u89c4\u5219\u751f\u6548\u4e86\uff1a</p> <p></p>"},{"location":"chap2/4mysql_exporter/","title":"\u7b2c\u56db\u8282 \u5b98\u65b9 <code>mysqld_exporter</code>\u652f\u6301\u6293\u53d6\u591aMySQL\u5b9e\u4f8b","text":"<p>\u76ee\u524d\u5b98\u65b9\u4ee3\u7801\u4ed3\u5e93\u5df2\u7ecf\u652f\u6301\u4e86 1 \u4e2a mysqld_exporter \u76d1\u63a7\u591a\u4e2a mysql \u5b9e\u4f8b(1:n)\uff0c\u8be6\u7ec6\u7684\u53ef\u4ee5\u53bb\u770b\u5b98\u65b9\u7684\u4ee3\u7801\u4ed3\u5e93\uff0c\u4f46\u662f\u76ee\u524d\u5c1a\u672a\u53d1\u73b0\u5b98\u65b9\u53d1\u5e03 release\uff0c\u53ef\u7b49\u5f85\u5b98\u65b9\u53d1\u5e03</p>"},{"location":"chap2/4mysql_exporter/#_1","title":"\u90e8\u7f72","text":"<p>\u9047\u5230\u95ee\u9898\uff0c\u8bb0\u5f97\u591a\u770b\u65e5\u5fd7\u3001\u591a\u68c0\u67e5\u6587\u4ef6\u914d\u7f6e\u3001\u68c0\u67e5\u7f51\u7edc\u95ee\u9898</p>"},{"location":"chap2/4mysql_exporter/#_2","title":"\u6388\u6743","text":"<pre><code>\n#\u6ce8\u610f\u4fee\u6539\u6388\u6743\u7684\u7f51\u6bb5\nCREATE USER 'mysqld_exporter'@'192.168.1.%' IDENTIFIED BY 'cccc' WITH MAX_USER_CONNECTIONS 3;\nGRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'mysqld_exporter'@'192.168.1.%';\nflush privileges;\n</code></pre> <p>\u6b64\u5904\u53ef\u4ee5\u5728\u6240\u6709\u73af\u5883\u7684\u5b9e\u4f8b\u4e2d\u521b\u5efa\u300c\u76f8\u540c\u300d\u7684 mysqld_exporter \u76d1\u63a7\u8d26\u53f7\u548c\u5bc6\u7801\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\uff0c\u5f53\u8ba4\u8bc1\u7684\u5bc6\u7801\u4e0d\u4e00\u6837\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b98\u65b9\u63d0\u793a\u7684\u914d\u7f6e\u6587\u4ef6\u914d\u7f6e\u5373\u53ef\u3002</p>"},{"location":"chap2/4mysql_exporter/#_3","title":"\u51c6\u5907\u914d\u7f6e\u6587\u4ef6","text":"<p><code>config.my-cnf</code></p> <p>\u6b64\u6587\u4ef6\u9075\u5faa <code>.ini</code>\u683c\u5f0f\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u4e0d\u540c\u7684\u76d1\u63a7\u8d26\u53f7\uff0c\u4f60\u53ef\u4ee5\u5728\u8be5\u914d\u7f6e\u6587\u4ef6\u4e2d\u589e\u52a0\u4e0d\u540c\u9879</p> <pre><code>[client]\nuser=mysqld_exporter\npassword=***************\n[client-hb2]\nuser=monitor\npassword=***************\n[client-hd]\nuser=monitor_hd\npassword=***************\n</code></pre> <p>\u6ce8\u610f\uff0c\u5982\u679c\u6709\u4e0d\u540c\u7684\u76d1\u63a7\u8d26\u53f7\uff0c\u8bb0\u5f97\u5728\u5411 consul \u4e2d\u6ce8\u518c mysql \u5b9e\u4f8b\u7684\u65f6\u5019\uff0c\u8bb0\u5f97\u4fee\u6539 <code>auth_module</code>\u7684\u5143\u6570\u636e\u7684\u503c</p> <p><code>docker-compose.yaml</code></p> <pre><code>version: '3'\nservices:\n  mysqld_exporter:\n    image: xx/mysqld_exporter:v1\n    restart: always\n    hostname: mysqld_exporter\n    ports:\n      - 10002:9104\n    volumes:\n      - ${PWD}/config.my-cnf:/config.my-cnf\n      - /usr/share/zoneinfo/PRC:/etc/localtime\n    command:\n      - \"--config.my-cnf=/config.my-cnf\"\n      - \"--collect.binlog_size\"\n      - \"--collect.info_schema.replica_host\"\n    container_name: mysqld-exporter\n</code></pre> <p>\u56e0\u4e3a\u5b98\u65b9\u6ca1\u6709\u53d1\u5e03 release,\u56e0\u6b64\u9700\u8981\u81ea\u5df1\u62c9\u53d6\u4ee3\u7801\u4ed3\u5e93\uff0c\u8fdb\u884c\u7f16\u8bd1\u5373\u53ef</p> <ul> <li>\u7f16\u8bd1 <code>mysqld_exporter</code> \u4e8c\u8fdb\u5236</li> </ul> <pre><code>git clone https://github.com/prometheus/mysqld_exporter.git &amp;&amp; cd mysqld_exporter\ngo mod download &amp;&amp; GOOS=linux CGO_ENABLED=0 go build -ldflags=\"-s -w\" -installsuffix cgo -o mysqld_exporter .\n# \u6d4b\u8bd5\n./mysqld_exporter --config.my-cnf=./config.my-cnf --collect.binlog_size --collect.info_schema.replica_host --web.listen-address=192.168.20.161:10002\n</code></pre> <ul> <li>\u5c01\u88c5\u955c\u50cf Dockerfile</li> </ul> <p>\u53ef\u4ee5\u91c7\u7528\u5b98\u65b9\u7684 Dockerfile \u4fee\u6539\u4e00\u4e0b\u5373\u53ef</p> <pre><code>ARG ARCH=\"amd64\"\nARG OS=\"linux\"\nFROM quay.io/prometheus/busybox-${OS}-${ARCH}:latest\nLABEL maintainer=\"marionxue@qq.com\"\n\nCOPY ./mysqld_exporter /bin/mysqld_exporter\n\nEXPOSE      9104\nUSER        nobody\nENTRYPOINT  [ \"/bin/mysqld_exporter\" ]\n</code></pre> <p>\u6784\u5efa</p> <pre><code>docker build -t xx/mysqld_exporter:v1 -f ./Dockerfile .\n</code></pre> <p>\u8fd0\u884c\u6d4b\u8bd5\u5373\u53ef</p> <pre><code>docker-compose up -d\n</code></pre>"},{"location":"chap2/4mysql_exporter/#consul","title":"\u5199\u5165 consul","text":"<pre><code>curl --location --request PUT 'http://$CONSUL_HOST:$CONSUL_PORT/v1/agent/service/register' \\\n--header 'x-consul-token: $CONSUL_TOKEN' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n  \"id\": \"$MYSQLHOST:$MYSQLPORT\",\n  \"name\": \"mysql\",\n  \"tags\": [\n      \"prod\",\n      \"mysql_exporter\"\n  ],\n  \"meta\": {\n    \"company\": \"company\",\n    \"env\": \"prod\",\n    \"instance\": \"$MYSQLHOST:$MYSQLPORT\",\n    \"auth_module\": \"client\",\n    \"role\": \"master\",\n    \"name\": \"prod-1-1-master\"\n  }\n}'\n</code></pre> <p>\u518d\u6b21\u63d0\u9192\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u4e86\u4e0d\u540c\u7684\u76d1\u63a7\u8d26\u53f7\uff0c\u8bb0\u5f97\u4fee\u6539auth_module\u4e3a <code>config.my-cnf</code>\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u7684\u914d\u7f6e\u9879\u540d\u79f0\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u8ba4\u8bc1\u5931\u8d25</p>"},{"location":"chap2/4mysql_exporter/#prometheus","title":"\u914d\u7f6e prometheus","text":"<pre><code> - job_name: 'consul_mysql'\n    metrics_path: /probe\n    consul_sd_configs:\n      - server: '$CONSUL_HOST:$CONSUL_PORT'\n        token: '$CONSUL_TOKEN'\n        services: ['mysql']\n        tags: ['prod']\n    relabel_configs:\n      - source_labels: [\"__meta_consul_service_metadata_instance\"]\n        target_label: __param_target\n      - source_labels: [\"__meta_consul_service_metadata_company\"]\n        target_label: company\n      - source_labels: [\"__meta_consul_service_metadata_env\"]\n        target_label: env\n      - source_labels: [\"__meta_consul_service_metadata_auth_module\"]\n        target_label: auth_module\n      - source_labels: [\"__meta_consul_service_metadata_auth_module\"]\n        target_label: __param_auth_module\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: $MYSQLD_EXPORTER_HOST:$MYSQLD_EXPORTER_PORT\n</code></pre> <p>\u91cd\u8f7d Prometheus \u914d\u7f6e\u6587\u4ef6</p> <pre><code>curl -XPUT http://localhost:9090/-/reload\n</code></pre> <p>\u6700\u540e\u6548\u679c:\u300c\u5347\u7ea7\u5b8c\u6210\uff0c\u603b\u5171\u5e9f\u5f03\u4e86 19 \u4e2a <code>mysqld_exporter</code>\u5bb9\u5668!\u300d</p> <p></p> <p></p>"},{"location":"chap2/59node_exporter/","title":"\u7b2c\u4e8c\u8282 \u4f7f\u7528Node Exporter\u76d1\u63a7Linux\u4e3b\u673a&amp;\u5e38\u7528\u76d1\u63a7\u6307\u6807","text":"<p>Node Exporter \u662f\u7528\u4e8e\u66b4\u9732 <code>*NIX</code> \u4e3b\u673a\u6307\u6807\u7684 Exporter\uff0c\u6bd4\u5982\u91c7\u96c6 CPU\u3001\u5185\u5b58\u3001\u78c1\u76d8\u7b49\u4fe1\u606f\u3002\u91c7\u7528 Go \u7f16\u5199\uff0c\u4e0d\u5b58\u5728\u4efb\u4f55\u7b2c\u4e09\u65b9\u4f9d\u8d56\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u4e0b\u8f7d\u89e3\u538b\u5373\u53ef\u8fd0\u884c\u3002</p>"},{"location":"chap2/59node_exporter/#1","title":"1 \u5b89\u88c5\u914d\u7f6e","text":"<p>\u7531\u4e8e Node Exporter \u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u53ef\u4ee5\u76f4\u63a5\u4ece Prometheus \u4e0b\u8f7d\u9875\u9762(https://prometheus.io/download/#node_exporter) \u4e0b\u8f7d\u89e3\u538b\u8fd0\u884c\uff1a</p> <pre><code>\u2638 \u279c wget https://github.com/prometheus/node_exporter/releases/download/v1.2.2/node_exporter-1.2.2.linux-amd64.tar.gz\n# \u56fd\u5185\u52a0\u901f\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e0b\u8f7d\n# wget https://download.fastgit.org/prometheus/node_exporter/releases/download/v1.2.2/node_exporter-1.2.2.linux-amd64.tar.gz\n\u2638 \u279c tar -xvf node_exporter-1.2.2.linux-amd64.tar.gz\nnode_exporter-1.2.2.linux-amd64/\nnode_exporter-1.2.2.linux-amd64/LICENSE\nnode_exporter-1.2.2.linux-amd64/NOTICE\nnode_exporter-1.2.2.linux-amd64/node_exporter\n\u2638 \u279c cd node_exporter-1.2.2.linux-amd64 &amp;&amp; ls -la\ntotal 18084\ndrwxr-xr-x  2 3434 3434       56 Aug  6 21:50 .\ndr-xr-x---. 5 root root     4096 Oct 14 11:50 ..\n-rw-r--r--  1 3434 3434    11357 Aug  6 21:49 LICENSE\n-rwxr-xr-x  1 3434 3434 18494215 Aug  6 21:45 node_exporter\n-rw-r--r--  1 3434 3434      463 Aug  6 21:49 NOTICE\n</code></pre> <p>\u76f4\u63a5\u6267\u884c <code>node_exporter</code> \u6587\u4ef6\u5373\u53ef\u8fd0\u884c\uff1a</p> <pre><code>\u2638 \u279c ./node_exporter\nlevel=info ts=2021-10-14T03:52:31.947Z caller=node_exporter.go:182 msg=\"Starting node_exporter\" version=\"(version=1.2.2, branch=HEAD, revision=26645363b486e12be40af7ce4fc91e731a33104e)\"\nlevel=info ts=2021-10-14T03:52:31.947Z caller=node_exporter.go:183 msg=\"Build context\" build_context=\"(go=go1.16.7, user=root@b9cb4aa2eb17, date=20210806-13:44:18)\"\n......\nlevel=info ts=2021-10-14T03:52:31.948Z caller=node_exporter.go:199 msg=\"Listening on\" address=:9100\nlevel=info ts=2021-10-14T03:52:31.948Z caller=tls_config.go:191 msg=\"TLS is disabled.\" http2=false\n</code></pre> <p>\u4ece\u65e5\u5fd7\u4e0a\u53ef\u4ee5\u770b\u51fa <code>node_exporter</code> \u76d1\u542c\u5728 <code>9100</code> \u7aef\u53e3\u4e0a\uff0c\u9ed8\u8ba4\u7684 <code>metrics</code> \u63a5\u53e3\u901a\u8fc7 <code>/metrics</code> \u7aef\u70b9\u66b4\u9732\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95ee <code>http://localhost:9100/metrics</code> \u6765\u83b7\u53d6\u76d1\u63a7\u6307\u6807\u6570\u636e\uff1a</p> <pre><code>\u2638 \u279c curl http://localhost:9100/metrics\n......\n# HELP node_load1 1m load average.\n# TYPE node_load1 gauge\nnode_load1 0.01\n# HELP node_load15 15m load average.\n# TYPE node_load15 gauge\nnode_load15 0.05\n# HELP node_load5 5m load average.\n# TYPE node_load5 gauge\nnode_load5 0.04\n# HELP node_memory_Active_anon_bytes Memory information field Active_anon_bytes.\n# TYPE node_memory_Active_anon_bytes gauge\nnode_memory_Active_anon_bytes 8.4393984e+07\n# HELP node_memory_Active_bytes Memory information field Active_bytes.\n# TYPE node_memory_Active_bytes gauge\nnode_memory_Active_bytes 1.8167808e+08\n# HELP node_memory_Active_file_bytes Memory information field Active_file_bytes.\n# TYPE node_memory_Active_file_bytes gauge\nnode_memory_Active_file_bytes 9.7284096e+07\n# HELP node_memory_AnonHugePages_bytes Memory information field AnonHugePages_bytes.\n# TYPE node_memory_AnonHugePages_bytes gauge\nnode_memory_AnonHugePages_bytes 3.5651584e+07\n# HELP node_memory_AnonPages_bytes Memory information field AnonPages_bytes.\n# TYPE node_memory_AnonPages_bytes gauge\nnode_memory_AnonPages_bytes 8.159232e+07\n# HELP node_memory_Bounce_bytes Memory information field Bounce_bytes.\n# TYPE node_memory_Bounce_bytes gauge\nnode_memory_Bounce_bytes 0\n......\n</code></pre> <p>\u8be5 metrics \u63a5\u53e3\u6570\u636e\u5c31\u662f\u4e00\u4e2a\u6807\u51c6\u7684 Prometheus \u76d1\u63a7\u6307\u6807\u683c\u5f0f\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5c06\u8be5\u7aef\u70b9\u914d\u7f6e\u5230 Prometheus \u4e2d\u5373\u53ef\u6293\u53d6\u8be5\u6307\u6807\u6570\u636e\u3002\u4e3a\u4e86\u4e86\u89e3 node_exporter \u53ef\u914d\u7f6e\u7684\u53c2\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>./node_exporter -h</code> \u6765\u67e5\u770b\u5e2e\u52a9\u4fe1\u606f\uff1a</p> <pre><code>\u2638 \u279c ./node_exporter -h\n    --web.listen-address=\":9100\"  # \u76d1\u542c\u7684\u7aef\u53e3\uff0c\u9ed8\u8ba4\u662f9100\n    --web.telemetry-path=\"/metrics\"  # metrics\u7684\u8def\u5f84\uff0c\u9ed8\u8ba4\u4e3a/metrics\n    --web.disable-exporter-metrics  # \u662f\u5426\u7981\u7528go\u3001prome\u9ed8\u8ba4\u7684metrics\n    --web.max-requests=40     # \u6700\u5927\u5e76\u884c\u8bf7\u6c42\u6570\uff0c\u9ed8\u8ba440\uff0c\u8bbe\u7f6e\u4e3a0\u65f6\u4e0d\u9650\u5236\n    --log.level=\"info\"        # \u65e5\u5fd7\u7b49\u7ea7: [debug, info, warn, error, fatal]\n    --log.format=logfmt     # \u7f6e\u65e5\u5fd7\u6253\u5370target\u548c\u683c\u5f0f: [logfmt, json]\n    --version                 # \u7248\u672c\u53f7\n    --collector.{metric-name} # \u5404\u4e2ametric\u5bf9\u5e94\u7684\u53c2\u6570\n    ......\n</code></pre> <p>\u5176\u4e2d\u6700\u91cd\u8981\u7684\u53c2\u6570\u5c31\u662f <code>--collector.&lt;name&gt;</code>\uff0c\u901a\u8fc7\u8be5\u53c2\u6570\u53ef\u4ee5\u542f\u7528\u6211\u4eec\u6536\u96c6\u7684\u529f\u80fd\u6a21\u5757\uff0c<code>node_exporter</code> \u4f1a\u9ed8\u8ba4\u91c7\u96c6\u4e00\u4e9b\u6a21\u5757\uff0c\u8981\u7981\u7528\u8fd9\u4e9b\u9ed8\u8ba4\u542f\u7528\u7684\u6536\u96c6\u5668\u53ef\u4ee5\u901a\u8fc7 <code>--no-collector.&lt;name&gt;</code> \u6807\u5fd7\u6765\u7981\u7528\uff0c\u5982\u679c\u53ea\u542f\u7528\u67d0\u4e9b\u7279\u5b9a\u7684\u6536\u96c6\u5668\uff0c\u57fa\u4e8e\u5148\u4f7f\u7528 <code>--collector.disable-defaults</code> \u6807\u5fd7\u7981\u7528\u6240\u6709\u9ed8\u8ba4\u7684\uff0c\u7136\u540e\u5728\u901a\u8fc7\u6307\u5b9a\u5177\u4f53\u7684\u6536\u96c6\u5668 <code>--collector.&lt;name&gt;</code> \u6765\u8fdb\u884c\u542f\u7528\u3002</p> <p>\u4e0b\u56fe\u5217\u51fa\u4e86\u9ed8\u8ba4\u542f\u7528\u7684\u6536\u96c6\u5668\uff1a</p> <p></p> <p>\u4e00\u822c\u6765\u8bf4\u4e3a\u4e86\u65b9\u4fbf\u7ba1\u7406\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 docker \u5bb9\u5668\u6765\u8fd0\u884c <code>node_exporter</code>\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u7531\u4e8e\u91c7\u96c6\u7684\u662f\u5bbf\u4e3b\u673a\u7684\u6307\u6807\u4fe1\u606f\uff0c\u6240\u4ee5\u9700\u8981\u8bbf\u95ee\u4e3b\u673a\u7cfb\u7edf\uff0c\u5982\u679c\u4f7f\u7528 <code>docker</code> \u5bb9\u5668\u6765\u90e8\u7f72\u7684\u8bdd\u9700\u8981\u6dfb\u52a0\u4e00\u4e9b\u989d\u5916\u7684\u53c2\u6570\u6765\u5141\u8bb8 <code>node_exporter</code> \u8bbf\u95ee\u5bbf\u4e3b\u673a\u7684\u547d\u540d\u7a7a\u95f4\uff0c\u5982\u679c\u76f4\u63a5\u5728\u5bbf\u4e3b\u673a\u4e0a\u8fd0\u884c\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u7528 systemd \u6765\u7ba1\u7406\uff0c\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 <code>service unit</code> \u6587\u4ef6\uff1a</p> <pre><code>\u2638 \u279c cat /etc/systemd/system/node_exporter.service\n[Unit]\nDescription=node exporter service\nDocumentation=https://prometheus.io\nAfter=network.target\n\n[Service]\nType=simple\nUser=root\nGroup=root\nExecStart=/usr/local/bin/node_exporter  # \u6709\u7279\u6b8a\u9700\u6c42\u7684\u53ef\u4ee5\u5728\u540e\u9762\u6307\u5b9a\u53c2\u6570\u914d\u7f6e\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528 systemd \u6765\u7ba1\u7406 <code>node_exporter</code> \u4e86\uff1a</p> <pre><code>\u2638 \u279c cp node_exporter /usr/local/bin/node_exporter\n\u2638 \u279c systemctl daemon-reload\n\u2638 \u279c systemctl start node_exporter\n\u2638 \u279c systemctl status node_exporter\n\u25cf node_exporter.service - node exporter servoce\n   Loaded: loaded (/etc/systemd/system/node_exporter.service; disabled; vendor preset: disabled)\n   Active: active (running) since Thu 2021-10-14 15:29:46 CST; 5s ago\n     Docs: https://prometheus.io\n Main PID: 18679 (node_exporter)\n    Tasks: 5\n   Memory: 6.5M\n   CGroup: /system.slice/node_exporter.service\n           \u2514\u250018679 /usr/local/bin/node_exporter\n\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=node_exporter.go:..._zone\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=node_exporter.go:...=time\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=node_exporter.go:...timex\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=node_exporter.go:...ueues\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=node_exporter.go:...uname\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=node_exporter.go:...mstat\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=node_exporter.go:...r=xfs\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=node_exporter.go:...r=zfs\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=node_exporter.go:...:9100\nOct 14 15:29:46 node1 node_exporter[18679]: level=info ts=2021-10-14T07:29:46.137Z caller=tls_config.go:191...false\nHint: Some lines were ellipsized, use -l to show in full.\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u7528 systemd \u7684\u65b9\u5f0f\u5728\u4e24\u4e2a\u8282\u70b9\u4e0a\uff08node1\u3001node2\uff09\u5206\u522b\u542f\u52a8 <code>node_exporter</code>\uff0c\u542f\u52a8\u5b8c\u6210\u540e\u6211\u4eec\u4f7f\u7528\u9759\u6001\u914d\u7f6e\u7684\u65b9\u5f0f\u5728\u4e4b\u524d\u7684 Prometheus \u914d\u7f6e\u4e2d\u65b0\u589e\u4e00\u4e2a <code>node_exporter</code> \u7684\u6293\u53d6\u4efb\u52a1\uff0c\u6765\u91c7\u96c6\u8fd9\u4e24\u4e2a\u8282\u70b9\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>\nglobal:\n  scrape_interval: 5s\n\nscrape_configs:\n  - job_name: \"prometheus\"\n    static_configs:\n      - targets: [\"localhost:9090\"]\n  - job_name: \"demo\"\n    scrape_interval: 15s # \u4f1a\u8986\u76d6global\u5168\u5c40\u7684\u914d\u7f6e\n    scrape_timeout: 10s\n    static_configs:\n      - targets: [\"localhost:10000\", \"localhost:10001\", \"localhost:10002\"]\n  - job_name: \"node_exporter\" # \u65b0\u589e node_exporter \u4efb\u52a1\n    static_configs:\n      - targets: [\"node1:9100\", \"node2:9100\"] # node1\u3001node2 \u5728 hosts \u4e2d\u505a\u4e86\u6620\u5c04\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u6587\u4ef6\u6700\u540e\u6211\u4eec\u65b0\u589e\u4e86\u4e00\u4e2a\u540d\u4e3a <code>node_exporter</code> \u7684\u6293\u53d6\u4efb\u52a1\uff0c\u91c7\u96c6\u7684\u76ee\u6807\u4f7f\u7528\u9759\u6001\u914d\u7f6e\u7684\u65b9\u5f0f\u8fdb\u884c\u914d\u7f6e\uff0c\u7136\u540e\u91cd\u65b0\u52a0\u8f7d Prometheus\uff0c\u6b63\u5e38\u5728 Prometheus \u7684 WebUI \u7684\u76ee\u6807\u9875\u9762\u5c31\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u914d\u7f6e\u7684 <code>node_exporter</code> \u4efb\u52a1\u4e86\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u4e00\u4e9b\u5173\u4e8e\u8282\u70b9\u76d1\u63a7\u7684\u5e38\u7528\u6307\u6807\uff0c\u6bd4\u5982 CPU\u3001\u5185\u5b58\u3001IO \u76d1\u63a7\u7b49\u3002</p>"},{"location":"chap2/59node_exporter/#2-cpu","title":"2 CPU \u76d1\u63a7","text":"<p>\u5bf9\u4e8e\u8282\u70b9\u6211\u4eec\u9996\u5148\u80fd\u60f3\u5230\u7684\u5c31\u662f\u8981\u5148\u5bf9 CPU \u8fdb\u884c\u76d1\u63a7\uff0c\u56e0\u4e3a CPU \u662f\u5904\u7406\u4efb\u52a1\u7684\u6838\u5fc3\uff0c\u6839\u636e CPU \u7684\u72b6\u6001\u53ef\u4ee5\u5206\u6790\u51fa\u5f53\u524d\u7cfb\u7edf\u7684\u5065\u5eb7\u72b6\u6001\u3002\u8981\u5bf9\u8282\u70b9\u8fdb\u884c CPU \u76d1\u63a7\uff0c\u9700\u8981\u7528\u5230 <code>node_cpu_seconds_total</code> \u8fd9\u4e2a\u76d1\u63a7\u6307\u6807\uff0c\u5728 metrics \u63a5\u53e3\u4e2d\u8be5\u6307\u6807\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.\n# TYPE node_cpu_seconds_total counter\nnode_cpu_seconds_total{cpu=\"0\",mode=\"idle\"} 13172.76\nnode_cpu_seconds_total{cpu=\"0\",mode=\"iowait\"} 0.25\nnode_cpu_seconds_total{cpu=\"0\",mode=\"irq\"} 0\nnode_cpu_seconds_total{cpu=\"0\",mode=\"nice\"} 0.01\nnode_cpu_seconds_total{cpu=\"0\",mode=\"softirq\"} 87.99\nnode_cpu_seconds_total{cpu=\"0\",mode=\"steal\"} 0\nnode_cpu_seconds_total{cpu=\"0\",mode=\"system\"} 309.38\nnode_cpu_seconds_total{cpu=\"0\",mode=\"user\"} 79.93\nnode_cpu_seconds_total{cpu=\"1\",mode=\"idle\"} 13168.98\nnode_cpu_seconds_total{cpu=\"1\",mode=\"iowait\"} 0.27\nnode_cpu_seconds_total{cpu=\"1\",mode=\"irq\"} 0\nnode_cpu_seconds_total{cpu=\"1\",mode=\"nice\"} 0\nnode_cpu_seconds_total{cpu=\"1\",mode=\"softirq\"} 74.1\nnode_cpu_seconds_total{cpu=\"1\",mode=\"steal\"} 0\nnode_cpu_seconds_total{cpu=\"1\",mode=\"system\"} 314.71\nnode_cpu_seconds_total{cpu=\"1\",mode=\"user\"} 78.83\nnode_cpu_seconds_total{cpu=\"2\",mode=\"idle\"} 13182.78\nnode_cpu_seconds_total{cpu=\"2\",mode=\"iowait\"} 0.69\nnode_cpu_seconds_total{cpu=\"2\",mode=\"irq\"} 0\nnode_cpu_seconds_total{cpu=\"2\",mode=\"nice\"} 0\nnode_cpu_seconds_total{cpu=\"2\",mode=\"softirq\"} 66.01\nnode_cpu_seconds_total{cpu=\"2\",mode=\"steal\"} 0\nnode_cpu_seconds_total{cpu=\"2\",mode=\"system\"} 309.09\nnode_cpu_seconds_total{cpu=\"2\",mode=\"user\"} 79.44\nnode_cpu_seconds_total{cpu=\"3\",mode=\"idle\"} 13185.13\nnode_cpu_seconds_total{cpu=\"3\",mode=\"iowait\"} 0.18\nnode_cpu_seconds_total{cpu=\"3\",mode=\"irq\"} 0\nnode_cpu_seconds_total{cpu=\"3\",mode=\"nice\"} 0\nnode_cpu_seconds_total{cpu=\"3\",mode=\"softirq\"} 64.49\nnode_cpu_seconds_total{cpu=\"3\",mode=\"steal\"} 0\nnode_cpu_seconds_total{cpu=\"3\",mode=\"system\"} 305.86\nnode_cpu_seconds_total{cpu=\"3\",mode=\"user\"} 78.17\n</code></pre> <p>\u4ece\u63a5\u53e3\u4e2d\u63cf\u8ff0\u53ef\u4ee5\u770b\u51fa\u8be5\u6307\u6807\u662f\u7528\u6765\u7edf\u8ba1 CPU \u6bcf\u79cd\u6a21\u5f0f\u4e0b\u6240\u82b1\u8d39\u7684\u65f6\u95f4\uff0c\u662f\u4e00\u4e2a Counter \u7c7b\u578b\u7684\u6307\u6807\uff0c\u4e5f\u5c31\u662f\u4f1a\u4e00\u76f4\u589e\u957f\uff0c\u8fd9\u4e2a\u6570\u503c\u5176\u5b9e\u662f CPU \u65f6\u95f4\u7247\u7684\u4e00\u4e2a\u7d2f\u79ef\u503c\uff0c\u610f\u601d\u5c31\u662f\u4ece\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u8d77\u6765 CPU \u5f00\u59cb\u5de5\u4f5c\uff0c\u5c31\u5f00\u59cb\u8bb0\u5f55\u81ea\u5df1\u603b\u5171\u4f7f\u7528\u7684\u65f6\u95f4\uff0c\u7136\u540e\u4fdd\u5b58\u4e0b\u6765\uff0c\u800c\u4e14\u8fd9\u91cc\u7684\u7d2f\u79ef\u7684 CPU \u4f7f\u7528\u65f6\u95f4\u8fd8\u4f1a\u5206\u6210\u51e0\u4e2a\u4e0d\u540c\u7684\u6a21\u5f0f\uff0c\u6bd4\u5982\u7528\u6237\u6001\u4f7f\u7528\u65f6\u95f4\u3001\u7a7a\u95f2\u65f6\u95f4\u3001\u4e2d\u65ad\u65f6\u95f4\u3001\u5185\u6838\u6001\u4f7f\u7528\u65f6\u95f4\u7b49\u7b49\uff0c\u4e5f\u5c31\u662f\u5e73\u65f6\u6211\u4eec\u4f7f\u7528 top \u547d\u4ee4\u67e5\u770b\u7684 CPU \u7684\u76f8\u5173\u4fe1\u606f\uff0c\u800c\u6211\u4eec\u8fd9\u91cc\u7684\u8fd9\u4e2a\u6307\u6807\u4f1a\u5206\u522b\u5bf9\u8fd9\u4e9b\u6a21\u5f0f\u8fdb\u884c\u8bb0\u5f55\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u5bf9\u8282\u70b9\u7684 CPU \u8fdb\u884c\u76d1\u63a7\uff0c\u6211\u4eec\u4e5f\u77e5\u9053\u4e00\u4e2a\u4e00\u76f4\u589e\u957f\u7684 CPU \u65f6\u95f4\u5bf9\u6211\u4eec\u610f\u4e49\u4e0d\u5927\uff0c\u4e00\u822c\u6211\u4eec\u66f4\u5e0c\u671b\u76d1\u63a7\u7684\u662f\u8282\u70b9\u7684 CPU \u4f7f\u7528\u7387\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u4f7f\u7528 top \u547d\u4ee4\u770b\u5230\u7684\u767e\u5206\u6bd4\u3002</p> <p></p> <p>\u8981\u8ba1\u7b97 CPU \u7684\u4f7f\u7528\u7387\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u641e\u6e05\u695a\u8fd9\u4e2a\u4f7f\u7528\u7387\u7684\u542b\u4e49\uff0cCPU \u4f7f\u7528\u7387\u662f CPU \u9664\u7a7a\u95f2\uff08idle\uff09\u72b6\u6001\u4e4b\u5916\u7684\u5176\u4ed6\u6240\u6709 CPU \u72b6\u6001\u7684\u65f6\u95f4\u603b\u548c\u9664\u4ee5\u603b\u7684 CPU \u65f6\u95f4\u5f97\u5230\u7684\u7ed3\u679c\uff0c\u7406\u89e3\u4e86\u8fd9\u4e2a\u6982\u5ff5\u540e\u5c31\u53ef\u4ee5\u5199\u51fa\u6b63\u786e\u7684 promql \u67e5\u8be2\u8bed\u53e5\u4e86\u3002</p> <p>\u8981\u8ba1\u7b97\u9664\u7a7a\u95f2\u72b6\u6001\u4e4b\u5916\u7684 CPU \u65f6\u95f4\u603b\u548c\uff0c\u66f4\u597d\u7684\u65b9\u5f0f\u662f\u4e0d\u662f\u76f4\u63a5\u8ba1\u7b97\u7a7a\u95f2\u72b6\u6001\u7684 CPU \u65f6\u95f4\u4f7f\u7528\u7387\uff0c\u7136\u540e\u7528 1 \u51cf\u6389\u5c31\u662f\u6211\u4eec\u60f3\u8981\u7684\u7ed3\u679c\u4e86\uff0c\u6240\u4ee5\u9996\u5148\u6211\u4eec\u5148\u8fc7\u6ee4 idle \u6a21\u5f0f\u7684\u6307\u6807\uff0c\u5728 Prometheus \u7684 WebUI \u4e2d\u8f93\u5165 <code>node_cpu_seconds_total{mode=\"idle\"}</code> \u8fdb\u884c\u8fc7\u6ee4\uff1a</p> <p></p> <p>\u8981\u8ba1\u7b97\u4f7f\u7528\u7387\uff0c\u80af\u5b9a\u5c31\u9700\u8981\u77e5\u9053 idle \u6a21\u5f0f\u7684 CPU \u7528\u4e86\u591a\u957f\u65f6\u95f4\uff0c\u7136\u540e\u548c\u603b\u7684\u8fdb\u884c\u5bf9\u6bd4\uff0c\u7531\u4e8e\u8fd9\u662f Counter \u6307\u6807\uff0c\u6211\u4eec\u53ef\u4ee5\u7528 increase \u51fd\u6570\u6765\u83b7\u53d6\u53d8\u5316\uff0c\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5 <code>increase(node_cpu_seconds_total{mode=\"idle\"}[1m])</code>\uff0c\u56e0\u4e3a increase \u51fd\u6570\u8981\u6c42\u8f93\u5165\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u53d6 1 \u5206\u949f\u5185\u7684\u6570\u636e\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u67e5\u8be2\u7ed3\u679c\u4e2d\u6709\u5f88\u591a\u4e0d\u540c cpu \u5e8f\u53f7\u7684\u6570\u636e\uff0c\u6211\u4eec\u5f53\u7136\u9700\u8981\u8ba1\u7b97\u6240\u6709 CPU \u7684\u65f6\u95f4\uff0c\u6240\u4ee5\u6211\u4eec\u5c06\u5b83\u4eec\u805a\u5408\u8d77\u6765\uff0c\u6211\u4eec\u8981\u67e5\u8be2\u7684\u662f\u4e0d\u540c\u8282\u70b9\u7684 CPU \u4f7f\u7528\u7387\uff0c\u6240\u4ee5\u5c31\u9700\u8981\u6839\u636e instance \u6807\u7b7e\u8fdb\u884c\u805a\u5408\uff0c</p> <p>\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5 <code>sum(increase(node_cpu_seconds_total{mode=\"idle\"}[1m])) by (instance)</code>\uff1a</p> <p></p> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u5206\u522b\u62ff\u5230\u4e0d\u540c\u8282\u70b9 1 \u5206\u949f\u5185\u7684\u7a7a\u95f2 CPU \u4f7f\u7528\u65f6\u95f4\u4e86\uff0c\u7136\u540e\u548c\u603b\u7684 CPU \uff08\u8fd9\u4e2a\u65f6\u5019\u4e0d\u9700\u8981\u8fc7\u6ee4\u72b6\u6001\u6a21\u5f0f\uff09\u65f6\u95f4\u8fdb\u884c\u6bd4\u8f83\u5373\u53ef\uff0c\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5 </p> <pre><code>sum(increase(node_cpu_seconds_total{mode=\"idle\"}[1m])) by (instance) / sum(increase(node_cpu_seconds_total[1m])) by (instance)\uff1a\n</code></pre> <p></p> <p>\u7136\u540e\u8ba1\u7b97 CPU \u4f7f\u7528\u7387\u5c31\u975e\u5e38\u7b80\u5355\u4e86\uff0c\u4f7f\u7528 1 \u51cf\u53bb\u4e58\u4ee5 100 \u5373\u53ef\uff1a</p> <pre><code>(1 - sum(increase(node_cpu_seconds_total{mode=\"idle\"}[1m])) by (instance) / sum(increase(node_cpu_seconds_total[1m])) by (instance) ) * 100\n</code></pre> <p>\u8fd9\u5c31\u662f\u80fd\u591f\u60f3\u5230\u7684\u6700\u76f4\u63a5\u7684 CPU \u4f7f\u7528\u7387\u67e5\u8be2\u65b9\u5f0f\u4e86\uff0c\u5f53\u7136\u524d\u9762\u6211\u4eec\u5b66\u4e60\u7684 promql \u8bed\u6cd5\u4e2d\u63d0\u5230\u8fc7\u66f4\u591a\u7684\u65f6\u5019\u6211\u4eec\u4f1a\u53bb\u4f7f\u7528 rate \u51fd\u6570\uff0c\u800c\u4e0d\u662f\u7528 increase \u51fd\u6570\u8fdb\u884c\u8ba1\u7b97\uff0c\u6240\u4ee5\u6700\u7ec8\u7684 CPU \u4f7f\u7528\u7387\u7684\u67e5\u8be2\u8bed\u53e5\u4e3a\uff1a</p> <pre><code>(1 - sum(increase(node_cpu_seconds_total{mode=\"idle\"}[1m])) by (instance) / sum(increase(node_cpu_seconds_total[1m])) by (instance) ) * 100\n</code></pre> <p></p> <p>\u53ef\u4ee5\u548c top \u547d\u4ee4\u7684\u7ed3\u679c\u8fdb\u884c\u5bf9\u6bd4\uff08\u4e0b\u56fe\u4e3a node2 \u8282\u70b9\uff09\uff0c\u57fa\u672c\u4e0a\u662f\u4fdd\u6301\u4e00\u81f4\u7684\uff0c\u8fd9\u5c31\u662f\u76d1\u63a7\u8282\u70b9 CPU \u4f7f\u7528\u7387\u7684\u65b9\u5f0f\u3002</p> <p></p>"},{"location":"chap2/59node_exporter/#3","title":"3 \u5185\u5b58\u76d1\u63a7","text":"<p>\u9664\u4e86 CPU \u76d1\u63a7\u4e4b\u5916\uff0c\u6211\u4eec\u53ef\u80fd\u6700\u5173\u5fc3\u7684\u5c31\u662f\u8282\u70b9\u5185\u5b58\u7684\u76d1\u63a7\u4e86\uff0c\u5e73\u65f6\u6211\u4eec\u67e5\u770b\u8282\u70b9\u7684\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u57fa\u672c\u4e0a\u90fd\u662f\u4f7f\u7528 free \u547d\u4ee4\u6765\u67e5\u770b\uff1a</p> <p></p>"},{"location":"chap2/59node_exporter/#3-1-free","title":"3-1 free\u547d\u4ee4","text":"<p>free \u547d\u4ee4\u7684\u8f93\u51fa\u4f1a\u663e\u793a\u7cfb\u7edf\u5185\u5b58\u7684\u4f7f\u7528\u60c5\u51b5\uff0c\u5305\u62ec\u7269\u7406\u5185\u5b58\u3001\u4ea4\u6362\u5185\u5b58(swap)\u548c\u5185\u6838\u7f13\u51b2\u533a\u5185\u5b58\u7b49\uff0c\u6240\u4ee5\u8981\u5bf9\u5185\u5b58\u8fdb\u884c\u76d1\u63a7\u6211\u4eec\u9700\u8981\u5148\u4e86\u89e3\u8fd9\u4e9b\u6982\u5ff5\uff0c\u6211\u4eec\u5148\u4e86\u89e3\u4e0b free \u547d\u4ee4\u7684\u8f93\u51fa\u5185\u5bb9\uff1a</p> <ul> <li>Mem \u884c(\u7b2c\u4e8c\u884c)\u662f\u5185\u5b58\u7684\u4f7f\u7528\u60c5\u51b5</li> <li>Swap \u884c(\u7b2c\u4e09\u884c)\u662f\u4ea4\u6362\u7a7a\u95f4\u7684\u4f7f\u7528\u60c5\u51b5</li> <li>total \u5217\u663e\u793a\u7cfb\u7edf\u603b\u7684\u53ef\u7528\u7269\u7406\u5185\u5b58\u548c\u4ea4\u6362\u7a7a\u95f4\u5927\u5c0f</li> <li>used \u5217\u663e\u793a\u5df2\u7ecf\u88ab\u4f7f\u7528\u7684\u7269\u7406\u5185\u5b58\u548c\u4ea4\u6362\u7a7a\u95f4</li> <li>free \u5217\u663e\u793a\u8fd8\u6709\u591a\u5c11\u7269\u7406\u5185\u5b58\u548c\u4ea4\u6362\u7a7a\u95f4\u53ef\u7528\u4f7f\u7528</li> <li>shared \u5217\u663e\u793a\u88ab\u5171\u4eab\u4f7f\u7528\u7684\u7269\u7406\u5185\u5b58\u5927\u5c0f</li> <li>buff/cache \u5217\u663e\u793a\u88ab buffer \u548c cache \u4f7f\u7528\u7684\u7269\u7406\u5185\u5b58\u5927\u5c0f</li> <li>available \u5217\u663e\u793a\u8fd8\u53ef\u4ee5\u88ab\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u7684\u7269\u7406\u5185\u5b58\u5927\u5c0f</li> </ul> <p>\u5176\u4e2d\u6211\u4eec\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u7684 <code>free</code> \u548c <code>available</code> \u4e24\u5217\u3002</p> <p><code>free</code> \u662f\u771f\u6b63\u5c1a\u672a\u88ab\u4f7f\u7528\u7684\u7269\u7406\u5185\u5b58\u6570\u91cf\uff0c\u800c available \u662f\u4ece\u5e94\u7528\u7a0b\u5e8f\u7684\u89d2\u5ea6\u770b\u5230\u7684\u53ef\u7528\u5185\u5b58\uff0cLinux \u5185\u6838\u4e3a\u4e86\u63d0\u5347\u78c1\u76d8\u64cd\u4f5c\u7684\u6027\u80fd\uff0c\u4f1a\u6d88\u8017\u4e00\u90e8\u5206\u5185\u5b58\u53bb\u7f13\u5b58\u78c1\u76d8\u6570\u636e\uff0c\u5c31\u662f buffer \u548c cache\uff0c\u6240\u4ee5\u5bf9\u4e8e\u5185\u6838\u6765\u8bf4\uff0cbuffer \u548c cache \u90fd\u5c5e\u4e8e\u5df2\u7ecf\u88ab\u4f7f\u7528\u7684\u5185\u5b58\uff0c\u53ea\u662f\u5e94\u7528\u7a0b\u5e8f\u9700\u8981\u5185\u5b58\u65f6\uff0c\u5982\u679c\u6ca1\u6709\u8db3\u591f\u7684 free \u5185\u5b58\u53ef\u4ee5\u7528\uff0c\u5185\u6838\u5c31\u4f1a\u4ece buffer \u548c cache \u4e2d\u56de\u6536\u5185\u5b58\u6765\u6ee1\u8db3\u5e94\u7528\u7a0b\u5e8f\u7684\u8bf7\u6c42\u3002\u6240\u4ee5\u4ece\u5e94\u7528\u7a0b\u5e8f\u7684\u89d2\u5ea6\u6765\u8bf4 <code>available = free + buffer + cache</code>\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u8fd9\u53ea\u662f\u4e00\u4e2a\u7406\u60f3\u7684\u8ba1\u7b97\u65b9\u5f0f\uff0c\u5b9e\u9645\u4e2d\u7684\u6570\u636e\u6709\u8f83\u5927\u7684\u8bef\u5dee\u3002</p> <p>\u5982\u679c\u8981\u5728 Prometheus \u4e2d\u6765\u67e5\u8be2\u5185\u5b58\u4f7f\u7528\uff0c\u5219\u53ef\u4ee5\u7528 node_memory_* \u76f8\u5173\u6307\u6807\uff0c\u540c\u6837\u7684\u8981\u8ba1\u7b97\u4f7f\u7528\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba1\u7b97\u53ef\u4f7f\u7528\u7684\u5185\u5b58\uff0c\u4f7f\u7528 promql \u67e5\u8be2\u8bed\u53e5 <code>node_memory_Buffers_bytes + node_memory_Cached_bytes + node_memory_MemFree_bytes</code>\u3002</p> <p></p> <p>\u7136\u540e\u8ba1\u7b97\u53ef\u7528\u5185\u5b58\u7684\u4f7f\u7528\u7387\uff0c\u548c\u603b\u7684\u5185\u5b58\u76f8\u9664\uff0c\u7136\u540e\u540c\u6837\u7528 1 \u51cf\u53bb\u5373\u53ef\uff0c\u8bed\u53e5\u4e3a</p> <p><code>(1- (node_memory_Buffers_bytes + node_memory_Cached_bytes + node_memory_MemFree_bytes) / node_memory_MemTotal_bytes) * 100</code>\uff0c</p> <p>\u8fd9\u6837\u8ba1\u7b97\u51fa\u6765\u7684\u5c31\u662f\u8282\u70b9\u5185\u5b58\u4f7f\u7528\u7387\u3002</p> <p></p> <p>\u5f53\u7136\u5982\u679c\u60f3\u8981\u67e5\u770b\u5404\u9879\u5185\u5b58\u4f7f\u7528\u76f4\u63a5\u4f7f\u7528\u5bf9\u5e94\u7684\u76d1\u63a7\u6307\u6807\u5373\u53ef\uff0c\u6bd4\u5982\u8981\u67e5\u770b\u8282\u70b9\u603b\u5185\u5b58\uff0c\u76f4\u63a5\u4f7f\u7528 <code>node_memory_MemTotal_bytes</code> \u6307\u6807\u5373\u53ef\u83b7\u53d6\u3002</p> <p></p>"},{"location":"chap2/59node_exporter/#4","title":"4 \u78c1\u76d8\u76d1\u63a7","text":"<p>\u63a5\u4e0b\u6765\u662f\u6bd4\u8f83\u4e2d\u7684\u78c1\u76d8\u76d1\u63a7\uff0c\u5bf9\u4e8e\u78c1\u76d8\u76d1\u63a7\u6211\u4eec\u4e0d\u4ec5\u5bf9\u78c1\u76d8\u4f7f\u7528\u60c5\u51b5\u611f\u5174\u8da3\uff0c\u4e00\u822c\u6765\u8bf4\u5bf9\u4e8e\u78c1\u76d8 IO \u7684\u76d1\u63a7\u4e5f\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\u3002</p> <p>\u78c1\u76d8\u5bb9\u91cf\u76d1\u63a7</p> <p>\u8981\u76d1\u63a7\u78c1\u76d8\u5bb9\u91cf\uff0c\u9700\u8981\u7528\u5230 <code>node_filesystem_*</code> \u76f8\u5173\u7684\u6307\u6807\uff0c\u6bd4\u5982\u8981\u67e5\u8be2\u8282\u70b9\u78c1\u76d8\u7a7a\u95f4\u4f7f\u7528\u7387\uff0c\u5219\u53ef\u4ee5\u540c\u6837\u7528\u603b\u7684\u51cf\u53bb\u53ef\u7528\u7684\u6765\u8fdb\u884c\u8ba1\u7b97\uff0c\u78c1\u76d8\u53ef\u7528\u7a7a\u95f4\u4f7f\u7528 <code>node_filesystem_avail_bytes</code> \u6307\u6807\uff0c\u4f46\u662f\u7531\u4e8e\u4f1a\u6709\u4e00\u4e9b\u6211\u4eec\u4e0d\u5173\u5fc3\u7684\u78c1\u76d8\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 fstype \u6807\u7b7e\u8fc7\u6ee4\u5173\u5fc3\u7684\u78c1\u76d8\u4fe1\u606f\uff0c\u6bd4\u5982 ext4 \u6216\u8005 xfs \u683c\u5f0f\u7684\u78c1\u76d8\uff1a</p> <p></p> <p>\u8981\u67e5\u8be2\u78c1\u76d8\u7a7a\u95f4\u4f7f\u7528\u7387\uff0c\u5219\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5 </p> <p><code>(1 - node_filesystem_avail_bytes{fstype=~\"ext4|xfs\"} / node_filesystem_size_bytes{fstype=~\"ext4|xfs\"}) * 100</code></p> <p>\u5373\u53ef\uff1a</p> <p></p> <p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u5f97\u5230\u6211\u4eec\u5173\u5fc3\u7684\u78c1\u76d8\u7a7a\u95f4\u4f7f\u7528\u7387\u4e86\u3002</p> <p>\u78c1\u76d8 IO \u76d1\u63a7</p> <p>\u8981\u76d1\u63a7\u78c1\u76d8 IO\uff0c\u5c31\u8981\u533a\u5206\u662f\u8bfb\u7684 IO\uff0c\u8fd8\u662f\u5199\u7684 IO\uff0c\u8bfb IO \u4f7f\u7528 <code>node_disk_reads_completed</code> \u6307\u6807\uff0c\u5199 IO \u4f7f\u7528 <code>node_disk_writes_completed_total</code> \u6307\u6807\u3002</p> <p>\u78c1\u76d8\u8bfb IO \u4f7f\u7528 <code>sum by (instance) (rate(node_disk_reads_completed_total[5m]))</code> \u67e5\u8be2\u8bed\u53e5\u5373\u53ef\uff1a</p> <p></p> <p>\u5f53\u7136\u5982\u679c\u4f60\u60f3\u6839\u636e device \u8fdb\u884c\u805a\u5408\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u6211\u4eec\u8fd9\u91cc\u662f\u5168\u90e8\u805a\u5408\u5728\u4e00\u8d77\u4e86\u3002</p> <p>\u78c1\u76d8\u5199 IO \u4f7f\u7528 <code>sum by (instance) (rate(node_disk_writes_completed_total[5m]))</code> \u67e5\u8be2\u8bed\u53e5\u5373\u53ef\uff1a</p> <p></p>"},{"location":"chap2/59node_exporter/#6-io","title":"6 \u7f51\u7edc IO \u76d1\u63a7","text":"<p>\u4e0a\u884c\u5e26\u5bbd\u9700\u8981\u7528\u5230\u7684\u6307\u6807\u662f <code>node_network_receive_bytes</code>\uff0c\u7531\u4e8e\u6211\u4eec\u5bf9\u7f51\u7edc\u5e26\u5bbd\u7684\u77ac\u65f6\u53d8\u5316\u6bd4\u8f83\u5173\u6ce8\uff0c\u6240\u4ee5\u4e00\u822c\u6211\u4eec\u4f1a\u4f7f\u7528 irate \u51fd\u6570\u6765\u8ba1\u7b97\u7f51\u7edc IO\uff0c\u6bd4\u5982\u8ba1\u7b97\u4e0a\u884c\u5e26\u5bbd\u7528\u67e5\u8be2\u8bed\u53e5 </p> <p><code>sum by(instance) (irate(node_network_receive_bytes_total{device!~\"bond.*?|lo\"}[5m]))</code></p> <p>\u5373\u53ef\uff1a</p> <p></p> <p>\u4e0b\u884c\u5e26\u5bbd\u7528\u5230\u7684\u6307\u6807\u4e3a <code>node_network_transmit_bytes</code>\uff0c\u540c\u6837\u7684\u65b9\u5f0f\u67e5\u8be2\u8bed\u53e5\u4e3a </p> <p><code>sum by(instance) (irate(node_network_transmit_bytes{device!~\"bond.*?|lo\"}[5m]))</code>\uff1a</p> <p></p> <p>\u5f53\u7136\u6211\u4eec\u8fd8\u53ef\u4ee5\u6839\u636e\u7f51\u5361\u8bbe\u5907\u8fdb\u884c\u5206\u522b\u805a\u5408\u8ba1\u7b97\uff0c\u6700\u540e\u8fd8\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u5c06\u7ed3\u679c\u8fdb\u884c\u5355\u4f4d\u6362\u7b97\u3002</p>"},{"location":"chap2/5prom_grafana_chatops/","title":"5 \u4f7f\u7528 Grafana\u3001Prometheus \u548c Slack \u6784\u5efa\u4e00\u4e2a\u7b80\u5355\u7684 ChatOps \u673a\u5668\u4eba","text":"<p>\u4e00\u79cd\u6784\u5efa\u7b80\u5355\u7684 ChatOps \u673a\u5668\u4eba\u7684\u65b9\u6cd5\uff0c\u5b83\u4f7f\u7528 Slack \u548c Grafana \u6765\u67e5\u8be2\u7cfb\u7edf\u72b6\u6001\u3002\u5f53\u4f60\u4e0d\u5728\u529e\u516c\u684c\u524d\u7684\u65f6\u5019\uff0c\u4ecd\u6709\u57fa\u672c\u7684\u5904\u7406\u80fd\u529b\uff0c\u4f8b\u5982\u5728\u4f60\u7684\u624b\u673a\u4e0a\uff0c\u80fd\u591f\u7528\u5bf9\u8bdd\u754c\u9762\u68c0\u67e5\u4f60\u7684\u7cfb\u7edf\u72b6\u6001\u3002</p> <p></p> <p>\u672c\u6559\u7a0b\u5206\u4e3a\u4e24\u90e8\u5206\uff1a\u7b2c\u4e00\u90e8\u5206\u662f\u6784\u5efa\u7528 Prometheus \u548c Grafana \u76d1\u63a7 Kafka \u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u7b2c\u4e8c\u90e8\u5206\u5c06\u7528 Python \u5efa\u7acb\u4e00\u4e2a\u7b80\u5355\u7684\u673a\u5668\u4eba\uff0c\u5b83\u53ef\u4ee5\u54cd\u5e94\u4e00\u4e9b\u95ee\u9898\u5e76\u901a\u8fc7 Slack \u8fd4\u56de Grafana \u7684\u56fe\u8868\u3002</p> <p>\u6d88\u606f\u901a\u77e5\u662f Grafana \u7684\u4e00\u4e2a\u539f\u751f\u529f\u80fd\uff0c\u5177\u6709\u5411 Slack \u9891\u9053\u53d1\u9001\u62a5\u8b66\u4fe1\u606f\u7684\u80fd\u529b\uff0cSlack bot \u80fd\u591f\u54cd\u5e94\u5173\u4e8e\u7cfb\u7edf\u72b6\u6001\u7684\u7b80\u5355\u95ee\u9898\uff0c\u4ee5\u534f\u52a9\u8fdb\u884c\u6545\u969c\u6392\u9664\u3002</p> <p>\u6211\u4eec\u7684\u76ee\u6807\u662f\u8bbe\u8ba1\u4e00\u4e2a\u5728\u9632\u706b\u5899\u73af\u5883\u4e0b\u8fd0\u884c\u7684\u5de5\u5177\uff0c\u4e0d\u9700\u8981\u4ee3\u7406\u8bbf\u95ee\uff0c\u4e5f\u4e0d\u9700\u8981\u8bbf\u95ee\u4efb\u4f55\u7b2c\u4e09\u65b9\u670d\u52a1\uff0c\u5982 Amazon S3\u3002\u56e0\u6b64\uff0c\u56fe\u8868\u7684\u56fe\u50cf\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e2d\u751f\u6210\uff0c\u5e76\u4f5c\u4e3a\u9644\u4ef6\u4e0a\u4f20\u5230 Slack\uff0c\u4ee5\u907f\u514d\u5728\u516c\u5171\u57fa\u7840\u8bbe\u65bd\u4e0a\u6258\u7ba1\u3002</p> <p></p>"},{"location":"chap2/5prom_grafana_chatops/#_1","title":"\u7ec4\u4ef6","text":"<p>\u4e3b\u8981\u5305\u542b\u7684\u7ec4\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>Kafka\uff1a\u4e00\u4e2a\u6d88\u606f\u6d41\u5e73\u53f0\u3002</li> <li>Prometheus\uff1a\u4e00\u79cd\u76d1\u63a7\u7cfb\u7edf\uff0c\u7528\u4e8e\u6309\u6307\u5b9a\u7684\u65f6\u95f4\u95f4\u9694\u6536\u96c6\u6307\u6807\uff0c\u8bc4\u4f30\u89c4\u5219\u5e76\u89e6\u53d1\u8b66\u62a5\u3002</li> <li><code>prometheus-jmx-exporter</code>\uff1aPrometheus Exporter\uff0c\u53ef\u4ee5\u6293\u53d6\u5e76\u66b4\u9732 JMX \u6570\u636e\uff0c\u4ece\u800c\u4f7f\u6211\u4eec\u80fd\u591f\u4ece Kafka \u6536\u96c6\u6307\u6807\u6570\u636e\u3002</li> <li>Grafana\uff1a\u4e00\u4e2a\u53ef\u89c6\u5316\u5e73\u53f0\uff0c\u901a\u5e38\u7528\u4e8e\u53ef\u89c6\u5316\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0c\u4ee5\u7528\u4e8e\u57fa\u7840\u7ed3\u6784\u548c\u5e94\u7528\u7a0b\u5e8f\u5206\u6790\u3002\u8fd9\u4f7f\u6211\u4eec\u80fd\u591f\u4ee5\u56fe\u5f62\u65b9\u5f0f\u663e\u793a\u6536\u96c6\u7684\u6307\u6807\u3002</li> <li>Slack\uff1a\u6d88\u606f\u4f20\u9012\u5e94\u7528\u7a0b\u5e8f\uff0c\u5b83\u5c06\u4f7f\u6211\u4eec\u80fd\u591f\u4e0e\u804a\u5929\u673a\u5668\u4eba\u8fdb\u884c\u4ea4\u4e92\u3002</li> <li>Slack bot\uff1a\u4e0b\u9762\u7684\u7b2c\u4e8c\u90e8\u5206\u4e2d\u63cf\u8ff0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684 Python \u811a\u672c\uff0c\u8be5\u811a\u672c\u53ef\u4ee5\u4ece Grafana \u68c0\u7d22\u56fe\u5f62\u5e76\u5c06\u5176\u4e0a\u4f20\u5230 Slack\u3002</li> </ul> <p>\u8fd9\u4e9b\u6b65\u9aa4\u57fa\u4e8e\u5bf9 Kafka \u7684\u76d1\u63a7\uff0c\u4f46\u662f\u53ef\u4ee5\u91c7\u7528\u76f8\u540c\u7684\u901a\u7528\u65b9\u6cd5\u6765\u4e0e\u5176\u4ed6\u670d\u52a1\u96c6\u6210\u3002</p> <p>\u5b8c\u6574\u7684\u4ee3\u7801\u53ef\u4ee5\u5728 https://github.com/lucrussell/slack-chatops \u8fd9\u91cc\u627e\u5230\u3002</p>"},{"location":"chap2/5prom_grafana_chatops/#_2","title":"\u76d1\u63a7\u7ec4\u4ef6","text":"<p>\u6211\u4eec\u5c06\u4f7f\u7528 Grafana \u548c Prometheus \u6765\u5efa\u7acb\u4e00\u4e2a\u76d1\u63a7\u6808\u3002\u8981\u76d1\u63a7\u7684\u670d\u52a1\u662f Kafka\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u6865\u6881\uff0c\u5c06 JMX \u6570\u636e\u4ece Kafka \u5bfc\u51fa\u5230 Prometheus\u3002</p> <p><code>prometheus-jmx-exporter</code> \u8fd9\u4e2a Docker \u955c\u50cf\u5c31\u53ef\u4ee5\u5f88\u597d\u5730\u6ee1\u8db3\u4e86\u8fd9\u4e2a\u4f5c\u7528\u3002\u8fd9\u4e2a\u670d\u52a1\u4ece Kafka \u7684 JMX \u670d\u52a1\u4e2d\u63d0\u53d6\u6307\u6807\uff0c\u5e76\u901a\u8fc7 HTTP \u66b4\u9732\u8fd9\u4e9b\u6307\u6807\uff0c\u56e0\u6b64\u5b83\u4eec\u53ef\u4ee5\u88ab Prometheus \u6293\u53d6\u3002</p> <p>\u4e3a\u4e86\u5728 Kafka \u670d\u52a1\u5668\u4e2d\u542f\u7528 JMX \u6307\u6807\uff0c\u6211\u4eec\u9700\u8981\u5bf9 Kafka \u670d\u52a1\u505a\u4e00\u4e9b\u8bbe\u7f6e\uff0c\u5e76\u5c06 <code>kafka-jmx-exporter</code> \u5bb9\u5668\u4e0e <code>Kafka</code> \u670d\u52a1\u8fde\u63a5\u8d77\u6765\u3002</p> <ul> <li>\u786e\u4fdd\u5728 kafka \u5bb9\u5668\u4e0a\u8bbe\u7f6e <code>KAFKA_JMX_OPTS</code> \u548c <code>JMX_PORT</code> \u73af\u5883\u53d8\u91cf</li> <li>\u786e\u4fdd <code>kafka-jmx-exporter</code> \u548c kafka \u5bb9\u5668\u5728\u540c\u4e00\u4e2a\u7f51\u7edc\u4e0a</li> <li>\u786e\u4fdd <code>kafka-jmx-exporter</code> \u5bb9\u5668\u7684 <code>JMX_HOST</code> \u503c\u4e0e kafka \u5bb9\u5668\u4e0a\u7684 <code>KAFKA_ADVERTISED_HOST_NAME</code> \u5339\u914d</li> <li>\u786e\u4fdd <code>KAFKA_ADVERTISED_HOST_NAME</code> \u5728 <code>/etc/hosts</code> \u4e2d\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684\u6761\u76ee\u3002</li> <li>\u5c06 <code>wurstmeister/kafka</code> \u7684\u7248\u672c\u56fa\u5b9a\uff0c\u5728 <code>wurstmeister/kafka</code> \u955c\u50cf\u7684\u65e9\u671f\u7248\u672c\u4e2d\u914d\u7f6e JMX \u53ef\u80fd\u4f1a\u6709\u95ee\u9898</li> </ul> <p>\u5bf9\u5e94\u7684 <code>docker-compose.yml</code> \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>  kafka:\n    image: wurstmeister/kafka:1.0.0\n    ports:\n      - \"9092:9092\"\n      - \"1099:1099\"\n    depends_on:\n      - zookeeper\n    environment:\n      - KAFKA_ADVERTISED_PORT=9092\n      - KAFKA_BROKER_ID=1\n      - KAFKA_ZOOKEEPER_CONNECT=zookeeper\n      - KAFKA_ADVERTISED_HOST_NAME=kafka\n      - ZOOKEEPER_CONNECTION_TIMEOUT_MS=180000\n      - KAFKA_CREATE_TOPICS=transactions:1:1\n      - KAFKA_JMX_OPTS=-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=kafka -Dcom.sun.management.jmxremote.rmi.port=1099\n      - JMX_PORT=1099\n    networks:\n      - backend\n\n  kafka-jmx-exporter:\n    build: ./prometheus-jmx-exporter\n    ports:\n      - \"8080:8080\"\n    links:\n      - kafka\n    environment:\n      - JMX_PORT=1099\n      - JMX_HOST=kafka\n      - HTTP_PORT=8080\n      - JMX_EXPORTER_CONFIG_FILE=kafka.yml\n    networks:\n        - backend\n\n  prometheus:\n    ports:\n      - 9090:9090/tcp\n    image: prom/prometheus:v2.0.0\n    volumes:\n      - ./etc:/etc/prometheus\n      - prometheus_data:/prometheus\n    links:\n      - kafka-jmx-exporter\n    restart: always\n    networks:\n        - backend\n</code></pre> <p>Grafana \u53ef\u4ee5\u88ab\u914d\u7f6e\u4e3a\u5728\u542f\u52a8\u65f6\u8bfb\u53d6\u4e00\u4e2a JSON \u4eea\u8868\u76d8\u6587\u4ef6 --\u5728 <code>etc/Kafka.json</code> \u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e2a\uff0c\u9884\u5148\u914d\u7f6e\u4e86\u4e00\u4e9b Kafka \u76d1\u63a7\u4fe1\u606f\u6837\u672c\u3002</p> <p>\u51c6\u5907\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u7528 <code>docker-compose up -d</code> \u547d\u4ee4\u6765\u542f\u52a8\uff0c\u7136\u540e\u7528 kafkacat \u5411 Kafka \u53d1\u9001\u4e00\u4e9b\u6d88\u606f\u3002</p> <pre><code>for i in `seq 1 3`;\ndo\n        echo \"hello\"  | kafkacat -b kafka:9092 -t transactions\ndone\n</code></pre> <p>\u5728 http://localhost:3000 \u67e5\u770b Kafka \u4eea\u8868\u76d8\uff0c\u4f60\u5e94\u8be5\u770b\u5230\u7c7b\u4f3c\u8fd9\u6837\u7684\u9762\u677f\u3002</p> <p></p>"},{"location":"chap2/5prom_grafana_chatops/#slack","title":"\u6784\u5efa Slack \u673a\u5668\u4eba","text":"<p>\u6709\u4e86\u76d1\u63a7\u57fa\u7840\u8bbe\u65bd\uff0c\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u7f16\u5199\u7b80\u5355\u7684 Slack \u673a\u5668\u4eba\u4e86\u3002</p> <p>\u7b2c\u4e00\u6b65\u662f\u5728 Slack \u7f51\u7ad9\u4e0a\u521b\u5efa\u548c\u6ce8\u518c\u673a\u5668\u4eba\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u767b\u5f55 Slack\uff0c\u8fdb\u5165 https://api.slack.com/bot-users\uff0c\u7136\u540e\u5728\u8be5\u9875\u9762\u4e0a\u641c\u7d22 new bot user integration</p> <p></p> <p>\u6b64\u5916\u8fd8\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7ec6\u8282\uff0c\u4f8b\u5982\u4e3a\u673a\u5668\u4eba\u6dfb\u52a0\u4e00\u4e2a\u56fe\u6807\u548c\u63cf\u8ff0\u3002\u5f53\u4f60\u7684\u673a\u5668\u4eba\u88ab\u521b\u5efa\u540e\uff0c\u63a5\u7740\u4f60\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u79c1\u4eba\u9891\u9053\u8fdb\u884c\u6d4b\u8bd5\u3002</p> <p></p> <p>\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 <code>/invite @handy_bot</code> \u9080\u8bf7\u673a\u5668\u4eba\u5230\u6d4b\u8bd5\u9891\u9053\u3002</p> <p></p> <p>\u6211\u4eec\u7684\u673a\u5668\u4eba\u5c06\u56de\u7b54\u51e0\u4e2a\u7b80\u5355\u7684\u95ee\u9898\uff0c\u6211\u4eec\u5c06\u5728\u7b2c1-3\u884c\u5b9a\u4e49\u3002</p> <pre><code>self.respond_to = ['list graph shortcuts',\n                    'graph &lt;shortcut&gt;',\n                    'help']\nself.help_msg = '```\\n'\nfor answer in self.respond_to:\n    self.help_msg += f'{answer}\\n'\nself.help_msg += '```'\n</code></pre> <p>\u5728 app.py \u4e2d\uff0c\u6211\u4eec\u5c06\u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6\u5e76\u542f\u52a8\u673a\u5668\u4eba\u3002</p> <pre><code>def main(arguments=None):\n    if not arguments:\n        arguments = docopt(__doc__)\n    config = configure(arguments['--config-file'])\n    mybot = SlackBot(config)\n    mybot.start()\n</code></pre> <p>\u5176\u4e2d\u7684 start \u65b9\u6cd5\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>\ndef start(self):\n    if self.slack_client.rtm_connect():\n        print(\"Bot is alive and listening for messages...\")\n        while True:\n            events = self.slack_client.rtm_read()\n            for event in events:\n                if event.get('type') == 'message':\n                    # If we received a message, read it and respond if necessary\n                    self.on_message(event)\n\n            time.sleep(1)\n</code></pre> <p>\u7b2c2\u884c\uff1a\u4e0e Slack \u7684 API \u5efa\u7acb\u8fde\u63a5 \u7b2c5\u884c\uff1a\u4ee5\u6307\u5b9a\u7684\u9891\u7387\uff081\u79d2\uff09\u8f6e\u8be2\uff0c\u68c0\u67e5\u662f\u5426\u6709\u4efb\u4f55\u65b0\u4e8b\u4ef6 \u7b2c7\u884c\uff1a\u5982\u679c\u4e8b\u4ef6\u662f\u4e00\u4e2a message\uff0c\u5219\u8fdb\u5165 <code>on_message</code> \u65b9\u6cd5\uff0c\u5982\u679c\u6211\u4eec\u4ece\u8be5\u65b9\u6cd5\u5f97\u5230\u4e00\u4e2a\u54cd\u5e94\uff0c\u5219\u5c06\u5176\u6253\u5370\u51fa\u6765\uff0c\u53d1\u9001\u5230\u6d88\u606f\u53d1\u5e03\u7684\u9891\u9053\u4e2d\u3002</p> <pre><code>def on_message(self, event):\n    ...\n    full_text = event.get('text', '') or ''\n\n    if full_text.startswith(self.bot_id):\n        question = full_text[len(self.bot_id):]\n        if len(question) &gt; 0:\n            question = question.strip().lower()\n            channel = event['channel']\n            ...\n            elif 'graph' in question:\n                self.respond(channel, 'Please wait...', True)\n</code></pre> <p><code>on_message</code> \u65b9\u6cd5\u662f\u6211\u4eec\u51b3\u5b9a\u5982\u4f55\u56de\u5e94\u673a\u5668\u4eba\u6536\u5230\u7684\u6d88\u606f\u7684\u5730\u65b9\u3002<code>generate_and_upload_graph</code> \u662f\u6700\u6709\u8da3\u7684\u51fd\u6570\uff0c\u8fd9\u91cc\u6211\u4eec\u7684\u60f3\u6cd5\u662f\u542f\u52a8\u4e00\u4e2a\u4e34\u65f6\u7684 Docker \u5bb9\u5668\u6765\u6355\u83b7\u5c4f\u5e55\u622a\u56fe\u3002</p> <p>Grafana \u786e\u5b9e\u6709\u80fd\u529b\u5c06\u4efb\u4f55\u56fe\u5f62\u6e32\u67d3\u6210 PNG \u6587\u4ef6\uff0c\u7136\u800c\uff0c\u5728 Grafana \u7684\u6700\u65b0\u7248\u672c\u4e2d\uff0c\u5185\u90e8\u7528\u4e8e\u751f\u6210\u56fe\u7247\u7684 phantomjs \u5e93\u4f3c\u4e4e\u51fa\u73b0\u4e86\u9519\u8bef\u3002</p> <p>\u4e00\u4e2a\u66f4\u53ef\u9760\u7684 headless  \u6d4f\u89c8\u5de5\u5177\u662f\u57fa\u4e8e Google Chrome \u7684 Puppeteer\uff0c\u6709\u4eba\u5df2\u7ecf\u628a\u5b83\u5305\u88c5\u5728 Docker \u955c\u50cf\u4e2d\u4e86\u3002\u8fd9\u7ed9\u4e86\u6211\u4eec\u4e00\u4e2a\u5b9e\u9a8c Docker Python API \u7684\u673a\u4f1a\u3002</p> <pre><code>def generate_and_upload_graph(self, filename, url, channel):\n    dir_name = os.path.dirname(os.path.abspath(__file__))\n\n    client = docker.APIClient()\n\n    container = client.create_container(\n        image='alekzonder/puppeteer:1.0.0',\n        command=f'screenshot \\'{url}\\' 1366x768',\n        volumes=[dir_name],\n\n        host_config=client.create_host_config(binds={\n            dir_name: {\n                'bind': '/screenshots'\n            }\n        }, network_mode='host')\n    )\n\n    files1 = prepare_dir(dir_name)\n\n    client.start(container)\n\n    # Poll for new files\n    while True:\n        time.sleep(2)\n        files2 = os.listdir(dir_name)\n        new = [f for f in files2 if all([f not in files1, f.endswith(\".png\")])]\n        for f in new:\n            with open(f, 'rb') as in_file:\n                ret = self.slack_client.api_call(\n                    \"files.upload\",\n                    filename=filename,\n                    channels=channel,\n                    title=filename,\n                    file=io.BytesIO(in_file.read()))\n                if 'ok' not in ret or not ret['ok']:\n                    print('File upload failed %s', ret['error'])\n            os.remove(f)\n        break\n</code></pre> <p>\u7b2c6:16\u884c\uff1a\u4f7f\u7528 Docker Python API \u52a8\u6001\u5730\u521b\u5efa\u4e00\u4e2a\u57fa\u4e8e  <code>alekzonder/puppeteer</code> \u955c\u50cf\u7684\u5bb9\u5668\u3002</p> <p>\u7b2c13\u884c\uff1a\u5c06\u5f53\u524d\u76ee\u5f55\u4e0e\u5bb9\u5668\u4e2d\u7684 <code>/screenshots</code> \u6302\u8f7d\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u6587\u4ef6\u5199\u5165\u53ef\u8bbf\u95ee\u7684\u5730\u65b9\u3002</p> <p>\u7b2c15\u884c\uff1a\u8bbe\u7f6e <code>network_mode=host</code>\uff0c\u8fd9\u6837\u5bb9\u5668\u5c31\u53ef\u4ee5\u5728 localhost \u4e0a\u8bbf\u95ee Grafana\u3002</p> <p>\u7b2c23:38\u884c\uff1a\u89c2\u5bdf\u65b0\u7684\u56fe\u7247\u88ab\u6dfb\u52a0\u5230\u76ee\u5f55\u4e2d\uff0c\u5e76\u4e0a\u4f20\u5b83\u4eec\u3002</p> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u542f\u52a8\u673a\u5668\u4eba\u4e86\uff0c\u5728 slackbot \u76ee\u5f55\u4e2d\u3002</p> <pre><code>$ python bot.py --config=config.yaml \nBot is alive and listening for messages...\n</code></pre> <p>\u673a\u5668\u4eba\u53ef\u4ee5\u54cd\u5e94\u4e00\u4e9b\u57fa\u672c\u7684\u8bf7\u6c42\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u6839\u636e\u4f60\u60f3\u8981\u76d1\u63a7\u7684\u7279\u5b9a\u7cfb\u7edf\u6765\u5b9a\u5236\u673a\u5668\u4eba\u7684\u80fd\u529b\u3002</p> <p></p>"},{"location":"chap2/5prom_grafana_chatops/#_3","title":"\u7ed3\u8bba","text":"<p>ChatOps \u673a\u5668\u4eba\u53ef\u4ee5\u6210\u4e3a\u6709\u7528\u7684\u52a9\u624b\uff0c\u5e2e\u52a9\u4f60\u8fd0\u7ef4\u8fd0\u884c\u4e2d\u7684\u7cfb\u7edf\uff0c\u6211\u4eec\u8fd9\u91cc\u662f\u4e00\u4e2a\u7b80\u5316\u7684\u793a\u4f8b\uff0c\u4f46\u6211\u4eec\u53ef\u4ee5\u6269\u5c55\u5230\u652f\u6301\u66f4\u590d\u6742\u7684\u573a\u666f\u3002</p> <p>\u5229\u7528 Docker API \u6765\u52a8\u6001\u521b\u5efa\u5bb9\u5668\u662f\u4e00\u79cd\u590d\u6742\u7684\u622a\u56fe\u673a\u5236\uff0c\u4f46\u5f53\u4f60\u9700\u8981\u5feb\u901f\u4e3a\u81ea\u5df1\u7684\u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u4e00\u4e2a\u5df2\u7ecf\u88ab\u5305\u88c5\u6210 Docker \u955c\u50cf\u7684\u529f\u80fd\u65f6\uff0c\u8fd9\u4f1a\u7279\u522b\u6709\u7528\u3002</p>"},{"location":"chap3/10Adv_k8s_AlertManger/","title":"\u7b2c\u4e5d\u8282 \u62a5\u8b66\u795e\u5668 AlertManager \u7684\u4f7f\u7528","text":""},{"location":"chap3/10Adv_k8s_AlertManger/#_1","title":"\u7b80\u4ecb","text":"<p>\u4e4b\u524d\u6211\u4eec\u5b66\u4e60 <code>Prometheus</code> \u7684\u65f6\u5019\u5c31\u4e86\u89e3\u5230 <code>Prometheus</code> \u5305\u542b\u4e00\u4e2a\u62a5\u8b66\u6a21\u5757\uff0c\u5c31\u662f\u6211\u4eec\u7684 <code>AlertManager</code>\uff0c<code>Alertmanager</code> \u4e3b\u8981\u7528\u4e8e\u63a5\u6536 <code>Prometheus</code> \u53d1\u9001\u7684\u544a\u8b66\u4fe1\u606f\uff0c\u5b83\u652f\u6301\u4e30\u5bcc\u7684\u544a\u8b66\u901a\u77e5\u6e20\u9053\uff0c\u800c\u4e14\u5f88\u5bb9\u6613\u505a\u5230\u544a\u8b66\u4fe1\u606f\u8fdb\u884c\u53bb\u91cd\uff0c\u964d\u566a\uff0c\u5206\u7ec4\u7b49\uff0c\u662f\u4e00\u6b3e\u524d\u536b\u7684\u544a\u8b66\u901a\u77e5\u7cfb\u7edf\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b66\u4e60\u4e0b AlertManager \u7684\u5177\u4f53\u4f7f\u7528\u65b9\u6cd5\u3002</p>"},{"location":"chap3/10Adv_k8s_AlertManger/#1","title":"1 \u5b89\u88c5","text":"<p>\u4ece\u5b98\u65b9\u6587\u6863<code>https://prometheus.io/docs/alerting/configuration/</code>\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0b\u8f7d<code>AlertManager</code>\u4e8c\u8fdb\u5236\u6587\u4ef6\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u8fd0\u884c\uff1a</p> <pre><code>$ ./alertmanager --config.file=simple.yml\n</code></pre> <p>\u5176\u4e2d <code>-config.file</code> \u53c2\u6570\u662f\u7528\u6765\u6307\u5b9a\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u7684\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u540c\u6837\u8981\u8fd0\u884c\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u6765. \u6240\u4ee5\u6211\u4eec\u4f7f\u7528 <code>docker</code> \u955c\u50cf\u7684\u65b9\u5f0f\u6765\u5b89\u88c5\uff0c\u4f7f\u7528\u7684\u955c\u50cf\u662f\uff1a<code>prom/alertmanager:v0.15.3</code>\u3002</p> <p>\u9996\u5148\uff0c\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\uff0c\u540c\u6837\u7684\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\uff1a(<code>alertmanager-conf.yaml</code>)</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: alert-config  \n  namespace: kube-ops\ndata:\n  config.yml: |-\n    global:\n      # \u5728\u6ca1\u6709\u62a5\u8b66\u7684\u60c5\u51b5\u4e0b\u58f0\u660e\u4e3a\u5df2\u89e3\u51b3\u7684\u65f6\u95f4\n      resolve_timeout: 5m      # \u914d\u7f6e\u90ae\u4ef6\u53d1\u9001\u4fe1\u606f\n      smtp_smarthost: 'smtp.gmail.com'\n      smtp_from: 'xichao2014@gmail.com'\n      smtp_auth_username: 'xichao2014@gmail.com'\n      smtp_auth_password: '&lt;\u90ae\u7bb1\u5bc6\u7801&gt;'\n      smtp_hello: 'gmail.com'\n      smtp_require_tls: false\n    # \u6240\u6709\u62a5\u8b66\u4fe1\u606f\u8fdb\u5165\u540e\u7684\u6839\u8def\u7531\uff0c\u7528\u6765\u8bbe\u7f6e\u62a5\u8b66\u7684\u5206\u53d1\u7b56\u7565\n    route:\n      # \u8fd9\u91cc\u7684\u6807\u7b7e\u5217\u8868\u662f\u63a5\u6536\u5230\u62a5\u8b66\u4fe1\u606f\u540e\u7684\u91cd\u65b0\u5206\u7ec4\u6807\u7b7e\uff0c\u4f8b\u5982\uff0c\u63a5\u6536\u5230\u7684\u62a5\u8b66\u4fe1\u606f\u91cc\u9762\u6709\u8bb8\u591a\u5177\u6709 cluster=A \u548c alertname=LatncyHigh \u8fd9\u6837\u7684\u6807\u7b7e\u7684\u62a5\u8b66\u4fe1\u606f\u5c06\u4f1a\u6279\u91cf\u88ab\u805a\u5408\u5230\u4e00\u4e2a\u5206\u7ec4\u91cc\u9762\n      group_by: ['alertname', 'cluster']\n      # \u5f53\u4e00\u4e2a\u65b0\u7684\u62a5\u8b66\u5206\u7ec4\u88ab\u521b\u5efa\u540e\uff0c\u9700\u8981\u7b49\u5f85\u81f3\u5c11group_wait\u65f6\u95f4\u6765\u521d\u59cb\u5316\u901a\u77e5\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u786e\u4fdd\u60a8\u80fd\u6709\u8db3\u591f\u7684\u65f6\u95f4\u4e3a\u540c\u4e00\u5206\u7ec4\u6765\u83b7\u53d6\u591a\u4e2a\u8b66\u62a5\uff0c\u7136\u540e\u4e00\u8d77\u89e6\u53d1\u8fd9\u4e2a\u62a5\u8b66\u4fe1\u606f\u3002\n      group_wait: 30s      # \u5f53\u7b2c\u4e00\u4e2a\u62a5\u8b66\u53d1\u9001\u540e\uff0c\u7b49\u5f85'group_interval'\u65f6\u95f4\u6765\u53d1\u9001\u65b0\u7684\u4e00\u7ec4\u62a5\u8b66\u4fe1\u606f\u3002\n      group_interval: 5m      # \u5982\u679c\u4e00\u4e2a\u62a5\u8b66\u4fe1\u606f\u5df2\u7ecf\u53d1\u9001\u6210\u529f\u4e86\uff0c\u7b49\u5f85'repeat_interval'\u65f6\u95f4\u6765\u91cd\u65b0\u53d1\u9001\u4ed6\u4eec\n      repeat_interval: 5m      # \u9ed8\u8ba4\u7684receiver\uff1a\u5982\u679c\u4e00\u4e2a\u62a5\u8b66\u6ca1\u6709\u88ab\u4e00\u4e2aroute\u5339\u914d\uff0c\u5219\u53d1\u9001\u7ed9\u9ed8\u8ba4\u7684\u63a5\u6536\u5668\n      receiver: default      # \u4e0a\u9762\u6240\u6709\u7684\u5c5e\u6027\u90fd\u7531\u6240\u6709\u5b50\u8def\u7531\u7ee7\u627f\uff0c\u5e76\u4e14\u53ef\u4ee5\u5728\u6bcf\u4e2a\u5b50\u8def\u7531\u4e0a\u8fdb\u884c\u8986\u76d6\u3002\n      routes:\n      - receiver: email        \n        group_wait: 10s        \n        match:\n          team: node    \n    receivers:\n    - name: 'default'\n      email_configs:\n      - to: 'xichao2017@gmail.com'\n        send_resolved: true\n    - name: 'email'\n      email_configs:\n      - to: 'xichao2017@gmail.com'\n        send_resolved: true\n</code></pre> <p>\u8fd9\u662f <code>AlertManager</code> \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u5148\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f alertmanager-conf.yaml\nconfigmap \"alert-config\" created\n</code></pre> <p>\u7136\u540e\u914d\u7f6e <code>AlertManager</code> \u7684\u5bb9\u5668\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728\u4e4b\u524d\u7684 <code>Prometheus</code> \u7684 Pod \u4e2d\u6dfb\u52a0\u8fd9\u4e2a\u5bb9\u5668\uff0c\u5bf9\u5e94\u7684 YAML \u8d44\u6e90\u58f0\u660e\u5982\u4e0b\uff1a</p> <pre><code> - name: alertmanager    \n    image: prom/alertmanager:v0.15.3    \n    imagePullPolicy: IfNotPresent    \n    args:\n    - \"--config.file=/etc/alertmanager/config.yml\"\n    ports:\n    - containerPort: 9093\n      name: http    \n    volumeMounts:\n    - mountPath: \"/etc/alertmanager\"\n      name: alertcfg    \n    resources:\n      requests:\n        cpu: 100m        \n        memory: 256Mi      \n      limits:\n        cpu: 100m        \n        memory: 256Mi\nvolumes:\n- name: alertcfg  \n  configMap:\n    name: alert-config\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5c06\u4e0a\u9762\u521b\u5efa\u7684 <code>alert-config</code> \u8fd9\u4e2a <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\u4ee5 <code>Volume</code> \u7684\u5f62\u5f0f\u6302\u8f7d\u5230 <code>/etc/alertmanager</code> \u76ee\u5f55\u4e0b\u53bb\uff0c\u7136\u540e\u5728\u542f\u52a8\u53c2\u6570\u4e2d\u6307\u5b9a\u4e86\u914d\u7f6e\u6587\u4ef6 <code>--config.file=/etc/alertmanager/config.yml</code>\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6765\u66f4\u65b0\u8fd9\u4e2a Prometheus \u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f prome-deploy.yaml\ndeployment.extensions \"prometheus\" configured\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u5c06 AlertManager \u7684\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u76f4\u63a5\u653e\u5165\u5230\u4e4b\u524d\u7684 <code>Prometheus</code> \u7684 <code>ConfigMap</code> \u7684\u8d44\u6e90\u5bf9\u8c61\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e00\u4e2a\u5355\u72ec\u7684 Pod \u6765\u8fd0\u884c <code>AlertManager</code> \u8fd9\u4e2a\u5bb9\u5668\uff0c\u5b8c\u6574\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cc\uff1a</p> <p><code>AlertManager</code> \u7684\u5bb9\u5668\u542f\u52a8\u8d77\u6765\u540e\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5728 <code>Prometheus</code> \u4e2d\u914d\u7f6e\u4e0b <code>AlertManager</code> \u7684\u5730\u5740\uff0c\u8ba9 <code>Prometheus</code> \u80fd\u591f\u8bbf\u95ee\u5230 <code>AlertManager</code>\uff0c\u5728 <code>Prometheus</code> \u7684 <code>ConfigMap</code> \u8d44\u6e90\u6e05\u5355\u4e2d\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>alerting:\n  alertmanagers:\n    - static_configs:\n      - targets: [\"localhost:9093\"]\n</code></pre> <p>\u66f4\u65b0\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u540e\uff0c\u7a0d\u7b49\u4e00\u5c0f\u4f1a\u513f\uff0c\u6267\u884c reload \u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl delete -f prome-cm.yaml\nconfigmap \"prometheus-config\" deleted\n$ kubectl create -f prome-cm.yaml\nconfigmap \"prometheus-config\" created\n\n# \u9694\u4e00\u4f1a\u513f\u540e\n$ kubectl get svc -n kube-ops\nNAME         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                          AGE\nprometheus   NodePort   10.102.74.90   &lt;none&gt;        9090:30358/TCP                   3d\n$ curl -X POST \"http://10.102.74.90:9090/-/reload\"\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u67e5\u770b <code>Pod</code> \u53d1\u73b0\u6709\u9519\u8bef\uff0c\u67e5\u770b\u4e0b <code>alertmanager</code> \u5bb9\u5668\u7684\u65e5\u5fd7\uff0c\u53d1\u73b0\u6709\u5982\u4e0b\u9519\u8bef\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                          READY     STATUS             RESTARTS   AGE\nprometheus-56d64bf6f7-rpz9j   1/2       CrashLoopBackOff   491        1d\n$ kubectl logs -f prometheus-56d64bf6f7-rpz9j alertmanager -n kube-ops\nlevel=info ts=2018-11-28T10:33:51.830071513Z caller=main.go:174 msg=\"Starting Alertmanager\" version=\"(version=0.15.3, branch=HEAD, revision=d4a7697cc90f8bce62efe7c44b63b542578ec0a1)\"level=info ts=2018-11-28T10:33:51.830362309Z caller=main.go:175 build_context=\"(go=go1.11.2, user=root@4ecc17c53d26, date=20181109-15:40:48)\"level=error ts=2018-11-28T10:33:51.830464639Z caller=main.go:179 msg=\"Unable to create data directory\" err=\"mkdir data/: read-only file system\"\n</code></pre> <p>\u8fd9\u4e2a\u662f\u56e0\u4e3a\u65b0\u7248\u672c <code>dockerfile</code> \u4e2d\u7684\u9ed8\u8ba4 <code>WORKDIR</code> \u53d1\u751f\u4e86\u53d8\u5316\uff0c\u53d8\u6210\u4e86 <code>/etc/alertmanager</code> \u76ee\u5f55\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5b58\u50a8\u8def\u5f84 <code>--storage.path</code> \u662f\u76f8\u5bf9\u76ee\u5f55 <code>data/</code>\uff0c\u56e0\u6b64\uff0c<code>alertmanager</code> \u4f1a\u5728\u6211\u4eec\u4e0a\u9762\u6302\u8f7d\u7684 <code>ConfigMap</code> \u4e2d\u53bb\u521b\u5efa\u8fd9\u4e2a\u76ee\u5f55\uff0c\u6240\u4ee5\u4f1a\u62a5\u9519\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8986\u76d6 <code>--storage.path</code> \u53c2\u6570\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728\u5bb9\u5668\u542f\u52a8\u53c2\u6570\u4e2d\u6dfb\u52a0\u8be5\u53c2\u6570\uff1a(<code>prome-deploy.yaml</code>)</p> <pre><code>- name: alertmanager\n  image: prom/alertmanager:v0.15.3\n  imagePullPolicy: IfNotPresent\n  args:\n  - \"--config.file=/etc/alertmanager/config.yml\"\n  - \"--storage.path=/alertmanager/data\"\n</code></pre> <p>\u91cd\u65b0\u66f4\u65b0 Pod\uff0c\u53ef\u4ee5\u53d1\u73b0 Prometheus \u5df2\u7ecf\u662f Running \u72b6\u6001\u4e86\uff1a</p> <pre><code>$ kubectl apply -f prome-deploy.yaml\ndeployment.extensions \"prometheus\" configured\n\n$ kubectl get pods -n kube-ops\nNAME                          READY     STATUS      RESTARTS   AGE\nprometheus-646f457455-gr8x5   2/2       Running     0          3m\n$ kubectl logs -f prometheus-646f457455-gr8x5 alertmanager -n kube-ops\nlevel=info ts=2018-11-28T11:03:16.054633463Z caller=main.go:174 msg=\"Starting Alertmanager\" version=\"(version=0.15.3, branch=HEAD, revision=d4a7697cc90f8bce62efe7c44b63b542578ec0a1)\"level=info ts=2018-11-28T11:03:16.054931931Z caller=main.go:175 build_context=\"(go=go1.11.2, user=root@4ecc17c53d26, date=20181109-15:40:48)\"level=info ts=2018-11-28T11:03:16.351058702Z caller=cluster.go:155 component=cluster msg=\"setting advertise address explicitly\" addr=10.244.2.217 port=9094\nlevel=info ts=2018-11-28T11:03:16.456683857Z caller=main.go:322 msg=\"Loading configuration file\" file=/etc/alertmanager/config.yml\nlevel=info ts=2018-11-28T11:03:16.548558156Z caller=cluster.go:570 component=cluster msg=\"Waiting for gossip to settle...\" interval=2s\nlevel=info ts=2018-11-28T11:03:16.556768564Z caller=main.go:398 msg=Listening address=:9093\nlevel=info ts=2018-11-28T11:03:18.549158865Z caller=cluster.go:595 component=cluster msg=\"gossip not settled\" polls=0 before=0 now=1 elapsed=2.000272112s\nlevel=info ts=2018-11-28T11:03:26.558221484Z caller=cluster.go:587 component=cluster msg=\"gossip settled; proceeding\" elapsed=10.009335611s\n</code></pre>"},{"location":"chap3/10Adv_k8s_AlertManger/#2","title":"2 \u62a5\u8b66\u89c4\u5219","text":"<p>\u73b0\u5728\u6211\u4eec\u53ea\u662f\u628a AlertManager \u5bb9\u5668\u8fd0\u884c\u8d77\u6765\u4e86\uff0c\u4e5f\u548c Prometheus \u8fdb\u884c\u4e86\u5173\u8054\uff0c\u4f46\u662f\u73b0\u5728\u6211\u4eec\u5e76\u4e0d\u77e5\u9053\u8981\u505a\u4ec0\u4e48\u62a5\u8b66\uff0c\u56e0\u4e3a\u6ca1\u6709\u4efb\u4f55\u5730\u65b9\u544a\u8bc9\u6211\u4eec\u8981\u62a5\u8b66\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u914d\u7f6e\u4e00\u4e9b\u62a5\u8b66\u89c4\u5219\u6765\u544a\u8bc9\u6211\u4eec\u5bf9\u54ea\u4e9b\u6570\u636e\u8fdb\u884c\u62a5\u8b66\u3002</p> <p>\u8b66\u62a5\u89c4\u5219\u5141\u8bb8\u4f60\u57fa\u4e8e Prometheus \u8868\u8fbe\u5f0f\u8bed\u8a00\u7684\u8868\u8fbe\u5f0f\u6765\u5b9a\u4e49\u62a5\u8b66\u62a5\u6761\u4ef6\uff0c\u5e76\u5728\u89e6\u53d1\u8b66\u62a5\u65f6\u53d1\u9001\u901a\u77e5\u7ed9\u5916\u90e8\u7684\u63a5\u6536\u8005\u3002</p> <p>\u540c\u6837\u5728 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u62a5\u8b66\u89c4\u5219\u914d\u7f6e\uff1a</p> <pre><code>rule_files:\n  - /etc/prometheus/rules.yml\n</code></pre> <p>\u5176\u4e2d <code>rule_files</code> \u5c31\u662f\u7528\u6765\u6307\u5b9a\u62a5\u8b66\u89c4\u5219\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u5c06<code>rules.yml</code> \u7528ConfigMap\u7684\u5f62\u5f0f\u6302\u8f7d\u5230<code>/etc/prometheus</code>\u76ee\u5f55\u4e0b\u9762\u5373\u53ef:</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config  \n  namespace: kube-ops\ndata:\n  prometheus.yml: |\n...\n  rules.yml: |\n    groups:\n    - name: test-rule\n      rules:\n      - alert: NodeMemoryUsage\n        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 20\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{$labels.instance}}: High Memory usage detected\"\n          description: \"{{$labels.instance}}: Memory usage is above 20% (current value is: {{ $value }}\"\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a <code>NodeMemoryUsage</code> \u7684\u62a5\u8b66\u89c4\u5219\uff0c\u5176\u4e2d\uff1a</p> <ul> <li><code>for</code> \u8bed\u53e5\u4f1a\u4f7f <code>Prometheus</code> \u670d\u52a1\u7b49\u5f85\u6307\u5b9a\u7684\u65f6\u95f4, \u7136\u540e\u6267\u884c\u67e5\u8be2\u8868\u8fbe\u5f0f\u3002</li> <li><code>labels</code> \u8bed\u53e5\u5141\u8bb8\u6307\u5b9a\u989d\u5916\u7684\u6807\u7b7e\u5217\u8868\uff0c\u628a\u5b83\u4eec\u9644\u52a0\u5728\u544a\u8b66\u4e0a\u3002</li> <li><code>annotations</code> \u8bed\u53e5\u6307\u5b9a\u4e86\u53e6\u4e00\u7ec4\u6807\u7b7e\uff0c\u5b83\u4eec\u4e0d\u88ab\u5f53\u505a\u544a\u8b66\u5b9e\u4f8b\u7684\u8eab\u4efd\u6807\u8bc6\uff0c\u5b83\u4eec\u7ecf\u5e38\u7528\u4e8e\u5b58\u50a8\u4e00\u4e9b\u989d\u5916\u7684\u4fe1\u606f\uff0c\u7528\u4e8e\u62a5\u8b66\u4fe1\u606f\u7684\u5c55\u793a\u4e4b\u7c7b\u7684\u3002</li> </ul> <p>\u4e3a\u4e86\u65b9\u4fbf\u6f14\u793a\uff0c\u6211\u4eec\u5c06\u7684\u8868\u8fbe\u5f0f\u5224\u65ad\u62a5\u8b66\u4e34\u754c\u503c\u8bbe\u7f6e\u4e3a20\uff0c\u91cd\u65b0\u66f4\u65b0 <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\uff0c\u7531\u4e8e\u6211\u4eec\u5728 <code>Prometheus</code> \u7684 <code>Pod</code> \u4e2d\u5df2\u7ecf\u901a\u8fc7 <code>Volume</code> \u7684\u5f62\u5f0f\u5c06 <code>prometheus-config</code> \u8fd9\u4e2a\u4e00\u4e2a <code>ConfigMap</code> \u5bf9\u8c61\u6302\u8f7d\u5230\u4e86<code>/etc/prometheus</code>\u76ee\u5f55\u4e0b\u9762\uff0c\u6240\u4ee5\u66f4\u65b0\u540e\uff0c\u8be5\u76ee\u5f55\u4e0b\u9762\u4e5f\u4f1a\u51fa\u73b0<code>rules.yml</code>\u6587\u4ef6\uff0c\u6240\u4ee5\u524d\u9762\u914d\u7f6e\u7684<code>rule_files</code>\u8def\u5f84\u4e5f\u662f\u6b63\u5e38\u7684\uff0c\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u91cd\u65b0\u6267\u884c<code>reload</code>\u64cd\u4f5c\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53bb <code>Prometheus</code> \u7684 <code>Dashboard</code> \u4e2d\u5207\u6362\u5230alerts\u8def\u5f84\u4e0b\u9762\u5c31\u53ef\u4ee5\u770b\u5230\u6709\u62a5\u8b66\u914d\u7f6e\u89c4\u5219\u7684\u6570\u636e\u4e86\uff1a</p> <p></p> <p>prometheus alerts</p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u9875\u9762\u4e2d\u51fa\u73b0\u4e86\u6211\u4eec\u521a\u521a\u5b9a\u4e49\u7684\u62a5\u8b66\u89c4\u5219\u4fe1\u606f\uff0c\b\u800c\u4e14\u62a5\u8b66\u4fe1\u606f\u4e2d\u8fd8\u6709\u72b6\u6001\u663e\u793a\u3002\u4e00\u4e2a\u62a5\u8b66\u4fe1\u606f\u5728\u751f\u547d\u5468\u671f\u5185\u6709\u4e0b\u97623\u79cd\u72b6\u6001\uff1a</p> <ul> <li><code>inactive</code>: \u8868\u793a\u5f53\u524d\u62a5\u8b66\u4fe1\u606f\u65e2\u4e0d\u662ffiring\u72b6\u6001\u4e5f\u4e0d\u662fpending\u72b6\u6001</li> <li><code>pending</code>: \u8868\u793a\u5728\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\u95f4\u8303\u56f4\u5185\u88ab\u6fc0\u6d3b\u4e86</li> <li><code>firing</code>: \u8868\u793a\u8d85\u8fc7\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\u95f4\u88ab\u6fc0\u6d3b\u4e86</li> </ul> <p>\u6211\u4eec\u8fd9\u91cc\u7684\u72b6\u6001\u73b0\u5728\u662f <code>firing</code> \u5c31\u8868\u793a\u8fd9\u4e2a\u62a5\u8b66\u5df2\u7ecf\u88ab\u6fc0\u6d3b\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u7684\u62a5\u8b66\u4fe1\u606f\u6709\u4e00\u4e2a <code>team=node</code> \u8fd9\u6837\u7684\u6807\u7b7e\uff0c\u800c\u6700\u4e0a\u9762\u6211\u4eec\u914d\u7f6e <code>alertmanager</code> \u7684\u65f6\u5019\u5c31\u6709\u5982\u4e0b\u7684\u8def\u7531\u914d\u7f6e\u4fe1\u606f\u4e86\uff1a</p> <pre><code>routes:\n- receiver: email\n  group_wait: 10s\n  match:\n    team: node\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7684\u62a5\u8b66\u4fe1\u606f\u4f1a\b\u88ab<code>email</code>\u8fd9\u4e2a\u63a5\u6536\u5668\u6765\u8fdb\u884c\u62a5\u8b66\uff0c\u6211\u4eec\u4e0a\u9762\u914d\u7f6e\u7684\u662f\u90ae\u7bb1\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u4f1a\u6536\u5230\u4e00\u5c01\b\u5982\u4e0b\u7684\u62a5\u8b66\u90ae\u4ef6\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6536\u5230\u7684\u90ae\u4ef6\u5185\u5bb9\u4e2d\u5305\u542b\u4e00\u4e2a<code>View In AlertManager</code>\u7684\u94fe\u63a5\uff0c\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u901a\u8fc7 NodePort \u7684\u5f62\u5f0f\u53bb\u8bbf\u95ee\u5230 <code>AlertManager</code> \u7684 <code>Dashboard</code> \u9875\u9762\uff1a</p> <pre><code>$ kubectl get svc -n kube-ops\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE\nprometheus   NodePort    10.102.74.90    &lt;none&gt;        9093:31788/TCP,9090:30358/TCP    34d\n</code></pre> <p>\u7136\u540e\u901a\u8fc7<code>&lt;\u4efb\u4e00Node\u8282\u70b9&gt;:31788</code>\u8fdb\u884c\u8bbf\u95ee\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u5230 <code>AlertManager</code> \u7684 <code>Dashboard</code>\u9875\u9762\uff1a</p> <p></p> <p>\u5728\u8fd9\u4e2a\u9875\u9762\u4e2d\u6211\u4eec\u53ef\u4ee5\u8fdb\u884c\b\u4e00\u4e9b\u64cd\u4f5c\uff0c\u6bd4\u5982\u8fc7\u6ee4\u3001\u5206\u7ec4\u7b49\u7b49\uff0c\u91cc\u9762\u8fd8\u6709\u4e24\u4e2a\u65b0\u7684\u6982\u5ff5\uff1a<code>Inhibition(\u6291\u5236)</code>\u548c <code>Silences(\u9759\u9ed8)</code>\u3002</p> <ul> <li>Inhibition\uff1a\u5982\u679c\u67d0\u4e9b\u5176\u4ed6\u8b66\u62a5\u5df2\u7ecf\u89e6\u53d1\u4e86\uff0c\u5219\u5bf9\u4e8e\u67d0\u4e9b\u8b66\u62a5\uff0cInhibition \u662f\u4e00\u4e2a\u6291\u5236\u901a\u77e5\u7684\u6982\u5ff5\u3002\u4f8b\u5982\uff1a\u4e00\u4e2a\u8b66\u62a5\u5df2\u7ecf\u89e6\u53d1\uff0c\u5b83\u6b63\u5728\u901a\u77e5\u6574\u4e2a\u96c6\u7fa4\u662f\u4e0d\u53ef\u8fbe\u7684\u65f6\uff0cAlertmanager \u5219\u53ef\u4ee5\u914d\u7f6e\u6210\u5173\u5fc3\u8fd9\u4e2a\u96c6\u7fa4\u7684\u5176\u4ed6\u8b66\u62a5\u65e0\u6548\u3002\u8fd9\u53ef\u4ee5\u9632\u6b62\u4e0e\u5b9e\u9645\u95ee\u9898\u65e0\u5173\u7684\u6570\u767e\u6216\u6570\u5343\u4e2a\u89e6\u53d1\u8b66\u62a5\u7684\u901a\u77e5\uff0cInhibition \u9700\u8981\u901a\u8fc7\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u914d\u7f6e\u3002</li> <li>Silences\uff1a\u9759\u9ed8\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5728\u7ed9\u5b9a\u65f6\u95f4\u5185\u7b80\u5355\u5730\u5ffd\u7565\u6240\u6709\u8b66\u62a5\u3002Silences \u57fa\u4e8e matchers\u914d\u7f6e\uff0c\u7c7b\u4f3c\u8def\u7531\u6811\u3002\u6765\u5230\u7684\u8b66\u544a\u5c06\u4f1a\u88ab\u68c0\u67e5\uff0c\u5224\u65ad\u5b83\u4eec\u662f\u5426\u548c\u6d3b\u8dc3\u7684 Silences \u76f8\u7b49\u6216\u8005\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u3002\u5982\u679c\u5339\u914d\u6210\u529f\uff0c\u5219\u4e0d\u4f1a\u5c06\u8fd9\u4e9b\u8b66\u62a5\u53d1\u9001\u7ed9\u63a5\u6536\u8005\u3002</li> </ul> <p>\u7531\u4e8e\u5168\u5c40\u914d\u7f6e\u4e2d\u6211\u4eec\u914d\u7f6e\u7684 <code>group_interval: 5m</code>\uff0c\u4e5f\u5c31\u662f\u6bcf5\u5206\u949f\u4e00\u4e2a\u5206\u7ec4\u7684\u62a5\u8b66\u5c06\u4f1a\u91cd\u65b0\u89e6\u53d1\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4\uff0c\u4e0a\u9762\u7684\u6d4b\u8bd5\u62a5\u8b66\u5982\u679c\u4e00\u76f4\u6ee1\u8db3\u62a5\u8b66\u6761\u4ef6(CPU\u4f7f\u7528\u7387\u5927\u4e8e20%)\u7684\u8bdd\uff0c\u90a3\u4e48\u6bcf5\u5206\u949f\u6211\u4eec\u5c31\u53ef\u4ee5\u6536\u5230\u4e00\u6761\u62a5\u8b66\u90ae\u4ef6\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a <code>Silences</code>\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u5339\u914d <code>node02</code> \u8282\u70b9\u7684\u5185\u5b58\u62a5\u8b66\uff1a</p> <p></p> <p>prometheus alertmanager Silences</p> <p>\u6dfb\u52a0\u5b8c\u6210\u540e\uff0c\u7b49\u4e0b\u4e00\u6b21\u7684\u62a5\u8b66\u4fe1\u606f\u89e6\u53d1\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u62a5\u8b66\b\u4fe1\u606f\u91cc\u9762\u5df2\u7ecf\u6ca1\u6709\u4e86\u8282\u70b9 node02 \u7684\u62a5\u8b66\u4fe1\u606f\u4e86\uff1a</p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u4e0a\u9762\u6dfb\u52a0\u7684 Silences \u662f\u6709\u8fc7\u671f\u65f6\u95f4\u7684\uff0c\u6240\u4ee5\u5728\u8fd9\u4e2a\u65f6\u95f4\u6bb5\u8fc7\u540e\uff0cnode02 \u7684\u62a5\u8b66\u4fe1\u606f\u5c31\u4f1a\u6062\u590d\u4e86\u3002</p>"},{"location":"chap3/10Adv_k8s_AlertManger/#3-webhook","title":"\b3 webhook\u63a5\u6536\u5668","text":"<p>\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u662f \bAlertManager \u81ea\u5e26\u7684\u90ae\u4ef6\b\u62a5\u8b66\u6a21\u677f\uff0c\u6211\u4eec\u4e5f\u8bf4\u4e86 AlertManager \u652f\u6301\u5f88\u591a\u4e2d\u62a5\u8b66\u63a5\u6536\u5668\uff0c\u6bd4\u5982 slack\u3001\u5fae\u4fe1\u4e4b\u7c7b\u7684\uff0c\u5176\u4e2d\u6700\u4e3a\u7075\u6d3b\u7684\u65b9\u5f0f\u5f53\u7136\u662f\u4f7f\u7528 <code>webhook</code> \u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a <code>webhook</code> \u6765\u63a5\u6536\u62a5\u8b66\u4fe1\u606f\uff0c\u7136\u540e\u5728 <code>webhook</code> \u91cc\u9762\u53bb\u8fdb\u884c\b\u5904\u7406\uff0c\u9700\u8981\u53d1\u9001\u600e\u6837\u7684\u62a5\u8b66\u4fe1\u606f\u6211\u4eec\u81ea\u5b9a\u4e49\u5c31\u53ef\u4ee5\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u7528 <code>Flask</code> \u7f16\u5199\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u5904\u7406\u9489\u9489\u62a5\u8b66\u7684 <code>webhook</code> \u7684\u7a0b\u5e8f\uff1a</p> <pre><code>import os\nimport requests\n\nfrom flask import Flask\nfrom flask import request\n\napp = Flask(__name__)\n\n\n@app.route('/', methods=['POST', 'GET'])\ndef send():\n    if request.method == 'POST':\n        post_data = request.get_data()\n        send_alert(post_data)\n        return 'success'\n    else:\n        return 'weclome to use prometheus alertmanager dingtalk webhook server!'\n\n\ndef send_alert(data):\n    token = os.getenv('ROBOT_TOKEN')\n    if not token:\n        print('you must set ROBOT_TOKEN env')\n        return\n    url = 'https://oapi.dingtalk.com/robot/send?access_token=%s' % token\n    send_data = {\n        \"msgtype\": \"text\",\n        \"text\": {\n            \"content\": data\n        }\n    }\n    req = requests.post(url, json=send_data)\n    result = req.json()\n    if result['errcode'] != 0:\n        print('notify dingtalk error: %s' % result['errcode'])\n\nif __name__ == '__main__':\n    from waitress import serve\n    serve(app, listen='0.0.0.0:5000')\n</code></pre> <p>\u4ee3\u7801\u975e\u5e38\u7b80\u5355\uff0c\u901a\u8fc7\u4e00\u4e2a <code>ROBOT_TOKEN</code> \u7684\u73af\u5883\u53d8\u91cf\u4f20\u5165\u7fa4\u673a\u5668\u4eba\u7684 <code>TOKEN</code>\uff0c\u7136\u540e\u76f4\u63a5\u5c06 <code>webhook</code> \u53d1\u9001\u8fc7\u6765\u7684\u6570\u636e\u76f4\u63a5\u4ee5\u6587\u672c\u7684\u5f62\u5f0f\u8f6c\u53d1\u7ed9\u7fa4\u673a\u5668\u4eba\u3002</p> <p>\u5f53\u7136\u6211\u4eec\u5f97\u5c06\u4e0a\u9762\u8fd9\u4e2a\u670d\u52a1\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u6765\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\uff1a(<code>dingtalk-hook.yaml</code>)</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: dingtalk-hook\n  namespace: kube-ops\nspec:\n  template:\n    metadata:\n      labels:\n        app: dingtalk-hook\n    spec:\n      containers:\n      - name: dingtalk-hook\n        image: cnych/alertmanager-dingtalk-hook:v0.2\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 5000\n          name: http\n        env:\n        - name: ROBOT_TOKEN\n          valueFrom:\n            secretKeyRef:\n              name: dingtalk-secret\n              key: token\n        resources:\n          requests:\n            cpu: 50m\n            memory: 100Mi\n          limits:\n            cpu: 50m\n            memory: 100Mi\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: dingtalk-hook\n  namespace: kube-ops\nspec:\n  selector:\n    app: dingtalk-hook\n  ports:\n  - name: hook\n    port: 5000\n    targetPort: http\n</code></pre> <p>\u8981\u6ce8\u610f\u4e0a\u9762\u6211\u4eec\u58f0\u660e\u4e86\u4e00\u4e2a <code>ROBOT_TOKEN</code> \u7684\u73af\u5883\u53d8\u91cf\uff0c\u7531\u4e8e\u8fd9\u662f\u4e00\u4e2a\u76f8\u5bf9\u4e8e\u79c1\u5bc6\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4ece\u4e00\u4e2a <code>Secret</code> \u5bf9\u8c61\u4e2d\u53bb\u83b7\u53d6\uff0c\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>dingtalk-secret</code> \u7684 <code>Secret</code> \u5bf9\u8c61\uff0c\u7136\u540e\u90e8\u7f72\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create secret generic dingtalk-secret --from-literal=token=\u66ff\u6362\u6210\u9489\u9489\u7fa4\u804a\u7684\u673a\u5668\u4ebaTOKEN -n kube-ops\nsecret \"dingtalk-secret\" created\n$ kubectl create -f dingtalk-hook.yaml\ndeployment.extensions \"dingtalk-hook\" created\nservice \"dingtalk-hook\" created\n$ kubectl get pods -n kube-ops\nNAME                            READY     STATUS      RESTARTS   AGE\ndingtalk-hook-c4fcd8cd6-6r2b6   1/1       Running     0          45m\n......\n</code></pre> <p>\u90e8\u7f72\u6210\u529f\u540e\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u7ed9 <code>AlertManager</code> \u914d\u7f6e\u4e00\u4e2a <code>webhook</code> \u4e86\uff0c\u5728\u4e0a\u9762\u7684\u914d\u7f6e\u4e2d\u589e\u52a0\u4e00\u4e2a\u8def\u7531\u63a5\u6536\u5668</p> <pre><code>routes:\n- receiver: webhook\nmatch:\n  filesystem: node\nreceivers:\n- name: 'webhook'\n  webhook_configs:\n  - url: 'http://dingtalk-hook:5000'\n    send_resolved: true\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u4e86\u4e00\u4e2a\u540d\u4e3a webhook \u7684\u63a5\u6536\u5668\uff0c\u5730\u5740\u4e3a\uff1a<code>http://dingtalk-hook:5000</code>\uff0c\u8fd9\u4e2a\u5730\u5740\u5f53\u7136\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u90e8\u7f72\u7684\u9489\u9489\u7684 <code>webhook</code> \u7684\u63a5\u6536\u7a0b\u5e8f\u7684 <code>Service</code> \u5730\u5740\u3002</p> <p>\u7136\u540e\u6211\u4eec\u4e5f\u5728\u62a5\u8b66\u89c4\u5219\u4e2d\u6dfb\u52a0\u4e00\u6761\u5173\u4e8e\u8282\u70b9\u6587\u4ef6\u7cfb\u7edf\u4f7f\u7528\u60c5\u51b5\u7684\u62a5\u8b66\u89c4\u5219\uff0c\u6ce8\u610f <code>labels</code> \u6807\u7b7e\u8981\u5e26\u4e0a<code>alertname=NodeFilesystem</code>\uff0c\u8fd9\u6837\u62a5\u8b66\u4fe1\u606f\u5c31\u4f1a\u88ab <code>webook</code> \u8fd9\u4e00\u4e2a\u63a5\u6536\u5668\u6240\u5339\u914d\uff1a</p> <pre><code>- alert: NodeFilesystemUsage\n  expr: (node_filesystem_size_bytes{device=\"rootfs\"} - node_filesystem_free_bytes{device=\"rootfs\"}) / node_filesystem_size_bytes{device=\"rootfs\"} * 100 &gt; 10\n  for: 2m\n  labels:\n    filesystem: node\n  annotations:\n    summary: \"{{$labels.instance}}: High Filesystem usage detected\"\n    description: \"{{$labels.instance}}: Filesystem usage is above 10% (current value is: {{ $value }}\"\n</code></pre> <p>\u66f4\u65b0 <code>AlertManager</code> \u548c <code>Prometheus</code> \u7684 <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\uff08\u5148\u5220\u9664\u518d\u521b\u5efa\uff09\uff0c\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u4f1a\u513f\u6267\u884c <code>reload</code> \u64cd\u4f5c\u662f\u66f4\u65b0\u751f\u6548\uff1a</p> <pre><code>$ kubectl get svc -n kube-ops\nNAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE\nprometheus      NodePort    10.102.74.90    &lt;none&gt;        9093:31788/TCP,9090:30358/TCP    34d\n$ curl -X POST \"http://10.102.74.90:9093/-/reload\"\n$ curl -X POST \"http://10.102.74.90:9090/-/reload\"\n</code></pre> <p><code>AlertManager</code> \u548c <code>Prometheus</code> \u90fd\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684 reload \u64cd\u4f5c\u8fdb\u884c\u91cd\u65b0\u52a0\u8f7d</p> <p>\u90fd\u5b8c\u6210\u66f4\u65b0\u540e\uff0c\u518d\u6b21\u53bb Prometheus \u7684 Alert \u8def\u5f84\u4e0b\u9762\u67e5\u770b\u62a5\u8b66\u4fe1\u606f\uff1a</p> <p></p> <p>\u9694\u4e00\u4f1a\u513f\u5173\u4e8e\u8fd9\u4e2a\u8282\u70b9\u6587\u4ef6\u7cfb\u7edf\u7684\u62a5\u8b66\u5c31\u4f1a\u88ab\u89e6\u53d1\u4e86\uff0c\u7531\u4e8e\u8fd9\u4e2a\u62a5\u8b66\u4fe1\u606f\u5305\u542b\u4e00\u4e2a <code>filesystem=node</code> \u7684 <code>label</code> \u6807\u7b7e\uff0c\u6240\u4ee5\u4f1a\u88ab\u8def\u7531\u5230 <code>webhook</code> \u8fd9\u4e2a\u63a5\u6536\u5668\u4e2d\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u8fd9\u4e2a <code>dingtalk-hook</code> \uff0c\u89e6\u53d1\u540e\u53ef\u4ee5\u89c2\u5bdf\u8fd9\u4e2a Pod \u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs -f dingtalk-hook-cc677c46d-gf26f -n kube-ops\n * Serving Flask app \"app\" (lazy loading)\n * Environment: production\n   WARNING: Do not use the development server in a production environment.\n   Use a production WSGI server instead.\n * Debug mode: off\n * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)\n\n10.244.2.217 - - [28/Nov/2018 17:14:09] \"POST / HTTP/1.1\" 200 -\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 POST \u8bf7\u6c42\u5df2\u7ecf\u6210\u529f\u4e86\uff0c\u540c\u65f6\u8fd9\u4e2a\u65f6\u5019\u6b63\u5e38\u6765\u8bf4\u5c31\u53ef\u4ee5\u6536\u5230\u4e00\u6761\u9489\u9489\u6d88\u606f\u4e86\uff1a</p> <p></p>"},{"location":"chap3/12gpu_monitor/","title":"\u7b2c\u5341\u4e8c\u8282 \u76d1\u63a7Kubernetes\u96c6\u7fa4\u7684GPU\u8d44\u6e90","text":""},{"location":"chap3/12gpu_monitor/#_1","title":"\u4e00\u3001\u80cc\u666f\u8bf4\u660e","text":""},{"location":"chap3/12gpu_monitor/#11","title":"1.1 \u9700\u6c42\u8bf4\u660e","text":"<p>\u5bf9\u4e8eSRE\u56e2\u961f\u6765\u8bf4\uff0c\u5b9e\u73b0\u76d1\u63a7AI\u3001\u9ad8\u6027\u80fd\u8ba1\u7b97\u5e73\u53f0\u4e0a\u5927\u89c4\u6a21GPU\u8d44\u6e90\uff0c\u81f3\u5173\u91cd\u8981\u3002SRE\u56e2\u961f\u53ef\u4ee5\u901a\u8fc7GPU\u6307\u6807\u4e86\u89e3\u5de5\u4f5c\u8d1f\u8f7d\u7b49\u76f8\u5173\u6027\u80fd\uff0c\u4ece\u800c\u4f18\u5316\u8d44\u6e90\u5206\u914d\uff0c\u63d0\u5347\u8d44\u6e90\u5229\u7528\u7387\u53ca\u5f02\u5e38\u8bca\u65ad\uff0c\u4ee5\u63d0\u9ad8\u6570\u636e\u4e2d\u5fc3\u8d44\u6e90\u7684\u6574\u4f53\u6548\u80fd\u3002\u9664\u4e86SRE\u53ca\u57fa\u7840\u8bbe\u65bd\u56e2\u961f\u4e4b\u5916\uff0c\u4e0d\u7ba1\u4f60\u662f\u4ece\u4e8bGPU\u52a0\u901f\u65b9\u5411\u7684\u7814\u7a76\u4eba\u5458\uff0c\u8fd8\u662f\u6570\u636e\u4e2d\u5fc3\u67b6\u6784\u5e08\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u76f8\u5173\u76d1\u63a7\u6307\u6807\uff0c\u4e86\u89e3GPU\u5229\u7528\u7387\u548c\u5de5\u4f5c\u9971\u548c\u5ea6\u4ee5\u8fdb\u884c\u5bb9\u91cf\u89c4\u5212\u53ca\u4efb\u52a1\u8c03\u5ea6\u7b49\u3002</p> <p>\u968f\u7740AI/ML\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5bb9\u5668\u5316\uff0c\u8c03\u5ea6\u5e73\u53f0\u91c7\u7528\u5177\u5907\u52a8\u6001\u6269\u7f29\u7279\u6027\u7684Kubernetes\u89e3\u51b3\u65b9\u6848\uff0c\u9488\u5bf9\u5176\u76d1\u63a7\u7684\u6025\u8feb\u6027\u65e5\u76ca\u63d0\u5347\u3002\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecdNVIDIA\u6570\u636e\u4e2d\u5fc3GPU\u7ba1\u7406\u5668\uff08DCGM\uff09\uff0c\u4ee5\u53ca\u5982\u4f55\u5c06\u5176\u96c6\u6210\u5230Prometheus\u548cGrafana\u7b49\u5f00\u6e90\u5de5\u5177\u4e2d\uff0c\u4ee5\u5b9e\u73b0Kubernetes\u7684GPU\u76d1\u63a7\u7684\u6574\u4f53\u89e3\u51b3\u65b9\u6848\u3002</p> <p></p>"},{"location":"chap3/12gpu_monitor/#12-nvidia-dcgm","title":"1.2 NVIDIA DCGM","text":"<p>NVIDIA DCGM\u662f\u7528\u4e8e\u7ba1\u7406\u548c\u76d1\u63a7\u57fa\u4e8eLinux\u7cfb\u7edf\u7684NVIDIA GPU\u5927\u89c4\u6a21\u96c6\u7fa4\u7684\u4e00\u4f53\u5316\u5de5\u5177\u3002\u5b83\u662f\u4e00\u4e2a\u4f4e\u5f00\u9500\u7684\u5de5\u5177\uff0c\u63d0\u4f9b\u591a\u79cd\u80fd\u529b\uff0c\u5305\u62ec\u4e3b\u52a8\u5065\u5eb7\u76d1\u63a7\u3001\u8bca\u65ad\u3001\u7cfb\u7edf\u9a8c\u8bc1\u3001\u7b56\u7565\u3001\u7535\u6e90\u548c\u65f6\u949f\u7ba1\u7406\u3001\u914d\u7f6e\u7ba1\u7406\u548c\u5ba1\u8ba1\u7b49\u3002</p> <p>DCGM\u63d0\u4f9b\u7528\u4e8e\u6536\u96c6GPU\u9065\u6d4b\u7684API\u3002\u7279\u522b\u503c\u5f97\u5173\u6ce8\u7684\u662fGPU\u5229\u7528\u7387\u6307\u6807\u3001\u5185\u5b58\u6307\u6807\u548c\u6d41\u91cf\u6307\u6807\u3002DCGM\u63d0\u4f9b\u4e86\u5404\u79cd\u8bed\u8a00\u7684\u5ba2\u6237\u7aef\uff0c\u5982C\u548cPython\u3002\u5bf9\u4e8e\u4e0e\u5bb9\u5668\u751f\u6001\u7cfb\u7edf\u7684\u96c6\u6210\uff0c\u63d0\u4f9b\u57fa\u4e8eDCGM APIs\u7684Go\u7ed1\u5b9a\u5b9e\u73b0\u3002</p>"},{"location":"chap3/12gpu_monitor/#13-nvidia-exporter","title":"1.3 NVIDIA exporter","text":"<p>\u5728\u524d\u9762\u4ecb\u7ecd\u7684Go API\u57fa\u7840\u4e0a\uff0c\u53ef\u4ee5\u901a\u8fc7<code>DCGM</code>\u5411<code>Prometheus</code>\u66b4\u9732GPU\u6307\u6807\u3002NVIDIA\u4e3a\u6b64\u6784\u5efa\u4e86<code>dcgm-exporter</code>\u7684\u9879\u76ee\u3002</p> <p><code>dcgm-exporter</code> \u4f7f\u7528 Go \u7ed1\u5b9a\u4ece DCGM \u6536\u96c6 GPU \u9065\u6d4b\u6570\u636e\uff0c\u7136\u540e\u901a\u8fc7 http \u63a5\u53e3 (<code>/metrics</code>) \u5411 Prometheus \u66b4\u9732\u6307\u6807\u3002</p> <p><code>dcgm-exporter</code>\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528csv\u683c\u5f0f\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u5b9a\u5236DCGM\u6536\u96c6\u7684GPU\u6307\u6807\u3002</p>"},{"location":"chap3/12gpu_monitor/#14-kubelet","title":"1.4 Kubelet\u8bbe\u5907\u76d1\u63a7","text":"<p><code>dcgm-exporter</code>\u6536\u96c6\u4e86\u8282\u70b9\u4e0a\u6240\u6709\u53ef\u7528GPU\u7684\u6307\u6807\u3002</p> <p>\u7136\u800c\uff0c\u5728Kubernetes\u4e2d\uff0c\u5f53\u4e00\u4e2a\u8282\u70b9\u8bf7\u6c42GPU\u8d44\u6e90\u65f6\uff0c\u53ef\u80fd\u4e0d\u80fd\u786e\u5b9a\u54ea\u4e9bGPU\u4f1a\u88ab\u5206\u914d\u7ed9pod\u3002</p> <p>\u4ecev1.13\u5f00\u59cb\uff0cKubelet\u589e\u52a0\u4e86\u4e00\u4e2a\u8bbe\u5907\u76d1\u63a7\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u8fc7pod-resources\u5957\u63a5\u5b57\u4e86\u89e3\u5206\u914d\u7ed9pod\u7684\u8bbe\u5907\uff0c\u5176\u4e2d\u5305\u62ecpod\u540d\u79f0\u3001pod\u547d\u540d\u7a7a\u95f4\u548c\u8bbe\u5907ID\u3002</p> <p><code>dcgm-exporter</code>\u4e2d\u7684http\u670d\u52a1\u8fde\u63a5\u5230<code>kubelet</code>\u4e2d\u7684<code>pod-resources</code>\u670d\u52a1(<code>/var/lib/kubelet/pod-resources</code>)\u6765\u8bc6\u522bpod\u4e0a\u8fd0\u884c\u7684GPU\u8bbe\u5907\uff0c\u5e76\u5c06GPU\u8bbe\u5907\u7684pod\u76f8\u5173\u4fe1\u606f\u6dfb\u52a0\u5230\u6536\u96c6\u7684\u6307\u6807\u4e2d\u3002</p> <p></p>"},{"location":"chap3/12gpu_monitor/#gpu","title":"\u4e8c\u3001GPU\u76d1\u63a7","text":""},{"location":"chap3/12gpu_monitor/#21","title":"2.1 \u90e8\u7f72\u8bf4\u660e","text":"<p>\u4e0b\u9762\u662f\u4e00\u4e9b\u8bbe\u7f6edcgm-exporter\u7684\u793a\u4f8b\u3002\u5982\u679c\u4f7f\u7528NVIDIA GPU Operator\uff0c\u90a3\u4e48dcgm-exporter\u540c\u6837\u662f\u90e8\u7f72\u7ec4\u4ef6\u4e4b\u4e00\u3002</p> <p>\u6587\u6863\u4e2d\u5305\u542b\u4e86\u8bbe\u7f6eKubernetes\u96c6\u7fa4\u7684\u6b65\u9aa4\u3002\u4e3a\u4e86\u7b80\u6d01\u8d77\u89c1\uff0c\u5047\u5b9a\u5df2\u7ecf\u5b58\u5728\u4e00\u4e2a\u8fd0\u884c\u7740NVIDIA\u8f6f\u4ef6\u7ec4\u4ef6\u7684Kubernetes\u96c6\u7fa4\uff0c\u4f8b\u5982\uff0c\u9a71\u52a8\u7a0b\u5e8f\u3001\u5bb9\u5668\u8fd0\u884c\u65f6\u548cKubernetes\u8bbe\u5907\u63d2\u4ef6\u7b49\u3002\u5728\u4f7f\u7528Prometheus Operator\u90e8\u7f72Prometheus\u65f6\uff0c\u8fd8\u53ef\u4ee5\u65b9\u4fbf\u5730\u90e8\u7f72Grafana\u3002\u5728\u8be5\u7bc7\u6587\u7ae0\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u4f7f\u7528\u4e86\u5355\u8282\u70b9Kubernetes\u96c6\u7fa4\u3002</p> <p>\u5728\u8bbe\u7f6e\u793e\u533a\u63d0\u4f9b\u7684Prometheus Operator\u7684Helm chart\u65f6\uff0c\u5fc5\u987b\u66b4\u9732Grafana\u4f9b\u5916\u90e8\u8bbf\u95ee\uff0c\u5e76\u4e14<code>prometheusSpec.serviceMonitorSelectorNilUsesHelmValues</code>\u5fc5\u987b\u8bbe\u7f6e\u4e3afalse</p> <p>\u7b80\u5355\u6765\u8bf4\uff0c\u8bbe\u7f6e\u76d1\u63a7\u5305\u62ec\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002</p> <pre><code>\n$ helm repo add prometheus-community \\\nhttps://prometheus-community.github.io/helm-charts\n\n$ helm repo update\n$ helm inspect values prometheus-community/kube-prometheus-stack &gt; /tmp/kube-prometheus-stack.values\n# Edit /tmp/kube-prometheus-stack.values in your favorite editor\n# according to the documentation\n# This exposes the service via NodePort so that Prometheus/Grafana\n# are accessible outside the cluster with a browser\n$ helm install prometheus-community/kube-prometheus-stack \\\n--create-namespace --namespace prometheus \\\n--generate-name \\\n--set prometheus.service.type=NodePort \\\n--set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false\n</code></pre> <p>\u6b64\u65f6\uff0c\u96c6\u7fa4\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff0c\u5176\u4e2d\u6240\u6709\u7684Prometheus pods\u548c\u670d\u52a1\u5065\u5eb7\u8fd0\u884c\u3002</p> <pre><code>\n$ kubectl get pods -A\nNAMESPACE     NAME                                                              READY   STATUS    RESTARTS   AGE\nkube-system   calico-kube-controllers-8f59968d4-zrsdt                           1/1     Running   0          18m\nkube-system   calico-node-c257f                                                 1/1     Running   0          18m\nkube-system   coredns-f9fd979d6-c52hz                                           1/1     Running   0          19m\nkube-system   coredns-f9fd979d6-ncbdp                                           1/1     Running   0          19m\nkube-system   etcd-ip-172-31-27-93                                              1/1     Running   1          19m\nkube-system   kube-apiserver-ip-172-31-27-93                                    1/1     Running   1          19m\nkube-system   kube-controller-manager-ip-172-31-27-93                           1/1     Running   1          19m\nkube-system   kube-proxy-b9szp                                                  1/1     Running   1          19m\nkube-system   kube-scheduler-ip-172-31-27-93                                    1/1     Running   1          19m\nkube-system   nvidia-device-plugin-1602308324-jg842                             1/1     Running   0          17m\nprometheus    alertmanager-kube-prometheus-stack-1602-alertmanager-0            2/2     Running   0          92s\nprometheus    kube-prometheus-stack-1602-operator-c4bc5c4d5-f5vzc               2/2     Running   0          98s\nprometheus    kube-prometheus-stack-1602309230-grafana-6b4fc97f8f-66kdv         2/2     Running   0          98s\nprometheus    kube-prometheus-stack-1602309230-kube-state-metrics-76887bqzv2b   1/1     Running   0          98s\nprometheus    kube-prometheus-stack-1602309230-prometheus-node-exporter-rrk9l   1/1     Running   0          98s\nprometheus    prometheus-kube-prometheus-stack-1602-prometheus-0                3/3     Running   1          92s\n\n\n$ kubectl get pods -A\nNAMESPACE     NAME                                                              READY   STATUS    RESTARTS   AGE\nkube-system   calico-kube-controllers-8f59968d4-zrsdt                           1/1     Running   0          18m\nkube-system   calico-node-c257f                                                 1/1     Running   0          18m\nkube-system   coredns-f9fd979d6-c52hz                                           1/1     Running   0          19m\nkube-system   coredns-f9fd979d6-ncbdp                                           1/1     Running   0          19m\nkube-system   etcd-ip-172-31-27-93                                              1/1     Running   1          19m\nkube-system   kube-apiserver-ip-172-31-27-93                                    1/1     Running   1          19m\nkube-system   kube-controller-manager-ip-172-31-27-93                           1/1     Running   1          19m\nkube-system   kube-proxy-b9szp                                                  1/1     Running   1          19m\nkube-system   kube-scheduler-ip-172-31-27-93                                    1/1     Running   1          19m\nkube-system   nvidia-device-plugin-1602308324-jg842                             1/1     Running   0          17m\nprometheus    alertmanager-kube-prometheus-stack-1602-alertmanager-0            2/2     Running   0          92s\nprometheus    kube-prometheus-stack-1602-operator-c4bc5c4d5-f5vzc               2/2     Running   0          98s\nprometheus    kube-prometheus-stack-1602309230-grafana-6b4fc97f8f-66kdv         2/2     Running   0          98s\nprometheus    kube-prometheus-stack-1602309230-kube-state-metrics-76887bqzv2b   1/1     Running   0          98s\nprometheus    kube-prometheus-stack-1602309230-prometheus-node-exporter-rrk9l   1/1     Running   0          98s\nprometheus    prometheus-kube-prometheus-stack-1602-prometheus-0                3/3     Running   1          92s\n\n\n$ kubectl get svc -A\nNAMESPACE     NAME                                                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                        AGE\ndefault       kubernetes                                                  ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                        20m\nkube-system   kube-dns                                                    ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP         20m\nkube-system   kube-prometheus-stack-1602-coredns                          ClusterIP   None             &lt;none&gt;        9153/TCP                       2m18s\nkube-system   kube-prometheus-stack-1602-kube-controller-manager          ClusterIP   None             &lt;none&gt;        10252/TCP                      2m18s\nkube-system   kube-prometheus-stack-1602-kube-etcd                        ClusterIP   None             &lt;none&gt;        2379/TCP                       2m18s\nkube-system   kube-prometheus-stack-1602-kube-proxy                       ClusterIP   None             &lt;none&gt;        10249/TCP                      2m18s\nkube-system   kube-prometheus-stack-1602-kube-scheduler                   ClusterIP   None             &lt;none&gt;        10251/TCP                      2m18s\nkube-system   kube-prometheus-stack-1602-kubelet                          ClusterIP   None             &lt;none&gt;        10250/TCP,10255/TCP,4194/TCP   2m12s\nprometheus    alertmanager-operated                                       ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP     2m12s\nprometheus    kube-prometheus-stack-1602-alertmanager                     ClusterIP   10.104.106.174   &lt;none&gt;        9093/TCP                       2m18s\nprometheus    kube-prometheus-stack-1602-operator                         ClusterIP   10.98.165.148    &lt;none&gt;        8080/TCP,443/TCP               2m18s\nprometheus    kube-prometheus-stack-1602-prometheus                       NodePort    10.105.3.19      &lt;none&gt;        9090:30090/TCP                 2m18s\nprometheus    kube-prometheus-stack-1602309230-grafana                    ClusterIP   10.100.178.41    &lt;none&gt;        80/TCP                         2m18s\nprometheus    kube-prometheus-stack-1602309230-kube-state-metrics         ClusterIP   10.100.119.13    &lt;none&gt;        8080/TCP                       2m18s\nprometheus    kube-prometheus-stack-1602309230-prometheus-node-exporter   ClusterIP   10.100.56.74     &lt;none&gt;        9100/TCP                       2m18s\nprometheus    prometheus-operated                                         ClusterIP   None             &lt;none&gt;        9090/TCP                       2m12s\n</code></pre> <p>\u90e8\u7f72<code>dcgm-exporter</code></p> <pre><code>$ helm repo add gpu-helm-charts \\\nhttps://nvidia.github.io/gpu-monitoring-tools/helm-charts\n$ helm repo update\n</code></pre> <p>\u4f7f\u7528helm\u5b89\u88c5</p> <pre><code>$ helm install \\\n   --generate-name \\\n   gpu-helm-charts/dcgm-exporter\n</code></pre> <p>\u7ed3\u679c\u9a8c\u8bc1</p> <pre><code>$ helm ls\nNAME                            NAMESPACE       REVISION        APP VERSION\ndcgm-exporter-1-1601677302      default         1               dcgm-exporter-1.1.0             2.0.10\nnvidia-device-plugin-1601662841 default         1          nvidia-device-plugin-0.7.0      0.7.0\n</code></pre> <p>Prometheus\u548cGrafana\u670d\u52a1\u66b4\u9732\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl get svc -A\nNAMESPACE     NAME                                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                        AGE\ndefault       dcgm-exporter                                             ClusterIP   10.99.34.128     &lt;none&gt;        9400/TCP                       43d\ndefault       kubernetes                                                  ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP                        20m\nkube-system   kube-dns                                                    ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP         20m\nkube-system   kube-prometheus-stack-1602-coredns                          ClusterIP   None             &lt;none&gt;        9153/TCP                       2m18s\nkube-system   kube-prometheus-stack-1602-kube-controller-manager          ClusterIP   None             &lt;none&gt;        10252/TCP                      2m18s\nkube-system   kube-prometheus-stack-1602-kube-etcd                        ClusterIP   None             &lt;none&gt;        2379/TCP                       2m18s\nkube-system   kube-prometheus-stack-1602-kube-proxy                       ClusterIP   None             &lt;none&gt;        10249/TCP                      2m18s\nkube-system   kube-prometheus-stack-1602-kube-scheduler                   ClusterIP   None             &lt;none&gt;        10251/TCP                      2m18s\nkube-system   kube-prometheus-stack-1602-kubelet                          ClusterIP   None             &lt;none&gt;        10250/TCP,10255/TCP,4194/TCP   2m12s\nprometheus    alertmanager-operated                                       ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP     2m12s\nprometheus    kube-prometheus-stack-1602-alertmanager                     ClusterIP   10.104.106.174   &lt;none&gt;        9093/TCP                       2m18s\nprometheus    kube-prometheus-stack-1602-operator                         ClusterIP   10.98.165.148    &lt;none&gt;        8080/TCP,443/TCP               2m18s\nprometheus    kube-prometheus-stack-1602-prometheus                       NodePort    10.105.3.19      &lt;none&gt;        9090:30090/TCP                 2m18s\nprometheus    kube-prometheus-stack-1602309230-grafana                    ClusterIP   10.100.178.41    &lt;none&gt;        80:32032/TCP                   2m18s\nprometheus    kube-prometheus-stack-1602309230-kube-state-metrics         ClusterIP   10.100.119.13    &lt;none&gt;        8080/TCP                       2m18s\nprometheus    kube-prometheus-stack-1602309230-prometheus-node-exporter   ClusterIP   10.100.56.74     &lt;none&gt;        9100/TCP                       2m18s\nprometheus    prometheus-operated  \n</code></pre> <p>\u4f7f\u752832032\u7aef\u53e3\u66b4\u9732\u7684Grafana\u670d\u52a1\uff0c\u8bbf\u95eeGrafana\u4e3b\u9875\u3002\u4f7f\u7528Prometheus chart\u4e2d\u8bbe\u7f6e\u7684\u51ed\u8bc1\u767b\u5f55\u5230\u4eea\u8868\u677f\uff1a<code>prometheus.values</code>\u4e2d\u7684<code>adminPassword</code>\u5b57\u6bb5\u3002</p> <p>\u73b0\u5728\u8981\u542f\u52a8\u4e00\u4e2a\u7528\u4e8eGPU\u6307\u6807\u7684Grafana\u4eea\u8868\u677f\uff0c\u8bf7\u4eceGrafana\u4eea\u8868\u677f\uff08<code>https://grafana.com/grafana/dashboards/12239</code>\uff09\u5bfc\u5165NVIDIA\u4eea\u8868\u677f\u3002</p> <p></p> <p>\u73b0\u5728\u8fd0\u884c\u4e00\u4e9bGPU\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u4e3a\u6b64\uff0cDCGM\u793e\u533a\u63d0\u4f9b\u4e86\u4e00\u4e2a\u540d\u4e3a<code>dcgmproftester</code>\u7684<code>CUDA</code>\u8d1f\u8f7d\u751f\u6210\u5668\uff0c\u5b83\u53ef\u4ee5\u7528\u6765\u751f\u6210\u786e\u5b9a\u6027\u7684CUDA\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u7528\u4e8e\u8bfb\u53d6\u548c\u9a8c\u8bc1GPU\u6307\u6807\u3002</p> <p>\u8981\u751f\u6210\u4e00\u4e2aPod\uff0c\u9996\u5148\u5fc5\u987b\u4e0b\u8f7dDCGM\u5e76\u5c06\u5236\u6210\u955c\u50cf\u3002\u4ee5\u4e0b\u811a\u672c\u521b\u5efa\u4e86\u4e00\u4e2a\u53ef\u7528\u4e8e\u8fd0\u884c<code>dcgmproftester</code>\u7684\u5bb9\u5668\u3002\u8fd9\u4e2a\u5bb9\u5668\u53ef\u4ee5\u5728NVIDIA DockerHub\u4ed3\u5e93\u4e2d\u627e\u5230\u3002</p> <pre><code>#!/usr/bin/env bash\nset -exo pipefail\n\nmkdir -p /tmp/dcgm-docker\npushd /tmp/dcgm-docker\n\ncat &gt; Dockerfile &lt;&lt;EOF\nARG BASE_DIST\nARG CUDA_VER\nFROM nvidia/cuda:\\${CUDA_VER}-base-\\${BASE_DIST}\nLABEL io.k8s.display-name=\"NVIDIA dcgmproftester\"\n\nARG DCGM_VERSION\n\nWORKDIR /dcgm\nRUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \\\n    libgomp1 \\\n    wget &amp;&amp; \\\n    rm -rf /var/lib/apt/lists/* &amp;&amp; \\\n    wget --no-check-certificate https://developer.download.nvidia.com/compute/redist/dcgm/\\${DCGM_VERSION}/DEBS/datacenter-gpu-manager_\\${DCGM_VERSION}_amd64.deb &amp;&amp; \\\n    dpkg -i datacenter-gpu-manager_*.deb &amp;&amp; \\\n    rm -f datacenter-gpu-manager_*.deb\n\nENTRYPOINT [\"/usr/bin/dcgmproftester11\"]\nEOF\n\nDIR=.\nDCGM_REL_VERSION=2.0.10\nBASE_DIST=ubuntu18.04\nCUDA_VER=11.0\nIMAGE_NAME=nvidia/samples:dcgmproftester-$DCGM_REL_VERSION-cuda$CUDA_VER-$BASE_DIST\n\n\ndocker build --pull \\\n        -t \"$IMAGE_NAME\" \\\n        --build-arg DCGM_VERSION=$DCGM_REL_VERSION \\\n        --build-arg BASE_DIST=$BASE_DIST \\\n        --build-arg CUDA_VER=$CUDA_VER \\\n        --file Dockerfile \\\n        \"$DIR\"\n\npopd\n</code></pre> <p>\u5728Kubernetes\u96c6\u7fa4\u4e0a\u90e8\u7f72\u5bb9\u5668\u4e4b\u524d\uff0c\u5c1d\u8bd5\u76f4\u63a5\u4f7f\u7528Docker\u8fd0\u884c\u5b83\u3002\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u901a\u8fc7\u6307\u5b9a-t 1004\u6765\u4f7f\u7528Tensor Cores\u89e6\u53d1FP16\u77e9\u9635\u4e58\u6cd5\uff0c\u5e76\u4ee5<code>-d 45</code>\uff0845\u79d2\uff09\u7684\u901f\u5ea6\u8fd0\u884c\u6d4b\u8bd5\u3002\u60a8\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539-t\u53c2\u6570\u6765\u5c1d\u8bd5\u8fd0\u884c\u5176\u4ed6\u5de5\u4f5c\u8d1f\u8f7d\u3002</p> <pre><code>\nSkipping CreateDcgmGroups() since DCGM validation is disabled\nCU_DEVICE_ATTRIBUTE_MAX_THREADS_PER_MULTIPROCESSOR: 1024\nCU_DEVICE_ATTRIBUTE_MULTIPROCESSOR_COUNT: 40\nCU_DEVICE_ATTRIBUTE_MAX_SHARED_MEMORY_PER_MULTIPROCESSOR: 65536\nCU_DEVICE_ATTRIBUTE_COMPUTE_CAPABILITY_MAJOR: 7\nCU_DEVICE_ATTRIBUTE_COMPUTE_CAPABILITY_MINOR: 5\nCU_DEVICE_ATTRIBUTE_GLOBAL_MEMORY_BUS_WIDTH: 256\nCU_DEVICE_ATTRIBUTE_MEMORY_CLOCK_RATE: 5001000\nMax Memory bandwidth: 320064000000 bytes (320.06 GiB)\nCudaInit completed successfully.\n\nSkipping WatchFields() since DCGM validation is disabled\nTensorEngineActive: generated ???, dcgm 0.000 (27605.2 gflops)\nTensorEngineActive: generated ???, dcgm 0.000 (28697.6 gflops)\n</code></pre> <p>\u5c06\u5176\u90e8\u7f72\u5230Kubernetes\u96c6\u7fa4\u4e0a\uff0c\u53ef\u4ee5\u901a\u8fc7Grafana\u4eea\u8868\u677f\u89c2\u6d4b\u76f8\u5e94\u7684\u6307\u6807\u3002\u4e0b\u9762\u7684\u4ee3\u7801\u793a\u4f8b\uff1a</p> <pre><code>cat &lt;&lt; EOF | kubectl create -f -\n apiVersion: v1\n kind: Pod\n metadata:\n   name: dcgmproftester\n spec:\n   restartPolicy: OnFailure\n   containers:\n   - name: dcgmproftester11\n     image: nvidia/samples:dcgmproftester-2.0.10-cuda11.0-ubuntu18.04\n     args: [\"--no-dcgm-validation\", \"-t 1004\", \"-d 120\"]\n     resources:\n       limits:\n          nvidia.com/gpu: 1\n     securityContext:\n       capabilities:\n          add: [\"SYS_ADMIN\"]\n\nEOF\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230dcgmproftester pod\u5065\u5eb7\u8fd0\u884c\uff0c\u968f\u540e\u6307\u6807\u663e\u793a\u5728Grafana\u4eea\u8868\u677f\u4e0a\u3002GPU\u5229\u7528\u7387(GrActive)\u5df2\u7ecf\u8fbe\u5230\u4e8698%\u7684\u5229\u7528\u7387\u5cf0\u503c\uff0c\u53ef\u80fd\u8fd8\u4f1a\u53d1\u73b0\u5176\u4ed6\u6709\u8da3\u7684\u6307\u6807\uff0c\u6bd4\u5982\u529f\u7387\u6216GPU\u5185\u5b58\u3002</p> <pre><code>\n$ kubectl get pods -A\nNAMESPACE     NAME                                                              \nREADY   STATUS    RESTARTS   AGE\n...\ndefault       dcgmproftester                                                    \n1/1     Running   0          6s\n</code></pre> <p></p> <p>DCGM\u6700\u8fd1\u589e\u52a0\u4e86\u4e00\u4e9b\u8bbe\u5907\u7ea7\u6307\u6807\u3002\u5176\u4e2d\u5305\u62ec\u7ec6\u7c92\u5ea6\u7684GPU\u5229\u7528\u7387\u6307\u6807\uff0c\u53ef\u4ee5\u76d1\u63a7SM\u5360\u7528\u7387\u548cTensor Core\u5229\u7528\u7387\u3002\u6709\u5173\u66f4\u591a\u4fe1\u606f\uff0c\u53ef\u4ee5\u67e5\u770bDCGM\u7528\u6237\u6307\u5357\u4e2d\u7684Profiling Metrics\u3002</p> <p>\u4e0b\u56fe\u663e\u793a\u4e86 Prometheus\u83b7\u53d6\u7684\u7531<code>dcgm-exporter</code> \u63d0\u4f9b\u7684\u76d1\u63a7\u6307\u6807\u3002</p> <p></p> <p>\u60a8\u53ef\u4ee5\u81ea\u5b9a\u4e49Grafana\u4eea\u8868\u677f\uff0c\u4ee5\u5305\u542bDCGM\u7684\u5176\u4ed6\u6307\u6807\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7\u7f16\u8f91 repo \u4e0a\u63d0\u4f9b\u7684 Grafana JSON \u6587\u4ef6\u5c06 Tensor Core \u5229\u7528\u7387\u6dfb\u52a0\u5230\u4eea\u8868\u677f\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528Grafana\u7684Web\u754c\u9762\u8fdb\u884c\u7f16\u8f91\u3002</p> <p>\u4e0b\u9762\u7684\u4eea\u8868\u677f\u5305\u62ecTensor Core\u5229\u7528\u7387\u3002\u91cd\u65b0\u542f\u52a8dcgmproftester\u5bb9\u5668\u540e\uff0c\u4f60\u53ef\u4ee5\u770b\u5230T4\u4e0a\u7684Tensor Core\u5df2\u7ecf\u8fbe\u5230\u4e86\u7ea687%\u7684\u5229\u7528\u7387\u3002</p> <p></p> <p>\u901a\u8fc7\u5c06GPU\u6307\u6807\u4f5c\u4e3a\u81ea\u5b9a\u4e49\u6307\u6807\u548cPrometheus Adapter\uff0c\u53ef\u4ee5\u4f7f\u7528Horizontal Pod Autoscaler\u6839\u636eGPU\u5229\u7528\u7387\u6216\u5176\u4ed6\u6307\u6807\u6765\u6269\u5c55Pod\u6570\u91cf\u3002</p>"},{"location":"chap3/16Adv_Prometheus_Del_index/","title":"\u7b2c\u5341\u8282 Prometheus \u5220\u9664\u6570\u636e\u6307\u6807","text":"<p>\u6709\u7684\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u4ece <code>Prometheus</code> \u4e2d\u5220\u9664\u4e00\u4e9b\u4e0d\u9700\u8981\u7684\u6570\u636e\u6307\u6807\uff0c\u6216\u8005\u53ea\u662f\u5355\u7eaf\u7684\u60f3\u8981\u91ca\u653e\u4e00\u4e9b\u78c1\u76d8\u7a7a\u95f4\u3002<code>Prometheus</code> \u4e2d\u7684\u65f6\u95f4\u5e8f\u5217\u53ea\u80fd\u901a\u8fc7 <code>HTTP API</code> \u6765\u8fdb\u884c\u7ba1\u7406\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u7ba1\u7406\u65f6\u95f4\u5e8f\u5217\u7684 API \u662f\u88ab\u7981\u7528\u7684\uff0c\u8981\u542f\u7528\u5b83\uff0c\u6211\u4eec\u9700\u8981\u5728 <code>Prometheus</code> \u7684\u542f\u52a8\u53c2\u6570\u4e2d\u6dfb\u52a0<code>--web.enable-admin-api</code>\u8fd9\u4e2a\u53c2\u6570\uff0c\u6bd4\u5982\u6211\u4eec\u524d\u9762\u7684\u6587\u7ae0\u4e2d\u901a\u8fc7Kubernetes Pod\u6765\u90e8\u7f72\u7684\uff0c\u5219\u540c\u6837\u9700\u8981\u6dfb\u52a0\u4e0a\u8fd9\u4e2a\u53c2\u6570\uff1a</p> <pre><code>command:\n- \"/bin/prometheus\"\nargs:\n- \"--config.file=/etc/prometheus/prometheus.yml\"\n- \"--storage.tsdb.path=/prometheus\"\n- \"--storage.tsdb.retention=24h\"\n- \"--web.enable-admin-api\"  # \u63a7\u5236\u5bf9admin HTTP API\u7684\u8bbf\u95ee\uff0c\u5176\u4e2d\u5305\u62ec\u5220\u9664\u65f6\u95f4\u5e8f\u5217\u7b49\u529f\u80fd\n- \"--web.enable-lifecycle\"  # \u652f\u6301\u70ed\u66f4\u65b0\uff0c\u76f4\u63a5\u6267\u884clocalhost:9090/-/reload\u7acb\u5373\u751f\u6548\n</code></pre> <p>\u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f Prometheus Operator \u90e8\u7f72\u7684\u8bdd\uff0c\u8c8c\u4f3c\u5b98\u65b9\u6ca1\u6709\u7ed9\u51fa\u8fd9\u4e2a\u53c2\u6570\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7\u7f16\u8f91\u5bf9\u5e94\u7684 Staefulset \u8d44\u6e90\u5bf9\u8c61\u6765\u6dfb\u52a0\u8be5\u53c2\u6570\u3002</p>"},{"location":"chap3/16Adv_Prometheus_Del_index/#1","title":"1 \u5220\u9664\u65f6\u95f4\u5e8f\u5217\u6307\u6807","text":"<p>\u63a7\u5236\u7ba1\u7406 <code>API</code> \u542f\u7528\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8bed\u6cd5\u6765\u5220\u9664\u4e0e\u67d0\u4e2a\u6807\u7b7e\u5339\u914d\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\u6307\u6807\uff1a</p> <pre><code>$ curl -X POST -g 'http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]={kubernetes_name=\"redis\"}'\n</code></pre> <p>\u5c06 localhost \u66ff\u6362\u6210\u4f60\u81ea\u5df1\u7684 Prometheus \u7684\u8bbf\u95ee\u5730\u5740\u5373\u53ef\u3002</p> <p>\u4e0a\u9762\u547d\u4ee4\u5c31\u53ef\u4ee5\u7528\u4e8e\u5220\u9664\u5177\u6709\u6807\u7b7e<code>kubernetes_name=\"redis\"</code>\u7684\u65f6\u95f4\u5e8f\u5217\u6307\u6807\u3002</p> <p>\u5982\u679c\u8981\u5220\u9664\u4e00\u4e9b <code>job</code> \u4efb\u52a1\u6216\u8005 <code>instance</code> \u7684\u6570\u636e\u6307\u6807\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ curl -X POST -g 'http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]={job=\"kubernetes-service-endpoints\"}'\n$ curl -X POST -g 'http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]={instance=\"10.244.2.158:9090\"}'\n</code></pre> <p>\u8981\u4ece <code>Prometheus</code> \u4e2d\u5220\u9664\u6240\u6709\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ curl -X POST -g 'http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]={__name__=~\".+\"}'\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e0a\u9762\u7684 API \u8c03\u7528\u5e76\u4e0d\u4f1a\u7acb\u5373\u5220\u9664\u6570\u636e\uff0c\u5b9e\u9645\u6570\u636e\u4efb\u7136\u8fd8\u5b58\u5728\u78c1\u76d8\u4e0a\uff0c\u4f1a\u5728\u540e\u9762\u8fdb\u884c\u6570\u636e\u6e05\u7406\u3002</p> <p>\u8981\u786e\u5b9a\u4f55\u65f6\u5220\u9664\u65e7\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528<code>--storage.tsdb.retention</code>\u53c2\u6570\u8fdb\u884c\u914d\u7f6e\uff08\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cPrometheus \u4f1a\u5c06\u6570\u636e\u4fdd\u755915\u5929\uff09\u3002</p>"},{"location":"chap3/1prometheus_setup/","title":"\u7b2c\u4e00\u8282 Kubernetes\u4f7f\u7528Prometheus\u642d\u5efa\u76d1\u63a7\u5e73\u53f0(2018)","text":"<p>\u6700\u8fd1\u5728\u6d4b\u8bd5\u73af\u5883\u642d\u5efa\u4e86Kubernetes\u96c6\u7fa4\u73af\u5883\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u662f\u76f4\u63a5\u901a\u8fc7Dashboard\u7684\u8d44\u6e90\u7edf\u8ba1\u56fe\u6807\u8fdb\u884c\u89c2\u5bdf\u7684\uff0c\u4f46\u662f\u5f88\u663e\u7136\u5982\u679c\u8981\u4e0a\u5230\u751f\u4ea7\u73af\u5883\uff0c\u5c31\u9700\u8981\u66f4\u81ea\u52a8\u5316\u7684\u65b9\u5f0f\u6765\u5bf9\u96c6\u7fa4\u3001Pod\u751a\u81f3\u5bb9\u5668\u8fdb\u884c\u76d1\u63a7\u4e86\u3002</p> <p>Kubernetes\u5185\u7f6e\u4e86\u4e00\u5957\u76d1\u63a7\u65b9\u6848\uff1ainfluxdb+grafana+heapster\u3002\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528Prometheus\u6765\u5b8c\u6210k8s\u7684\u96c6\u7fa4\u76d1\u63a7\u3002</p>"},{"location":"chap3/1prometheus_setup/#1-prometheus","title":"1 Prometheus \u7b80\u4ecb","text":"<p><code>Prometheus</code>\u662f<code>SoundCloud</code>\u5f00\u6e90\u7684\u4e00\u6b3e\u5f00\u6e90\u8f6f\u4ef6\u3002\u5b83\u7684\u5b9e\u73b0\u53c2\u8003\u4e86<code>Google</code>\u5185\u90e8\u7684\u76d1\u63a7\u5b9e\u73b0\uff0c\u4e0e\u6e90\u81ea<code>Google</code>\u7684<code>Kubernetes</code>\u7ed3\u5408\u8d77\u6765\u975e\u5e38\u5408\u9002\u3002\u53e6\u5916\u76f8\u6bd4<code>influxdb</code>\u7684\u65b9\u6848\uff0c\u6027\u80fd\u66f4\u52a0\u7a81\u51fa\uff0c\u800c\u4e14\u8fd8\u5185\u7f6e\u4e86\u62a5\u8b66\u529f\u80fd\u3002\u5b83\u9488\u5bf9\u5927\u89c4\u6a21\u7684\u96c6\u7fa4\u73af\u5883\u8bbe\u8ba1\u4e86\u62c9\u53d6\u5f0f\u7684\u6570\u636e\u91c7\u96c6\u65b9\u5f0f\uff0c\u4f60\u53ea\u9700\u8981\u5728\u4f60\u7684\u5e94\u7528\u91cc\u9762\u5b9e\u73b0\u4e00\u4e2a<code>metrics</code>\u63a5\u53e3\uff0c\u7136\u540e\u628a\u8fd9\u4e2a\u63a5\u53e3\u544a\u8bc9<code>Prometheus</code>\u5c31\u53ef\u4ee5\u5b8c\u6210\u6570\u636e\u91c7\u96c6\u4e86\u3002</p>"},{"location":"chap3/1prometheus_setup/#2-prometheus","title":"2 \u5b89\u88c5Prometheus","text":"<p>\u9996\u5148\u6211\u4eec\u4f7f\u7528<code>namespace</code>\u6765\u8bbe\u7f6e\u4e00\u4e2a\u65b0\u7684<code>kube-ops</code>\u7684<code>namespace</code>\u7528\u6765\u7ba1\u7406<code>Prometheus</code>\u3002(<code>namespace.yaml</code>)</p> <pre><code>---\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: kube-ops\n</code></pre> <pre><code>$ kubectl create -f namespace.yaml\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u4f7f\u7528<code>ConfigMap</code>\u7684\u5f62\u5f0f\u6765\u8bbe\u7f6e<code>Prometheus</code>\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u4e0b(<code>prometheus-config.yaml</code>)</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-ops\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 30s\n      scrape_timeout: 30s\n    scrape_configs:\n    - job_name: 'prometheus'\n      static_configs:\n        - targets: ['localhost:9090']\n    - job_name: 'kubernetes-nodes-cadvisor'\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - api_servers:\n        - 'https://10.254.0.1'\n        in_cluster: true\n        role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n      - source_labels: [__meta_kubernetes_role]\n        action: replace\n        target_label: kubernetes_role\n      - source_labels: [__address__]\n        regex: '(.*):10250'\n        replacement: '${1}:4194'\n        target_label: __address__\n    - job_name: 'kubernetes-apiserver-cadvisor'\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - api_servers:\n        - 'https://10.254.0.1'\n        in_cluster: true\n        role: apiserver\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n      - source_labels: [__meta_kubernetes_role]\n        action: replace\n        target_label: kubernetes_role\n      - source_labels: [__address__]\n        regex: '(.*):10250'\n        replacement: '${1}:10255'\n        target_label: __address__\n    - job_name: 'kubernetes-node-exporter'\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - api_servers:\n        - 'https://10.254.0.1'\n        in_cluster: true\n        role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n      - source_labels: [__meta_kubernetes_role]\n        action: replace\n        target_label: kubernetes_role\n      - source_labels: [__address__]\n        regex: '(.*):10250'\n        replacement: '${1}:31672'\n        target_label: __address__\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u914d\u7f6e\u6587\u4ef6\u4fdd\u5b58\u4e3a<code>prometheus-config.yaml</code>\uff0c\u7136\u540e\u6267\u884c\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl create -f prometheus-config.yaml\n</code></pre>"},{"location":"chap3/1prometheus_setup/#2-1","title":"2-1 \u6ce8\u610f\uff1a","text":"<p>1.\u5176\u4e2d<code>api_servers</code>\u7684\u5730\u5740\u53ef\u4ee5\u901a\u8fc7<code>kubectl get services</code>\u67e5\u770b<code>kubernetes</code>\u7684\u5730\u5740\uff0c\u6ce8\u610f<code>https</code>\u7684\u8bc1\u4e66\u8def\u5f84</p> <pre><code>$ kubectl get services\nNAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE\nkubernetes      ClusterIP   10.254.0.1      &lt;none&gt;        443/TCP        34d\n</code></pre> <p>2.<code>job_name=kubernetes-apiserver-cadvisor</code>\u9700\u8981\u5c06<code>10250</code>\u7aef\u53e3\u66ff\u6362\u6210<code>10255</code>\uff0c<code>10255</code>\u7aef\u53e3\u662f<code>kubelet</code>\u5b9e\u73b0\u7684<code>metrics</code>\uff0c\u53ef\u4ee5\u5728\u8282\u70b9\u4e0a\u9762<code>curl</code>\u67e5\u770b\u5185\u5bb9\uff0c<code>curl http://&lt;node_ip&gt;:10255/metrics</code></p> <p>3.<code>job_name=kubernetes-nodes-cadvisor</code>\u9700\u8981\u5c06<code>10250</code>\u7aef\u53e3\u66ff\u6362\u6210<code>4194</code>\uff0c<code>4194</code>\u540c\u6837\u662fkubernetes\u96c6\u6210\u7684\u5bb9\u5668\u76d1\u63a7\u670d\u52a1\uff0c\u5728k8s 1.7\u7248\u672c\u4e4b\u524d\u7684\u7528<code>10255</code>\u7aef\u53e3\u5373\u53ef\uff0c\u4f46\u662f<code>1.7</code>\u7248\u672c\u540e<code>cadvisor</code>\u76d1\u63a7\u7684\u6570\u636e\u6ca1\u6709\u96c6\u6210\u5230<code>kubelet</code>\u7684\u5b9e\u73b0\u91cc\u9762\u53bb\u4e86, After upgrading to 1.7.0, Kubelet no longer reports cAdvisor stats</p> <p>4.<code>job_name=kubernetes-node-exporter</code>\u4e2d\u66ff\u6362<code>10250</code>\u7684\u7aef\u53e3\u662f<code>31672</code>\uff0c\u8be5\u7aef\u53e3\u662f<code>node-exporter</code>\u66b4\u9732\u7684<code>NodePort</code>\u7aef\u53e3\uff0c\u8fd9\u91cc\u9700\u8981\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u586b\u5199\u3002</p> <p>\u7136\u540e\u6211\u4eec\u4f7f\u7528<code>ServiceAccount</code>, <code>ClusterRole</code>, <code>ClusterRoleBinding</code> \u7684\u5f62\u5f0f\u6765\u8bbe\u7f6e<code>Prometheus</code>\u7684<code>SA</code>\uff0c\u5982\u4e0b(<code>prometheus-sa.yaml</code>)</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: kube-ops\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: prometheus\n  namespace: kube-ops\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - nodes/proxy\n  - services\n  - endpoints\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- nonResourceURLs: [\"/metrics\"]\n  verbs: [\"get\"]\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\n  namespace: kube-ops\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: kube-ops\n</code></pre> <pre><code>$ kubectl create -f prometheus-sa.yaml\n</code></pre> <p>\u90e8\u7f72<code>node-exporter</code>\uff0c\u4e3a\u4e86\u80fd\u591f\u6536\u96c6\u6bcf\u4e2a\u8282\u70b9\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528<code>DaemonSet</code>\u7684\u5f62\u5f0f\u90e8\u7f72<code>PODS</code>\uff1a(<code>node-exporter.yaml</code>)</p> <pre><code>---\napiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\n  namespace: kube-ops\n  labels:\n    k8s-app: node-exporter\nspec:\n  template:\n    metadata:\n      labels:\n        k8s-app: node-exporter\n    spec:\n      containers:\n      - image: prom/node-exporter\n        name: node-exporter\n        ports:\n        - containerPort: 9100\n          protocol: TCP\n          name: http\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    k8s-app: node-exporter\n  name: node-exporter\n  namespace: kube-ops\nspec:\n  ports:\n  - name: http\n    port: 9100\n    nodePort: 31672\n    protocol: TCP\n  type: NodePort\n  selector:\n    k8s-app: node-exporter\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u6587\u4ef6\u4fdd\u5b58\u4e3a<code>node-exporter.yaml</code>\uff0c\u7136\u540e\u6267\u884c\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl create -f node-exporter.yaml\n</code></pre> <p>\u63a5\u4e0b\u6765\u901a\u8fc7<code>Deployment</code>\u90e8\u7f72<code>Prometheus.yaml</code>\u6587\u4ef6\u5982\u4e0b\uff1a(<code>prometheus-deploy.yaml</code>)</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    name: prometheus-deployment\n  name: prometheus\n  namespace: kube-ops\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: prometheus\n    spec:\n      serviceAccountName: prometheus\n      containers:\n      - image: prom/prometheus:v1.0.1\n        name: prometheus\n        command:\n        - \"/bin/prometheus\"\n        args:\n        - \"-config.file=/etc/prometheus/prometheus.yml\"\n        - \"-storage.local.path=/prometheus\"\n        - \"-storage.local.retention=24h\"\n        ports:\n        - containerPort: 9090\n          protocol: TCP\n        volumeMounts:\n        - mountPath: \"/prometheus\"\n          name: data\n          subPath: prometheus\n        - mountPath: \"/etc/prometheus\"\n          name: config-volume\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n          limits:\n            cpu: 200m\n            memory: 1Gi\n      volumes:\n      - name: data\n        emptyDir: {}\n      - configMap:\n          name: prometheus-config\n        name: config-volume\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u6587\u4ef6\u4fdd\u5b58\u4e3a<code>prometheus-deploy.yaml</code>\uff0c\u7136\u540e\u6267\u884c\u547d\u4ee4\uff1a</p>"},{"location":"chap3/1prometheus_setup/#2-2","title":"2-2 \u6ce8\u610f\uff1a","text":"<p>\u4e00\u5b9a\u8981\u52a0\u4e0a <code>serviceAccountName: prometheus</code>, \u5426\u5219\u4f1a\u51fa\u73b0\u5728 Prometheus pod log \u4e2d:</p> <pre><code>Cannot initialize nodes collection: unable to list Kubernetes nodes; unexpected response: 403 \n403 Forbidden\n</code></pre> <pre><code>$ kubectl create -f prometheus-deploy.yaml\n</code></pre>"},{"location":"chap3/1prometheus_setup/#3-output-prometheus-service","title":"3 Output Prometheus Service","text":""},{"location":"chap3/1prometheus_setup/#3-1-option-1","title":"3-1 option 1","text":"<p>\u628a <code>prometheus</code>\u7684 <code>pod</code> \u670d\u52a1\u66b4\u9732\u51fa\u6765, \u7528<code>svc</code> \u628a <code>nodeport</code> \u66b4\u9732\u51fa\u6765(<code>prometheus-svc.yaml</code>):</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus\n  namespace: kube-ops\n  labels:\n    k8s-app: prometheus\nspec:\n  selector:\n    app: prometheus\n  type: NodePort\n  ports:\n  - name: web\n    port: 9090\n    protocol: TCP\n    nodePort: 30900\n</code></pre> <pre><code>$ kubectl create -f prometheus-svc.yaml\n</code></pre> <p></p>"},{"location":"chap3/1prometheus_setup/#3-2-option-2","title":"3-2 option 2","text":"<pre><code>$ screen\n$ POD=`kubectl get pod -l app=prometheus -n kube-ops -o go-template --template '{{range .items}}{{.metadata.name}}{{end}}'`\n$ kubectl port-forward $POD 9090:9090\n$ ctrl + a + d\n$ curl http://localhost:9090\n$ screen \u2013ls\n$ screen -XS [session # you want to quit] quit\n</code></pre> <p>\u7136\u540e\u7528\u6d4f\u89c8\u5668\u8bbf\u95ee<code>http://localhost:9090</code>\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230Prometheus\u7684\u754c\u9762\u4e86\u3002</p>"},{"location":"chap3/1prometheus_setup/#3-3-option-3","title":"3-3 option 3","text":"<p>\u5728\u521b\u5efa <code>cluserIP Service</code> \u4e4b\u540e</p> <p>\u6211\u8fd9\u91cc\u901a\u8fc7<code>ingress</code>\u66b4\u9732\u5230\u5916\u7f51\uff0c<code>yaml</code>\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: traefik-default-ingress\n  annotations:\n    kubernetes.io/ingress.class: \"traefik\"\nspec:\n  tls:\n    - secretName: traefik-ssl\n  rules:\n  - host: prometheus.local  # \u66ff\u6362\u6210\u4f60\u7684\u57df\u540d\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: prometheus\n          servicePort: 9090\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u6587\u4ef6\u4fdd\u5b58\u4e3a<code>prometheus-ingress.yaml</code>\uff0c\u7136\u540e\u6267\u884c\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl create -f prometheus-ingress.yaml\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762 option1 : <code>nodeport</code>\u4e2d\u914d\u7f6e\u7684\u7aef\u53e3\u8fdb\u884c\u8bbf\u95ee\u4e86\uff0c\u53ef\u4ee5\u5207\u6362\u5230<code>Status</code>\u4e0b\u9762\u7684<code>targets</code>\u67e5\u770b\u6211\u4eec\u91c7\u96c6\u7684\u6570\u636e\u662f\u5426\u6b63\u5e38\uff1a</p> <pre><code>$ kubectl get svc -n kube-ops\nNAME            TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE\nnode-exporter   NodePort   10.254.125.138   &lt;none&gt;        9100:31672/TCP                   34d\nprometheus      NodePort   10.254.35.188    &lt;none&gt;        9090:30900/TCP                   3h\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u8bbf\u95ee <code>http://192.168.1.138:30900</code></p> <p></p> <p>\u53ef\u4ee5\u6839\u636e<code>targets</code>\u4e0b\u9762\u7684\u63d0\u793a\u4fe1\u606f\u5bf9\u91c7\u96c6\u5931\u8d25\u7684\u6570\u636e\u8fdb\u884c\u4fee\u6b63\u3002</p>"},{"location":"chap3/1prometheus_setup/#4","title":"4 \u67e5\u8be2\u76d1\u63a7\u6570\u636e","text":"<p><code>Prometheus</code>\u63d0\u4f9b\u4e86<code>API</code>\u7684\u65b9\u5f0f\u8fdb\u884c\u6570\u636e\u67e5\u8be2\uff0c\u540c\u6837\u53ef\u4ee5\u4f7f\u7528<code>query</code>\u8bed\u8a00\u8fdb\u884c\u590d\u6742\u7684\u67e5\u8be2\u4efb\u52a1\uff0c\u5728\u4e0a\u9762\u7684WEB\u754c\u9762\u4e0a\u63d0\u4f9b\u4e86\u57fa\u672c\u7684\u67e5\u8be2\u548c\u56fe\u5f62\u5316\u7684\u5c55\u793a\u529f\u80fd\u3002</p> <p>\u6bd4\u5982\u67e5\u8be2\u6bcf\u4e2a<code>POD</code>\u7684CPU\u4f7f\u7528\u60c5\u51b5\uff0c\u67e5\u8be2\u6761\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>sum by (pod_name)( rate(container_cpu_usage_seconds_total{image!=\"\", pod_name!=\"\"}[1m] ) )\n</code></pre> <p>\u6ce8\u610f\u5176\u4e2d\u7684<code>pod_name</code>\u548c<code>image</code>\u8981\u6839\u636e\u81ea\u5df1\u91c7\u96c6\u7684\u6570\u636e\u8fdb\u884c\u533a\u5206\u3002</p> <p></p> <p>\u66f4\u591a\u7684\u67e5\u8be2\u6761\u4ef6\u53ef\u4ee5\u53c2\u8003<code>Prometheus\u7684\u6587\u6863</code>\uff0c\u5c06\u6765\u4e5f\u4f1a\u9010\u6b65\u4ecb\u7ecd\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8be6\u7ec6\u5c55\u5f00\u4e86\u3002</p> <p>\u8fd9\u6837\u901a\u8fc7\u5728<code>Kubernetes</code>\u4e0a\u90e8\u7f72<code>Prometheus</code>\uff0c\u5728\u4e0d\u4fee\u6539\u96c6\u7fa4\u7684\u4efb\u4f55\u914d\u7f6e\u60c5\u51b5\u4e0b\u5b9e\u73b0\u4e86\u96c6\u7fa4\u7684\u57fa\u672c\u76d1\u63a7\u529f\u80fd\u3002</p> <p>Reference: Prometheus\u7684\u6587\u6863</p>"},{"location":"chap3/1prometheus_setup/#5-grafana","title":"5 \u5b89\u88c5Grafana","text":"<p><code>Prometheus</code>\u4ee5\u53ca\u83b7\u53d6\u5230\u4e86\u6211\u4eec\u91c7\u96c6\u7684\u6570\u636e\uff0c\u73b0\u5728\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u66f4\u52a0\u5f3a\u5927\u7684\u56fe\u6807\u5c55\u793a\u5de5\u5177\uff0c\u6beb\u65e0\u7591\u95ee\u9009\u62e9<code>grafana</code>\u3002</p> <p>\u6211\u7684 <code>Grafana</code> \u539f\u6765\u5df2\u7ecf\u5b89\u88c5\u8fc7\u4e86\uff0c\u53ef\u4ee5\u53c2\u8003\u5b89\u88c5\u6587\u6863</p> <p>\u540c\u6837\u7684\uff0c\u5728<code>Kubernetes</code>\u73af\u5883\u4e0b\u9762\u8fdb\u884c\u5b89\u88c5\uff0c<code>yaml</code>\u6587\u4ef6\u5982\u4e0b:</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: grafana\n  namespace: kube-ops\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        k8s-app: grafana\n        task: monitoring\n    spec:\n      containers:\n      - name: grafana\n        image: gcr.io/google_containers/heapster-grafana-amd64:v4.4.3\n        ports:\n        - containerPort: 3000\n          protocol: TCP\n        resources:\n          limits:\n            cpu: 200m\n            memory: 256Mi\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        volumeMounts:\n        - name: ca-certificates\n          mountPath: /etc/ssl/certs\n          readOnly: true\n        - name: grafana-data\n          mountPath: /var\n          subPath: grafana\n        env:\n        - name: INFLUXDB_HOST\n          value: influxdb\n        - name: INFLUXDB_SERVICE_URL\n          value: http://influxdb.kube-ops.svc.cluster.local:8086\n        - name: GF_SERVER_HTTP_PORT\n          value: \"3000\"\n        - name: GF_AUTH_BASIC_ENABLED\n          value: \"false\"\n        - name: GF_AUTH_ANONYMOUS_ENABLED\n          value: \"true\"\n        - name: GF_AUTH_ANONYMOUS_ORG_ROLE\n          value: Admin\n        - name: GF_SERVER_ROOT_URL\n          # If you're only using the API Server proxy, set this value instead:\n          # value: /api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/\n          value: /\n      volumes:\n      - name: ca-certificates\n        hostPath:\n          path: /etc/ssl/certs\n      - name: grafana-data\n        emptyDir: {}\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    kubernetes.io/cluster-service: 'true'\n    kubernetes.io/name: grafana\n  name: grafana\n  namespace: kube-ops\nspec:\n  ports:\n  - port: 3000\n    targetPort: 3000\n  selector:\n    k8s-app: grafana\n</code></pre> <p>\u5c06\u4ee5\u4e0a\u6587\u4ef6\u4fdd\u5b58\u4e3a<code>grafana.yaml</code>\uff0c\u7136\u540e\u6267\u884c\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl create -f grafana.yaml\n</code></pre> <p>\u540c\u6837\u7684\u4f60\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528<code>kubectl port-forward</code>\u628a\u7aef\u53e3\u66b4\u9732\u5728\u672c\u5730\uff0c\u6216\u8005\u7528<code>ingress</code>\u5c06\u670d\u52a1\u66b4\u9732\u5728\u5916\u7f51\u8fdb\u884c\u8bbf\u95ee\u3002 \u8bbf\u95ee<code>grafanaWEB</code>\u754c\u9762\uff0c\u5c06\u6211\u4eec\u4e0a\u9762\u7684<code>Prometheus</code>\u6dfb\u52a0\u5230<code>grafana</code>\u6570\u636e\u6e90\u4e2d\u53bb</p> <pre><code>$ kubectl get svc -n kube-system\nNAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\nkubernetes-dashboard      NodePort    10.254.64.44     &lt;none&gt;        80:31042/TCP        34d\nmonitoring-grafana        NodePort    10.254.77.179    &lt;none&gt;        80:30425/TCP        34d\nmonitoring-influxdb       ClusterIP   10.254.82.61     &lt;none&gt;        8086/TCP            34d\n</code></pre> <p></p> <p>\u7136\u540e\u6dfb\u52a0\u6211\u4eec\u7684<code>Dashboard</code>\uff0c\u63a8\u8350\u4f7f\u7528https://grafana.com/dashboards/162\uff0c\u53ef\u4ee5\u4e0b\u8f7d\u8be5\u9875\u9762\u7684<code>dashboard</code>\u7684<code>json</code>\u6587\u4ef6\uff0c\u7136\u540e\u76f4\u63a5\u5bfc\u5165\u5230<code>grafana</code>\u4e2d\u53bb\u3002</p> <p></p> <p></p> <p>\u4f46\u662f\u9700\u8981\u6ce8\u610f\u5176\u4e2d\u7684\u4e00\u4e9b\u53c2\u6570\uff0c\u9700\u8981\u6839\u636e<code>prometheus</code>\u4e2d\u91c7\u96c6\u5230\u5b9e\u9645\u6570\u636e\u8fdb\u884c\u586b\u5199\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u91c7\u96c6\u5230\u5bb9\u5668\u540d\u662f<code>name</code>\uff0c\u800c\u4e0d\u662f<code>io_kubernetes_container_name</code>,</p> <p>kubernetes-pod-monitoring_rev1.json</p> <p>\u6700\u7ec8\u5c55\u793a\u754c\u9762\u5982\u4e0b</p> <p></p>"},{"location":"chap3/29AlertManager_SendAlerts_when/","title":"\u7b2c\u5341\u4e09\u8282 AlertManager\u4f55\u65f6\u62a5\u8b66","text":"<p>\u5728\u4f7f\u7528 Prometheus \u8fdb\u884c\u76d1\u63a7\u7684\u65f6\u5019\uff0c\u901a\u8fc7 AlertManager \u6765\u8fdb\u884c\u544a\u8b66\uff0c\u4f46\u662f\u6709\u5f88\u591a\u4eba\u5bf9\u62a5\u8b66\u7684\u76f8\u5173\u914d\u7f6e\u6bd4\u8f83\u8ff7\u7cca\uff0c\u4e0d\u592a\u6e05\u695a\u5177\u4f53\u4ec0\u4e48\u65f6\u5019\u4f1a\u8fdb\u884c\u544a\u8b66\u3002\u4e0b\u9762\u6211\u4eec\u6765\u7b80\u5355\u4ecb\u7ecd\u4e0b AlertManager \u4e2d\u7684\u51e0\u4e2a\u5bb9\u6613\u6df7\u6dc6\u7684\u53c2\u6570\u3002</p> <p>\u9996\u5148\u5728 <code>Prometheus</code> \u4e2d\u6709\u4e24\u4e2a\u5168\u5c40\u7684\u53c2\u6570 <code>scrape_interval</code> \u548c <code>evaluation_interval</code>\u3002</p> <ul> <li>\u5176\u4e2d <code>scrape_interval</code> \u53c2\u6570\u8868\u793a\u7684\u662f <code>Prometheus</code> \u4ece\u5404\u79cd <code>metrics</code> \u63a5\u53e3\u6293\u53d6\u6307\u6807\u6570\u636e\u7684\u65f6\u95f4\u95f4\u9694</li> <li><code>evaluation_interval</code> \u53c2\u6570\u8868\u793a\u7684\u662f<code>Prometheus</code> \u5bf9\u62a5\u8b66\u89c4\u5219\u8fdb\u884c\u8bc4\u4f30\u8ba1\u7b97\u7684\u65f6\u95f4\u95f4\u9694\u3002</li> </ul> <p>\u5f53\u4e00\u6761\u544a\u8b66\u89c4\u5219\u8bc4\u4f30\u540e\uff0c\u5b83\u7684\u72b6\u6001\u53ef\u80fd\u662f <code>inactive</code>\u3001<code>pending</code> \u6216\u8005 <code>firing</code> \u4e2d\u7684\u4e00\u79cd\u3002\u8bc4\u4f30\u4e4b\u540e\uff0c\u72b6\u6001\u5c06\u88ab\u53d1\u9001\u5230\u5173\u8054\u7684 <code>AlertManager</code>\u4ee5\u8fdb\u884c\u6f5c\u5728\u5730\u5f00\u59cb\u6216\u8005\u505c\u6b62\u544a\u8b66\u901a\u77e5\u7684\u53d1\u9001\u3002</p> <p>\u7136\u540e\u5c31\u662f <code>AlertManager</code> \u4e2d\u914d\u7f6e\u7684 <code>group_by</code>\u53c2\u6570\u8d77\u4f5c\u7528\u7684\u5730\u65b9\u4e86\uff0c</p> <p>\u4e3a\u4e86\u907f\u514d\u8fde\u7eed\u53d1\u9001\u7c7b\u4f3c\u7684\u544a\u8b66\u901a\u77e5\uff0c\u53ef\u4ee5\u5c06\u76f8\u5173\u544a\u8b66\u5206\u5230\u540c\u4e00\u7ec4\u4e2d\u8fdb\u884c\u544a\u8b66\u3002</p> <p>\u5206\u7ec4\u673a\u5236\u53ef\u4ee5\u5c06\u8be6\u7ec6\u7684\u544a\u8b66\u4fe1\u606f\u5408\u5e76\u6210\u4e00\u4e2a\u901a\u77e5\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6bd4\u5982\u7531\u4e8e\u7cfb\u7edf\u5b95\u673a\u5bfc\u81f4\u5927\u91cf\u7684\u544a\u8b66\u88ab\u540c\u65f6\u89e6\u53d1\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5206\u7ec4\u673a\u5236\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u88ab\u89e6\u53d1\u7684\u544a\u8b66\u5408\u5e76\u4e3a\u4e00\u4e2a\u544a\u8b66\u901a\u77e5\uff0c\u907f\u514d\u4e00\u6b21\u6027\u63a5\u53d7\u5927\u91cf\u7684\u544a\u8b66\u901a\u77e5\uff1a</p> <pre><code>group_by: ['alertname', 'job']\n</code></pre> <p>\u5f53\u4e00\u4e2a\u65b0\u7684\u62a5\u8b66\u5206\u7ec4\u88ab\u521b\u5efa\u540e\uff0c\u9700\u8981\u7b49\u5f85\u81f3\u5c11 <code>group_wait</code> \u65f6\u95f4\u6765\u521d\u59cb\u5316\u544a\u8b66\u3002</p> <p>\u8fd9\u6837\u5b9e\u9645\u4e0a\u5c31\u7f13\u51b2\u4e86\u4ece <code>Prometheus</code> \u53d1\u9001\u5230 <code>AlertManager</code> \u7684\u544a\u8b66\uff0c\u5c06\u544a\u8b66\u6309\u76f8\u540c\u7684\u6807\u7b7e\u5206\u7ec4\uff0c\u800c\u4e0d\u5fc5\u5168\u90fd\u53d1\u9001\uff1a</p> <pre><code>group_by: ['alertname', 'job']\ngroup_wait: 45s # \u901a\u5e38\u8bbe\u7f6e\u62100s ~ \u51e0\u5206\u949f\n</code></pre> <p>\u4f46\u662f\u8fd9\u53ef\u80fd\u4e5f\u5bfc\u81f4\u4e86\u63a5\u6536\u5230\u7684\u544a\u8b66\u901a\u77e5\u7684\u7b49\u5f85\u65f6\u95f4\u66f4\u957f\u4e86\u3002\u53e6\u5916\u4e00\u4e2a\u95ee\u9898\u662f\u4e0b\u6b21\u5bf9\u544a\u8b66\u89c4\u5219\u8fdb\u884c\u8bc4\u4f30\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c06\u518d\u6b21\u6536\u5230\u76f8\u540c\u7684\u5206\u7ec4\u544a\u8b66\u901a\u77e5\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>group_interval</code> \u53c2\u6570\u6765\u8fdb\u884c\u914d\u7f6e\uff0c\u5f53\u4e0a\u4e00\u4e2a\u544a\u8b66\u901a\u77e5\u53d1\u9001\u5230\u4e00\u4e2a <code>group</code> \u540e\uff0c\u6211\u4eec\u5728\u7b49\u5f85 <code>group_interval</code>\u65f6\u957f\u540e\uff0c\u7136\u540e\u518d\u5c06\u89e6\u53d1\u7684\u544a\u8b66\u4ee5\u53ca\u5df2\u89e3\u51b3\u7684\u544a\u8b66\u53d1\u9001\u7ed9 <code>receiver</code>\uff1a</p> <pre><code>group_by: ['instance', 'job']\ngroup_wait: 45s\ngroup_interval: 10m # \u901a\u5e38\u8bbe\u7f6e\u62105\u5206\u949f\u4ee5\u4e0a\n</code></pre> <p>\u9664\u6b64\u4e4b\u5916\u8fd8\u6709\u4e00\u4e2a <code>repeat_interval</code> \u53c2\u6570\uff0c\u8be5\u53c2\u6570\u4e3b\u8981\u662f\u7528\u4e8e\u914d\u7f6e\u544a\u8b66\u4fe1\u606f\u5df2\u7ecf\u53d1\u9001\u6210\u529f\u540e\uff0c\u518d\u6b21\u88ab\u89e6\u53d1\u53d1\u9001\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u4e00\u822c\u4e0d\u540c\u7c7b\u578b\u7684\u544a\u8b66\u4e1a\u52a1\u6539\u53c2\u6570\u914d\u7f6e\u4e0d\u592a\u4e00\u6837\uff0c\u5bf9\u4e8e\u6bd4\u8f83\u91cd\u8981\u7d27\u6025\u7684\u53ef\u4ee5\u5c06\u6539\u53c2\u6570\u8bbe\u7f6e\u7a0d\u5fae\u5c0f\u70b9\uff0c\u5bf9\u4e8e\u4e0d\u592a\u7d27\u6025\u7684\u53ef\u4ee5\u8bbe\u7f6e\u7a0d\u5fae\u5927\u70b9\u3002</p> <p>\u9762\u8fd9\u4e9b\u90fd\u662f\u5728 Prometheus \u6216\u8005 AlertManager \u4e2d\u914d\u7f6e\u7684\u4e00\u4e9b\u5168\u5c40\u7684\u53c2\u6570\uff0c\u5bf9\u4e8e\u5177\u4f53\u7684\u544a\u8b66\u89c4\u5219\u8fd8\u6709\u65f6\u95f4\u53ef\u4ee5\u914d\u7f6e\uff0c\u5982\u4e0b\u6240\u793a\u7684\u544a\u8b66\u89c4\u5219\uff1a</p> <pre><code>groups:\n- name: test-node-mem\n  rules:\n  - alert: NodeMemoryUsage\n    expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 90\n    for: 1m\n    labels:\n      team: node\n    annotations:\n      summary: \"{{$labels.instance}}: High Memory usage detected\"\n        description: \"{{$labels.instance}}: Memory usage is above 90% (current value is: {{ $value }}\"\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a <code>test-node-mem</code> \u7684\u62a5\u8b66\u89c4\u5219\u5206\u7ec4\uff0c\u4e00\u6761\u62a5\u8b66\u89c4\u5219\u4e3b\u8981\u7531\u4ee5\u4e0b\u51e0\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li><code>alert</code>\uff1a\u544a\u8b66\u89c4\u5219\u7684\u540d\u79f0</li> <li><code>expr</code>\uff1a\u662f\u7528\u4e8e\u8fdb\u884c\u62a5\u8b66\u89c4\u5219 <code>PromQL</code> \u67e5\u8be2\u8bed\u53e5</li> <li><code>for</code>\uff1a\u8bc4\u4f30\u7b49\u5f85\u65f6\u95f4\uff08<code>Pending Duration</code>\uff09\uff0c\u7528\u4e8e\u8868\u793a\u53ea\u6709\u5f53\u89e6\u53d1\u6761\u4ef6\u6301\u7eed\u4e00\u6bb5\u65f6\u95f4\u540e\u624d\u53d1\u9001\u544a\u8b66\uff0c\u5728\u7b49\u5f85\u671f\u95f4\u65b0\u4ea7\u751f\u7684\u544a\u8b66\u72b6\u6001\u4e3apending</li> <li><code>labels</code>\uff1a\u81ea\u5b9a\u4e49\u6807\u7b7e\uff0c\u5141\u8bb8\u7528\u6237\u6307\u5b9a\u989d\u5916\u7684\u6807\u7b7e\u5217\u8868\uff0c\u628a\u5b83\u4eec\u9644\u52a0\u5728\u544a\u8b66\u4e0a</li> <li><code>annotations</code>\uff1a\u6307\u5b9a\u4e86\u53e6\u4e00\u7ec4\u6807\u7b7e\uff0c\u5b83\u4eec\u4e0d\u88ab\u5f53\u505a\u544a\u8b66\u5b9e\u4f8b\u7684\u8eab\u4efd\u6807\u8bc6\uff0c\u5b83\u4eec\u7ecf\u5e38\u7528\u4e8e\u5b58\u50a8\u4e00\u4e9b\u989d\u5916\u7684\u4fe1\u606f\uff0c\u7528\u4e8e\u62a5\u8b66\u4fe1\u606f\u7684\u5c55\u793a\u4e4b\u7c7b\u7684</li> </ul> <p>\u5176\u4e2d\u7684 <code>for</code> \u5b57\u6bb5\u540c\u6837\u4f1a\u5f71\u54cd\u5230\u6211\u4eec\u7684\u544a\u8b66\u5230\u8fbe\u65f6\u95f4\uff0c\u8be5\u53c2\u6570\u7528\u4e8e\u8868\u793a\u53ea\u6709\u5f53\u89e6\u53d1\u6761\u4ef6\u6301\u7eed\u4e00\u6bb5\u65f6\u95f4\u540e\u624d\u53d1\u9001\u544a\u8b66\uff0c\u5728\u7b49\u5f85\u671f\u95f4\u65b0\u4ea7\u751f\u7684\u544a\u8b66\u72b6\u6001\u4e3a<code>pending</code>\uff0c\u8fd9\u4e2a\u53c2\u6570\u4e3b\u8981\u7528\u4e8e\u964d\u566a\uff0c\u5f88\u591a\u7c7b\u4f3c\u54cd\u5e94\u65f6\u95f4\u8fd9\u6837\u7684\u6307\u6807\u90fd\u662f\u6709\u6296\u52a8\u7684\uff0c\u901a\u8fc7\u6307\u5b9a <code>Pending Duration</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u8fc7\u6ee4\u6389\u8fd9\u4e9b\u77ac\u65f6\u6296\u52a8\uff0c\u53ef\u4ee5\u8ba9\u6211\u4eec\u80fd\u591f\u628a\u6ce8\u610f\u529b\u653e\u5728\u771f\u6b63\u6709\u6301\u7eed\u5f71\u54cd\u7684\u95ee\u9898\u4e0a\u3002</p> <p>\u6240\u4ee5\u6709\u7684\u60c5\u51b5\u4e0b\u8ba1\u7b97\u6211\u4eec\u7684\u76d1\u63a7\u56fe\u8868\u4e0a\u9762\u5df2\u7ecf\u6709\u90e8\u5206\u6307\u6807\u8fbe\u5230\u4e86\u544a\u8b66\u7684\u9608\u503c\u4e86\uff0c\u4f46\u662f\u5e76\u4e0d\u4e00\u5b9a\u4f1a\u89e6\u53d1\u544a\u8b66\u89c4\u5219\uff0c\u6bd4\u5982\u6211\u4eec\u4e0a\u9762\u7684\u89c4\u5219\u4e2d\uff0c\u8bbe\u7f6e\u7684\u662f<code>1</code>\u5206\u949f\u7684 <code>Pending Duration</code>\uff0c\u5bf9\u4e8e\u4e0b\u56fe\u8fd9\u79cd\u60c5\u51b5\u5c31\u4e0d\u4f1a\u89e6\u53d1\u544a\u8b66\uff0c\u56e0\u4e3a\u6301\u7eed\u65f6\u95f4\u592a\u77ed\uff0c\u6ca1\u6709\u8fbe\u5230\u4e00\u5206\u949f\uff1a</p> <p></p> <p>\u5982\u679c\u544a\u8b66\u89c4\u5219\u8d85\u8fc7\u9608\u503c\u7684\u6301\u7eed\u65f6\u95f4\u8d85\u8fc7\u4e86 <code>Pending Duration</code> \u90a3\u4e48\u5c31\u4f1a\u89e6\u53d1\u544a\u8b66\u4e86\uff0c\u544a\u8b66\u4ea7\u751f\u540e\uff0c\u8fd8\u8981\u7ecf\u8fc7 <code>Alertmanager</code> \u7684\u5206\u7ec4\u3001\u6291\u5236\u5904\u7406\u3001\u9759\u9ed8\u5904\u7406\u3001\u53bb\u91cd\u5904\u7406\u548c\u964d\u566a\u5904\u7406\u6700\u540e\u518d\u53d1\u9001\u7ed9\u63a5\u6536\u8005\u3002</p> <p>\u6240\u4ee5\u4ece\u4e00\u6761\u544a\u8b66\u89c4\u5219\u88ab\u8bc4\u4f30\u5230\u89e6\u53d1\u544a\u8b66\u518d\u5230\u53d1\u9001\u7ed9\u63a5\u6536\u65b9\uff0c\u4e2d\u95f4\u4f1a\u6709\u4e00\u7cfb\u5217\u7684\u5404\u79cd\u56e0\u7d20\u8fdb\u884c\u5e72\u9884\uff0c\u6240\u4ee5\u6709\u65f6\u5019\u5728\u76d1\u63a7\u56fe\u8868\u4e0a\u770b\u5230\u5df2\u7ecf\u8fbe\u5230\u4e86\u9608\u503c\u800c\u6700\u7ec8\u6ca1\u6709\u6536\u5230\u76d1\u63a7\u62a5\u8b66\u4e5f\u5c31\u4e0d\u8db3\u4e3a\u5947\u4e86\u3002</p>"},{"location":"chap3/2prometheus_AlertManager/","title":"\u7b2c\u4e8c\u8282 Prometheus\u62a5\u8b66 &amp;&amp; AlertManager\u5b9e\u6218\uff082018\uff09","text":""},{"location":"chap3/2prometheus_AlertManager/#1-alertmanager","title":"1 AlertManager \u7b80\u4ecb","text":"<p>Prometheus\u5c06\u6570\u636e\u91c7\u96c6\u548c\u62a5\u8b66\u5206\u6210\u4e86\u4e24\u4e2a\u6a21\u5757\u3002</p> <p>\u62a5\u8b66\u89c4\u5219\u914d\u7f6e\u5728<code>Prometheus Servers</code>\u4e0a\uff0c\u7136\u540e\u53d1\u9001\u62a5\u8b66\u4fe1\u606f\u5230<code>AlertManger</code>\uff0c\u7136\u540e\u6211\u4eec\u7684<code>AlertManager</code>\u5c31\u6765\u7ba1\u7406\u8fd9\u4e9b\u62a5\u8b66\u4fe1\u606f\uff0c\u5305\u62ec<code>silencing</code>\u3001<code>inhibition</code>\uff0c\u805a\u5408\u62a5\u8b66\u4fe1\u606f\u8fc7\u540e\u901a\u8fc7<code>email</code>\u3001<code>PagerDuty</code>\u3001<code>HipChat</code>\u3001<code>Slack</code> \u7b49\u65b9\u5f0f\u53d1\u9001\u6d88\u606f\u63d0\u793a\u3002</p> <p>\u8ba9<code>AlertManager</code>\u63d0\u4f9b\u670d\u52a1\u603b\u7684\u6765\u8bf4\u5c31\u4e0b\u97623\u6b65\uff1a </p> <ul> <li>\u5b89\u88c5\u548c\u914d\u7f6e<code>AlertManger</code> </li> <li>\u914d\u7f6e<code>Prometheus</code>\u6765\u548c<code>AlertManager</code>\u901a\u4fe1 </li> <li>\u5728<code>Prometheus</code>\u4e2d\u521b\u5efa\u62a5\u8b66\u89c4\u5219</li> </ul>"},{"location":"chap3/2prometheus_AlertManager/#2-alertmanager","title":"2 \u5b89\u88c5\u548c\u914d\u7f6eAlertManager","text":"<p>\u4ece\u5b98\u65b9\u6587\u6863https://prometheus.io/docs/alerting/configuration/\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0b\u8f7d<code>alertmanager</code>\u4e8c\u8fdb\u5236\u6587\u4ef6\u8fc7\u540e\uff0c\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u5c31\u53ef\u8fd0\u884c</p> <pre><code>$ ./alertmanager -config.file=simple.yml\n</code></pre> <ul> <li>\u53ef\u4ee5\u901a\u8fc7<code>-config.file</code>\u6765\u6307\u5b9a\u76f8\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u8fd9\u91cc\u5728<code>kubernetes</code>\u5e73\u53f0\u4e0a\u9762\u6765\u8fd0\u884c\u6211\u4eec\u7684<code>AlertManager</code>\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u7528<code>docker</code>\u955c\u50cf\u7684\u65b9\u5f0f\u6765\u5b89\u88c5.</li> <li>\u4f7f\u7528\u7684\u955c\u50cf\u662f\uff1a<code>quay.io/prometheus/alertmanager:v0.12.0</code></li> <li>\u5982\u679c\u4f60\u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u4e0d\u80fd\u62c9\u53d6\u8be5\u955c\u50cf\uff0c\u53ef\u4ee5\u76f4\u63a5\u53bb\u4e0b\u8f7d<code>AlertManager</code>\u7684\u6e90\u4ee3\u7801\uff0c\u7136\u540e\u81ea\u5df1\u6784\u5efa\u6253\u5305\u4e00\u4e2a<code>docker</code>\u955c\u50cf\u4e5f\u662f\u4e00\u6837\u7684\u3002</li> </ul> <p>\u901a\u8fc7<code>ConfigMap</code>\u6765\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u4e0b:</p> <pre><code>kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: alertmanager\n  namespace: kube-ops\ndata:\n  config.yml: |-\n    global:\n      resolve_timeout: 5m\n    route:\n      receiver: webhook\n      group_wait: 30s\n      group_interval: 5m\n      repeat_interval: 4h\n      group_by: [alertname]\n      routes:\n      - receiver: webhook\n        group_wait: 10s\n        match:\n          team: node\n    receivers:\n    - name: webhook\n      webhook_configs:\n      - url: 'http://apollo/hooks/dingtalk/'\n        send_resolved: true\n      - url: 'http://apollo/hooks/prome/'\n        send_resolved: true\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e24\u4e2a<code>webhook</code>\uff0c\u5176\u4e2d\u4e00\u4e2a\u662f<code>\u9489\u9489</code>\uff0c\u53e6\u5916\u4e00\u4e2a\u662f<code>email</code>\u3002</p>"},{"location":"chap3/2prometheus_AlertManager/#3-prometheusalertmanager","title":"3 \u914d\u7f6ePrometheus\u6765\u548cAlertManager\u901a\u4fe1","text":"<p>\u5728\u6211\u4eec\u4e4b\u524d\u7684<code>Prometheus</code>\u7684 <code>ConfigMap</code>\u4e2d\u589e\u52a0 <code>AlertManager</code>\u7684\u914d\u7f6e\uff1a</p> <pre><code>alerting:\n  alertmanagers:\n    - static_configs:\n      - targets: [\"localhost:9093\"]\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9\u5c06Prometheus\u548cAlertManager\u90e8\u7f72\u5728\u540c\u4e00\u4e2aPOD\u4e2d\uff0c\u800c<code>AlertManager</code>\u7684\u9ed8\u8ba4\u7aef\u53e3\u662f<code>9093</code>\uff0c\u6240\u4ee5\u76f4\u63a5\u4f7f\u7528<code>localhost:9093</code>\u5c31\u53ef\u4ee5\u4e92\u76f8\u901a\u4fe1\u4e86\u3002</p> <p></p>"},{"location":"chap3/2prometheus_AlertManager/#4-prometheus","title":"4 \u5728 Prometheus \u4e2d\u521b\u5efa\u62a5\u8b66\u89c4\u5219","text":"<p>\u540c\u6837\u7684\u6211\u4eec\u8fd8\u9700\u8981\u6dfb\u52a0\u62a5\u8b66\u89c4\u5219\uff1a</p> <pre><code>rule_files:\n    - /etc/prometheus/rules.yml\n</code></pre> <p>\u5176\u4e2d<code>rule_files</code>\u5c31\u662f\u7528\u6765\u6307\u5b9a\u62a5\u8b66\u89c4\u5219\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u5c06<code>rules.yml</code>\u7528<code>ConfigMap</code>\u7684\u5f62\u5f0f\u6302\u8f7d\u5230<code>/etc/prometheus</code>\u76ee\u5f55\u4e0b\u9762\u5373\u53ef:</p> <pre><code>rules.yml: |\n    groups:\n    - name: test-rule\n      rules:\n      - alert: NodeFilesystemUsage\n        expr: (node_filesystem_size{device=\"rootfs\"} - node_filesystem_free{device=\"rootfs\"}) / node_filesystem_size{device=\"rootfs\"} * 100 &gt; 80\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{$labels.instance}}: High Filesystem usage detected\"\n          description: \"{{$labels.instance}}: Filesystem usage is above 80% (current value is: {{ $value }}\"\n      - alert: NodeMemoryUsage\n        expr: (node_memory_MemTotal - (node_memory_MemFree+node_memory_Buffers+node_memory_Cached )) / node_memory_MemTotal * 100 &gt; 80\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{$labels.instance}}: High Memory usage detected\"\n          description: \"{{$labels.instance}}: Memory usage is above 80% (current value is: {{ $value }}\"\n      - alert: NodeCPUUsage\n        expr: (100 - (avg by (instance) (irate(node_cpu{job=\"kubernetes-node-exporter\",mode=\"idle\"}[5m])) * 100)) &gt; 80\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{$labels.instance}}: High CPU usage detected\"\n          description: \"{{$labels.instance}}: CPU usage is above 80% (current value is: {{ $value }}\"\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u6dfb\u52a0\u4e863\u6761\u6d4b\u8bd5\u7684\u62a5\u8b66\u89c4\u5219\uff0c\u5206\u522b\u662f\u8282\u70b9\u7684\u6587\u4ef6\u7cfb\u7edf\u3001\u8282\u70b9\u5185\u5b58\u548cCPU\u7684\u4f7f\u7528\u91cf\uff0c\u5982\u679c\u5927\u4e8e\u4e8680%\u7684\u8bdd\u5c31\u89e6\u53d1<code>label</code>\u4e3a<code>team=node</code>\u7684<code>receiver</code>(\u4e0a\u9762<code>alertmanager</code> \u914d\u7f6e\u6587\u4ef6\u4e2d)\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u914d\u7f6e\u5c31\u4f1a\u5339\u914d<code>webhook</code>\u8fd9\u4e2a<code>receiver</code>\uff0c\u7136\u540e\u4f1a\u5c06\u62a5\u8b66\u4fe1\u606f<code>POST</code>\u5230\u6211\u4eec\u63d0\u4f9b\u7684\u4e24\u4e2a<code>HOOK</code> \u63a5\u53e3\u4e2d</p> <p>\u4e00\u4e2a\u62a5\u8b66\u4fe1\u606f\u5728\u751f\u547d\u5468\u671f\u5185\u6709\u4e0b\u97623\u4e2d\u72b6\u6001\uff1a</p> <ul> <li><code>inactive</code>: \u8868\u793a\u5f53\u524d\u62a5\u8b66\u4fe1\u606f\u65e2\u4e0d\u662f<code>firing</code>\u72b6\u6001\u4e5f\u4e0d\u662f<code>pending</code>\u72b6\u6001</li> <li><code>pending</code>: \u8868\u793a\u5728\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\u95f4\u8303\u56f4\u5185\u88ab\u6fc0\u6d3b\u4e86</li> <li><code>firing</code>: \u8868\u793a\u8d85\u8fc7\u8bbe\u7f6e\u7684\u9608\u503c\u65f6\u95f4\u88ab\u6fc0\u6d3b\u4e86</li> </ul> <p></p> <p>\u6211\u4eec\u76f4\u63a5\u70b9\u51fb\u4e0a\u9762\u7684<code>expr</code>\u4f1a\u76f4\u63a5\u8df3\u8f6c\u5230<code>graph</code>\u9875\u9762\u67e5\u8be2\uff0c\u6211\u4eec\u5728\u5236\u5b9a\u62a5\u8b66\u89c4\u5219\u7684\u65f6\u5019\u540c\u6837\u53ef\u4ee5\u5148\u5728<code>Prometheus</code>\u91cc\u9762\u5148\u6d4b\u8bd5\u6211\u4eec\u7684\u8868\u8fbe\u5f0f: <code>alert-info</code></p> <p></p>"},{"location":"chap3/2prometheus_AlertManager/#5","title":"5 \u5168\u90e8\u914d\u7f6e","text":"<p>\u6574\u4f53\u7684<code>ConfigMap</code>\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b<code>cm.yaml</code>:</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-ops\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 30s\n      scrape_timeout: 30s\n    rule_files:\n    - /etc/prometheus/rules.yml\n    alerting:\n      alertmanagers:\n        - static_configs:\n          - targets: [\"localhost:9093\"]\n    scrape_configs:\n    - job_name: 'prometheus'\n      static_configs:\n        - targets: ['localhost:9090']\n    - job_name: 'kubernetes-apiservers'\n      kubernetes_sd_configs:\n      - role: endpoints\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n        action: keep\n        regex: default;kubernetes;https\n    - job_name: 'kubernetes-nodes'\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n      - target_label: __address__\n        replacement: kubernetes.default.svc:443\n      - source_labels: [__meta_kubernetes_node_name]\n        regex: (.+)\n        target_label: __metrics_path__\n        replacement: /api/v1/nodes/${1}/proxy/metrics\n    - job_name: 'kubernetes-cadvisor'\n      scheme: https\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n      - target_label: __address__\n        replacement: kubernetes.default.svc:443\n      - source_labels: [__meta_kubernetes_node_name]\n        regex: (.+)\n        target_label: __metrics_path__\n        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor\n    - job_name: 'kubernetes-node-exporter'\n      scheme: http\n      tls_config:\n        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      kubernetes_sd_configs:\n      - role: node\n      relabel_configs:\n      - action: labelmap\n        regex: __meta_kubernetes_node_label_(.+)\n      - source_labels: [__meta_kubernetes_role]\n        action: replace\n        target_label: kubernetes_role\n      - source_labels: [__address__]\n        regex: '(.*):10250'\n        replacement: '${1}:31672'\n        target_label: __address__\n    - job_name: 'kubernetes-service-endpoints'\n      kubernetes_sd_configs:\n      - role: endpoints\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n        action: replace\n        target_label: __scheme__\n        regex: (https?)\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n        action: replace\n        target_label: __metrics_path__\n        regex: (.+)\n      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\n        action: replace\n        target_label: __address__\n        regex: ([^:]+)(?::\\d+)?;(\\d+)\n        replacement: $1:$2\n      - action: labelmap\n        regex: __meta_kubernetes_service_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        action: replace\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_service_name]\n        action: replace\n        target_label: kubernetes_name\n    - job_name: 'kubernetes-services'\n      metrics_path: /probe\n      params:\n        module: [http_2xx]\n      kubernetes_sd_configs:\n      - role: service\n      relabel_configs:\n      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]\n        action: keep\n        regex: true\n      - source_labels: [__address__]\n        target_label: __param_target\n      - target_label: __address__\n        replacement: blackbox-exporter.example.com:9115\n      - source_labels: [__param_target]\n        target_label: instance\n      - action: labelmap\n        regex: __meta_kubernetes_service_label_(.+)\n      - source_labels: [__meta_kubernetes_namespace]\n        target_label: kubernetes_namespace\n      - source_labels: [__meta_kubernetes_service_name]\n        target_label: kubernetes_name\n  rules.yml: |\n    groups:\n    - name: test-rule\n      rules:\n      - alert: NodeFilesystemUsage\n        expr: (node_filesystem_size{device=\"rootfs\"} - node_filesystem_free{device=\"rootfs\"}) / node_filesystem_size{device=\"rootfs\"} * 100 &gt; 80\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{$labels.instance}}: High Filesystem usage detected\"\n          description: \"{{$labels.instance}}: Filesystem usage is above 80% (current value is: {{ $value }}\"\n      - alert: NodeMemoryUsage\n        expr: (node_memory_MemTotal - (node_memory_MemFree+node_memory_Buffers+node_memory_Cached )) / node_memory_MemTotal * 100 &gt; 80\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{$labels.instance}}: High Memory usage detected\"\n          description: \"{{$labels.instance}}: Memory usage is above 80% (current value is: {{ $value }}\"\n      - alert: NodeCPUUsage\n        expr: (100 - (avg by (instance) (irate(node_cpu{job=\"kubernetes-node-exporter\",mode=\"idle\"}[5m])) * 100)) &gt; 80\n        for: 2m\n        labels:\n          team: node\n        annotations:\n          summary: \"{{$labels.instance}}: High CPU usage detected\"\n          description: \"{{$labels.instance}}: CPU usage is above 80% (current value is: {{ $value }}\"\n---\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: alertmanager\n  namespace: kube-ops\ndata:\n  config.yml: |-\n    global:\n      resolve_timeout: 5m\n    route:\n      receiver: webhook\n      group_wait: 30s\n      group_interval: 5m\n      repeat_interval: 4h\n      group_by: [alertname]\n      routes:\n      - receiver: webhook\n        group_wait: 10s\n        match:\n          team: node\n    receivers:\n    - name: webhook\n      webhook_configs:\n      - url: 'http://apollo/hooks/dingtalk/'\n        send_resolved: true\n      - url: 'http://apollo/hooks/prome/'\n        send_resolved: true\n</code></pre> <p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f cm.yaml\n</code></pre> <p>\u7136\u540e\u90e8\u7f72\u7684\u6587\u4ef6<code>deploy.yaml</code>\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  labels:\n    k8s-app: prometheus\n  name: prometheus\n  namespace: kube-ops\nspec:\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        k8s-app: prometheus\n    spec:\n      serviceAccountName: prometheus\n      containers:\n      - image: prom/prometheus:v2.0.0-rc.3\n        name: prometheus\n        command:\n        - \"/bin/prometheus\"\n        args:\n        - \"--config.file=/etc/prometheus/prometheus.yml\"\n        - \"--storage.tsdb.path=/prometheus\"\n        - \"--storage.tsdb.retention=24h\"\n        ports:\n        - containerPort: 9090\n          protocol: TCP\n          name: http\n        volumeMounts:\n        - mountPath: \"/prometheus\"\n          name: data\n        - mountPath: \"/etc/prometheus\"\n          name: config-volume\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n          limits:\n            cpu: 200m\n            memory: 1Gi\n      - image: quay.io/prometheus/alertmanager:v0.12.0\n        name: alertmanager\n        args:\n        - \"-config.file=/etc/alertmanager/config.yml\"\n        - \"-storage.path=/alertmanager\"\n        ports:\n        - containerPort: 9093\n          protocol: TCP\n          name: http\n        volumeMounts:\n        - name: alertmanager-config-volume\n          mountPath: /etc/alertmanager\n        resources:\n          requests:\n            cpu: 50m\n            memory: 50Mi\n          limits:\n            cpu: 200m\n            memory: 200Mi\n      volumes:\n      - name: data\n        emptyDir: {}\n      - configMap:\n          name: prometheus-config\n        name: config-volume\n      - name: alertmanager-config-volume\n        configMap:\n          name: alertmanager\n\n</code></pre> <p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\uff1a \u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f deploy.yaml\n</code></pre> <p>\u6ce8\u610f\uff1a\u672c\u6587\u7ae0\u7684\u5b9e\u73b0\u90fd\u662f\u9488\u5bf9Prometheus2.x\u7248\u672c\uff0c1.x \u7248\u672c\u914d\u7f6e\u4f1a\u6709\u6240\u4e0d\u540c</p> <p>Prometheus: understanding the delays on alerting</p>"},{"location":"chap3/3changes_on_Grafana/","title":"\u7b2c\u4e09\u8282 Grafana \u663e\u793a\u53c2\u6570\u8bbe\u7f6e(2018)","text":"<p>\u6839\u636e <code>kubernetes json</code> \u6587\u4ef6\u7684\u53c2\u6570\u8bbe\u7f6e\uff0c \u663e\u793a\u5982\u4e0b:</p> <p></p> <p>\u9700\u8981\u91cd\u65b0\u8bbe\u7f6e Grafana \u4e2d\u7684 <code>Cluster memory usage</code>, <code>Cluster CPU usage</code>, <code>Cluster filesystem usage</code></p>"},{"location":"chap3/3changes_on_Grafana/#option-1","title":"Option 1","text":"<p>\u5728 <code>json</code> \u6587\u4ef6\u4e2d\u4fee\u6539</p> <p>kubernetes-pod-monitoring_rev1.json</p>"},{"location":"chap3/3changes_on_Grafana/#option-2","title":"Option 2","text":"<p>\u5728\u754c\u9762\u4e2d\u76f4\u63a5\u4fee\u6539</p> <p></p> <p></p> <p></p>"},{"location":"chap3/3changes_on_Grafana/#cluster-memory-usage","title":"Cluster memory usage","text":"<pre><code>(sum(node_memory_MemTotal_bytes) - sum(node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes) ) / sum(node_memory_MemTotal_bytes) * 100\n</code></pre>"},{"location":"chap3/3changes_on_Grafana/#cluster-cpu-usage","title":"Cluster CPU usage","text":"<pre><code>sum(sum by (name)( rate(container_cpu_usage_seconds_total{image!=\"\"}[1m] ) )) / count(node_cpu_seconds_total{mode=\"system\"}) * 100\n</code></pre>"},{"location":"chap3/3changes_on_Grafana/#cluster-filesystem-usage","title":"Cluster filesystem usage","text":"<pre><code>(sum(node_filesystem_size_bytes{device=\"tmpfs\"}) - sum(node_filesystem_free_bytes{device=\"tmpfs\"}) ) / sum(node_filesystem_size_bytes{device=\"tmpfs\"}) * 100\n</code></pre>"},{"location":"chap3/3changes_on_Grafana/#_1","title":"\u663e\u793a\u5982\u4e0b:","text":"<p>\u5982\u4f55\u9a8c\u8bc1\u8fd9\u4e9b\u51fd\u6570\u7684\u6b63\u786e\u6027\uff0c<code>Prometheus</code>\u63d0\u4f9b\u4e86API\u7684\u65b9\u5f0f\u8fdb\u884c\u6570\u636e\u67e5\u8be2\uff0c\u540c\u6837\u53ef\u4ee5\u4f7f\u7528query\u8bed\u8a00\u8fdb\u884c\u590d\u6742\u7684\u67e5\u8be2\u4efb\u52a1\uff0c\u5728\u4e0a\u9762\u7684WEB\u754c\u9762\u4e0a\u63d0\u4f9b\u4e86\u57fa\u672c\u7684\u67e5\u8be2\u548c\u56fe\u5f62\u5316\u7684\u5c55\u793a\u529f\u80fd\u3002\uff1a</p> <p></p> <p></p> <p>\u5982\u4f55\u67e5\u8be2\u67d0\u4e9b\u51fd\u6570\u7684\u5199\u6cd5\uff0c \u53ef\u4ee5\u518d <code>node</code> \u4e0a\u7684 <code>node-exporter</code> \u7aef\u53e3\u8bbf\u95ee, \u4f8b\u5982 </p> <p><code>http://192.168.1.138:31672/metrics</code></p> <p></p> <p></p>"},{"location":"chap3/41Prometheus_Monitor_OutCluster/","title":"\u7b2c\u5341\u56db\u8282 Prometheus\u76d1\u63a7\u5916\u90e8Kubernetes\u96c6\u7fa4","text":"<p>\u524d\u9762\u6211\u4eec\u7684\u6587\u7ae0\u4e2d\u90fd\u662f\u5c06 Prometheus \u5b89\u88c5\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u6765\u91c7\u96c6\u6570\u636e\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u73af\u5883\u4e2d\u5f88\u591a\u4f01\u4e1a\u662f\u5c06 Prometheus \u5355\u72ec\u90e8\u7f72\u5728\u96c6\u7fa4\u5916\u90e8\u7684\uff0c\u751a\u81f3\u76f4\u63a5\u76d1\u63a7\u591a\u4e2a Kubernetes \u96c6\u7fa4\uff0c\u867d\u7136\u4e0d\u63a8\u8350\u8fd9\u6837\u53bb\u505a\uff0c\u56e0\u4e3a Prometheus \u91c7\u96c6\u7684\u6570\u636e\u91cf\u592a\u5927\uff0c\u6216\u5927\u91cf\u6d88\u8017\u8d44\u6e90\uff0c\u6bd4\u8f83\u63a8\u8350\u7684\u505a\u6cd5\u662f\u7528\u4e0d\u540c\u7684 <code>Prometheus</code>\u5b9e\u4f8b\u76d1\u63a7\u4e0d\u540c\u7684\u96c6\u7fa4\uff0c\u7136\u540e\u7528\u8054\u90a6\u7684\u65b9\u5f0f\u8fdb\u884c\u6c47\u603b\u3002\u4f46\u662f\u4f7f\u7528 <code>Prometheus</code> \u76d1\u63a7\u5916\u90e8\u7684 <code>Kubernetes</code> \u96c6\u7fa4\u8fd9\u4e2a\u9700\u6c42\u8fd8\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u8981\u53bb\u91c7\u96c6 <code>Kubernetes</code> \u96c6\u7fa4 <code>cAdvisor</code> \u7684\u76d1\u63a7\u6570\u636e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528 <code>APIServer</code> \u901a\u8fc7 <code>kubelet</code> \u53bb\u83b7\u53d6\u5230\u5bf9\u5e94\u7684\u6570\u636e\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5bf9\u96c6\u7fa4\u5185\u90e8\u7684 <code>Prometheus</code> \u81ea\u52a8\u53d1\u73b0 <code>Kubernetes</code> \u7684\u6570\u636e\u6bd4\u8f83\u719f\u6089\u7684\u8bdd\uff0c\u90a3\u4e48\u76d1\u63a7\u5916\u90e8\u96c6\u7fa4\u7684\u539f\u7406\u4e5f\u662f\u4e00\u6837\u7684\uff0c\u53ea\u662f\u8bbf\u95ee <code>APIServer</code> \u7684\u5f62\u5f0f\u6709 <code>inCluster</code> \u6a21\u5f0f\u53d8\u6210\u4e86 <code>KubeConfig</code> \u7684\u6a21\u5f0f\uff0c<code>inCluster</code> \u6a21\u5f0f\u4e0b\u5728 <code>Pod</code> \u4e2d\u5c31\u5df2\u7ecf\u81ea\u52a8\u6ce8\u5165\u4e86\u8bbf\u95ee\u96c6\u7fa4\u7684 <code>token</code> \u548c <code>ca.crt</code> \u6587\u4ef6\uff0c\u6240\u4ee5\u975e\u5e38\u65b9\u4fbf\uff0c\u90a3\u4e48\u5728\u96c6\u7fa4\u5916\u7684\u8bdd\u5c31\u9700\u8981\u6211\u4eec\u624b\u52a8\u63d0\u4f9b\u8fd9\u4e24\u4e2a\u6587\u4ef6\uff0c\u624d\u80fd\u591f\u505a\u5230\u81ea\u52a8\u53d1\u73b0\u4e86\u3002</p> <p>\u63a5\u4e0b\u6765\u5c31\u9996\u5148\u6784\u9020 <code>Prometheus</code> \u8fde\u63a5 <code>APIServer</code> \u7684\u4fe1\u606f\uff0c\u5728\u901a\u8fc7 <code>kubernetes_sd_configs</code>\u505a\u670d\u52a1\u53d1\u73b0\u7684\u65f6\u5019\u53ea\u9700\u8981\u586b\u5165 <code>Kubernetes</code> \u96c6\u7fa4\u7684 <code>api_server</code>\u3001<code>ca_file</code>\u3001<code>bearer_token_file</code> \u4fe1\u606f\u5373\u53ef\uff0c\u8981\u60f3\u83b7\u5f97\u8fd9\u51e0\u4e2a\u6587\u4ef6\u4fe1\u606f\u4e5f\u6bd4\u8f83\u7b80\u5355\u3002</p> <p>\u521b\u5efa\u7528\u4e8e <code>Prometheus</code> \u8bbf\u95ee <code>Kubernetes</code> \u8d44\u6e90\u5bf9\u8c61\u7684 <code>RBAC</code> \u5bf9\u8c61\uff1a</p> <pre><code># prom.rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus\n  namespace: kube-mon\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - nodes\n  - services\n  - endpoints\n  - pods\n  - nodes/proxy\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - \"extensions\"\n  resources:\n    - ingresses\n  verbs:\n  - get\n  - list\n  - watch\n- apiGroups:\n  - \"\"\n  resources:\n  - configmaps\n  - nodes/metrics\n  verbs:\n  - get\n- nonResourceURLs:\n  - /metrics\n  verbs:\n  - get\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: prometheus\nsubjects:\n- kind: ServiceAccount\n  name: prometheus\n  namespace: kube-mon\n</code></pre> <p>\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f prom.rbac.yaml\n</code></pre> <p>\u7136\u540e\u83b7\u53d6\u4e0a\u9762\u7684 <code>Prometheus</code> \u5bf9\u5e94\u7684 <code>Secret</code> \u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get sa prometheus -n kube-mon -o yaml\n......\nsecrets:\n- name: prometheus-token-wj7fb\n\n$ kubectl describe secret prometheus-token-wj7fb -n kube-mon\nName:         prometheus-token-wj7fb\nNamespace:    kube-mon\n......\n\nData\n====\nnamespace:  8 bytes\ntoken:      &lt;token string&gt;\nca.crt:     1025 bytes\n</code></pre> <p>\u4e0a\u9762\u7684 <code>token</code> \u548c <code>ca.crt</code> \u4fe1\u606f\u5c31\u662f\u6211\u4eec\u7528\u4e8e\u8bbf\u95ee <code>APIServer</code> \u7684\u6570\u636e\uff0c\u53ef\u4ee5\u5c06 <code>token</code> \u4fe1\u606f\u4fdd\u5b58\u5230\u4e00\u4e2a\u540d\u4e3a <code>k8s.token</code> \u7684\u6587\u672c\u6587\u4ef6\u4e2d\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a <code>Prometheus</code> \u76d1\u63a7\u5916\u90e8 <code>Kubernetes</code> \u96c6\u7fa4\u6570\u636e\u7684\u4efb\u52a1\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># prometheus.yml\nglobal:\n  scrape_interval: 15s\n  scrape_timeout: 15s\nscrape_configs:\n- job_name: k8s-cadvisor\n  honor_timestamps: true\n  metrics_path: /metrics\n  scheme: https\n  kubernetes_sd_configs:  # kubernetes \u81ea\u52a8\u53d1\u73b0\n  - api_server: https://10.151.30.11:6443  # apiserver \u5730\u5740\n    role: node  # node \u7c7b\u578b\u7684\u81ea\u52a8\u53d1\u73b0\n    bearer_token_file: k8s.token\n    tls_config:\n      insecure_skip_verify: true\n  bearer_token_file: k8s.token  # \u4e0a\u9762\u751f\u6210\u7684token\n  tls_config:\n    insecure_skip_verify: true\n  relabel_configs:\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n  - separator: ;\n    regex: (.*)\n    target_label: __address__\n    replacement: 10.151.30.11:6443\n    action: replace\n  - source_labels: [__meta_kubernetes_node_name]\n    separator: ;\n    regex: (.+)\n    target_label: __metrics_path__\n    replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor\n    action: replace\n</code></pre> <p>\u8fd9\u91cc <code>bearer_token_file</code> \u5c31\u662f\u4e0a\u9762\u751f\u6210\u7684 <code>k8s.token</code> \u6587\u4ef6\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7528 <code>bearer_token</code> \u76f4\u63a5\u5c06\u5bf9\u5e94\u7684\u5b57\u7b26\u4e32\u653e\u7f6e\u5728\u8fd9\u91cc\uff0c\u53e6\u5916\u8981\u8bb0\u5f97\u5c06 <code>api_server</code> \u66ff\u6362\u6210\u4f60 <code>Prometheus</code> \u6240\u5728\u7684\u8282\u70b9\u80fd\u8bbf\u95ee\u5230\u7684 <code>APIServer</code> \u5730\u5740\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u76d1\u63a7 <code>cAdvisor</code>\uff0c\u540c\u6837\u53ef\u4ee5\u901a\u8fc7 <code>relabel_configs</code> \u6765\u914d\u7f6e\uff0c\u5c06 <code>__metrics_path__</code> \u8f6c\u6362\u4e3a <code>/api/v1/nodes/${1}/proxy/metrics/cadvisor</code>\uff0c\u76f8\u5f53\u4e8e\u901a\u8fc7 <code>APIServer</code> \u4ee3\u7406\u5230 <code>Kubelet</code> \u4e0a\u83b7\u53d6\u6570\u636e\u3002</p> <p>\u5f53\u7136\u5982\u679c\u4f60\u7684 <code>Prometheus</code> \u80fd\u591f\u76f4\u63a5\u8bbf\u95ee\u5230 <code>kubelet</code>\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e\u6210\u76f4\u63a5\u8bf7\u6c42\uff0c\u8fd9\u6837\u5c31\u76f8\u5f53\u4e8e\u670d\u52a1\u53d1\u73b0\u4f7f\u7528 <code>APIServer</code>\uff0c\u91c7\u96c6\u76f4\u63a5\u8d70 <code>Kubelet</code>\u3002</p> <p>\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u76f4\u63a5\u542f\u52a8 Prometheus \u5373\u53ef\u751f\u6548\uff1a</p> <pre><code>$ ./prometheus --config.file=prometheus.yaml\n.......\nlevel=info ts=2020-06-29T07:31:44.438Z caller=main.go:695 msg=\"TSDB started\"\nlevel=info ts=2020-06-29T07:31:44.438Z caller=main.go:799 msg=\"Loading configuration file\" filename=prometheus.yaml\nlevel=info ts=2020-06-29T07:31:44.448Z caller=main.go:827 msg=\"Completed loading of configuration file\" filename=prometheus.yaml\nlevel=info ts=2020-06-29T07:31:44.448Z caller=main.go:646 msg=\"Server is ready to receive web requests.\"\n</code></pre> <p>\u73b0\u5728\u53bb Prometheus \u9875\u9762\u5c31\u53ef\u4ee5\u770b\u5230\u91c7\u96c6\u7684\u5916\u90e8 Kubernetes \u96c6\u7fa4\u7684\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u5982\u679c\u4f60\u8981\u91c7\u96c6 <code>node-exporter</code> \u6216\u8005\u81ea\u52a8\u53d1\u73b0 <code>Endpoints</code>\u3001<code>Pods</code> \u90fd\u662f\u4e00\u6837\u7684\u539f\u7406\u3002</p>"},{"location":"chap3/4Adv_Prometheus_setup/","title":"\u7b2c\u56db\u8282 \u5728 Kubernetes \u4e2d\u624b\u52a8\u90e8\u7f72 Prometheus (adv)","text":"<p>\u5728\u65e9\u671f\u7684\u7248\u672c\u4e2d <code>Kubernetes</code> \u63d0\u4f9b\u4e86 <code>heapster</code>\u3001<code>influxDB</code>\u3001<code>grafana</code> \u7684\u7ec4\u5408\u6765\u76d1\u63a7\u7cfb\u7edf\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728 <code>Dashboard</code> \u4e2d\u770b\u5230 <code>heapster</code> \u63d0\u4f9b\u7684\u4e00\u4e9b\u56fe\u8868\u4fe1\u606f\uff0c\u5728\u540e\u7eed\u7684\u7248\u672c\u4e2d\u4f1a\u9646\u7eed\u79fb\u9664\u6389 <code>heapster</code>\uff0c\u73b0\u5728\u66f4\u52a0\u6d41\u884c\u7684\u76d1\u63a7\u5de5\u5177\u662f <code>prometheus</code>\uff0c<code>prometheus</code> \u662f <code>Google</code> \u5185\u90e8\u76d1\u63a7\u62a5\u8b66\u7cfb\u7edf\u7684\u5f00\u6e90\u7248\u672c\uff0c\u662f <code>Google SRE</code>\u601d\u60f3\u5728\u5176\u5185\u90e8\u4e0d\u65ad\u5b8c\u5584\u7684\u4ea7\u7269\uff0c\u5b83\u7684\u5b58\u5728\u662f\u4e3a\u4e86\u66f4\u5feb\u548c\u9ad8\u6548\u7684\u53d1\u73b0\u95ee\u9898\uff0c\u5feb\u901f\u7684\u63a5\u5165\u901f\u5ea6\uff0c\u7b80\u5355\u7075\u6d3b\u7684\u914d\u7f6e\u90fd\u5f88\u597d\u7684\u89e3\u51b3\u4e86\u8fd9\u4e00\u5207\uff0c\u800c\u4e14\u662f\u5df2\u7ecf\u6bd5\u4e1a\u7684 <code>CNCF</code> \u9879\u76ee\u3002</p>"},{"location":"chap3/4Adv_Prometheus_setup/#1","title":"1 \u7b80\u4ecb","text":"<p><code>Prometheus</code> \u6700\u521d\u662f <code>SoundCloud</code> \u6784\u5efa\u7684\u5f00\u6e90\u7cfb\u7edf\u76d1\u63a7\u548c\u62a5\u8b66\u5de5\u5177\uff0c\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u5f00\u6e90\u9879\u76ee\uff0c\u4e8e2016\u5e74\u52a0\u5165\u4e86 <code>CNCF</code> \u57fa\u91d1\u4f1a\uff0c\u4f5c\u4e3a\u7ee7 Kubernetes \u4e4b\u540e\u7684\u7b2c\u4e8c\u4e2a\u6258\u7ba1\u9879\u76ee\u3002</p>"},{"location":"chap3/4Adv_Prometheus_setup/#2","title":"2 \u7279\u5f81","text":"<p><code>Prometheus</code> \u76f8\u6bd4\u4e8e\u5176\u4ed6\u4f20\u7edf\u76d1\u63a7\u5de5\u5177\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a</p> <ul> <li>\u5177\u6709\u7531 <code>metric</code> \u540d\u79f0\u548c\u952e/\u503c\u5bf9\u6807\u8bc6\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u7684\u591a\u7ef4\u6570\u636e\u6a21\u578b</li> <li>\u6709\u4e00\u4e2a\u7075\u6d3b\u7684\u67e5\u8be2\u8bed\u8a00</li> <li>\u4e0d\u4f9d\u8d56\u5206\u5e03\u5f0f\u5b58\u50a8\uff0c\u53ea\u548c\u672c\u5730\u78c1\u76d8\u6709\u5173</li> <li>\u901a\u8fc7 <code>HTTP</code> \u7684\u670d\u52a1\u62c9\u53d6\u65f6\u95f4\u5e8f\u5217\u6570\u636e</li> <li>\u4e5f\u652f\u6301\u63a8\u9001\u7684\u65b9\u5f0f\u6765\u6dfb\u52a0\u65f6\u95f4\u5e8f\u5217\u6570\u636e</li> <li>\u8fd8\u652f\u6301\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u6216\u9759\u6001\u914d\u7f6e\u53d1\u73b0\u76ee\u6807</li> <li>\u591a\u79cd\u56fe\u5f62\u548c\u4eea\u8868\u677f\u652f\u6301</li> </ul>"},{"location":"chap3/4Adv_Prometheus_setup/#3","title":"3 \u7ec4\u4ef6","text":"<p><code>Prometheus</code> \u7531\u591a\u4e2a\u7ec4\u4ef6\u7ec4\u6210\uff0c\u4f46\u662f\u5176\u4e2d\u8bb8\u591a\u7ec4\u4ef6\u662f\u53ef\u9009\u7684</p> <ul> <li><code>Prometheus Server</code>\uff1a\u7528\u4e8e\u6293\u53d6\u6307\u6807\u3001\u5b58\u50a8\u65f6\u95f4\u5e8f\u5217\u6570\u636e</li> <li><code>exporter</code>\uff1a\u66b4\u9732\u6307\u6807\u8ba9\u4efb\u52a1\u6765\u6293</li> <li><code>pushgateway</code>\uff1apush \u7684\u65b9\u5f0f\u5c06\u6307\u6807\u6570\u636e\u63a8\u9001\u5230\u8be5\u7f51\u5173</li> <li><code>alertmanager</code>\uff1a\u5904\u7406\u62a5\u8b66\u7684\u62a5\u8b66\u7ec4\u4ef6</li> <li><code>adhoc</code>\uff1a\u7528\u4e8e\u6570\u636e\u67e5\u8be2</li> </ul> <p>\u5927\u591a\u6570 <code>Prometheus</code> \u7ec4\u4ef6\u90fd\u662f\u7528 <code>Go</code> \u7f16\u5199\u7684\uff0c\u56e0\u6b64\u5f88\u5bb9\u6613\u6784\u5efa\u548c\u90e8\u7f72\u4e3a\u9759\u6001\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002</p>"},{"location":"chap3/4Adv_Prometheus_setup/#4","title":"4 \u67b6\u6784","text":"<p>\u4e0b\u56fe\u662f <code>Prometheus</code> \u5b98\u65b9\u63d0\u4f9b\u7684\u67b6\u6784\u53ca\u5176\u4e00\u4e9b\u76f8\u5173\u7684\u751f\u6001\u7cfb\u7edf\u7ec4\u4ef6\uff1a</p> <p></p> <p>\u6574\u4f53\u6d41\u7a0b\u6bd4\u8f83\u7b80\u5355\uff0c<code>Prometheus</code> \u76f4\u63a5\u63a5\u6536\u6216\u8005\u901a\u8fc7\u4e2d\u95f4\u7684 <code>Pushgateway</code> \u7f51\u5173\u88ab\u52a8\u83b7\u53d6\u6307\u6807\u6570\u636e\uff0c\u5728\u672c\u5730\u5b58\u50a8\u6240\u6709\u7684\u83b7\u53d6\u7684\u6307\u6807\u6570\u636e\uff0c\u5e76\u5bf9\u8fd9\u4e9b\u6570\u636e\u8fdb\u884c\u4e00\u4e9b\u89c4\u5219\u6574\u7406\uff0c\u7528\u6765\u751f\u6210\u4e00\u4e9b\u805a\u5408\u6570\u636e\u6216\u8005\u62a5\u8b66\u4fe1\u606f\uff0cGrafana \u6216\u8005\u5176\u4ed6\u5de5\u5177\u7528\u6765\u53ef\u89c6\u5316\u8fd9\u4e9b\u6570\u636e\u3002</p>"},{"location":"chap3/4Adv_Prometheus_setup/#5","title":"5 \u5b89\u88c5","text":"<p>\u7531\u4e8e Prometheus \u662f Golang \u7f16\u5199\u7684\u7a0b\u5e8f\uff0c\u6240\u4ee5\u8981\u5b89\u88c5\u7684\u8bdd\u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e0b\u8f7d\u4e0b\u6765\u76f4\u63a5\u6267\u884c\u5373\u53ef\uff0c\u524d\u5f80\u5730\u5740\uff1a<code>https://prometheus.io/download</code> \u4e0b\u8f7d\u6211\u4eec\u5bf9\u5e94\u7684\u7248\u672c\u5373\u53ef\u3002</p> <p><code>Prometheus</code> \u662f\u901a\u8fc7\u4e00\u4e2a <code>YAML</code> \u914d\u7f6e\u6587\u4ef6\u6765\u8fdb\u884c\u542f\u52a8\u7684\uff0c\u5982\u679c\u6211\u4eec\u4f7f\u7528\u4e8c\u8fdb\u5236\u7684\u65b9\u5f0f\u6765\u542f\u52a8\u7684\u8bdd\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ ./prometheus --config.file=prometheus.yml\n</code></pre> <p>\u5176\u4e2d <code>prometheus.yml</code> \u6587\u4ef6\u7684\u57fa\u672c\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>global:\n  scrape_interval: 15s  \n  evaluation_interval: 15s\nrule_files:\n  # - \"first.rules\"\n  # - \"second.rules\"\nscrape_configs:\n  - job_name: prometheus    \n    static_configs:\n      - targets: ['localhost:9090']\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u4e2d\u5305\u542b\u4e863\u4e2a\u6a21\u5757\uff1a<code>global</code>\u3001<code>rule_files</code> \u548c <code>scrape_configs</code>\u3002</p>"},{"location":"chap3/4Adv_Prometheus_setup/#1-global-prometheus-server","title":"1.\u5176\u4e2d <code>global</code> \u6a21\u5757\u63a7\u5236 <code>Prometheus Server</code> \u7684\u5168\u5c40\u914d\u7f6e\uff1a","text":"<ul> <li><code>scrape_interval</code>\uff1a\u8868\u793a <code>prometheus</code> \u6293\u53d6\u6307\u6807\u6570\u636e\u7684\u9891\u7387\uff0c\u9ed8\u8ba4\u662f<code>15s</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u8986\u76d6\u8fd9\u4e2a\u503c</li> <li><code>evaluation_interval</code>\uff1a\u7528\u6765\u63a7\u5236\u8bc4\u4f30\u89c4\u5219\u7684\u9891\u7387\uff0c<code>prometheus</code> \u4f7f\u7528\u89c4\u5219\u4ea7\u751f\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u6216\u8005\u4ea7\u751f\u8b66\u62a5</li> </ul>"},{"location":"chap3/4Adv_Prometheus_setup/#2rule_files","title":"2.<code>rule_files</code> \u6a21\u5757\u5236\u5b9a\u4e86\u89c4\u5219\u6240\u5728\u7684\u4f4d\u7f6e:","text":"<p><code>prometheus</code> \u53ef\u4ee5\u6839\u636e\u8fd9\u4e2a\u914d\u7f6e\u52a0\u8f7d\u89c4\u5219\uff0c\u7528\u4e8e\u751f\u6210\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u6216\u8005\u62a5\u8b66\u4fe1\u606f\uff0c\u5f53\u524d\u6211\u4eec\u6ca1\u6709\u914d\u7f6e\u4efb\u4f55\u89c4\u5219\u3002</p>"},{"location":"chap3/4Adv_Prometheus_setup/#3scrape_configs-prometheus","title":"3.<code>scrape_configs</code> \u7528\u4e8e\u63a7\u5236 <code>prometheus</code> \u76d1\u63a7\u54ea\u4e9b\u8d44\u6e90\u3002","text":"<ul> <li>\u7531\u4e8e <code>prometheus</code> \u901a\u8fc7 <code>HTTP</code> \u7684\u65b9\u5f0f\u6765\u66b4\u9732\u7684\u5b83\u672c\u8eab\u7684\u76d1\u63a7\u6570\u636e\uff0c<code>prometheus</code> \u4e5f\u80fd\u591f\u76d1\u63a7\u672c\u8eab\u7684\u5065\u5eb7\u60c5\u51b5\u3002</li> <li>\u5728\u9ed8\u8ba4\u7684\u914d\u7f6e\u91cc\u6709\u4e00\u4e2a\u5355\u72ec\u7684 <code>job</code>\uff0c\u53eb\u505a<code>prometheus</code>\uff0c\u5b83\u91c7\u96c6 <code>prometheus</code> \u670d\u52a1\u672c\u8eab\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u3002</li> <li>\u8fd9\u4e2a job \u5305\u542b\u4e86\u4e00\u4e2a\u5355\u72ec\u7684\u3001\u9759\u6001\u914d\u7f6e\u7684\u76ee\u6807\uff1a\u76d1\u542c <code>localhost</code> \u4e0a\u7684<code>9090</code>\u7aef\u53e3\u3002prometheus \u9ed8\u8ba4\u4f1a\u901a\u8fc7\u76ee\u6807\u7684<code>/metrics</code>\u8def\u5f84\u91c7\u96c6 <code>metrics</code>\u3002\u6240\u4ee5\uff0c\u9ed8\u8ba4\u7684 job \u901a\u8fc7 URL\uff1a<code>http://localhost:9090/metrics</code>\u91c7\u96c6 <code>metrics</code>\u3002</li> <li>\u6536\u96c6\u5230\u7684\u65f6\u95f4\u5e8f\u5217\u5305\u542b <code>prometheus</code> \u670d\u52a1\u672c\u8eab\u7684\u72b6\u6001\u548c\u6027\u80fd\u3002\u5982\u679c\u6211\u4eec\u8fd8\u6709\u5176\u4ed6\u7684\u8d44\u6e90\u9700\u8981\u76d1\u63a7\u7684\u8bdd\uff0c\u76f4\u63a5\u914d\u7f6e\u5728\u8be5\u6a21\u5757\u4e0b\u9762\u5c31\u53ef\u4ee5\u4e86\u3002</li> </ul> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u662f\u8981\u8dd1\u5728 <code>Kubernetes</code> \u7cfb\u7edf\u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u7528 <code>Docker</code> \u955c\u50cf\u7684\u65b9\u5f0f\u8fd0\u884c\u5373\u53ef\u3002</p> <p>\u4e3a\u4e86\u80fd\u591f\u65b9\u4fbf\u7684\u7ba1\u7406\u914d\u7f6e\u6587\u4ef6\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06 <code>prometheus.yml</code> \u6587\u4ef6\u7528 <code>ConfigMap</code> \u7684\u5f62\u5f0f\u8fdb\u884c\u7ba1\u7406\uff1a\uff08<code>prometheus-cm.yaml</code>\uff09</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config  \n  namespace: kube-ops\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n    scrape_configs:\n    - job_name: 'prometheus'\n      static_configs:\n      - targets: ['localhost:9090']\n</code></pre> <pre><code>data:\n  prometheus.yml: |\n    gloabl:\n    scrape_configs:\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u6682\u65f6\u53ea\u914d\u7f6e\u4e86\u5bf9 <code>prometheus</code> \u7684\u76d1\u63a7\uff0c\u7136\u540e\u521b\u5efa\u8be5\u8d44\u6e90\u5bf9\u8c61:</p> <pre><code>$ kubectl create -f prometheus-cm.yaml\nconfigmap \"prometheus-config\" created\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u521b\u5efa\u5b8c\u6210\u4e86\uff0c\u4ee5\u540e\u5982\u679c\u6211\u4eec\u6709\u65b0\u7684\u8d44\u6e90\u9700\u8981\u88ab\u76d1\u63a7\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5c06\u4e0a\u9762\u7684 <code>ConfigMap</code> \u5bf9\u8c61\u66f4\u65b0\u5373\u53ef\u3002\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa prometheus \u7684 Pod \u8d44\u6e90\uff1a(<code>prometheus-deploy.yaml</code>)</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: prometheus  \n  namespace: kube-ops  \n  labels:\n    app: prometheus\nspec:\n  template:\n    metadata:\n      labels:\n        app: prometheus    \n    spec:\n      serviceAccountName: prometheus      \n      containers:\n      - image: prom/prometheus:v2.4.3        \n        name: prometheus        \n        args:\n        - \"--config.file=/etc/prometheus/prometheus.yml\"\n        - \"--storage.tsdb.path=/prometheus\"\n        - \"--storage.tsdb.retention=24h\"\n        - \"--web.enable-admin-api\"  # \u63a7\u5236\u5bf9admin HTTP API\u7684\u8bbf\u95ee\uff0c\u5176\u4e2d\u5305\u62ec\u5220\u9664\u65f6\u95f4\u5e8f\u5217\u7b49\u529f\u80fd\n        - \"--web.enable-lifecycle\"  # \u652f\u6301\u70ed\u66f4\u65b0\uff0c\u76f4\u63a5\u6267\u884clocalhost:9090/-/reload\u7acb\u5373\u751f\u6548\n        ports:\n        - containerPort: 9090\n          protocol: TCP          \n          name: http        \n        volumeMounts:\n        - mountPath: \"/prometheus\"\n          subPath: prometheus          \n          name: data        \n        - mountPath: \"/etc/prometheus\"\n          name: config-volume        \n        resources:\n          requests:\n            cpu: 100m            \n            memory: 512Mi          \n          limits:\n            cpu: 100m            \n          memory: 512Mi      \n      securityContext:\n        runAsUser: 0\n      volumes:\n      - name: data        \n        persistentVolumeClaim:\n          claimName: prometheus      \n      - configMap:\n          name: prometheus-config        \n        name: config-volume\n</code></pre> <p>\u6211\u4eec\u5728\u542f\u52a8\u7a0b\u5e8f\u7684\u65f6\u5019\uff0c\u9664\u4e86\u6307\u5b9a\u4e86 <code>prometheus.yml</code> \u6587\u4ef6\u4e4b\u5916\uff0c</p> <ul> <li>\u8fd8\u901a\u8fc7\u53c2\u6570 <code>storage.tsdb.path</code> \u6307\u5b9a\u4e86 <code>TSDB</code> \u6570\u636e\u7684\u5b58\u50a8\u8def\u5f84\u3002</li> <li>\u901a\u8fc7<code>storage.tsdb.retention</code> \u8bbe\u7f6e\u4e86\u4fdd\u7559\u591a\u957f\u65f6\u95f4\u7684\u6570\u636e\u3002</li> <li>\u8fd8\u6709\u4e0b\u9762\u7684<code>web.enable-admin-api</code>\u53c2\u6570\u53ef\u4ee5\u7528\u6765\u5f00\u542f\u5bf9 <code>admin api</code> \u7684\u8bbf\u95ee\u6743\u9650\u3002</li> <li>\u53c2\u6570<code>web.enable-lifecycle</code>\u975e\u5e38\u91cd\u8981\uff0c\u7528\u6765\u5f00\u542f\u652f\u6301\u70ed\u66f4\u65b0\u7684\uff0c\u6709\u4e86\u8fd9\u4e2a\u53c2\u6570\u4e4b\u540e\uff0c<code>prometheus.yml</code> \u914d\u7f6e\u6587\u4ef6\u53ea\u8981\u66f4\u65b0\u4e86\uff0c\u901a\u8fc7\u6267\u884c<code>localhost:9090/-/reload</code>\u5c31\u4f1a\u7acb\u5373\u751f\u6548\uff0c\u6240\u4ee5\u4e00\u5b9a\u8981\u52a0\u4e0a\u8fd9\u4e2a\u53c2\u6570\u3002</li> </ul> <p>\u6211\u4eec\u8fd9\u91cc\u5c06 <code>prometheus.yml</code> \u6587\u4ef6\u5bf9\u5e94\u7684 <code>ConfigMap</code> \u5bf9\u8c61\u901a\u8fc7 <code>volume</code> \u7684\u5f62\u5f0f\u6302\u8f7d\u8fdb\u4e86 <code>Pod</code>\uff0c\u8fd9\u6837 <code>ConfigMap</code> \u66f4\u65b0\u540e\uff0c\u5bf9\u5e94\u7684 <code>Pod</code> \u91cc\u9762\u7684\u6587\u4ef6\u4e5f\u4f1a\u70ed\u66f4\u65b0\u7684.</p> <p>\u7136\u540e\u6211\u4eec\u518d\u6267\u884c\u4e0a\u9762\u7684 <code>reload</code> \u8bf7\u6c42\uff0c<code>Prometheus</code> \u914d\u7f6e\u5c31\u751f\u6548\u4e86\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u4e3a\u4e86\u5c06\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u8fdb\u884c\u6301\u4e45\u5316\uff0c\u6211\u4eec\u5c06\u6570\u636e\u76ee\u5f55\u548c\u4e00\u4e2a <code>pvc</code> \u5bf9\u8c61\u8fdb\u884c\u4e86\u7ed1\u5b9a\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u63d0\u524d\u521b\u5efa\u597d\u8fd9\u4e2a <code>pvc</code> \u5bf9\u8c61\uff1a(<code>prometheus-volume.yaml</code>)</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: prometheus\nspec:\n  capacity:\n    storage: 10Gi  \n  accessModes:\n  - ReadWriteOnce  \n  persistentVolumeReclaimPolicy: Recycle  \n  nfs:\n    server: 10.151.30.57    \n    path: /data/k8s\n\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: prometheus  \n  namespace: kube-ops\nspec:\n  accessModes:\n  - ReadWriteOnce  \n  resources:\n    requests:\n      storage: 10Gi\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u7b80\u5355\u7684\u901a\u8fc7 <code>NFS</code> \u4f5c\u4e3a\u5b58\u50a8\u540e\u7aef\u521b\u5efa\u4e00\u4e2a <code>pv\u3001pvc</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f prometheus-volume.yaml\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u7684\u6ce8\u610f\u4e8b\u9879\u5916\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u9700\u8981\u914d\u7f6e <code>rbac</code> \u8ba4\u8bc1\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u5728 <code>prometheus</code> \u4e2d\u53bb\u8bbf\u95ee <code>Kubernetes</code>\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7ba1\u7406\u4e86\u4e00\u4e2a\u540d\u4e3a <code>prometheus</code>\u7684 <code>serviceAccount</code> \u5bf9\u8c61\uff1a(<code>prometheus-rbac.yaml</code>)</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: prometheus  \n  namespace: kube-ops\n\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: prometheus\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes  \n  - services  \n  - endpoints  \n  - pods  \n  - nodes/proxy  \n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"\"]\n  resources:\n  - configmaps  \n  verbs: [\"get\"]\n- nonResourceURLs: [\"/metics\"]  # \u5bf9\u975e\u8d44\u6e90\u578b endpoint metrics \u8fdb\u884c get \u64cd\u4f5c\n  verbs: [\"get\"]\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: prometheus\nroleRef:\n  apiGroup: rbac.authorization.k8s.io  \n  kind: ClusterRole  \n  name: prometheus\nsubjects:\n- kind: ServiceAccount  \n  name: prometheus  \n  namespace: kube-ops\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8981\u83b7\u53d6\u7684\u8d44\u6e90\u4fe1\u606f\uff0c\u5728\u6bcf\u4e00\u4e2a <code>namespace</code> \u4e0b\u9762\u90fd\u6709\u53ef\u80fd\u5b58\u5728\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f <code>ClusterRole</code> \u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u503c\u5f97\u4e00\u63d0\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u7684\u6743\u9650\u89c4\u5219\u58f0\u660e\u4e2d\u6709\u4e00\u4e2a <code>nonResourceURLs</code>\u7684\u5c5e\u6027\uff0c\u662f\u7528\u6765\u5bf9\u975e\u8d44\u6e90\u578b <code>metrics</code> \u8fdb\u884c\u64cd\u4f5c\u7684\u6743\u9650\u58f0\u660e\uff0c\u8fd9\u4e2a\u5728\u4ee5\u524d\u6211\u4eec\u5f88\u5c11\u9047\u5230\u8fc7\uff0c\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create -f prometheus-rbac.yaml\nserviceaccount \"prometheus\" created\nclusterrole.rbac.authorization.k8s.io \"prometheus\" created\nclusterrolebinding.rbac.authorization.k8s.io \"prometheus\" created\n</code></pre> <p>\u8fd8\u6709\u4e00\u4e2a\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\u6211\u4eec\u8fd9\u91cc\u5fc5\u987b\u8981\u6dfb\u52a0\u4e00\u4e2a<code>securityContext</code>\u7684\u5c5e\u6027\u5728 <code>prometheus deployment</code>\uff0c\u5c06\u5176\u4e2d\u7684<code>runAsUser</code>\u8bbe\u7f6e\u4e3a<code>0</code>\uff0c\u8fd9\u662f\u56e0\u4e3a\u73b0\u5728\u7684 <code>prometheus</code> \u8fd0\u884c\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u7684\u7528\u6237\u662f <code>nobody</code>\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u4e0b\u9762\u7684<code>permission denied</code>\u4e4b\u7c7b\u7684\u6743\u9650\u9519\u8bef\uff1a</p> <pre><code>level=error ts=2018-10-22T14:34:58.632016274Z caller=main.go:617 err=\"opening storage failed: lock DB directory: open /data/lock: permission denied\n</code></pre>"},{"location":"chap3/4Adv_Prometheus_setup/#4promethues","title":"4.\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u6dfb\u52a0promethues\u7684\u8d44\u6e90\u5bf9\u8c61\u4e86\uff1a","text":"<pre><code>$ kubectl create -f prometheus-deploy.yaml\ndeployment.extensions \"prometheus\" created\n\n$ kubectl get pods -n kube-ops\nNAME                          READY     STATUS    RESTARTS   AGE\nprometheus-6dd775cbff-zb69l   1/1       Running   0          20m\n\n$ kubectl logs -f prometheus-6dd775cbff-zb69l -n kube-ops......level=info ts=2018-10-22T14:44:40.535385503Z caller=main.go:523 msg=\"Server is ready to receive web requests.\"\n</code></pre> <p><code>Pod</code> \u521b\u5efa\u6210\u529f\u540e\uff0c\u4e3a\u4e86\u80fd\u591f\u5728\u5916\u90e8\u8bbf\u95ee\u5230 <code>prometheus</code> \u7684\u5916\u90e8\u670d\u52a1\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u521b\u5efa\u4e00\u4e2a <code>Service</code> \u5bf9\u8c61\uff1a(<code>prometheus-svc.yaml</code>)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: prometheus  \n  namespace: kube-ops  \n  labels:\n    app: prometheus\nspec:\n  selector:\n    app: prometheus  \n  type: NodePort  \n  ports:\n  - name: web      \n    port: 9090\n    targetPort: http\n</code></pre> <p>\u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\uff0c\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a<code>NodePort</code>\u7c7b\u578b\u7684\u670d\u52a1\uff0c\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a<code>Ingress</code>\u5bf9\u8c61\uff0c\u901a\u8fc7\u57df\u540d\u6765\u8fdb\u884c\u8bbf\u95ee\uff1a</p> <pre><code>$ kubectl create -f prometheus-svc.yaml\nservice \"prometheus\" created\n\n$ kubectl get svc -n kube-ops\nNAME         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                          AGE\nprometheus   NodePort   10.111.118.104   &lt;none&gt;        9090:30987/TCP                   24s\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7<code>http://\u4efb\u610f\u8282\u70b9IP:30987</code>\u8bbf\u95ee <code>prometheus</code> \u7684 \u5916\u90e8\u670d\u52a1\u4e86\u3002</p> <p></p> <p>\u4e3a\u4e86\u6570\u636e\u7684\u4e00\u81f4\u6027\uff0c<code>prometheus</code> \u6240\u6709\u7684\u6570\u636e\u90fd\u662f\u4f7f\u7528\u7684 <code>UTC</code> \u65f6\u95f4\uff0c\u6240\u4ee5\u6211\u4eec\u9ed8\u8ba4\u6253\u5f00\u7684 <code>dashboard</code> \u4e2d\u6709\u8fd9\u6837\u4e00\u4e2a\u8b66\u544a\uff0c\u6211\u4eec\u9700\u8981\u5728\u67e5\u8be2\u7684\u65f6\u5019\u6307\u5b9a\u6211\u4eec\u5f53\u524d\u7684\u65f6\u95f4\u624d\u53ef\u4ee5\u3002\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u76d1\u63a7\u7cfb\u7edf\u4e2d\u7684\u4e00\u4e9b\u76d1\u63a7\u76ee\u6807</p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u73b0\u5728\u8fd8\u6ca1\u6709\u914d\u7f6e\u4efb\u4f55\u7684\u62a5\u8b66\u4fe1\u606f\uff0c\u6240\u4ee5 Alerts \u83dc\u5355\u4e0b\u9762\u73b0\u5728\u6ca1\u6709\u4efb\u4f55\u6570\u636e\uff0c\u9694\u4e00\u4f1a\u513f\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb Graph \u83dc\u5355\u4e0b\u9762\u67e5\u770b\u6211\u4eec\u6293\u53d6\u7684 prometheus \u672c\u8eab\u7684\u4e00\u4e9b\u76d1\u63a7\u6570\u636e\u4e86\uff0c\u5176\u4e2d <code>insert metrics at cursor</code> \u4e0b\u9762\u5c31\u662f\u6211\u4eec\u641c\u96c6\u5230\u7684\u4e00\u4e9b\u76d1\u63a7\u6570\u636e\u6307\u6807\uff1a</p> <p></p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5c31\u9009\u62e9 <code>scrape_duration_seconds</code> \u8fd9\u4e2a\u6307\u6807\uff0c\u7136\u540e\u70b9\u51fb<code>Execute\uff0c\u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u6ca1\u6709\u67e5\u8be2\u5230\u4efb\u4f55\u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u5207\u6362\u5230</code>Graph<code>\u8fd9\u4e2a</code>tab `\u4e0b\u9762\u91cd\u65b0\u9009\u62e9\u4e0b\u65f6\u95f4\uff0c\u9009\u62e9\u5230\u5f53\u524d\u7684\u65f6\u95f4\u70b9\uff0c\u91cd\u65b0\u6267\u884c\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u56fe\u8868\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u9664\u4e86\u7b80\u5355\u7684\u76f4\u63a5\u4f7f\u7528\u91c7\u96c6\u5230\u7684\u4e00\u4e9b\u76d1\u63a7\u6307\u6807\u6570\u636e\u4e4b\u5916\uff0c\u8fd9\u4e2a\u65f6\u5019\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5f3a\u5927\u7684 <code>PromQL</code> \u5de5\u5177\uff0c<code>PromQL</code>\u5176\u5b9e\u5c31\u662f <code>prometheus</code> \u4fbf\u4e8e\u6570\u636e\u805a\u5408\u5c55\u793a\u5f00\u53d1\u7684\u4e00\u5957 <code>ad hoc</code> \u67e5\u8be2\u8bed\u8a00\u7684\uff0c\u4f60\u60f3\u8981\u67e5\u4ec0\u4e48\u627e\u5bf9\u5e94\u51fd\u6570\u53d6\u4f60\u7684\u6570\u636e\u597d\u4e86\u3002</p>"},{"location":"chap3/50PrometheusAlert/","title":"\u7b2c\u5341\u4e00\u8282 Prometheus\u4e2d\u4f7f\u7528PrometheusAlert\u8fdb\u884c\u805a\u5408\u62a5\u8b66","text":"<p>\u672c\u8eabprometheus\u5df2\u7ecf\u6709\u4e86alertmanager\u8fd9\u4e2a\u7ec4\u4ef6\u63d0\u4f9b\u4e86\u4e00\u4e9b\u62a5\u8b66\u5a92\u4ecb\u6bd4\u5982email wechat\u7b49\uff0c\u4e3a\u4ec0\u4e48\u6211\u8fd8\u8fd8\u8981\u4f7f\u7528prometheusalert\u5462\uff1f</p> <p>Prometheus Alert\u662f\u5f00\u6e90\u7684\u8fd0\u7ef4\u544a\u8b66\u4e2d\u5fc3\u6d88\u606f\u8f6c\u53d1\u7cfb\u7edf,\u652f\u6301\u4e3b\u6d41\u7684\u76d1\u63a7\u7cfb\u7edfPrometheus,Zabbix,\u65e5\u5fd7\u7cfb\u7edfGraylog\u548c\u6570\u636e\u53ef\u89c6\u5316\u7cfb\u7edfGrafana\u53d1\u51fa\u7684\u9884\u8b66\u6d88\u606f,\u652f\u6301\u9489\u9489,\u5fae\u4fe1,\u534e\u4e3a\u4e91\u77ed\u4fe1,\u817e\u8baf\u4e91\u77ed\u4fe1,\u817e\u8baf\u4e91\u7535\u8bdd,\u963f\u91cc\u4e91\u77ed\u4fe1,\u963f\u91cc\u4e91\u7535\u8bdd\u7b49\uff0c</p> <p>\u53ef\u4ee5\u770b\u51faprometheusalert\u76f8\u6bd4\u548calertmanager\u5185\u7f6e\u7684\u62a5\u8b66\u5a92\u4ecb\u76f8\u6bd4\u652f\u6301\u7684\u66f4\u5168\u9762\uff0c\u5e76\u4e14\u914d\u7f6e\u548c\u8c03\u8bd5\u66f4\u65b9\u4fbf\uff0cprometheusalert \u5e76\u4e0d\u80fd\u53d6\u4ee3alertmanager\uff0c\u800c\u662f\u8981\u4f5c\u4e3awebhoook\u4e0ealertmanager\u7ed3\u5408\u4f7f\u7528\u3002</p> <pre><code>#Kubernetes\u4e2d\u8fd0\u884c\u53ef\u4ee5\u76f4\u63a5\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u884c\u5373\u53ef(\u6ce8\u610f\u9ed8\u8ba4\u7684\u90e8\u7f72\u6a21\u7248\u4e2d\u672a\u6302\u8f7d\u6a21\u7248\u6570\u636e\u5e93\u6587\u4ef6 db/PrometheusAlertDB.db\uff0c\u4e3a\u9632\u6b62\u6a21\u7248\u6570\u636e\u4e22\u5931\uff0c\u8bf7\u81ea\u884c\u589e\u52a0\u6302\u8f7d\u914d\u7f6e )\n\n\nwget https://raw.githubusercontent.com/feiyu563/PrometheusAlert/master/example/kubernetes/PrometheusAlert-Deployment.yaml\n</code></pre> <p>\u6ce8\u610f\uff1a\u8fd9\u91cc\u9700\u8981\u4fee\u6539\u4e00\u4e0b\u6587\u4ef6\u4e2dvolumemount\u4e2d\u4f7f\u7528\u7684configmap\u540d\u79f0\uff0c\u53c2\u89c1https://github.com/feiyu563/PrometheusAlert/issues(2021-01-26)</p> <p>\u4fee\u6539\u540e\u6587\u4ef6\u5982\u4e0b</p> <pre><code># apiVersion: v1\n# kind: Namespace\n# metadata:\n#   name: monitoring\n---  \napiVersion: v1\ndata:\n  app.conf: |\n    #---------------------\u2193\u5168\u5c40\u914d\u7f6e-----------------------\n    appname = PrometheusAlert\n    #\u76d1\u542c\u7aef\u53e3\n    httpport = 8080\n    runmode = dev\n    #\u8bbe\u7f6e\u4ee3\u7406 proxy = http://123.123.123.123:8080\n    proxy =\n    #\u5f00\u542fJSON\u8bf7\u6c42\n    copyrequestbody = true\n    #\u544a\u8b66\u6d88\u606f\u6807\u9898\n    title=PrometheusAlert\n    #\u94fe\u63a5\u5230\u544a\u8b66\u5e73\u53f0\u5730\u5740\n    GraylogAlerturl=http://graylog.org\n    #\u9489\u9489\u544a\u8b66 \u544a\u8b66logo\u56fe\u6807\u5730\u5740\n    logourl=https://raw.githubusercontent.com/feiyu563/PrometheusAlert/master/doc/alert-center.png\n    #\u9489\u9489\u544a\u8b66 \u6062\u590dlogo\u56fe\u6807\u5730\u5740\n    rlogourl=https://raw.githubusercontent.com/feiyu563/PrometheusAlert/master/doc/alert-center.png\n    #\u77ed\u4fe1\u544a\u8b66\u7ea7\u522b(\u7b49\u4e8e3\u5c31\u8fdb\u884c\u77ed\u4fe1\u544a\u8b66) \u544a\u8b66\u7ea7\u522b\u5b9a\u4e49 0 \u4fe1\u606f,1 \u8b66\u544a,2 \u4e00\u822c\u4e25\u91cd,3 \u4e25\u91cd,4 \u707e\u96be\n    messagelevel=3\n    #\u7535\u8bdd\u544a\u8b66\u7ea7\u522b(\u7b49\u4e8e4\u5c31\u8fdb\u884c\u8bed\u97f3\u544a\u8b66) \u544a\u8b66\u7ea7\u522b\u5b9a\u4e49 0 \u4fe1\u606f,1 \u8b66\u544a,2 \u4e00\u822c\u4e25\u91cd,3 \u4e25\u91cd,4 \u707e\u96be\n    phonecalllevel=4\n    #\u9ed8\u8ba4\u62e8\u6253\u53f7\u7801(\u9875\u9762\u6d4b\u8bd5\u77ed\u4fe1\u548c\u7535\u8bdd\u529f\u80fd\u9700\u8981\u914d\u7f6e\u6b64\u9879)\n    defaultphone=xxxxxxxx\n    #\u6545\u969c\u6062\u590d\u662f\u5426\u542f\u7528\u7535\u8bdd\u901a\u77e50\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    phonecallresolved=0\n    #\u81ea\u52a8\u544a\u8b66\u6291\u5236(\u81ea\u52a8\u544a\u8b66\u6291\u5236\u662f\u9ed8\u8ba4\u540c\u4e00\u4e2a\u544a\u8b66\u6e90\u7684\u544a\u8b66\u4fe1\u606f\u53ea\u53d1\u9001\u544a\u8b66\u7ea7\u522b\u6700\u9ad8\u7684\u7b2c\u4e00\u6761\u544a\u8b66\u4fe1\u606f,\u5176\u4ed6\u6d88\u606f\u9ed8\u8ba4\u5c4f\u853d,\u8fd9\u4e48\u505a\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u51cf\u5c11\u76f8\u540c\u544a\u8b66\u6765\u6e90\u7684\u6d88\u606f\u6570\u91cf,\u9632\u6b62\u544a\u8b66\u70b8\u5f39,0\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f)\n    silent=0\n    #\u662f\u5426\u524d\u53f0\u8f93\u51fafile or console\n    logtype=file\n    #\u65e5\u5fd7\u6587\u4ef6\u8def\u5f84\n    logpath=logs/prometheusalertcenter.log\n    #\u8f6c\u6362Prometheus,graylog\u544a\u8b66\u6d88\u606f\u7684\u65f6\u533a\u4e3aCST\u65f6\u533a(\u5982\u9ed8\u8ba4\u5df2\u7ecf\u662fCST\u65f6\u533a\uff0c\u8bf7\u52ff\u5f00\u542f)\n    prometheus_cst_time=0\n    #\u6570\u636e\u5e93\u9a71\u52a8\uff0c\u652f\u6301sqlite3\uff0cmysql,\u5982\u4f7f\u7528mysql\uff0c\u8bf7\u5f00\u542fdb_host,db_user,db_password,db_name\u7684\u6ce8\u91ca\n    db_driver=sqlite3\n    #db_host=127.0.0.1:3306\n    #db_user=root\n    #db_password=root\n    #db_name=prometheusalert\n\n    #---------------------\u2193webhook-----------------------\n    #\u662f\u5426\u5f00\u542f\u9489\u9489\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-dingding=1\n    #\u9ed8\u8ba4\u9489\u9489\u673a\u5668\u4eba\u5730\u5740\n    ddurl=https://oapi.dingtalk.com/robot/send?access_token=xxxxx\n    #\u662f\u5426\u5f00\u542f @\u6240\u6709\u4eba(0\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f)\n    dd_isatall=1\n\n    #\u662f\u5426\u5f00\u542f\u5fae\u4fe1\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-weixin=0\n    #\u9ed8\u8ba4\u4f01\u4e1a\u5fae\u4fe1\u673a\u5668\u4eba\u5730\u5740\n    wxurl=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx\n\n    #\u662f\u5426\u5f00\u542f\u98de\u4e66\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-feishu=0\n    #\u9ed8\u8ba4\u98de\u4e66\u673a\u5668\u4eba\u5730\u5740\n    fsurl=https://open.feishu.cn/open-apis/bot/hook/xxxxxxxxx\n\n    #---------------------\u2193\u817e\u8baf\u4e91\u63a5\u53e3-----------------------\n    #\u662f\u5426\u5f00\u542f\u817e\u8baf\u4e91\u77ed\u4fe1\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-txdx=0\n    #\u817e\u8baf\u4e91\u77ed\u4fe1\u63a5\u53e3key\n    TXY_DX_appkey=xxxxx\n    #\u817e\u8baf\u4e91\u77ed\u4fe1\u6a21\u7248ID \u817e\u8baf\u4e91\u77ed\u4fe1\u6a21\u7248\u914d\u7f6e\u53ef\u53c2\u8003 prometheus\u544a\u8b66:{1}\n    TXY_DX_tpl_id=xxxxx\n    #\u817e\u8baf\u4e91\u77ed\u4fe1sdk app id\n    TXY_DX_sdkappid=xxxxx\n    #\u817e\u8baf\u4e91\u77ed\u4fe1\u7b7e\u540d \u6839\u636e\u81ea\u5df1\u5ba1\u6838\u901a\u8fc7\u7684\u7b7e\u540d\u6765\u586b\u5199\n    TXY_DX_sign=\u817e\u8baf\u4e91\n\n    #\u662f\u5426\u5f00\u542f\u817e\u8baf\u4e91\u7535\u8bdd\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-txdh=0\n    #\u817e\u8baf\u4e91\u7535\u8bdd\u63a5\u53e3key\n    TXY_DH_phonecallappkey=xxxxx\n    #\u817e\u8baf\u4e91\u7535\u8bdd\u6a21\u7248ID\n    TXY_DH_phonecalltpl_id=xxxxx\n    #\u817e\u8baf\u4e91\u7535\u8bddsdk app id\n    TXY_DH_phonecallsdkappid=xxxxx\n\n    #---------------------\u2193\u534e\u4e3a\u4e91\u63a5\u53e3-----------------------\n    #\u662f\u5426\u5f00\u542f\u534e\u4e3a\u4e91\u77ed\u4fe1\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-hwdx=0\n    #\u534e\u4e3a\u4e91\u77ed\u4fe1\u63a5\u53e3key\n    HWY_DX_APP_Key=xxxxxxxxxxxxxxxxxxxxxx\n    #\u534e\u4e3a\u4e91\u77ed\u4fe1\u63a5\u53e3Secret\n    HWY_DX_APP_Secret=xxxxxxxxxxxxxxxxxxxxxx\n    #\u534e\u4e3a\u4e91APP\u63a5\u5165\u5730\u5740(\u7aef\u53e3\u63a5\u53e3\u5730\u5740)\n    HWY_DX_APP_Url=https://rtcsms.cn-north-1.myhuaweicloud.com:10743\n    #\u534e\u4e3a\u4e91\u77ed\u4fe1\u6a21\u677fID\n    HWY_DX_Templateid=xxxxxxxxxxxxxxxxxxxxxx\n    #\u534e\u4e3a\u4e91\u7b7e\u540d\u540d\u79f0\uff0c\u5fc5\u987b\u662f\u5df2\u5ba1\u6838\u901a\u8fc7\u7684\uff0c\u4e0e\u6a21\u677f\u7c7b\u578b\u4e00\u81f4\u7684\u7b7e\u540d\u540d\u79f0,\u6309\u7167\u81ea\u5df1\u7684\u5b9e\u9645\u7b7e\u540d\u586b\u5199\n    HWY_DX_Signature=\u534e\u4e3a\u4e91\n    #\u534e\u4e3a\u4e91\u7b7e\u540d\u901a\u9053\u53f7\n    HWY_DX_Sender=xxxxxxxxxx\n\n    #---------------------\u2193\u963f\u91cc\u4e91\u63a5\u53e3-----------------------\n    #\u662f\u5426\u5f00\u542f\u963f\u91cc\u4e91\u77ed\u4fe1\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-alydx=0\n    #\u963f\u91cc\u4e91\u77ed\u4fe1\u4e3b\u8d26\u53f7AccessKey\u7684ID\n    ALY_DX_AccessKeyId=xxxxxxxxxxxxxxxxxxxxxx\n    #\u963f\u91cc\u4e91\u77ed\u4fe1\u63a5\u53e3\u5bc6\u94a5\n    ALY_DX_AccessSecret=xxxxxxxxxxxxxxxxxxxxxx\n    #\u963f\u91cc\u4e91\u77ed\u4fe1\u7b7e\u540d\u540d\u79f0\n    ALY_DX_SignName=\u963f\u91cc\u4e91\n    #\u963f\u91cc\u4e91\u77ed\u4fe1\u6a21\u677fID\n    ALY_DX_Template=xxxxxxxxxxxxxxxxxxxxxx\n\n    #\u662f\u5426\u5f00\u542f\u963f\u91cc\u4e91\u7535\u8bdd\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-alydh=0\n    #\u963f\u91cc\u4e91\u7535\u8bdd\u4e3b\u8d26\u53f7AccessKey\u7684ID\n    ALY_DH_AccessKeyId=xxxxxxxxxxxxxxxxxxxxxx\n    #\u963f\u91cc\u4e91\u7535\u8bdd\u63a5\u53e3\u5bc6\u94a5\n    ALY_DH_AccessSecret=xxxxxxxxxxxxxxxxxxxxxx\n    #\u963f\u91cc\u4e91\u7535\u8bdd\u88ab\u53eb\u663e\u53f7\uff0c\u5fc5\u987b\u662f\u5df2\u8d2d\u4e70\u7684\u53f7\u7801\n    ALY_DX_CalledShowNumber=xxxxxxxxx\n    #\u963f\u91cc\u4e91\u7535\u8bdd\u6587\u672c\u8f6c\u8bed\u97f3\uff08TTS\uff09\u6a21\u677fID\n    ALY_DH_TtsCode=xxxxxxxx\n\n    #---------------------\u2193\u5bb9\u8054\u4e91\u63a5\u53e3-----------------------\n    #\u662f\u5426\u5f00\u542f\u5bb9\u8054\u4e91\u7535\u8bdd\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    RLY_DH_open-rlydh=0\n    #\u5bb9\u8054\u4e91\u57fa\u7840\u63a5\u53e3\u5730\u5740\n    RLY_URL=https://app.cloopen.com:8883/2013-12-26/Accounts/\n    #\u5bb9\u8054\u4e91\u540e\u53f0SID\n    RLY_ACCOUNT_SID=xxxxxxxxxxx\n    #\u5bb9\u8054\u4e91api-token\n    RLY_ACCOUNT_TOKEN=xxxxxxxxxx\n    #\u5bb9\u8054\u4e91app_id\n    RLY_APP_ID=xxxxxxxxxxxxx\n\n    #---------------------\u2193\u90ae\u4ef6\u914d\u7f6e-----------------------\n    #\u662f\u5426\u5f00\u542f\u90ae\u4ef6\n    open-email=0\n    #\u90ae\u4ef6\u53d1\u4ef6\u670d\u52a1\u5668\u5730\u5740\n    Email_host=smtp.qq.com\n    #\u90ae\u4ef6\u53d1\u4ef6\u670d\u52a1\u5668\u7aef\u53e3\n    Email_port=465\n    #\u90ae\u4ef6\u5e10\u53f7\n    Email_user=xxxxxxx@qq.com\n    #\u90ae\u4ef6\u5bc6\u7801\n    Email_password=xxxxxx\n    #\u90ae\u4ef6\u6807\u9898\n    Email_title=\u8fd0\u7ef4\u544a\u8b66\n    #\u9ed8\u8ba4\u53d1\u9001\u90ae\u7bb1\n    Default_emails=xxxxx@qq.com,xxxxx@qq.com\n\n    #---------------------\u2193\u4e03\u964c\u4e91\u63a5\u53e3-----------------------\n    #\u662f\u5426\u5f00\u542f\u4e03\u964c\u77ed\u4fe1\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-7moordx=0\n    #\u4e03\u964c\u8d26\u6237ID\n    7MOOR_ACCOUNT_ID=Nxxx\n    #\u4e03\u964c\u8d26\u6237APISecret\n    7MOOR_ACCOUNT_APISECRET=xxx\n    #\u4e03\u964c\u8d26\u6237\u77ed\u4fe1\u6a21\u677f\u7f16\u53f7\n    7MOOR_DX_TEMPLATENUM=n\n    #\u6ce8\u610f\uff1a\u4e03\u964c\u77ed\u4fe1\u53d8\u91cf\u8fd9\u91cc\u53ea\u7528\u4e00\u4e2avar1\uff0c\u5728\u4ee3\u7801\u91cc\u5199\u6b7b\u4e86\u3002\n    #-----------\n    #\u662f\u5426\u5f00\u542f\u4e03\u964cwebcall\u8bed\u97f3\u901a\u77e5\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-7moordh=0\n    #\u8bf7\u5728\u4e03\u964c\u5e73\u53f0\u6dfb\u52a0\u865a\u62df\u670d\u52a1\u53f7\u3001\u6587\u672c\u8282\u70b9\n    #\u4e03\u964c\u8d26\u6237webcall\u7684\u865a\u62df\u670d\u52a1\u53f7\n    7MOOR_WEBCALL_SERVICENO=xxx\n    # \u6587\u672c\u8282\u70b9\u91cc\u88ab\u66ff\u6362\u7684\u53d8\u91cf\uff0c\u6211\u914d\u7f6e\u7684\u662ftext\u3002\u5982\u679c\u88ab\u66ff\u6362\u7684\u53d8\u91cf\u4e0d\u662ftext\uff0c\u8bf7\u4fee\u6539\u6b64\u914d\u7f6e\n    7MOOR_WEBCALL_VOICE_VAR=text\n\n    #---------------------\u2193telegram\u63a5\u53e3-----------------------\n    #\u662f\u5426\u5f00\u542ftelegram\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-tg=0\n    #tg\u673a\u5668\u4ebatoken\n    TG_TOKEN=xxxxx\n    #tg\u6d88\u606f\u6a21\u5f0f \u4e2a\u4eba\u6d88\u606f\u6216\u8005\u9891\u9053\u6d88\u606f 0\u4e3a\u5173\u95ed(\u63a8\u9001\u7ed9\u4e2a\u4eba)\uff0c1\u4e3a\u5f00\u542f(\u63a8\u9001\u7ed9\u9891\u9053)\n    TG_MODE_CHAN=0\n    #tg\u7528\u6237ID\n    TG_USERID=xxxxx\n    #tg\u9891\u9053name\n    TG_CHANNAME=xxxxx\n    #tg api\u5730\u5740, \u53ef\u4ee5\u914d\u7f6e\u4e3a\u4ee3\u7406\u5730\u5740\n    #TG_API_PROXY=\"https://api.telegram.org/bot%s/%s\"\n\n    #---------------------\u2193workwechat\u63a5\u53e3-----------------------\n    #\u662f\u5426\u5f00\u542fworkwechat\u544a\u8b66\u901a\u9053,\u53ef\u540c\u65f6\u5f00\u59cb\u591a\u4e2a\u901a\u90530\u4e3a\u5173\u95ed,1\u4e3a\u5f00\u542f\n    open-workwechat=0\n    # \u4f01\u4e1aID\n    WorkWechat_CropID=xxxxx\n    # \u5e94\u7528ID\n    WorkWechat_AgentID=xxxx\n    # \u5e94\u7528secret\n    WorkWechat_AgentSecret=xxxx\n    # \u63a5\u53d7\u7528\u6237\n    WorkWechat_ToUser=\"zhangsan|lisi\"\n    # \u63a5\u53d7\u90e8\u95e8\n    WorkWechat_ToParty=\"ops|dev\"\n    # \u63a5\u53d7\u6807\u7b7e\n    WorkWechat_ToTag=\"\"\n    # \u6d88\u606f\u7c7b\u578b, \u6682\u65f6\u53ea\u652f\u6301markdown\n    # WorkWechat_Msgtype = \"markdown\"\n  user.csv: |\n    2019\u5e744\u670810\u65e5,15888888881,\u5c0f\u5f20,15999999999,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u9648,15999999998,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u8d75\n    2019\u5e744\u670811\u65e5,15888888882,\u5c0f\u674e,15999999999,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u9648,15999999998,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u8d75\n    2019\u5e744\u670812\u65e5,15888888883,\u5c0f\u738b,15999999999,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u9648,15999999998,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u8d75\n    2019\u5e744\u670813\u65e5,15888888884,\u5c0f\u5b8b,15999999999,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u9648,15999999998,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u8d75\nkind: ConfigMap\nmetadata:\n  name: prometheus-alert-center-conf\n  namespace: monitoring\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: prometheus-alert-center\n    alertname: prometheus-alert-center\n  name: prometheus-alert-center\n#   namespace: monitoring  \nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: prometheus-alert-center\n      alertname: prometheus-alert-center\n  template:\n    metadata:\n      labels:\n        app: prometheus-alert-center\n        alertname: prometheus-alert-center\n    spec:\n      containers:\n      - image: feiyu563/prometheus-alert\n        name: prometheus-alert-center\n        env:\n        - name: TZ\n          value: \"Asia/Shanghai\"\n        ports:\n        - containerPort: 8080\n          name: http\n        resources:\n          limits:\n            cpu: 200m\n            memory: 200Mi\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        volumeMounts:\n        - name: prometheus-alert-center-conf-map\n          mountPath: /app/conf/app.conf\n          subPath: app.conf\n        - name: prometheus-alert-center-conf-map\n          mountPath: /app/user.csv\n          subPath: user.csv\n      volumes:\n      - name: prometheus-alert-center-conf-map\n        configMap:\n          name: prometheus-alert-center-conf\n          items:\n          - key: app.conf\n            path: app.conf\n          - key: user.csv\n            path: user.csv\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    alertname: prometheus-alert-center\n  name: prometheus-alert-center\n#   namespace: monitoring  \n  annotations:\n    prometheus.io/scrape: 'true'\n    prometheus.io/port: '8080'  \nspec:\n  ports:\n  - name: http\n    port: 8080\n    targetPort: http\n  selector:\n    app: prometheus-alert-center\n---\n# apiVersion: networking.k8s.io/v1beta1\n# kind: Ingress\n# metadata:\n#   annotations:\n#     kubernetes.io/ingress.class: nginx\n#   name: prometheus-alert-center\n#   namespace: monitoring\n# spec:\n#   rules:\n#     - host: alert-center.local\n#       http:\n#         paths:\n#           - backend:\n#               serviceName: prometheus-alert-center\n#               servicePort: 8080\n#             path: / \n</code></pre> <p>\u6587\u4ef6\u4e2d\u7684\u6ce8\u91ca\u5f88\u8be6\u7ec6\uff0c</p> <ul> <li>\u8fd9\u91cc\u9700\u8981\u989d\u5916\u8bf4\u4e00\u4e0b<code>PrometheusAlert</code> \u540c\u65f6\u652f\u6301\u6309\u7167\u65e5\u671f\u53d1\u9001\u544a\u8b66\u5230\u4e0d\u540c\u53f7\u7801,</li> <li>\u5e76\u4e14\u5df2\u7ecf\u52a0\u5165\u544a\u8b66\u5931\u8d25\u6216\u8005\u88ab\u544a\u8b66\u4eba\u672a\u63a5\u542c\u7535\u8bdd\u540e\u8f6c\u8054\u7cfb\u9ed8\u8ba4\u8054\u7cfb\u4eba<code>defaultphone</code> \u53ea\u9700\u65b0\u5efa<code>ser.csv</code>\u6587\u4ef6,</li> <li>\u5e76\u5c06\u6587\u4ef6\u653e\u5230\u7a0b\u5e8f\u8fd0\u884c\u76ee\u5f55\u4e0b\u5373\u53ef\u81ea\u52a8\u52a0\u8f7d </li> <li>\u540c\u65f6\u8be5\u6587\u4ef6\u4e5f\u662f\u7535\u8bdd\u56de\u8c03\u63a5\u53e3\u6240\u5fc5\u9700\u6587\u4ef6(\u5982\u56de\u8c03\u63a5\u53e3\u8fd4\u56de\u975e0\u72b6\u6001,\u5219\u4f1a\u5728\u6b64\u6587\u4ef6\u4e2d\u5bfb\u627e\u4e0b\u4e00\u53f7\u7801\u8fdb\u884c\u62e8\u6253,\u5982\u5f00\u542f\u56de\u8c03\u529f\u80fd,\u8bf7\u52a1\u5fc5\u521b\u5efa\u8be5\u6587\u4ef6) </li> <li>ps:\u76ee\u524d<code>grafana/graylog</code>\u7684\u7535\u8bdd\u548c\u77ed\u4fe1\u544a\u8b66\u4f9d\u8d56\u4e8e\u8be5\u6587\u4ef6,</li> <li>prometheus\u7535\u8bdd\u548c\u77ed\u4fe1\u544a\u8b66\u4f18\u5148\u4ecerules\u7684mobile\u5b57\u6bb5\u8bfb\u53d6,\u5982\u672a\u914d\u7f6e\u53f7\u7801,\u5219\u4f1a\u4ece<code>user.csv</code>\u4e2d\u8bfb\u53d6,\u5982<code>user.csv</code>\u4e2d\u4e5f\u672a\u914d\u7f6e,\u5219\u4f1a\u76f4\u63a5\u53d1\u9001\u5230<code>defaultphone</code></li> </ul> <p>\u5173\u4e8euser.csv\u4e2d\u503c\u73ed\u65f6\u95f4\u5207\u6362\u95ee\u9898,\u9ed8\u8ba4\u6bcf\u65e5\u4e0a\u534810\u70b9\u8fdb\u884c\u5207\u6362\uff0c</p> <pre><code>2019\u5e744\u670810\u65e5,15888888881,\u5c0f\u5f20,15999999999,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u9648,15999999998,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u8d75\n2019\u5e744\u670811\u65e5,15888888882,\u5c0f\u674e,15999999999,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u9648,15999999998,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u8d75\n2019\u5e744\u670812\u65e5,15888888883,\u5c0f\u738b,15999999999,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u9648,15999999998,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u8d75\n2019\u5e744\u670813\u65e5,15888888884,\u5c0f\u5b8b,15999999999,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u9648,15999999998,\u5907\u7528\u8054\u7cfb\u4eba\u5c0f\u8d75\n</code></pre> <p>\u6211\u4eec\u5148\u9700\u8981\u4fee\u6539\u4e00\u4e0bconfigmap\u4e2d\u7684\u62a5\u8b66\u5a92\u4ecb\u5730\u5740,\u7136\u540e\u6267\u884c<code>kubectl apply -f deployment.yaml</code></p>"},{"location":"chap3/50PrometheusAlert/#1-prometheus","title":"1 prometheus\u914d\u7f6e","text":"<p>Prometheus\u652f\u6301\u4e24\u79cd\u914d\u7f6e\uff0c\u4efb\u9009\u5176\u4e00\u6216\u8005\u4e24\u8005\u642d\u914d\u5747\u53ef\u3002</p>"},{"location":"chap3/50PrometheusAlert/#1-1-prometheus-rules","title":"1-1 \u901a\u8fc7Prometheus Rules\u65b9\u5f0f","text":"<p>\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u4f1a\u4f7f\u7528\u62a5\u8b66\u89c4\u5219\u4e2d\u5b9a\u4e49\u7684\u4e00\u4e9b\u62a5\u8b66\u5a92\u4ecb\u7684\u4fe1\u606f\u3002</p> <p>\u9996\u5148\u9700\u8981\u5728Alertmanager\u914d\u7f6eWebhook\uff0c\u53ef\u53c2\u8003\u5982\u4e0b\u6a21\u677f\uff1a</p> <pre><code>global:\n  resolve_timeout: 5m\nroute:\n  group_by: ['instance']\n  group_wait: 10m\n  group_interval: 10s\n  repeat_interval: 10m\n  receiver: 'web.hook.prometheusalert'\nreceivers:\n- name: 'web.hook.prometheusalert'\n  webhook_configs:\n  - url: 'http://prometheus-alert-center:8080/prometheus/alert'\n    send_resolved: true\n</code></pre> <p>Prometheus Server \u7684\u544a\u8b66rules\u914d\u7f6e\uff0c\u53ef\u53c2\u8003\u5982\u4e0b\u6a21\u677f\uff1a</p> <pre><code>groups:\n- name: node_alert\n  rules:\n  - alert: \u4e3b\u673aCPU\u544a\u8b66\n    expr: node_load1 &gt; 1\n    labels:\n      name: prometheusalertcenter\n      level: 3   #\u544a\u8b66\u7ea7\u522b,\u544a\u8b66\u7ea7\u522b\u5b9a\u4e49 0 \u4fe1\u606f,1 \u8b66\u544a,2 \u4e00\u822c\u4e25\u91cd,3 \u4e25\u91cd,4 \u707e\u96be\n    annotations:\n      description: \"{{ $labels.instance }} CPU load\u5360\u7528\u8fc7\u9ad8\"  #\u544a\u8b66\u4fe1\u606f\n      mobile: 15888888881,15888888882,15888888883  #\u544a\u8b66\u53d1\u9001\u76ee\u6807\u624b\u673a\u53f7(\u9700\u8981\u8bbe\u7f6e\u7535\u8bdd\u548c\u77ed\u4fe1\u544a\u8b66\u7ea7\u522b)\n      ddurl: \"https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx,https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\" #\u652f\u6301\u6dfb\u52a0\u591a\u4e2a\u9489\u9489\u673a\u5668\u4eba\u544a\u8b66,\u7528,\u53f7\u5206\u5272\u5373\u53ef,\u5982\u679c\u7559\u7a7a\u6216\u8005\u672a\u586b\u5199,\u5219\u9ed8\u8ba4\u53d1\u9001\u5230\u914d\u7f6e\u6587\u4ef6\u4e2d\u586b\u5199\u7684\u9489\u9489\u5668\u4eba\u5730\u5740\n      fsurl: \"https://open.feishu.cn/open-apis/bot/hook/xxxxxxxxx,https://open.feishu.cn/open-apis/bot/hook/xxxxxxxxx\" #\u652f\u6301\u6dfb\u52a0\u591a\u4e2a\u98de\u4e66\u673a\u5668\u4eba\u544a\u8b66,\u7528,\u53f7\u5206\u5272\u5373\u53ef,\u5982\u679c\u7559\u7a7a\u6216\u8005\u672a\u586b\u5199,\u5219\u9ed8\u8ba4\u53d1\u9001\u5230\u914d\u7f6e\u6587\u4ef6\u4e2d\u586b\u5199\u7684\u98de\u4e66\u5668\u4eba\u5730\u5740\n      wxurl: \"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxxxxx-xxxxxx-xxxxxx-xxxxxx,https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx-xxxx-xxxxxxx-xxxxx\" #\u652f\u6301\u6dfb\u52a0\u591a\u4e2a\u4f01\u4e1a\u5fae\u4fe1\u673a\u5668\u4eba\u544a\u8b66,\u7528,\u53f7\u5206\u5272\u5373\u53ef,\u5982\u679c\u7559\u7a7a\u6216\u8005\u672a\u586b\u5199,\u5219\u9ed8\u8ba4\u53d1\u9001\u5230\u914d\u7f6e\u6587\u4ef6\u4e2d\u586b\u5199\u7684\u4f01\u4e1a\u5fae\u4fe1\u673a\u5668\u4eba\u5730\u5740\n</code></pre>"},{"location":"chap3/50PrometheusAlert/#1-2-prometheus-alertmanager-router","title":"1-2 \u901a\u8fc7Prometheus AlertManager router\u65b9\u5f0f","text":"<p>\u9488\u5bf9 <code>/prometheus/router AlertManager router</code>\u6307\u5b9a\u63a5\u6536\u7aef\u63a5\u53e3,\u8be5\u63a5\u53e3\u53ef\u5728url\u4e2d\u76f4\u63a5\u6307\u5b9a\u544a\u8b66\u7684\u63a5\u6536\u7aef,\u76ee\u524d\u652f\u6301\u4e09\u4e2a\u53c2\u6570,\u5206\u522b\u662f:wxurl,ddurl,phone(phone\u7528\u4e8e\u77ed\u4fe1\u548c\u7535\u8bdd\u544a\u8b66)</p> <p>\u5728 Prometheus Alertmanager \u4e2d\u914d\u7f6eWebhook\uff0c\u53ef\u53c2\u8003\u5982\u4e0b\u6a21\u677f\uff1a</p> <pre><code>global:\n  resolve_timeout: 5m\nroute:\n  group_by: ['instance']\n  group_wait: 10m\n  group_interval: 10s\n  repeat_interval: 10m\n  receiver: 'web.hook.prometheusalert'\n  routes:\n  - receiver: 'prometheusalert-weixin'\n    group_wait: 10s\n    match:\n      level: '1'\n  - receiver: 'prometheusalert-dingding'\n    group_wait: 10s\n    match:\n      level: '2'\n  - receiver: 'prometheusalert-feishu'\n    group_wait: 10s\n    match:\n      level: '3'\n  - receiver: 'prometheusalert-all'\n    group_wait: 10s\n    match:\n      level: '4'\nreceivers:\n- name: 'web.hook.prometheusalert'\n  webhook_configs:\n  - url: 'http://[prometheusalert_url]:8080/prometheus/alert'\n- name: 'prometheusalert-weixin'\n  webhook_configs:\n  - url: 'http://[prometheusalert_url]:8080/prometheus/router?wxurl=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx'\n- name: 'prometheusalert-dingding'\n  webhook_configs:\n  - url: 'http://[prometheusalert_url]:8080/prometheus/router?ddurl=https://oapi.dingtalk.com/robot/send?access_token=xxxxx'\n- name: 'prometheusalert-feishu'\n  webhook_configs:\n  - url: 'http://[prometheusalert_url]:8080/prometheus/router?fsurl=https://open.feishu.cn/open-apis/bot/hook/xxxxxxxxx'\n- name: 'prometheusalert-all'\n  webhook_configs:\n  - url: 'http://[prometheusalert_url]:8080/prometheus/router?wxurl=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx&amp;ddurl=https://oapi.dingtalk.com/robot/send?access_token=xxxxx&amp;phone=15395105573'\n</code></pre> <p>\u6700\u7ec8\u544a\u8b66\u6548\u679c:</p> <p></p>"},{"location":"chap3/50PrometheusAlert/#2-dashboard","title":"2 \u4f7f\u7528dashboard\u8fdb\u884c\u8c03\u8bd5","text":"<p>depoyment.yaml\u6587\u4ef6\u4e2d\u9ed8\u8ba4\u6ce8\u91ca\u4e86ingress\u76f8\u5173\u8d44\u6e90\uff0c\u6211\u4eec\u9700\u8981\u8c03\u8bd5\u53ef\u4ee5\u53d6\u6d88\u6ce8\u91ca\u4f7f\u7528\u3002</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb\u4e0a\u56fe\u7684test\u5207\u6362\u5230\u6d4b\u8bd5\u9875\u9762\uff0c\u7136\u540e\u70b9\u51fb\u544a\u8b66\u6d4b\u8bd5\u5373\u53ef\u6d4b\u8bd5\u6211\u4eec\u914d\u7f6e\u7684\u62a5\u8b66\u5a92\u4ecb\u662f\u5426\u80fd\u6b63\u5e38\u53d1\u9001\u544a\u8b66\u6d88\u606f\u3002</p> <p></p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u6536\u5230\u5982\u4e0b\u7684\u544a\u8b66\u6d4b\u8bd5\u6d88\u606f</p> <p></p>"},{"location":"chap3/5Adv_Prometheus_monitor/","title":"\u7b2c\u4e94\u8282 \u5e94\u7528\u76d1\u63a7\uff08Metrics/Exporter\u7684\u914d\u7f6e\uff09","text":"<p><code>Prometheus</code> \u7684\u6570\u636e\u6307\u6807\u662f\u901a\u8fc7\u4e00\u4e2a\u516c\u5f00\u7684 <code>HTTP(S)</code> \u6570\u636e\u63a5\u53e3\u83b7\u53d6\u5230\u7684\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u5355\u72ec\u5b89\u88c5\u76d1\u63a7\u7684 <code>agent</code>\uff0c\u53ea\u9700\u8981\u66b4\u9732\u4e00\u4e2a <code>metrics \u63a5\u53e3</code>\uff0c<code>Prometheus</code> \u5c31\u4f1a\u5b9a\u671f\u53bb\u62c9\u53d6\u6570\u636e\uff1b</p> <p>\u5bf9\u4e8e\u4e00\u4e9b\u666e\u901a\u7684 <code>HTTP</code> \u670d\u52a1\uff0c\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u76f4\u63a5\u91cd\u7528\u8fd9\u4e2a\u670d\u52a1\uff0c\u6dfb\u52a0\u4e00\u4e2a<code>/metrics</code>\u63a5\u53e3\u66b4\u9732\u7ed9 <code>Prometheus</code>\uff1b\u800c\u4e14\u83b7\u53d6\u5230\u7684\u6307\u6807\u6570\u636e\u683c\u5f0f\u662f\u975e\u5e38\u6613\u61c2\u7684\uff0c\u4e0d\u9700\u8981\u592a\u9ad8\u7684\u5b66\u4e60\u6210\u672c\u3002</p> <p>\u73b0\u5728\u5f88\u591a\u670d\u52a1\u4ece\u4e00\u5f00\u59cb\u5c31\u5185\u7f6e\u4e86\u4e00\u4e2a<code>/metrics</code>\u63a5\u53e3\uff0c\u6bd4\u5982 <code>Kubernetes</code> \u7684\u5404\u4e2a\u7ec4\u4ef6\u3001<code>istio</code> \u670d\u52a1\u7f51\u683c\u90fd\u76f4\u63a5\u63d0\u4f9b\u4e86\u6570\u636e\u6307\u6807\u63a5\u53e3\u3002</p> <p>\u6709\u4e00\u4e9b\u670d\u52a1\u5373\u4f7f\u6ca1\u6709\u539f\u751f\u96c6\u6210\u8be5\u63a5\u53e3\uff0c\u4e5f\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b <code>exporter</code> \u6765\u83b7\u53d6\u5230\u6307\u6807\u6570\u636e\uff0c\u6bd4\u5982 <code>mysqld_exporter</code>\u3001<code>node_exporter</code>\uff0c\u8fd9\u4e9b <code>exporter</code> \u5c31\u6709\u70b9\u7c7b\u4f3c\u4e8e\u4f20\u7edf\u76d1\u63a7\u670d\u52a1\u4e2d\u7684 <code>agent</code>\uff0c\u4f5c\u4e3a\u4e00\u76f4\u670d\u52a1\u5b58\u5728\uff0c\u7528\u6765\u6536\u96c6\u76ee\u6807\u670d\u52a1\u7684\u6307\u6807\u6570\u636e\u7136\u540e\u76f4\u63a5\u66b4\u9732\u7ed9 <code>Prometheus</code>\u3002</p>"},{"location":"chap3/5Adv_Prometheus_monitor/#1","title":"1 \u666e\u901a\u5e94\u7528\u76d1\u63a7","text":"<p>\u6211\u4eec\u91c7\u7528\u7684\u662f<code>Traefik</code> \u4f5c\u4e3a\u6211\u4eec\u7684 <code>ingress-controller</code>\uff0c\u662f\u6211\u4eec <code>Kubernetes</code> \u96c6\u7fa4\u5185\u90e8\u670d\u52a1\u548c\u5916\u90e8\u7528\u6237\u4e4b\u95f4\u7684\u6865\u6881\u3002<code>Traefik</code> \u672c\u8eab\u5185\u7f6e\u4e86\u4e00\u4e2a<code>/metrics</code>\u7684\u63a5\u53e3\uff0c\u4f46\u662f\u9700\u8981\u6211\u4eec\u5728\u53c2\u6570\u4e2d\u914d\u7f6e\u5f00\u542f:</p> <pre><code>[metrics]\n  [metrics.prometheus]\n    entryPoint = \"traefik\"\n    buckets = [0.1, 0.3, 1.2, 5.0]\n</code></pre>"},{"location":"chap3/5Adv_Prometheus_monitor/#1-1-traefiktoml","title":"1-1 traefik.toml","text":"<pre><code>defaultEntryPoints = [\"http\", \"https\"]\n\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n    [entryPoints.http.redirect]\n      entryPoint = \"https\"\n  [entryPoints.https]\n  address = \":443\"\n    [entryPoints.https.tls]\n      [[entryPoints.https.tls.certificates]]\n      CertFile = \"/ssl/tls.crt\"\n      KeyFile = \"/ssl/tls.key\"\n[metrics]\n  [metrics.prometheus]\n    entryPoint = \"traefik\"\n    buckets = [0.1, 0.3, 1.2, 5.0]\n</code></pre> <p>\u6211\u4eec\u9700\u8981\u5728<code>traefik.toml</code>\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e0a\u4e0a\u9762\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u7136\u540e\u66f4\u65b0 <code>ConfigMap</code> \u548c <code>Pod</code> \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff0c</p> <pre><code>$ kubectl delete configmap traefik-conf -n kube-system\nconfigmap \"traefik-conf\" deleted\n\n$ kubectl create configmap traefik-conf --from-file=traefik.toml -n kube-system\nconfigmap \"traefik-conf\" created\n\n$ kubectl apply -f traefik.yaml\n</code></pre> <ul> <li><code>--from-file=traefik.toml</code></li> </ul> <p><code>Traefik Pod</code> \u8fd0\u884c\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u7684\u670d\u52a1 <code>IP</code></p> <pre><code>$ kubectl get svc -n kube-system\nNAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                       AGE\ntraefik-ingress-service   NodePort    10.254.141.152   &lt;none&gt;        80:32221/TCP,8080:32440/TCP   1m\n</code></pre> <pre><code>$ kubectl get pods -n kube-system -l k8s-app=traefik-ingress-lb -o wide\nNAME                                          READY     STATUS    RESTARTS   AGE       IP            NODE\ntraefik-ingress-controller-7b57f48999-x6rgf   1/1       Running   0          7m        172.17.0.13   192.168.1.170\n\n\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5728<code>192.168.1.170</code>\u4f7f\u7528<code>curl</code>\u68c0\u67e5\u662f\u5426\u5f00\u542f\u4e86 <code>Prometheus</code> \u6307\u6807\u6570\u636e\u63a5\u53e3\uff0c\u6216\u8005\u901a\u8fc7 <code>NodePort</code> \u8bbf\u95ee\u4e5f\u53ef\u4ee5\uff1a</p> <pre><code>$ curl 10.254.141.152:8080\n&lt;a href=\"/dashboard/\"&gt;Found&lt;/a&gt;.\n\n$ curl 10.254.141.152:8080/metrics\n# HELP go_gc_duration_seconds A summary of the GC invocation durations.\n# TYPE go_gc_duration_seconds summary\ngo_gc_duration_seconds{quantile=\"0\"} 5.2278e-05\ngo_gc_duration_seconds{quantile=\"0.25\"} 0.00019601\ngo_gc_duration_seconds{quantile=\"0.5\"} 0.001842359\ngo_gc_duration_seconds{quantile=\"0.75\"} 0.003759024\ngo_gc_duration_seconds{quantile=\"1\"} 0.013050517\ngo_gc_duration_seconds_sum 0.045638715\ngo_gc_duration_seconds_count 13\n# HELP go_goroutines Number of goroutines that currently exist.\n# TYPE go_goroutines gauge\ngo_goroutines 68\n# HELP go_memstats_alloc_bytes Number of bytes allocated and still in use.\n# TYPE go_memstats_alloc_bytes gauge\ngo_memstats_alloc_bytes 5.160144e+06\n# HELP go_memstats_alloc_bytes_total Total number of bytes allocated, even if freed.\n# TYPE go_memstats_alloc_bytes_total counter\ngo_memstats_alloc_bytes_total 3.9738656e+07\n# HELP go_memstats_buck_hash_sys_bytes Number of bytes used by the profiling bucket hash table.\n# TYPE go_memstats_buck_hash_sys_bytes gauge\ngo_memstats_buck_hash_sys_bytes 1.464133e+06\n...\n</code></pre> <p>\u4ece\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 <code>Traefik</code> \u7684\u76d1\u63a7\u6570\u636e\u63a5\u53e3\u5df2\u7ecf\u5f00\u542f\u6210\u529f\u4e86\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u8fd9\u4e2a<code>/metrics</code>\u63a5\u53e3\u914d\u7f6e\u5230<code>prometheus.yml</code>\u4e2d\u53bb\u4e86\uff0c\u76f4\u63a5\u52a0\u5230\u9ed8\u8ba4\u7684<code>prometheus</code>\u8fd9\u4e2a job \u4e0b\u9762\uff1a(<code>prometheus-config.yaml</code>)</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-ops\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 30s\n      scrape_timeout: 30s\n    scrape_configs:\n    - job_name: 'prometheus'\n      static_configs:\n        - targets: ['localhost:9090']\n    - job_name: 'traefik'\n      static_configs:\n        - targets: ['traefik-ingress-service.kube-system.svc.cluster.local:8080']\n...\n</code></pre> <p>\u5f53\u7136\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u4e00\u4e2a\u5f88\u7b80\u5355\u7684\u914d\u7f6e\uff0c<code>scrape_configs</code> \u4e0b\u9762\u53ef\u4ee5\u652f\u6301\u5f88\u591a\u53c2\u6570\uff0c\u4f8b\u5982</p> <ul> <li><code>basic_auth</code> \u548c <code>bearer_token</code>\uff1a\u6bd4\u5982\u6211\u4eec\u63d0\u4f9b\u7684<code>/metrics</code>\u63a5\u53e3\u9700\u8981 <code>basic</code> \u8ba4\u8bc1\u7684\u65f6\u5019\uff0c\u901a\u8fc7\u4f20\u7edf\u7684\u7528\u6237\u540d/\u5bc6\u7801\u6216\u8005\u5728\u8bf7\u6c42\u7684<code>header</code>\u4e2d\u6dfb\u52a0\u5bf9\u5e94\u7684 <code>token</code> \u90fd\u53ef\u4ee5\u652f\u6301</li> <li><code>kubernetes_sd_configs</code> \u6216 <code>consul_sd_configs</code>\uff1a\u53ef\u4ee5\u7528\u6765\u81ea\u52a8\u53d1\u73b0\u4e00\u4e9b\u5e94\u7528\u7684\u76d1\u63a7\u6570\u636e</li> </ul> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc <code>Traefik</code> \u5bf9\u5e94\u7684 <code>servicename</code> \u662f<code>traefik-ingress-service</code>\uff0c\u5e76\u4e14\u5728 <code>kube-system</code> \u8fd9\u4e2a <code>namespace</code> \u4e0b\u9762\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7684<code>targets</code>\u7684\u8def\u5f84\u914d\u7f6e\u5219\u9700\u8981\u4f7f\u7528<code>FQDN</code>\u7684\u5f62\u5f0f\uff1a<code>traefik-ingress-service.kube-system.svc.cluster.local</code>\uff0c\u5f53\u7136\u5982\u679c\u4f60\u7684 <code>Traefik</code> \u548c <code>Prometheus</code> \u90fd\u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u7684\u8bdd\uff0c\u5219\u76f4\u63a5\u586b <code>servicename:serviceport</code>\u5373\u53ef\u3002\u7136\u540e\u6211\u4eec\u91cd\u65b0\u66f4\u65b0\u8fd9\u4e2a <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <p><code>traefik-ingress-service.kube-system.svc.cluster.local</code></p> <pre><code>$ kubectl delete -f prometheus-config.yaml\nconfigmap \"prometheus-config\" deleted\n$ kubectl create -f prometheus-config.yaml\nconfigmap \"prometheus-config\" created\n</code></pre> <p>\u73b0\u5728 <code>Prometheus</code> \u7684\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5df2\u7ecf\u66f4\u6539\u4e86\uff0c\u9694\u4e00\u4f1a\u513f\u88ab\u6302\u8f7d\u5230 <code>Pod</code> \u4e2d\u7684 <code>prometheus-deploy.yaml</code> \u6587\u4ef6\u4e5f\u4f1a\u66f4\u65b0\uff0c\u7531\u4e8e\u6211\u4eec\u4e4b\u524d\u7684 <code>Prometheus</code> \u542f\u52a8\u53c2\u6570\u4e2d\u6dfb\u52a0\u4e86<code>--web.enable-lifecycle</code>\u53c2\u6570\uff0c\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u53ea\u9700\u8981\u6267\u884c\u4e00\u4e2a <code>reload</code> \u547d\u4ee4\u5373\u53ef\u8ba9\u914d\u7f6e\u751f\u6548\uff1a</p> <pre><code>$ kubectl get svc -n kube-ops\nNAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)           AGE\nrometheus      NodePort    10.254.35.188    &lt;none&gt;        9090:30900/TCP    15d\n</code></pre> <p>\u5728 node <code>192.168.1.179</code>\u4e0a</p> <pre><code>$ curl -X POST \"http://10.254.35.188:9090/-/reload\"\nReloading configuration file...\n</code></pre> <p>\u7531\u4e8e ConfigMap \u901a\u8fc7 Volume \u7684\u5f62\u5f0f\u6302\u8f7d\u5230 Pod \u4e2d\u53bb\u7684\u70ed\u66f4\u65b0\u9700\u8981\u4e00\u5b9a\u7684\u95f4\u9694\u65f6\u95f4\u624d\u4f1a\u751f\u6548\uff0c\u6240\u4ee5\u9700\u8981\u7a0d\u5fae\u7b49\u4e00\u5c0f\u4f1a\u513f\u3002<code>http://192.168.1.170:30900/targets</code></p> <p><code>reload</code> \u8fd9\u4e2a <code>url</code> \u662f\u4e00\u4e2a <code>POST</code> \u8bf7\u6c42\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>service</code> \u7684 <code>CLUSTER-IP:PORT</code> \u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u8fd9\u4e2a\u91cd\u8f7d\u7684\u63a5\u53e3\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u770b <code>Prometheus</code> \u7684 <code>Dashboard</code> \u4e2d\u67e5\u770b\u91c7\u96c6\u7684\u76ee\u6807\u6570\u636e\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u521a\u521a\u6dfb\u52a0\u7684<code>traefik</code>\u8fd9\u4e2a\u4efb\u52a1\u5df2\u7ecf\u51fa\u73b0\u4e86\uff0c\u7136\u540e\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u5207\u6362\u5230 <code>Graph</code> \u4e0b\u9762\u53bb\uff0c\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u4e00\u4e9b <code>Traefik</code> \u7684\u6307\u6807\u6570\u636e\uff0c\u81f3\u4e8e\u8fd9\u4e9b\u6307\u6807\u6570\u636e\u4ee3\u8868\u4ec0\u4e48\u610f\u4e49\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b\u5bf9\u5e94\u7684<code>/metrics</code>\u63a5\u53e3\uff0c\u91cc\u9762\u4e00\u822c\u60c5\u51b5\u4e0b\u90fd\u4f1a\u6709\u5bf9\u5e94\u7684\u6ce8\u91ca\u3002</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5728 <code>Prometheus</code> \u4e0a\u914d\u7f6e\u4e86\u7b2c\u4e00\u4e2a <code>Kubernetes</code> \u5e94\u7528\u3002</p>"},{"location":"chap3/5Adv_Prometheus_monitor/#2-exporter","title":"2 \u4f7f\u7528 exporter \u76d1\u63a7\u5e94\u7528","text":"<p>\u4e0a\u9762\u6211\u4eec\u4e5f\u8bf4\u8fc7\u6709\u4e00\u4e9b\u5e94\u7528\u53ef\u80fd\u6ca1\u6709\u81ea\u5e26<code>/metrics</code>\u63a5\u53e3\u4f9b <code>Prometheus</code> \u4f7f\u7528\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5c31\u9700\u8981\u5229\u7528 <code>exporter</code> \u670d\u52a1\u6765\u4e3a <code>Prometheus</code> \u63d0\u4f9b\u6307\u6807\u6570\u636e\u4e86\u3002<code>Prometheus</code> \u5b98\u65b9\u4e3a\u8bb8\u591a\u5e94\u7528\u5c31\u63d0\u4f9b\u4e86\u5bf9\u5e94\u7684 <code>exporter</code> \u5e94\u7528\uff0c\u4e5f\u6709\u8bb8\u591a\u7b2c\u4e09\u65b9\u7684\u5b9e\u73b0\uff0c\u6211\u4eec\u53ef\u4ee5\u524d\u5f80\u5b98\u65b9\u7f51\u7ad9\u8fdb\u884c\u67e5\u770b\uff1aexporters</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7\u4e00\u4e2aredis-exporter\u7684\u670d\u52a1\u6765\u76d1\u63a7 <code>redis</code> \u670d\u52a1\uff0c\u5bf9\u4e8e\u8fd9\u7c7b\u5e94\u7528\uff0c\u6211\u4eec\u4e00\u822c\u4f1a\u4ee5 <code>sidecar</code> \u7684\u5f62\u5f0f\u548c\u4e3b\u5e94\u7528\u90e8\u7f72\u5728\u540c\u4e00\u4e2a <code>Pod</code> \u4e2d\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6765\u90e8\u7f72\u4e00\u4e2a <code>redis</code> \u5e94\u7528\uff0c\u5e76\u7528 <code>redis-exporter</code> \u7684\u65b9\u5f0f\u6765\u91c7\u96c6\u76d1\u63a7\u6570\u636e\u4f9b <code>Prometheus</code> \u4f7f\u7528\uff0c\u5982\u4e0b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a\uff08<code>prome-redis.yaml</code>\uff09</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: redis\n  namespace: kube-ops\nspec:\n  template:\n    metadata:\n      annotations:\n        prometheus.io/scrape: \"true\"\n        prometheus.io/port: \"9121\"\n      labels:\n        app: redis\n    spec:\n      containers:\n      - name: redis\n        image: redis:4\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        ports:\n        - containerPort: 6379\n      - name: redis-exporter\n        image: oliver006/redis_exporter:latest\n        resources:\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        ports:\n        - containerPort: 9121\n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: redis\n  namespace: kube-ops\nspec:\n  selector:\n    app: redis\n  ports:\n  - name: redis\n    port: 6379\n    targetPort: 6379\n  - name: prom\n    port: 9121\n    targetPort: 9121\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u6211\u4eec\u5728 <code>redis</code> \u8fd9\u4e2a <code>Pod</code> \u4e2d\u5305\u542b\u4e86\u4e24\u4e2a\u5bb9\u5668\uff0c\u4e00\u4e2a\u5c31\u662f <code>redis</code> \u672c\u8eab\u7684\u4e3b\u5e94\u7528\uff0c\u53e6\u5916\u4e00\u4e2a\u5bb9\u5668\u5c31\u662f <code>redis_exporter</code>\u3002\u73b0\u5728\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u5e94\u7528\uff1a</p> <pre><code>$ kubectl create -f prome-redis.yaml\ndeployment.extensions \"redis\" created\nservice \"redis\" created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>redis</code> \u7684 <code>Pod</code> \u91cc\u9762\u5305\u542b\u6709\u4e24\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                          READY     STATUS    RESTARTS   AGE\nprometheus-66cf4c9574-8f9f6   1/1       Running   1          5d\nredis-59bf8cdd76-d5hq7        2/2       Running   0          23m\n\n$ kubectl get svc -n kube-ops\nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\nprometheus      NodePort    10.254.35.188    &lt;none&gt;        9090:30900/TCP      5d\nredis           ClusterIP   10.254.9.196     &lt;none&gt;        6379/TCP,9121/TCP   24m\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>9121</code> \u7aef\u53e3\u6765\u6821\u9a8c\u662f\u5426\u80fd\u591f\u91c7\u96c6\u5230\u6570\u636e(<code>138</code>)\uff1a</p> <pre><code> curl 10.254.9.196:9121/metrics\n# HELP go_gc_duration_seconds A summary of the GC invocation durations.\n# TYPE go_gc_duration_seconds summary\ngo_gc_duration_seconds{quantile=\"0\"} 0\ngo_gc_duration_seconds{quantile=\"0.25\"} 0\ngo_gc_duration_seconds{quantile=\"0.5\"} 0\ngo_gc_duration_seconds{quantile=\"0.75\"} 0\ngo_gc_duration_seconds{quantile=\"1\"} 0\ngo_gc_duration_seconds_sum 0\ngo_gc_duration_seconds_count 0\n...\n</code></pre> <p>\u540c\u6837\u7684\uff0c\u73b0\u5728\u6211\u4eec\u53ea\u9700\u8981\u66f4\u65b0 <code>Prometheus</code> \u7684\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-ops\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 30s\n      scrape_timeout: 30s\n    scrape_configs:\n    - job_name: 'prometheus'\n      static_configs:\n        - targets: ['localhost:9090']\n    - job_name: 'traefik'\n      static_configs:\n        - targets: ['traefik-ingress-service.kube-system.svc.cluster.local:8080']\n    - job_name: 'redis'\n      static_configs:\n        - targets: ['redis:9121']\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u7684 <code>redis</code> \u670d\u52a1\u548c <code>Prometheus</code> \u5904\u4e8e\u540c\u4e00\u4e2a <code>namespace</code>\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 <code>servicename</code> \u5373\u53ef\u3002</p> <pre><code>$ kubectl delete -f prometheus-config.yaml\nconfigmap \"prometheus-config\" deleted\n\n$ kubectl create -f prometheus-config.yaml\nconfigmap \"prometheus-config\" created\n</code></pre> <p>\u5728 node <code>192.168.1.179</code>\u4e0a</p> <pre><code>$ curl -X POST \"http://10.254.35.188:9090/-/reload\"\nReloading configuration file...\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u770b Prometheus \u7684 Dashboard \u4e2d\u67e5\u770b\u91c7\u96c6\u7684\u76ee\u6807\u6570\u636e\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u914d\u7f6e\u7684 <code>redis</code> \u8fd9\u4e2a <code>job</code> \u5df2\u7ecf\u751f\u6548\u4e86\u3002\u5207\u6362\u5230 <code>Graph</code> \u4e0b\u9762\u53ef\u4ee5\u770b\u5230\u5f88\u591a\u5173\u4e8e <code>redis</code> \u7684\u6307\u6807\u6570\u636e\uff1a</p> <p></p> <p>\u6211\u4eec\u9009\u62e9\u4efb\u610f\u4e00\u4e2a\u6307\u6807\uff0c\u6bd4\u5982<code>redis_exporter_scrapes_total</code>\uff0c\u7136\u540e\u70b9\u51fb\u6267\u884c\u5c31\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u6570\u636e\u56fe\u8868\u4e86\uff1a <code>redis scrapes total</code></p> <p></p> <p>\u6ce8\u610f\uff0c\u5982\u679c\u65f6\u95f4\u6709\u95ee\u9898\uff0c\u6211\u4eec\u9700\u8981\u624b\u52a8\u5728 Graph \u4e0b\u9762\u8c03\u6574\u4e0b\u65f6\u95f4</p>"},{"location":"chap3/6Adv_K8S_Nodes_monitor/","title":"\u7b2c\u516d\u8282 \u76d1\u63a7K8S\u96c6\u7fa4\u8282\u70b9&amp;Node-exporter DaemonSet","text":"<p>\u600e\u6837\u7528 <code>Promethues</code> \u6765\u76d1\u63a7 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\uff0c\u4f46\u662f\u5bf9\u4e8e <code>Kubernetes</code> \u96c6\u7fa4\u672c\u8eab\u7684\u76d1\u63a7\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u6211\u4eec\u9700\u8981\u65f6\u65f6\u523b\u523b\u4e86\u89e3\u96c6\u7fa4\u7684\u8fd0\u884c\u72b6\u6001\u3002</p> <p>\u5bf9\u4e8e\u96c6\u7fa4\u7684\u76d1\u63a7\u4e00\u822c\u6211\u4eec\u9700\u8981\u8003\u8651\u4ee5\u4e0b\u51e0\u4e2a\u65b9\u9762\uff1a</p> <ul> <li><code>Kubernetes</code> \u8282\u70b9\u7684\u76d1\u63a7\uff1a\u6bd4\u5982\u8282\u70b9\u7684 <code>cpu</code>\u3001<code>load</code>\u3001<code>disk</code>\u3001<code>memory</code> \u7b49\u6307\u6807</li> <li>\u5185\u90e8\u7cfb\u7edf\u7ec4\u4ef6\u7684\u72b6\u6001\uff1a\u6bd4\u5982 <code>kube-scheduler</code>\u3001<code>kube-controller-manager</code>\u3001<code>kubedns/coredns</code> \u7b49\u7ec4\u4ef6\u7684\u8be6\u7ec6\u8fd0\u884c\u72b6\u6001</li> <li>\u7f16\u6392\u7ea7\u7684 <code>metrics</code>\uff1a\u6bd4\u5982 <code>Deployment</code> \u7684\u72b6\u6001\u3001\u8d44\u6e90\u8bf7\u6c42\u3001\u8c03\u5ea6\u548c <code>API</code> \u5ef6\u8fdf\u7b49\u6570\u636e\u6307\u6807</li> </ul>"},{"location":"chap3/6Adv_K8S_Nodes_monitor/#1","title":"1 \u76d1\u63a7\u65b9\u6848","text":"<p><code>Kubernetes</code> \u96c6\u7fa4\u7684\u76d1\u63a7\u65b9\u6848\u76ee\u524d\u4e3b\u8981\u6709\u4ee5\u4e0b\u96c6\u4e2d\u65b9\u6848\uff1a</p> <ul> <li><code>Heapster</code>\uff1a<code>Heapster</code> \u662f\u4e00\u4e2a\u96c6\u7fa4\u8303\u56f4\u7684\u76d1\u63a7\u548c\u6570\u636e\u805a\u5408\u5de5\u5177\uff0c\u4ee5 <code>Pod</code> \u7684\u5f62\u5f0f\u8fd0\u884c\u5728\u96c6\u7fa4\u4e2d\u3002</li> </ul> <p></p> <p>\u9664\u4e86 <code>Kubelet/cAdvisor</code> \u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5411 <code>Heapster</code> \u6dfb\u52a0\u5176\u4ed6\u6307\u6807\u6e90\u6570\u636e\uff0c\u6bd4\u5982 <code>kube-state-metrics</code>\uff0c\u6211\u4eec\u4f1a\u5728\u4e0b\u9762\u548c\u5927\u5bb6\u8bb2\u89e3\u7684</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f <code>Heapster</code> \u5df2\u7ecf\u88ab\u5e9f\u5f03\u4e86\uff0c\u540e\u7eed\u7248\u672c\u4e2d\u4f1a\u4f7f\u7528 <code>metrics-server</code> \u4ee3\u66ff\u3002</p> <ul> <li><code>cAdvisor</code>\uff1acAdvisor \u662f<code>Google</code>\u5f00\u6e90\u7684\u5bb9\u5668\u8d44\u6e90\u76d1\u63a7\u548c\u6027\u80fd\u5206\u6790\u5de5\u5177\uff0c\u5b83\u662f\u4e13\u95e8\u4e3a\u5bb9\u5668\u800c\u751f\uff0c\u672c\u8eab\u4e5f\u652f\u6301 <code>Docker</code> \u5bb9\u5668\uff0c\u5728 <code>Kubernetes</code> \u4e2d\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u5355\u72ec\u53bb\u5b89\u88c5\uff0c<code>cAdvisor</code> \u4f5c\u4e3a <code>kubelet</code> \u5185\u7f6e\u7684\u4e00\u90e8\u5206\u7a0b\u5e8f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002</li> <li><code>Kube-state-metrics</code>\uff1akube-state-metrics \u901a\u8fc7\u76d1\u542c <code>API Server</code> \u751f\u6210\u6709\u5173\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u6307\u6807\uff0c\u6bd4\u5982 <code>Deployment</code>\u3001<code>Node</code>\u3001<code>Pod</code>\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f <code>kube-state-metrics</code> \u53ea\u662f\u7b80\u5355\u63d0\u4f9b\u4e00\u4e2a <code>metrics</code> \u6570\u636e\uff0c\u5e76\u4e0d\u4f1a\u5b58\u50a8\u8fd9\u4e9b\u6307\u6807\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>Prometheus</code> \u6765\u6293\u53d6\u8fd9\u4e9b\u6570\u636e\u7136\u540e\u5b58\u50a8\u3002</li> <li><code>metrics-server</code>\uff1a<code>metrics-server</code> \u4e5f\u662f\u4e00\u4e2a\u96c6\u7fa4\u8303\u56f4\u5185\u7684\u8d44\u6e90\u6570\u636e\u805a\u5408\u5de5\u5177\uff0c\u662f <code>Heapster</code> \u7684\u66ff\u4ee3\u54c1\uff0c\u540c\u6837\u7684\uff0c<code>metrics-server</code> \u4e5f\u53ea\u662f\u663e\u793a\u6570\u636e\uff0c\u5e76\u4e0d\u63d0\u4f9b\u6570\u636e\u5b58\u50a8\u670d\u52a1\u3002</li> </ul> <p>\u4e0d\u8fc7 <code>kube-state-metrics</code> \u548c <code>metrics-server</code> \u4e4b\u95f4\u8fd8\u662f\u6709\u5f88\u5927\u4e0d\u540c\u7684\uff0c\u4e8c\u8005\u7684\u4e3b\u8981\u533a\u522b\u5982\u4e0b\uff1a</p> <ul> <li><code>kube-state-metric</code>s \u4e3b\u8981\u5173\u6ce8\u7684\u662f\u4e1a\u52a1\u76f8\u5173\u7684\u4e00\u4e9b\u5143\u6570\u636e\uff0c\u6bd4\u5982 <code>Deployment</code>\u3001<code>Pod</code>\u3001\u526f\u672c\u72b6\u6001\u7b49</li> <li><code>metrics-server</code> \u4e3b\u8981\u5173\u6ce8\u7684\u662f\u8d44\u6e90\u5ea6\u91cf API \u7684\u5b9e\u73b0\uff0c\u6bd4\u5982 CPU\u3001\u6587\u4ef6\u63cf\u8ff0\u7b26\u3001\u5185\u5b58\u3001\u8bf7\u6c42\u5ef6\u65f6\u7b49\u6307\u6807\u3002</li> </ul>"},{"location":"chap3/6Adv_K8S_Nodes_monitor/#2","title":"2 \u76d1\u63a7\u96c6\u7fa4\u8282\u70b9","text":"<p>\u73b0\u5728\u6211\u4eec\u5c31\u6765\u5f00\u59cb\u6211\u4eec\u96c6\u7fa4\u7684\u76d1\u63a7\u5de5\u4f5c\uff0c\u9996\u5148\u6765\u76d1\u63a7\u6211\u4eec\u96c6\u7fa4\u7684\u8282\u70b9\uff0c\u8981\u76d1\u63a7\u8282\u70b9\u5176\u5b9e\u6211\u4eec\u5df2\u7ecf\u6709\u5f88\u591a\u975e\u5e38\u6210\u719f\u7684\u65b9\u6848\u4e86\uff0c\u6bd4\u5982 <code>Nagios</code>\u3001<code>zabbix</code>\uff0c\u751a\u81f3\u6211\u4eec\u81ea\u5df1\u6765\u6536\u96c6\u6570\u636e\u4e5f\u53ef\u4ee5\uff0c\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7 <code>Prometheus</code> \u6765\u91c7\u96c6\u8282\u70b9\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u53ef\u4ee5\u901a\u8fc7<code>node_exporter</code>\u6765\u83b7\u53d6\uff0c\u987e\u540d\u601d\u4e49\uff0c<code>node_exporter</code> \u6293\u54df\u5c31\u662f\u7528\u4e8e\u91c7\u96c6\u670d\u52a1\u5668\u8282\u70b9\u7684\u5404\u79cd\u8fd0\u884c\u6307\u6807\u7684\uff0c\u76ee\u524d <code>node_exporter</code> \u652f\u6301\u51e0\u4e4e\u6240\u6709\u5e38\u89c1\u7684\u76d1\u63a7\u70b9\uff0c\u6bd4\u5982 <code>conntrack</code>\uff0c<code>cpu</code>\uff0c<code>diskstats</code>\uff0c<code>filesystem</code>\uff0c<code>loadavg</code>\uff0c<code>meminfo</code>\uff0c<code>netstat</code>\u7b49\uff0c</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>DaemonSet</code> \u63a7\u5236\u5668\u6765\u90e8\u7f72\u8be5\u670d\u52a1\uff0c\u8fd9\u6837\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u4f1a\u81ea\u52a8\u8fd0\u884c\u4e00\u4e2a\u8fd9\u6837\u7684 <code>Pod</code>\uff0c\u5982\u679c\u6211\u4eec\u4ece\u96c6\u7fa4\u4e2d\u5220\u9664\u6216\u8005\u6dfb\u52a0\u8282\u70b9\u540e\uff0c\u4e5f\u4f1a\u8fdb\u884c\u81ea\u52a8\u6269\u5c55\u3002</p> <p>\u5728\u90e8\u7f72 <code>node-exporter</code> \u7684\u65f6\u5019\u6709\u4e00\u4e9b\u7ec6\u8282\u9700\u8981\u6ce8\u610f\uff0c\u5982\u4e0b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a(<code>prome-node-exporter.yaml</code>)</p> <pre><code>apiVersion: extensions/v1beta1\nkind: DaemonSet\nmetadata:\n  name: node-exporter\n  namespace: kube-ops\n  labels:\n    name: node-exporter\nspec:\n  template:\n    metadata:\n      labels:\n        name: node-exporter\n    spec:\n      hostPID: true\n      hostIPC: true\n      hostNetwork: true\n      containers:\n      - name: node-exporter\n        image: prom/node-exporter:v0.16.0\n        ports:\n        - containerPort: 9100\n        resources:\n          requests:\n            cpu: 0.15\n        securityContext:\n          privileged: true\n        args:\n        - --path.procfs\n        - /host/proc\n        - --path.sysfs\n        - /host/sys\n        - --collector.filesystem.ignored-mount-points\n        - '\"^/(sys|proc|dev|host|etc)($|/)\"'\n        volumeMounts:\n        - name: dev\n          mountPath: /host/dev\n        - name: proc\n          mountPath: /host/proc\n        - name: sys\n          mountPath: /host/sys\n        - name: rootfs\n          mountPath: /rootfs\n      tolerations:\n      - key: \"node-role.kubernetes.io/master\"\n        operator: \"Exists\"\n        effect: \"NoSchedule\"\n      volumes:\n        - name: proc\n          hostPath:\n            path: /proc\n        - name: dev\n          hostPath:\n            path: /dev\n        - name: sys\n          hostPath:\n            path: /sys\n        - name: rootfs\n          hostPath:\n            path: /\n\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8981\u83b7\u53d6\u5230\u7684\u6570\u636e\u662f\u4e3b\u673a\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u800c\u6211\u4eec\u7684 <code>node-exporter</code> \u662f\u8fd0\u884c\u5728\u5bb9\u5668\u4e2d\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5728 Pod \u4e2d\u9700\u8981\u914d\u7f6e\u4e00\u4e9b <code>Pod</code> \u7684\u5b89\u5168\u7b56\u7565\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u6dfb\u52a0\u4e86<code>hostPID: true</code>\u3001<code>hostIPC : true</code> \u3001 <code>hostNetwork: true</code>3\u4e2a\u7b56\u7565\uff0c\u7528\u6765\u4f7f\u7528\u4e3b\u673a\u7684 <code>PID namespace</code>\u3001<code>IPC namespace</code> \u4ee5\u53ca\u4e3b\u673a\u7f51\u7edc\uff0c\u8fd9\u4e9b <code>namespace</code> \u5c31\u662f\u7528\u4e8e\u5bb9\u5668\u9694\u79bb\u7684\u5173\u952e\u6280\u672f\uff0c\u8981\u6ce8\u610f\u8fd9\u91cc\u7684 <code>namespace</code> \u548c\u96c6\u7fa4\u4e2d\u7684 <code>namespace</code> \u662f\u4e24\u4e2a\u5b8c\u5168\u4e0d\u76f8\u540c\u7684\u6982\u5ff5\u3002 </p> <p>\u53e6\u5916\u6211\u4eec\u8fd8\u5c06\u4e3b\u673a\u7684<code>/dev</code>\u3001<code>/proc</code>\u3001<code>/sys</code>\u8fd9\u4e9b\u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u8fd9\u4e9b\u56e0\u4e3a\u6211\u4eec\u91c7\u96c6\u7684\u5f88\u591a\u8282\u70b9\u6570\u636e\u90fd\u662f\u901a\u8fc7\u8fd9\u4e9b\u6587\u4ef6\u5939\u4e0b\u9762\u7684\u6587\u4ef6\u6765\u83b7\u53d6\u5230\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u5728\u4f7f\u7528<code>top</code>\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d<code>cpu</code>\u4f7f\u7528\u60c5\u51b5\uff0c\u6570\u636e\u5c31\u6765\u6e90\u4e8e\u6587\u4ef6<code>/proc/stat</code>\uff0c\u4f7f\u7528<code>free</code>\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\uff0c\u5176\u6570\u636e\u6765\u6e90\u662f\u6765\u81ea<code>/proc/meminfo</code>\u6587\u4ef6\u3002</p> <p>\u53e6\u5916\u7531\u4e8e\u6211\u4eec\u96c6\u7fa4\u4f7f\u7528\u7684\u662f <code>kubeadm</code> \u642d\u5efa\u7684\uff0c\u6240\u4ee5\u5982\u679c\u5e0c\u671b master \u8282\u70b9\u4e5f\u4e00\u8d77\u88ab\u76d1\u63a7\uff0c\u5219\u9700\u8981\u6dfb\u52a0\u54cd\u5e94\u7684\u5bb9\u5fcd\uff0c\u5bf9\u4e8e\u6c61\u70b9\u548c\u5bb9\u5fcd\u8fd8\u4e0d\u662f\u5f88\u719f\u6089\u7684\u540c\u5b66\u53ef\u4ee5\u5728\u524d\u9762\u7684\u7ae0\u8282\u4e2d\u56de\u987e\u4e0b\u3002</p> <pre><code>$ kubectl create -f prome-node-exporter.yaml\ndaemonset.extensions \"node-exporter\" created\n$ kubectl get pods -n kube-ops -o wide\nNAME                          READY     STATUS    RESTARTS   AGE       IP             NODE\nnode-exporter-jfwfv           1/1       Running   0          30m       10.151.30.63   node02\nnode-exporter-kr8rt           1/1       Running   0          30m       10.151.30.64   node03\nnode-exporter-whb7n           1/1       Running   0          20m       10.151.30.57   master\nprometheus-8566cd9699-gt9wh   1/1       Running   0          4d        10.244.4.39    node02\nredis-544b6c8c54-8xd2g        2/2       Running   0          23h       10.244.2.87    node03\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5728<code>3</code>\u4e2a\u8282\u70b9\u4e0a\u90fd\u8fd0\u884c\u4e86\u4e00\u4e2a <code>Pod</code>\uff0c\u6709\u7684\u540c\u5b66\u53ef\u80fd\u4f1a\u8bf4\u6211\u4eec\u8fd9\u91cc\u4e0d\u9700\u8981\u521b\u5efa\u4e00\u4e2a <code>Service</code> \u5417\uff1f\u6211\u4eec\u5e94\u8be5\u600e\u6837\u53bb\u83b7\u53d6<code>/metrics</code>\u6570\u636e\u5462\uff1f\u6211\u4eec\u4e0a\u9762\u662f\u4e0d\u662f\u6307\u5b9a\u4e86<code>hostNetwork=true</code>\uff0c\u6240\u4ee5\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5c31\u4f1a\u7ed1\u5b9a\u4e00\u4e2a\u7aef\u53e3 <code>9100</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u7aef\u53e3\u53bb\u83b7\u53d6\u5230\u76d1\u63a7\u6307\u6807\u6570\u636e\uff1a</p> <pre><code>$ curl 127.0.0.1:9100/metrics\n...\nnode_filesystem_device_error{device=\"shm\",fstype=\"tmpfs\",mountpoint=\"/rootfs/var/lib/docker/containers/aefe8b1b63c3aa5f27766053ec817415faf8f6f417bb210d266fef0c2da64674/shm\"} 1\nnode_filesystem_device_error{device=\"shm\",fstype=\"tmpfs\",mountpoint=\"/rootfs/var/lib/docker/containers/c8652ca72230496038a07e4fe4ee47046abb5f88d9d2440f0c8a923d5f3e133c/shm\"} 1\nnode_filesystem_device_error{device=\"tmpfs\",fstype=\"tmpfs\",mountpoint=\"/dev\"} 0\nnode_filesystem_device_error{device=\"tmpfs\",fstype=\"tmpfs\",mountpoint=\"/dev/shm\"} 0\n...\n</code></pre> <p>\u5f53\u7136\u5982\u679c\u4f60\u89c9\u5f97\u4e0a\u9762\u7684\u624b\u52a8\u5b89\u88c5\u65b9\u5f0f\u6bd4\u8f83\u9ebb\u70e6\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 Helm \u7684\u65b9\u5f0f\u6765\u5b89\u88c5\uff1a</p> <pre><code>$ helm install --name node-exporter stable/prometheus-node-exporter --namespace kube-ops\n\n</code></pre>"},{"location":"chap3/6Adv_K8S_Nodes_monitor/#3","title":"3 \u670d\u52a1\u53d1\u73b0","text":"<p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc<code>3</code>\u4e2a\u8282\u70b9\u4e0a\u9762\u90fd\u8fd0\u884c\u4e86 <code>node-exporter</code> \u7a0b\u5e8f\uff0c\u5982\u679c\u6211\u4eec\u901a\u8fc7\u4e00\u4e2a <code>Service</code> \u6765\u5c06\u6570\u636e\u6536\u96c6\u5230\u4e00\u8d77\u7528\u9759\u6001\u914d\u7f6e\u7684\u65b9\u5f0f\u914d\u7f6e\u5230 <code>Prometheus</code> \u53bb\u4e2d\uff0c\u5c31\u53ea\u4f1a\u663e\u793a\u4e00\u6761\u6570\u636e\uff0c\u6211\u4eec\u5f97\u81ea\u5df1\u5728\u6307\u6807\u6570\u636e\u4e2d\u53bb\u8fc7\u6ee4\u6bcf\u4e2a\u8282\u70b9\u7684\u6570\u636e\uff0c\u90a3\u4e48\u6709\u6ca1\u6709\u4e00\u79cd\u65b9\u5f0f\u53ef\u4ee5\u8ba9 <code>Prometheus</code> \u53bb\u81ea\u52a8\u53d1\u73b0\u6211\u4eec\u8282\u70b9\u7684 <code>node-exporter</code> \u7a0b\u5e8f\uff0c\u5e76\u4e14\u6309\u8282\u70b9\u8fdb\u884c\u5206\u7ec4\u5462\uff1f\u662f\u6709\u7684\uff0c\u5c31\u662f\u6211\u4eec\u524d\u9762\u548c\u5927\u5bb6\u63d0\u5230\u8fc7\u7684\u670d\u52a1\u53d1\u73b0\u3002</p> <p>\u5728 <code>Kubernetes</code> \u4e0b\uff0c<code>Promethues</code> \u901a\u8fc7\u4e0e <code>Kubernetes API</code> \u96c6\u6210\uff0c\u76ee\u524d\u4e3b\u8981\u652f\u63015\u4e2d\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff0c\u5206\u522b\u662f\uff1a<code>Node</code>\u3001<code>Service</code>\u3001<code>Pod</code>\u3001<code>Endpoints</code>\u3001<code>Ingress</code>\u3002</p> <p>\u6211\u4eec\u901a\u8fc7 kubectl \u547d\u4ee4\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u83b7\u53d6\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get nodes\nNAME      STATUS    ROLES     AGE       VERSION\nmaster    Ready     master    165d      v1.10.0\nnode02    Ready     &lt;none&gt;    85d       v1.10.0\nnode03    Ready     &lt;none&gt;    145d      v1.10.0\n</code></pre> <p>\u4f46\u662f\u8981\u8ba9 <code>Prometheus</code> \u4e5f\u80fd\u591f\u83b7\u53d6\u5230\u5f53\u524d\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u4fe1\u606f\u7684\u8bdd\uff0c\u6211\u4eec\u5c31\u9700\u8981\u5229\u7528 Node \u7684\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff0c\u540c\u6837\u7684\uff0c\u5728 <code>prometheus.yml</code> \u6587\u4ef6\u4e2d\u914d\u7f6e\u5982\u4e0b\u7684 <code>job</code> \u4efb\u52a1\u5373\u53ef\uff1a</p> <pre><code>- job_name: 'kubernetes-nodes'\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  kubernetes_sd_configs:\n  - role: node\n</code></pre> <p>\u901a\u8fc7\u6307\u5b9a <code>kubernetes_sd_configs</code>\u7684\u6a21\u5f0f\u4e3a<code>node</code>\uff0c<code>Prometheus</code> \u5c31\u4f1a\u81ea\u52a8\u4ece <code>Kubernetes</code> \u4e2d\u53d1\u73b0\u6240\u6709\u7684 <code>node</code> \u8282\u70b9\u5e76\u4f5c\u4e3a\u5f53\u524d <code>job</code> \u76d1\u63a7\u7684\u76ee\u6807\u5b9e\u4f8b\uff0c\u53d1\u73b0\u7684\u8282\u70b9<code>/metrics</code>\u63a5\u53e3\u662f\u9ed8\u8ba4\u7684 <code>kubelet</code> \u7684 <code>HTTP</code> \u63a5\u53e3\uff0c\u53e6\u5916\u8fd9\u91cc\u8fd8\u9700\u8981\u6307\u5b9a\u7528\u4e8e\u8bbf\u95ee <code>Kubernetes API</code> \u7684 <code>ca</code> \u4ee5\u53ca <code>token</code> \u6587\u4ef6\u8def\u5f84\uff0c<code>ca</code> \u8bc1\u4e66\u548c <code>token</code> \u6587\u4ef6\u90fd\u662f <code>Pod</code> \u542f\u52a8\u540e\u96c6\u7fa4\u81ea\u52a8\u6ce8\u5165\u5230 <code>Pod</code> \u4e2d\u7684\u6587\u4ef6\u3002</p> <p><code>prometheus</code> \u7684 <code>ConfigMap</code> \u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u540c\u6837\u7684\u6211\u4eec\u6267\u884c <code>reload</code> \u64cd\u4f5c\uff0c\u8ba9\u914d\u7f6e\u751f\u6548\uff1a</p> <pre><code>$ kubectl delete -f prome-cm.yaml\nconfigmap \"prometheus-config\" deleted\n$ kubectl create -f prome-cm.yaml\nconfigmap \"prometheus-config\" created\n# \u9694\u4e00\u4f1a\u513f\u518d\u6267\u884c\u4e0b\u9762\u7684 reload \u64cd\u4f5c\n$ kubectl get svc -n kube-ops\nNAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE\nprometheus      NodePort    10.102.74.90    &lt;none&gt;        9090:30358/TCP                   5d\n......\n$ curl -X POST \"http://10.102.74.90:9090/-/reload\"\n</code></pre> <p>\u914d\u7f6e\u751f\u6548\u540e\uff0c\u6211\u4eec\u518d\u53bb <code>prometheus</code> \u7684 <code>dashboard</code> \u4e2d\u67e5\u770b <code>Targets</code> \u662f\u5426\u80fd\u591f\u6b63\u5e38\u6293\u53d6\u6570\u636e\uff0c\u8bbf\u95ee\u4efb\u610f\u8282\u70b9<code>IP:30358</code>\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684<code>kubernetes-nodes</code>\u8fd9\u4e2a job \u4efb\u52a1\u5df2\u7ecf\u81ea\u52a8\u53d1\u73b0\u4e86\u6211\u4eec<code>3</code>\u4e2a <code>node</code> \u8282\u70b9\uff0c\u4f46\u662f\u5728\u83b7\u53d6\u6570\u636e\u7684\u65f6\u5019\u5931\u8d25\u4e86\uff0c\u51fa\u73b0\u4e86\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u9519\u8bef\u4fe1\u606f\uff1a</p> <pre><code>Get http://10.151.30.57:10250/metrics: net/http: HTTP/1.x transport connection broken: malformed HTTP response \"\\x15\\x03\\x01\\x00\\x02\\x02\"\n</code></pre> <p>\u8fd9\u4e2a\u662f\u56e0\u4e3a <code>prometheus</code> \u53bb\u53d1\u73b0 <code>Node</code> \u6a21\u5f0f\u7684\u670d\u52a1\u7684\u65f6\u5019\uff0c\u8bbf\u95ee\u7684\u7aef\u53e3\u9ed8\u8ba4\u662f<code>10250</code>\uff0c\u800c\u73b0\u5728\u8be5\u7aef\u53e3\u4e0b\u9762\u5df2\u7ecf\u6ca1\u6709\u4e86<code>/metrics</code>\u6307\u6807\u6570\u636e\u4e86\uff0c\u73b0\u5728 <code>kubelet</code> \u53ea\u8bfb\u7684\u6570\u636e\u63a5\u53e3\u7edf\u4e00\u901a\u8fc7<code>10255</code>\u7aef\u53e3\u8fdb\u884c\u66b4\u9732\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5e94\u8be5\u53bb\u66ff\u6362\u6389\u8fd9\u91cc\u7684\u7aef\u53e3\uff0c\u4f46\u662f\u6211\u4eec\u662f\u8981\u66ff\u6362\u6210<code>10255</code>\u7aef\u53e3\u5417\uff1f</p> <p>\u4e0d\u662f\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u662f\u8981\u53bb\u914d\u7f6e\u4e0a\u9762\u901a\u8fc7<code>node-exporter</code>\u6293\u53d6\u5230\u7684\u8282\u70b9\u6307\u6807\u6570\u636e\uff0c\u800c\u6211\u4eec\u4e0a\u9762\u662f\u4e0d\u662f\u6307\u5b9a\u4e86<code>hostNetwork=true</code>\uff0c\u6240\u4ee5\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5c31\u4f1a\u7ed1\u5b9a\u4e00\u4e2a\u7aef\u53e3<code>9100</code>\uff0c\u6240\u4ee5\u6211\u4eec\u5e94\u8be5\u5c06\u8fd9\u91cc\u7684<code>10250</code>\u66ff\u6362\u6210<code>9100</code>\uff0c\u4f46\u662f\u5e94\u8be5\u600e\u6837\u66ff\u6362\u5462\uff1f</p> <p>\u8fd9\u91cc\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u5230 <code>Prometheus</code> \u63d0\u4f9b\u7684<code>relabel_configs</code> \u4e2d\u7684 <code>replace</code> \u80fd\u529b\u4e86\uff0c<code>relabel</code> \u53ef\u4ee5\u5728 <code>Prometheus</code> \u91c7\u96c6\u6570\u636e\u4e4b\u524d\uff0c\u901a\u8fc7<code>Target</code>  \u5b9e\u4f8b\u7684 <code>Metadata</code> \u4fe1\u606f\uff0c\u52a8\u6001\u91cd\u65b0\u5199\u5165 <code>Label</code> \u7684\u503c\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u80fd\u6839\u636e <code>Target</code> \u5b9e\u4f8b\u7684 <code>Metadata</code> \u4fe1\u606f\u9009\u62e9\u662f\u5426\u91c7\u96c6\u6216\u8005\u5ffd\u7565\u8be5 <code>Target</code> \u5b9e\u4f8b\u3002\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5c31\u53ef\u4ee5\u53bb\u5339\u914d<code>__address__</code> \u8fd9\u4e2a <code>Label</code> \u6807\u7b7e\uff0c\u7136\u540e\u66ff\u6362\u6389\u5176\u4e2d\u7684\u7aef\u53e3\uff1a</p> <pre><code>- job_name: 'kubernetes-nodes'\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  kubernetes_sd_configs:\n  - role: node\n  relabel_configs:\n  - source_labels: [__address__]\n    regex: '(.*):10250'\n    replacement: '${1}:9100'\n    target_label: __address__\n    action: replace  \n</code></pre> <p>\u8fd9\u91cc\u5c31\u662f\u4e00\u4e2a\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u53bb\u5339\u914d<code>__address__</code>\uff0c\u7136\u540e\u5c06 <code>host</code> \u90e8\u5206\u4fdd\u7559\u4e0b\u6765\uff0c<code>port</code> \u66ff\u6362\u6210\u4e86<code>9100</code>\uff0c\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\uff0c\u6267\u884c <code>reload</code> \u64cd\u4f5c\uff0c\u7136\u540e\u518d\u53bb\u770b <code>Prometheus</code> \u7684 <code>Dashboard</code> \u7684 <code>Targets</code> \u8def\u5f84\u4e0b\u9762 <code>kubernetes-nodes</code> \u8fd9\u4e2a <code>job</code> \u4efb\u52a1\u662f\u5426\u6b63\u5e38\u4e86\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u5df2\u7ecf\u6b63\u5e38\u4e86\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\u6211\u4eec\u91c7\u96c6\u7684\u6307\u6807\u6570\u636e <code>Label</code> \u6807\u7b7e\u5c31\u53ea\u6709\u4e00\u4e2a\u8282\u70b9\u7684 <code>hostname</code>\uff0c\u8fd9\u5bf9\u4e8e\u6211\u4eec\u5728\u8fdb\u884c\u76d1\u63a7\u5206\u7ec4\u5206\u7c7b\u67e5\u8be2\u7684\u65f6\u5019\u5e26\u6765\u4e86\u5f88\u591a\u4e0d\u65b9\u4fbf\u7684\u5730\u65b9\uff0c\u8981\u662f\u6211\u4eec\u80fd\u591f\u5c06\u96c6\u7fa4\u4e2d <code>Node</code> \u8282\u70b9\u7684 <code>Label</code> \u6807\u7b7e\u4e5f\u80fd\u83b7\u53d6\u5230\u5c31\u5f88\u597d\u4e86\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>labelmap</code>\u8fd9\u4e2a\u5c5e\u6027\u6765\u5c06 <code>Kubernetes</code> \u7684 <code>Label</code>\u6807\u7b7e\u6dfb\u52a0\u4e3a <code>Prometheus</code> \u7684\u6307\u6807\u6807\u7b7e\uff1a</p> <pre><code>- job_name: 'kubernetes-nodes'\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  kubernetes_sd_configs:\n  - role: node\n  relabel_configs:\n  - source_labels: [__address__]\n    regex: '(.*):10250'\n    replacement: '${1}:9100'\n    target_label: __address__\n    action: replace\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u6dfb\u52a0\u4e86\u4e00\u4e2a<code>action</code> \u4e3a<code>labelmap</code>\uff0c\u6b63\u5219\u8868\u8fbe\u5f0f\u662f<code>__meta_kubernetes_node_label_(.+)</code>\u7684\u914d\u7f6e\uff0c\u8fd9\u91cc\u7684\u610f\u601d\u5c31\u662f\u8868\u8fbe\u5f0f\u4e2d\u5339\u914d\u90fd\u7684\u6570\u636e\u4e5f\u6dfb\u52a0\u5230\u6307\u6807\u6570\u636e\u7684<code>Label</code> \u6807\u7b7e\u4e2d\u53bb\u3002</p> <p>\u5bf9\u4e8e <code>kubernetes_sd_configs</code> \u4e0b\u9762\u53ef\u7528\u7684\u6807\u7b7e\u5982\u4e0b\uff1a \u53ef\u7528\u5143\u6807\u7b7e\uff1a</p> <ul> <li><code>__meta_kubernetes_node_name</code>\uff1a\u8282\u70b9\u5bf9\u8c61\u7684\u540d\u79f0</li> <li><code>_meta_kubernetes_node_label</code>\uff1a\u8282\u70b9\u5bf9\u8c61\u4e2d\u7684\u6bcf\u4e2a\u6807\u7b7e</li> <li><code>_meta_kubernetes_node_annotation</code>\uff1a\u6765\u81ea\u8282\u70b9\u5bf9\u8c61\u7684\u6bcf\u4e2a\u6ce8\u91ca</li> <li><code>_meta_kubernetes_node_address</code>\uff1a\u6bcf\u4e2a\u8282\u70b9\u5730\u5740\u7c7b\u578b\u7684\u7b2c\u4e00\u4e2a\u5730\u5740\uff08\u5982\u679c\u5b58\u5728\uff09</li> </ul> <p>\u5173\u4e8e <code>kubernets_sd_configs</code> \u66f4\u591a\u4fe1\u606f\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff1akubernetes_sd_config</p> <p>\u5916\u7531\u4e8e <code>kubelet</code> \u4e5f\u81ea\u5e26\u4e86\u4e00\u4e9b\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u5c31\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684<code>10255</code>\u7aef\u53e3\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e5f\u628a <code>kubelet</code> \u7684\u76d1\u63a7\u4efb\u52a1\u4e5f\u4e00\u5e76\u914d\u7f6e\u4e0a\uff1a</p> <pre><code>- job_name: 'kubernetes-nodes'\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  kubernetes_sd_configs:\n  - role: node\n  relabel_configs:\n  - source_labels: [__address__]\n    regex: '(.*):10250'\n    replacement: '${1}:9100'\n    target_label: __address__\n    action: replace\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n\n- job_name: 'kubernetes-kubelet'\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  kubernetes_sd_configs:\n  - role: node\n  relabel_configs:\n  - source_labels: [__address__]\n    regex: '(.*):10250'\n    replacement: '${1}:10255'\n    target_label: __address__\n    action: replace\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb\u66f4\u65b0\u4e0b\u914d\u7f6e\u6587\u4ef6\uff0c\u6267\u884c <code>reload</code> \u64cd\u4f5c\uff0c\u8ba9\u914d\u7f6e\u751f\u6548\uff0c\u7136\u540e\u8bbf\u95ee <code>Prometheus</code> \u7684 <code>Dashboard</code> \u67e5\u770b <code>Targets</code> \u8def\u5f84\uff1a</p> <p></p> <p>\u73b0\u5728\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4e0a\u9762\u6dfb\u52a0\u7684<code>kubernetes-kubelet</code>\u548c<code>kubernetes-nodes</code>\u8fd9\u4e24\u4e2a <code>job</code> \u4efb\u52a1\u90fd\u5df2\u7ecf\u914d\u7f6e\u6210\u529f\u4e86\uff0c\u800c\u4e14\u4e8c\u8005\u7684 <code>Labels</code> \u6807\u7b7e\u90fd\u548c\u96c6\u7fa4\u7684 <code>node</code> \u8282\u70b9\u6807\u7b7e\u4fdd\u6301\u4e00\u81f4\u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5207\u6362\u5230 <code>Graph</code> \u8def\u5f84\u4e0b\u9762\u67e5\u770b\u91c7\u96c6\u7684\u4e00\u4e9b\u6307\u6807\u6570\u636e\u4e86\uff0c\u6bd4\u5982\u67e5\u8be2 <code>node_load1</code> \u6307\u6807\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5c063\u4e2a <code>node</code> \u8282\u70b9\u5bf9\u5e94\u7684 <code>node_load1</code> \u6307\u6807\u6570\u636e\u90fd\u67e5\u8be2\u51fa\u6765\u4e86\uff0c\u540c\u6837\u7684\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 <code>PromQL</code> \u8bed\u53e5\u6765\u8fdb\u884c\u66f4\u590d\u6742\u7684\u4e00\u4e9b\u805a\u5408\u67e5\u8be2\u64cd\u4f5c\uff0c\u8fd8\u53ef\u4ee5\u6839\u636e\u6211\u4eec\u7684 <code>Labels</code> \u6807\u7b7e\u5bf9\u6307\u6807\u6570\u636e\u8fdb\u884c\u805a\u5408\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u53ea\u67e5\u8be2 <code>node03</code> \u8282\u70b9\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u8868\u8fbe\u5f0f<code>node_load1{instance=\"node03\"}</code>\u6765\u8fdb\u884c\u67e5\u8be2\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u628a <code>Kubernetes</code> \u96c6\u7fa4\u8282\u70b9\u7684\u4f7f\u7528 <code>Prometheus</code> \u76d1\u63a7\u8d77\u6765\u4e86</p>"},{"location":"chap3/7Adv_K8S_Resource_monitor/","title":"\u7b2c\u4e03\u8282 \u76d1\u63a7\u5e38\u7528\u8d44\u6e90\u5bf9\u8c61\uff08\u5bb9\u5668/apiserver/Service\u76d1\u63a7/kube-state-metric\uff09","text":"<p>\u4e0a\u4e00\u7bc7\u6211\u4eec\u5b66\u4e60\u4e86\u600e\u6837\u7528 <code>Prometheus</code> \u6765\u81ea\u52a8\u53d1\u73b0 <code>Kubernetes</code> \u96c6\u7fa4\u7684\u8282\u70b9\uff0c\u7528\u5230\u4e86 <code>Prometheus</code> \u9488\u5bf9 <code>Kubernetes</code> \u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236 <code>kubernetes_sd_configs</code> \u7684\u4f7f\u7528\uff0c\u6b64\u7bc7\u6587\u7ae0\u6211\u4eec\u4e86\u89e3\u4e0b\u600e\u6837\u5728 <code>Prometheus</code> \u4e2d\u6765\u81ea\u52a8\u76d1\u63a7 <code>Kubernetes</code> \u4e2d\u7684\u4e00\u4e9b\u5e38\u7528\u8d44\u6e90\u5bf9\u8c61\u3002</p> <p>\u524d\u9762\u6211\u4eec\u548c\u5927\u5bb6\u4ecb\u7ecd\u8fc7\u4e86\u5728 <code>Prometheus</code> \u4e2d\u7528\u9759\u6001\u7684\u65b9\u5f0f\u6765\u76d1\u63a7 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u7684\u666e\u901a\u5e94\u7528\uff0c\u4f46\u662f\u5982\u679c\u9488\u5bf9\u96c6\u7fa4\u4e2d\u4f17\u591a\u7684\u8d44\u6e90\u5bf9\u8c61\u90fd\u91c7\u7528\u9759\u6001\u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u914d\u7f6e\u7684\u8bdd\u663e\u7136\u662f\u4e0d\u73b0\u5b9e\u7684\uff0c\u6240\u4ee5\u540c\u6837\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5230 <code>Prometheus</code> \u63d0\u4f9b\u7684\u5176\u4ed6\u7c7b\u578b\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\u3002</p>"},{"location":"chap3/7Adv_K8S_Resource_monitor/#1","title":"1 \u5bb9\u5668\u76d1\u63a7","text":"<p>\u8bf4\u5230\u5bb9\u5668\u76d1\u63a7\u6211\u4eec\u81ea\u7136\u4f1a\u60f3\u5230 <code>cAdvisor</code>\uff0c\u6211\u4eec\u524d\u9762\u4e5f\u8bf4\u8fc7 <code>cAdvisor</code> \u5df2\u7ecf\u5185\u7f6e\u5728\u4e86 <code>kubelet</code> \u7ec4\u4ef6\u4e4b\u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u9700\u8981\u5355\u72ec\u53bb\u5b89\u88c5\uff0c<code>cAdvisor</code> \u7684\u6570\u636e\u8def\u5f84\u4e3a <code>/api/v1/nodes/&lt;node&gt;/proxy/metrics</code>, \u540c\u6837\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 <code>node</code>\u7684\u670d\u52a1\u53d1\u73b0\u6a21\u5f0f\uff0c\u56e0\u4e3a\u6bcf\u4e00\u4e2a\u8282\u70b9\u4e0b\u9762\u90fd\u6709 <code>kubelet</code>\uff0c\u81ea\u7136\u90fd\u6709 <code>cAdvisor</code> \u91c7\u96c6\u5230\u7684\u6570\u636e\u6307\u6807\uff0c\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>- job_name: 'kubernetes-cadvisor'\n  kubernetes_sd_configs:\n  - role: node\n  scheme: https\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  relabel_configs:\n  - action: labelmap\n    regex: __meta_kubernetes_node_label_(.+)\n  - target_label: __address__\n    replacement: kubernetes.default.svc:443\n  - source_labels: [__meta_kubernetes_node_name]\n    regex: (.+)\n    target_label: __metrics_path__\n    replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor\n</code></pre> <p>\u4e0a\u9762\u7684\u914d\u7f6e\u548c\u6211\u4eec\u4e4b\u524d\u914d\u7f6e <code>node-exporter</code> \u7684\u65f6\u5019\u51e0\u4e4e\u662f\u4e00\u6837\u7684.</p> <p>\u533a\u522b\u662f\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e86 <code>https</code> \u7684\u534f\u8bae\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u914d\u7f6e\u4e86 <code>ca.cart</code> \u548c <code>token</code> \u8fd9\u4e24\u4e2a\u6587\u4ef6\uff0c\u8fd9\u4e24\u4e2a\u6587\u4ef6\u662f <code>Pod</code> \u542f\u52a8\u540e\u81ea\u52a8\u6ce8\u5165\u8fdb\u6765\u7684\uff0c\u901a\u8fc7\u8fd9\u4e24\u4e2a\u6587\u4ef6\u6211\u4eec\u53ef\u4ee5\u5728 <code>Pod</code> \u4e2d\u8bbf\u95ee <code>apiserver</code></p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u7684 <code>__address__</code> \u4e0d\u5728\u662f <code>nodeip</code> \u4e86\uff0c\u800c\u662f <code>kubernetes</code> \u5728\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u5730\u5740\uff0c\u7136\u540e\u52a0\u4e0a<code>__metrics_path__</code> \u7684\u8bbf\u95ee\u8def\u5f84\uff1a<code>/api/v1/nodes/${1}/proxy/metrics/cadvisor</code>\uff0c\u73b0\u5728\u540c\u6837\u66f4\u65b0\u4e0b\u914d\u7f6e\uff0c\u7136\u540e\u67e5\u770b <code>Targets</code> \u8def\u5f84\uff1a</p> <p></p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5207\u6362\u5230 <code>Graph</code> \u8def\u5f84\u4e0b\u9762\u67e5\u8be2\u5bb9\u5668\u76f8\u5173\u6570\u636e\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6765\u67e5\u8be2\u96c6\u7fa4\u4e2d\u6240\u6709 <code>Pod</code> \u7684 <code>CPU</code> \u4f7f\u7528\u60c5\u51b5\uff0c\u8fd9\u91cc\u7528\u7684\u6570\u636e\u6307\u6807\u662f <code>container_cpu_usage_seconds_total</code>\uff0c\u7136\u540e\u53bb\u9664\u4e00\u4e9b\u65e0\u6548\u7684\u6570\u636e\uff0c\u67e5\u8be21\u5206\u949f\b\u5185\u7684\u6570\u636e\uff0c\u7531\u4e8e\u67e5\u8be2\u5230\u7684\u6570\u636e\u90fd\u662f\u5bb9\u5668\u76f8\u5173\u7684\uff0c\u6700\u597d\u8981\u5b89\u88c5 <code>Pod</code> \u6765\u8fdb\u884c\u805a\u5408\uff0c\u5bf9\u5e94\u7684<code>promQL</code>\u8bed\u53e5\u5982\u4e0b\uff1a</p> <pre><code>sum by (pod_name)(rate(container_cpu_usage_seconds_total{image!=\"\", pod_name!=\"\"}[1m] ))\n</code></pre> <p></p> <p><code>prometheus cadvisor graph</code></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u7ed3\u679c\u5c31\u662f\u96c6\u7fa4\u4e2d\u7684\u6240\u6709 Pod \u57281\u5206\u949f\u4e4b\u5185\u7684 CPU \u4f7f\u7528\u60c5\u51b5\u7684\u66f2\u7ebf\u56fe\uff0c\u5f53\u7136\u8fd8\u6709\u5f88\u591a\u6570\u636e\u53ef\u4ee5\u83b7\u53d6\u5230\uff0c\u6211\u4eec\u540e\u9762\u5728\u9700\u8981\u7684\u65f6\u5019\u518d\u548c\u5927\u5bb6\u4ecb\u7ecd\u3002</p>"},{"location":"chap3/7Adv_K8S_Resource_monitor/#2-apiserver","title":"2 apiserver \u76d1\u63a7","text":"<p><code>apiserver</code> \u4f5c\u4e3a <code>Kubernetes</code> \u6700\u6838\u5fc3\u7684\u7ec4\u4ef6\uff0c\u5f53\u7136\u4ed6\u7684\u76d1\u63a7\u4e5f\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\uff0c\u5bf9\u4e8e <code>apiserver</code> \u7684\u76d1\u63a7\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>kubernetes</code> \u7684 <code>Service</code> \u6765\u83b7\u53d6\uff1a</p> <pre><code>$ kubectl get services\nNAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE\nkubernetes      ClusterIP   10.254.0.1      &lt;none&gt;        443/TCP        34d\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a <code>Service</code> \u5c31\u662f\u6211\u4eec\u96c6\u7fa4\u7684 <code>apiserver</code> \u5728\u96c6\u7fa4\u5185\u90e8\u7684 <code>Service</code> \u5730\u5740\uff0c\u8981\u81ea\u52a8\u53d1\u73b0 <code>Service</code> \u7c7b\u578b\u7684\u670d\u52a1\uff0c\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230 <code>role</code> \u4e3a <code>Endpoints</code> \u7684 <code>kubernetes_sd_configs</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 <code>ConfigMap</code> \u5bf9\u8c61\u4e2d\u6dfb\u52a0\u4e0a\u4e00\u4e2a <code>Endpoints</code> \u7c7b\u578b\u7684\u670d\u52a1\u7684\u76d1\u63a7\u4efb\u52a1\uff1a</p> <pre><code>- job_name: 'kubernetes-apiservers'\n  kubernetes_sd_configs:\n  - role: endpoints\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u4efb\u52a1\u662f\u5b9a\u4e49\u7684\u4e00\u4e2a\u7c7b\u578b\u4e3a <code>endpoints</code> \u7684 <code>kubernetes_sd_configs</code>\uff0c\u6dfb\u52a0\u5230 <code>Prometheus</code> \u7684 <code>ConfigMap</code> \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u7136\u540e\u66f4\u65b0\u914d\u7f6e\uff1a</p> <pre><code>$ kubectl delete -f prome-cm.yaml\n$ kubectl create -f prome-cm.yaml\n# \u9694\u4e00\u4f1a\u513f\u6267\u884creload\u64cd\u4f5c\n\n$ kubectl get svc -n kube-ops\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE\nprometheus   NodePort    10.102.74.90    &lt;none&gt;        9090:30358/TCP                   14d\n\n$ curl -X POST \"http://10.102.74.90:9090/-/reload\"\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u518d\u53bb\u67e5\u770b <code>Prometheus</code> \u7684 <code>Dashboard</code> \u7684 <code>target</code> \u9875\u9762\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\b\u770b\u5230 <code>kubernetes-apiservers</code> \u4e0b\u9762\u51fa\u73b0\u4e86\u5f88\u591a\u5b9e\u4f8b\uff0c\u8fd9\u662f\u56e0\u4e3a\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u662f <code>Endpoints</code> \u7c7b\u578b\u7684\u670d\u52a1\u53d1\u73b0\uff0c\u6240\u4ee5 <code>Prometheus</code> \u628a\u6240\u6709\u7684 <code>Endpoints</code> \u670d\u52a1\u90fd\u6293\u53d6\u8fc7\u6765\u4e86\uff0c\u540c\u6837\u7684\uff0c\u4e0a\u9762\u6211\u4eec\u9700\u8981\u7684\u670d\u52a1\u540d\u4e3a <code>kubernetes</code>\u8fd9\u4e2a <code>apiserver</code> \u7684\u670d\u52a1\u4e5f\u5728\u8fd9\u4e2a\u5217\u8868\u4e4b\u4e2d\uff0c\u90a3\u4e48\u6211\u4eec\u5e94\u8be5\u600e\u6837\u6765\u8fc7\u6ee4\u51fa\u8fd9\u4e2a\u670d\u52a1\u6765\u5462\uff1f</p> <p>\u8fd8\u8bb0\u5f97\u4e0a\u8282\u8bfe\u7684 <code>relabel_configs</code> \u5417\uff1f\u6ca1\u9519\uff0c\u540c\u6837\u6211\u4eec\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a\u914d\u7f6e\uff0c\u53ea\u662f\u6211\u4eec\u8fd9\u91cc\u4e0d\u662f\u4f7f\u7528<code>replace</code> \u8fd9\u4e2a\u52a8\u4f5c\u4e86\uff0c\u800c\u662f<code>keep</code>\uff0c\u5c31\u662f\u53ea\u628a\u7b26\u5408\u6211\u4eec\u8981\u6c42\u7684\u7ed9\u4fdd\u7559\u4e0b\u6765\uff0c\u54ea\u4e9b\u624d\u662f\u7b26\u5408\u6211\u4eec\u8981\u6c42\u7684\u5462\uff1f</p> <p>\u6211\u4eec\u53ef\u4ee5\u628a\u9f20\u6807\u653e\u7f6e\u5728\u4efb\u610f\u4e00\u4e2a <code>target</code> \u4e0a\uff0c\u53ef\u4ee5\u67e5\u770b\u5230 <code>Before relabeling</code> \u91cc\u9762\u6240\u6709\u7684\u5143\u6570\u636e\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u8fc7\u6ee4\u7684\u670d\u52a1\u662f <code>default</code> \u8fd9\u4e2a <code>namespace</code> \u4e0b\u9762\uff0c\u670d\u52a1\u540d\u4e3a <code>kubernetes</code> \u7684\u5143\u6570\u636e\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u5c31\u53ef\u4ee5\u6839\u636e\u5bf9\u5e94\u7684<code>__meta_kubernetes_namespace</code> \u548c <code>__meta_kubernetes_service_name</code> \u8fd9\u4e24\u4e2a\u5143\u6570\u636e\u6765 <code>relabel</code></p> <p></p> <p><code>prometheus before label</code></p> <p>\u53e6\u5916\u7531\u4e8e <code>kubernetes</code> \u8fd9\u4e2a\u670d\u52a1\u5bf9\u5e94\u7684\u7aef\u53e3\u662f<code>443</code>\uff0c\u9700\u8981\u4f7f\u7528 <code>https</code> \u534f\u8bae\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u4f7f\u7528 <code>https</code> \u7684\u534f\u8bae\uff0c\u5bf9\u5e94\u7684\u5c31\u9700\u8981\u5c06\u5bf9\u5e94\u7684 <code>ca</code> \u8bc1\u4e66\u914d\u7f6e\u4e0a\uff0c\u5982\u4e0b\uff1a</p> <pre><code>- job_name: 'kubernetes-apiservers'\n  kubernetes_sd_configs:\n  - role: endpoints\n  scheme: https\n  tls_config:\n    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]\n    action: keep\n    regex: default;kubernetes;https\n</code></pre> <p>\u73b0\u5728\u91cd\u65b0\u66f4\u65b0\u914d\u7f6e\u6587\u4ef6\u3001\u91cd\u65b0\u52a0\u8f7d <code>Prometheus</code>\uff0c\u5207\u6362\u5230 <code>Prometheus</code> \u7684 <code>Targets</code> \u8def\u5f84\u4e0b\u67e5\u770b\uff1a</p> <p></p> <p><code>promethues apiserver</code></p> <p>\u73b0\u5728\u53ef\u4ee5\u770b\u5230 <code>kubernetes-apiserver</code> \u8fd9\u4e2a\u4efb\u52a1\u4e0b\u9762\u53ea\u6709 <code>apiserver</code> \u8fd9\u4e00\u4e2a\u5b9e\u4f8b\u4e86\uff0c\u8bc1\u660e\u6211\u4eec\u7684 <code>relabel</code> \u662f\u6210\u529f\u7684\uff0c\u73b0\u5728\u6211\u4eec\u5207\u6362\u5230 <code>graph</code> \u8def\u5f84\u4e0b\u9762\u67e5\u770b\u4e0b\u91c7\u96c6\u5230\u6570\u636e\uff0c\u6bd4\u5982\u67e5\u8be2 <code>apiserver</code> \u7684\u603b\u7684\u8bf7\u6c42\u6570\uff1a</p> <pre><code>sum(rate(apiserver_request_count[1m]))\n</code></pre> <p><code>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u5230\u4e86 promql \u91cc\u9762\u7684 rate \u548c sum\u51fd\u6570\uff0c\b\u8868\u793a\u7684\u610f\u601d\u662f apiserver \u57281\u5206\u949f\u5185\u603b\u7684\u8bf7\u6c42\u6570\u3002</code></p> <p></p> <p><code>apiserver request count</code></p> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u5bf9 <code>Kubernetes APIServer</code> \u7684\u76d1\u63a7\u3002</p> <p>\u53e6\u5916\u5982\u679c\u6211\u4eec\u8981\u6765\u76d1\u63a7\u5176\u4ed6\u7cfb\u7edf\u7ec4\u4ef6\uff0c\u6bd4\u5982 <code>kube-controller-manager</code>\u3001<code>kube-scheduler</code> \u7684\u8bdd\u5e94\u8be5\u600e\u4e48\u505a\u5462\uff1f</p> <p>\u7531\u4e8e <code>apiserver</code> \u670d\u52a1 <code>namespace</code> \u5728 <code>default</code> \u4f7f\u7528\u9ed8\u8ba4\u7684 <code>Service kubernetes</code>\uff0c\u800c\u5176\u4f59\u7ec4\u4ef6\u670d\u52a1\u5728 <code>kube-system</code> \u8fd9\u4e2a\b <code>namespace</code> \u4e0b\u9762\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8981\u6765\u76d1\u63a7\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u8bdd\uff0c\u9700\u8981\u624b\u52a8\u521b\u5efa\u5355\u72ec\u7684 <code>Service</code>\uff0c\u5176\u4e2d <code>kube-sheduler</code> \u7684\u6307\u6807\u6570\u636e\u7aef\u53e3\u4e3a <code>10251</code>\uff0c<code>kube-controller-manager</code> \u5bf9\u5e94\u7684\u7aef\u53e3\u4e3a <code>10252</code>\uff0c\u5927\u5bb6\u53ef\u4ee5\b\u5c1d\u8bd5\u4e0b\u81ea\u5df1\u6765\u914d\u7f6e\u4e0b\u8fd9\u51e0\u4e2a\u7cfb\u7edf\u7ec4\u4ef6\u3002</p>"},{"location":"chap3/7Adv_K8S_Resource_monitor/#3-service","title":"3 Service \u7684\u76d1\u63a7","text":"<p>\u4e0a\u9762\u7684 apiserver \u5b9e\u9645\u4e0a\u662f\u4e00\u79cd\u7279\u6b8a\u7684 <code>Service</code>\uff0c\u73b0\u5728\u6211\u4eec\u540c\u6837\u6765\u914d\u7f6e\u4e00\u4e2a\u4efb\u52a1\u7528\u6765\u4e13\u95e8\u53d1\u73b0\u666e\u901a\u7c7b\u578b\u7684 <code>Service</code>\uff1a</p> <pre><code>- job_name: 'kubernetes-service-endpoints'\n  kubernetes_sd_configs:\n  - role: endpoints\n  relabel_configs:\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]\n    action: keep\n    regex: true\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\n    action: replace\n    target_label: __scheme__\n    regex: (https?)\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\n    action: replace\n    target_label: __metrics_path__\n    regex: (.+)\n  - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\n    action: replace\n    target_label: __address__\n    regex: ([^:]+)(?::\\d+)?;(\\d+)\n    replacement: $1:$2\n  - action: labelmap\n    regex: __meta_kubernetes_service_label_(.+)\n  - source_labels: [__meta_kubernetes_namespace]\n    action: replace\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_service_name]\n    action: replace\n    target_label: kubernetes_name\n</code></pre> <p>\u6ce8\u610f\u6211\u4eec\u8fd9\u91cc\b\u5728 <code>relabel_configs</code> \u533a\u57df\u505a\u4e86\u5927\u91cf\u7684\u914d\u7f6e\uff0c\u7279\u522b\u662f\u7b2c\u4e00\u4e2a\u4fdd\u7559<code>__meta_kubernetes_service_annotation_prometheus_io_scrape</code> \u4e3a<code>true</code>\u7684\u624d\u4fdd\u7559\u4e0b\u6765\uff0c\u8fd9\u5c31\u662f\b\u8bf4\u8981\u60f3\u81ea\u52a8\u53d1\u73b0\b\u96c6\u7fa4\u4e2d\u7684 <code>Service</code>\uff0c\u5c31\u9700\u8981\u6211\u4eec\u5728 <code>Service</code> \u7684 <code>annotation</code> \u533a\u57df\u6dfb\u52a0 <code>prometheus.io/scrape=true</code> \u7684\u58f0\u660e.</p> <p>\u73b0\u5728\u6211\u4eec\b\u5148\u5c06\u4e0a\u9762\u7684\u914d\u7f6e\u66f4\u65b0\uff0c\u67e5\u770b\u4e0b\u6548\u679c\uff1a</p> <p></p> <p><code>service endpoints</code></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>kubernetes-service-endpoints</code> \u8fd9\u4e00\u4e2a\u4efb\u52a1\u4e0b\u9762\u53ea\u53d1\u73b0\u4e86\u4e00\u4e2a\u670d\u52a1\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5728<code>relabel_configs</code> \b\u4e2d\u8fc7\u6ee4\u4e86 <code>annotation</code> \u6709 <code>prometheus.io/scrape=true</code> \u7684 <code>Service</code>\uff0c\u800c\u73b0\u5728\u6211\u4eec\u7cfb\u7edf\u4e2d\u53ea\u6709\u8fd9\u6837\u4e00\u4e2a\u670d\u52a1\u7b26\u5408\u8981\u6c42\uff0c\u6240\u4ee5\u53ea\u51fa\u73b0\u4e86\u4e00\u4e2a\u5b9e\u4f8b\u3002</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: redis\n  namespace: kube-ops\n  annotations:\n    prometheus.io/scrape: \"true\"\n    prometheus.io/port: \"9121\"\nspec:\n  selector:\n    app: redis\n  ports:\n  - name: redis\n    port: 6379\n    targetPort: 6379\n  - name: prom\n    port: 9121\n    targetPort: 9121\n</code></pre> <p>\u7531\u4e8e <code>redis</code> \u670d\u52a1\u7684 <code>metrics</code> \u63a5\u53e3\u5728<code>9121</code>\u8fd9\u4e2a <code>redis-exporter</code> \u670d\u52a1\u4e0a\u9762\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a<code>prometheus.io/port=9121</code>\u8fd9\u6837\u7684<code>annotations</code>\uff0c\u7136\u540e\u66f4\u65b0\u8fd9\u4e2a <code>Service</code>\uff1a</p> <pre><code>$ kubectl apply -f prome-redis-exporter.yaml\ndeployment.extensions \"redis\" unchanged\nservice \"redis\" changed\n</code></pre> <p></p> <p>\u8fd9\u6837\u4ee5\u540e\u6211\u4eec\u6709\u4e86\u65b0\u7684\u670d\u52a1\uff0c\u670d\u52a1\u672c\u8eab\u63d0\u4f9b\u4e86<code>/metrics</code> \u63a5\u53e3\uff0c\u6211\u4eec\u5c31\u5b8c\u5168\u4e0d\u9700\u8981\u7528\u9759\u6001\u7684\u65b9\u5f0f\u53bb\u914d\u7f6e\u4e86\uff0c\b\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u4e4b\u524d\u914d\u7f6e\u7684 <code>redis</code> \u7684\u9759\u6001\u914d\u7f6e\u53bb\u6389\u4e86\u3002</p> <p>\u540c\u6837\u7684\uff0c\u5927\u5bb6\u53ef\u4ee5\u81ea\u5df1\u53bb\u5c1d\u8bd5\u4e0b\u53bb\u914d\u7f6e\u4e0b\u81ea\u52a8\u53d1\u73b0 Pod\u3001ingress \u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u3002</p>"},{"location":"chap3/7Adv_K8S_Resource_monitor/#4-kube-state-metrics","title":"4 kube-state-metrics","text":"<p>\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u4e86\u81ea\u52a8\u53d1\u73b0 <code>Service</code>\uff08Pod\u4e5f\u662f\u4e00\u6837\u7684\uff09\u7684\u76d1\u63a7\uff0c\u4f46\u662f\u8fd9\u4e9b\u76d1\u63a7\u6570\u636e\u90fd\u662f\u5e94\u7528\u5185\u90e8\u7684\u76d1\u63a7\uff0c\u9700\u8981\u5e94\u7528\u672c\u8eab\u63d0\u4f9b\u4e00\u4e2a <code>/metrics</code> \u63a5\u53e3\uff0c\u6216\u8005\u5bf9\u5e94\u7684 <code>exporter</code> \u6765\u66b4\u9732\u5bf9\u5e94\u7684\u6307\u6807\u6570\u636e\uff0c\u4f46\u662f\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u4e0a <code>Pod</code>\u3001<code>DaemonSet</code>\u3001<code>Deployment</code>\u3001<code>Job</code>\u3001<code>CronJob</code> \u7b49\u5404\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u4e5f\u9700\u8981\u76d1\u63a7\uff0c\u8fd9\u4e5f\u53cd\u6620\u4e86\u4f7f\u7528\u8fd9\u4e9b\u8d44\u6e90\u90e8\u7f72\u7684\u5e94\u7528\u7684\u72b6\u6001\u3002</p> <p>\u4f46\u901a\u8fc7\u67e5\u770b\u524d\u9762\u4ece\u96c6\u7fa4\u4e2d\u62c9\u53d6\u7684\u6307\u6807(\u8fd9\u4e9b\u6307\u6807\u4e3b\u8981\u6765\u81ea <code>apiserver</code> \u548c <code>kubelet</code> \u4e2d\u96c6\u6210\u7684 <code>cAdvisor</code>)\uff0c\u5e76\u6ca1\u6709\u5177\u4f53\u7684\u5404\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u6307\u6807\u3002\u5bf9\u4e8e <code>Prometheus</code> \u6765\u8bf4\uff0c\u5f53\u7136\u662f\u9700\u8981\u5f15\u5165\u65b0\u7684 <code>exporter</code> \u6765\u66b4\u9732\u8fd9\u4e9b\u6307\u6807\uff0c<code>Kubernetes</code> \u63d0\u4f9b\u4e86\u4e00\u4e2a kube-state-metrics \u5c31\u662f\u6211\u4eec\u9700\u8981\u7684\u3002</p> <p><code>kube-state-metrics</code> \u5df2\u7ecf\u7ed9\u51fa\u4e86\u5728 <code>Kubernetes</code> \u90e8\u7f72\u7684 <code>manifest</code> \u5b9a\u4e49\u6587\u4ef6\uff0c\u6211\u4eec\u76f4\u63a5\u5c06\u4ee3\u7801 <code>Clone</code> \u5230\u96c6\u7fa4\u4e2d(\u80fd\u7528 <code>kubectl</code> \u5de5\u5177\u64cd\u4f5c\u5c31\u884c):</p> <pre><code>$ git clone https://github.com/kubernetes/kube-state-metrics.git\n$ cd kube-state-metrics/kubernetes\n$ kubectl create -f .\nclusterrolebinding.rbac.authorization.k8s.io \"kube-state-metrics\" created\nclusterrole.rbac.authorization.k8s.io \"kube-state-metrics\" created\ndeployment.apps \"kube-state-metrics\" created\nrolebinding.rbac.authorization.k8s.io \"kube-state-metrics\" created\nrole.rbac.authorization.k8s.io \"kube-state-metrics-resizer\" created\nserviceaccount \"kube-state-metrics\" created\nservice \"kube-state-metrics\" created\n</code></pre> <p>\u5c06 <code>kube-state-metrics</code> \u90e8\u7f72\u5230 <code>Kubernetes</code> \u4e0a\u4e4b\u540e\uff0c\u5c31\u4f1a\u53d1\u73b0 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u7684 <code>Prometheus</code> \u4f1a\u5728<code>kubernetes-service-endpoints</code> \u8fd9\u4e2a <code>job</code> \u4e0b\u81ea\u52a8\u670d\u52a1\u53d1\u73b0 <code>kube-state-metrics</code>\uff0c\u5e76\u5f00\u59cb\u62c9\u53d6 <code>metrics</code>\uff0c\u8fd9\u662f\u56e0\u4e3a\u90e8\u7f72 <code>kube-state-metrics</code> \u7684 <code>manifest</code> \u5b9a\u4e49\u6587\u4ef6 <code>kube-state-metrics-service.yaml</code> \u5bf9 <code>Service</code> \u7684\u5b9a\u4e49\u5305\u542b <code>prometheus.io/scrape: 'true'</code>\u8fd9\u6837\u7684\u4e00\u4e2a <code>annotation</code>\uff0c\u56e0\u6b64 <code>kube-state-metrics</code> \u7684 <code>endpoint</code> \u53ef\u4ee5\u88ab <code>Prometheus</code> \u81ea\u52a8\u670d\u52a1\u53d1\u73b0</p>"},{"location":"chap3/8Adv_K8S_Grafana/","title":"\u7b2c\u516b\u8282 Grafana \u5728 Kubernetes \u4e2d\u7684\u4f7f\u7528","text":""},{"location":"chap3/8Adv_K8S_Grafana/#1","title":"1 \u5b89\u88c5","text":"<p><code>grafana</code> \u662f\u4e00\u4e2a\u53ef\u89c6\u5316\u9762\u677f\uff0c\u6709\u7740\u975e\u5e38\u6f02\u4eae\u7684\u56fe\u8868\u548c\u5e03\u5c40\u5c55\u793a\uff0c\u529f\u80fd\u9f50\u5168\u7684\u5ea6\u91cf\u4eea\u8868\u76d8\u548c\u56fe\u5f62\u7f16\u8f91\u5668\uff0c\u652f\u6301 <code>Graphite</code>\u3001<code>zabbix</code>\u3001<code>InfluxDB</code>\u3001<code>Prometheus</code>\u3001<code>OpenTSDB</code>\u3001<code>Elasticsearch</code> \u7b49\u4f5c\u4e3a\u6570\u636e\u6e90\uff0c\u6bd4 Prometheus \u81ea\u5e26\u7684\u56fe\u8868\u5c55\u793a\u529f\u80fd\u5f3a\u5927\u592a\u591a\uff0c\u66f4\u52a0\u7075\u6d3b\uff0c\u6709\u4e30\u5bcc\u7684\u63d2\u4ef6\uff0c\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06 <code>grafana</code> \u5b89\u88c5\u5230 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\uff0c\u7b2c\u4e00\u6b65\u540c\u6837\u662f\u53bb\u67e5\u770b <code>grafana</code> \u7684 <code>docker</code> \u955c\u50cf\u7684\u4ecb\u7ecd\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 <code>dockerhub</code> \u4e0a\u53bb\u641c\u7d22\uff0c\u4e5f\u53ef\u4ee5\u5728\u5b98\u7f51\u53bb\u67e5\u770b\u76f8\u5173\u8d44\u6599\uff0c\u955c\u50cf\u5730\u5740\u5982\u4e0b\uff1ahttps://hub.docker.com/r/grafana/grafana/\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4ecb\u7ecd\u4e2d\u8fd0\u884c grafana \u5bb9\u5668\u7684\u547d\u4ee4\u975e\u5e38\u7b80\u5355\uff1a</p> <pre><code>$ docker run -d --name=grafana -p 3000:3000 grafana/grafana\n</code></pre> <p>\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u9700\u8981\u6ce8\u610f\u7684\u662f Changelog \u4e2d <code>v5.1.0</code> \u7248\u672c\u7684\u66f4\u65b0\u4ecb\u7ecd\uff1a</p> <ul> <li>Major restructuring of the container</li> <li>Usage of chown removed</li> <li>File permissions incompatibility with previous versions</li> <li>user id changed from 104 to 472</li> <li>group id changed from 107 to 472</li> <li>Runs as the grafana user by default (instead of root)</li> <li>All default volumes removed</li> </ul> <p>\u7279\u522b\u9700\u8981\u6ce8\u610f\u7b2c3\u6761\uff0c<code>userid</code> \u548c <code>groupid</code> \u90fd\u6709\u6240\u53d8\u5316\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u8fd0\u884c\u7684\u5bb9\u5668\u7684\u65f6\u5019\u9700\u8981\u6ce8\u610f\u8fd9\u4e2a\u53d8\u5316\u3002\u73b0\u5728\u6211\u4eec\u5c06\u8fd9\u4e2a\u5bb9\u5668\u8f6c\u5316\u6210 Kubernetes \u4e2d\u7684 Pod\uff1a(<code>grafana.yaml</code>)</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: grafana\n  namespace: kube-ops\n  labels:\n    app: grafana\nspec:\n  revisionHistoryLimit: 10\n  template:\n    metadata:\n      labels:\n        app: grafana\n    spec:\n      containers:\n      - name: grafana\n        image: grafana/grafana:5.3.4\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 3000\n          name: grafana\n        env:\n        - name: GF_SECURITY_ADMIN_USER\n          value: admin\n        - name: GF_SECURITY_ADMIN_PASSWORD\n          value: admin321\n        readinessProbe:\n          failureThreshold: 10\n          httpGet:\n            path: /api/health\n            port: 3000\n            scheme: HTTP\n          initialDelaySeconds: 60\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 30\n        livenessProbe:\n          failureThreshold: 3\n          httpGet:\n            path: /api/health\n            port: 3000\n            scheme: HTTP\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 1\n        resources:\n          limits:\n            cpu: 100m\n            memory: 256Mi\n          requests:\n            cpu: 100m\n            memory: 256Mi\n        volumeMounts:\n        - mountPath: /var/lib/grafana\n          subPath: grafana\n          name: storage\n      securityContext:\n        fsGroup: 472\n        runAsUser: 472\n      volumes:\n      - name: storage\n        persistentVolumeClaim:\n          claimName: grafana\n</code></pre> <p>\u6211\u4eec\u4f7f\u7528\u4e86\u6700\u65b0\u7684\u955c\u50cf <code>grafana/grafana:5.3.4</code> \uff0c\u7136\u540e\u6dfb\u52a0\u4e86\u76d1\u63a7\u68c0\u67e5\u3001\u8d44\u6e90\u58f0\u660e\uff0c</p> <p>\u53e6\u5916\u4e24\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u73af\u5883\u53d8\u91cf<code>GF_SECURITY_ADMIN_USER</code> \u548c <code>GF_SECURITY_ADMIN_PASSWORD</code>\uff0c\u7528\u6765\u914d\u7f6e <code>grafana</code> \u7684\u7ba1\u7406\u5458\u7528\u6237\u548c\u5bc6\u7801\u7684</p> <p>\u7531\u4e8e <code>grafana</code> \u5c06 <code>dashboard</code>\u3001<code>\u63d2\u4ef6</code>\u8fd9\u4e9b\u6570\u636e\u4fdd\u5b58\u5728<code>/var/lib/grafana</code>\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u9762\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u5982\u679c\u9700\u8981\u505a\u6570\u636e\u6301\u4e45\u5316\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u9488\u5bf9\u8fd9\u4e2a\u76ee\u5f55\u8fdb\u884c <code>volume</code> \u6302\u8f7d\u58f0\u660e\uff0c</p> <p>\u5176\u4ed6\u7684\u548c\u6211\u4eec\u4e4b\u524d\u7684 <code>Deployment</code> \u6ca1\u4ec0\u4e48\u533a\u522b\uff0c\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u521a\u521a\u63d0\u5230\u7684 <code>Changelog</code> \u4e2d <code>grafana</code> \u7684 <code>userid</code> \u548c <code>groupid</code> \u6709\u6240\u53d8\u5316\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u589e\u52a0\u4e00\u4e2a<code>securityContext</code>\u7684\u58f0\u660e\u6765\u8fdb\u884c\u58f0\u660e\u3002</p> <pre><code> securityContext:\n   fsGroup: 472\n   runAsUser: 472\n</code></pre> <p>\u5f53\u7136\u5982\u679c\u8981\u4f7f\u7528\u4e00\u4e2a <code>pvc</code>\u5bf9\u8c61\u6765\u6301\u4e45\u5316\u6570\u636e\uff0c\u6211\u4eec\u5c31\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a\u53ef\u7528\u7684 pv \u4f9b pvc \u7ed1\u5b9a\u4f7f\u7528\uff1a\uff08<code>grafana-volume.yaml</code>\uff09</p> <p>\u5f53\u7136\u5982\u679c\u8981\u4f7f\u7528\u4e00\u4e2a <code>pvc</code> \u5bf9\u8c61\u6765\u6301\u4e45\u5316\u6570\u636e\uff0c\u6211\u4eec\u5c31\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a\u53ef\u7528\u7684 <code>pv</code> \u4f9b <code>pvc</code> \u7ed1\u5b9a\u4f7f\u7528\uff1a\uff08<code>grafana-volume.yaml</code>\uff09</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: grafana\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Recycle\n  nfs:\n    server: 10.151.30.57\n    path: /data/k8s\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: grafana\n  namespace: kube-ops\nspec:\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n</code></pre> <p>\u6700\u540e\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u5916\u66b4\u9732 <code>grafana</code> \u8fd9\u4e2a\u670d\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u5bf9\u5e94\u7684 <code>Service</code> \u5bf9\u8c61\uff0c\u5f53\u7136\u7528 <code>NodePort</code> \u6216\u8005\u518d\u5efa\u7acb\u4e00\u4e2a <code>ingress</code> \u5bf9\u8c61\u90fd\u662f\u53ef\u884c\u7684\uff1a(<code>grafana-svc.yaml</code>)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: grafana\n  namespace: kube-ops\n  labels:\n    app: grafana\nspec:\n  type: NodePort\n  ports:\n    - port: 3000\n  selector:\n    app: grafana\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f grafana-volume.yaml\npersistentvolume \"grafana\" created\npersistentvolumeclaim \"grafana\" created\n$ kubectl create -f grafana-deploy.yaml\ndeployment.extensions \"grafana\" created\n$ kubectl create -f grafana-svc.yaml\nservice \"grafana\" created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b <code>grafana</code> \u5bf9\u5e94\u7684 <code>Pod</code> \u662f\u5426\u6b63\u5e38</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                          READY     STATUS             RESTARTS   AGE\ngrafana-5f7b965b55-wxvvk      0/1       CrashLoopBackOff   1          22s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u7684\u72b6\u6001\u662f<code>CrashLoopBackOff</code>\uff0c\u5e76\u6ca1\u6709\u6b63\u5e38\u542f\u52a8\uff0c\u6211\u4eec\u67e5\u770b\u4e0b\u8fd9\u4e2a <code>Pod</code> \u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs -f grafana-5f7b965b55-wxvvk -n kube-ops\nGF_PATHS_DATA='/var/lib/grafana' is not writable.\nYou may have issues with file permissions, more information here: http://docs.grafana.org/installation/docker/#migration-from-a-previous-version-of-the-docker-container-to-5-1-or-later\nmkdir: cannot create directory '/var/lib/grafana/plugins': Permission denied\n</code></pre> <p>\u4e0a\u9762\u7684\u9519\u8bef\u662f\u57285.1\u7248\u672c\u4e4b\u540e\u624d\u4f1a\u51fa\u73b0\u7684\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e4b\u524d\u7684\u7248\u672c\u6765\u89c4\u907f\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\u662f\u65e5\u5fd7\u4e2d\u9519\u8bef\u5f88\u660e\u663e\u5c31\u662f<code>/var/lib/grafana</code> \u76ee\u5f55\u7684\u6743\u9650\u95ee\u9898\uff0c\u8fd9\u8fd8\u662f\u56e0\u4e3a5.1\u7248\u672c\u540e <code>groupid</code> \u66f4\u6539\u4e86\u5f15\u8d77\u7684\u95ee\u9898\uff0c\u6211\u4eec\u8fd9\u91cc\u589e\u52a0\u4e86 <code>securityContext</code> \uff0c\u4f46\u662f\u6211\u4eec\u5c06\u76ee\u5f55 <code>/var/lib/grafana</code> \u6302\u8f7d\u5230 <code>pvc</code> \u8fd9\u8fb9\u540e\u76ee\u5f55\u7684\u62e5\u6709\u8005\u5e76\u4e0d\u662f\u4e0a\u9762\u7684 <code>grafana(472)</code> \u8fd9\u4e2a\u7528\u6237\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u66f4\u6539\u4e0b\u8fd9\u4e2a\u76ee\u5f55\u7684\u6240\u5c5e\u7528\u6237\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u4e00\u4e2a Job \u4efb\u52a1\u53bb\u66f4\u6539\u4e0b\u8be5\u76ee\u5f55\u7684\u6240\u5c5e\u7528\u6237\uff1a\uff08<code>grafana-chown-job.yaml</code>\uff09</p> <pre><code>apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: grafana-chown\n  namespace: kube-ops\nspec:\n  template:\n    spec:\n      restartPolicy: Never\n      containers:\n      - name: grafana-chown\n        command: [\"chown\", \"-R\", \"472:472\", \"/var/lib/grafana\"]\n        image: busybox\n        imagePullPolicy: IfNotPresent\n        volumeMounts:\n        - name: storage\n          subPath: grafana\n          mountPath: /var/lib/grafana\n      volumes:\n      - name: storage\n        persistentVolumeClaim:\n          claimName: grafana\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u5229\u7528\u4e00\u4e2a <code>busybox</code> \u955c\u50cf\u5c06 <code>/var/lib/grafana</code> \u76ee\u5f55\u66f4\u6539\u6210\u4e86<code>472</code> \u8fd9\u4e2a <code>user</code> \u548c <code>group</code>\uff0c\u4e0d\u8fc7\u8fd8\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e0b\u9762\u7684 <code>volumeMounts</code> \u548c <code>volumes</code> \u9700\u8981\u548c\u4e0a\u9762\u7684 <code>Deployment</code> \u5bf9\u5e94\u4e0a\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5220\u9664\u4e4b\u524d\u521b\u5efa\u7684 <code>Deployment</code> \u5bf9\u8c61\uff0c\u91cd\u65b0\u521b\u5efa\uff1a</p> <pre><code>$ kubectl delete -f grafana-deploy.yaml\ndeployment.extensions \"grafana\" deleted\n$ kubectl create -f grafana-deploy.yaml\ndeployment.extensions \"grafana\" created\n$ kubectl create -f grafana-chown-job.yaml\njob.batch \"grafana-chown\" created\n</code></pre> <p>\u91cd\u65b0\u6267\u884c\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770b\u4e0b\u4e0a\u9762\u7684\u521b\u5efa\u7684\u8d44\u6e90\u5bf9\u8c61\u662f\u5426\u6b63\u786e\u4e86\uff1a</p> <pre><code>$ kubectl get pod -n kube-ops\nNAME                          READY     STATUS      RESTARTS   AGE\ngrafana-79477fbb7c-2mb84      1/1       Running     0          2m\ngrafana-chown-k8zt7           0/1       Completed   0          2m\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u72b6\u6001\u4e3a<code>Completed</code> \u7684 <code>Pod</code>\uff0c\u8fd9\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u7528\u6765\u66f4\u6539 <code>grafana</code> \u76ee\u5f55\u6743\u9650\u7684 <code>Pod</code>\uff0c\u662f\u4e00\u4e2a <code>Job</code> \u4efb\u52a1\uff0c\u6240\u4ee5\u6267\u884c\u6210\u529f\u540e\u5c31\u9000\u51fa\u4e86\uff0c\u72b6\u6001\u53d8\u6210\u4e86 <code>Completed</code>\uff0c\u800c\u4e0a\u9762\u7684 <code>grafana</code> \u7684 <code>Pod</code> \u4e5f\u5df2\u7ecf\u662f<code>Running</code> \u72b6\u6001\u4e86\uff0c\u53ef\u4ee5\u67e5\u770b\u4e0b\u8be5 <code>Pod</code> \u7684\u65e5\u5fd7\u786e\u8ba4\u4e0b\uff1a</p> <pre><code>$ kubectl logs -f grafana-79477fbb7c-2mb84 -n kube-ops\nt=2018-11-14T19:57:31+0000 lvl=info msg=\"Starting Grafana\" logger=server version=5.3.4 commit=69630b9 compiled=2018-11-13T12:19:12+0000\n......\nlogger=settings var=\"GF_SECURITY_ADMIN_USER=admin\"\nt=2018-11-14T19:57:31+0000 lvl=info msg=\"Config overridden from Environment variable\"\n......\nt=2018-11-14T19:57:32+0000 lvl=info msg=\"Initializing Stream Manager\"\nt=2018-11-14T19:57:32+0000 lvl=info msg=\"HTTP Server Listen\" logger=http.server address=0.0.0.0:3000 protocol=http subUrl= socket=\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684\u65e5\u5fd7\u4fe1\u606f\u5c31\u8bc1\u660e\u6211\u4eec\u7684 <code>grafana</code> \u7684 <code>Pod</code> \u5df2\u7ecf\u6b63\u5e38\u542f\u52a8\u8d77\u6765\u4e86\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u67e5\u770b <code>Service</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get svc -n kube-ops\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE\ngrafana      NodePort    10.97.46.27     &lt;none&gt;        3000:30105/TCP                   1h\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u4f7f\u7528<code>http://&lt;\u4efb\u610f\u8282\u70b9IP:30105&gt;</code>\u6765\u8bbf\u95ee <code>grafana</code> \u8fd9\u4e2a\u670d\u52a1\u4e86\uff1a </p> <p></p> <p>\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u4e86\u7ba1\u7406\u5458\u7684\uff0c\u6240\u4ee5\u7b2c\u4e00\u6b21\u6253\u5f00\u7684\u65f6\u5019\u4f1a\u8df3\u8f6c\u5230\u767b\u5f55\u754c\u9762\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u7528\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u4e24\u4e2a\u73af\u5883\u53d8\u91cf\u7684\u503c\u6765\u8fdb\u884c\u767b\u5f55\u4e86\uff0c\u767b\u5f55\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u8fdb\u5165\u5230\u4e0b\u9762 <code>Grafana</code> \u7684\u9996\u9875\uff1a</p> <p></p> <p>\u914d\u7f6e</p> <p>\u5728\u4e0a\u9762\u7684\u9996\u9875\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u5b89\u88c5\u4e86 <code>Grafana</code>\uff0c\u63a5\u4e0b\u6765\u70b9\u51fb <code>Add data source</code> \u8fdb\u5165\u6dfb\u52a0\u6570\u636e\u6e90\u754c\u9762\u3002</p>"},{"location":"chap3/8Adv_K8S_Grafana/#2","title":"2 \u6570\u636e\u6e90","text":"<p>\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9\u914d\u7f6e\u7684\u6570\u636e\u6e90\u662f <code>Prometheus</code>\uff0c\b\u6240\u4ee5\u9009\u62e9\u8fd9\u4e2a <code>Type</code> \u5373\u53ef\uff0c\u7ed9\u6539\u6570\u636e\u6e90\u6dfb\u52a0\u4e00\u4e2a <code>name\uff1aprometheus-ds</code>\uff0c\u6700\u4e3b\u8981\u7684\u662f\u4e0b\u9762 <code>HTTP</code> \u533a\u57df\u662f\u914d\u7f6e\u6570\u636e\u6e90\u7684\u8bbf\u95ee\u6a21\u5f0f\u3002</p> <p>\u8bbf\u95ee\u6a21\u5f0f\u662f\u7528\u6765\u63a7\u5236\u5982\u4f55\u5904\u7406\u5bf9\u6570\u636e\u6e90\u7684\u8bf7\u6c42\u7684\uff1a</p> <ul> <li>\u670d\u52a1\u5668(<code>Server</code>)\u8bbf\u95ee\u6a21\u5f0f\uff08\u9ed8\u8ba4\uff09\uff1a\u6240\u6709\u8bf7\u6c42\u90fd\u5c06\u4ece\u6d4f\u89c8\u5668\u53d1\u9001\u5230 <code>Grafana</code> \u540e\u7aef\u7684\u670d\u52a1\u5668\uff0c\u540e\u8005\u53c8\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u6570\u636e\u6e90\uff0c\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\b\u907f\u514d\u4e00\u4e9b\u8de8\u57df\u95ee\u9898\uff0c\u5176\u5b9e\u5c31\u662f\u5728 <code>Grafana</code> \u540e\u7aef\u505a\u4e86\u4e00\u6b21\u8f6c\u53d1\uff0c\u9700\u8981\u4ece<code>Grafana</code> \u540e\u7aef\u670d\u52a1\u5668\u8bbf\u95ee\u8be5 <code>URL</code>\u3002</li> <li>\u6d4f\u89c8\u5668(<code>Browser</code>)\u8bbf\u95ee\u6a21\u5f0f\uff1a\u6240\u6709\u8bf7\u6c42\u90fd\u5c06\u4ece\u6d4f\u89c8\u5668\u76f4\u63a5\u53d1\u9001\u5230\u6570\u636e\u6e90\uff0c\u4f46\u662f\u6709\u53ef\u80fd\u4f1a\u6709\u4e00\u4e9b\u8de8\u57df\u7684\u9650\u5236\uff0c\u4f7f\u7528\u6b64\u8bbf\u95ee\u6a21\u5f0f\uff0c\u9700\u8981\u4ece\u6d4f\u89c8\u5668\u76f4\u63a5\u8bbf\u95ee\u8be5 URL\u3002</li> </ul> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9 <code>Prometheus</code> \u901a\u8fc7 <code>NodePort</code> \u7684\u65b9\u5f0f\u7684\u5bf9\u5916\u66b4\u9732\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9\u662f\u53ef\u4ee5\u4f7f\u7528\u6d4f\u89c8\u5668\u8bbf\u95ee\u6a21\u5f0f\u76f4\u63a5\u8bbf\u95ee <code>Prometheus</code> \u7684\u5916\u7f51\u5730\u5740\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u663e\u7136\u4e0d\u662f\u6700\u597d\u7684\uff0c\u76f8\u5f53\u4e8e\u8d70\u7684\u662f\u5916\u7f51.</p> <p>\u800c\u6211\u4eec\u8fd9\u91cc <code>Prometheus</code> \u548c <code>Grafana</code> \u90fd\u5904\u4e8e <code>kube-ops</code> \u8fd9\u540c\u4e00\u4e2a\b <code>namespace</code> \u4e0b\u9762\uff0c\u662f\u5728\u96c6\u7fa4\u5185\u90e8\u76f4\u63a5\b\u901a\u8fc7 <code>DNS</code> \u7684\u5f62\u5f0f\u5c31\u53ef\u4ee5\u8bbf\u95ee\u4e86\uff0c\u800c\u4e14\u8fd8\u90fd\u662f\u8d70\u7684\u5185\u7f51\u6d41\u91cf\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7528\u670d\u52a1\u5668\u8bbf\u95ee\u6a21\u5f0f\u663e\u7136\u66f4\u597d\uff0c\u6570\u636e\u6e90\u5730\u5740\uff1a<code>http://prometheus:9090</code>\uff08\u56e0\u4e3a\u5728\u540c\u4e00\u4e2a namespace \u4e0b\u9762\u6240\u4ee5\u76f4\u63a5\u7528\b Service \b\u540d\u4e5f\u53ef\u4ee5\uff0c</p> <p>\u7136\u540e\u5176\u4ed6\u7684\u914d\u7f6e\u4fe1\u606f\u5c31\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u4e86\uff0c\u6bd4\u5982 <code>Auth \u8ba4\u8bc1</code>\uff0c\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\uff0c\u6240\u4ee5\u8df3\u8fc7\u5373\u53ef\uff0c\u70b9\u51fb\u6700\u4e0b\u65b9\u7684<code>Save &amp; Test</code>\u63d0\u793a\u6210\u529f\u8bc1\u660e\u6211\u4eec\u7684\u6570\u636e\u6e90\u914d\u7f6e\u6b63\u786e\uff1a</p> <p></p> <p>\u6570\u636e\u6e90\u6dfb\u52a0\u5b8c\u6210\u540e\uff0c\u5c31\u53ef\u4ee5\u6765\u6dfb\u52a0 <code>Dashboard</code> \u4e86\u3002</p>"},{"location":"chap3/8Adv_K8S_Grafana/#3-dashboard","title":"3 Dashboard","text":"<p>\u540c\u6837\uff0c\u5207\u6362\u5230\u4e3b\u9875\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u624b\u52a8\b\u65b0\u5efa\u4e00\u4e2a <code>Dashboard</code> \uff0c\u9664\u6b64\u4e4b\u5916\uff0c<code>grafana</code> \u7684\u5b98\u65b9\u7f51\u7ad9\u4e0a\u8fd8\u6709\u5f88\u591a\u516c\u5171\u7684 <code>\bDashboard</code> \u53ef\u4ee5\u4f9b\u6211\u4eec\u4f7f\u7528\uff0c\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528Kubernetes cluster monitoring (via Prometheus)\u8fd9\u4e2a Dashboard \u6765\u5c55\u793a Kubernetes \u96c6\u7fa4\u7684\u76d1\u63a7\u4fe1\u606f\uff0c\u5728\u5de6\u4fa7\u4fa7\u8fb9\u680f Create \u4e2d\u70b9\u51fb <code>import</code> \u5bfc\u5165\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0a\u9762\u7f16\u53f7<code>162</code>\u7684 <code>dashboard</code> \u4e0b\u8f7d\u5230\u672c\u5730\uff0c\u7136\u540e\u8fd9\u91cc\u91cd\u65b0\u4e0a\u4f20\u5373\u53ef\uff0c\u4e5f\u53ef\u4ee5\u5728\u4e0a\u9762\u7684\u6587\u672c\u6846\u4e2d\u76f4\u63a5\u8f93\u5165162\u7f16\u53f7\u56de\u8f66\u5373\u53ef\uff0c\u5bfc\u5165\u8fd9\u4e2a <code>dashboard</code>\uff1a</p> <p></p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u6267\u884c\u4e0a\u9762\u7684 <code>import</code> \u4e4b\u524d\u8981\u8bb0\u5f97\u9009\u62e9\u6211\u4eec\u7684<code>prometheus-ds</code>\u8fd9\u4e2a\u540d\u5b57\u7684\u6570\u636e\u6e90\uff0c\u6267\u884c<code>import</code>\u64cd\u4f5c\uff0c\u5c31\u53ef\u4ee5\u8fdb\u5165\u5230 <code>dashboard</code> \u9875\u9762\uff1a</p> <p></p> <p>\b\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>dashboard</code> \u9875\u9762\u4e0a\u51fa\u73b0\u4e86\u5f88\u591a\u6f02\u4eae\u7684\u56fe\u8868\uff0c\u4f46\u662f\u770b\u4e0a\u53bb\u6570\u636e\u4e0d\u6b63\u5e38\uff0c\u8fd9\u662f\u56e0\u4e3a\u8fd9\u4e2a <code>dashboard</code> \u91cc\u9762\u9700\u8981\u7684\u6570\u636e\u6307\u6807\u540d\u79f0\u548c\u6211\u4eec\b <code>Prometheus</code> \u91cc\u9762\u91c7\u96c6\u5230\u7684\u6570\u636e\u6307\u6807\u4e0d\u4e00\u81f4\u9020\u6210\u7684\uff0c\u6bd4\u5982\uff0c\u7b2c\u4e00\u4e2a<code>Cluster memory usage</code>(\u96c6\u7fa4\u5185\u5b58\u4f7f\u7528\u60c5\u51b5)\uff0c\u6211\u4eec\u53ef\u4ee5\u70b9\u51fb\u6807\u9898 <code>-&gt; Edit</code>\uff0c\u8fdb\u5165\u7f16\u8f91\u8fd9\u4e2a\u56fe\u8868\u7684\u7f16\u8f91\u9875\u9762\uff1a</p> <p></p> <p>\u8fdb\u5165\u7f16\u8f91\u9875\u9762\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u56fe\u8868\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>(sum(node_memory_MemTotal) - sum(node_memory_MemFree+node_memory_Buffers+node_memory_Cached) ) / sum(node_memory_MemTotal) * 100\n</code></pre> <p></p> <p>\u8fd9\u5c31\u662f\u6211\u4eec\u4e4b\u524d\u5728 <code>Prometheus</code> \u91cc\u9762\u67e5\u8be2\u7684<code>promQL</code>\u8bed\u53e5\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684\u67e5\u8be2\u8bed\u53e5\u590d\u5236\u5230 <code>Prometheus</code> \u7684 <code>Graph</code> \u9875\u9762\u8fdb\u884c\u67e5\u8be2\uff0c\u5176\u5b9e\u53ef\u4ee5\u9884\u60f3\u5230\u662f\u6ca1\u6709\u5bf9\u5e94\u7684\u6570\u636e\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u7528<code>node_exporter</code>\u91c7\u96c6\u5230\u7684\u6570\u636e\u6307\u6807\u4e0d\u662f<code>node_memory_MemTotal</code>\u5173\u952e\u5b57\uff0c\u800c\u662f<code>node_memory_MemTotal_bytes</code>\uff0c\u5c06\u4e0a\u9762\u7684<code>promQL</code>\u8bed\u53e5\u505a\u76f8\u5e94\u7684\u66f4\u6539\uff1a</p> <pre><code>(sum(node_memory_MemTotal_bytes) - sum(node_memory_MemFree_bytes + node_memory_Buffers_bytes+node_memory_Cached_bytes)) / sum(node_memory_MemTotal_bytes) * 100\n</code></pre> <p>\u8fd9\u4e2a\u8bed\u53e5\u7684\u610f\u601d\u5c31\u662f(\u6574\u4e2a\u96c6\u7fa4\u7684\u5185\u5b58-(\u6574\u4e2a\u96c6\u7fa4\b\u5269\u4f59\u7684\u5185\u5b58\u4ee5\u53caBuffer\u548cCached))/\u6574\u4e2a\u96c6\u7fa4\u7684\u5185\u5b58\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u603b\u7684\u96c6\u7fa4\u5185\u5b58\u4f7f\u7528\u767e\u5206\u6bd4\u3002</p> <p>\u5c06\u4e0a\u9762 grafana \u7684promQL\u8bed\u53e5\u66ff\u6362\u6389\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u56fe\u8868\u6b63\u5e38\u4e86\uff1a</p> <p></p> <p>\u540c\u6837\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u66f4\u6539\b\u540e\u9762\u7684 <code>CPU</code> \u548c <code>FileSystem</code> \u7684\u4f7f\u7528\u7387\uff1a</p> <p></p> <p>\u540c\u6837\u4e0b\u9762\u7684<code>Pod CPU Usage</code>\u7528\u6765\u5c55\u793a <code>Pod CPU</code> \u7684\u4f7f\u7528\u60c5\u51b5\uff0c\u5bf9\u5e94\u7684<code>promQL</code>\u8bed\u53e5\u5982\u4e0b\uff0c\u6839\u636e <code>pod_name</code> \u6765\u8fdb\u884c\u7edf\u8ba1\uff1a</p> <pre><code>sum by (pod_name)(rate(container_cpu_usage_seconds_total{image!=\"\", pod_name!=\"\"}[1m]))\n</code></pre> <p>\u6309\u7167\u4e0a\u9762\u7684\u65b9\u6cd5\u66ff\u6362 grafana \u4e2d\u7684 dashboard \u56fe\u8868\u4e2d\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <p></p> <p>\u5176\u4ed6\u7684\u4e5f\u6309\u7167\u6211\u4eec\u7684\u5b9e\u9645\u9700\u6c42\u91cd\u65b0\u7f16\u8f91\u4e0b\b\u5c31\u53ef\u4ee5\uff0c\u4e0b\u56fe\u662f\u6700\u7ec8\u6574\u4e2a <code>dashboard</code> \u7684\u6548\u679c\u56fe\uff1a</p> <p></p> <p>\u6700\u540e\u8981\u8bb0\u5f97\u4fdd\u5b58\u8fd9\u4e2a <code>dashboard</code>\uff0c\u4e0b\u9762\u7684\u94fe\u63a5\u662f\u6211\u4fee\u6539\u540e\u7684 <code>dashboard json</code> \u6587\u4ef6\u5730\u5740\uff0c\u4f60\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d\u4e0b\u6765\u5bfc\u5165\u5230 <code>grafana</code> \u5f53\u4e2d\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u76f8\u5e94\u7684\u66f4\u6539\uff1ak8s-cluster-grafana-dashboard.json</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u524d\u5f80 <code>grafana dashboard</code> \u7684\u9875\u9762\u53bb\u641c\u7d22\u5176\u4ed6\u7684\u5173\u4e8e <code>Kubernetes</code> \u7684\u76d1\u63a7\u9875\u9762\uff0c\u5730\u5740\uff1ahttps://grafana.com/dashboards\uff0c\u6bd4\u5982id \u4e3a<code>747</code>\u548c<code>741</code>\u7684\u8fd9\u4e24\u4e2a <code>dashboard</code>\u3002</p>"},{"location":"chap3/8Adv_K8S_Grafana/#4","title":"4 \u63d2\u4ef6","text":"<p>\u4e0a\u9762\u662f\u6211\u4eec\u6700\u5e38\u7528\u7684 grafana \u5f53\u4e2d\u7684 dashboard \u7684\u529f\u80fd\u7684\u4f7f\u7528\uff0c\u7136\u540e\u6211\u4eec\u4e5f\u53ef\u4ee5\u6765\u8fdb\u884c\u4e00\u4e9b\u5176\u4ed6\u7684\u7cfb\u7edf\u7ba1\u7406\uff0c\u6bd4\u5982\u6dfb\u52a0\u7528\u6237\uff0c\u4e3a\u7528\u6237\u6dfb\u52a0\u6743\u9650\u7b49\u7b49\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e9b\u5176\u4ed6\u63d2\u4ef6\uff0c\u6bd4\u5982 grafana \u5c31\u6709\u4e00\u4e2a\u4e13\u95e8\u9488\u5bf9 Kubernetes \u96c6\u7fa4\u76d1\u63a7\u7684\u63d2\u4ef6\uff1agrafana-kubernetes-app</p> <p>\u8981\u5b89\u88c5\u8fd9\u4e2a\u63d2\u4ef6\uff0c\u9700\u8981\u5230 <code>grafana</code> \u7684 <code>Pod</code> \u91cc\u9762\u53bb\u6267\u884c\u5b89\u88c5\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl get pods -n kube-ops\nNAME                          READY     STATUS      RESTARTS   AGE\ngrafana-79477fbb7c-v4prs      1/1       Running     0          23m\n\n# kubectl exec -it pod-name bin/bash -n kube-ops\n$ kubectl exec -it grafana-79477fbb7c-v4prs /bin/bash -n kube-ops\ngrafana@grafana-79477fbb7c-v4prs:/usr/share/grafana$ grafana-cli plugins install grafana-kubernetes-app\ninstalling grafana-kubernetes-app @ 1.0.1\nfrom url: https://grafana.com/api/plugins/grafana-kubernetes-app/versions/1.0.1/download\ninto: /var/lib/grafana/plugins\n\n\u2714 Installed grafana-kubernetes-app successfully\n\nRestart grafana after installing plugins . &lt;service grafana-server restart&gt;\n\ngrafana@grafana-79477fbb7c-v4prs:/usr/share/grafana$\n\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u9700\u8981\u91cd\u542f <code>grafana</code> \u624d\u4f1a\u751f\u6548\uff0c\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u5220\u9664 <code>Pod</code>\uff0c\u91cd\u5efa\u5373\u53ef\uff0c\u7136\u540e\u56de\u5230 <code>grafana</code> \u9875\u9762\u4e2d\uff0c\u5207\u6362\u5230 <code>plugins</code> \u9875\u9762\u53ef\u4ee5\u53d1\u73b0\u4e0b\u9762\u591a\u4e86\u4e00\u4e2a <code>Kubernetes</code> \u7684\u63d2\u4ef6\uff0c\u70b9\u51fb\u8fdb\u6765\u542f\u7528\u5373\u53ef\uff0c\u7136\u540e\u70b9\u51fb<code>Next up\b</code>\u65c1\u8fb9\u7684\u94fe\u63a5\u914d\u7f6e\u96c6\u7fa4</p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684 <code>Kubernetes</code> \u96c6\u7fa4\uff0c\u8fd9\u91cc\u9700\u8981\u586b\u5199\u96c6\u7fa4\u7684\u8bbf\u95ee\u5730\u5740\uff1a<code>https://kubernetes.default</code>\uff0c\u7136\u540e\u6bd4\u8f83\u91cd\u8981\u7684\u662f\u96c6\u7fa4\u8bbf\u95ee\u7684\u8bc1\u4e66\uff0c\u52fe\u9009\u4e0a<code>TLS Client Auth</code>\u548c<code>With CA Cert</code>\u8fd9\u4e24\u9879\u3002</p> <p></p> <p>\u96c6\u7fa4\u8bbf\u95ee\u7684\u8bc1\u4e66\u6587\u4ef6\uff0c\u7528\u6211\u4eec\u8bbf\u95ee\u96c6\u7fa4\u7684 <code>kubectl</code> \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u8bc1\u4e66\u4fe1\u606f<code>(~/.kube/config)</code>\u5373\u53ef\uff0c\u5176\u4e2d\u5c5e\u6027<code>certificate-authority-data</code>\u3001<code>client-certificate-data</code>\u3001<code>client-key-data</code> \u5c31\u5bf9\u5e94\u8fd9 <code>CA \u8bc1\u4e66</code>\u3001<code>Client \u8bc1\u4e66</code>\u3001<code>Client \u79c1\u94a5</code>\uff0c\u4e0d\u8fc7 <code>config</code> \u6587\u4ef6\u91cc\u9762\u7684\u5185\u5bb9\u662f<code>base64</code>\u7f16\u7801\u8fc7\u540e\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u586b\u5199\u7684\u65f6\u5019\u8981\u505a<code>base64</code>\u89e3\u7801\u3002</p> <p>\u53e6\u5916\u9700\u8981\u5c06\u89e3\u7801\u8fc7\u540e\u7684\\n\u6362\u6210\u6362\u884c\u7b26\uff0c\u4e0d\u7136\u8ba4\u8bc1\u4f1a\u5931\u8d25\u3002</p> <p>\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u76f4\u63a5\u70b9\u51fb<code>Deploy</code>\uff0c\u7136\u540e\u70b9\u51fbSave\uff0c\u5c31\u53ef\u4ee5\b\u83b7\u53d6\u5230\u96c6\u7fa4\u7684\u76d1\u63a7\u8d44\u6e90\u4fe1\u606f\u4e86\u3002</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u5c55\u793a\u4e86\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u53ef\u4ee5\b\u67e5\u770b\u4e0a\u9762\u7684\u4e00\u4e9b <code>Dashboard</code>:</p> <p></p>"},{"location":"chap3/8Adv_K8S_Grafana/#5","title":"5 \u62a5\u8b66","text":"<p><code>grafana 4</code> \u7248\u672c\u4ee5\u4e0a\u5c31\u652f\u6301\u4e86\u62a5\u8b66\u529f\u80fd\uff0c\u8fd9\u4f7f\u5f97\u6211\u4eec\u5229\u7528 <code>grafana</code> \u4f5c\u4e3a\u76d1\u63a7\u9762\u677f\u66f4\u4e3a\u5b8c\u6574\uff0c\u56e0\u4e3a\u62a5\u8b66\u662f\u76d1\u63a7\u7cfb\u7edf\u4e2d\u5fc5\u4e0d\u53ef\u5c11\u7684\u73af\u8282\uff0c<code>grafana</code> \u652f\u6301\u5f88\u591a\u79cd\u5f62\u5f0f\u7684\u62a5\u8b66\u529f\u80fd\uff0c\u6bd4\u5982 <code>email</code>\u3001<code>\u9489\u9489</code>\u3001<code>slack</code>\u3001<code>webhook</code> \u7b49\u7b49\uff0c\u6211\u4eec\u8fd9\u91cc\u6765\u6d4b\u8bd5\u4e0b <code>email</code> \u548c <code>\u9489\u9489</code>\u3002</p>"},{"location":"chap3/8Adv_K8S_Grafana/#5-1-email","title":"5-1 email \u62a5\u8b66","text":"<p>\u8981\u542f\u7528 <code>email</code> \u62a5\u8b66\u9700\u8981\u5728\u542f\u52a8\u914d\u7f6e\u6587\u4ef6\u4e2d<code>/etc/grafana/grafan.ini</code>\u5f00\u542f <code>SMTP</code> \u670d\u52a1\uff0c\u6211\u4eec\u8fd9\u91cc\u540c\u6837\u5229\u7528\u4e00\u4e2a <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\u6302\u8f7d\u5230 <code>grafana Pod</code> \u4e2d\uff1a\uff08<code>grafana-cm.yaml</code>\uff09</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: grafana-config\n  namespace: kube-ops\ndata:\n  grafana.ini: |\n    [server]\n    root_url = http://&lt;\u4f60grafana\u7684url\u5730\u5740&gt;\n    [smtp]\n    enabled = true\n    host = smtp.gmail.com\n    user = xichao2017@gmail.com\n    password = &lt;\u90ae\u7bb1\u5bc6\u7801&gt;\n    skip_verify = true\n    from_address = xichao2017@gmail.com\n    [alerting]\n    enabled = true\n    execute_alerts = true\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u4e86\u6211\u7684 <code>gmail</code> \u90ae\u7bb1\uff0c\u5f00\u542f\u62a5\u8b66\u529f\u80fd\uff0c\u5f53\u7136\u6211\u4eec\u8fd8\u5f97\u5c06\u8fd9\u4e2a <code>ConfigMap</code> \u6587\u4ef6\u6302\u8f7d\u5230 <code>Pod</code> \u4e2d\u53bb\uff1a</p> <pre><code> volumeMounts:\n  - mountPath: \"/etc/grafana\"\n    name: config\nvolumes:\n- name: config\n  configMap:\n    name: grafana-config\n</code></pre> <p>\u521b\u5efa <code>ConfigMap</code> \u5bf9\u8c61\uff0c\u66f4\u65b0 <code>Deployment</code>\uff1a</p> <pre><code>$ kubectl create -f grafana-cm.yaml\n$ kubectl apply -f grafana-deploy.yaml\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u5728 <code>grafana</code> \u7684 ui \u4e2d<code>Alert</code>\u9875\u9762\u6d4b\u8bd5\u90ae\u4ef6\u62a5\u8b66\uff1a</p> <p></p> <p>\u53d1\u9001\u6d4b\u8bd5\b\u540e\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\u5c31\u53ef\u4ee5\u6536\u5230\u6d4b\u8bd5\u62a5\u8b66\u90ae\u4ef6\uff1a</p> <p></p>"},{"location":"chap3/8Adv_K8S_Grafana/#5-2","title":"5-2 \u9489\u9489\u62a5\u8b66","text":"<p>\u4e0a\u9762\u6211\u4eec\u4e5f\u8bf4\u4e86 grafana \u4e5f\u662f\u652f\u6301\u9489\u9489\u62a5\u8b66\u7684\uff0c\u5728\u9489\u9489\u7fa4\u91cc\u9762\u6dfb\u52a0\u7fa4\u673a\u5668\u4eba\uff0c\u9009\u62e9\u6700\u540e\u7684\u81ea\u5b9a\u4e49\u673a\u5668\u4eba\uff1a</p> <p></p> <p>\u6dfb\u52a0\u5b8c\u6210\u540e\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a <code>webhook</code> \u7684\u5730\u5740\uff0c\u7136\u540e\u5c06\u8fd9\u4e2a <code>webhook</code> \u5730\u5740\u6dfb\u52a0\u5230\u4e0a\u9762 <code>grafana web_ui</code>\b \u7684\u62a5\u8b66\u6d4b\u8bd5\u9875\u9762\u8fdb\u884c\u6d4b\u8bd5\uff0c\u5c31\u53ef\u4ee5\u5728\u9489\u9489\u7fa4\u91cc\u9762\u6536\u5230\u62a5\u8b66\u6d4b\u8bd5\u4fe1\u606f\u4e86\uff1a</p> <p></p>"},{"location":"chap3/8Adv_K8S_Grafana/#5-3","title":"5-3 \u914d\u7f6e","text":"<p>\u76ee\u524d\u53ea\u6709 <code>Graph</code> \u652f\u6301\u62a5\u8b66\u529f\u80fd\uff0c\u6240\u4ee5\u6211\u4eec\u9009\u62e9 <code>Graph</code> \u76f8\u5173\u56fe\u8868\uff0c\u70b9\u51fb\u7f16\u8f91\uff0c\u8fdb\u5165 <code>Graph</code> \u7f16\u8f91\u9875\u9762\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a <code>Alert</code> \u6a21\u5757\uff0c\u5207\u6362\u8fc7\u6765\u521b\u5efa\u62a5\u8b66\uff1a</p> <p></p> <p>\u7136\u540e\u914d\u7f6e\u76f8\u5173\u53c2\u6570\uff1a</p> <ol> <li>Alert \u540d\u79f0\uff0c\u53ef\u4ee5\u81ea\u5b9a\u4e49\u3002</li> <li>\u6267\u884c\u7684\u9891\u7387\uff0c\u8fd9\u91cc\u6211\u9009\u62e9\u6bcf60s\u68c0\u6d4b\u4e00\u6b21\u3002</li> <li>\u5224\u65ad\u6807\u51c6\uff0c\u9ed8\u8ba4\u662f avg\uff0c\u8fd9\u91cc\u662f\u4e0b\u62c9\u6846\uff0c\u81ea\u5df1\u6309\u9700\u6c42\u9009\u62e9\u3002</li> <li>query\uff08A,5m,now\uff09\uff0c\u5b57\u6bcdA\u4ee3\u8868\u9009\u62e9\u7684metrics \u4e2d\u8bbe\u7f6e\u7684 sql\uff0c\u4e5f\u53ef\u4ee5\u9009\u62e9\u5176\u5b83\u5728 metrics\u4e2d\u8bbe\u7f6e\u7684\uff0c\u4f46\u8fd9\u91cc\u662f\u5355\u9009\u30025m\u4ee3\u8868\u4ece\u73b0\u5728\u8d77\u5f80\u4e4b\u524d\u7684\u4e94\u5206\u949f\uff0c\u53735m\u4e4b\u524d\u7684\u90a3\u4e2a\u70b9\u4e3a\u65f6\u95f4\u7684\u8d77\u59cb\u70b9\uff0c<code>now</code>\u4e3a\u65f6\u95f4\u7684\u7ed3\u675f\u70b9\uff0c\u6b64\u5916\u8fd9\u91cc\u53ef\u4ee5\u81ea\u5df1\u624b\u52a8\u8f93\u5165\u65f6\u95f4\u3002</li> <li>\u8bbe\u7f6e\u7684\u9884\u8b66\u4e34\u754c\u70b9\uff0c\u8fd9\u91cc\u624b\u52a8\u8f93\u5165\uff0c\u548c6\u662f\u540c\u6837\u529f\u80fd\uff0c</li> <li>\u53ef\u4ee5\u624b\u52a8\u79fb\u52a8\uff0c\u4e24\u79cd\u64cd\u4f5c\u662f\u7b49\u540c\u7684\u3002</li> </ol> <p>\u7136\u540e\u9700\u8981\u8bbe\u7f6e\u62a5\u8b66\u53d1\u9001\u4fe1\u606f\uff0c\u70b9\u51fb\u4fa7\u8fb9\u7684 <code>Notifications</code>:</p> <p></p> <p>\u5176\u4e2d<code>Send to</code>\u5c31\u662f\u524d\u9762\u6211\u4eec\u914d\u7f6e\u8fc7\u7684\u53d1\u9001\u90ae\u4ef6\u548c\u9489\u9489\u7684\u62a5\u8b66\u9891\u9053\u7684\u540d\u79f0\u3002</p> <p>\u914d\u7f6e\u5b8c\u6210\u540e\u9700\u8981\u4fdd\u5b58\u4e0b\u8fd9\u4e2a <code>graph</code>\uff0c\u5426\u5219\u53d1\u9001\u62a5\u8b66\u53ef\u80fd\u4f1a\u5931\u8d25\uff0c\u7136\u540e\u70b9\u51fb <code>Alert</code> \u533a\u57df\u7684<code>Test Rule</code>\u53ef\u4ee5\u6765\u6d4b\u8bd5\u62a5\u8b66\u89c4\u5219\uff0c\u7136\u540e\u90ae\u4ef6\u548c\u9489\u9489\u6b63\u5e38\u6765\u8bf4\u5c31\u53ef\u4ee5\u6536\u5230\u62a5\u8b66\u4fe1\u606f\u4e86\u3002</p> <p>\u90ae\u4ef6\u62a5\u8b66\u4fe1\u606f\uff1a</p> <p></p> <p>\u9489\u9489\u62a5\u8b66\u4fe1\u606f\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 grafana \u6765\u5c55\u793a Kubernetes \u96c6\u7fa4\u7684\u76d1\u63a7\u56fe\u8868\u4fe1\u606f\u4ee5\u53ca\u62a5\u8b66\u914d\u7f6e\uff0c\u4f46\u662f\u6211\u4eec\u660e\u663e\u53ef\u4ee5\u611f\u89c9\u5230 grafana \u7684\u4f18\u52bf\u5728\u4e8e\u56fe\u8868\u7684\u5c55\u793a\uff0c\u62a5\u8b66\u529f\u80fd\u6709\u70b9\u5f31\uff0c\u6240\u4ee5\u4e00\u822c\u6765\u8bf4\uff0c\u5728\u751f\u4ea7\u73af\u5883\u6211\u4eec\u4e0d\u4f1a\u76f4\u63a5\u4f7f\u7528 grafana \u7684\u62a5\u8b66\u529f\u80fd\uff0c\u66f4\u591a\u7684\u662f\u4f7f\u7528\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\u7684 AlertManager\u3002</p>"},{"location":"chap4/11Adv_Prometheus_Operator/","title":"\u7b2c\u4e00\u8282 Prometheus Operator \u521d\u4f53\u9a8c","text":"<p>\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u5b66\u4e60\u4e86\u7528\u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u6765\u5bf9 Kubernetes \u96c6\u7fa4\u8fdb\u884c\u76d1\u63a7\uff0c\u4f46\u662f\u8fd8\u662f\u6709\u4e00\u4e9b\u7f3a\u9677\uff0c\u6bd4\u5982 <code>Prometheus</code>\u3001<code>AlertManager</code> \u8fd9\u4e9b\u7ec4\u4ef6\u670d\u52a1\u672c\u8eab\u7684\u9ad8\u53ef\u7528\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u5b8c\u5168\u53ef\u4ee5\u7528\u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u8fd9\u4e9b\u9700\u6c42\uff0c\u6211\u4eec\u4e5f\u77e5\u9053 <code>Promethues</code> \u5728\u4ee3\u7801\u4e0a\u5c31\u5df2\u7ecf\u5bf9 <code>Kubernetes</code> \u6709\u4e86\u539f\u751f\u7684\u652f\u6301\uff0c\u53ef\u4ee5\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\u7684\u5f62\u5f0f\u6765\u81ea\u52a8\u76d1\u63a7\u96c6\u7fa4\uff0c</p> <p>\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u53e6\u5916\u4e00\u79cd\u66f4\u52a0\u9ad8\u7ea7\u7684\u65b9\u5f0f\u6765\u90e8\u7f72 <code>Prometheus\uff1aOperator</code> \u6846\u67b6\u3002</p>"},{"location":"chap4/11Adv_Prometheus_Operator/#1-operator","title":"1 Operator","text":"<p><code>Operator</code> \u662f\u7531 CoreOS \u516c\u53f8\u5f00\u53d1\u7684\uff0c\u7528\u6765\u6269\u5c55 <code>Kubernetes API</code>\uff0c\u7279\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u63a7\u5236\u5668\uff0c\u5b83\u7528\u6765\u521b\u5efa\u3001\u914d\u7f6e\u548c\u7ba1\u7406\u590d\u6742\u7684\u6709\u72b6\u6001\u5e94\u7528\uff0c\u5982\u6570\u636e\u5e93\u3001\u7f13\u5b58\u548c\u76d1\u63a7\u7cfb\u7edf\u3002</p> <p><code>Operator</code>\u57fa\u4e8e <code>Kubernetes</code> \u7684\u8d44\u6e90\u548c\u63a7\u5236\u5668\u6982\u5ff5\u4e4b\u4e0a\u6784\u5efa\uff0c\u4f46\u540c\u65f6\u53c8\u5305\u542b\u4e86\u5e94\u7528\u7a0b\u5e8f\u7279\u5b9a\u7684\u4e00\u4e9b\u4e13\u4e1a\u77e5\u8bc6\uff0c\u6bd4\u5982\u521b\u5efa\u4e00\u4e2a\u6570\u636e\u5e93\u7684<code>Operator</code> \uff0c\u5219\u5fc5\u987b\u5bf9\u521b\u5efa\u7684\u6570\u636e\u5e93\u7684\u5404\u79cd\u8fd0\u7ef4\u65b9\u5f0f\u975e\u5e38\u4e86\u89e3\uff0c\u521b\u5efa<code>Operator</code>\u7684\u5173\u952e\u662f<code>CRD</code>\uff08\u81ea\u5b9a\u4e49\u8d44\u6e90\uff09\u7684\u8bbe\u8ba1\u3002</p> <ul> <li><code>CRD</code> \u662f\u5bf9 <code>Kubernetes API</code> \u7684\u6269\u5c55\uff0c<code>Kubernetes</code> \u4e2d\u7684\u6bcf\u4e2a\u8d44\u6e90\u90fd\u662f\u4e00\u4e2a <code>API</code> \u5bf9\u8c61\u7684\u96c6\u5408\uff0c\u4f8b\u5982\u6211\u4eec\u5728 </li> <li><code>YAML</code> \u6587\u4ef6\u91cc\u5b9a\u4e49\u7684\u90a3\u4e9b <code>spec</code> \u90fd\u662f\u5bf9 <code>Kubernetes</code> \u4e2d\u7684\u8d44\u6e90\u5bf9\u8c61\u7684\u5b9a\u4e49\uff0c\u6240\u6709\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\u53ef\u4ee5\u8ddf </li> <li><code>Kubernetes</code> \u4e2d\u5185\u5efa\u7684\u8d44\u6e90\u4e00\u6837\u4f7f\u7528 <code>kubectl</code> \u64cd\u4f5c\u3002</li> </ul> <p><code>Operator</code> \u662f\u5c06\u8fd0\u7ef4\u4eba\u5458\u5bf9\u8f6f\u4ef6\u64cd\u4f5c\u7684\u77e5\u8bc6\u7ed9\u4ee3\u7801\u5316\uff0c\u540c\u65f6\u5229\u7528 Kubernetes \u5f3a\u5927\u7684\u62bd\u8c61\u6765\u7ba1\u7406\u5927\u89c4\u6a21\u7684\u8f6f\u4ef6\u5e94\u7528\u3002\u76ee\u524dCoreOS\u5b98\u65b9\u63d0\u4f9b\u4e86\u51e0\u79cdOperator\u7684\u5b9e\u73b0\uff0c\u5176\u4e2d\u5c31\u5305\u62ec\u6211\u4eec\u4eca\u5929\u7684\u4e3b\u89d2\uff1a<code>Prometheus Operator</code>\uff0c<code>Operator</code>\u7684\u6838\u5fc3\u5b9e\u73b0\u5c31\u662f\u57fa\u4e8e Kubernetes \u7684\u4ee5\u4e0b\u4e24\u4e2a\u6982\u5ff5\uff1a</p> <ul> <li>\u8d44\u6e90\uff1a\u5bf9\u8c61\u7684\u72b6\u6001\u5b9a\u4e49</li> <li>\u63a7\u5236\u5668\uff1a\u89c2\u6d4b\u3001\u5206\u6790\u548c\u884c\u52a8\uff0c\u4ee5\u8c03\u8282\u8d44\u6e90\u7684\u5206\u5e03</li> </ul> <p>\u5f53\u7136\u6211\u4eec\u5982\u679c\u6709\u5bf9\u5e94\u7684\u9700\u6c42\u4e5f\u5b8c\u5168\u53ef\u4ee5\u81ea\u5df1\u53bb\u5b9e\u73b0\u4e00\u4e2a<code>Operator</code>\uff0c\u63a5\u4e0b\u6765\u6211\u5c31\u6765\u7ed9\u5927\u5bb6\u8be6\u7ec6\u4ecb\u7ecd\u4e0b<code>Prometheus-Operator</code>\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p>"},{"location":"chap4/11Adv_Prometheus_Operator/#2","title":"2 \u4ecb\u7ecd","text":"<p>\u9996\u5148\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e0b <code>Prometheus-Operator</code>\u7684\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>\u4e0a\u56fe\u662f <code>Prometheus-Operator</code> \u5b98\u65b9\u63d0\u4f9b\u7684\u67b6\u6784\u56fe\uff0c\u5176\u4e2d <code>Operator</code>\u662f\u6700\u6838\u5fc3\u7684\u90e8\u5206\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u63a7\u5236\u5668\uff0c\u4ed6\u4f1a\u53bb\u521b\u5efa<code>Prometheus</code>\u3001<code>ServiceMonitor</code>\u3001<code>AlertManager</code> \u4ee5\u53ca <code>PrometheusRule</code> 4\u4e2a<code>CRD</code>\u8d44\u6e90\u5bf9\u8c61\uff0c\u7136\u540e\u4f1a\u4e00\u76f4\u76d1\u63a7\u5e76\u7ef4\u6301\u8fd9<code>4</code>\u4e2a\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u3002</p> <ul> <li>\u5176\u4e2d\u521b\u5efa\u7684 <code>prometheus</code> \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u5c31\u662f\u4f5c\u4e3a<code>Prometheus Server</code>\u5b58\u5728\uff0c</li> <li>\u800c<code>ServiceMonitor</code>\u5c31\u662f<code>exporter</code>\u7684\u5404\u79cd\u62bd\u8c61\uff0c</li> <li><code>exporter</code>\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u4e86\uff0c\u662f\u7528\u6765\u63d0\u4f9b\u4e13\u95e8\u63d0\u4f9b<code>metrics</code>\u6570\u636e\u63a5\u53e3\u7684\u5de5\u5177\uff0c</li> </ul> <p><code>Prometheus</code>\u5c31\u662f\u901a\u8fc7 <code>ServiceMonitor</code> \u63d0\u4f9b\u7684 <code>metrics</code> \u6570\u636e\u63a5\u53e3\u53bb <code>pull</code> \u6570\u636e\u7684\uff0c\u5f53\u7136 <code>alertmanager</code> \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u5c31\u662f\u5bf9\u5e94\u7684 <code>AlertManager</code> \u7684\u62bd\u8c61\uff0c\u800c <code>PrometheusRule</code> \u662f\u7528\u6765\u88ab <code>Prometheus</code> \u5b9e\u4f8b\u4f7f\u7528\u7684\u62a5\u8b66\u89c4\u5219\u6587\u4ef6\u3002</p> <p>\u8fd9\u6837\u6211\u4eec\u8981\u5728\u96c6\u7fa4\u4e2d\u76d1\u63a7\u4ec0\u4e48\u6570\u636e\uff0c\u5c31\u53d8\u6210\u4e86\u76f4\u63a5\u53bb\u64cd\u4f5c <code>Kubernetes</code> \u96c6\u7fa4\u7684\u8d44\u6e90\u5bf9\u8c61\u4e86\uff0c\u662f\u4e0d\u662f\u65b9\u4fbf\u5f88\u591a\u4e86\u3002\u4e0a\u56fe\u4e2d\u7684 <code>Service</code> \u548c <code>ServiceMonitor</code> \u90fd\u662f <code>Kubernetes</code> \u7684\u8d44\u6e90\uff0c\u4e00\u4e2a <code>ServiceMonitor</code> \u53ef\u4ee5\u901a\u8fc7 <code>labelSelector</code> \u7684\u65b9\u5f0f\u53bb\u5339\u914d\u4e00\u7c7b <code>Service</code>\uff0c<code>Prometheus</code> \u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>labelSelector</code>\u53bb\u5339\u914d\u591a\u4e2a<code>ServiceMonitor</code>\u3002</p>"},{"location":"chap4/11Adv_Prometheus_Operator/#2_1","title":"2 \u5b89\u88c5","text":"<p>\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u901a\u8fc7 <code>Prometheus-Operator</code> \u7684\u6e90\u7801\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u7528 <code>Helm</code> \u6765\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff0c\u6211\u4eec\u91c7\u7528\u6e90\u7801\u5b89\u88c5\u53ef\u4ee5\u53bb\u4e86\u89e3\u66f4\u591a\u7684\u5b9e\u73b0\u7ec6\u8282\u3002\u9996\u9875\u5c06\u6e90\u7801 <code>Clone</code> \u4e0b\u6765\uff1a</p> <pre><code>$ git clone https://github.com/coreos/prometheus-operator\n$ cd contrib/kube-prometheus/manifests/\n$ ls\n00namespace-namespace.yaml                                         node-exporter-clusterRole.yaml\n0prometheus-operator-0alertmanagerCustomResourceDefinition.yaml    node-exporter-daemonset.yaml\n......\n</code></pre> <p>\u8fdb\u5165\u5230 <code>manifests</code>\u76ee\u5f55\u4e0b\u9762\uff0c\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u9762\u5305\u542b\u6211\u4eec\u6240\u6709\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u5176\u4e2d\u7684\u6587\u4ef6 <code>prometheus-serviceMonitorKubelet.yaml</code> \u8fdb\u884c\u7b80\u5355\u7684\u4fee\u6539.</p> <p>\u56e0\u4e3a\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e2a <code>ServiceMonitor</code> \u662f\u5173\u8054\u7684 <code>kubelet</code> \u7684 <code>10250</code> \u7aef\u53e3\u53bb\u91c7\u96c6\u7684\u8282\u70b9\u6570\u636e\uff0c\u800c\u6211\u4eec\u524d\u9762\u8bf4\u8fc7\u4e3a\u4e86\u5b89\u5168\uff0c\u8fd9\u4e2a <code>metrics</code>\u6570\u636e\u5df2\u7ecf\u8fc1\u79fb\u5230<code>10255</code>\u8fd9\u4e2a\u53ea\u8bfb\u7aef\u53e3\u4e0a\u9762\u53bb\u4e86\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5c06\u6587\u4ef6\u4e2d\u7684<code>https-metrics</code>\u66f4\u6539\u6210<code>http-metrics</code>\u5373\u53ef\uff0c\u8fd9\u4e2a\u5728 <code>Prometheus-Operator</code> \u5bf9\u8282\u70b9\u7aef\u70b9\u540c\u6b65\u7684\u4ee3\u7801\u4e2d\u6709\u76f8\u5173\u5b9a\u4e49\uff0c\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u70b9\u6b64\u67e5\u770b\u5b8c\u6574\u4ee3\u7801\uff1a</p> <pre><code>Subsets: []v1.EndpointSubset{\n    {\n        Ports: []v1.EndpointPort{\n            {\n                Name: \"https-metrics\",\n                Port: 10250,\n            },\n            {\n                Name: \"http-metrics\",\n                Port: 10255,\n            },\n            {\n                Name: \"cadvisor\",\n                Port: 4194,\n            },\n        },\n    },\n},\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u76f4\u63a5\u5728\u8be5\u6587\u4ef6\u5939\u4e0b\u9762\u6267\u884c\u521b\u5efa\u8d44\u6e90\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f .\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a<code>monitoring</code>\u7684 <code>namespace</code>\uff0c\u6240\u4ee5\u8d44\u6e90\u5bf9\u8c61\u5bf9\u5c06\u90e8\u7f72\u5728\u6539\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff0c\u6b64\u5916 <code>Operator</code> \u4f1a\u81ea\u52a8\u521b\u5efa4\u4e2a <code>CRD</code> \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get crd |grep coreos\nalertmanagers.monitoring.coreos.com     5d\nprometheuses.monitoring.coreos.com      5d\nprometheusrules.monitoring.coreos.com   5d\nservicemonitors.monitoring.coreos.com   5d\n</code></pre> <p>\u53ef\u4ee5\u5728 <code>monitoring</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u67e5\u770b\u6240\u6709\u7684 <code>Pod</code>\uff0c\u5176\u4e2d <code>alertmanager</code> \u548c <code>prometheus</code> \u662f\u7528 <code>StatefulSet</code> \u63a7\u5236\u5668\u7ba1\u7406\u7684\uff0c\u5176\u4e2d\u8fd8\u6709\u4e00\u4e2a\u6bd4\u8f83\u6838\u5fc3\u7684 <code>prometheus-operator</code> \u7684 Pod\uff0c\u7528\u6765\u63a7\u5236\u5176\u4ed6\u8d44\u6e90\u5bf9\u8c61\u548c\u76d1\u542c\u5bf9\u8c61\u53d8\u5316\u7684\uff1a</p> <pre><code>$ kubectl get pods -n monitoring\nNAME                                  READY     STATUS    RESTARTS   AGE\nalertmanager-main-0                   2/2       Running   0          21h\nalertmanager-main-1                   2/2       Running   0          21h\nalertmanager-main-2                   2/2       Running   0          21h\ngrafana-df9bfd765-f4dvw               1/1       Running   0          22h\nkube-state-metrics-77c9658489-ntj66   4/4       Running   0          20h\nnode-exporter-4sr7f                   2/2       Running   0          21h\nnode-exporter-9mh2r                   2/2       Running   0          21h\nnode-exporter-m2gkp                   2/2       Running   0          21h\nprometheus-adapter-dc548cc6-r6lhb     1/1       Running   0          22h\nprometheus-k8s-0                      3/3       Running   1          21h\nprometheus-k8s-1                      3/3       Running   1          21h\nprometheus-operator-bdf79ff67-9dc48   1/1       Running   0          21h\n</code></pre> <p>\u67e5\u770b\u521b\u5efa\u7684 <code>Service</code>:</p> <pre><code>$ kubectl get svc -n monitoring\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\nalertmanager-main       ClusterIP   10.110.204.224   &lt;none&gt;        9093/TCP            23h\nalertmanager-operated   ClusterIP   None             &lt;none&gt;        9093/TCP,6783/TCP   23h\ngrafana                 ClusterIP   10.98.191.31     &lt;none&gt;        3000/TCP            23h\nkube-state-metrics      ClusterIP   None             &lt;none&gt;        8443/TCP,9443/TCP   23h\nnode-exporter           ClusterIP   None             &lt;none&gt;        9100/TCP            23h\nprometheus-adapter      ClusterIP   10.107.201.172   &lt;none&gt;        443/TCP             23h\nprometheus-k8s          ClusterIP   10.107.105.53    &lt;none&gt;        9090/TCP            23h\nprometheus-operated     ClusterIP   None             &lt;none&gt;        9090/TCP            23h\nprometheus-operator     ClusterIP   None             &lt;none&gt;        8080/TCP            23h\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u9488\u5bf9 <code>grafana</code> \u548c <code>prometheus</code> \u90fd\u521b\u5efa\u4e86\u4e00\u4e2a\u7c7b\u578b\u4e3a <code>ClusterIP</code> \u7684 <code>Service</code>\uff0c\u5f53\u7136\u5982\u679c\u6211\u4eec\u60f3\u8981\u5728\u5916\u7f51\u8bbf\u95ee\u8fd9\u4e24\u4e2a\u670d\u52a1\u7684\u8bdd\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u5bf9\u5e94\u7684 <code>Ingress</code> \u5bf9\u8c61\u6216\u8005\u4f7f\u7528 <code>NodePort</code> \u7c7b\u578b\u7684 <code>Service</code>\uff0c\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5355\uff0c\u76f4\u63a5\u4f7f\u7528 <code>NodePort</code> \u7c7b\u578b\u7684\u670d\u52a1\u5373\u53ef\uff0c\u7f16\u8f91 <code>grafana</code> \u548c <code>prometheus-k8s</code>\u8fd9\u4e24\u4e2a <code>Service</code>\uff0c\u5c06\u670d\u52a1\u7c7b\u578b\u66f4\u6539\u4e3a <code>NodePort</code>:</p> <pre><code>$ kubectl edit svc grafana -n monitoring\n$ kubectl edit svc prometheus-k8s -n monitoring\n$ kubectl get svc -n monitoring\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\ngrafana                 NodePort    10.98.191.31     &lt;none&gt;        3000:32333/TCP      23h\nprometheus-k8s          NodePort    10.107.105.53    &lt;none&gt;        9090:30166/TCP      23h\n......\n</code></pre> <pre><code>kubectl edit svc -n   # \u76f4\u63a5\u5c06service\u7684clusterIP\u6539\u4e3anodeport\n</code></pre> <p>\u66f4\u6539\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>NodeIP:NodePort</code> \u53bb\u8bbf\u95ee\u4e0a\u9762\u7684\u4e24\u4e2a\u670d\u52a1\u4e86\uff0c\u6bd4\u5982\u67e5\u770b prometheus \u7684 targets \u9875\u9762\uff1a</p> <p></p> <p></p> <p></p>"},{"location":"chap4/11Adv_Prometheus_Operator/#3","title":"3 \u914d\u7f6e","text":"<p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5927\u90e8\u5206\u7684\u914d\u7f6e\u90fd\u662f\u6b63\u5e38\u7684\uff0c\u53ea\u6709\u4e24\u4e09\u4e2a\u6ca1\u6709\u7ba1\u7406\u5230\u5bf9\u5e94\u7684\u76d1\u63a7\u76ee\u6807\uff0c\u6bd4\u5982 <code>kube-controller-manager</code> \u548c <code>kube-scheduler</code> \u8fd9\u4e24\u4e2a\u7cfb\u7edf\u7ec4\u4ef6\uff0c\u8fd9\u5c31\u548c <code>ServiceMonitor</code> \u7684\u5b9a\u4e49\u6709\u5173\u7cfb\u4e86\uff0c</p> <p>\u6211\u4eec\u5148\u6765\u67e5\u770b\u4e0b <code>kube-scheduler</code> \u7ec4\u4ef6\u5bf9\u5e94\u7684 <code>ServiceMonitor</code> \u8d44\u6e90\u7684\u5b9a\u4e49\uff1a(<code>prometheus-serviceMonitorKubeScheduler.yaml</code>)</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    k8s-app: kube-scheduler\n  name: kube-scheduler\n  namespace: monitoring\nspec:\n  endpoints:\n  - interval: 30s # \u6bcf30s\u83b7\u53d6\u4e00\u6b21\u4fe1\u606f\n    port: http-metrics  # \u5bf9\u5e94service\u7684\u7aef\u53e3\u540d\n  jobLabel: k8s-app\n  namespaceSelector: # \u8868\u793a\u53bb\u5339\u914d\u67d0\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u7684service\uff0c\u5982\u679c\u60f3\u4ece\u6240\u6709\u7684namespace\u4e2d\u5339\u914d\u7528any: true\n    matchNames:\n    - kube-system\n  selector:  # \u5339\u914d\u7684 Service \u7684labels\uff0c\u5982\u679c\u4f7f\u7528mathLabels\uff0c\u5219\u4e0b\u9762\u7684\u6240\u6709\u6807\u7b7e\u90fd\u5339\u914d\u65f6\u624d\u4f1a\u5339\u914d\u8be5service\uff0c\u5982\u679c\u4f7f\u7528matchExpressions\uff0c\u5219\u81f3\u5c11\u5339\u914d\u4e00\u4e2a\u6807\u7b7e\u7684service\u90fd\u4f1a\u88ab\u9009\u62e9\n    matchLabels:\n      k8s-app: kube-scheduler\n</code></pre> <p>\u4e0a\u9762\u662f\u4e00\u4e2a\u5178\u578b\u7684 <code>ServiceMonitor</code> \u8d44\u6e90\u6587\u4ef6\u7684\u58f0\u660e\u65b9\u5f0f\uff0c\u4e0a\u9762\u6211\u4eec\u901a\u8fc7 <code>selector.matchLabels</code> \u5728 <code>kube-system</code> \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5339\u914d\u5177\u6709 <code>k8s-app=kube-scheduler</code> \u8fd9\u6837\u7684 <code>Service</code>\uff0c\u4f46\u662f\u6211\u4eec\u7cfb\u7edf\u4e2d\u6839\u672c\u5c31\u6ca1\u6709\u5bf9\u5e94\u7684 <code>Service</code>\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u624b\u52a8\u521b\u5efa\u4e00\u4e2a <code>Service</code>\uff1a\uff08<code>prometheus-kubeSchedulerService.yaml</code>\uff09</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  namespace: kube-system\n  name: kube-scheduler\n  labels:\n    k8s-app: kube-scheduler\nspec:\n  selector:\n    component: kube-scheduler\n  ports:\n  - name: http-metrics\n    port: 10251\n    targetPort: 10251\n    protocol: TCP\n</code></pre> <p><code>10251</code> \u662f <code>kube-scheduler</code> \u7ec4\u4ef6 <code>metrics</code> \u6570\u636e\u6240\u5728\u7684\u7aef\u53e3\uff0c<code>10252</code> \u662f <code>kube-controller-manager</code> \u7ec4\u4ef6\u7684\u76d1\u63a7\u6570\u636e\u6240\u5728\u7aef\u53e3\u3002</p> <p>\u5176\u4e2d\u6700\u91cd\u8981\u7684\u662f\u4e0a\u9762 <code>labels</code> \u548c <code>selector</code> \u90e8\u5206\uff0c<code>labels</code> \u533a\u57df\u7684\u914d\u7f6e\u5fc5\u987b\u548c\u6211\u4eec\u4e0a\u9762\u7684 <code>ServiceMonitor</code> \u5bf9\u8c61\u4e2d\u7684 <code>selector</code> \u4fdd\u6301\u4e00\u81f4\uff0c<code>selector</code> \u4e0b\u9762\u914d\u7f6e\u7684\u662f <code>component=kube-scheduler</code>\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u662f\u8fd9\u4e2a <code>label</code> \u6807\u7b7e\u5462\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb <code>describe</code> \u4e0b <code>kube-scheduler</code> \u8fd9\u4e2a <code>Pod</code>\uff1a</p> <pre><code>$ kubectl describe pod kube-scheduler-master -n kube-system\nName:         kube-scheduler-master\nNamespace:    kube-system\nNode:         master/10.151.30.57\nStart Time:   Sun, 05 Aug 2018 18:13:32 +0800\nLabels:       component=kube-scheduler\n              tier=control-plane\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a <code>Pod</code> \u5177\u6709<code>component=kube-scheduler</code>\u548c<code>tier=control-plane</code>\u8fd9\u4e24\u4e2a\u6807\u7b7e\uff0c\u800c\u524d\u9762\u8fd9\u4e2a\u6807\u7b7e\u5177\u6709\u66f4\u552f\u4e00\u7684\u7279\u6027\uff0c\u6240\u4ee5\u4f7f\u7528\u524d\u9762\u8fd9\u4e2a\u6807\u7b7e\u8f83\u597d\uff0c\u8fd9\u6837\u4e0a\u9762\u521b\u5efa\u7684 <code>Service</code> \u5c31\u53ef\u4ee5\u548c\u6211\u4eec\u7684 <code>Pod</code> \u8fdb\u884c\u5173\u8054\u4e86\uff0c\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create -f prometheus-kubeSchedulerService.yaml\n$ kubectl get svc -n kube-system -l k8s-app=kube-scheduler\nNAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE\nkube-scheduler   ClusterIP   10.102.119.231   &lt;none&gt;        10251/TCP   18m\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u5c0f\u4f1a\u513f\u540e\u53bb <code>prometheus</code> \u67e5\u770b <code>targets</code> \u4e0b\u9762 <code>kube-scheduler</code> \u7684\u72b6\u6001\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u5df2\u7ecf\u53d1\u73b0\u4e86 <code>target</code>\uff0c\u4f46\u662f\u6293\u53d6\u6570\u636e\u7ed3\u679c\u51fa\u9519\u4e86\uff0c\u8fd9\u4e2a\u9519\u8bef\u662f\u56e0\u4e3a\u6211\u4eec\u96c6\u7fa4\u662f\u4f7f\u7528 <code>kubeadm</code> \u642d\u5efa\u7684\uff0c\u5176\u4e2d <code>kube-scheduler</code> \u9ed8\u8ba4\u662f\u7ed1\u5b9a\u5728<code>127.0.0.1</code>\u4e0a\u9762\u7684\uff0c\u800c\u4e0a\u9762\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9\u662f\u60f3\u901a\u8fc7\u8282\u70b9\u7684 <code>IP</code> \u53bb\u8bbf\u95ee\uff0c\u6240\u4ee5\u8bbf\u95ee\u88ab\u62d2\u7edd\u4e86\uff0c\u6211\u4eec\u53ea\u8981\u628a <code>kube-scheduler</code> \u7ed1\u5b9a\u7684\u5730\u5740\u66f4\u6539\u6210<code>0.0.0.0</code>\u5373\u53ef\u6ee1\u8db3\u8981\u6c42\uff0c\u7531\u4e8e <code>kube-scheduler</code> \u662f\u4ee5\u9759\u6001 <code>Pod</code> \u7684\u5f62\u5f0f\u8fd0\u884c\u5728\u96c6\u7fa4\u4e2d\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u66f4\u6539\u9759\u6001 <code>Pod</code> \u76ee\u5f55\u4e0b\u9762\u5bf9\u5e94\u7684 <code>YAML</code> \u6587\u4ef6\u5373\u53ef\uff1a</p> <pre><code>$ ls /etc/kubernetes/manifests/\netcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml\n</code></pre> <p>\u5c06 <code>kube-scheduler.yaml</code> \u6587\u4ef6\u4e2d <code>-command</code> \u7684 <code>--address</code> \u5730\u5740\u66f4\u6539\u6210 <code>0.0.0.0</code>\uff1a</p> <pre><code>containers:\n- command:\n- kube-scheduler\n- --leader-elect=true\n- --kubeconfig=/etc/kubernetes/scheduler.conf\n- --address=0.0.0.0\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\u540e\u6211\u4eec\u5c06\u8be5\u6587\u4ef6\u4ece\u5f53\u524d\u6587\u4ef6\u5939\u4e2d\u79fb\u9664\uff0c\u9694\u4e00\u4f1a\u513f\u518d\u79fb\u56de\u8be5\u76ee\u5f55\uff0c\u5c31\u53ef\u4ee5\u81ea\u52a8\u66f4\u65b0\u4e86\uff0c\u7136\u540e\u518d\u53bb\u770b <code>prometheus</code> \u4e2d <code>kube-scheduler</code> \u8fd9\u4e2a <code>target</code> \u662f\u5426\u5df2\u7ecf\u6b63\u5e38\u4e86\uff1a</p> <p></p> <p>\u5927\u5bb6\u53ef\u4ee5\u6309\u7167\u4e0a\u9762\u7684\u65b9\u6cd5\u5c1d\u8bd5\u53bb\u4fee\u590d\u4e0b kube-controller-manager \u7ec4\u4ef6\u7684\u76d1\u63a7\u3002</p> <p>\u4e0a\u9762\u7684\u76d1\u63a7\u6570\u636e\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b <code>grafana</code> \u4e0b\u9762\u7684  <code>dashboard</code>\uff0c\u540c\u6837\u4f7f\u7528\u4e0a\u9762\u7684 <code>NodePort</code> \u8bbf\u95ee\u5373\u53ef\uff0c\u7b2c\u4e00\u6b21\u767b\u5f55\u4f7f\u7528 <code>admin:admin</code> \u767b\u5f55\u5373\u53ef\uff0c\u8fdb\u5165\u9996\u9875\u540e\uff0c\u53ef\u4ee5\u53d1\u73b0\u5df2\u7ecf\u548c\u6211\u4eec\u7684 <code>Prometheus</code> \u6570\u636e\u6e90\u5173\u8054\u4e0a\u4e86\uff0c\u6b63\u5e38\u6765\u8bf4\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u76d1\u63a7\u56fe\u8868\u4e86\uff1a</p> <p></p> <p></p>"},{"location":"chap4/13Adv_Prometheus_Operator_etcd/","title":"\u7b2c\u4e8c\u8282 \u4f7f\u7528 Prometheus Operator \u76d1\u63a7 etcd","text":"<p>\u9664\u4e86 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u7684\u4e00\u4e9b\u8d44\u6e90\u5bf9\u8c61\u3001\u8282\u70b9\u4ee5\u53ca\u7ec4\u4ef6\u9700\u8981\u76d1\u63a7\uff0c\u6709\u7684\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u8fd8\u9700\u8981\u6839\u636e\u5b9e\u9645\u7684\u4e1a\u52a1\u9700\u6c42\u53bb\u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u9879\uff0c\u6dfb\u52a0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u76d1\u63a7\u7684\u6b65\u9aa4\u4e5f\u662f\u975e\u5e38\u7b80\u5355\u7684\u3002</p> <ul> <li>\u7b2c\u4e00\u6b65\u5efa\u7acb\u4e00\u4e2a <code>ServiceMonitor</code> \u5bf9\u8c61\uff0c\u7528\u4e8e <code>Prometheus</code> \u6dfb\u52a0\u76d1\u63a7\u9879</li> <li>\u7b2c\u4e8c\u6b65\u4e3a <code>ServiceMonitor</code> \u5bf9\u8c61\u5173\u8054 <code>metrics</code> \u6570\u636e\u63a5\u53e3\u7684\u4e00\u4e2a <code>Service</code> \u5bf9\u8c61</li> <li>\u7b2c\u4e09\u6b65\u786e\u4fdd <code>Service</code> \u5bf9\u8c61\u53ef\u4ee5\u6b63\u786e\u83b7\u53d6\u5230 <code>metrics</code> \u6570\u636e</li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u4e3a\u5927\u5bb6\u6f14\u793a\u5982\u4f55\u6dfb\u52a0 <code>etcd</code> \u96c6\u7fa4\u7684\u76d1\u63a7\u3002</p> <p>\u65e0\u8bba\u662f Kubernetes \u96c6\u7fa4\u5916\u7684\u8fd8\u662f\u4f7f\u7528 <code>Kubeadm</code> \u5b89\u88c5\u5728\u96c6\u7fa4\u5185\u90e8\u7684 etcd \u96c6\u7fa4\uff0c\u6211\u4eec\u8fd9\u91cc\u90fd\u5c06\u5176\u89c6\u4f5c\u96c6\u7fa4\u5916\u7684\u72ec\u7acb\u96c6\u7fa4\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u4e8c\u8005\u7684\u4f7f\u7528\u65b9\u6cd5\u6ca1\u4ec0\u4e48\u7279\u6b8a\u4e4b\u5904\u3002</p>"},{"location":"chap4/13Adv_Prometheus_Operator_etcd/#1-etcd","title":"1 etcd \u8bc1\u4e66","text":"<p>\u5bf9\u4e8e <code>etcd</code> \u96c6\u7fa4\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e86\u5b89\u5168\u90fd\u4f1a\u5f00\u542f <code>https</code> \u8bc1\u4e66\u8ba4\u8bc1\u7684\u65b9\u5f0f\uff0c\u6240\u4ee5\u8981\u60f3\u8ba9 <code>Prometheus</code> \u8bbf\u95ee\u5230 <code>etcd</code> \u96c6\u7fa4\u7684\u76d1\u63a7\u6570\u636e\uff0c\u5c31\u9700\u8981\u63d0\u4f9b\u76f8\u5e94\u7684\u8bc1\u4e66\u6821\u9a8c\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u6f14\u793a\u73af\u5883\u4f7f\u7528\u7684\u662f <code>Kubeadm</code> \u642d\u5efa\u7684\u96c6\u7fa4\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>kubectl</code> \u5de5\u5177\u53bb\u83b7\u53d6 <code>etcd</code> \u542f\u52a8\u7684\u65f6\u5019\u4f7f\u7528\u7684\u8bc1\u4e66\u8def\u5f84\uff1a</p> <pre><code>$ kubectl get pods -n kube-system\nNAME                                          READY     STATUS    RESTARTS   AGE\netcd-master                                   1/1       Running   0          2h\n\n$ kubectl get pod etcd-master -n kube-system -o yaml\n\n......\nspec:\n  containers:\n  - command:\n    - etcd\n    - --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt\n    - --listen-client-urls=https://127.0.0.1:2379\n    - --advertise-client-urls=https://127.0.0.1:2379\n    - --client-cert-auth=true\n    - --peer-client-cert-auth=true\n    - --data-dir=/var/lib/etcd\n    - --cert-file=/etc/kubernetes/pki/etcd/server.crt\n    - --key-file=/etc/kubernetes/pki/etcd/server.key\n    - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt\n    - --peer-key-file=/etc/kubernetes/pki/etcd/peer.key\n    - --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt\n    image: k8s.gcr.io/etcd-amd64:3.1.12\n    imagePullPolicy: IfNotPresent\n    livenessProbe:\n      exec:\n        command:\n        - /bin/sh\n        - -ec\n        - ETCDCTL_API=3 etcdctl --endpoints=127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt\n          --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt --key=/etc/kubernetes/pki/etcd/healthcheck-client.key\n          get foo\n      failureThreshold: 8\n      initialDelaySeconds: 15\n      periodSeconds: 10\n      successThreshold: 1\n      timeoutSeconds: 15\n    name: etcd\n    resources: {}\n    terminationMessagePath: /dev/termination-log\n    terminationMessagePolicy: File\n    volumeMounts:\n    - mountPath: /var/lib/etcd\n      name: etcd-data\n    - mountPath: /etc/kubernetes/pki/etcd\n      name: etcd-certs\n......\n  tolerations:\n  - effect: NoExecute\n    operator: Exists\n  volumes:\n  - hostPath:\n      path: /var/lib/etcd\n      type: DirectoryOrCreate\n    name: etcd-data\n  - hostPath:\n      path: /etc/kubernetes/pki/etcd\n      type: DirectoryOrCreate\n    name: etcd-certs\n......\n\n</code></pre> <p><code>- o yaml Output format</code></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>etcd</code> \u4f7f\u7528\u7684\u8bc1\u4e66\u90fd\u5bf9\u5e94\u5728\u8282\u70b9\u7684 <code>/etc/kubernetes/pki/etcd</code> \u8fd9\u4e2a\u8def\u5f84\u4e0b\u9762\uff0c\u6240\u4ee5\u9996\u5148\u6211\u4eec\u5c06\u9700\u8981\u4f7f\u7528\u5230\u7684\u8bc1\u4e66\u901a\u8fc7 <code>secret</code> \u5bf9\u8c61\u4fdd\u5b58\u5230\u96c6\u7fa4\u4e2d\u53bb\uff1a<code>(\u5728 etcd \u8fd0\u884c\u7684\u8282\u70b9)</code></p> <pre><code>$ kubectl -n monitoring create secret generic etcd-certs --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.crt --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.key --from-file=/etc/kubernetes/pki/etcd/ca.crt\nsecret \"etcd-certs\" created\n</code></pre> <pre><code>secret generic\nCreate a secret based on a file, directory, or specified literal value.\n\nWhen creating a secret based on a file, the key will default to the basename of the file, and \nthe value will default to the file content. If the basename is an invalid key or you wish to \nchose your own, you may specify an alternate key.\n\nkubectl create secret generic my-secret --from-file=path/to/bar\n\n--from-file=/etc/kubernetes/pki/etcd/healthcheck-client.crt\n--from-file=/etc/kubernetes/pki/etcd/healthcheck-client.key\n--from-file=/etc/kubernetes/pki/etcd/ca.crts\n</code></pre> <p>\u7136\u540e\u5c06\u4e0a\u9762\u521b\u5efa\u7684 <code>etcd-certs</code> \u5bf9\u8c61\u914d\u7f6e\u5230 <code>prometheus</code> \u8d44\u6e90\u5bf9\u8c61\u4e2d\uff0c\u76f4\u63a5\u66f4\u65b0 <code>prometheus</code> \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl edit prometheus k8s -n monitoring\n</code></pre> <p><code>-n monitoring namespace</code> </p> <p>\u6dfb\u52a0\u5982\u4e0b\u7684 <code>secrets</code> \u5c5e\u6027\uff1a</p> <pre><code>nodeSelector:\n  beta.kubernetes.io/os: linux\nreplicas: 2\nsecrets:\n- etcd-certs\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 <code>Prometheus</code> \u7684 <code>Pod</code> \u4e2d\u83b7\u53d6\u5230\u4e0a\u9762\u521b\u5efa\u7684 <code>etcd</code> \u8bc1\u4e66\u6587\u4ef6\u4e86\uff0c\u5177\u4f53\u7684\u8def\u5f84\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165 <code>Pod</code> \u4e2d\u67e5\u770b\uff1a</p> <pre><code>$ kubectl exec -it prometheus-k8s-0 /bin/sh -n monitoring\nDefaulting container name to prometheus.\nUse 'kubectl describe pod/prometheus-k8s-0 -n monitoring' to see all of the containers in this pod.\n\n$ ls /etc/prometheus/secrets/etcd-certs/\nca.crt      healthcheck-client.crt  healthcheck-client.key\n</code></pre>"},{"location":"chap4/13Adv_Prometheus_Operator_etcd/#2-servicemonitor","title":"2 \u521b\u5efa ServiceMonitor","text":"<p>\u73b0\u5728 <code>Prometheus</code> \u8bbf\u95ee <code>etcd</code> \u96c6\u7fa4\u7684\u8bc1\u4e66\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\uff0c\u63a5\u4e0b\u6765\u521b\u5efa <code>ServiceMonitor</code> \u5bf9\u8c61\u5373\u53ef\uff08<code>prometheus-serviceMonitorEtcd.yaml</code>\uff09</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: etcd-k8s\n  namespace: monitoring\n  labels:\n    k8s-app: etcd-k8s\nspec:\n  jobLabel: k8s-app\n  endpoints:\n  - port: port\n    interval: 30s\n    scheme: https\n    tlsConfig:\n      caFile: /etc/prometheus/secrets/etcd-certs/ca.crt\n      certFile: /etc/kubernetes/pki/etcd/healthcheck-client.crt\n      keyFile: /etc/kubernetes/pki/etcd/healthcheck-client.key\n      insecureSkipVerify: true\n  selector:\n    matchLabels:\n      k8s-app: etcd\n  namespaceSelector:\n    matchNames:\n    - kube-system\n</code></pre> <ol> <li>\u4e0a\u9762\u6211\u4eec\u5728 <code>monitoring</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u4e86\u540d\u4e3a <code>etcd-k8s</code> \u7684 <code>ServiceMonitor</code> \u5bf9\u8c61\uff0c\u57fa\u672c\u5c5e\u6027\u548c\u524d\u9762\u7ae0\u8282\u4e2d\u7684\u4e00\u81f4\uff0c</li> <li>\u5339\u914d <code>kube-system</code> \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u5177\u6709 <code>k8s-app=etcd</code> \u8fd9\u4e2a <code>label</code> \u6807\u7b7e\u7684 <code>Service</code>\uff0c<code>jobLabel</code> \u8868\u793a\u7528\u4e8e\u68c0\u7d22 <code>job</code> \u4efb\u52a1\u540d\u79f0\u7684\u6807\u7b7e\uff0c</li> <li>\u548c\u524d\u9762\u4e0d\u592a\u4e00\u6837\u7684\u5730\u65b9\u662f <code>endpoints</code> \u5c5e\u6027\u7684\u5199\u6cd5\uff0c\u914d\u7f6e\u4e0a\u8bbf\u95ee <code>etcd</code> \u7684\u76f8\u5173\u8bc1\u4e66\uff0c<code>endpoints</code> \u5c5e\u6027\u4e0b\u9762\u53ef\u4ee5\u914d\u7f6e\u5f88\u591a\u6293\u53d6\u7684\u53c2\u6570\uff0c\u6bd4\u5982 <code>relabel</code>\u3001<code>proxyUrl</code>\uff0c<code>tlsConfig</code> \u8868\u793a\u7528\u4e8e\u914d\u7f6e\u6293\u53d6\u76d1\u63a7\u6570\u636e\u7aef\u70b9\u7684 <code>tls</code> \u8ba4\u8bc1\uff0c\u7531\u4e8e\u8bc1\u4e66 <code>serverName</code> \u548c <code>etcd</code> \u4e2d\u7b7e\u53d1\u7684\u53ef\u80fd\u4e0d\u5339\u914d\uff0c\u6240\u4ee5\u52a0\u4e0a\u4e86 <code>insecureSkipVerify=true</code></li> </ol> <p></p> <p>\u5173\u4e8e ServiceMonitor \u5c5e\u6027\u7684\u66f4\u591a\u7528\u6cd5\u53ef\u4ee5\u67e5\u770b\u6587\u6863\uff1ahttps://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md \u4e86\u89e3\u66f4\u591a</p> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a <code>ServiceMonitor</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f prometheus-serviceMonitorEtcd.yaml\nservicemonitor.monitoring.coreos.com \"etcd-k8s\" created\n</code></pre>"},{"location":"chap4/13Adv_Prometheus_Operator_etcd/#3-service","title":"3 \u521b\u5efa Service","text":"<p>ServiceMonitor \u521b\u5efa\u5b8c\u6210\u4e86\uff0c\u4f46\u662f\u73b0\u5728\u8fd8\u6ca1\u6709\u5173\u8054\u7684\u5bf9\u5e94\u7684 Service \u5bf9\u8c61\uff0c\u6240\u4ee5\u9700\u8981\u6211\u4eec\u53bb\u624b\u52a8\u521b\u5efa\u4e00\u4e2a Service \u5bf9\u8c61\uff08prometheus-etcdService.yaml\uff09\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: etcd-k8s\n  namespace: kube-system\n  labels:\n    k8s-app: etcd\nspec:\n  type: ClusterIP\n  clusterIP: None\n  ports:\n  - name: port\n    port: 2379\n    protocol: TCP\n\n---\napiVersion: v1\nkind: Endpoints\nmetadata:\n  name: etcd-k8s\n  namespace: kube-system\n  labels:\n    k8s-app: etcd\nsubsets:\n- addresses:\n  - ip: 10.151.30.57\n    nodeName: etc-master\n  ports:\n  - name: port\n    port: 2379\n    protocol: TCP\n</code></pre> <ul> <li>\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u7684 <code>Service</code> \u6ca1\u6709\u91c7\u7528\u524d\u9762\u901a\u8fc7 <code>label</code> \u6807\u7b7e\u7684\u5f62\u5f0f\u53bb\u5339\u914d <code>Pod</code> \u7684\u505a\u6cd5\uff0c\u56e0\u4e3a\u524d\u9762\u6211\u4eec\u8bf4\u8fc7\u5f88\u591a\u65f6\u5019\u6211\u4eec\u521b\u5efa\u7684 etcd \u96c6\u7fa4\u662f\u72ec\u7acb\u4e8e\u96c6\u7fa4\u4e4b\u5916\u7684\uff0c</li> <li>\u8fd9\u79cd\u60c5\u51b5\u4e0b\u9762\u6211\u4eec\u5c31\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e2a <code>Endpoints</code>\uff0c\u8981\u6ce8\u610f <code>metadata</code> \u533a\u57df\u7684\u5185\u5bb9\u8981\u548c <code>Service</code> \u4fdd\u6301\u4e00\u81f4\uff0c<code>Service</code> \u7684 <code>clusterIP</code> \u8bbe\u7f6e\u4e3a <code>None</code>\uff0c\u5bf9\u6539\u77e5\u8bc6\u70b9\u4e0d\u592a\u719f\u6089\u7684\uff0c\u53ef\u4ee5\u53bb\u67e5\u770b\u6211\u4eec\u524d\u9762\u5173\u4e8e Service \u90e8\u5206\u7684\u8bb2\u89e3\u3002</li> <li><code>Endpoints</code> \u7684 <code>subsets</code> \u4e2d\u586b\u5199 <code>etcd</code> \u96c6\u7fa4\u7684\u5730\u5740\u5373\u53ef\uff0c\u6211\u4eec\u8fd9\u91cc\u662f\u5355\u8282\u70b9\u7684\uff0c\u586b\u5199\u4e00\u4e2a\u5373\u53ef\uff0c</li> </ul> <p>\u76f4\u63a5\u521b\u5efa\u8be5 Service \u8d44\u6e90\uff1a</p> <pre><code>$ kubectl create -f prometheus-etcdService.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u4f1a\u513f\u53bb <code>Prometheus</code> \u7684 <code>Dashboard</code> \u4e2d\u67e5\u770b <code>targets</code>\uff0c\u4fbf\u4f1a\u6709 <code>etcd</code> \u7684\u76d1\u63a7\u9879\u4e86\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u8fd8\u662f\u6709\u4e00\u4e2a\u660e\u663e\u7684\u9519\u8bef\uff0c\u548c\u6211\u4eec\u4e0a\u8282\u8bfe\u76d1\u63a7 <code>kube-scheduler</code> \u7684\u9519\u8bef\u6bd4\u8f83\u7c7b\u4f3c\u4e8e\uff0c\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u7684 etcd \u7684\u662f\u76d1\u542c\u5728 <code>127.0.0.1</code> \u8fd9\u4e2a <code>IP</code> \u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u8bbf\u95ee\u4f1a\u62d2\u7edd\uff1a</p> <pre><code>--listen-client-urls=https://127.0.0.1:2379\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u53ea\u9700\u8981\u5728 <code>/etc/kubernetes/manifest/</code> \u76ee\u5f55\u4e0b\u9762\uff08static pod \u9ed8\u8ba4\u7684\u76ee\u5f55\uff09\u7684 <code>etcd.yaml</code> \u6587\u4ef6\u4e2d\u5c06\u4e0a\u9762\u7684<code>listen-client-urls</code>\u66f4\u6539\u6210 <code>0.0.0.0</code> \u5373\u53ef\uff1a</p> <pre><code>$ ls /etc/kubernetes/manifests/\netcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml\n</code></pre> <pre><code>--listen-client-urls=https://0.0.0.0:2379\n</code></pre> <p>\u91cd\u542f etcd\uff0c\u751f\u6548\u540e\uff0c\u67e5\u770b etcd \u8fd9\u4e2a\u76d1\u63a7\u4efb\u52a1\u5c31\u6b63\u5e38\u4e86\uff1a</p> <p></p> <p>\u6570\u636e\u91c7\u96c6\u5230\u540e\uff0c\u53ef\u4ee5\u5728 <code>grafana</code> \u4e2d\u5bfc\u5165\u7f16\u53f7\u4e3a<code>3070</code>\u7684 <code>dashboard</code>\uff0c\u83b7\u53d6\u5230 <code>etcd</code> \u7684\u76d1\u63a7\u56fe\u8868\u3002</p> <p></p>"},{"location":"chap4/14Adv_Prometheus_Operator_alarm/","title":"\u7b2c\u4e09\u8282 Prometheus Operator \u81ea\u5b9a\u4e49\u62a5\u8b66","text":""},{"location":"chap4/14Adv_Prometheus_Operator_alarm/#1-prometheusrule","title":"1 \u914d\u7f6e PrometheusRule","text":"<p>\u73b0\u5728\u6211\u4eec\u77e5\u9053\u600e\u4e48\u81ea\u5b9a\u4e49\u4e00\u4e2a <code>ServiceMonitor</code> \u5bf9\u8c61\u4e86\uff0c\u4f46\u662f\u5982\u679c\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e2a\u62a5\u8b66\u89c4\u5219\u7684\u8bdd\u5462\uff1f\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u53bb\u67e5\u770b <code>Prometheus Dashboard</code> \u7684 <code>Alert</code> \u9875\u9762\u4e0b\u9762\u5c31\u5df2\u7ecf\u6709\u4e00\u4e9b\u62a5\u8b66\u89c4\u5219\u4e86\uff0c\u8fd8\u6709\u4e00\u4e9b\u662f\u5df2\u7ecf\u89e6\u53d1\u89c4\u5219\u7684</p> <p></p> <p>\u4f46\u662f\u8fd9\u4e9b\u62a5\u8b66\u4fe1\u606f\u662f\u54ea\u91cc\u6765\u7684\u5462\uff1f\u4ed6\u4eec\u5e94\u8be5\u7528\u600e\u6837\u7684\u65b9\u5f0f\u901a\u77e5\u6211\u4eec\u5462\uff1f</p> <p>\u6211\u4eec\u77e5\u9053\u4e4b\u524d\u6211\u4eec\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u53ef\u4ee5\u5728 <code>Prometheus</code> \u7684\u914d\u7f6e\u6587\u4ef6\u4e4b\u4e2d\u6307\u5b9a <code>AlertManager</code> \u5b9e\u4f8b\u548c \u62a5\u8b66\u7684 <code>rules</code> \u6587\u4ef6\uff0c\u73b0\u5728\u6211\u4eec\u901a\u8fc7 <code>Operator</code> \u90e8\u7f72\u7684\u5462\uff1f</p> <p>\u6211\u4eec\u53ef\u4ee5\u5728 <code>Prometheus Dashboard</code> \u7684 <code>Config</code> \u9875\u9762\u4e0b\u9762\u67e5\u770b\u5173\u4e8e <code>AlertManager</code> \u7684\u914d\u7f6e\uff1a</p> <pre><code>alerting:\n  alert_relabel_configs:\n  - separator: ;\n    regex: prometheus_replica\n    replacement: $1\n    action: labeldrop\n  alertmanagers:\n  - kubernetes_sd_configs:\n    - role: endpoints\n      namespaces:\n        names:\n        - monitoring\n    scheme: http\n    path_prefix: /\n    timeout: 10s\n    relabel_configs:\n    - source_labels: [__meta_kubernetes_service_name]\n      separator: ;\n      regex: alertmanager-main\n      replacement: $1\n      action: keep\n    - source_labels: [__meta_kubernetes_endpoint_port_name]\n      separator: ;\n      regex: web\n      replacement: $1\n      action: keep\nrule_files:\n- /etc/prometheus/rules/prometheus-k8s-rulefiles-0/*.yaml\n</code></pre> <p>\u4e0a\u9762 <code>alertmanagers</code> \u5b9e\u4f8b\u7684\u914d\u7f6e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u662f\u901a\u8fc7\u89d2\u8272\u4e3a <code>endpoints</code> \u7684 <code>kubernetes</code> \u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\u83b7\u53d6\u7684\uff0c\u5339\u914d\u7684\u662f\u670d\u52a1\u540d\u4e3a <code>alertmanager-main</code>\uff0c\u7aef\u53e3\u540d\u672a <code>web</code> \u7684 <code>Service</code> \u670d\u52a1\uff0c\u6211\u4eec\u67e5\u770b\u4e0b <code>alertmanager-main</code> \u8fd9\u4e2a <code>Service</code>\uff1a</p> <pre><code>kubectl describe svc alertmanager-main -n monitoring\nName:                     alertmanager-main\nNamespace:                monitoring\nLabels:                   alertmanager=main\nAnnotations:              kubectl.kubernetes.io/last-applied-configuration={\"apiVersion\":\"v1\",\"kind\":\"Service\",\"metadata\":{\"annotations\":{},\"labels\":{\"alertmanager\":\"main\"},\"name\":\"alertmanager-main\",\"namespace\":\"monitoring\"},...\nSelector:                 alertmanager=main,app=alertmanager\nType:                     NodePort\nIP:                       10.104.156.29\nPort:                     web  9093/TCP\nTargetPort:               web/TCP\nNodePort:                 web  31918/TCP\nEndpoints:                10.244.2.34:9093,10.244.2.37:9093,10.244.4.109:9093\nSession Affinity:         None\nExternal Traffic Policy:  Cluster\nEvents:                   &lt;none&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u670d\u52a1\u540d\u6b63\u662f <code>alertmanager-main</code>\uff0c<code>Port</code> \u5b9a\u4e49\u7684\u540d\u79f0\u4e5f\u662f <code>web</code>\uff0c\u7b26\u5408\u4e0a\u9762\u7684\u89c4\u5219\uff0c\u6240\u4ee5 <code>Prometheus</code> \u548c <code>AlertManager</code> \u7ec4\u4ef6\u5c31\u6b63\u786e\u5173\u8054\u4e0a\u4e86\u3002\u800c\u5bf9\u5e94\u7684\u62a5\u8b66\u89c4\u5219\u6587\u4ef6\u4f4d\u4e8e\uff1a<code>/etc/prometheus/rules/prometheus-k8s-rulefiles-0/</code>\u76ee\u5f55\u4e0b\u9762\u6240\u6709\u7684 <code>YAML</code> \u6587\u4ef6\u3002\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165 <code>Prometheus</code> \u7684 <code>Pod</code> \u4e2d\u9a8c\u8bc1\u4e0b\u8be5\u76ee\u5f55\u4e0b\u9762\u662f\u5426\u6709 <code>YAML</code> \u6587\u4ef6\uff1a</p> <pre><code>$ kubectl exec -it prometheus-k8s-0 /bin/sh -n monitoring\nDefaulting container name to prometheus.\nUse 'kubectl describe pod/prometheus-k8s-0 -n monitoring' to see all of the containers in this pod.\n/prometheus $ ls /etc/prometheus/rules/prometheus-k8s-rulefiles-0/\nmonitoring-prometheus-k8s-rules.yaml\n/prometheus $ cat /etc/prometheus/rules/prometheus-k8s-rulefiles-0/monitoring-pr\nometheus-k8s-rules.yaml\ngroups:\n- name: k8s.rules\n  rules:\n  - expr: |\n      sum(rate(container_cpu_usage_seconds_total{job=\"kubelet\", image!=\"\", container_name!=\"\"}[5m])) by (namespace)\n    record: namespace:container_cpu_usage_seconds_total:sum_rate\n......\n</code></pre> <p>\u8fd9\u4e2a <code>YAML</code> \u6587\u4ef6\u5b9e\u9645\u4e0a\u5c31\u662f\u6211\u4eec\u4e4b\u524d\u521b\u5efa\u7684\u4e00\u4e2a <code>PrometheusRule</code> \u6587\u4ef6\u5305\u542b\u7684\uff1a</p> <pre><code>$ cat prometheus-rules.yaml\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: prometheus-k8s-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: k8s.rules\n    rules:\n    - expr: |\n        sum(rate(container_cpu_usage_seconds_total{job=\"kubelet\", image!=\"\", container_name!=\"\"}[5m])) by (namespace)\n      record: namespace:container_cpu_usage_seconds_total:sum_rate\n</code></pre> <ul> <li>\u6211\u4eec\u8fd9\u91cc\u7684 <code>PrometheusRule</code> \u7684 <code>name</code> \u4e3a <code>prometheus-k8s-rules</code>\uff0c<code>namespace</code> \u4e3a <code>monitoring</code>.</li> <li>\u6211\u4eec\u53ef\u4ee5\u731c\u60f3\u5230\u6211\u4eec\u521b\u5efa\u4e00\u4e2a <code>PrometheusRule</code> \u8d44\u6e90\u5bf9\u8c61\u540e\uff0c\u4f1a\u81ea\u52a8\u5728\u4e0a\u9762\u7684<code>prometheus-k8s-rulefiles-0</code> \u76ee\u5f55\u4e0b\u9762\u751f\u6210\u4e00\u4e2a\u5bf9\u5e94\u7684<code>&lt;namespace&gt;-&lt;name&gt;.yaml</code>\u6587\u4ef6\uff0c</li> <li>\u6240\u4ee5\u5982\u679c\u4ee5\u540e\u6211\u4eec\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e2a\u62a5\u8b66\u9009\u9879\u7684\u8bdd\uff0c\u53ea\u9700\u8981\u5b9a\u4e49\u4e00\u4e2a <code>PrometheusRule</code> \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48 </li> <li><code>Prometheus</code> \u80fd\u591f\u8bc6\u522b\u8fd9\u4e2a <code>PrometheusRule</code> \u8d44\u6e90\u5bf9\u8c61\u5462\uff1f\u8fd9\u5c31\u9700\u8981\u67e5\u770b\u6211\u4eec\u521b\u5efa\u7684 <code>prometheus</code> \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u4e86\uff0c\u91cc\u9762\u6709\u975e\u5e38\u91cd\u8981\u7684\u4e00\u4e2a\u5c5e\u6027 <code>ruleSelector</code>\uff0c\u7528\u6765\u5339\u914d <code>rule</code> \u89c4\u5219\u7684\u8fc7\u6ee4\u5668\uff0c\u8981\u6c42\u5339\u914d\u5177\u6709 <code>prometheus=k8s</code> \u548c <code>role=alert-rules</code> \u6807\u7b7e\u7684 <code>PrometheusRule</code> \u8d44\u6e90\u5bf9\u8c61.</li> </ul> <pre><code>ruleSelector:\n  matchLabels:\n    prometheus: k8s\n    role: alert-rules\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u8981\u60f3\u81ea\u5b9a\u4e49\u4e00\u4e2a\u62a5\u8b66\u89c4\u5219\uff0c\u53ea\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5177\u6709 <code>prometheus=k8s</code> \u548c <code>role=alert-rules</code> \u6807\u7b7e\u7684 <code>PrometheusRule</code> \u5bf9\u8c61\u5c31\u884c\u4e86\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a <code>etcd</code> \u662f\u5426\u53ef\u7528\u7684\u62a5\u8b66\uff0c\u6211\u4eec\u77e5\u9053 <code>etcd</code> \u6574\u4e2a\u96c6\u7fa4\u6709\u4e00\u534a\u4ee5\u4e0a\u7684\u8282\u70b9\u53ef\u7528\u7684\u8bdd\u96c6\u7fa4\u5c31\u662f\u53ef\u7528\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5224\u65ad\u5982\u679c\u4e0d\u53ef\u7528\u7684 <code>etcd</code> \u6570\u91cf\u8d85\u8fc7\u4e86\u4e00\u534a\u90a3\u4e48\u5c31\u89e6\u53d1\u62a5\u8b66\uff0c\u521b\u5efa\u6587\u4ef6 <code>prometheus-etcdRules.yaml</code>\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s               // `prometheus=k8s` \u548c `role=alert-rules`\n    role: alert-rules              \n  name: etcd-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: etcd\n    rules:\n    - alert: EtcdClusterUnavailable\n      annotations:\n        summary: etcd cluster small\n        description: If one more etcd peer goes down the cluster will be unavailable\n      expr: |\n        count(up{job=\"etcd\"} == 0) &gt; (count(up{job=\"etcd\"}) / 2 - 1)\n      for: 3m\n      labels:\n        severity: critical\n\n</code></pre> <p>\u6ce8\u610f <code>label</code> \u6807\u7b7e\u4e00\u5b9a\u81f3\u5c11\u8981\u6709 <code>prometheus=k8s</code> \u548c <code>role=alert-rules</code>\uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u4f1a\u513f\u518d\u53bb\u5bb9\u5668\u4e2d\u67e5\u770b\u4e0b <code>rules</code> \u6587\u4ef6\u5939\uff1a</p> <pre><code>kubectl exec -it prometheus-k8s-0 /bin/sh -n monitoring\nDefaulting container name to prometheus.\nUse 'kubectl describe pod/prometheus-k8s-0 -n monitoring' to see all of the containers in this pod.\n/prometheus $ ls /etc/prometheus/rules/prometheus-k8s-rulefiles-0/\nmonitoring-etcd-rules.yaml            monitoring-prometheus-k8s-rules.yaml\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u521b\u5efa\u7684 <code>rule</code> \u6587\u4ef6\u5df2\u7ecf\u88ab\u6ce8\u5165\u5230\u4e86\u5bf9\u5e94\u7684 <code>rulefiles</code> \u6587\u4ef6\u5939\u4e0b\u9762\u4e86\uff0c\u8bc1\u660e\u6211\u4eec\u4e0a\u9762\u7684\u8bbe\u60f3\u662f\u6b63\u786e\u7684\u3002\u7136\u540e\u518d\u53bb <code>Prometheus Dashboard</code> \u7684 <code>Alert</code> \u9875\u9762\u4e0b\u9762\u5c31\u53ef\u4ee5\u67e5\u770b\u5230\u4e0a\u9762\u6211\u4eec\u65b0\u5efa\u7684\u62a5\u8b66\u89c4\u5219\u4e86\uff1a</p> <p></p>"},{"location":"chap4/14Adv_Prometheus_Operator_alarm/#2","title":"2 \u914d\u7f6e\u62a5\u8b66","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86\u5982\u4f55\u53bb\u6dfb\u52a0\u4e00\u4e2a\u62a5\u8b66\u89c4\u5219\u914d\u7f6e\u9879\uff0c\u4f46\u662f\u8fd9\u4e9b\u62a5\u8b66\u4fe1\u606f\u7528\u600e\u6837\u7684\u65b9\u5f0f\u53bb\u53d1\u9001\u5462\uff1f\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u77e5\u9053\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>AlertManager</code> \u7684\u914d\u7f6e\u6587\u4ef6\u53bb\u914d\u7f6e\u5404\u79cd\u62a5\u8b66\u63a5\u6536\u5668\uff0c\u73b0\u5728\u6211\u4eec\u662f\u901a\u8fc7 <code>Operator</code> \u63d0\u4f9b\u7684 <code>alertmanager</code> \u8d44\u6e90\u5bf9\u8c61\u521b\u5efa\u7684\u7ec4\u4ef6\uff0c\u5e94\u8be5\u600e\u6837\u53bb\u4fee\u6539\u914d\u7f6e\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u5c06<code>alertmanager-main</code> \u8fd9\u4e2a <code>Service</code> \u6539\u4e3a <code>NodePort</code> \u7c7b\u578b\u7684 <code>Service</code></p> <p>\u4fee\u6539\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u5728\u9875\u9762\u4e0a\u7684 <code>status</code> \u8def\u5f84\u4e0b\u9762\u67e5\u770b <code>AlertManager</code> \u7684\u914d\u7f6e\u4fe1\u606f:</p> <p></p> <p>\u8fd9\u4e9b\u914d\u7f6e\u4fe1\u606f\u5b9e\u9645\u4e0a\u662f\u6765\u81ea\u4e8e\u6211\u4eec\u4e4b\u524d\u5728 <code>prometheus-operator/contrib/kube-prometheus/manifests</code> \u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7684 <code>alertmanager-secret.yaml</code> \u6587\u4ef6\uff1a</p> <pre><code>apiVersion: v1\ndata:\n  alertmanager.yaml: Imdsb2JhbCI6IAogICJyZXNvbHZlX3RpbWVvdXQiOiAiNW0iCiJyZWNlaXZlcnMiOiAKLSAibmFtZSI6ICJudWxsIgoicm91dGUiOiAKICAiZ3JvdXBfYnkiOiAKICAtICJqb2IiCiAgImdyb3VwX2ludGVydmFsIjogIjVtIgogICJncm91cF93YWl0IjogIjMwcyIKICAicmVjZWl2ZXIiOiAibnVsbCIKICAicmVwZWF0X2ludGVydmFsIjogIjEyaCIKICAicm91dGVzIjogCiAgLSAibWF0Y2giOiAKICAgICAgImFsZXJ0bmFtZSI6ICJEZWFkTWFuc1N3aXRjaCIKICAgICJyZWNlaXZlciI6ICJudWxsIg==\nkind: Secret\nmetadata:\n  name: alertmanager-main\n  namespace: monitoring\ntype: Opaque\n</code></pre> <p>\u53ef\u4ee5\u5c06 <code>alertmanager.yaml</code> \u5bf9\u5e94\u7684 <code>value</code> \u503c\u505a\u4e00\u4e2a <code>base64</code> \u89e3\u7801\uff1a</p> <pre><code>$ echo \"Imdsb2JhbCI6IAogICJyZXNvbHZlX3RpbWVvdXQiOiAiNW0iCiJyZWNlaXZlcnMiOiAKLSAibmFtZSI6ICJudWxsIgoicm91dGUiOiAKICAiZ3JvdXBfYnkiOiAKICAtICJqb2IiCiAgImdyb3VwX2ludGVydmFsIjogIjVtIgogICJncm91cF93YWl0IjogIjMwcyIKICAicmVjZWl2ZXIiOiAibnVsbCIKICAicmVwZWF0X2ludGVydmFsIjogIjEyaCIKICAicm91dGVzIjogCiAgLSAibWF0Y2giOiAKICAgICAgImFsZXJ0bmFtZSI6ICJEZWFkTWFuc1N3aXRjaCIKICAgICJyZWNlaXZlciI6ICJudWxsIg==\" | base64 -D\n\"global\":\n  \"resolve_timeout\": \"5m\"\n\"receivers\":\n- \"name\": \"null\"\n\"route\":\n  \"group_by\":\n  - \"job\"\n  \"group_interval\": \"5m\"\n  \"group_wait\": \"30s\"\n  \"receiver\": \"null\"\n  \"repeat_interval\": \"12h\"\n  \"routes\":\n  - \"match\":\n      \"alertname\": \"DeadMansSwitch\"\n    \"receiver\": \"null\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5185\u5bb9\u548c\u4e0a\u9762\u67e5\u770b\u7684\u914d\u7f6e\u4fe1\u606f\u662f\u4e00\u81f4\u7684\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u60f3\u8981\u6dfb\u52a0\u81ea\u5df1\u7684\u63a5\u6536\u5668\uff0c\u6216\u8005\u6a21\u677f\u6d88\u606f\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u66f4\u6539\u8fd9\u4e2a\u6587\u4ef6\uff1a</p> <pre><code>global:\n  resolve_timeout: 5m\n  smtp_smarthost: 'smtp.gmail.com'\n  smtp_from: 'xichao2014@gmail.com'\n  smtp_auth_username: 'xichao2014@gmail.com'\n  smtp_auth_password: '&lt;\u90ae\u7bb1\u5bc6\u7801&gt;'\n  smtp_hello: 'gmail.com'\n  smtp_require_tls: false\nroute:\n  group_by: ['job', 'severity']\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 12h\n  receiver: default\n  routes:\n  - receiver: webhook\n    match:\n      alertname: CoreDNSDown\nreceivers:\n- name: 'default'\n  email_configs:\n  - to: 'xichao2017@gmail.com'\n    send_resolved: true\n- name: 'webhook'\n  webhook_configs:\n  - url: 'http://dingtalk-hook.kube-ops:5000'\n    send_resolved: true\n</code></pre> <p>\u5c06\u4e0a\u9762\u6587\u4ef6\u4fdd\u5b58\u4e3a <code>alertmanager.yaml</code>\uff0c\u7136\u540e\u4f7f\u7528\u8fd9\u4e2a\u6587\u4ef6\u521b\u5efa\u4e00\u4e2a <code>Secret</code> \u5bf9\u8c61\uff1a</p> <pre><code># \u5148\u5c06\u4e4b\u524d\u7684 secret \u5bf9\u8c61\u5220\u9664\n$ kubectl delete secret alertmanager-main -n monitoring\nsecret \"alertmanager-main\" deleted\n$ kubectl create secret generic alertmanager-main --from-file=alertmanager.yaml -n monitoring\nsecret \"alertmanager-main\" created\n</code></pre> <p>\u6211\u4eec\u6dfb\u52a0\u4e86\u4e24\u4e2a\u63a5\u6536\u5668\uff0c\u9ed8\u8ba4\u7684\u901a\u8fc7\u90ae\u7bb1\u8fdb\u884c\u53d1\u9001\uff0c\u5bf9\u4e8e <code>CoreDNSDown</code> \u8fd9\u4e2a\u62a5\u8b66\u6211\u4eec\u901a\u8fc7 <code>webhook</code> \u6765\u8fdb\u884c\u53d1\u9001\uff0c\u8fd9\u4e2a <code>webhook</code> \u5c31\u662f\u6211\u4eec\u524d\u9762\u8bfe\u7a0b\u4e2d\u5b9a\u4e49\u7684\u4e00\u4e2a\u9489\u9489\u63a5\u6536\u7684 <code>Server</code>\uff0c\u4e0a\u9762\u7684\u6b65\u9aa4\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u5f88\u5feb\u6211\u4eec\u5c31\u4f1a\u6536\u5230\u4e00\u6761\u9489\u9489\u6d88\u606f\uff1a</p> <p></p> <p>\u540c\u6837\u90ae\u7bb1\u4e2d\u4e5f\u4f1a\u6536\u5230\u62a5\u8b66\u4fe1\u606f\uff1a</p> <p></p> <p>\u6211\u4eec\u518d\u6b21\u67e5\u770b <code>AlertManager</code> \u9875\u9762\u7684 <code>status</code> \u9875\u9762\u7684\u914d\u7f6e\u4fe1\u606f\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u53d8\u6210\u4e0a\u9762\u6211\u4eec\u7684\u914d\u7f6e\u4fe1\u606f\u4e86\uff1a</p>"},{"location":"chap4/14Adv_Prometheus_Operator_alarm/#config","title":"Config","text":"<p><code>AlertManager</code> \u914d\u7f6e\u4e5f\u53ef\u4ee5\u4f7f\u7528\u6a21\u677f(<code>.tmpl\u6587\u4ef6</code>)\uff0c\u8fd9\u4e9b\u6a21\u677f\u53ef\u4ee5\u4e0e <code>alertmanager.yaml</code> \u914d\u7f6e\u6587\u4ef6\u4e00\u8d77\u6dfb\u52a0\u5230 <code>Secret</code> \u5bf9\u8c61\u4e2d\uff0c\u6bd4\u5982\uff1a</p> <pre><code>apiVersion\uff1av1\nkind\uff1asecret\nmetadata\uff1a\n   name\uff1aalertmanager-example\ndata\uff1a\n  alertmanager.yaml\uff1a{BASE64_CONFIG}\n  template_1.tmpl\uff1a{BASE64_TEMPLATE_1}\n  template_2.tmpl\uff1a{BASE64_TEMPLATE_2}\n  ...\n</code></pre> <p>\u6a21\u677f\u4f1a\u88ab\u653e\u7f6e\u5230\u4e0e\u914d\u7f6e\u6587\u4ef6\u76f8\u540c\u7684\u8def\u5f84\uff0c\u5f53\u7136\u8981\u4f7f\u7528\u8fd9\u4e9b\u6a21\u677f\u6587\u4ef6\uff0c\u8fd8\u9700\u8981\u5728 <code>alertmanager.yam</code>l \u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\uff1a</p> <pre><code>templates:\n- '*.tmpl'\n</code></pre> <p>\u521b\u5efa\u6210\u529f\u540e\uff0c<code>Secret</code> \u5bf9\u8c61\u5c06\u4f1a\u6302\u8f7d\u5230 <code>AlertManager</code> \u5bf9\u8c61\u521b\u5efa\u7684 <code>AlertManager Pod</code> \u4e2d\u53bb\u3002</p>"},{"location":"chap4/22Customize_Alert_Email/","title":"\u7b2c\u56db\u8282 Add Custom Alert and Send Alert Email with Alertmanager","text":""},{"location":"chap4/22Customize_Alert_Email/#1-add-custom-alert-prometheus-operator","title":"1 Add Custom Alert (prometheus operator)","text":""},{"location":"chap4/22Customize_Alert_Email/#step-one-check-ruleselector-from-prometheus-operator","title":"Step one: Check <code>ruleSelector</code> from prometheus-operator","text":"<p>Why Should I do this, please check reference \u914d\u7f6e PrometheusRule</p> <pre><code>kubectl get Prometheus monitoring-prometheus-oper-prometheus -n monitoring -oyaml\n\n...\nruleSelector:\n    matchLabels:\n      app: prometheus-operator\n      release: monitoring\n...\n</code></pre>"},{"location":"chap4/22Customize_Alert_Email/#step-two-custom-alert-info-for-git_proxy-in-ubertest-cluster","title":"Step two: Custom Alert info for <code>git_proxy</code> in Ubertest Cluster","text":"<pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    app: prometheus-operator\n    release: monitoring\n  name: gitproxy-memory-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: gitproxy\n    rules:\n    - alert: GitproxyMemoryHigh\n      annotations:\n        summary: gitproxy memory is over 2gb in 30 minutes\n        description: gitproxy pod memory is unusually high and normally below 1gb\n      expr: | \n        (avg_over_time(container_memory_usage_bytes{namespace=\"management\", container_name=\"gitproxy\"}[30m]) / (1024*1024)) &gt; 2048\n      labels:\n        severity: critical\n</code></pre> <pre><code>$ kubectl apply -f gitproxy_memory_rule.yaml \nprometheusrule.monitoring.coreos.com/gitproxy-memory-rules configured\n</code></pre>"},{"location":"chap4/22Customize_Alert_Email/#step-three-check-alert-works-or-not","title":"Step Three: Check alert works or not","text":"<ul> <li>Option one</li> </ul> <pre><code>$ kubectl -n monitoring port-forward prometheus-monitoring-prometheus-oper-prometheus-0 9090:9090\n</code></pre> <ul> <li>Option two</li> </ul> <pre><code>$ kubectl exec prometheus-monitoring-prometheus-oper-prometheus-0 -n monitoring -it sh\n\n# cd /etc/prometheus/rules/prometheus-monitoring-prometheus-oper-prometheus-rulefiles-0/\n\n# ls -la \n</code></pre> <p>**Reference: **</p> <ul> <li>https://timber.io/blog/promql-for-humans/</li> </ul>"},{"location":"chap4/22Customize_Alert_Email/#2-send-alert-email","title":"2 Send alert email","text":""},{"location":"chap4/22Customize_Alert_Email/#step-one-check-origin-alert-email-config","title":"Step one Check origin alert email config","text":"<pre><code>$ kubectl get secret -n monitoring alertmanager-monitoring-prometheus-oper-alertmanager -oyaml\n\napiVersion: v1\ndata:\n  alertmanager.yaml: Z2xvYmFsOgogIHJlc29sdmVfdGltZW91dDogNW0KcmVjZWl2ZXJzOgotIG5hbWU6ICJudWxsIgpyb3V0ZToKICBncm91cF9ieToKICAtIGpvYgogIGdyb3VwX2ludGVydmFsO\niA1bQogIGdyb3VwX3dhaXQ6IDMwcwogIHJlY2VpdmVyOiAibnVsbCIKICByZXBlYXRfaW50ZXJ2YWw6IDEyaAogIHJvdXRlczoKICAtIG1hdGNoOgogICAgICBhbGVydG5hbWU6IFdhdGNoZG9nCiAgICB\nyZWNlaXZlcjogIm51bGwiCg==\nkind: Secret\nmetadata:\n  creationTimestamp: \"2019-08-07T07:42:14Z\"\n  labels:\n    app: prometheus-operator-alertmanager\n    chart: prometheus-operator-6.2.0\n    heritage: Tiller\n    release: monitoring\n  name: alertmanager-monitoring-prometheus-oper-alertmanager\n  namespace: monitoring\n  resourceVersion: \"69027563\"\n  selfLink: /api/v1/namespaces/monitoring/secrets/alertmanager-monitoring-prometheus-oper-alertmanager\n  uid: dfca9306-b8e6-11e9-9cbe-fe2458f1cc65\ntype: Opaque\n</code></pre> <p>alertmanager.yaml</p> <pre><code>$ echo Z2xvYmFsOgogIHJlc29sdmVfdGltZW91dDogNW0KcmVjZWl2ZXJzOgotIG5hbWU6ICJudWxsIgpyb3V0ZToKICBncm91cF9ieToKICAtIGpvYgogIGdyb3VwX2ludGVydmFsOiA1bQogIGdyb3VwX3dhaXQ6IDMwcwogIHJlY2VpdmVyOiAibnVsbCIKICByZXBlYXRfaW50ZXJ2YWw6IDEyaAogIHJvdXRlczoKICAtIG1hdGNoOgogICAgICBhbGVydG5hbWU6IFdhdGNoZG9nCiAgICByZWNlaXZlcjogIm51bGwiCg== |  base64 -D\n\nglobal:\n  resolve_timeout: 5m\nreceivers:\n- name: \"null\"\nroute:\n  group_by:\n  - job\n  group_interval: 5m\n  group_wait: 30s\n  receiver: \"null\"\n  repeat_interval: 12h\n  routes:\n  - match:\n      alertname: Watchdog\n    receiver: \"null\"\n</code></pre>"},{"location":"chap4/22Customize_Alert_Email/#step-two-custom-own-email-config","title":"Step two: Custom own email config","text":"<pre><code># https://prometheus.io/docs/alerting/configuration/\nglobal:\n  resolve_timeout: 5m\n  smtp_from: 'noreply@sap.com'\n  # can only be set up as noreply@sap.com, otherwise the email will not sent\n  smtp_smarthost: 'mailhost.pgdev.sap.corp:25' \n  # public smtp server for sap   \n  smtp_require_tls: false\nroute:\n  # group_by: ['prometheus']\n  group_wait: 30s\n  group_interval: 1h\n  repeat_interval: 12h\n  # Set repeat_interval as 6h, since ubertest is internal tool for us\n  receiver: jam_devops\n  routes:\n  - receiver: jam_devops\n    match:\n      alertname: GitproxyMemoryHigh\n\nreceivers:\n- name: 'jam_devops'\n  email_configs:\n  # - to: 'DL_@global.corp.sap'  # This is Jam Devops Team DL\n  - to: 'j@sap.com'\n    send_resolved: true\n    headers:\n      Subject: 'Ubertest-Alert{{ template \"email.default.subject\" . }}' # Special header for ubertest cluster\n\n# \ninhibit_rules:\n- source_match:\n    severity: 'critical'\n  target_match_re:\n    severity: 'warning|none'\n  # Since prometheus is common label in alertmanager, so critical will inhibit all \"warning|none\" severity \n  equal:  ['prometheus']\n# Since severity cannot inhibit severity, \n# I need change policy from severity to alertname which inside severity \n- source_match:\n    alertname: 'KubeControllerManagerDown'\n  target_match:\n    alertname: 'KubeDaemonSetRolloutStuck'\n  equal: ['prometheus']\n# KubeSchedulerDown and KubeControllerManagerDown inhibit each other \n- source_match:\n    alertname: 'KubeControllerManagerDown'\n  target_match:\n    alertname: 'KubeSchedulerDown'\n  equal: ['prometheus']\n- source_match:\n    alertname: 'KubeSchedulerDown'\n  target_match:\n    alertname: 'KubeControllerManagerDown'\n  equal: ['prometheus']\n- source_match:\n    alertname: 'GitproxyMemoryHigh'\n  target_match_re:\n    severity: 'critical'\n  equal: ['prometheus']\n</code></pre>"},{"location":"chap4/22Customize_Alert_Email/#speical-settings","title":"Speical settings","text":"<ul> <li><code>smtp_from: 'noreply@sap.com'</code></li> <li><code>Subject: 'Ubertest-Alert{{ template \"email.default.subject\" . }}'</code></li> <li><code>inhibit_rules:</code></li> </ul>"},{"location":"chap4/22Customize_Alert_Email/#step-three-delete-old-and-apply-new","title":"Step three: Delete old and apply new","text":"<p>Why Should I do this, please check reference \u914d\u7f6e\u62a5\u8b66</p> <pre><code>$ kubectl create secret generic alertmanager-monitoring-prometheus-oper-alertmanager -n monitoring --from-file=alertmanager.yaml\n\n$ kubectl delete secret alertmanager-monitoring-prometheus-oper-alertmanager -n monitoring\n\n$ kubectl logs alertmanager-monitoring-prometheus-oper-alertmanager-0 -n monitoring -c alertmanager\n</code></pre>"},{"location":"chap4/22Customize_Alert_Email/#step-four-check-works-or-not","title":"Step four: Check works or not","text":"<pre><code>$ kubectl logs alertmanager-monitoring-prometheus-oper-alertmanager-0 -n monitoring -c alertmanager\n\n...\nlevel=info ts=2019-11-08T05:18:34.894500263Z caller=coordinator.go:131 component=configuration msg=\"Completed loading of configuration file\" file=/etc/alertmanager/config/alertmanager.yaml\n...\n</code></pre> <pre><code>$ kubectl -n monitoring port-forward alertmanager-monitoring-prometheus-oper-alertmanager-0 9093:9093\n</code></pre> <p><code>http://localhost:9093/#/status</code></p> <p></p> <p>Config</p> <pre><code>global:\n  resolve_timeout: 5m\n  http_config: {}\n  smtp_from: noreply@sap.com\n  smtp_hello: localhost\n  smtp_smarthost: mailhost.pgdev.sap.corp:25\n  pagerduty_url: https://events.pagerduty.com/v2/enqueue\n  hipchat_api_url: https://api.hipchat.com/\n  opsgenie_api_url: https://api.opsgenie.com/\n  wechat_api_url: https://qyapi.weixin.qq.com/cgi-bin/\n  victorops_api_url: https://alert.victorops.com/integrations/generic/20131114/alert/\nroute:\n  receiver: jam_devops\n  routes:\n  - receiver: jam_devops\n    match:\n      alertname: GitproxyMemoryHigh\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 6h\ninhibit_rules:\n- source_match:\n    severity: critical\n  target_match_re:\n    severity: warning|none\n  equal:\n  - prometheus\n- source_match:\n    alertname: KubeControllerManagerDown\n  target_match:\n    alertname: KubeDaemonSetRolloutStuck\n  equal:\n  - prometheus\n- source_match:\n    alertname: KubeControllerManagerDown\n  target_match:\n    alertname: KubeSchedulerDown\n  equal:\n  - prometheus\n- source_match:\n    alertname: KubeSchedulerDown\n  target_match:\n    alertname: KubeControllerManagerDown\n  equal:\n  - prometheus\nreceivers:\n- name: jam_devops\n  email_configs:\n  - send_resolved: true\n    to: ***\n    from: noreply@sap.com\n    hello: localhost\n    smarthost: mailhost.pgdev.sap.corp:25\n    headers:\n      From: noreply@sap.com\n      Subject: Ubertest-Alert{{ template \"email.default.subject\" . }}\n      To: ***\n    html: '{{ template \"email.default.html\" . }}'\n    require_tls: false\ntemplates: []\n</code></pre>"},{"location":"chap4/22Customize_Alert_Email/#reference","title":"Reference:","text":"<ul> <li>alert-example-github</li> </ul>"},{"location":"chap4/24Kubernetes_Prometheus_blackbox/","title":"\u7b2c\u4e94\u8282 Prometheus \u9ed1\u76d2\u76d1\u63a7","text":"<p>\u524d\u9762\u6211\u4eec\u4e3b\u8981\u4ecb\u7ecd\u4e86 <code>Prometheus</code> \u4e0b\u5982\u4f55\u8fdb\u884c\u767d\u76d2\u76d1\u63a7\uff0c\u6211\u4eec\u76d1\u63a7\u4e3b\u673a\u7684\u8d44\u6e90\u7528\u91cf\u3001\u5bb9\u5668\u7684\u8fd0\u884c\u72b6\u6001\u3001\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u7684\u8fd0\u884c\u6570\u636e\u3001\u81ea\u52a8\u53d1\u73b0 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u7684\u8d44\u6e90\u7b49\u7b49\uff0c</p> <p>\u8fd9\u4e9b\u90fd\u662f\u652f\u6301\u4e1a\u52a1\u548c\u670d\u52a1\u7684\u57fa\u7840\u8bbe\u65bd\uff0c\u901a\u8fc7\u767d\u76d2\u80fd\u591f\u4e86\u89e3\u5176\u5185\u90e8\u7684\u5b9e\u9645\u8fd0\u884c\u72b6\u6001\uff0c\u901a\u8fc7\u5bf9\u76d1\u63a7\u6307\u6807\u7684\u89c2\u5bdf\u80fd\u591f\u9884\u5224\u53ef\u80fd\u51fa\u73b0\u7684\u95ee\u9898\uff0c\u4ece\u800c\u5bf9\u6f5c\u5728\u7684\u4e0d\u786e\u5b9a\u56e0\u7d20\u8fdb\u884c\u4f18\u5316</p> <p>\u800c\u4ece\u5b8c\u6574\u7684\u76d1\u63a7\u903b\u8f91\u7684\u89d2\u5ea6\uff0c\u9664\u4e86\u5927\u91cf\u7684\u5e94\u7528\u767d\u76d2\u76d1\u63a7\u4ee5\u5916\uff0c\u8fd8\u5e94\u8be5\u6dfb\u52a0\u9002\u5f53\u7684 <code>Blackbox</code>\uff08\u9ed1\u76d2\uff09\u76d1\u63a7\uff0c\u9ed1\u76d2\u76d1\u63a7\u5373\u4ee5\u7528\u6237\u7684\u8eab\u4efd\u6d4b\u8bd5\u670d\u52a1\u7684\u5916\u90e8\u53ef\u89c1\u6027\uff0c\u5e38\u89c1\u7684\u9ed1\u76d2\u76d1\u63a7\u5305\u62ec <code>HTTP \u63a2\u9488</code>\u3001<code>TCP \u63a2\u9488</code> \u7b49\u7528\u4e8e\u68c0\u6d4b\u7ad9\u70b9\u6216\u8005\u670d\u52a1\u7684\u53ef\u8bbf\u95ee\u6027\uff0c\u4ee5\u53ca\u8bbf\u95ee\u6548\u7387\u7b49\u3002</p> <p>\u9ed1\u76d2\u76d1\u63a7\u76f8\u8f83\u4e8e\u767d\u76d2\u76d1\u63a7\u6700\u5927\u7684\u4e0d\u540c\u5728\u4e8e\u9ed1\u76d2\u76d1\u63a7\u662f\u4ee5\u6545\u969c\u4e3a\u5bfc\u5411\u5f53\u6545\u969c\u53d1\u751f\u65f6\uff0c\u9ed1\u76d2\u76d1\u63a7\u80fd\u5feb\u901f\u53d1\u73b0\u6545\u969c\uff0c\u800c\u767d\u76d2\u76d1\u63a7\u5219\u4fa7\u91cd\u4e8e\u4e3b\u52a8\u53d1\u73b0\u6216\u8005\u9884\u6d4b\u6f5c\u5728\u7684\u95ee\u9898\u3002\u4e00\u4e2a\u5b8c\u5584\u7684\u76d1\u63a7\u76ee\u6807\u662f\u8981\u80fd\u591f\u4ece\u767d\u76d2\u7684\u89d2\u5ea6\u53d1\u73b0\u6f5c\u5728\u95ee\u9898\uff0c\u80fd\u591f\u5728\u9ed1\u76d2\u7684\u89d2\u5ea6\u5feb\u901f\u53d1\u73b0\u5df2\u7ecf\u53d1\u751f\u7684\u95ee\u9898\u3002</p> <p><code>Blackbox Exporter</code> \u662f<code>Prometheus</code> \u793e\u533a\u63d0\u4f9b\u7684\u5b98\u65b9\u9ed1\u76d2\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff0c\u5176\u5141\u8bb8\u7528\u6237\u901a\u8fc7\uff1a<code>HTTP</code>\u3001<code>HTTPS</code>\u3001<code>DNS</code>\u3001<code>TCP</code> \u4ee5\u53ca <code>ICMP</code> \u7684\u65b9\u5f0f\u5bf9\u7f51\u7edc\u8fdb\u884c\u63a2\u6d4b</p> <p>Marvelous Prometheus Blackbox alerts</p>"},{"location":"chap4/24Kubernetes_Prometheus_blackbox/#2-helm-prometheus-operator","title":"2 \u5feb\u901f\u5b89\u88c5 <code>helm-prometheus-operator</code>","text":"<pre><code>kubectl create ns kube-mon\nhelm install prom-blackbox stable/prometheus-operator -f prometheus-operator-values.yml --namespace kube-mon\n</code></pre> <p><code>prometheus-operator-values.yml</code></p> <pre><code># We don't need the alertmanager for this demo\nalertmanager:\n  enabled: false\n\n# This configuration means all ServiceMonitors in the namespsace will be picked up\n# Use with caution!\nprometheus: \n  prometheusSpec:\n    serviceMonitorSelectorNilUsesHelmValues: false\n    serviceMonitorSelector: {}\n</code></pre> <pre><code>$ helm install prom-blackbox stable/prometheus-operator -f prometheus-operator-values.yml --namespace kube-mon\nNAME: prom-blackbox\nLAST DEPLOYED: Tue Dec 17 10:17:02 2019\nNAMESPACE: kube-mon\nSTATUS: deployed\nREVISION: 1\nNOTES:\nThe Prometheus Operator has been installed. Check its status by running:\n  kubectl --namespace kube-mon get pods -l \"release=prom-blackbox\"\n\nVisit https://github.com/coreos/prometheus-operator for instructions on how\n</code></pre>"},{"location":"chap4/24Kubernetes_Prometheus_blackbox/#2-1-blackbox-exporter","title":"2-1 \u5feb\u901f\u5b89\u88c5 <code>blackbox-exporter</code> \u670d\u52a1","text":"<p>\u540c\u6837\u9996\u5148\u9700\u8981\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u8fd0\u884c <code>blackbox-exporter</code> \u670d\u52a1\uff0c\u540c\u6837\u901a\u8fc7\u4e00\u4e2a <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\u6765\u4e3a <code>Blackbox</code> \u63d0\u4f9b\u914d\u7f6e\uff0c\u5982\u4e0b\u6240\u793a\uff1a\uff08<code>prome-blackbox.yaml</code>\uff09</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: blackbox-config\n  namespace: kube-mon\ndata:\n  blackbox.yml: |-\n    modules:\n      http_2xx:  # http \u68c0\u6d4b\u6a21\u5757  Blockbox-Exporter \u4e2d\u6240\u6709\u7684\u63a2\u9488\u5747\u662f\u4ee5 Module \u7684\u4fe1\u606f\u8fdb\u884c\u914d\u7f6e\n        prober: http\n        timeout: 10s\n        http:\n          valid_http_versions: [\"HTTP/1.1\", \"HTTP/2\"]   \n          valid_status_codes: [200]  # \u8fd9\u91cc\u6700\u597d\u4f5c\u4e00\u4e2a\u8fd4\u56de\u72b6\u6001\u7801\uff0c\u5728grafana\u4f5c\u56fe\u65f6\uff0c\u6709\u660e\u793a---\u9648\u521a\u6ce8\u91ca\u3002\n          method: GET\n          preferred_ip_protocol: \"ip4\"\n      http_post_2xx: # http post \u76d1\u6d4b\u6a21\u5757\n        prober: http\n        timeout: 10s\n        http:\n          valid_http_versions: [\"HTTP/1.1\", \"HTTP/2\"]\n          method: POST\n          preferred_ip_protocol: \"ip4\"\n      tcp_connect:  # TCP \u68c0\u6d4b\u6a21\u5757\n        prober: tcp\n        timeout: 10s\n      dns:  # DNS \u68c0\u6d4b\u6a21\u5757\n        prober: dns\n        dns:\n          transport_protocol: \"tcp\"  # \u9ed8\u8ba4\u662f udp\n          preferred_ip_protocol: \"ip4\"  # \u9ed8\u8ba4\u662f ip6\n          query_name: \"kubernetes.default.svc.cluster.local\"\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: blackbox\n  namespace: kube-mon\nspec:\n  selector:\n    matchLabels:\n      app: blackbox\n  template:\n    metadata:\n      labels:\n        app: blackbox\n    spec:\n      containers:\n      - image: prom/blackbox-exporter:v0.16.0\n        name: blackbox\n        args:\n        - --config.file=/etc/blackbox_exporter/blackbox.yml # ConfigMap \u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\n        - --log.level=error  # \u9519\u8bef\u7ea7\u522b\u63a7\u5236\n        ports:\n        - containerPort: 9115\n        volumeMounts:\n        - name: config\n          mountPath: /etc/blackbox_exporter\n      volumes:\n      - name: config\n        configMap:\n          name: blackbox-config\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: blackbox\n  namespace: kube-mon\nspec:\n  selector:\n    app: blackbox\n  ports:\n  - port: 9115\n    targetPort: 9115\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\uff1a</p> <pre><code>$ kubectl apply -f content/monitor/manifests/install/prome-blackbox.yaml \nconfigmap/blackbox-config created\ndeployment.apps/blackbox created\nservice/blackbox created\n</code></pre> <p>\u7136\u540e\u9700\u8981\u5728 <code>Prometheus</code> \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u52a0\u5165\u5bf9 <code>BlackBox</code> \u7684\u6293\u53d6\u8bbe\u7f6e\uff0c</p>"},{"location":"chap4/24Kubernetes_Prometheus_blackbox/#3-k8s-prometheus","title":"3 \u4f20\u7edf <code>k8s-Prometheus</code>  \u65b9\u5f0f","text":"<pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: prometheus-config\n  namespace: kube-mon\ndata:\n  prometheus.yml: |\n    global:\n      scrape_interval: 15s\n      scrape_timeout: 15s\n    scrape_configs:\n    - job_name: 'prometheus'\n      static_configs:\n      - targets: ['localhost:9090']\n\n    - job_name: \"kubernetes-service-dns\"\n      metrics_path: /probe # \u4e0d\u662f metrics\uff0c\u662f probe\n      params:\n        module: [dns] # \u4f7f\u7528 DNS \u6a21\u5757\n      static_configs:\n      - targets:\n        - kube-dns.kube-system:53  # \u4e0d\u8981\u7701\u7565\u7aef\u53e3\u53f7\n      relabel_configs:\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: blackbox:9115  # \u670d\u52a1\u5730\u5740\uff0c\u548c\u4e0a\u9762\u7684 Service \u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\n</code></pre> <ul> <li>\u9996\u5148\u83b7\u53d6 <code>targets</code> \u5b9e\u4f8b\u7684 <code>__address__</code> \u503c\u5199\u8fdb <code>__param_target</code>, </li> <li><code>__param_&lt;name&gt;</code>\u5f62\u5f0f\u7684\u6807\u7b7e\u91cc\u7684 <code>name</code>\u548c\u5b83\u7684\u503c\u4f1a\u88ab\u6dfb\u52a0\u5230\u53d1\u9001\u5230\u9ed1\u76d2\u7684 <code>http</code> \u7684 <code>header</code>\u7684 <code>params</code> \u5f53\u4f5c\u952e\u503c\uff0c\u4f8b\u5982 <code>__param_module</code> \u5bf9\u5e94 <code>params</code> \u91cc\u7684 <code>module</code>\u3002</li> <li>\u7136\u540e\u83b7\u53d6 <code>__param_target</code> \u7684\u503c\uff0c\u5e76\u8986\u5199\u5230 <code>instance</code> \u6807\u7b7e\u4e2d\uff0c</li> <li>\u8986\u5199 <code>Target</code> \u5b9e\u4f8b\u7684 <code>__address__</code>\u6807\u7b7e\u503c\u4e3a <code>BlackBox Exporter</code> \u5b9e\u4f8b\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u5411 <code>blackbox:9115</code> \u53d1\u9001\u8bf7\u6c42\u83b7\u53d6\u5b9e\u4f8b\u7684 <code>metrics</code> \u4fe1\u606f\u3002</li> </ul> <p>\u7136\u540e\u66f4\u65b0\u914d\u7f6e\uff1a</p> <pre><code>$ kubectl apply -f prometheus-cm.yaml\nconfigmap/prometheus-config configured\n\n\n# \u9694\u4e00\u4f1a\u513f\u6267\u884c reload \u64cd\u4f5c\n$ curl -X POST \"http://10.244.3.174:9090/-/reload\"  # promethues pod ip  and suppose hot reload\n</code></pre> <p>\u6253\u5f00 <code>Prometheus</code> \u7684 <code>Target</code> \u9875\u9762\uff0c\u5c31\u4f1a\u770b\u5230 \u4e0a\u9762\u5b9a\u4e49\u7684 <code>kubernetes-service-dns</code> \u4efb\u52a1\u4e86\uff1a</p>"},{"location":"chap4/24Kubernetes_Prometheus_blackbox/#prometheus-opeartor-servicemonitor","title":"<code>Prometheus-Opeartor</code> \u7ed5\u8fc7 <code>ServiceMonitor</code> \u65b9\u5f0f","text":"<p>Reference:</p> <p>Additional Scrape Configuration</p> <p>Creating an additional configuration:</p> <p><code>prometheus-additional.yaml</code></p> <pre><code>- job_name: \"kubernetes-service-dns\"\n      metrics_path: /probe # \u4e0d\u662f metrics\uff0c\u662f probe\n      params:\n        module: [dns] # \u4f7f\u7528 DNS \u6a21\u5757\n      static_configs:\n      - targets:\n        - kube-dns.kube-system:53  # \u4e0d\u8981\u7701\u7565\u7aef\u53e3\u53f7\n      relabel_configs:\n      - source_labels: [__address__]\n        target_label: __param_target\n      - source_labels: [__param_target]\n        target_label: instance\n      - target_label: __address__\n        replacement: blackbox:9115  # \u670d\u52a1\u5730\u5740\uff0c\u548c\u4e0a\u9762\u7684 Service \u5b9a\u4e49\u4fdd\u6301\u4e00\u81f4\n</code></pre> <pre><code>kubectl create secret --namesapce kube-mon generic additional-scrape-configs --from-file=prometheus-additional.yaml --dry-run -oyaml &gt; additional-scrape-configs.yaml\n</code></pre> <p><code>additional-scrape-configs.yaml</code></p> <pre><code>apiVersion: v1\ndata:\n  prometheus-additional.yaml: ......\nkind: Secret\nmetadata:\n  creationTimestamp: null\n  name: additional-scrape-configs\n  namespace: kube-mon   \n</code></pre> <pre><code>$ kubectl apply -f additional-scrape-configs.yaml\nsecret/additional-scrape-configs created\n</code></pre> <p>Finally, reference this additional configuration in your <code>prometheus.yaml</code> CRD.</p> <pre><code>$ kubectl get prometheus -n kube-mon\nNAME                                    AGE\nprom-blackbox-prometheus-o-prometheus   6h34m\n</code></pre> <pre><code>$ kubectl edit Prometheus prom-blackbox-prometheus-o-prometheus -n kube-mon\n...\nruleNamespaceSelector: {}\n  ruleSelector:\n    matchLabels:\n      app: prometheus-operator\n      release: prom-blackbox\n  securityContext:\n...\n</code></pre> <pre><code># \u9694\u4e00\u4f1a\u513f\u6267\u884c \nkubectl port-forward svc/prom-blackbox-prometheus-o-prometheus -n kube-mon 9090:9090\n</code></pre> <p></p> <p>\u56de\u5230 <code>Graph</code> \u9875\u9762\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>probe_success{job=\"kubernetes-service-dns\"}</code> \u6765\u67e5\u770b\u68c0\u6d4b\u7ed3\u679c\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u5bf9 DNS \u7684\u9ed1\u76d2\u76d1\u63a7\u3002</p> <p></p> <p></p> <p>\u9664\u4e86 <code>DNS</code> \u7684\u914d\u7f6e\u5916\uff0c\u4e0a\u9762\u6211\u4eec\u8fd8\u914d\u7f6e\u4e86\u4e00\u4e2a <code>http_2xx</code> \u7684\u6a21\u5757\uff0c\u4e5f\u5c31\u662f <code>HTTP</code> \u63a2\u9488\uff0c<code>HTTP</code> \u63a2\u9488\u662f\u8fdb\u884c\u9ed1\u76d2\u76d1\u63a7\u65f6\u6700\u5e38\u7528\u7684\u63a2\u9488\u4e4b\u4e00\uff0c\u901a\u8fc7 <code>HTTP</code> \u63a2\u9488\u80fd\u591f\u5bf9\u7f51\u7ad9\u6216\u8005 <code>HTTP</code> \u670d\u52a1\u5efa\u7acb\u6709\u6548\u7684\u76d1\u63a7\uff0c\u5305\u62ec\u5176\u672c\u8eab\u7684\u53ef\u7528\u6027\uff0c\u4ee5\u53ca\u7528\u6237\u4f53\u9a8c\u76f8\u5173\u7684\u5982\u54cd\u5e94\u65f6\u95f4\u7b49\u7b49\u3002\u9664\u4e86\u80fd\u591f\u5728\u670d\u52a1\u51fa\u73b0\u5f02\u5e38\u7684\u65f6\u5019\u53ca\u65f6\u62a5\u8b66\uff0c\u8fd8\u80fd\u5e2e\u52a9\u7cfb\u7edf\u7ba1\u7406\u5458\u5206\u6790\u548c\u4f18\u5316\u7f51\u7ad9\u4f53\u9a8c\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4ed6\u6765\u5bf9 <code>http</code> \u670d\u52a1\u8fdb\u884c\u68c0\u6d4b\u3002</p> <p>\u56e0\u4e3a\u524d\u9762\u5df2\u7ecf\u7ed9 <code>Blackbox</code> \u914d\u7f6e\u4e86 <code>http_2xx</code> \u6a21\u5757\uff0c\u6240\u4ee5\u8fd9\u91cc\u53ea\u9700\u8981\u5728 <code>Prometheus</code> \u4e2d\u52a0\u5165\u6293\u53d6\u4efb\u52a1\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u7ed3\u5408\u524d\u9762\u7684 <code>Prometheus</code> \u7684\u670d\u52a1\u53d1\u73b0\u529f\u80fd\u6765\u505a\u9ed1\u76d2\u76d1\u63a7\uff0c\u5bf9\u4e8e <code>Service</code> \u548c <code>Ingress</code> \u7c7b\u578b\u7684\u670d\u52a1\u53d1\u73b0\uff0c\u7528\u6765\u8fdb\u884c\u9ed1\u76d2\u76d1\u63a7\u662f\u975e\u5e38\u5408\u9002\u7684\uff0c\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>prometheus-additional.yaml</code></p> <pre><code>- job_name: \"kubernetes-service-dns\"\n  metrics_path: /probe \n  params:\n    module: [dns]\n  static_configs:\n  - targets:\n    - kube-dns.kube-system:53\n  relabel_configs:\n  - source_labels: [__address__]\n    target_label: __param_target\n  - source_labels: [__param_target]\n    target_label: instance\n  - target_label: __address__\n    replacement: blackbox:9115\n\n- job_name: 'kubernetes-http-services'\n  metrics_path: /probe\n  params:\n    module: [http_2xx]  # \u4f7f\u7528\u5b9a\u4e49\u7684http\u6a21\u5757\n  kubernetes_sd_configs:\n  - role: service  # service \u7c7b\u578b\u7684\u670d\u52a1\u53d1\u73b0\n  relabel_configs:\n  # \u53ea\u6709service\u7684annotation\u4e2d\u914d\u7f6e\u4e86 prometheus.io/http_probe=true \u7684\u624d\u8fdb\u884c\u53d1\u73b0\n  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_http_probe]\n    action: keep\n    regex: true\n  - source_labels: [__address__]\n    target_label: __param_target\n  - target_label: __address__\n    replacement: blackbox:9115\n  - source_labels: [__param_target]\n    target_label: instance\n  - action: labelmap\n    regex: __meta_kubernetes_service_label_(.+)\n  - source_labels: [__meta_kubernetes_namespace]\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_service_name]\n    target_label: kubernetes_name\n\n- job_name: 'kubernetes-ingresses'\n  metrics_path: /probe\n  params:\n    module: [http_2xx]  # \u4f7f\u7528\u5b9a\u4e49\u7684http\u6a21\u5757\n  kubernetes_sd_configs:\n  - role: ingress  # ingress \u7c7b\u578b\u7684\u670d\u52a1\u53d1\u73b0\n  relabel_configs:\n  # \u53ea\u6709ingress\u7684annotation\u4e2d\u914d\u7f6e\u4e86 prometheus.io/http_probe=true\u7684\u624d\u8fdb\u884c\u53d1\u73b0\n  - source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_http_probe]\n    action: keep\n    regex: true\n  - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]\n    regex: (.+);(.+);(.+)\n    replacement: ${1}://${2}${3}\n    target_label: __param_target\n  - target_label: __address__\n    replacement: blackbox:9115\n  - source_labels: [__param_target]\n    target_label: instance\n  - action: labelmap\n    regex: __meta_kubernetes_ingress_label_(.+)\n  - source_labels: [__meta_kubernetes_namespace]\n    target_label: kubernetes_namespace\n  - source_labels: [__meta_kubernetes_ingress_name]\n    target_label: kubernetes_name\n</code></pre> <p>\u6211\u4eec\u7ed3\u5408\u524d\u9762\u7684\u670d\u52a1\u53d1\u73b0\u529f\u80fd\uff0c\u901a\u8fc7\u8fc7\u6ee4 <code>prometheus.io/http_probe=true</code> \u7684 <code>Service</code> \u548c <code>Ingress</code> \u624d\u8fdb\u884c <code>HTTP</code> \u63a2\u9488\u7c7b\u578b\u7684\u9ed1\u76d2\u76d1\u63a7\uff0c\u5176\u4ed6\u914d\u7f6e\u548c\u4e0a\u9762\u914d\u7f6e <code>dns</code> \u76d1\u63a7\u7684\u65f6\u5019\u662f\u4e00\u81f4\u7684\u3002\u7136\u540e\u66f4\u65b0\u914d\u7f6e\uff1a</p> <pre><code>kubectl delete secret additional-scrape-configs -n kube-mon\n</code></pre> <pre><code>kubectl create secret --namespace kube-mon generic additional-scrape-configs --from-file=prometheus-additional.yaml --dry-run -oyaml &gt; additional-scrape-configs.yaml\n</code></pre> <p><code>additional-scrape-configs.yaml</code></p> <pre><code>apiVersion: v1\ndata:\n  prometheus-additional.yaml: LSBqb2JfbmFtZTogImt1YmVybmV0ZXMtc2VydmljZS1kbnMiCiAgbWV0cmljc19wYXRoOiAvcHJvYmUgCiAgcGFyYW1zOgogICAgbW9kdWxlOiBbZG5zXQogIHN0YXRpY19jb25maWdzOgogIC0gdGFyZ2V0czoKICAgIC0ga3ViZS1kbnMua3ViZS1zeXN0ZW06NTMKICByZWxhYmVsX2NvbmZpZ3M6CiAgLSBzb3VyY2VfbGFiZWxzOiBbX19hZGRyZXNzX19dCiAgICB0YXJnZXRfbGFiZWw6IF9fcGFyYW1fdGFyZ2V0CiAgLSBzb3VyY2VfbGFiZWxzOiBbX19wYXJhbV90YXJnZXRdCiAgICB0YXJnZXRfbGFiZWw6IGluc3RhbmNlCiAgLSB0YXJnZXRfbGFiZWw6IF9fYWRkcmVzc19fCiAgICByZXBsYWNlbWVudDogYmxhY2tib3g6OTExNQoKLSBqb2JfbmFtZTogJ2t1YmVybmV0ZXMtaHR0cC1zZXJ2aWNlcycKICBtZXRyaWNzX3BhdGg6IC9wcm9iZQogIHBhcmFtczoKICAgIG1vZHVsZTogW2h0dHBfMnh4XSAgIyDkvb/nlKjlrprkuYnnmoRodHRw5qih5Z2XCiAga3ViZXJuZXRlc19zZF9jb25maWdzOgogIC0gcm9sZTogc2VydmljZSAgIyBzZXJ2aWNlIOexu+Wei+eahOacjeWKoeWPkeeOsAogIHJlbGFiZWxfY29uZmlnczoKICAjIOWPquaciXNlcnZpY2XnmoRhbm5vdGF0aW9u5Lit6YWN572u5LqGIHByb21ldGhldXMuaW8vaHR0cF9wcm9iZT10cnVlIOeahOaJjei/m+ihjOWPkeeOsAogIC0gc291cmNlX2xhYmVsczogW19fbWV0YV9rdWJlcm5ldGVzX3NlcnZpY2VfYW5ub3RhdGlvbl9wcm9tZXRoZXVzX2lvX2h0dHBfcHJvYmVdCiAgICBhY3Rpb246IGtlZXAKICAgIHJlZ2V4OiB0cnVlCiAgLSBzb3VyY2VfbGFiZWxzOiBbX19hZGRyZXNzX19dCiAgICB0YXJnZXRfbGFiZWw6IF9fcGFyYW1fdGFyZ2V0CiAgLSB0YXJnZXRfbGFiZWw6IF9fYWRkcmVzc19fCiAgICByZXBsYWNlbWVudDogYmxhY2tib3g6OTExNQogIC0gc291cmNlX2xhYmVsczogW19fcGFyYW1fdGFyZ2V0XQogICAgdGFyZ2V0X2xhYmVsOiBpbnN0YW5jZQogIC0gYWN0aW9uOiBsYWJlbG1hcAogICAgcmVnZXg6IF9fbWV0YV9rdWJlcm5ldGVzX3NlcnZpY2VfbGFiZWxfKC4rKQogIC0gc291cmNlX2xhYmVsczogW19fbWV0YV9rdWJlcm5ldGVzX25hbWVzcGFjZV0KICAgIHRhcmdldF9sYWJlbDoga3ViZXJuZXRlc19uYW1lc3BhY2UKICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19zZXJ2aWNlX25hbWVdCiAgICB0YXJnZXRfbGFiZWw6IGt1YmVybmV0ZXNfbmFtZQoKLSBqb2JfbmFtZTogJ2t1YmVybmV0ZXMtaW5ncmVzc2VzJwogIG1ldHJpY3NfcGF0aDogL3Byb2JlCiAgcGFyYW1zOgogICAgbW9kdWxlOiBbaHR0cF8yeHhdICAjIOS9v+eUqOWumuS5ieeahGh0dHDmqKHlnZcKICBrdWJlcm5ldGVzX3NkX2NvbmZpZ3M6CiAgLSByb2xlOiBpbmdyZXNzICAjIGluZ3Jlc3Mg57G75Z6L55qE5pyN5Yqh5Y+R546wCiAgcmVsYWJlbF9jb25maWdzOgogICMg5Y+q5pyJaW5ncmVzc+eahGFubm90YXRpb27kuK3phY3nva7kuoYgcHJvbWV0aGV1cy5pby9odHRwX3Byb2JlPXRydWXnmoTmiY3ov5vooYzlj5HnjrAKICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19pbmdyZXNzX2Fubm90YXRpb25fcHJvbWV0aGV1c19pb19odHRwX3Byb2JlXQogICAgYWN0aW9uOiBrZWVwCiAgICByZWdleDogdHJ1ZQogIC0gc291cmNlX2xhYmVsczogW19fbWV0YV9rdWJlcm5ldGVzX2luZ3Jlc3Nfc2NoZW1lLF9fYWRkcmVzc19fLF9fbWV0YV9rdWJlcm5ldGVzX2luZ3Jlc3NfcGF0aF0KICAgIHJlZ2V4OiAoLispOyguKyk7KC4rKQogICAgcmVwbGFjZW1lbnQ6ICR7MX06Ly8kezJ9JHszfQogICAgdGFyZ2V0X2xhYmVsOiBfX3BhcmFtX3RhcmdldAogIC0gdGFyZ2V0X2xhYmVsOiBfX2FkZHJlc3NfXwogICAgcmVwbGFjZW1lbnQ6IGJsYWNrYm94OjkxMTUKICAtIHNvdXJjZV9sYWJlbHM6IFtfX3BhcmFtX3RhcmdldF0KICAgIHRhcmdldF9sYWJlbDogaW5zdGFuY2UKICAtIGFjdGlvbjogbGFiZWxtYXAKICAgIHJlZ2V4OiBfX21ldGFfa3ViZXJuZXRlc19pbmdyZXNzX2xhYmVsXyguKykKICAtIHNvdXJjZV9sYWJlbHM6IFtfX21ldGFfa3ViZXJuZXRlc19uYW1lc3BhY2VdCiAgICB0YXJnZXRfbGFiZWw6IGt1YmVybmV0ZXNfbmFtZXNwYWNlCiAgLSBzb3VyY2VfbGFiZWxzOiBbX19tZXRhX2t1YmVybmV0ZXNfaW5ncmVzc19uYW1lXQogICAgdGFyZ2V0X2xhYmVsOiBrdWJlcm5ldGVzX25hbWU=\nkind: Secret\nmetadata:\n  creationTimestamp: null\n  name: additional-scrape-configs\n  namespace: kube-mon\n\n</code></pre> <pre><code>$ kubectl apply -f additional-scrape-configs.yaml \nsecret/additional-scrape-configs created\n</code></pre> <p>\u6253\u5f00 Prometheus \u7684 Target \u9875\u9762\uff0c\u7b49\u4e00\u4f1a\u513f\u5c31\u4f1a\u770b\u5230 \u4e0a\u9762\u5b9a\u4e49\u7684\u4e24\u4e2a\u4efb\u52a1\u4e86\uff1a</p> <p></p> <p>\u4f46\u662f\u73b0\u5728\u8fd8\u6ca1\u6709\u4efb\u4f55\u6570\u636e\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u662f\u5339\u914d <code>__meta_kubernetes_ingress_annotation_prometheus_io_http_probe</code>\u8fd9\u4e2a\u5143\u4fe1\u606f\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u9700\u8981\u8ba9\u8fd9\u4e24\u4e2a\u4efb\u52a1\u53d1\u73b0\u7684\u8bdd\u9700\u8981\u5728 <code>Service</code> \u6216\u8005 <code>Ingress</code> \u4e2d\u914d\u7f6e\u5bf9\u5e94\u7684 <code>annotation</code>\uff1a</p> <pre><code>annotation:\n  prometheus.io/http-probe: \"true\"\n</code></pre> <p>\u6bd4\u5982\u5728\u6211\u4eec\u81ea\u5df1\u7684\u4e00\u4e2a Ingress \u5bf9\u8c61\u4e2d\u6dfb\u52a0\u4e0a\u9762\u8fd9\u4e2a annotation\uff1a</p> <pre><code>$ kubectl edit ingress fe\n</code></pre> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    ...\n    kubernetes.io/ingress.class: nginx\n    prometheus.io/http-probe: \"true\"   # \u7528\u4e8e\u9ed1\u76d2\u76d1\u63a7\n  creationTimestamp: \"2019-11-29T08:41:58Z\"\n  generation: 1\n  name: fe\n  namespace: default\n  resourceVersion: \"909843\"\n  selfLink: /apis/extensions/v1beta1/namespaces/default/ingresses/fe\n  uid: 146e0a5d-b934-42f0-9534-fa790714b5f2\n   ...\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u67e5\u770b\u5230 Ingress \u8fd9\u4e2a\u4efb\u52a1\u4e0b\u9762\u5df2\u7ecf\u6709\u6293\u53d6\u4efb\u52a1\u4e86\uff1a</p> <p></p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>probe_duration_seconds</code> \u6765\u68c0\u67e5\u76d1\u63a7\u7ed3\u679c\uff1a</p> <p><code>probe_duration_seconds{instance=\"http://todo.jxi.com/\"}</code></p> <p></p> <p>\u5bf9\u4e8e Service \u662f\u4e00\u6837\u7684\uff0c\u5f53\u7136\u5982\u679c\u4f60\u9700\u8981\u5bf9\u76d1\u63a7\u7684\u8def\u5f84\u3001\u7aef\u53e3\u8fd9\u4e9b\u505a\u63a7\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u5728 <code>relabel_configs</code> \u4e2d\u53bb\u505a\u76f8\u5e94\u7684\u914d\u7f6e\uff0c\u6bd4\u5982\u6211\u4eec\u60f3\u5bf9 Service \u7684\u9ed1\u76d2\u505a\u81ea\u5b9a\u4e49\u914d\u7f6e\uff0c\u53ef\u4ee5\u60f3\u4e0b\u9762\u8fd9\u6837\u914d\u7f6e\uff1a</p> <pre><code>- source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_http_probe_port, __meta_kubernetes_service_annotation_prometheus_io_http_probe_path]\n  action: replace\n  target_label: __param_target\n  regex: (.+);(.+);(.+);(.+)\n  replacement: $1.$2:$3$4\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u9700\u8981\u5728 Service \u4e2d\u914d\u7f6e\u8fd9\u6837\u7684 annotation \u4e86\uff1a</p> <pre><code>annotation:\n  prometheus.io/http-probe: \"true\"\n  prometheus.io/http-probe-port: \"8080\"\n  prometheus.io/http-probe-path: \"/healthz\"\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 HTTP \u63a2\u9488\u7684\u9ed1\u76d2\u76d1\u63a7\uff0c\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u914d\u7f6e TCP \u7684\u76d1\u63a7\uff0c\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u914d\u7f6e\u4e86\u8fd9\u4e2a\u6a21\u5757\uff0c\u5927\u5bb6\u53ef\u4ee5\u81ea\u5df1\u5c1d\u8bd5\u53bb\u914d\u7f6e\u4e0b\u3002</p> <ul> <li> <p>Prometheus \u914d\u7f6e\u6587\u4ef6\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u4ed3\u5e93\uff1ahttps://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml</p> </li> <li> <p>Blackbox \u7684\u914d\u7f6e\u6587\u4ef6\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u53c2\u8003\uff1ahttps://github.com/prometheus/blackbox_exporter/blob/master/example.yml</p> </li> </ul>"},{"location":"chap4/32Prometheus_troubleshoot_Servicemonitor/","title":"\u7b2c\u516d\u8282 Troubleshooting ServiceMonitor changes","text":"<p>When creating/deleting/modifying <code>ServiceMonitor</code> objects it is sometimes not as obvious what piece is not working properly. </p> <p>This section gives a step by step guide how to troubleshoot such actions on a <code>ServiceMonitor</code> object.</p>"},{"location":"chap4/32Prometheus_troubleshoot_Servicemonitor/#1-overview-of-servicemonitor-tagging-and-related-elements","title":"1 Overview of ServiceMonitor tagging and related elements","text":"<p>A common problem related to <code>ServiceMonitor</code> identification by Prometheus is related to an incorrect tagging, that does not match the <code>Prometheus</code> custom resource definition scope, or lack of permission for the Prometheus <code>ServiceAccount</code> to get, list, watch <code>Services</code> and <code>Endpoints</code> from the target application being monitored. </p> <p>As a general guideline consider the diagram below, giving an example of a <code>Deployment</code> and <code>Service</code> called <code>my-app</code>, being monitored by Prometheus based on a <code>ServiceMonitor</code> named <code>my-service-monitor</code>:</p> <p></p>"},{"location":"chap4/32Prometheus_troubleshoot_Servicemonitor/#note","title":"Note:","text":"<ul> <li>The <code>ServiceMonitor</code> references a <code>Service</code> (not a <code>Deployment</code>, or a <code>Pod</code>), by labels and by the port name in the <code>Service</code>. </li> <li>This port name is optional in Kubernetes, but must be specified for the <code>ServiceMonitor</code> to work. </li> <li>It is not the same as the port name on the <code>Pod</code> or <code>container</code>, although it can be.</li> </ul>"},{"location":"chap4/32Prometheus_troubleshoot_Servicemonitor/#2-has-my-servicemonitor-been-picked-up-by-prometheus","title":"2 Has my ServiceMonitor been picked up by Prometheus?","text":"<p><code>ServiceMonitor</code> objects are selected by the <code>serviceMonitorSelector</code> of a Prometheus object.</p> <p>The name of a <code>ServiceMonitor</code> is encoded in the Prometheus configuration, so you can simply grep whether it is present there. </p> <p>The configuration generated by the Prometheus Operator is stored in a Kubernetes <code>Secret</code>, named after the Prometheus object name prefixed with <code>prometheus-</code> and is located in the same namespace as the Prometheus object. </p> <p>For example for a Prometheus object called k8s one can find out if the ServiceMonitor named <code>elasticsearch</code> has been picked up with:</p> <pre><code>kubectl -n monitoring get secret prometheus-k8s -ojson | jq -r '.data[\"prometheus.yaml.gz\"]' | base64 -d | gunzip | grep \"elasticsearch\"\n\n- job_name: default/elasticsearch/0\n    regex: elasticsearch-exporter\n</code></pre>"},{"location":"chap4/43Prometheus_operator_ssl_exporter/","title":"\u7b2c\u4e03\u8282 \u4f7f\u7528<code>ssl_exporter</code>\u76d1\u63a7K8S\u96c6\u7fa4\u8bc1\u4e66","text":"<p>\u4f7f\u7528kubeadm\u642d\u5efa\u7684\u96c6\u7fa4\u9ed8\u8ba4\u8bc1\u4e66\u6709\u6548\u671f\u662f1\u5e74\uff0c\u7eed\u8d39\u8bc1\u4e66\u5176\u5b9e\u662f\u4e00\u4ef6\u5f88\u5feb\u7684\u4e8b\u60c5\u3002\u4f46\u662f\u5c31\u6015\u51fa\u4e8b\u4e86\u624d\u53d1\u73b0\uff0c\u6bd5\u7adf\u4f5c\u4e3a\u4e13\u4e1a\u642c\u7816\u5de5\u7a0b\u5e08\uff0c\u6bcf\u5929\u90fd\u5f88\u5fd9\u7684\u3002</p> <p>\u9274\u4e8e\u6b64\uff0c\u76d1\u63a7\u96c6\u7fa4\u8bc1\u4e66\u6709\u6548\u671f\u662f\u4e00\u4ef6\u4e0d\u5f97\u4e0d\u505a\u7684\u4e8b\u60c5\u3002Prometheus\u4f5c\u4e3a\u4e91\u539f\u751f\u9886\u57df\u7684\u738b\u8005\uff0c\u5982\u679c\u80fd\u7528\u5b83\u6765\u76d1\u63a7\u8bc1\u4e66\u6709\u6548\u671f\u5e76\u80fd\u53ca\u65f6\u544a\u8b66\uff0c\u90a3\u5c31\u518d\u597d\u4e0d\u8fc7\u4e86\u3002</p> <p><code>ssl_exporter</code>\u5c31\u662f\u6765\u505a\u8fd9\u4e2a\u4e8b\u60c5\u7684\u3002<code>ssh_exporter</code>\u662f\u4e00\u4e2aPrometheus Exporter\u80fd\u63d0\u4f9b\u591a\u79cd\u9488\u5bf9 SSL \u7684\u68c0\u6d4b\u624b\u6bb5\uff0c\u5305\u62ec\uff1ahttps \u8bc1\u4e66\u751f\u6548/\u5931\u6548\u65f6\u95f4\u3001\u6587\u4ef6\u8bc1\u4e66\u751f\u6548/\u5931\u6548\u65f6\u95f4\uff0cOCSP \u7b49\u76f8\u5173\u6307\u6807\u3002 <p>\u4e0b\u9762\u5c31\u6765\u76d1\u542c\u96c6\u7fa4\u8bc1\u4e66\u7684\u6709\u6548\u671f\u3002</p>"},{"location":"chap4/43Prometheus_operator_ssl_exporter/#1","title":"1 \u5b89\u88c5","text":"<pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    name: ssl-exporter\n  name: ssl-exporter\nspec:\n  ports:\n    - name: ssl-exporter\n      protocol: TCP\n      port: 9219\n      targetPort: 9219\n  selector:\n    app: ssl-exporter\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: ssl-exporter\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: ssl-exporter\n  template:\n    metadata:\n      name: ssl-exporter\n      labels:\n        app: ssl-exporter\n    spec:\n      initContainers:\n        # Install kube ca cert as a root CA\n        - name: ca\n          image: alpine\n          command:\n            - sh\n            - -c\n            - |\n              set -e\n              apk add --update ca-certificates\n              cp /var/run/secrets/kubernetes.io/serviceaccount/ca.crt /usr/local/share/ca-certificates/kube-ca.crt\n              update-ca-certificates\n              cp /etc/ssl/certs/* /ssl-certs\n          volumeMounts:\n            - name: ssl-certs\n              mountPath: /ssl-certs\n      containers:\n        - name: ssl-exporter\n          image: ribbybibby/ssl-exporter:v0.6.0\n          ports:\n            - name: tcp\n              containerPort: 9219\n          volumeMounts:\n            - name: ssl-certs\n              mountPath: /etc/ssl/certs\n      volumes:\n        - name: ssl-certs\n          emptyDir: {}\n</code></pre> <p>\u6267\u884c<code>kubectl apply -f .</code>\u5b89\u88c5\u5373\u53ef\u3002 </p> <p>\u5f85Pod\u6b63\u5e38\u8fd0\u884c\uff0c\u5982\u4e0b\uff1a</p> <pre><code># kubectl get po -n monitoring -l app=ssl-exporter\nNAME                            READY   STATUS    RESTARTS   AGE\nssl-exporter-7ff4759679-f4qbs   1/1     Running   0          21m\n</code></pre> <p>\u7136\u540e\u914d\u7f6eprometheus\u6293\u53d6\u89c4\u5219\u3002</p> <p>!! \u7531\u4e8e\u6211\u7684Prometheus\u662f\u901a\u8fc7Prometheus Operator\u90e8\u7f72\u7684\uff0c\u6240\u4ee5\u901a\u8fc7additional\u7684\u65b9\u5f0f\u8fdb\u884c\u6293\u53d6\u3002</p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6<code>prometheus-additional.yaml</code>\uff0c\u5176\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>- job_name: ssl-exporter\n  metrics_path: /probe\n  static_configs:\n  - targets:\n    - kubernetes.default.svc:443\n  relabel_configs:\n  - source_labels: [__address__]\n    target_label: __param_target\n  - source_labels: [__param_target]\n    target_label: instance\n  - target_label: __address__\n    replacement: ssl-exporter.monitoring:9219\n</code></pre> <p>\u7136\u540e\u521b\u5efasecret\uff0c\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>kubectl delete secret additional-config -n monitoring\nkubectl -n monitoring create secret generic additional-config --from-file=prometheus-additional.yaml\n</code></pre> <p>\u7136\u540e\u4fee\u6539<code>prometheus-prometheus.yaml</code>\u914d\u7f6e\u6587\u4ef6\uff0c\u65b0\u589e\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>  additionalScrapeConfigs:\n    name: additional-config \n    key: prometheus-additional.yaml \n</code></pre> <p><code>prometheus-prometheus.yaml</code>\u7684\u6574\u4f53\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  labels:\n    prometheus: k8s\n  name: k8s\n  namespace: monitoring\nspec:\n  alerting:\n    alertmanagers:\n    - name: alertmanager-main\n      namespace: monitoring\n      port: web\n  baseImage: quay.io/prometheus/prometheus\n  nodeSelector:\n    kubernetes.io/os: linux\n  podMonitorNamespaceSelector: {}\n  podMonitorSelector: {}\n  replicas: 2\n  resources:\n    requests:\n      memory: 400Mi\n  ruleSelector:\n    matchLabels:\n      prometheus: k8s\n      role: alert-rules\n  securityContext:\n    fsGroup: 2000\n    runAsNonRoot: true\n    runAsUser: 1000\n  additionalScrapeConfigs:\n    name: additional-config \n    key: prometheus-additional.yaml \n  serviceAccountName: prometheus-k8s\n  serviceMonitorNamespaceSelector: {}\n  serviceMonitorSelector: {}\n  version: v2.11.0\n  storage:\n    volumeClaimTemplate:\n      spec:\n        storageClassName: managed-nfs-storage \n        resources:\n          requests:\n            storage: 10Gi\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u6267\u884c<code>prometheus-prometheus.yaml</code>\u6587\u4ef6\uff0c\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>kubectl apply -f prometheus-prometheus.yaml\n</code></pre> <p>\u73b0\u5728\u53ef\u4ee5\u5728prometheus\u7684web\u754c\u9762\u770b\u5230\u6b63\u5e38\u7684\u6293\u53d6\u4efb\u52a1\u4e86\uff0c\u5982\u4e0b\uff1a</p> <p></p> <p>\u7136\u540e\u901a\u8fc7<code>(ssl_cert_not_after-time())/3600/24</code>\u5373\u53ef\u770b\u5230\u8bc1\u4e66\u8fd8\u6709\u591a\u4e45\u5931\u6548\u3002</p> <p></p> <p>\u901a\u8fc7<code>ssl_tls_connect_success</code>\u53ef\u4ee5\u89c2\u6d4bssl\u94fe\u63a5\u662f\u5426\u6b63\u5e38\u3002</p> <p></p>"},{"location":"chap4/43Prometheus_operator_ssl_exporter/#2","title":"2 \u544a\u8b66","text":"<p>\u4e0a\u9762\u5df2\u7ecf\u5b89\u88c5<code>ssl_exporter</code>\u6210\u529f\uff0c\u5e76\u4e14\u80fd\u6b63\u5e38\u76d1\u63a7\u6570\u636e\u4e86\uff0c\u4e0b\u9762\u5c31\u914d\u7f6e\u4e00\u4e9b\u544a\u8b66\u89c4\u5219\uff0c\u4ee5\u4fbf\u4e8e\u8fd0\u7ef4\u80fd\u5feb\u901f\u77e5\u9053\u8fd9\u4e2a\u4e8b\u60c5\u3002</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  name: monitoring-ssl-tls-rules\n  namespace: monitoring\n  labels:\n    prometheus: k8s\n    role: alert-rules\nspec:\n  groups:\n  - name: check_ssl_validity\n    rules:\n    - alert: \"K8S\u96c6\u7fa4\u8bc1\u4e66\u572830\u5929\u540e\u8fc7\u671f\"\n      expr: (ssl_cert_not_after-time())/3600/24 &lt;30\n      for: 1h\n      labels:\n        severity: critical\n      annotations:\n        description: 'K8S\u96c6\u7fa4\u7684\u8bc1\u4e66\u8fd8\u6709{{ printf \"%.1f\" $value }}\u5929\u5c31\u8fc7\u671f\u4e86,\u8bf7\u5c3d\u5feb\u66f4\u65b0\u8bc1\u4e66'\n        summary: \"K8S\u96c6\u7fa4\u8bc1\u4e66\u8bc1\u4e66\u8fc7\u671f\u8b66\u544a\"\n  - name: ssl_connect_status\n    rules:\n    - alert: \"K8S\u96c6\u7fa4\u8bc1\u4e66\u53ef\u7528\u6027\u5f02\u5e38\"\n      expr: ssl_tls_connect_success == 0\n      for: 1m\n      labels:\n        severity: critical\n      annotations:\n        summary: \"K8S\u96c6\u7fa4\u8bc1\u4e66\u8fde\u63a5\u5f02\u5e38\"\n        description: \"K8S\u96c6\u7fa4 {{ $labels.instance }}  \u8bc1\u4e66\u8fde\u63a5\u5f02\u5e38\"\n</code></pre> <p>\u5982\u4e0b\u5c55\u793a\u89c4\u5219\u6b63\u5e38\uff0c\u5728\u5f02\u5e38\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u63a5\u6536\u5230\u544a\u8b66\u4e86\u3002</p> <p></p>"},{"location":"chap4/44Prometheus_KubeNurse/","title":"\u7b2c\u516b\u8282 Operator2021-\u4f7f\u7528KubeNurse\u8fdb\u884c\u96c6\u7fa4\u7f51\u7edc\u76d1\u63a7","text":"<ul> <li>https://github.com/postfinance/kubenurse</li> <li>https://github.com/postfinance/kubenurse/tree/master/examples</li> </ul>"},{"location":"chap4/44Prometheus_KubeNurse/#1","title":"1 \u524d\u8a00","text":"<p>\u5728Kubernetes\u4e2d\uff0c\u7f51\u7edc\u662f\u901a\u8fc7\u7b2c\u4e09\u65b9\u7f51\u7edc\u63d2\u4ef6\u6765\u63d0\u4f9b\uff0c\u8fd9\u4e9b\u4e09\u65b9\u63d2\u4ef6\u672c\u8eab\u7684\u5b9e\u73b0\u5c31\u6bd4\u8f83\u590d\u6742\uff0c\u4ee5\u81f3\u4e8e\u5728\u6392\u67e5\u7f51\u7edc\u95ee\u9898\u65f6\u5e38\u5e38\u78b0\u58c1\u3002\u90a3\u4e48\u6709\u6ca1\u6709\u4ec0\u4e48\u65b9\u5f0f\u6765\u76d1\u63a7\u96c6\u7fa4\u4e2d\u6240\u6709\u7684\u7f51\u7edc\u8fde\u63a5\u5462\uff1f</p> <p>kubenurse\u5c31\u662f\u8fd9\u6837\u4e00\u4e2a\u9879\u76ee\uff0c\u5b83\u901a\u8fc7\u76d1\u89c6\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u7f51\u7edc\u8fde\u63a5\uff0c\u5e76\u63d0\u4f9b\u76d1\u63a7\u6307\u6807\u4f9bPrometheus\u91c7\u96c6\u3002</p>"},{"location":"chap4/44Prometheus_KubeNurse/#2-kubenurse","title":"2 Kubenurse","text":"<p>kubenurse\u7684\u90e8\u7f72\u975e\u5e38\u7b80\u5355\uff0c\u4f7f\u7528Daemonset\u5f62\u5f0f\u90e8\u7f72\u5230\u96c6\u7fa4\u8282\u70b9\u4e0a\uff0cYaml\u6587\u4ef6\u5728\u9879\u76ee\u7684example\u76ee\u5f55\u4e0b\u3002</p> <p>\u90e8\u7f72\u6210\u529f\u540e\uff0c\u6bcf5\u79d2\u949f\u4f1a\u5bf9/alive\u53d1\u4e00\u6b21\u68c0\u67e5\u8bf7\u6c42\uff0c\u7136\u540e\u5176\u5185\u90e8\u4f1a\u8fd0\u884c\u5404\u79cd\u65b9\u6cd5\u5168\u65b9\u4f4d\u5bf9\u96c6\u7fa4\u7f51\u7edc\u8fdb\u884c\u68c0\u6d4b\uff0c\u4e3a\u4e86\u9632\u6b62\u8fc7\u591a\u7684\u7f51\u7edc\u6d41\u91cf\uff0c\u4f1a\u5bf9\u68c0\u67e5\u7ed3\u679c\u7f13\u5b583\u79d2\u3002\u5176\u68c0\u6d4b\u673a\u5236\u5982\u4e0b\uff1a</p> <p></p> <p>\u4ece\u4e0a\u56fe\u53ef\u4ee5\u770b\u51fa\uff0ckubenurse\u4f1a\u5bf9ingress\u3001dns\u3001apiserver\u3001kube-proxy\u8fdb\u884c\u7f51\u7edc\u63a2\u6d4b\u3002</p> <p>\u6240\u6709\u7684\u68c0\u67e5\u90fd\u4f1a\u521b\u5efa\u516c\u5f00\u7684\u6307\u6807\uff0c\u8fd9\u4e9b\u6307\u6807\u53ef\u7528\u4e8e\u68c0\u6d4b\uff1a</p> <ul> <li>SDN\u7f51\u7edc\u5ef6\u8fdf\u4ee5\u53ca\u9519\u8bef</li> <li>Kubelet\u4e4b\u95f4\u7684\u7f51\u7edc\u5ef6\u8fdf\u4ee5\u53ca\u9519\u8bef</li> <li>Pod\u4e0eapiserver\u901a\u4fe1\u95ee\u9898</li> <li>Ingress\u5f80\u8fd4\u7f51\u7edc\u5ef6\u8fdf\u4ee5\u53ca\u9519\u8bef</li> <li>Service\u5f80\u8fd4\u7f51\u7edc\u5ef6\u8fdf\u4ee5\u53ca\u9519\u8bef\uff08kube-proxy\uff09</li> <li>Kube-apiserver\u95ee\u9898</li> <li>Kube-dns\uff08CoreDns\uff09\u9519\u8bef</li> <li>\u5916\u90e8DNS\u89e3\u6790\u9519\u8bef\uff08ingress url\u89e3\u6790\uff09</li> </ul> <p>\u7136\u540e\u8fd9\u4e9b\u6570\u636e\u4e3b\u8981\u901a\u8fc7\u4e24\u4e2a\u76d1\u63a7\u6307\u6807\u6765\u4f53\u73b0\uff1a</p> <ul> <li><code>kubenurse_errors_total</code>\uff1a\u6309\u9519\u8bef\u7c7b\u578b\u5212\u5206\u7684\u9519\u8bef\u8ba1\u6570\u5668</li> <li><code>kubenurse_request_duration</code>\uff1a\u6309\u7c7b\u578b\u5212\u5206\u7684\u8bf7\u6c42\u65f6\u95f4\u5206\u5e03</li> </ul> <p>\u8fd9\u4e9b\u6307\u6807\u90fd\u662f\u901a\u8fc7Type\u7c7b\u578b\u8fdb\u884c\u6807\u8bc6\uff0c\u5bf9\u5e94\u51e0\u79cd\u4e0d\u540c\u7684\u68c0\u6d4b\u76ee\u6807\uff1a</p> <ul> <li><code>api_server_direct</code>\uff1a\u4ece\u8282\u70b9\u76f4\u63a5\u68c0\u6d4b API Server</li> <li><code>api_server_dns</code>\uff1a\u4ece\u8282\u70b9\u901a\u8fc7 DNS \u68c0\u6d4b API Server</li> <li><code>me_ingress</code>\uff1a\u901a\u8fc7 Ingress \u68c0\u6d4b\u672c\u670d\u52a1 Service</li> <li><code>me_service</code>\uff1a\u4f7f\u7528 Service \u68c0\u6d4b\u672c\u670d\u52a1 Service</li> <li><code>path_$KUBELET_HOSTNAME</code>\uff1a\u8282\u70b9\u4e4b\u95f4\u7684\u4e92\u76f8\u68c0\u6d4b</li> </ul> <p>\u7136\u540e\u8fd9\u4e9b\u6307\u6807\u5206\u522b\u6309P50\uff0cP90\uff0cP99\u5206\u4f4d\u6570\u8fdb\u884c\u5212\u5206\uff0c\u5c31\u53ef\u4ee5\u6839\u636e\u4e0d\u540c\u7684\u60c5\u51b5\u6765\u786e\u8ba4\u96c6\u7fa4\u7f51\u7edc\u72b6\u51b5\u4e86\u3002</p>"},{"location":"chap4/44Prometheus_KubeNurse/#2-promethuse-operator-2021","title":"2 Promethuse-operator 2021 \u5b89\u88c5","text":"<pre><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\n\n\nhelm repo update\n</code></pre> <pre><code>$ helm repo list\nNAME                    URL                                                               \nloki                    https://grafana.github.io/loki/charts                             \nargocd-helm             https://chao-xi.github.io/helm/                                   \nistio                   https://storage.googleapis.com/istio-release/releases/1.3.6/charts\nincubator               http://mirror.azure.cn/kubernetes/charts-incubator/               \nargo                    https://argoproj.github.io/argo-helm                              \ntraefik                 https://containous.github.io/traefik-helm-chart                   \noteemocharts            https://oteemo.github.io/charts                                   \nhashicorp               https://helm.releases.hashicorp.com                               \nprometheus-community    https://prometheus-community.github.io/helm-charts     \n</code></pre> <pre><code>helm-values\n\u2502   \u2514\u2500\u2500 prometheus-operator-values.yml\n</code></pre> <p><code>prometheus-operator-values.yml</code></p> <pre><code># We don't need the alertmanager for this demo\nalertmanager:\n  enabled: false\n\n# This configuration means all ServiceMonitors in the namespsace will be picked up\n# Use with caution!\nprometheus: \n  prometheusSpec:\n    serviceMonitorSelectorNilUsesHelmValues: false\n    serviceMonitorSelector: {}\ngrafana:\n  persistence:\n    enabled: true\n    type: pvc\n    size: 5G\n    storageClassName: \"hostpath\"\n\nprometheusOperator:\n  admissionWebhooks:\n    enabled: false\n\nprometheus-node-exporter:\n  hostRootFsMount: false\n\n# prometheus-node-exporter:\n#     hostRootFsMount: false\n</code></pre> <p>Installed Error</p> <pre><code>Error: failed to start container \"node-exporter\": Error response from daemon: path / is mounted on / but it is not a shared or slave mount\n</code></pre> <p>https://github.com/prometheus-community/helm-charts/issues/467</p> <pre><code>prometheus-node-exporter:\n  hostRootFsMount: false\n</code></pre> <p>Or</p> <pre><code>kubectl patch ds kube-prom-prometheus-node-exporter --type \"json\" -p '[{\"op\": \"remove\", \"path\" : \"/spec/template/spec/containers/0/volumeMounts/2/mountPropagation\"}]' -n monitoring\n</code></pre>"},{"location":"chap4/44Prometheus_KubeNurse/#installation","title":"Installation","text":"<pre><code>helm install kube-prom prometheus-community/kube-prometheus-stack -f helm-values/prometheus-operator-values.yml --namespace monitoring\n</code></pre> <p>Upgrade</p> <pre><code>helm upgrade kube-prom prometheus-community/kube-prometheus-stack -f helm-values/prometheus-operator-values.yml --namespace monitoring\n</code></pre> <pre><code>$ kubectl get pod -n monitoring NAME                                                  READY   STATUS    RESTARTS   AGE\nkube-prom-grafana-854d497c4b-gcd2j                    2/2     Running   10         4h39m\nkube-prom-grafana-test                                0/1     Error     0          4h39m\nkube-prom-kube-prometheus-operator-6b84867b8b-wpfpp   1/1     Running   6          4h39m\nkube-prom-kube-state-metrics-77866d67c5-kl44g         1/1     Running   2          4h39m\nkube-prom-prometheus-node-exporter-qkplq              1/1     Running   0          40s\nprometheus-kube-prom-kube-prometheus-prometheus-0     2/2     Running   11         4h38m\n</code></pre>"},{"location":"chap4/44Prometheus_KubeNurse/#3-kubenurse","title":"3 KubeNurse \u5b89\u88c5\u90e8\u7f72","text":"<p>\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528\u5b98\u65b9\u7684\u90e8\u7f72\u6587\u4ef6\u8fdb\u884c\u90e8\u7f72\u3002\u4e0d\u8fc7\u9700\u8981\u66f4\u6539\u51e0\u4e2a\u5730\u65b9\u3002\uff081\uff09\u9996\u5148\u5c06\u4ee3\u7801clone\u5230\u672c\u5730</p> <pre><code>git clone https://github.com/postfinance/kubenurse.git\n</code></pre> <p>\u8fdb\u5165example\u76ee\u5f55\uff0c\u4fee\u6539<code>ingress.yaml</code>\u914d\u7f6e\uff0c\u4e3b\u8981\u662f\u6dfb\u52a0\u57df\u540d\uff0c\u5982\u4e0b\u3002</p> <pre><code>---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n  name: kubenurse\n  namespace: kube-system\nspec:\n  rules:\n  - host: kubenurse-test.xxx.cn\n    http:\n      paths:\n      - backend:\n          serviceName: kubenurse\n          servicePort: 8080\n</code></pre> <p>\u66f4\u65b0<code>daemonset.yaml</code>\u914d\u7f6e\uff0c\u4e3b\u8981\u662f\u66f4\u6539ingress\u7684\u5165\u53e3\u57df\u540d\uff0c\u5982\u4e0b\u3002</p> <pre><code>---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  labels:\n    app: kubenurse\n  name: kubenurse\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      app: kubenurse\n  template:\n    metadata:\n      labels:\n        app: kubenurse\n      annotations:\n        prometheus.io/path: \"/metrics\"\n        prometheus.io/port: \"8080\"\n        prometheus.io/scheme: \"http\"\n        prometheus.io/scrape: \"true\"\n    spec:\n      serviceAccountName: nurse\n      containers:\n      - name: kubenurse\n        env:\n        # - name: KUBENURSE_INGRESS_URL\n        #   value: https://kubenurse.example.com\n        - name: KUBENURSE_SERVICE_URL\n          value: http://kubenurse.kube-system.svc.cluster.local:8080\n        - name: KUBENURSE_NAMESPACE\n          value: kube-system\n        - name: KUBENURSE_NEIGHBOUR_FILTER\n          value: \"app=kubenurse\"\n        image: \"postfinance/kubenurse:v1.2.0\"\n        ports:\n        - containerPort: 8080\n          protocol: TCP\n      tolerations:\n      - effect: NoSchedule\n        key: node-role.kubernetes.io/master\n        operator: Equal\n      - effect: NoSchedule\n        key: node-role.kubernetes.io/control-plane\n        operator: Equal\n</code></pre> <p><code>rbac.yaml</code></p> <pre><code>---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: nurse\n  namespace: kube-system\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: view\nsubjects:\n- kind: ServiceAccount\n  name: nurse\n  namespace: kube-system\n</code></pre> <p><code>service.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: kubenurse\n  name: kubenurse\n  namespace: kube-system\nspec:\n  ports:\n  - name: 8080-8080\n    port: 8080\n    protocol: TCP\n    targetPort: 8080\n  selector:\n    app: kubenurse\n</code></pre> <p><code>serviceaccount.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: nurse\n  namespace: kube-system\n</code></pre> <p>\u65b0\u521b\u5efa\u4e00\u4e2aServiceMonitor\uff0c\u7528\u4e8e\u83b7\u53d6\u6307\u6807\u6570\u636e\uff0c\u5982\u4e0b\uff1a</p> <p><code>ServiceMonitor.yaml</code></p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: kubenurse\n  namespace: monitoring\n  labels:\n    k8s-app: kubenurse\nspec:\n  jobLabel: k8s-app\n  endpoints:\n  - port: \"8080-8080\" \n    interval: 30s\n    scheme: http\n  selector:\n    matchLabels:\n     app: kubenurse\n  namespaceSelector:\n    matchNames:\n    - kube-system\n</code></pre> <p>\u90e8\u7f72\u5e94\u7528\uff0c\u5728example\u76ee\u5f55\u4e0b\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002</p> <p>\u7b49\u5f85\u6240\u6709\u5e94\u7528\u53d8\u6210running\uff0c\u5982\u4e0b\u3002</p> <pre><code>$  kubectl get all -n kube-system -l app=kubenurse\nNAME                  READY   STATUS    RESTARTS   AGE\npod/kubenurse-cvk69   1/1     Running   0          15h\n\nNAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nservice/kubenurse   ClusterIP   10.108.126.242   &lt;none&gt;        8080/TCP   15h\n\nNAME                       DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\ndaemonset.apps/kubenurse   1         1         1       1            1           &lt;none&gt;          15h\n</code></pre> <p>\u5230prometheus\u4e0a\u67e5\u770b\u662f\u5426\u6b63\u5e38\u83b7\u53d6\u6570\u636e\u3002</p> <pre><code>$ kubectl port-forward svc/kube-prom-kube-prometheus-prometheus -n monitoring 9090:9090\nForwarding from 127.0.0.1:9090 -&gt; 9090\nForwarding from [::1]:9090 -&gt; 9090\n</code></pre> <p></p> <p>\u67e5\u770b\u6307\u6807\u662f\u5426\u6b63\u5e38\u3002</p> <p></p> <p></p> <p>\u8fd9\u65f6\u5019\u5c31\u53ef\u4ee5\u5728grafana\u4e0a\u753b\u56fe\uff0c\u5c55\u793a\u76d1\u63a7\u6570\u636e\u4e86\uff0c\u5982\u4e0b\u3002</p> <p></p>"},{"location":"chap4/45Prom-operator_2021/","title":"\u7b2c\u4e5d\u8282 Prometheus Operator\u5b89\u88c5\u914d\u7f6e(2021)","text":"<p>\u4f46\u5b9e\u9645\u4e0a\u5bf9\u4e0a Kubernetes \u6765\u8bf4\uff0c\u8fd8\u6709\u66f4\u7b80\u5355\u65b9\u5f0f\u6765\u76d1\u63a7\u62a5\u8b66\uff0c\u90a3\u5c31\u662f Prometheus Operator(https://prometheus-operator.dev/)\u3002</p> <p>Prometheus Operator \u4e3a\u76d1\u63a7 Kubernetes \u8d44\u6e90\u548c Prometheus \u5b9e\u4f8b\u7684\u7ba1\u7406\u63d0\u4f9b\u4e86\u7b80\u5355\u7684\u5b9a\u4e49\uff0c\u7b80\u5316\u5728 Kubernetes \u4e0a\u90e8\u7f72\u3001\u7ba1\u7406\u548c\u8fd0\u884c Prometheus \u548c Alertmanager \u96c6\u7fa4\u3002</p> <p></p>"},{"location":"chap4/45Prom-operator_2021/#1","title":"1 \u4ecb\u7ecd","text":"<p>Prometheus Operator \u4e3a Kubernetes \u63d0\u4f9b\u4e86\u5bf9 Prometheus \u673a\u5668\u76f8\u5173\u76d1\u63a7\u7ec4\u4ef6\u7684\u672c\u5730\u90e8\u7f72\u548c\u7ba1\u7406\u65b9\u6848\uff0c\u8be5\u9879\u76ee\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u7b80\u5316\u548c\u81ea\u52a8\u5316\u57fa\u4e8e Prometheus \u7684\u76d1\u63a7\u6808\u914d\u7f6e\uff0c\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u529f\u80fd\uff1a</p> <ul> <li>Kubernetes \u81ea\u5b9a\u4e49\u8d44\u6e90\uff1a\u4f7f\u7528 Kubernetes CRD \u6765\u90e8\u7f72\u548c\u7ba1\u7406 Prometheus\u3001Alertmanager \u548c\u76f8\u5173\u7ec4\u4ef6\u3002</li> <li>\u7b80\u5316\u7684\u90e8\u7f72\u914d\u7f6e\uff1a\u76f4\u63a5\u901a\u8fc7 Kubernetes \u8d44\u6e90\u6e05\u5355\u914d\u7f6e Prometheus\uff0c\u6bd4\u5982\u7248\u672c\u3001\u6301\u4e45\u5316\u3001\u526f\u672c\u3001\u4fdd\u7559\u7b56\u7565\u7b49\u7b49\u914d\u7f6e\u3002</li> <li>Prometheus \u76d1\u63a7\u76ee\u6807\u914d\u7f6e\uff1a\u57fa\u4e8e\u719f\u77e5\u7684 Kubernetes \u6807\u7b7e\u67e5\u8be2\u81ea\u52a8\u751f\u6210\u76d1\u63a7\u76ee\u6807\u914d\u7f6e\uff0c\u65e0\u9700\u5b66\u4e60 Prometheus \u7279\u5730\u7684\u914d\u7f6e\u3002</li> </ul> <p>\u9996\u5148\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e0b Prometheus Operator \u7684\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>\u4e0a\u56fe\u662f Prometheus-Operator \u5b98\u65b9\u63d0\u4f9b\u7684\u67b6\u6784\u56fe\uff0c\u5404\u7ec4\u4ef6\u4ee5\u4e0d\u540c\u7684\u65b9\u5f0f\u8fd0\u884c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u5176\u4e2d Operator \u662f\u6700\u6838\u5fc3\u7684\u90e8\u5206\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u63a7\u5236\u5668\uff0c\u4ed6\u4f1a\u53bb\u521b\u5efa Prometheus\u3001ServiceMonitor\u3001AlertManager \u4ee5\u53ca PrometheusRule \u7b49 CRD \u8d44\u6e90\u5bf9\u8c61\uff0c\u7136\u540e\u4f1a\u4e00\u76f4 Watch \u5e76\u7ef4\u6301\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u3002</p> <p>\u5728\u6700\u65b0\u7248\u672c\u7684 Operator \u4e2d\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u51e0\u4e2a CRD \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <ul> <li>Prometheus</li> <li>Alertmanager</li> <li>ServiceMonitor</li> <li>PodMonitor</li> <li>Probe</li> <li>ThanosRuler</li> <li>PrometheusRule</li> <li>AlertmanagerConfig</li> </ul>"},{"location":"chap4/45Prom-operator_2021/#1-1-prometheus","title":"1-1 Prometheus","text":"<p>\u8be5 CRD \u58f0\u660e\u5b9a\u4e49\u4e86 Prometheus \u671f\u671b\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684\u914d\u7f6e\uff0c\u63d0\u4f9b\u4e86\u914d\u7f6e\u9009\u9879\u6765\u914d\u7f6e\u526f\u672c\u3001\u6301\u4e45\u5316\u3001\u62a5\u8b66\u5b9e\u4f8b\u7b49\u3002</p> <p>\u5bf9\u4e8e\u6bcf\u4e2a Prometheus CRD \u8d44\u6e90\uff0cOperator \u90fd\u4f1a\u4ee5 StatefulSet \u5f62\u5f0f\u5728\u76f8\u540c\u7684\u547d\u540d\u7a7a\u95f4\u4e0b\u90e8\u7f72\u5bf9\u5e94\u914d\u7f6e\u7684\u8d44\u6e90\uff0cPrometheus Pod \u7684\u914d\u7f6e\u662f\u901a\u8fc7\u4e00\u4e2a\u5305\u542b Prometheus \u914d\u7f6e\u7684\u540d\u4e3a <code>&lt;prometheus-name&gt;</code>  \u7684 Secret \u5bf9\u8c61\u58f0\u660e\u6302\u8f7d\u7684\u3002</p> <p>\u8be5 CRD \u6839\u636e\u6807\u7b7e\u9009\u62e9\u6765\u6307\u5b9a\u90e8\u7f72\u7684 Prometheus \u5b9e\u4f8b\u5e94\u8be5\u8986\u76d6\u54ea\u4e9b <code>ServiceMonitor</code>\uff0c\u7136\u540e Operator \u4f1a\u6839\u636e\u5305\u542b\u7684 ServiceMonitors \u751f\u6210\u914d\u7f6e\uff0c\u5e76\u5728\u5305\u542b\u914d\u7f6e\u7684 Secret \u4e2d\u8fdb\u884c\u66f4\u65b0\u3002</p> <p>\u5982\u679c\u672a\u63d0\u4f9b\u5bf9 <code>ServiceMonitor</code> \u7684\u9009\u62e9\uff0c\u5219 Operator \u4f1a\u5c06 Secret \u7684\u7ba1\u7406\u7559\u7ed9\u7528\u6237\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u63d0\u4f9b\u81ea\u5b9a\u4e49\u914d\u7f6e\uff0c\u540c\u65f6\u8fd8\u80fd\u4eab\u53d7 Operator \u7ba1\u7406 Operator \u7684\u8bbe\u7f6e\u80fd\u529b\u3002</p>"},{"location":"chap4/45Prom-operator_2021/#1-2-alertmanager","title":"1-2 Alertmanager","text":"<p>\u8be5 CRD \u5b9a\u4e49\u4e86\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684 Alertmanager \u7684\u914d\u7f6e\uff0c\u540c\u6837\u63d0\u4f9b\u4e86\u591a\u79cd\u914d\u7f6e\uff0c\u5305\u62ec\u6301\u4e45\u5316\u5b58\u50a8\u3002</p> <p>\u5bf9\u4e8e\u6bcf\u4e2a Alertmanager \u8d44\u6e90\uff0cOperator \u90fd\u4f1a\u5728\u76f8\u540c\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u90e8\u7f72\u4e00\u4e2a\u5bf9\u5e94\u914d\u7f6e\u7684 StatefulSet\uff0cAlertmanager Pods \u88ab\u914d\u7f6e\u4e3a\u5305\u542b\u4e00\u4e2a\u540d\u4e3a <code>&lt;alertmanager-name&gt;</code> \u7684 Secret\uff0c\u8be5 Secret \u4ee5 <code>alertmanager.yaml</code> \u4e3a key \u7684\u65b9\u5f0f\u4fdd\u5b58\u4f7f\u7528\u7684\u914d\u7f6e\u6587\u4ef6\u3002</p> <p>\u5f53\u6709\u4e24\u4e2a\u6216\u66f4\u591a\u914d\u7f6e\u7684\u526f\u672c\u65f6\uff0cOperator \u4f1a\u5728\u9ad8\u53ef\u7528\u6a21\u5f0f\u4e0b\u8fd0\u884c Alertmanager \u5b9e\u4f8b\u3002</p>"},{"location":"chap4/45Prom-operator_2021/#1-3-thanosruler","title":"1-3 ThanosRuler","text":"<p>\u8be5 CRD \u5b9a\u4e49\u4e86\u4e00\u4e2a Thanos Ruler \u7ec4\u4ef6\u7684\u914d\u7f6e\uff0c\u4ee5\u65b9\u4fbf\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u8fd0\u884c\u3002\u901a\u8fc7 Thanos Ruler\uff0c\u53ef\u4ee5\u8de8\u591a\u4e2aPrometheus \u5b9e\u4f8b\u5904\u7406\u8bb0\u5f55\u548c\u8b66\u62a5\u89c4\u5219\u3002</p> <p>\u4e00\u4e2a ThanosRuler \u5b9e\u4f8b\u81f3\u5c11\u9700\u8981\u4e00\u4e2a <code>queryEndpoint</code>\uff0c\u5b83\u6307\u5411 <code>Thanos Queriers</code> \u6216 Prometheus \u5b9e\u4f8b\u7684\u4f4d\u7f6e\u3002<code>queryEndpoints</code> \u7528\u4e8e\u914d\u7f6e Thanos \u8fd0\u884c\u65f6\u7684 <code>--query</code> \u53c2\u6570\uff0c\u66f4\u591a\u4fe1\u606f\u4e5f\u53ef\u4ee5\u5728 Thanos \u6587\u6863\u4e2d\u627e\u5230\u3002</p>"},{"location":"chap4/45Prom-operator_2021/#1-4-servicemonitor","title":"1-4 ServiceMonitor","text":"<p>\u8be5 CRD \u5b9a\u4e49\u4e86\u5982\u4f55\u76d1\u63a7\u4e00\u7ec4\u52a8\u6001\u7684\u670d\u52a1\uff0c\u4f7f\u7528\u6807\u7b7e\u9009\u62e9\u6765\u5b9a\u4e49\u54ea\u4e9b Service \u88ab\u9009\u62e9\u8fdb\u884c\u76d1\u63a7\u3002\u8fd9\u53ef\u4ee5\u8ba9\u56e2\u961f\u5236\u5b9a\u4e00\u4e2a\u5982\u4f55\u66b4\u9732\u76d1\u63a7\u6307\u6807\u7684\u89c4\u8303\uff0c\u7136\u540e\u6309\u7167\u8fd9\u4e9b\u89c4\u8303\u81ea\u52a8\u53d1\u73b0\u65b0\u7684\u670d\u52a1\uff0c\u800c\u65e0\u9700\u91cd\u65b0\u914d\u7f6e\u3002</p> <p>\u4e3a\u4e86\u8ba9 Prometheus \u76d1\u63a7 Kubernetes \u5185\u7684\u4efb\u4f55\u5e94\u7528\uff0c\u9700\u8981\u5b58\u5728\u4e00\u4e2a Endpoints \u5bf9\u8c61\uff0cEndpoints \u5bf9\u8c61\u672c\u8d28\u4e0a\u662fIP\u5730\u5740\u7684\u5217\u8868\uff0c\u901a\u5e38 Endpoints \u5bf9\u8c61\u662f\u7531 Service \u5bf9\u8c61\u6765\u81ea\u52a8\u586b\u5145\u7684\uff0cService \u5bf9\u8c61\u901a\u8fc7\u6807\u7b7e\u9009\u62e9\u5668\u5339\u914d Pod\uff0c\u5e76\u5c06\u5176\u6dfb\u52a0\u5230Endpoints \u5bf9\u8c61\u4e2d\u3002</p> <p>\u4e00\u4e2a Service \u53ef\u4ee5\u66b4\u9732\u4e00\u4e2a\u6216\u591a\u4e2a\u7aef\u53e3\uff0c\u8fd9\u4e9b\u7aef\u53e3\u7531\u591a\u4e2a Endpoints \u5217\u8868\u652f\u6301\uff0c\u8fd9\u4e9b\u7aef\u70b9\u4e00\u822c\u60c5\u51b5\u4e0b\u90fd\u662f\u6307\u5411\u4e00\u4e2a Pod\u3002</p> <p>Prometheus Operator \u5f15\u5165\u7684\u8fd9\u4e2a ServiceMonitor \u5bf9\u8c61\u5c31\u4f1a\u53d1\u73b0\u8fd9\u4e9b Endpoints \u5bf9\u8c61\uff0c\u5e76\u914d\u7f6e Prometheus \u76d1\u63a7\u8fd9\u4e9b Pod\u3002<code>ServiceMonitorSpec</code> \u7684 endpoints \u90e8\u5206\u5c31\u662f\u7528\u4e8e\u914d\u7f6e\u8fd9\u4e9b Endpoints \u7684\u54ea\u4e9b\u7aef\u53e3\u5c06\u88ab scrape \u6307\u6807\u7684\u3002</p> <p>\u6ce8\u610f\uff1aendpoints\uff08\u5c0f\u5199\uff09\u662f ServiceMonitor CRD \u4e2d\u7684\u5b57\u6bb5\uff0c\u800c Endpoints\uff08\u5927\u5199\uff09\u662f Kubernetes \u7684\u4e00\u79cd\u5bf9\u8c61\u3002</p> <p>ServiceMonitors \u4ee5\u53ca\u88ab\u53d1\u73b0\u7684\u76ee\u6807\u90fd\u53ef\u4ee5\u6765\u81ea\u4efb\u4f55\u547d\u540d\u7a7a\u95f4\uff0c\u8fd9\u5bf9\u4e8e\u5141\u8bb8\u8de8\u547d\u540d\u7a7a\u95f4\u76d1\u63a7\u7684\u573a\u666f\u975e\u5e38\u91cd\u8981\u3002</p> <p>\u4f7f\u7528 <code>PrometheusSpec</code> \u7684 <code>ServiceMonitorNamespaceSelector</code>\uff0c\u53ef\u4ee5\u9650\u5236\u5404\u81ea\u7684 Prometheus \u670d\u52a1\u5668\u9009\u62e9\u7684 <code>ServiceMonitors</code> \u7684\u547d\u540d\u7a7a\u95f4\u3002</p> <p>\u4f7f\u7528 <code>ServiceMonitorSpec</code> \u7684 <code>namespaceSelector</code>\uff0c\u53ef\u4ee5\u9650\u5236 <code>Endpoints</code> \u5bf9\u8c61\u88ab\u5141\u8bb8\u4ece\u54ea\u4e9b\u547d\u540d\u7a7a\u95f4\u4e2d\u53d1\u73b0\uff0c\u8981\u5728\u6240\u6709\u547d\u540d\u7a7a\u95f4\u4e2d\u53d1\u73b0\u76ee\u6807\uff0c<code>namespaceSelector</code> \u5fc5\u987b\u4e3a\u7a7a\uff1a</p> <pre><code>spec:\n  namespaceSelector:\n    any: true\n</code></pre>"},{"location":"chap4/45Prom-operator_2021/#1-5-podmonitor","title":"1-5 PodMonitor","text":"<p>\u8be5 CRD \u7528\u4e8e\u5b9a\u4e49\u5982\u4f55\u76d1\u63a7\u4e00\u7ec4\u52a8\u6001 pods\uff0c\u4f7f\u7528\u6807\u7b7e\u9009\u62e9\u6765\u5b9a\u4e49\u54ea\u4e9b pods \u88ab\u9009\u62e9\u8fdb\u884c\u76d1\u63a7\u3002\u540c\u6837\u56e2\u961f\u4e2d\u53ef\u4ee5\u5236\u5b9a\u4e00\u4e9b\u89c4\u8303\u6765\u66b4\u9732\u76d1\u63a7\u7684\u6307\u6807\u3002</p> <p>Pod \u662f\u4e00\u4e2a\u6216\u591a\u4e2a\u5bb9\u5668\u7684\u96c6\u5408\uff0c\u53ef\u4ee5\u5728\u4e00\u4e9b\u7aef\u53e3\u4e0a\u66b4\u9732Prometheus\u6307\u6807\u3002</p> <p>\u7531 Prometheus Operator \u5f15\u5165\u7684 PodMonitor \u5bf9\u8c61\u4f1a\u53d1\u73b0\u8fd9\u4e9b Pod\uff0c\u5e76\u4e3a Prometheus \u670d\u52a1\u5668\u751f\u6210\u76f8\u5173\u914d\u7f6e\uff0c\u4ee5\u4fbf\u76d1\u63a7\u5b83\u4eec\u3002</p> <p><code>PodMonitorSpec</code> \u4e2d\u7684 <code>PodMetricsEndpoints</code> \u90e8\u5206\uff0c\u7528\u4e8e\u914d\u7f6e Pod \u7684\u54ea\u4e9b\u7aef\u53e3\u5c06\u88ab <code>scrape</code> \u6307\u6807\uff0c\u4ee5\u53ca\u4f7f\u7528\u54ea\u4e9b\u53c2\u6570\u3002</p> <p>PodMonitors \u548c\u53d1\u73b0\u7684\u76ee\u6807\u53ef\u4ee5\u6765\u81ea\u4efb\u4f55\u547d\u540d\u7a7a\u95f4\uff0c\u8fd9\u540c\u6837\u5bf9\u4e8e\u5141\u8bb8\u8de8\u547d\u540d\u7a7a\u95f4\u7684\u76d1\u63a7\u7528\u4f8b\u662f\u5f88\u91cd\u8981\u7684\u3002\u4f7f\u7528 <code>PodMonitorSpec</code> \u7684 <code>namespaceSelector</code>\uff0c\u53ef\u4ee5\u9650\u5236 <code>Pod</code> \u88ab\u5141\u8bb8\u53d1\u73b0\u7684\u547d\u540d\u7a7a\u95f4\uff0c\u8981\u5728\u6240\u6709\u547d\u540d\u7a7a\u95f4\u4e2d\u53d1\u73b0\u76ee\u6807\uff0c<code>namespaceSelector</code> \u5fc5\u987b\u4e3a\u7a7a\uff1a</p> <pre><code>spec:\n  namespaceSelector:\n    any: true\n</code></pre> <p>PodMonitor \u548c ServieMonitor \u6700\u5927\u7684\u533a\u522b\u5c31\u662f\u4e0d\u9700\u8981\u6709\u5bf9\u5e94\u7684 Service\u3002</p>"},{"location":"chap4/45Prom-operator_2021/#1-6-probe","title":"1-6 Probe","text":"<p>\u8be5 CRD \u7528\u4e8e\u5b9a\u4e49\u5982\u4f55\u76d1\u63a7\u4e00\u7ec4 Ingress \u548c\u9759\u6001\u76ee\u6807\u3002\u9664\u4e86 target \u4e4b\u5916\uff0c<code>Probe</code> \u5bf9\u8c61\u8fd8\u9700\u8981\u4e00\u4e2a <code>prober</code>\uff0c\u5b83\u662f\u76d1\u63a7\u7684\u76ee\u6807\u5e76\u4e3a Prometheus \u63d0\u4f9b\u6307\u6807\u7684\u670d\u52a1\u3002\u4f8b\u5982\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 blackbox-exporter \u6765\u63d0\u4f9b\u8fd9\u4e2a\u670d\u52a1\u3002</p>"},{"location":"chap4/45Prom-operator_2021/#1-7-prometheusrule","title":"1-7 PrometheusRule","text":"<p>\u7528\u4e8e\u914d\u7f6e Prometheus \u7684 Rule \u89c4\u5219\u6587\u4ef6\uff0c\u5305\u62ec recording rules \u548c alerting\uff0c\u53ef\u4ee5\u81ea\u52a8\u88ab Prometheus \u52a0\u8f7d\u3002</p>"},{"location":"chap4/45Prom-operator_2021/#1-8-alertmanagerconfig","title":"1-8 AlertmanagerConfig","text":"<p>\u5728\u4ee5\u524d\u7684\u7248\u672c\u4e2d\u8981\u914d\u7f6e Alertmanager \u90fd\u662f\u901a\u8fc7 Configmap \u6765\u5b8c\u6210\u7684\uff0c\u5728 v0.43 \u7248\u672c\u540e\u65b0\u589e\u8be5 CRD\uff0c\u53ef\u4ee5\u5c06 Alertmanager \u7684\u914d\u7f6e\u5206\u5272\u6210\u4e0d\u540c\u7684\u5b50\u5bf9\u8c61\u8fdb\u884c\u914d\u7f6e\uff0c\u5141\u8bb8\u5c06\u62a5\u8b66\u8def\u7531\u5230\u81ea\u5b9a\u4e49 Receiver \u4e0a\uff0c\u5e76\u914d\u7f6e\u6291\u5236\u89c4\u5219\u3002</p> <p>AlertmanagerConfig \u53ef\u4ee5\u5728\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u4e0a\u5b9a\u4e49\uff0c\u4e3a Alertmanager \u63d0\u4f9b\u4e00\u4e2a\u805a\u5408\u7684\u914d\u7f6e\u3002\u8fd9\u91cc\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5982\u4f55\u4f7f\u7528\u5b83\u7684\u4f8b\u5b50\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u8fd9\u4e2a CRD \u8fd8\u4e0d\u7a33\u5b9a\u3002</p> <p>\u8fd9\u6837\u6211\u4eec\u8981\u5728\u96c6\u7fa4\u4e2d\u76d1\u63a7\u4ec0\u4e48\u6570\u636e\uff0c\u5c31\u53d8\u6210\u4e86\u76f4\u63a5\u53bb\u64cd\u4f5c Kubernetes \u96c6\u7fa4\u7684\u8d44\u6e90\u5bf9\u8c61\u4e86\uff0c\u662f\u8fd9\u6837\u6bd4\u4e4b\u524d\u624b\u52a8\u7684\u65b9\u5f0f\u5c31\u65b9\u4fbf\u5f88\u591a\u4e86\u3002</p>"},{"location":"chap4/45Prom-operator_2021/#2","title":"2 \u5b89\u88c5","text":"<p>\u4e3a\u4e86\u4f7f\u7528 Prometheus-Operator\uff0c\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 kube-prometheus \u8fd9\u4e2a\u9879\u76ee\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u8be5\u9879\u76ee\u548c Prometheus-Operator \u7684\u533a\u522b\u5c31\u7c7b\u4f3c\u4e8e Linux \u5185\u6838\u548c CentOS/Ubuntu \u8fd9\u4e9b\u53d1\u884c\u7248\u7684\u5173\u7cfb\uff0c\u771f\u6b63\u8d77\u4f5c\u7528\u7684\u662f Operator \u53bb\u5b9e\u73b0\u7684\uff0c\u800c <code>kube-prometheus</code> \u53ea\u662f\u5229\u7528 Operator \u7f16\u5199\u4e86\u4e00\u7cfb\u5217\u5e38\u7528\u7684\u76d1\u63a7\u8d44\u6e90\u6e05\u5355\u3002</p> <p>\u9996\u5148 clone \u9879\u76ee\u4ee3\u7801\uff0c\u5207\u6362\u5230\u5f53\u524d\u6700\u65b0\u7684 v0.7.0 \u7248\u672c\uff1a</p> <pre><code>$ git clone https://github.com/prometheus-operator/kube-prometheus.git\n$ cd kube-prometheus &amp;&amp; git checkout v0.7.0\n</code></pre> <p>\u9996\u5148\u521b\u5efa\u9700\u8981\u7684\u547d\u540d\u7a7a\u95f4\u548c CRDs\uff0c\u7b49\u5f85\u5b83\u4eec\u53ef\u7528\u540e\u518d\u521b\u5efa\u5176\u4f59\u8d44\u6e90\uff1a</p> <pre><code>$ kubectl apply -f manifests/setup\n$ until kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo \"\"; done\n$ kubectl apply -f manifests/\n</code></pre> <p>\u8fdb\u5165\u5230 <code>manifests</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u5b89\u88c5 <code>setup</code> \u76ee\u5f55\u4e0b\u9762\u7684 <code>CRD</code> \u548c <code>Operator</code>\u8d44\u6e90\u5bf9\u8c61\uff0c\u7b49\u5f85\u5b83\u4eec\u53ef\u7528\u540e\u518d\u521b\u5efa\u5176\u4f59\u8d44\u6e90\uff1a</p> <pre><code>$ kubectl apply -f setup/\n$ kubectl get pods -n monitoring\nNAME                                   READY   STATUS    RESTARTS   AGE\nprometheus-operator-7649c7454f-wqtx7   2/2     Running   0          2m42s\n</code></pre> <p>\u8fd9\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>monitoring</code>\u7684\u547d\u540d\u7a7a\u95f4\uff0c\u4ee5\u53ca\u76f8\u5173\u7684 CRD \u8d44\u6e90\u5bf9\u8c61\u58f0\u660e\u548c Prometheus Operator \u63a7\u5236\u5668\u3002</p> <p>\u524d\u9762\u7ae0\u8282\u4e2d\u6211\u4eec\u8bb2\u89e3\u8fc7 CRD \u548c Operator \u7684\u4f7f\u7528\uff0c\u5f53\u6211\u4eec\u58f0\u660e\u5b8c CRD \u8fc7\u540e\uff0c\u5c31\u53ef\u4ee5\u6765\u81ea\u5b9a\u4e49\u8d44\u6e90\u6e05\u5355\u4e86\uff0c\u4f46\u662f\u8981\u8ba9\u6211\u4eec\u58f0\u660e\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\u5bf9\u8c61\u751f\u6548\u5c31\u9700\u8981\u5b89\u88c5\u5bf9\u5e94\u7684 Operator \u63a7\u5236\u5668\uff0c\u8fd9\u91cc\u6211\u4eec\u90fd\u5df2\u7ecf\u5b89\u88c5\u4e86\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u6765\u7528 CRD \u521b\u5efa\u771f\u6b63\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90\u5bf9\u8c61\u4e86\u3002</p> <p>\u5728 <code>manifests</code> \u76ee\u5f55\u4e0b\u9762\u7684\u5c31\u662f\u6211\u4eec\u8981\u53bb\u521b\u5efa\u7684 Prometheus\u3001Alertmanager \u4ee5\u53ca\u5404\u79cd\u76d1\u63a7\u5bf9\u8c61\u7684\u8d44\u6e90\u6e05\u5355\uff0c\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f manifests/\n</code></pre> <p>\u8fd9\u4f1a\u81ea\u52a8\u5b89\u88c5 <code>node-exporter</code>\u3001<code>kube-state-metrics</code>\u3001<code>grafana</code>\u3001<code>prometheus-adapter</code> \u4ee5\u53ca <code>prometheus</code> \u548c <code>alertmanager</code> \u7b49\u5927\u91cf\u7ec4\u4ef6\uff0c\u800c\u4e14 prometheus \u548c alertmanager \u8fd8\u662f\u591a\u526f\u672c\u7684\u3002</p> <pre><code>$ kubectl get pods -n monitoring\nNAME                                   READY   STATUS    RESTARTS   AGE\nalertmanager-main-0                    2/2     Running   0          12m\nalertmanager-main-1                    2/2     Running   0          12m\nalertmanager-main-2                    2/2     Running   0          12m\ngrafana-f8cd57fcf-kbnsj                1/1     Running   0          12m\nkube-state-metrics-587bfd4f97-pwk5p    3/3     Running   0          12m\nnode-exporter-djwtz                    2/2     Running   0          12m\nnode-exporter-k7zl9                    2/2     Running   0          12m\nnode-exporter-rlnjt                    2/2     Running   0          12m\nprometheus-adapter-69b8496df6-vq7bl    1/1     Running   0          12m\nprometheus-k8s-0                       2/2     Running   0          12m\nprometheus-k8s-1                       1/2     Running   0          12m\nprometheus-operator-7649c7454f-wqtx7   2/2     Running   0          16m\n$ kubectl get svc -n monitoring                      \nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE\nalertmanager-main       ClusterIP   10.104.5.112     &lt;none&gt;        9093/TCP                     4m58s\nalertmanager-operated   ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   4m58s\ngrafana                 ClusterIP   10.107.173.231   &lt;none&gt;        3000/TCP                     4m52s\nkube-state-metrics      ClusterIP   None             &lt;none&gt;        8443/TCP,9443/TCP            4m51s\nnode-exporter           ClusterIP   None             &lt;none&gt;        9100/TCP                     4m51s\nprometheus-adapter      ClusterIP   10.104.205.68    &lt;none&gt;        443/TCP                      4m50s\nprometheus-k8s          ClusterIP   10.105.168.183   &lt;none&gt;        9090/TCP                     4m49s\nprometheus-operated     ClusterIP   None             &lt;none&gt;        9090/TCP                     4m50s\nprometheus-operator     ClusterIP   None             &lt;none&gt;        8443/TCP  \n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u9488\u5bf9 grafana\u3001alertmanager \u548c prometheus \u90fd\u521b\u5efa\u4e86\u4e00\u4e2a\u7c7b\u578b\u4e3a ClusterIP \u7684 Service\uff0c\u5f53\u7136\u5982\u679c\u6211\u4eec\u60f3\u8981\u5728\u5916\u7f51\u8bbf\u95ee\u8fd9\u4e24\u4e2a\u670d\u52a1\u7684\u8bdd\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u5bf9\u5e94\u7684 Ingress \u5bf9\u8c61\u6216\u8005\u4f7f\u7528 NodePort \u7c7b\u578b\u7684 Service\uff0c</p> <p>\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5355\uff0c\u76f4\u63a5\u4f7f\u7528 NodePort \u7c7b\u578b\u7684\u670d\u52a1\u5373\u53ef\uff0c\u7f16\u8f91 <code>grafana</code>\u3001<code>alertmanager-main</code> \u548c <code>prometheus-k8s</code> \u8fd93\u4e2a Service\uff0c\u5c06\u670d\u52a1\u7c7b\u578b\u66f4\u6539\u4e3a NodePort:</p> <pre><code># \u5c06 type: ClusterIP \u66f4\u6539\u4e3a type: NodePort\n$ kubectl edit svc grafana -n monitoring  \n$ kubectl edit svc alertmanager-main -n monitoring\n$ kubectl edit svc prometheus-k8s -n monitoring\n$ kubectl get svc -n monitoring\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE\nalertmanager-main       NodePort    10.111.28.173    &lt;none&gt;        9093:30733/TCP               18m\ngrafana                 NodePort    10.99.62.32      &lt;none&gt;        3000:32150/TCP               17m\nprometheus-k8s          NodePort    10.111.105.155   &lt;none&gt;        9090:30206/TCP               17m\n......\n</code></pre> <p>\u66f4\u6539\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684 NodePort \u53bb\u8bbf\u95ee\u5bf9\u5e94\u7684\u670d\u52a1\u4e86\uff0c\u6bd4\u5982\u67e5\u770b prometheus \u7684\u670d\u52a1\u53d1\u73b0\u9875\u9762\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u76d1\u63a7\u4e0a\u4e86\u5f88\u591a\u6307\u6807\u6570\u636e\u4e86\uff0c\u4e0a\u9762\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Prometheus \u662f\u4e24\u4e2a\u526f\u672c\uff0c\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7 Service \u53bb\u8bbf\u95ee\uff0c\u6309\u6b63\u5e38\u6765\u8bf4\u8bf7\u6c42\u662f\u4f1a\u53bb\u8f6e\u8be2\u8bbf\u95ee\u540e\u7aef\u7684\u4e24\u4e2a Prometheus \u5b9e\u4f8b\u7684\uff0c\u4f46\u5b9e\u9645\u4e0a\u6211\u4eec\u8fd9\u91cc\u8bbf\u95ee\u7684\u65f6\u5019\u59cb\u7ec8\u662f\u8def\u7531\u5230\u540e\u7aef\u7684\u4e00\u4e2a\u5b9e\u4f8b\u4e0a\u53bb\uff0c\u56e0\u4e3a\u8fd9\u91cc\u7684 <code>Service</code> \u5728\u521b\u5efa\u7684\u65f6\u5019\u6dfb\u52a0\u4e86 <code>sessionAffinity: ClientIP</code> \u8fd9\u6837\u7684\u5c5e\u6027\uff0c\u4f1a\u6839\u636e <code>ClientIP</code> \u6765\u505a <code>session</code> \u4eb2\u548c\u6027\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u7528\u62c5\u5fc3\u8bf7\u6c42\u4f1a\u5230\u4e0d\u540c\u7684\u526f\u672c\u4e0a\u53bb\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    prometheus: k8s\n  name: prometheus-k8s\n  namespace: monitoring\nspec:\n  ports:\n  - name: web\n    port: 9090\n    targetPort: web\n  selector:\n    app: prometheus\n    prometheus: k8s\n  sessionAffinity: ClientIP\n</code></pre> <p>\u4e3a\u4ec0\u4e48\u4f1a\u62c5\u5fc3\u8bf7\u6c42\u4f1a\u5230\u4e0d\u540c\u7684\u526f\u672c\u4e0a\u53bb\u5462\uff1f\u6b63\u5e38\u591a\u526f\u672c\u5e94\u8be5\u662f\u770b\u6210\u9ad8\u53ef\u7528\u7684\u5e38\u7528\u65b9\u6848\uff0c\u7406\u8bba\u4e0a\u6765\u8bf4\u4e0d\u540c\u526f\u672c\u672c\u5730\u7684\u6570\u636e\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f Prometheus \u7684\u4e3b\u52a8 Pull \u62c9\u53d6\u76d1\u63a7\u6307\u6807\u7684\u65b9\u5f0f\uff0c\u7531\u4e8e\u6293\u53d6\u65f6\u95f4\u4e0d\u80fd\u5b8c\u5168\u4e00\u81f4\uff0c\u5373\u4f7f\u4e00\u81f4\u4e5f\u4e0d\u4e00\u5b9a\u5c31\u80fd\u4fdd\u8bc1\u7f51\u7edc\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u6240\u4ee5\u6700\u7ec8\u4e0d\u540c\u526f\u672c\u4e0b\u5b58\u50a8\u7684\u6570\u636e\u5f88\u5927\u53ef\u80fd\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e86 session \u4eb2\u548c\u6027\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u6211\u4eec\u5728\u8bbf\u95ee\u6570\u636e\u7684\u65f6\u5019\u59cb\u7ec8\u662f\u4e00\u81f4\u7684\u3002</p>"},{"location":"chap4/45Prom-operator_2021/#3","title":"3 \u914d\u7f6e","text":"<p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u76d1\u63a7\u6307\u6807\u5927\u90e8\u5206\u7684\u914d\u7f6e\u90fd\u662f\u6b63\u5e38\u7684\uff0c\u53ea\u6709\u4e24\u4e09\u4e2a\u6ca1\u6709\u7ba1\u7406\u5230\u5bf9\u5e94\u7684\u76d1\u63a7\u76ee\u6807\uff0c\u6bd4\u5982 kube-controller-manager \u548c kube-scheduler \u8fd9\u4e24\u4e2a\u7cfb\u7edf\u7ec4\u4ef6\u3002</p> <p></p> <p>\u8fd9\u5176\u5b9e\u5c31\u548c <code>ServiceMonitor</code> \u7684\u5b9a\u4e49\u6709\u5173\u7cfb\u4e86\uff0c\u6211\u4eec\u5148\u6765\u67e5\u770b\u4e0b kube-scheduler \u7ec4\u4ef6\u5bf9\u5e94\u7684 ServiceMonitor \u8d44\u6e90\u7684\u5b9a\u4e49\uff1a</p> <pre><code># manifests/prometheus-serviceMonitorKubeScheduler.yaml\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    k8s-app: kube-scheduler\n  name: kube-scheduler\n  namespace: monitoring\nspec:\n  endpoints:\n  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token  # token \u6587\u4ef6\n    interval: 30s  # \u6bcf30s\u83b7\u53d6\u4e00\u6b21\u4fe1\u606f\n    port: https-metrics  # \u5bf9\u5e94 service \u7684\u7aef\u53e3\u540d\n    scheme: https  # \u6ce8\u610f\u662f\u4f7f\u7528 https \u534f\u8bae\n    tlsConfig:  # \u8df3\u8fc7\u5b89\u5168\u6821\u9a8c\n      insecureSkipVerify: true\n  jobLabel: k8s-app  # \u7528\u4e8e\u4ece\u4e2d\u68c0\u7d22\u4efb\u52a1\u540d\u79f0\u7684\u6807\u7b7e\n  namespaceSelector:  # \u8868\u793a\u53bb\u5339\u914d\u67d0\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u7684 Service\uff0c\u5982\u679c\u60f3\u4ece\u6240\u6709\u7684namespace\u4e2d\u5339\u914d\u7528any:true\n    matchNames:\n    - kube-system\n  selector:  # \u5339\u914d\u7684 Service \u7684 labels\uff0c\u5982\u679c\u4f7f\u7528 mathLabels\uff0c\u5219\u4e0b\u9762\u7684\u6240\u6709\u6807\u7b7e\u90fd\u5339\u914d\u65f6\u624d\u4f1a\u5339\u914d\u8be5 service\uff0c\u5982\u679c\u4f7f\u7528 matchExpressions\uff0c\u5219\u81f3\u5c11\u5339\u914d\u4e00\u4e2a\u6807\u7b7e\u7684 service \u90fd\u4f1a\u88ab\u9009\u62e9\n    matchLabels:\n      k8s-app: kube-scheduler\n</code></pre> <p>\u4e0a\u9762\u662f\u4e00\u4e2a\u5178\u578b\u7684 <code>ServiceMonitor</code> \u8d44\u6e90\u5bf9\u8c61\u7684\u58f0\u660e\u65b9\u5f0f\uff0c\u4e0a\u9762\u6211\u4eec\u901a\u8fc7 <code>selector.matchLabels</code> \u5728 <code>kube-system</code> \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5339\u914d\u5177\u6709 <code>k8s-app=kube-scheduler</code> \u8fd9\u6837\u7684 <code>Service</code>\uff0c\u4f46\u662f\u6211\u4eec\u7cfb\u7edf\u4e2d\u6839\u672c\u5c31\u6ca1\u6709\u5bf9\u5e94\u7684 Service\uff1a</p> <pre><code>$ kubectl get svc -n kube-system -l k8s-app=kube-scheduler\nNo resources found in kube-system namespace.\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u53bb\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 Service \u5bf9\u8c61\uff0c\u624d\u80fd\u4e0e ServiceMonitor \u8fdb\u884c\u5173\u8054\uff1a</p> <pre><code># prometheus-kubeSchedulerService.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: kube-system\n  name: kube-scheduler\n  labels:  # \u5fc5\u987b\u548c\u4e0a\u9762\u7684 ServiceMonitor \u4e0b\u9762\u7684 matchLabels \u4fdd\u6301\u4e00\u81f4\n    k8s-app: kube-scheduler\nspec:\n  selector:\n    component: kube-scheduler\n  ports:\n  - name: https-metrics\n    port: 10259  \n    targetPort: 10259  # \u9700\u8981\u6ce8\u610f\u73b0\u5728\u7248\u672c\u9ed8\u8ba4\u7684\u5b89\u5168\u7aef\u53e3\u662f10259\n</code></pre> <p>\u5176\u4e2d\u6700\u91cd\u8981\u7684\u662f\u4e0a\u9762 labels \u548c selector \u90e8\u5206\uff0clabels \u533a\u57df\u7684\u914d\u7f6e\u5fc5\u987b\u548c\u6211\u4eec\u4e0a\u9762\u7684 ServiceMonitor \u5bf9\u8c61\u4e2d\u7684 selector \u4fdd\u6301\u4e00\u81f4\uff0cselector \u4e0b\u9762\u914d\u7f6e\u7684\u662f <code>component=kube-scheduler</code>\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u662f\u8fd9\u4e2a label \u6807\u7b7e\u5462\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb <code>describe</code> \u4e0b <code>kube-scheduler</code> \u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl describe pod kube-scheduler-master1 -n kube-system\nName:                 kube-scheduler-master1\nNamespace:            kube-system\nPriority:             2000001000\nPriority Class Name:  system-node-critical\nNode:                 master1/192.168.31.75\nStart Time:           Mon, 29 Mar 2021 18:15:46 +0800\nLabels:               component=kube-scheduler\n                      tier=control-plane\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a Pod \u5177\u6709 <code>component=kube-scheduler</code> \u548c <code>tier=control-plane</code> \u8fd9\u4e24\u4e2a\u6807\u7b7e\uff0c\u800c\u524d\u9762\u8fd9\u4e2a\u6807\u7b7e\u5177\u6709\u66f4\u552f\u4e00\u7684\u7279\u6027\uff0c\u6240\u4ee5\u4f7f\u7528\u524d\u9762\u8fd9\u4e2a\u6807\u7b7e\u8f83\u597d\uff0c\u8fd9\u6837\u4e0a\u9762\u521b\u5efa\u7684 Service \u5c31\u53ef\u4ee5\u548c\u6211\u4eec\u7684 Pod \u8fdb\u884c\u5173\u8054\u4e86\uff0c\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f prometheus-kubeSchedulerService.yaml\n$ kubectl get svc -n kube-system -l k8s-app=kube-scheduler\nNAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE\nkube-scheduler   ClusterIP   10.100.66.246   &lt;none&gt;        10251/TCP   2m2s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u5c0f\u4f1a\u513f\u540e\u53bb Prometheus \u9875\u9762\u4e0a\u67e5\u770b targets \u4e0b\u9762 kube-scheduler \u5df2\u7ecf\u6709\u91c7\u96c6\u7684\u76ee\u6807\u4e86\uff0c\u4f46\u662f\u62a5\u4e86 <code>connect: connection refused</code> \u8fd9\u6837\u7684\u9519\u8bef\uff1a</p> <p></p> <p>\u8fd9\u662f\u56e0\u4e3a kube-scheduler \u542f\u52a8\u7684\u65f6\u5019\u9ed8\u8ba4\u7ed1\u5b9a\u7684\u662f <code>127.0.0.1</code> \u5730\u5740\uff0c\u6240\u4ee5\u8981\u901a\u8fc7 IP \u5730\u5740\u53bb\u8bbf\u95ee\u5c31\u88ab\u62d2\u7edd\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b master \u8282\u70b9\u4e0a\u7684\u9759\u6001 Pod \u8d44\u6e90\u6e05\u5355\u6765\u786e\u8ba4\u8fd9\u4e00\u70b9\uff1a</p> <pre><code># /etc/kubernetes/manifests/kube-scheduler.yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  creationTimestamp: null\n  labels:\n    component: kube-scheduler\n    tier: control-plane\n  name: kube-scheduler\n  namespace: kube-system\nspec:\n  containers:\n  - command:\n    - kube-scheduler\n    - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf\n    - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf\n    - --bind-address=127.0.0.1  # \u7ed1\u5b9a\u4e86127.0.0.1\n    - --kubeconfig=/etc/kubernetes/scheduler.conf\n    - --leader-elect=true\n    - --port=0  # \u5982\u679c\u4e3a0\uff0c\u5219\u4e0d\u63d0\u4f9b HTTP \u670d\u52a1\uff0c--secure-port \u9ed8\u8ba4\u503c\uff1a10259\uff0c\u901a\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u548c\u6388\u6743\u4e3a HTTPS \u670d\u52a1\u7684\u7aef\u53e3\uff0c\u5982\u679c\u4e3a 0\uff0c\u5219\u4e0d\u63d0\u4f9b HTTPS\u3002\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5c06\u4e0a\u9762\u7684 <code>--bind-address=127.0.0.1</code> \u66f4\u6539\u4e3a <code>--bind-address=0.0.0.0</code> \u5373\u53ef\uff0c\u66f4\u6539\u540e <code>kube-scheduler</code> \u4f1a\u81ea\u52a8\u91cd\u542f\uff0c\u91cd\u542f\u5b8c\u6210\u540e\u518d\u53bb\u67e5\u770b Prometheus \u4e0a\u9762\u7684\u91c7\u96c6\u76ee\u6807\u5c31\u6b63\u5e38\u4e86\u3002</p> <p>\u53ef\u4ee5\u7528\u540c\u6837\u7684\u65b9\u5f0f\u6765\u4fee\u590d\u4e0b <code>kube-controller-manager</code> \u7ec4\u4ef6\u7684\u76d1\u63a7\uff0c\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 Service \u5bf9\u8c61\uff0c\u53ea\u662f\u7aef\u53e3\u6539\u6210 10257\uff1a</p> <pre><code># prometheus-kubeControllerManagerService.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: kube-system\n  name: kube-controller-manager\n  labels:\n    k8s-app: kube-controller-manager\nspec:\n  selector:\n    component: kube-controller-manager\n  ports:\n  - name: https-metrics\n    port: 10257\n    targetPort: 10257  # controller-manager \u7684\u5b89\u5168\u7aef\u53e3\u4e3a10257\n</code></pre> <p>\u7136\u540e\u5c06 <code>kube-controller-manager</code> \u9759\u6001 Pod \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\u7684\u53c2\u6570 <code>--bind-address=127.0.0.1</code> \u66f4\u6539\u4e3a <code>--bind-address=0.0.0.0</code>\u3002</p> <p></p> <p>\u4e0a\u9762\u7684\u76d1\u63a7\u6570\u636e\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b Grafana \u4e0b\u9762\u7684\u76d1\u63a7\u56fe\u8868\u4e86\uff0c\u540c\u6837\u4f7f\u7528\u4e0a\u9762\u7684 NodePort \u8bbf\u95ee\u5373\u53ef\uff0c\u7b2c\u4e00\u6b21\u767b\u5f55\u4f7f\u7528 <code>admin:admin</code> \u767b\u5f55\u5373\u53ef\uff0c\u8fdb\u5165\u9996\u9875\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u5176\u5b9e Grafana \u5df2\u7ecf\u6709\u5f88\u591a\u914d\u7f6e\u597d\u7684\u76d1\u63a7\u56fe\u8868\u4e86\u3002</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u968f\u4fbf\u9009\u62e9\u4e00\u4e2a Dashboard \u67e5\u770b\u76d1\u63a7\u56fe\u8868\u4fe1\u606f\u3002</p> <p></p> <p>\u5982\u679c\u8981\u6e05\u7406 Prometheus-Operator\uff0c\u53ef\u4ee5\u76f4\u63a5\u5220\u9664\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\uff1a</p> <pre><code>$ kubectl delete -f manifests/ \n$ kubectl delete -f manifests/setup/\n</code></pre>"},{"location":"chap4/46Prometheus_traefik/","title":"\u7b2c\u5341\u8282 Traefik\u4e4b\u4f7f\u7528Prometheus Operator\u8fdb\u884c\u76d1\u63a7\u62a5\u8b662021","text":"<p>\u672c\u6587\u6211\u4eec\u5c06\u63a2\u8ba8\u5982\u4f55\u4f7f\u7528 Prometheus \u548c Grafana \u4ece Traefik \u63d0\u4f9b\u7684 metrics \u6307\u6807\u4e2d\u8fdb\u884c\u76d1\u63a7\u62a5\u8b66\u3002</p> <p></p>"},{"location":"chap4/46Prometheus_traefik/#_1","title":"\u5b89\u88c5","text":"<p>\u9996\u5148\u4f60\u9700\u8981\u4e00\u4e2a\u53ef\u4ee5\u8bbf\u95ee\u7684 Kubernetes \u96c6\u7fa4\u3002</p>"},{"location":"chap4/46Prometheus_traefik/#1-traefik","title":"1 \u90e8\u7f72 Traefik","text":"<p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u66f4\u52a0\u7b80\u5355\u7684 Helm \u65b9\u5f0f\u6765\u5b89\u88c5\u90e8\u7f72 Traefik\u3002\u9996\u5148\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5c06 Traefik \u6dfb\u52a0\u5230 Helm \u7684\u4ed3\u5e93\u4e2d\uff1a</p> <pre><code>$ helm repo add traefik https://helm.traefik.io/traefik\n$ helm repo update\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5728 <code>kube-system</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u6765\u90e8\u7f72\u6700\u65b0\u7248\u672c\u7684 <code>Traefik</code>\uff0c\u5728\u6211\u4eec\u8fd9\u4e2a\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u786e\u4fdd\u5728\u96c6\u7fa4\u4e2d\u542f\u7528\u4e86 <code>Prometheus</code> \u6307\u6807\uff0c\u53ef\u4ee5\u901a\u8fc7\u7ed9 <code>Helm</code> \u4f20\u9012 <code>--metrics.prometheus=true</code> \u6807\u5fd7\u6765\u5b9e\u73b0\uff0c\u8fd9\u91cc\u6211\u4eec\u5c06\u6240\u6709\u914d\u7f6e\u90fd\u653e\u7f6e\u5230\u4e0b\u9762\u7684 <code>traefik-values.yaml</code> \u6587\u4ef6\u4e2d\uff1a</p> <p><code>traefik-values.yaml</code></p> <pre><code># \u7b80\u5355\u4f7f\u7528 hostPort \u6a21\u5f0f\nports:\n  web:\n    port: 8000\n    hostPort: 80\n  websecure:\n    port: 8443\n    hostPort: 443\n\nservice:\n  enabled: false\n# \u4e0d\u66b4\u9732 dashboard\n\n\ndashboard:\n  # Enable the dashboard on Traefik\n  enable: true\n  ingressRoute: false\n# ingressRoute:\n#   dashboard:\n#     enabled: false\n\n# \u5f00\u542f prometheus \u76d1\u63a7\u6307\u6807\nadditionalArguments:\n- --api.debug=true\n- --metrics.prometheus=true\n\n# kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\u9ed8\u8ba4\u60c5\u51b5\u4e0bmaster\u662f\u6709\u6c61\u70b9\uff0c\u9700\u8981\u5bb9\u5fcd\u8fd9\u4e2a\u6c61\u70b9\u624d\u53ef\u4ee5\u90e8\u7f72\n# \u8fd9\u91cc\u6211\u4eec\u5c06 traefik \u56fa\u5b9a\u5728 master \u8282\u70b9\ntolerations:   \n- key: \"node-role.kubernetes.io/master\"\n  operator: \"Equal\"\n  effect: \"NoSchedule\"\n\nnodeSelector: \n  kubernetes.io/hostname: \"docker-desktop\"\n</code></pre> <p>https://github.com/traefik/traefik-helm-chart/blob/43d63f418836d7aaac03cfca5b54f4287c8acf9c/traefik/values.yaml</p> <p>\u76f4\u63a5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u5b89\u88c5\uff1a</p> <pre><code>$ helm install traefik traefik/traefik -n kube-system -f traefik-values.yaml\nNAME: traefik\nLAST DEPLOYED: Tue Apr  6 14:37:54 2021\nNAMESPACE: kube-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u9ed8\u8ba4\u6ca1\u6709\u4e3a Traefik \u7684 Dashboard \u521b\u5efa IngressRoute \u5bf9\u8c61\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 port-forward \u6765\u4e34\u65f6\u8bbf\u95ee\u5373\u53ef\uff0c\u5f53\u7136\u9996\u5148\u9700\u8981\u4e3a Traefik Dashboard \u521b\u5efa\u4e00\u4e2a Service\uff1a</p> <p><code>traefik-dashboard-service.yaml</code></p> <pre><code># traefik-dashboard-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: traefik-dashboard\n  namespace: kube-system\n  labels:\n    app.kubernetes.io/instance: traefik\n    app.kubernetes.io/name: traefik-dashboard\nspec:\n  type: ClusterIP\n  ports:\n  - name: traefik\n    port: 9000\n    targetPort: traefik\n    protocol: TCP\n  selector:\n    app.kubernetes.io/instance: traefik\n    app.kubernetes.io/name: traefik\n</code></pre> <pre><code>$ kubectl get all -n kube-system | grep traefik\npod/traefik-79765f8cc6-rjqtc                 1/1     Running   0          144m\nservice/traefik-dashboard                                   ClusterIP   10.99.59.98      &lt;none&gt;        9000/TCP                       169m\ndeployment.apps/traefik   1/1     1            1           144m\nreplicaset.apps/traefik-79765f8cc6   1         1         1       144m\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\uff0c\u7136\u540e\u4f7f\u7528\u7aef\u53e3\u8f6c\u53d1\u6765\u8bbf\u95ee\uff1a</p> <pre><code>$ kubectl apply -f traefik-dashboard-service.yaml\n\n$ kubectl port-forward service/traefik-dashboard 9000:9000 -n kube-system\nForwarding from 127.0.0.1:9000 -&gt; 9000\nForwarding from [::1]:9000 -&gt; 9000\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u6d4f\u89c8\u5668 http://127.0.0.1:9000/dashboard/\uff08\u6ce8\u610f URL \u4e2d\u7684\u5c3e\u90e8\u659c\u6760\uff0c\u8fd9\u662f\u5fc5\u987b\u7684\uff09\u8bbf\u95ee Traefik Dashboard \u4e86\uff0c\u73b0\u5728\u5e94\u8be5\u53ef\u4ee5\u770b\u5230\u5728\u4eea\u8868\u677f\u7684 Features \u90e8\u5206\u542f\u7528\u4e86 Prometheus \u6307\u6807\u3002</p> <p></p> <p>\u6b64\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u8bbf\u95ee http://127.0.0.1:9000/metrics \u7aef\u70b9\u6765\u67e5\u770b Traefik \u63d0\u4f9b\u7684\u4e00\u4e9b metrics \u6307\u6807\uff1a</p> <p></p>"},{"location":"chap4/46Prometheus_traefik/#prometheus-stack","title":"\u90e8\u7f72 Prometheus Stack","text":"<pre><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\n\nhelm repo update\n</code></pre> <p>\u4e0a\u8ff0\u8d44\u6e90\u5e93\u63d0\u4f9b\u4e86\u8bb8\u591a Chart\uff0c\u8981\u67e5\u770b\u5b8c\u6574\u7684\u5217\u8868\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u641c\u7d22\u547d\u4ee4\uff1a</p> <pre><code>$ helm search repo prometheus-community\nNAME                                                    CHART VERSION   APP VERSION     DESCRIPTION                                       \nprometheus-community/alertmanager                       0.8.0           v0.21.0         The Alertmanager handles alerts sent by client ...\nprometheus-community/kube-prometheus-stack              14.5.0          0.46.0          kube-prometheus-stack collects Kubernetes manif...\nprometheus-community/prometheus                         13.6.0          2.24.0          Prometheus is a monitoring system and time seri...\nprometheus-community/prometheus-adapter                 2.12.1          v0.8.3          A Helm chart for k8s prometheus adapter           \nprometheus-community/prometheus-blackbox-exporter       4.10.2          0.18.0          Prometheus Blackbox Exporter                      \nprometheus-community/prometheus-cloudwatch-expo...      0.14.1          0.10.0          A Helm chart for prometheus cloudwatch-exporter   \nprometheus-community/prometheus-consul-exporter         0.4.0           0.4.0           A Helm chart for the Prometheus Consul Exporter   \nprometheus-community/prometheus-couchdb-exporter        0.2.0           1.0             A Helm chart to export the metrics from couchdb...\nprometheus-community/prometheus-druid-exporter          0.9.0           v0.8.0          Druid exporter to monitor druid metrics with Pr...\nprometheus-community/prometheus-elasticsearch-e...      4.4.0           1.1.0           Elasticsearch stats exporter for Prometheus       \nprometheus-community/prometheus-kafka-exporter          1.0.0           v1.2.0          A Helm chart to export the metrics from Kafka i...\nprometheus-community/prometheus-mongodb-exporter        2.8.1           v0.10.0         A Prometheus exporter for MongoDB metrics         \nprometheus-community/prometheus-mysql-exporter          1.1.0           v0.12.1         A Helm chart for prometheus mysql exporter with...\nprometheus-community/prometheus-nats-exporter           2.6.0           0.7.0           A Helm chart for prometheus-nats-exporter         \nprometheus-community/prometheus-node-exporter           1.16.2          1.1.2           A Helm chart for prometheus node-exporter         \nprometheus-community/prometheus-operator                9.3.2           0.38.1          DEPRECATED - This chart will be renamed. See ht...\nprometheus-community/prometheus-pingdom-exporter        2.3.2           20190610-1      A Helm chart for Prometheus Pingdom Exporter      \n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u5b89\u88c5\u7684\u662f kube-prometheus-stack \u8fd9\u4e2a Chart\uff0c\u5b83\u4f1a\u90e8\u7f72\u6240\u9700\u8981\u7684\u76f8\u5173\u7ec4\u4ef6\uff1a</p> <pre><code>$ helm install kube-prom prometheus-community/kube-prometheus-stack -n monitoring\n</code></pre> <p>Promethuse-operator 2021 \u5b89\u88c5</p>"},{"location":"chap4/46Prometheus_traefik/#2-traefik","title":"2 \u914d\u7f6e Traefik \u76d1\u63a7","text":"<p>Prometheus Operator \u63d0\u4f9b\u4e86 ServiceMonitor \u8fd9\u4e2a CRD \u6765\u914d\u7f6e\u76d1\u63a7\u6307\u6807\u7684\u91c7\u96c6\uff0c\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u5bf9\u8c61\uff1a</p> <p><code>traefik-service-monitor.yaml</code></p> <pre><code># traefik-service-monitor.yaml\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name:  traefik\n  namespace: default\n  labels:\n    app: traefik\n    release: prometheus-stack\nspec:\n  jobLabel: traefik-metrics\n  selector:\n    matchLabels:\n      app.kubernetes.io/instance: traefik\n      app.kubernetes.io/name: traefik-dashboard\n  namespaceSelector:\n    matchNames:\n    - kube-system\n  endpoints:\n  - port: traefik\n    path: /metrics\n</code></pre> <p>\u6839\u636e\u4e0a\u9762\u7684\u914d\u7f6e\uff0c<code>Prometheus</code> \u5c06\u83b7\u53d6 <code>traefik-dashboard</code> \u670d\u52a1\u7684 <code>/metrics</code> \u7aef\u70b9\u3002</p> <p>\u4e3b\u8981\u6ce8\u610f\u7684\u662f <code>traefik-dashboard</code> \u670d\u52a1\u662f\u5728 <code>kube-system</code> \u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u7684\uff0c\u800c <code>ServiceMonitor</code> \u5219\u90e8\u7f72\u5728\u9ed8\u8ba4\u7684 <code>default</code> \u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u6240\u4ee5\u8fd9\u91cc\u9762\u6211\u4eec\u4f7f\u7528\u4e86 <code>namespaceSelector</code> \u8fdb\u884c\u547d\u540d\u7a7a\u95f4\u5339\u914d\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u6765\u9a8c\u8bc1\u4e00\u4e0b Prometheus \u662f\u5426\u5df2\u7ecf\u5f00\u59cb\u6293\u53d6 Traefik \u7684\u6307\u6807\u4e86\u3002</p> <p></p>"},{"location":"chap4/46Prometheus_traefik/#3-traefik","title":"3 \u914d\u7f6e Traefik \u62a5\u8b66","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u8fd8\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a\u62a5\u8b66\u89c4\u5219\uff0c\u5f53\u6761\u4ef6\u5339\u914d\u7684\u65f6\u5019\u4f1a\u89e6\u53d1\u62a5\u8b66\uff0c\u540c\u6837 Prometheus Operator \u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u540d\u4e3a PrometheusRule \u7684 CRD \u5bf9\u8c61\u6765\u914d\u7f6e\u62a5\u8b66\u89c4\u5219\uff1a</p> <p>traefik-rules.yaml</p> <pre><code># traefik-rules.yaml\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  annotations:\n    meta.helm.sh/release-name: kube-prom\n    meta.helm.sh/release-namespace: monitoring\n  labels:\n    app: kube-prometheus-stack\n    release: kube-prom\n  name: traefik-alert-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: Traefik\n    rules:\n    - alert: TooManyRequest\n      expr: avg(traefik_entrypoint_open_connections{job=\"traefik-dashboard\",namespace=\"kube-system\"})\n        &gt; 5\n      for: 1m\n      labels:\n        severity: critical\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u89c4\u5219\uff1a\u5982\u679c1\u5206\u949f\u5185\u6709\u8d85\u8fc75\u4e2a <code>open connections</code> \u673a\u4f1a\u89e6\u53d1\u4e00\u4e2a <code>TooManyRequest</code> \u62a5\u8b66\uff0c\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f traefik-rules.yaml\n</code></pre> <p>\u6ce8\u610f\uff1a PrometheusRule\u7684annotations&amp;labels</p> <p>\u53ef\u4ee5\u501f\u9274\u5176\u5b83\u5df2\u7ecf\u8fd0\u884c\u7684rule</p> <p><code>kubectl get PrometheusRule kube-prom-kube-prometheus-prometheus-operator -n monitoring -oyaml</code></p> <pre><code>annotations:\n    meta.helm.sh/release-name: kube-prom\n    meta.helm.sh/release-namespace: monitoring\n  labels:\n    app: kube-prometheus-stack\n    release: kube-prom\n  name: traefik-alert-rules\n  namespace: monitoring\n</code></pre>"},{"location":"chap4/46Prometheus_traefik/#prometheusrule","title":"\u67e5\u770bPrometheusRule\u662f\u5426\u5b89\u88c5\u6210\u529f","text":"<pre><code>kubectl exec prometheus-kube-prom-kube-prometheus-prometheus-0 -n monitoring -it sh\n\ncd /etc/prometheus/rules/prometheus-kube-prom-kube-prometheus-prometheus-rulefiles-0\n\n$ ls -la\n\n...\nmonitoring-traefik-alert-rules.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6b63\u5e38\u5728 Promethues \u7684 Dashboard  \u4e0b\u7684 <code>Status &gt; Rules</code> \u9875\u9762\u5c31\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u62a5\u8b66\u89c4\u5219\uff1a</p> <p></p>"},{"location":"chap4/46Prometheus_traefik/#4-grafana","title":"4 Grafana \u914d\u7f6e","text":"<p>\u524d\u9762\u4f7f\u7528 kube-prometheus-stack \u8fd9\u4e2a Helm Chart \u90e8\u7f72\u7684\u65f6\u5019\u5c31\u5df2\u7ecf\u90e8\u7f72\u4e0a\u4e86 Grafana\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u4e3a Traefik \u7684\u76d1\u63a7\u6307\u6807\u914d\u7f6e\u4e00\u4e2a Dashboard\uff0c\u540c\u6837\u9996\u5148\u6211\u4eec\u4f7f\u7528\u7aef\u53e3\u8f6c\u53d1\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee Grafana\uff1a</p> <pre><code>kubectl port-forward svc/kube-prom-grafana 10080:80 -n monitoring\n</code></pre> <p>\u7136\u540e\u8bbf\u95ee <code>Grafana GUI\uff08http://localhost:10080</code>\uff09\u65f6\uff0c\u5b83\u4f1a\u8981\u6c42\u8f93\u5165\u767b\u5f55\u540d\u548c\u5bc6\u7801\uff0c\u9ed8\u8ba4\u7684\u767b\u5f55\u7528\u6237\u540d\u662f <code>admin</code>\uff0c\u5bc6\u7801\u662f <code>prom-operator</code>\uff0c\u5bc6\u7801\u53ef\u4ee5\u4ece\u540d\u4e3a <code>prometheus-operator-grafana</code> \u7684 Kubernetes Secret \u5bf9\u8c61\u4e2d\u83b7\u53d6\u3002</p> <p>\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u4e3a Traefik \u81ea\u5b9a\u4e49\u4e00\u4e2a Dashboard\uff0c\u4e5f\u53ef\u4ee5\u4ece Grafana \u7684\u5b98\u65b9\u793e\u533a\u4e2d\u5bfc\u5165\u4e00\u4e2a\u5408\u9002\u7684\u5373\u53ef\uff0c\u70b9\u51fb\u5de6\u4fa7\u5bfc\u822a\u680f\u4e0a\u7684\u56db\u65b9\u5f62\u56fe\u6807\uff0c\u5bfc\u822a\u5230 Dashboards &gt; Manage\uff0c\u5373\u53ef\u6dfb\u52a0\u4eea\u8868\u76d8\u3002</p> <p></p> <p>\u70b9\u51fb\u53f3\u4e0a\u89d2\u7684 Import \u6309\u94ae\uff0c\u8f93\u5165 <code>11462</code> \u4f5c\u4e3a Dashboard \u7684 ID\uff0c\u5bf9\u5e94\u7528\u6237 timoreymann \u8d21\u732e\u7684 Traefik 2 \u4eea\u8868\u76d8\u3002</p> <p></p> <p>\u70b9\u51fb Load \u540e\uff0c\u4f60\u5e94\u8be5\u770b\u5230\u5bfc\u5165\u7684\u4eea\u8868\u76d8\u7684\u76f8\u5173\u4fe1\u606f\u3002</p> <p></p> <p>\u5728\u6700\u4e0b\u9762\u6709\u4e00\u4e2a\u4e0b\u62c9\u83dc\u5355\uff0c\u9009\u62e9 Prometheus \u6570\u636e\u6e90\uff0c\u7136\u540e\u70b9\u51fb Import\uff0c\u5373\u53ef\u751f\u6210\u5982\u4e0b\u6240\u793a\u7684 Dashboard\u3002</p> <p></p>"},{"location":"chap4/46Prometheus_traefik/#5","title":"5 \u6d4b\u8bd5","text":"<p>\u73b0\u5728\uff0cTraefik \u5df2\u7ecf\u5f00\u59cb\u5de5\u4f5c\u4e86\uff0c\u5e76\u4e14\u6307\u6807\u4e5f\u88ab Prometheus \u548c Grafana \u83b7\u53d6\u5230\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u4f7f\u7528\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6765\u6d4b\u8bd5\u3002\u8fd9\u91cc\u6211\u4eec\u90e8\u7f72 HTTPBin \u670d\u52a1\uff0c\u5b83\u63d0\u4f9b\u4e86\u8bb8\u591a\u7aef\u70b9\uff0c\u53ef\u7528\u4e8e\u6a21\u62df\u4e0d\u540c\u7c7b\u578b\u7684\u7528\u6237\u6d41\u91cf\u3002\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># httpbin.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: httpbin\n  labels:\n    app: httpbin\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: httpbin\n  template:\n    metadata:\n      labels:\n        app: httpbin\n    spec:\n      containers:\n      - image: kennethreitz/httpbin\n        name: httpbin\n        ports:\n        - containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: httpbin\nspec:\n  ports:\n  - name: http\n    port: 8000\n    targetPort: 80\n  selector:\n    app: httpbin\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: httpbin\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`httpbin.local`)\n    kind: Rule\n    services:\n    - name: httpbin\n      port: 8000\n ```\n\n\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\uff1a\n\n</code></pre> <p>$ kubectl apply -f httpbin.yaml deployment.apps/httpbin created service/httpbin created ingressroute.traefik.containo.us/httpbin created</p> <pre><code>\nhttpbin \u8def\u7531\u4f1a\u5339\u914d `httpbin.local` \u7684\u4e3b\u673a\u540d\uff0c\u7136\u540e\u5c06\u8bf7\u6c42\u8f6c\u53d1\u7ed9 httpbin Service\uff1a\n\n</code></pre> <p>$ curl -I http://192.168.65.4  -H \"host:httpbin.local\" HTTP/1.1 200 OK Access-Control-Allow-Credentials: true Access-Control-Allow-Origin: * Content-Length: 9593 Content-Type: text/html; charset=utf-8 Date: Mon, 05 Apr 2021 05:43:16 GMT Server: gunicorn/19.9.0</p> <pre><code>\n\u6211\u4eec\u8fd9\u91cc\u90e8\u7f72\u7684 Traefik \u4f7f\u7528\u7684\u662f hostPort \u6a21\u5f0f\uff0c\u56fa\u5b9a\u5230 master \u8282\u70b9\u4e0a\u9762\u7684\uff0c\u8fd9\u91cc\u7684 IP \u5730\u5740 192.168.65.4 \u5c31\u662f master \u8282\u70b9\u7684 IP \u5730\u5740\u3002\n\n\u63a5\u4e0b\u6765\u6211\u4eec\u4f7f\u7528 ab \u6765\u8bbf\u95ee HTTPBin \u670d\u52a1\u6a21\u62df\u4e00\u4e9b\u6d41\u91cf\uff0c\u8fd9\u4e9b\u8bf7\u6c42\u4f1a\u4ea7\u751f\u5bf9\u5e94\u7684\u6307\u6807\uff0c\u6267\u884c\u4ee5\u4e0b\u811a\u672c\uff1a\n\n</code></pre> <p>$ ab -c 5 -n 10000  -m PATCH -H \"host:httpbin.local\" -H \"accept: application/json\" http://192.168.31.75/patch $ ab -c 5 -n 10000  -m GET -H \"host:httpbin.local\" -H \"accept: application/json\" http://192.168.31.75/get $ ab -c 5 -n 10000  -m POST -H \"host:httpbin.local\" -H \"accept: application/json\" http://192.168.31.75/post</p> <pre><code>\u6b63\u5e38\u4e00\u6bb5\u65f6\u95f4\u540e\u518d\u53bb\u67e5\u770b Grafana \u7684 Dashboard \u53ef\u4ee5\u770b\u5230\u663e\u793a\u4e86\u66f4\u591a\u7684\u4fe1\u606f\uff1a\n\n\u5305\u62ec\uff1a\u6b63\u5e38\u8fd0\u884c\u7684\u65f6\u95f4\u3001\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\u3001\u8bf7\u6c42\u603b\u6570\u3001\u57fa\u4e8e HTTP \u65b9\u6cd5\u548c\u670d\u52a1\u7684\u8bf7\u6c42\u8ba1\u6570\u7b49\u3002\n\n![Alt Image Text](../images/46_10.png \"Body image\")\n\n\n\u6700\u540e\uff0c\u5f53\u6211\u4eec\u6d4b\u8bd5\u5e94\u7528\u6d41\u91cf\u65f6\uff0c`Prometheus` \u53ef\u80fd\u4f1a\u89e6\u53d1\u62a5\u8b66\uff0c\u4e4b\u524d\u521b\u5efa\u7684 `TooManyRequest` \u62a5\u8b66\u5c06\u663e\u793a\u5728 Alertmanager \u4eea\u8868\u677f\u4e0a\uff0c\u7136\u540e\u53ef\u4ee5\u81ea\u5df1\u6839\u636e\u9700\u8981\u914d\u7f6e\u63a5\u6536\u62a5\u8b66\u4fe1\u606f\u7684 Receiver \u5373\u53ef\u3002\n\n</code></pre> <p>$ kubectl port-forward service/prometheus-stack-kube-prom-alertmanager 9093:9093 Forwarding from 127.0.0.1:9093 -&gt; 9093 ```</p> <p></p>"},{"location":"chap4/46Prometheus_traefik/#6","title":"6 \u603b\u7ed3","text":"<p>\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u770b\u5230\u4e86\u5c06 Traefik \u8fde\u63a5\u5230 Prometheus \u548c Grafana \u4ee5\u4ece Traefik \u6307\u6807\u4e2d\u521b\u5efa\u53ef\u89c6\u5316\u7684\u8fc7\u7a0b\u662f\u975e\u5e38\u7b80\u5355\u7684\u3002\u5f53\u719f\u6089\u8fd9\u4e9b\u5de5\u5177\u540e\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u9700\u6c42\u521b\u5efa\u4e00\u4e9b Dashboard\uff0c\u66b4\u9732\u4f60\u7684\u73af\u5883\u7684\u4e00\u4e9b\u5173\u952e\u6570\u636e\u3002</p>"},{"location":"chap4/47Prometheus_opt_AlertmanagerConfig/","title":"\u7b2c\u5341\u4e00\u8282 Operator\u4f7f\u7528AlertmanagerConfig\u8fdb\u884c\u62a5\u8b66\u914d\u7f6e","text":"<p>Prometheus Dashboard \u7684 Alert \u9875\u9762\u4e0b\u9762\u5c31\u5df2\u7ecf\u6709\u5f88\u591a\u62a5\u8b66\u89c4\u5219\u4e86\uff0c\u8fd9\u4e00\u7cfb\u5217\u7684\u89c4\u5219\u5176\u5b9e\u90fd\u6765\u81ea\u4e8e\u9879\u76ee https://github.com/kubernetes-monitoring/kubernetes-mixin\uff0c\u6211\u4eec\u90fd\u901a\u8fc7 Prometheus Operator \u5b89\u88c5\u914d\u7f6e\u4e0a\u4e86\u3002</p>"},{"location":"chap4/47Prometheus_opt_AlertmanagerConfig/#1-prometheusrule","title":"1 \u914d\u7f6e PrometheusRule","text":"<p>\u4f46\u662f\u8fd9\u4e9b\u62a5\u8b66\u4fe1\u606f\u662f\u54ea\u91cc\u6765\u7684\u5462\uff1f\u4ed6\u4eec\u5e94\u8be5\u7528\u600e\u6837\u7684\u65b9\u5f0f\u901a\u77e5\u6211\u4eec\u5462\uff1f</p> <p>\u6211\u4eec\u77e5\u9053\u4e4b\u524d\u6211\u4eec\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u53ef\u4ee5\u5728 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\u4e4b\u4e2d\u6307\u5b9a AlertManager \u5b9e\u4f8b\u548c \u62a5\u8b66\u7684 rules \u6587\u4ef6\uff0c\u73b0\u5728\u6211\u4eec\u901a\u8fc7 Operator \u90e8\u7f72\u7684\u5462\uff1f</p> <p>\u6211\u4eec\u53ef\u4ee5\u5728 Prometheus Dashboard \u7684 Config \u9875\u9762\u4e0b\u9762\u67e5\u770b\u5173\u4e8e AlertManager \u7684\u914d\u7f6e\uff1a</p> <pre><code>alerting:\n  alert_relabel_configs:\n    - separator: ;\n      regex: prometheus_replica\n      replacement: $1\n      action: labeldrop\n  alertmanagers:\n    - kubernetes_sd_configs:\n        - role: endpoints\n          namespaces:\n            names:\n              - monitoring\n      scheme: http\n      path_prefix: /\n      timeout: 10s\n      api_version: v1\n      relabel_configs:\n        - source_labels: [__meta_kubernetes_service_name]\n          separator: ;\n          regex: alertmanager-main\n          replacement: $1\n          action: keep\n        - source_labels: [__meta_kubernetes_endpoint_port_name]\n          separator: ;\n          regex: web\n          replacement: $1\n          action: keep\nrule_files:\n  - /etc/prometheus/rules/prometheus-k8s-rulefiles-0/*.yaml\n</code></pre> <p>\u4e0a\u9762 alertmanagers \u7684\u914d\u7f6e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u662f\u901a\u8fc7 role \u4e3a endpoints \u7684 kubernetes \u7684\u81ea\u52a8\u53d1\u73b0\u673a\u5236\u83b7\u53d6\u7684\uff0c\u5339\u914d\u7684\u662f\u670d\u52a1\u540d\u4e3a <code>alertmanager-main</code>\uff0c\u7aef\u53e3\u540d\u4e3a <code>web</code> \u7684 <code>Service</code> \u670d\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b <code>alertmanager-main</code> \u8fd9\u4e2a<code>Service</code>\uff1a</p> <pre><code>$ kubectl describe svc alertmanager-main -n monitoring\nName:                     alertmanager-main\nNamespace:                monitoring\nLabels:                   alertmanager=main\nAnnotations:              kubectl.kubernetes.io/last-applied-configuration:\n                            {\"apiVersion\":\"v1\",\"kind\":\"Service\",\"metadata\":{\"annotations\":{},\"labels\":{\"alertmanager\":\"main\"},\"name\":\"alertmanager-main\",\"namespace\":\"...\nSelector:                 alertmanager=main,app=alertmanager\nType:                     NodePort\nIP:                       10.106.211.33\nPort:                     web  9093/TCP\nTargetPort:               web/TCP\nNodePort:                 web  31742/TCP\nEndpoints:                10.244.3.119:9093,10.244.4.112:9093,10.244.8.164:9093\nSession Affinity:         ClientIP\nExternal Traffic Policy:  Cluster\nEvents:                   &lt;none&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u670d\u52a1\u540d\u6b63\u662f<code>alertmanager-main</code>\uff0cPort \u5b9a\u4e49\u7684\u540d\u79f0\u4e5f\u662f <code>web</code>\uff0c\u7b26\u5408\u4e0a\u9762\u7684\u89c4\u5219\uff0c\u6240\u4ee5 Prometheus \u548c AlertManager \u7ec4\u4ef6\u5c31\u6b63\u786e\u5173\u8054\u4e0a\u4e86\u3002</p> <p>\u800c\u5bf9\u5e94\u7684\u62a5\u8b66\u89c4\u5219\u6587\u4ef6\u4f4d\u4e8e\uff1a<code>/etc/prometheus/rules/prometheus-k8s-rulefiles-0/</code>\u76ee\u5f55\u4e0b\u9762\u6240\u6709\u7684 YAML \u6587\u4ef6\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165<code>Prometheus</code> \u7684 <code>Pod</code> \u4e2d\u9a8c\u8bc1\u4e0b\u8be5\u76ee\u5f55\u4e0b\u9762\u662f\u5426\u6709 <code>YAML</code>\u6587\u4ef6\uff1a</p> <pre><code>$ kubectl exec -it prometheus-k8s-0 /bin/sh -n monitoring\nDefaulting container name to prometheus.\nUse 'kubectl describe pod/prometheus-k8s-0 -n monitoring' to see all of the containers in this pod.\n/prometheus $ ls /etc/prometheus/rules/prometheus-k8s-rulefiles-0/\nmonitoring-prometheus-k8s-rules.yaml\n/prometheus $ cat /etc/prometheus/rules/prometheus-k8s-rulefiles-0/monitoring-pr\nometheus-k8s-rules.yaml\ngroups:\n- name: k8s.rules\n  rules:\n  - expr: |\n      sum(rate(container_cpu_usage_seconds_total{job=\"kubelet\", image!=\"\", container_name!=\"\"}[5m])) by (namespace)\n    record: namespace:container_cpu_usage_seconds_total:sum_rate\n......\n</code></pre> <p>\u8fd9\u4e2a YAML \u6587\u4ef6\u5b9e\u9645\u4e0a\u5c31\u662f\u6211\u4eec\u4e4b\u524d\u521b\u5efa\u7684\u4e00\u4e2a <code>PrometheusRule</code> \u6587\u4ef6\u5305\u542b\u7684\u5185\u5bb9\uff1a</p> <pre><code>$ cat prometheus-rules.yaml\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: prometheus-k8s-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: node-exporter.rules\n    rules:\n    - expr: |\n        count without (cpu) (\n          count without (mode) (\n            node_cpu_seconds_total{job=\"node-exporter\"}\n          )\n        )\n      record: instance:node_num_cpu:sum\n    - expr: |\n......\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u7684 <code>PrometheusRule</code> \u7684 <code>name</code> \u4e3a <code>prometheus-k8s-rules</code>\uff0cnamespace \u4e3a monitoring\uff0c\u6211\u4eec\u53ef\u4ee5\u731c\u60f3\u5230\u6211\u4eec\u521b\u5efa\u4e00\u4e2a <code>PrometheusRule</code> \u8d44\u6e90\u5bf9\u8c61\u540e\uff0c\u4f1a\u81ea\u52a8\u5728\u4e0a\u9762\u7684 prometheus-k8s-rulefiles-0 \u76ee\u5f55\u4e0b\u9762\u751f\u6210\u4e00\u4e2a\u5bf9\u5e94\u7684 <code>&lt;namespace&gt;-&lt;name&gt;.yaml</code>\u6587\u4ef6\uff0c\u6240\u4ee5\u5982\u679c\u4ee5\u540e\u6211\u4eec\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e2a\u62a5\u8b66\u9009\u9879\u7684\u8bdd\uff0c\u53ea\u9700\u8981\u5b9a\u4e49\u4e00\u4e2a PrometheusRule \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\u3002</p> <p>\u81f3\u4e8e\u4e3a\u4ec0\u4e48 Prometheus \u80fd\u591f\u8bc6\u522b\u8fd9\u4e2a PrometheusRule \u8d44\u6e90\u5bf9\u8c61\u5462\uff1f\u8fd9\u5c31\u9700\u8981\u67e5\u770b\u6211\u4eec\u521b\u5efa\u7684 <code>prometheus</code>\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u4e86\uff0c\u91cc\u9762\u6709\u975e\u5e38\u91cd\u8981\u7684\u4e00\u4e2a\u5c5e\u6027 ruleSelector\uff0c\u7528\u6765\u5339\u914d rule \u89c4\u5219\u7684\u8fc7\u6ee4\u5668\uff0c\u8981\u6c42\u5339\u914d\u5177\u6709 <code>prometheus=k8s</code> \u548c <code>role=alert-rules</code> \u6807\u7b7e\u7684 <code>PrometheusRule</code> \u8d44\u6e90\u5bf9\u8c61\uff0c\u73b0\u5728\u660e\u767d\u4e86\u5427\uff1f</p> <pre><code>ruleSelector:\n  matchLabels:\n    prometheus: k8s\n    role: alert-rules\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u8981\u60f3\u81ea\u5b9a\u4e49\u4e00\u4e2a\u62a5\u8b66\u89c4\u5219\uff0c\u53ea\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5177\u6709 <code>prometheus=k8s</code>\u548c <code>role=alert-rules</code> \u6807\u7b7e\u7684 PrometheusRule \u5bf9\u8c61\u5c31\u884c\u4e86\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a <code>etcd</code>\u662f\u5426\u53ef\u7528\u7684\u62a5\u8b66\uff0c\u6211\u4eec\u77e5\u9053 etcd \u6574\u4e2a\u96c6\u7fa4\u6709\u4e00\u534a\u4ee5\u4e0a\u7684\u8282\u70b9\u53ef\u7528\u7684\u8bdd\u96c6\u7fa4\u5c31\u662f\u53ef\u7528\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5224\u65ad\u5982\u679c\u4e0d\u53ef\u7528\u7684 etcd \u6570\u91cf\u8d85\u8fc7\u4e86\u4e00\u534a\u90a3\u4e48\u5c31\u89e6\u53d1\u62a5\u8b66\uff0c\u521b\u5efa\u6587\u4ef6 <code>prometheus-etcdRules.yaml</code>\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: etcd-rules\n  namespace: monitoring\nspec:\n  groups:\n    - name: etcd\n      rules:\n        - alert: EtcdClusterUnavailable\n          annotations:\n            summary: etcd cluster small\n            description: If one more etcd peer goes down the cluster will be unavailable\n          expr: |\n            count(up{job=\"etcd\"} == 0) &gt; (count(up{job=\"etcd\"}) / 2 - 1)\n          for: 3m\n          labels:\n            severity: critical\n</code></pre> <p>\u6ce8\u610f label \u6807\u7b7e\u4e00\u5b9a\u81f3\u5c11\u8981\u6709 <code>prometheus=k8s</code> \u548c <code>role=alert-rules</code>\uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u9694\u4e00\u4f1a\u513f\u518d\u53bb\u5bb9\u5668\u4e2d\u67e5\u770b\u4e0b rules \u6587\u4ef6\u5939\uff1a</p> <pre><code>$ kubectl apply -f prometheus-etcdRules.yaml\nprometheusrule.monitoring.coreos.com/etcd-rules created\n$ kubectl exec -it prometheus-k8s-0 /bin/sh -n monitoring\nDefaulting container name to prometheus.\nUse 'kubectl describe pod/prometheus-k8s-0 -n monitoring' to see all of the containers in this pod.\n/prometheus $ ls /etc/prometheus/rules/prometheus-k8s-rulefiles-0/\nmonitoring-etcd-rules.yaml            monitoring-prometheus-k8s-rules.yaml\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u521b\u5efa\u7684 rule \u6587\u4ef6\u5df2\u7ecf\u88ab\u6ce8\u5165\u5230\u4e86\u5bf9\u5e94\u7684 rulefiles \u6587\u4ef6\u5939\u4e0b\u9762\u4e86\uff0c\u8bc1\u660e\u6211\u4eec\u4e0a\u9762\u7684\u8bbe\u60f3\u662f\u6b63\u786e\u7684\u3002\u7136\u540e\u518d\u53bb <code>Prometheus Dashboard</code> \u7684 Alert \u9875\u9762\u4e0b\u9762\u5c31\u53ef\u4ee5\u67e5\u770b\u5230\u4e0a\u9762\u6211\u4eec\u65b0\u5efa\u7684\u62a5\u8b66\u89c4\u5219\u4e86\uff1a</p> <p></p>"},{"location":"chap4/47Prometheus_opt_AlertmanagerConfig/#2","title":"2 \u914d\u7f6e\u62a5\u8b66","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86\u5982\u4f55\u53bb\u6dfb\u52a0\u4e00\u4e2a\u62a5\u8b66\u89c4\u5219\u914d\u7f6e\u9879\uff0c\u4f46\u662f\u8fd9\u4e9b\u62a5\u8b66\u4fe1\u606f\u7528\u600e\u6837\u7684\u65b9\u5f0f\u53bb\u53d1\u9001\u5462\uff1f\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u77e5\u9053\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 AlertManager \u7684\u914d\u7f6e\u6587\u4ef6\u53bb\u914d\u7f6e\u5404\u79cd\u62a5\u8b66\u63a5\u6536\u5668\uff0c\u73b0\u5728\u6211\u4eec\u662f\u901a\u8fc7 Operator \u63d0\u4f9b\u7684 alertmanager \u8d44\u6e90\u5bf9\u8c61\u521b\u5efa\u7684\u7ec4\u4ef6\uff0c\u5e94\u8be5\u600e\u6837\u53bb\u4fee\u6539\u914d\u7f6e\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u53bb Alertmanager \u7684\u9875\u9762\u4e0a status \u8def\u5f84\u4e0b\u9762\u67e5\u770b AlertManager \u7684\u914d\u7f6e\u4fe1\u606f:</p> <p></p> <p>\u8fd9\u4e9b\u914d\u7f6e\u4fe1\u606f\u5b9e\u9645\u4e0a\u662f\u6765\u81ea\u4e8e <code>Prometheus-Operator</code> \u81ea\u52a8\u521b\u5efa\u7684\u540d\u4e3a <code>alertmanager-main-generated</code> \u7684 Secret \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get secret alertmanager-main-generated -n monitoring -o json | jq -r '.data.\"alertmanager.yaml\"' | base64 --decode\n\"global\":\n  \"resolve_timeout\": \"5m\"\n\"inhibit_rules\":\n- \"equal\":\n  - \"namespace\"\n  - \"alertname\"\n  \"source_match\":\n    \"severity\": \"critical\"\n  \"target_match_re\":\n    \"severity\": \"warning|info\"\n- \"equal\":\n  - \"namespace\"\n  - \"alertname\"\n  \"source_match\":\n    \"severity\": \"warning\"\n  \"target_match_re\":\n    \"severity\": \"info\"\n\"receivers\":\n- \"name\": \"Default\"\n- \"name\": \"Watchdog\"\n- \"name\": \"Critical\"\n\"route\":\n  \"group_by\":\n  - \"namespace\"\n  \"group_interval\": \"5m\"\n  \"group_wait\": \"30s\"\n  \"receiver\": \"Default\"\n  \"repeat_interval\": \"12h\"\n  \"routes\":\n  - \"match\":\n      \"alertname\": \"Watchdog\"\n    \"receiver\": \"Watchdog\"\n  - \"match\":\n      \"severity\": \"critical\"\n    \"receiver\": \"Critical\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5185\u5bb9\u548c\u4e0a\u9762\u67e5\u770b\u7684\u914d\u7f6e\u4fe1\u606f\u662f\u4e00\u81f4\u7684\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u60f3\u8981\u6dfb\u52a0\u81ea\u5df1\u7684\u63a5\u6536\u5668\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u66f4\u6539\u8fd9\u4e2a\u6587\u4ef6\uff0c\u4f46\u662f\u8fd9\u91cc\u7684\u5185\u5bb9\u662f base64 \u7f16\u7801\u8fc7\u540e\u7684\uff0c\u5982\u679c\u624b\u52a8\u6dfb\u52a0\u5185\u5bb9\u5c31\u975e\u5e38\u4e0d\u65b9\u4fbf\u3002</p>"},{"location":"chap4/47Prometheus_opt_AlertmanagerConfig/#3-alertmanagerconfig","title":"3 AlertmanagerConfig","text":"<p>\u4e3a\u6b64 Prometheus-Operator \u65b0\u589e\u4e86\u4e00\u4e2a <code>AlertmanagerConfig</code> \u7684 CRD\uff0c\u6bd4\u5982\u6211\u4eec\u5c06 <code>Critical</code> \u8fd9\u4e2a\u63a5\u6536\u5668\u7684\u62a5\u8b66\u4fe1\u606f\u90fd\u53d1\u9001\u5230\u9489\u9489\u8fdb\u884c\u62a5\u8b66\u3002</p> <p>\u9996\u5148\u5728 monitoring \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u90e8\u7f72\u4e00\u4e2a\u7b80\u5355\u7684\u9489\u9489 webhook \u5904\u7406\u5668\uff0c\u524d\u9762 Alertmanager \u7ae0\u8282\u5df2\u7ecf\u5b66\u4e60\u8fc7\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8d58\u8ff0\u4e86\u3002</p> <p>\u7136\u540e\u65b0\u5efa\u4e00\u4e2a <code>AlertmanagerConfig</code> \u7c7b\u578b\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>kubectl explain alertmanagerconfig</code> \u6216\u8005\u5728\u7ebf API \u6587\u6863(https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/user-guides/alerting.md)\u6765\u67e5\u770b\u5b57\u6bb5\u7684\u542b\u4e49</p> <pre><code># alertmanager-config.yaml\napiVersion: monitoring.coreos.com/v1alpha1\nkind: AlertmanagerConfig\nmetadata:\n  name: dinghook\n  namespace: monitoring\n  labels:\n    alertmanagerConfig: example\nspec:\n  receivers:\n    - name: Critical\n      webhookConfigs:\n        - url: http://dingtalk-hook:5000\n          sendResolved: true\n  route:\n    groupBy: [\"namespace\"]\n    groupWait: 30s\n    groupInterval: 5m\n    repeatInterval: 12h\n    receiver: Critical\n    routes:\n      - receiver: Critical\n        match:\n          severity: critical\n</code></pre> <p>\u4e0d\u8fc7\u5982\u679c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u914d\u7f6e\u662f\u4e0d\u4f1a\u751f\u6548\u7684\uff0c\u6211\u4eec\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a Label \u6807\u7b7e\uff0c\u5e76\u5728 Alertmanager \u7684\u8d44\u6e90\u5bf9\u8c61\u4e2d\u901a\u8fc7\u6807\u7b7e\u6765\u5173\u8054\u4e0a\u9762\u7684\u8fd9\u4e2a\u5bf9\u8c61\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u65b0\u589e\u4e86\u4e00\u4e2a Label \u6807\u7b7e\uff1a<code>alertmanagerConfig: example</code>\uff0c\u7136\u540e\u9700\u8981\u91cd\u65b0\u66f4\u65b0 Alertmanager \u5bf9\u8c61\uff0c\u6dfb\u52a0 <code>alertmanagerConfigSelector</code> \u5c5e\u6027\u53bb\u5339\u914d <code>AlertmanagerConfig</code> \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code># alertmanager-alertmanager.yaml\napiVersion: monitoring.coreos.com/v1\nkind: Alertmanager\nmetadata:\n  labels:\n    alertmanager: main\n  name: main\n  namespace: monitoring\nspec:\n  image: quay.io/prometheus/alertmanager:v0.21.0\n  nodeSelector:\n    kubernetes.io/os: linux\n  replicas: 3\n  securityContext:\n    fsGroup: 2000\n    runAsNonRoot: true\n    runAsUser: 1000\n  serviceAccountName: alertmanager-main\n  version: v0.21.0\n  configSecret:\n  alertmanagerConfigSelector: # \u5339\u914d AlertmanagerConfig \u7684\u6807\u7b7e\n    matchLabels:\n      alertmanagerConfig: example\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u66f4\u65b0\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>kubectl apply -f alertmanager-config.yaml\nkubectl apply -f alertmanager-alertmanager.yaml\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\u540e\u9ed8\u8ba4\u7684\u914d\u7f6e\u4f1a\u548c\u6211\u4eec\u521b\u5efa\u7684\u914d\u7f6e\u8fdb\u884c\u5408\u5e76\uff0c\u6211\u4eec\u53ef\u4ee5\u91cd\u65b0\u67e5\u770b\u751f\u6210\u7684 Secret \u8d44\u6e90\u5bf9\u8c61\u5185\u5bb9\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b Alertmanager \u7684 WEB UI \u754c\u9762\u7684\u914d\u7f6e\u5185\u5bb9\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u5728 <code>AlertmanagerConfig</code> \u91cc\u9762\u5b9a\u4e49\u7684\u540d\u4e3a <code>Critical</code> \u7684 Receiver\uff0c\u5728\u6700\u7ec8\u751f\u6210\u7684\u914d\u7f6e\u4e2d\u540d\u79f0\u4e86<code>monitoring-dinghook-Critical</code>\uff0c\u683c\u5f0f\u4e3a <code>&lt;namespace&gt;-&lt;name&gt;-&lt;receiver name&gt;</code>\u3002</p>"},{"location":"chap4/49Prometheus_SLI_SLO/","title":"\u7b2c\u5341\u4e8c\u8282 \u901a\u8fc7Prometheus\u6765\u505aSLI/SLO\u76d1\u63a7\u5c55\u793a","text":"<p>Service level operator\u6709\u70b9\u610f\u601d\uff0c\u628a\u670d\u52a1SLI/SLO\u62bd\u8c61\u6210operator\u7684\u60f3\u6cd5\u5c31\u5f88\u8fd0\u7ef4</p>"},{"location":"chap4/49Prometheus_SLI_SLO/#1-slislo","title":"1 \u4ec0\u4e48\u662fSLI/SLO","text":"<ul> <li> <p>SLI\uff0c\u5168\u540dService Level Indicator\uff0c\u662f\u670d\u52a1\u7b49\u7ea7\u6307\u6807\u7684\u7b80\u79f0\uff0c\u5b83\u662f\u8861\u5b9a\u7cfb\u7edf\u7a33\u5b9a\u6027\u7684\u6307\u6807\u3002</p> </li> <li> <p>SLO\uff0c\u5168\u540dSevice Level Objective\uff0c\u662f\u670d\u52a1\u7b49\u7ea7\u76ee\u6807\u7684\u7b80\u79f0\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u8bbe\u5b9a\u7684\u7a33\u5b9a\u6027\u76ee\u6807\uff0c\u6bd4\u5982\"4\u4e2a9\"\uff0c\"5\u4e2a9\"\u7b49\u3002 <p>SRE\u901a\u5e38\u901a\u8fc7\u8fd9\u4e24\u4e2a\u6307\u6807\u6765\u8861\u91cf\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\uff0c\u5176\u4e3b\u8981\u601d\u8def\u5c31\u662f\u901a\u8fc7SLI\u6765\u5224\u65adSLO\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7\u4e00\u7cfb\u5217\u7684\u6307\u6807\u6765\u8861\u91cf\u6211\u4eec\u7684\u76ee\u6807\u662f\u5426\u8fbe\u5230\u4e86\"\u51e0\u4e2a9\"\u3002</p>"},{"location":"chap4/49Prometheus_SLI_SLO/#2-sli","title":"2 \u5982\u4f55\u9009\u62e9SLI","text":"<p>\u5728\u7cfb\u7edf\u4e2d\uff0c\u5e38\u89c1\u7684\u6307\u6807\u6709\u5f88\u591a\u79cd\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u7cfb\u7edf\u5c42\u9762\uff1aCPU\u4f7f\u7528\u7387\u3001\u5185\u5b58\u4f7f\u7528\u7387\u3001\u78c1\u76d8\u4f7f\u7528\u7387\u7b49</li> <li>\u5e94\u7528\u670d\u52a1\u5668\u5c42\u9762\uff1a\u7aef\u53e3\u5b58\u6d3b\u72b6\u6001\u3001JVM\u7684\u72b6\u6001\u7b49</li> <li>\u5e94\u7528\u8fd0\u884c\u5c42\u9762\uff1a\u72b6\u6001\u7801\u3001\u65f6\u5ef6\u3001QPS\u7b49</li> <li>\u4e2d\u95f4\u4ef6\u5c42\u9762\uff1aQPS\u3001TPS\u3001\u65f6\u5ef6\u7b49</li> <li>\u4e1a\u52a1\u5c42\u9762\uff1a\u6210\u529f\u7387\u3001\u589e\u957f\u901f\u5ea6\u7b49</li> </ul> <p>\u8fd9\u4e48\u591a\u6307\u6807\uff0c\u5e94\u8be5\u5982\u4f55\u9009\u62e9\u5462\uff1f\u53ea\u8981\u9075\u4ece\u4e24\u4e2a\u539f\u5219\u5c31\u53ef\u4ee5\uff1a</p> <ul> <li>\u9009\u62e9\u80fd\u591f\u6807\u8bc6\u4e00\u4e2a\u4e3b\u4f53\u662f\u5426\u7a33\u5b9a\u7684\u6307\u6807\uff0c\u5982\u679c\u4e0d\u662f\u8fd9\u4e2a\u4e3b\u4f53\u672c\u8eab\u7684\u6307\u6807\uff0c\u6216\u8005\u4e0d\u80fd\u6807\u8bc6\u4e3b\u4f53\u7a33\u5b9a\u6027\u7684\uff0c\u5c31\u8981\u6392\u9664\u5728\u5916\u3002</li> <li>\u4f18\u5148\u9009\u62e9\u4e0e\u7528\u6237\u4f53\u9a8c\u5f3a\u76f8\u5173\u6216\u7528\u6237\u53ef\u4ee5\u660e\u663e\u611f\u77e5\u7684\u6307\u6807\u3002</li> </ul> <p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8c37\u6b4c\u7684VALET\u6307\u6807\u65b9\u6cd5\u3002</p> <ul> <li>V\uff1aVolume\uff0c\u5bb9\u91cf\uff0c\u670d\u52a1\u627f\u8bfa\u7684\u6700\u5927\u5bb9\u91cf</li> <li>A\uff1aAvailability\uff0c\u53ef\u7528\u6027\uff0c\u670d\u52a1\u662f\u5426\u6b63\u5e38</li> <li>L\uff1aLatency\uff0c\u5ef6\u8fdf\uff0c\u670d\u52a1\u7684\u54cd\u5e94\u65f6\u95f4</li> <li>E\uff1aError\uff0c\u9519\u8bef\u7387\uff0c\u8bf7\u6c42\u9519\u8bef\u7387\u662f\u591a\u5c11</li> <li>T\uff1aTicket\uff0c\u4eba\u5de5\u4ecb\u5165\uff0c\u662f\u5426\u9700\u8981\u4eba\u5de5\u4ecb\u5165</li> </ul> <p>\u8fd9\u5c31\u662f\u8c37\u6b4c\u4f7f\u7528VALET\u65b9\u6cd5\u7ed9\u7684\u6837\u4f8b\u3002</p> <p></p> <p>\u4e0a\u9762\u4ec5\u4ec5\u662f\u7b80\u5355\u7684\u4ecb\u7ecd\u4e86\u4e00\u4e0bSLI/SLO\uff0c\u66f4\u591a\u7684\u77e5\u8bc6\u53ef\u4ee5\u5b66\u4e60\u300aSRE\uff1aGoogle\u8fd0\u7ef4\u89e3\u5bc6\u300b\u548c\u8d75\u6210\u8001\u5e08\u7684\u6781\u5ba2\u65f6\u95f4\u8bfe\u7a0b\u300aSRE\u5b9e\u8df5\u624b\u518c\u300b\u3002\u4e0b\u9762\u6765\u7b80\u5355\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528Prometheus\u6765\u8fdb\u884cSLI/SLO\u76d1\u63a7\u3002</p>"},{"location":"chap4/49Prometheus_SLI_SLO/#service-level-operator","title":"service-level-operator","text":"<p>Service level operator\u662f\u4e3a\u4e86Kubernetes\u4e2d\u7684\u5e94\u7528SLI/SLO\u6307\u6807\u6765\u8861\u91cf\u5e94\u7528\u7684\u670d\u52a1\u6307\u6807\uff0c\u5e76\u53ef\u4ee5\u901a\u8fc7Grafana\u6765\u8fdb\u884c\u5c55\u793a\u3002</p> <p>Operator\u4e3b\u8981\u662f\u901a\u8fc7SLO\u6765\u67e5\u770b\u548c\u521b\u5efa\u65b0\u7684\u6307\u6807\u3002\u4f8b\u5982\uff1a</p> <p>https://github.com/spotahome/service-level-operator</p> <pre><code>\napiVersion: monitoring.spotahome.com/v1alpha1\nkind: ServiceLevel\nmetadata:\n  name: awesome-service\nspec:\n  serviceLevelObjectives:\n    - name: \"9999_http_request_lt_500\"\n      description: 99.99% of requests must be served with &lt;500 status code.\n      disable: false\n      availabilityObjectivePercent: 99.99\n      serviceLevelIndicator:\n        prometheus:\n          address: http://myprometheus:9090\n          totalQuery: sum(increase(http_request_total{host=\"awesome_service_io\"}[2m]))\n          errorQuery: sum(increase(http_request_total{host=\"awesome_service_io\", code=~\"5..\"}[2m]))\n      output:\n        prometheus:\n          labels:\n            team: a-team\n            iteration: \"3\"\n</code></pre> <ul> <li>availabilityObjectivePercent\uff1aSLO</li> <li>totalQuery\uff1a\u603b\u8bf7\u6c42\u6570</li> <li>errorQuery\uff1a\u9519\u8bef\u8bf7\u6c42\u6570</li> </ul> <p>Operator\u901a\u8fc7totalQuert\u548cerrorQuery\u5c31\u53ef\u4ee5\u8ba1\u7b97\u51faSLO\u7684\u6307\u6807\u4e86\u3002</p>"},{"location":"chap4/49Prometheus_SLI_SLO/#3-service-level-operator","title":"3 \u90e8\u7f72service-level-operator","text":"<p>\u524d\u63d0\uff1a\u5728Kubernetes\u96c6\u7fa4\u4e2d\u90e8\u7f72\u597dPrometheus\uff0c\u6211\u8fd9\u91cc\u662f\u91c7\u7528Prometheus-Operator\u65b9\u5f0f\u8fdb\u884c\u90e8\u7f72\u7684\u3002</p> <p>\u9996\u5148\u521b\u5efaRBAC</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: service-level-operator\n  namespace: monitoring\n  labels:\n    app: service-level-operator\n    component: app\n\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: service-level-operator\n  labels:\n    app: service-level-operator\n    component: app\nrules:\n  # Register and check CRDs.\n  - apiGroups:\n      - apiextensions.k8s.io\n    resources:\n      - customresourcedefinitions\n    verbs:\n      - \"*\"\n\n  # Operator logic.\n  - apiGroups:\n      - monitoring.spotahome.com\n    resources:\n      - servicelevels\n      - servicelevels/status\n    verbs:\n      - \"*\"\n\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: service-level-operator\nsubjects:\n  - kind: ServiceAccount\n    name: service-level-operator\n    namespace: monitoring \nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: service-level-operator\n</code></pre> <p>\u7136\u540e\u521b\u5efaDeployment</p> <pre><code>apiVersion: apps/v1 \nkind: Deployment\nmetadata:\n  name: service-level-operator\n  namespace: monitoring\n  labels:\n    app: service-level-operator\n    component: app\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: service-level-operator\n      component: app\n  strategy:\n    rollingUpdate:\n      maxUnavailable: 0\n  template:\n    metadata:\n      labels:\n        app: service-level-operator\n        component: app\n    spec:\n      serviceAccountName: service-level-operator\n      containers:\n        - name: app\n          imagePullPolicy: Always\n          image: quay.io/spotahome/service-level-operator:latest\n          ports:\n            - containerPort: 8080\n              name: http\n              protocol: TCP\n          readinessProbe:\n            httpGet:\n              path: /healthz/ready\n              port: http\n          livenessProbe:\n            httpGet:\n              path: /healthz/live\n              port: http\n          resources:\n            limits:\n              cpu: 220m\n              memory: 254Mi\n            requests:\n              cpu: 120m\n              memory: 128Mi\n</code></pre> <p>\u521b\u5efaservice</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: service-level-operator\n  namespace: monitoring\n  labels:\n    app: service-level-operator\n    component: app\nspec:\n  ports:\n    - port: 80\n      protocol: TCP\n      name: http\n      targetPort: http\n  selector:\n    app: service-level-operator\n    component: app\n</code></pre> <p>\u521b\u5efaprometheus serviceMonitor</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: service-level-operator\n  namespace: monitoring\n  labels:\n    app: service-level-operator\n    component: app\n    prometheus: myprometheus\nspec:\n  selector:\n    matchLabels:\n      app: service-level-operator\n      component: app\n  namespaceSelector:\n    matchNames:\n      - monitoring \n  endpoints:\n    - port: http\n      interval: 10s\n</code></pre> <p>\u5230\u8fd9\u91cc\uff0cService Level Operator\u90e8\u7f72\u5b8c\u6210\u4e86\uff0c\u53ef\u4ee5\u5728prometheus\u4e0a\u67e5\u770b\u5230\u5bf9\u5e94\u7684Target\uff0c\u5982\u4e0b\uff1a</p> <p></p> <p>\u7136\u540e\u5c31\u9700\u8981\u521b\u5efa\u5bf9\u5e94\u7684\u670d\u52a1\u6307\u6807\u4e86\uff0c\u5982\u4e0b\u6240\u793a\u521b\u5efa\u4e00\u4e2a\u793a\u4f8b\u3002</p> <pre><code>apiVersion: monitoring.spotahome.com/v1alpha1\nkind: ServiceLevel\nmetadata:\n  name: prometheus-grafana-service\n  namespace: monitoring\nspec:\n  serviceLevelObjectives:\n    - name: \"9999_http_request_lt_500\"\n      description: 99.99% of requests must be served with &lt;500 status code.\n      disable: false\n      availabilityObjectivePercent: 99.99\n      serviceLevelIndicator:\n        prometheus:\n          address: http://prometheus-k8s.monitoring.svc:9090\n          totalQuery: sum(increase(http_request_total{service=\"grafana\"}[2m]))\n          errorQuery: sum(increase(http_request_total{service=\"grafana\", code=~\"5..\"}[2m]))\n      output:\n        prometheus:\n          labels:\n            team: prometheus-grafana \n            iteration: \"3\"\n</code></pre> <p>\u4e0a\u9762\u5b9a\u4e49\u4e86grafana\u5e94\u7528\"4\u4e2a9\"\u7684SLO\u3002</p> <p>\u7136\u540e\u53ef\u4ee5\u5728Prometheus\u4e0a\u770b\u5230\u5177\u4f53\u7684\u6307\u6807\uff0c\u5982\u4e0b\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\u5728Grafana\u4e0a\u5bfc\u5165ID\u4e3a<code>8793</code>\u7684Dashboard\uff0c\u5373\u53ef\u751f\u6210\u5982\u4e0b\u56fe\u8868\u3002</p> <p></p> <p>\u4e0a\u9762\u662fSLI\uff0c\u4e0b\u9762\u662f\u9519\u8bef\u603b\u9884\u7b97\u548c\u5df2\u6d88\u8017\u7684\u9519\u8bef\u3002</p> <p>\u4e0b\u9762\u53ef\u4ee5\u5b9a\u4e49\u544a\u8b66\u89c4\u5219\uff0c\u5f53SLO\u4e0b\u964d\u65f6\u53ef\u4ee5\u7b2c\u4e00\u65f6\u95f4\u6536\u5230\uff0c\u6bd4\u5982\uff1a</p> <pre><code>groups:\n  - name: slo.rules\n    rules:\n      - alert: SLOErrorRateTooFast1h\n        expr: |\n          (\n            increase(service_level_sli_result_error_ratio_total[1h])\n            /\n            increase(service_level_sli_result_count_total[1h])\n          ) &gt; (1 - service_level_slo_objective_ratio) * 14.6\n        labels:\n          severity: critical\n          team: a-team\n        annotations:\n          summary: The monthly SLO error budget consumed for 1h is greater than 2%\n          description: The error rate for 1h in the {{$labels.service_level}}/{{$labels.slo}} SLO error budget is being consumed too fast, is greater than 2% monthly budget.\n      - alert: SLOErrorRateTooFast6h\n        expr: |\n          (\n            increase(service_level_sli_result_error_ratio_total[6h])\n            /\n            increase(service_level_sli_result_count_total[6h])\n          ) &gt; (1 - service_level_slo_objective_ratio) * 6\n        labels:\n          severity: critical\n          team: a-team\n        annotations:\n          summary: The monthly SLO error budget consumed for 6h is greater than 5%\n          description: The error rate for 6h in the {{$labels.service_level}}/{{$labels.slo}} SLO error budget is being consumed too fast, is greater than 5% monthly budget.\n</code></pre> <p>\u7b2c\u4e00\u6761\u89c4\u5219\u8868\u793a\u57281h\u5185\u6d88\u8017\u7684\u9519\u8bef\u7387\u5927\u4e8e30\u5929\u5185\u76842%\uff0c\u5e94\u8be5\u544a\u8b66\u3002\u7b2c\u4e8c\u6761\u89c4\u5219\u662f\u57286h\u5185\u7684\u9519\u8bef\u7387\u5927\u4e8e30\u5929\u76845%\uff0c\u5e94\u8be5\u544a\u8b66\u3002</p> <p>\u4e0b\u9762\u662f\u8c37\u6b4c\u7684\u7684\u57fa\u51c6\u3002</p> <p></p>"},{"location":"chap4/49Prometheus_SLI_SLO/#4","title":"4 \u6700\u540e","text":"<p>\u8bf4\u5230\u7cfb\u7edf\u7a33\u5b9a\u6027\uff0c\u8fd9\u91cc\u4e0d\u5f97\u4e0d\u63d0\u5230\u7cfb\u7edf\u53ef\u7528\u6027\uff0cSRE\u63d0\u9ad8\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\uff0c\u6700\u7ec8\u8fd8\u662f\u4e3a\u4e86\u63d0\u5347\u7cfb\u7edf\u7684\u53ef\u7528\u65f6\u95f4\uff0c\u51cf\u5c11\u6545\u969c\u65f6\u95f4\u3002\u90a3\u5982\u4f55\u6765\u8861\u91cf\u7cfb\u7edf\u7684\u53ef\u7528\u6027\u5462\uff1f</p> <p>\u76ee\u524d\u4e1a\u754c\u6709\u4e24\u79cd\u8861\u91cf\u7cfb\u7edf\u53ef\u7528\u6027\u7684\u65b9\u5f0f\uff0c\u4e00\u4e2a\u662f\u65f6\u95f4\u7ef4\u5ea6\uff0c\u4e00\u4e2a\u662f\u8bf7\u6c42\u7ef4\u5ea6\u3002\u65f6\u95f4\u7ef4\u5ea6\u5c31\u662f\u4ece\u6545\u969c\u51fa\u53d1\u5bf9\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\u8fdb\u884c\u8bc4\u4f30\u3002\u8bf7\u6c42\u7ef4\u5ea6\u662f\u4ece\u6210\u529f\u8bf7\u6c42\u5360\u6bd4\u7684\u89d2\u5ea6\u51fa\u53d1\uff0c\u5bf9\u7cfb\u7edf\u7a33\u5b9a\u6027\u8fdb\u884c\u8bc4\u4f30\u3002</p> <ul> <li>\u65f6\u95f4\u7ef4\u5ea6\uff1a\u53ef\u7528\u6027 = \u670d\u52a1\u65f6\u95f4 / \uff08\u670d\u52a1\u65f6\u95f4 + \u6545\u969c\u65f6\u95f4\uff09</li> <li>\u8bf7\u6c42\u7ef4\u5ea6\uff1a\u53ef\u7528\u6027 = \u6210\u529f\u8bf7\u6c42\u6570 / \u603b\u8bf7\u6c42\u6570</li> </ul> <p>\u5728SRE\u5b9e\u8df5\u4e2d\uff0c\u901a\u5e38\u4f1a\u9009\u62e9\u8bf7\u6c42\u7ef4\u5ea6\u6765\u8861\u91cf\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\uff0c\u5c31\u5982\u4e0a\u9762\u7684\u4f8b\u5b50\u3002\u4e0d\u8fc7\uff0c\u5982\u679c\u4ec5\u4ec5\u901a\u8fc7\u4e00\u4e2a\u7ef4\u5ea6\u6765\u5224\u65ad\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\u4e5f\u6709\u70b9\u592a\u6b66\u65ad\uff0c\u8fd8\u5e94\u8be5\u7ed3\u5408\u66f4\u591a\u7684\u6307\u6807\uff0c\u6bd4\u5982\u5ef6\u8fdf\uff0c\u9519\u8bef\u7387\u7b49\uff0c\u800c\u4e14\u5bf9\u6838\u5fc3\u5e94\u7528\uff0c\u6838\u5fc3\u94fe\u8def\u7684SLI\u5e94\u8be5\u66f4\u7ec6\u81f4\u3002</p>"},{"location":"chap4/51missing-container-metrics/","title":"\u7b2c\u5341\u4e09\u8282 Prometheus \u4f7f\u7528 missing-container-metrics \u76d1\u63a7 Pod oomkill","text":"<p>Kubernetes \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528 cAdvisor \u6765\u6536\u96c6\u5bb9\u5668\u7684\u5404\u9879\u6307\u6807\uff0c\u8db3\u4ee5\u6ee1\u8db3\u5927\u591a\u6570\u4eba\u7684\u9700\u6c42\uff0c\u4f46\u8fd8\u662f\u6709\u6240\u6b20\u7f3a\uff0c\u6bd4\u5982\u7f3a\u5c11\u5bf9\u4ee5\u4e0b\u51e0\u4e2a\u6307\u6807\u7684\u6536\u96c6\uff1a</p> <ul> <li>OOM kill</li> <li>\u5bb9\u5668\u91cd\u542f\u7684\u6b21\u6570</li> <li>\u5bb9\u5668\u7684\u9000\u51fa\u7801</li> </ul> <p><code>missing-container-metrics</code> \u8fd9\u4e2a\u9879\u76ee\u5f25\u8865\u4e86 cAdvisor \u7684\u7f3a\u9677\uff0c\u65b0\u589e\u4e86\u4ee5\u4e0a\u51e0\u4e2a\u6307\u6807\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u53ef\u4ee5\u5229\u7528\u8fd9\u4e9b\u6307\u6807\u8fc5\u901f\u5b9a\u4f4d\u67d0\u4e9b\u6545\u969c\u3002</p> <p>\u4f8b\u5982\uff0c\u5047\u8bbe\u67d0\u4e2a\u5bb9\u5668\u6709\u591a\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u5176\u4e2d\u67d0\u4e2a\u5b50\u8fdb\u7a0b\u88ab OOM kill\uff0c\u4f46\u5bb9\u5668\u8fd8\u5728\u8fd0\u884c\uff0c\u5982\u679c\u4e0d\u5bf9 OOM kill \u8fdb\u884c\u76d1\u63a7\uff0c\u7ba1\u7406\u5458\u5f88\u96be\u5bf9\u6545\u969c\u8fdb\u884c\u5b9a\u4f4d\u3002</p>"},{"location":"chap4/51missing-container-metrics/#1","title":"1 \u5b89\u88c5","text":"<p>\u5b98\u65b9\u63d0\u4f9b\u4e86helm chart\u65b9\u5f0f\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u6211\u4eec\u5148\u6dfb\u52a0helm\u4ed3\u5e93</p> <pre><code>helm repo add missing-container-metrics https://draganm.github.io/missing-container-metrics\n</code></pre> <p>\u628a\u8fd9\u4e2achart\u4e0b\u8f7d\u5230\u672c\u5730\uff0c\u6211\u4eec\u9700\u8981\u4fee\u6539value.yaml\u6587\u4ef6</p> <pre><code>[root@master-01 addons]# helm pull missing-container-metrics/missing-container-metrics\n[root@master-01 addons]# ls\nblackbox        dingtalk  harbor_exporter                      mysql-exporter    prometheusalert  rules                          servicemonitor  victoriametrics\nblackbox-probe  etcd      missing-container-metrics-0.1.1.tgz  process-exporter  redis-exporter   scheduler-controller-svc.yaml  ssl-exporter\n[root@master-01 addons]# tar xf  missing-container-metrics-0.1.1.tgz \n</code></pre> <p>\u53ef\u914d\u7f6e\u9879</p> <p></p> <p>\u6211\u4eec\u8fd9\u91cc\u4fee\u6539<code>missing-container-metrics/values.yaml</code>\u4e2d<code>useDocker\u4e3atrue</code>\uff0c\u7136\u540e\u5b89\u88c5</p> <pre><code>[root@master-01 addons]# kubectl create namespace missing-container-metrics\nnamespace/missing-container-metrics created\n\n\n[root@master-01 addons]# helm install missing-container-metrics  missing-container-metrics -n missing-container-metrics\nNAME: missing-container-metrics\nLAST DEPLOYED: Tue Jul  6 10:47:35 2021\nNAMESPACE: missing-container-metrics\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\n\n\n[root@master-01 addons]# helm -n missing-container-metrics list\nNAME                            NAMESPACE                       REVISION        UPDATED                                 STATUS          CHART                           APP VERSION\nmissing-container-metrics       missing-container-metrics       1               2021-07-06 10:47:35.261058822 +0800 CST deployed        missing-container-metrics-0.1.1 0.21.0     \n##\u56e0\u4e3a\u6211\u53ea\u6709\u4e00\u4e2a\u8282\u70b9\uff0c\u6240\u4ee5\u8fd9\u91ccdaemonset \u5c31\u53ea\u6709\u4e00\u4e2apod\n\n\n[root@master-01 addons]# kubectl get pod -n missing-container-metrics \nNAME                              READY   STATUS    RESTARTS   AGE\nmissing-container-metrics-s9cgk   1/1     Running   0          115s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u8bbf\u95ee\u670d\u52a1\u76843001\u7aef\u53e3\u67e5\u770bmetrics,\u4f8b\u5982</p> <pre><code>[root@master-01 addons]# curl 100.67.79.150:3001/metrics\n# HELP container_last_exit_code Last exit code of the container\n# TYPE container_last_exit_code gauge\ncontainer_last_exit_code{container_id=\"docker://0133fb5d739ba98b3985bdc7766fa200334bbbf29de9a61f98a463ec00de53de\",container_short_id=\"0133fb5d739b\",docker_container_id=\"0133fb5d739ba98b3985bdc7766fa200334bbbf29de9a61f98a463ec00de53de\",image_id=\"docker-pullable://k8s.gcr.io/pause:3.2\",name=\"k8s_POD_dns-autoscaler-565bf94d6c-dc6v4_kube-system_96437fe8-200c-4845-a7cc-a27790c6c5a7_0\",namespace=\"kube-system\",pod=\"dns-autoscaler-565bf94d6c-dc6v4\"} 0\ncontainer_last_exit_code{container_id=\"docker://0388ba15b0181fead17cfc3606a57aeef0a9b8b73cf3f97eb901565c8aa1702c\",container_short_id=\"0388ba15b018\",docker_container_id=\"0388ba15b0181fead17cfc3606a57aeef0a9b8b73cf3f97eb901565c8aa1702c\",image_id=\"docker-pullable://sha256:e20d2ec0d0ed8ffd693b435af9f2943095a608440e3b845331d6d00344025455\",name=\"k8s_victoriametrics_victoriametrics-0_kube-system_7b381d2c-791b-4e38-8cbb-43485afcb285_0\",namespace=\"kube-system\",pod=\"victoriametrics-0\"} 0\ncontainer_last_exit_code{container_id=\"docker://0400f7e29dab47304f97669cb52b5c7c9310fbb5c156c07d0dc9bfca6b8ee14d\",container_short_id=\"0400f7e29dab\",docker_container_id=\"0400f7e29dab47304f97669cb52b5c7c9310fbb5c156c07d0dc9bfca6b8ee14d\",image_id=\"docker-pullable://k8s.gcr.io/pause:3.2\",name=\"k8s_POD_csi-resizer-f6d66495f-s4vkv_longhorn-system_282278da-2638-4e26-8411-802bf57c1ed8_0\",namespace=\"longhorn-system\",pod=\"csi-resizer-f6d66495f-s4vkv\"} 0\ncontainer_last_exit_code{container_id=\"docker://04e2c60777ce277c62c7137f1d7b40d9c1523bb3edf9127efd357590f39ba79c\",container_short_id=\"04e2c60777ce\",docker_container_id=\"04e2c60777ce277c62c7137f1d7b40d9c1523bb3edf9127efd357590f39ba79c\",image_id=\"docker-pullable://k8s.gcr.io/pause:3.2\",name=\"k8s_POD_kube-state-metrics-859b6bf99-q8tdf_monitoring_529aa188-f7a0-4b5c-9608-cd8fc473ac8c_2\",namespace=\"monitoring\",pod=\"kube-state-metrics-859b6bf99-q8tdf\"} 0\n</code></pre> <p>\u670d\u52a1\u516c\u5f00\u4e86\u5982\u4e0b\u7684\u6307\u6807\uff1a</p> <ul> <li><code>container_restarts</code>\uff1a\u5bb9\u5668\u7684\u91cd\u542f\u6b21\u6570\u3002</li> <li><code>container_ooms</code> \uff1a\u5bb9\u5668\u7684 OOM \u6740\u6b7b\u6570\u3002\u8fd9\u6db5\u76d6\u4e86\u5bb9\u5668 cgroup \u4e2d\u4efb\u4f55\u8fdb\u7a0b\u7684 OOM \u7ec8\u6b62\u3002</li> <li><code>container_last_exit_code</code> \uff1a\u5bb9\u5668\u7684\u6700\u540e\u9000\u51fa\u4ee3\u7801\u3002</li> </ul> <p>\u6bcf\u4e00\u4e2a\u6307\u6807\u5305\u542b\u5982\u4e0b\u6807\u7b7e\uff1a</p> <ul> <li><code>docker_container_id</code>\uff1a\u5bb9\u5668\u7684\u5b8c\u6574 ID\u3002</li> <li><code>container_short_id</code>\uff1aDocker \u5bb9\u5668 ID \u7684\u524d 6 \u4e2a\u5b57\u8282\u3002</li> <li><code>container_id</code>\uff1a\u5bb9\u5668 id \u4ee5\u4e0e kubernetes pod \u6307\u6807\u76f8\u540c\u7684\u683c\u5f0f\u8868\u793a - \u4ee5\u5bb9\u5668\u8fd0\u884c\u65f6\u4e3a\u524d\u7f00<code>docker://</code>\u5e76<code>containerd://</code>\u53d6\u51b3\u4e8e\u5bb9\u5668\u8fd0\u884c\u65f6\u3002\u8fd9\u4f7f\u5f97 Prometheus \u4e2d\u7684<code>kube_pod_container_info</code>\u6307\u6807\u53ef\u4ee5\u8f7b\u677e\u8fde\u63a5\u3002</li> <li><code>name</code>\uff1a\u5bb9\u5668\u7684\u540d\u79f0\u3002</li> <li><code>image_id</code>\uff1a\u56fe\u50cf id \u4ee5\u4e0e k8s pod \u7684\u6307\u6807\u76f8\u540c\u7684\u683c\u5f0f\u8868\u793a\u3002\u8fd9\u4f7f\u5f97 Prometheus \u4e2d\u7684<code>kube_pod_container_info</code>\u6307\u6807\u53ef\u4ee5\u8f7b\u677e\u8fde\u63a5\u3002</li> <li>pod\uff1a\u5982\u679c<code>io.kubernetes.pod.name</code>\u5728\u5bb9\u5668\u4e0a\u8bbe\u7f6e\u4e86pod\u6807\u7b7e\uff0c\u5219\u5176\u503c\u5c06\u8bbe\u7f6e\u4e3a\u6307\u6807\u4e2d\u7684\u6807\u7b7e</li> <li>namespace\uff1a\u5982\u679c<code>io.kubernetes.pod.namespace</code>\u5bb9\u5668\u4e0a\u8bbe\u7f6e\u4e86namespace\u6807\u7b7e\uff0c\u5219\u5176\u503c\u5c06\u8bbe\u7f6e\u4e3a\u6307\u6807\u7684\u6807\u7b7e\u3002</li> </ul>"},{"location":"chap4/51missing-container-metrics/#2-podmonitor-prometheusruleprometheus-operator","title":"2 \u6dfb\u52a0PodMonitor \u548c PrometheusRule\uff08\u9488\u5bf9Prometheus Operator\uff09","text":"<p>\u5728template\u76ee\u5f55\u4e0b\u521b\u5efa\u6587\u4ef6<code>podmonitor.yaml</code></p> <pre><code>{{ if .Values.prometheusOperator.podMonitor.enabled }}\napiVersion: monitoring.coreos.com/v1\nkind: PodMonitor\nmetadata:\n  name: {{ include \"missing-container-metrics.fullname\" . }}\n  {{- with .Values.prometheusOperator.podMonitor.namespace }}\n  namespace: {{ . }}\n  {{- end }}\n  labels:\n    {{- include \"missing-container-metrics.labels\" . | nindent 4 }}\n    {{- with .Values.prometheusOperator.podMonitor.selector }}\n    {{- toYaml . | nindent 4 }}\n    {{- end }}\nspec:\n  selector:\n    matchLabels:\n      {{- include \"missing-container-metrics.selectorLabels\" . | nindent 6 }}\n  podMetricsEndpoints:\n  - port: http\n  namespaceSelector:\n    matchNames:\n      - {{ .Release.Namespace }}\n{{ end }}\n</code></pre> <p>\u5728template\u76ee\u5f55\u4e0b\u521b\u5efa\u6587\u4ef6<code>prometheusrule.yaml</code></p> <pre><code>{{ if .Values.prometheusOperator.prometheusRule.enabled }}\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  name: {{ include \"missing-container-metrics.fullname\" . }}\n  {{- with .Values.prometheusOperator.prometheusRule.namespace }}\n  namespace: {{ . }}\n  {{- end }}\n  labels:\n    {{- include \"missing-container-metrics.labels\" . | nindent 4 }}\n    {{- with .Values.prometheusOperator.prometheusRule.selector }}\n    {{- toYaml . | nindent 4 }}\n    {{- end }}\nspec:\n  groups:\n  - name: {{ include \"missing-container-metrics.fullname\" . }}\n    rules:\n      {{- toYaml .Values.prometheusOperator.prometheusRule.rules | nindent 6 }}\n{{ end }}\n</code></pre> <p>\u4fee\u6539<code>value.yaml</code>,\u6dfb\u52a0\u5982\u4e0b</p> <pre><code>useDocker: true\nuseContainerd: false\n###\u6dfb\u52a0\nprometheusOperator:\n  podMonitor:\n    # Create a Prometheus Operator PodMonitor resource\n    enabled: true\n    # Namespace defaults to the Release namespace but can be overridden\n    namespace: \"\"\n    # Additional labels to add to the PodMonitor so it matches the Operator's podMonitorSelector\n    selector:\n      app.kubernetes.io/name: missing-container-metrics\n\n  prometheusRule:\n    # Create a Prometheus Operator PrometheusRule resource\n    enabled: true\n    # Namespace defaults to the Release namespace but can be overridden\n    namespace: \"\"\n    # Additional labels to add to the PrometheusRule so it matches the Operator's ruleSelector\n    selector:\n      prometheus: k8s\n      role: alert-rules\n    # The rules can be set here. An example is defined here but can be overridden.\n    rules:\n    - alert: ContainerOOMObserved\n      annotations:\n        message: A process in this Pod has been OOMKilled due to exceeding the Kubernetes memory limit at least twice in the last 15 minutes. Look at the metrics to determine if a memory limit increase is required.\n      expr: sum(increase(container_ooms[15m])) by (exported_namespace, exported_pod) &gt; 2\n      labels:\n        severity: warning\n    - alert: ContainerOOMObserved\n      annotations:\n        message: A process in this Pod has been OOMKilled due to exceeding the Kubernetes memory limit at least ten times in the last 15 minutes. Look at the metrics to determine if a memory limit increase is required.\n      expr: sum(increase(container_ooms[15m])) by (exported_namespace, exported_pod) &gt; 10\n      labels:\n        severity: critical\n</code></pre> <p>\u4f7f\u7528\u4e0b\u9762\u547d\u4ee4\u66f4\u65b0</p> <pre><code>[root@master-01 addons]# helm upgrade missing-container-metrics -n missing-container-metrics missing-container-metrics/\nRelease \"missing-container-metrics\" has been upgraded. Happy Helming!\nNAME: missing-container-metrics\nLAST DEPLOYED: Tue Jul  6 11:36:02 2021\nNAMESPACE: missing-container-metrics\nSTATUS: deployed\nREVISION: 2\nTEST SUITE: None\n</code></pre> <p>\u66f4\u65b0\u540e\u4f1a\u521b\u5efapodmonitor\u548cprometeusrules</p> <pre><code>[root@master-01 addons]# kubectl get prometheusrules.monitoring.coreos.com  -n monitoring\nNAME                        AGE\nmissing-container-metrics   15s\n[root@master-01 addons]# kubectl get podmonitors.monitoring.coreos.com  -n missing-container-metrics \nNAME                        AGE\nmissing-container-metrics   35s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5728prometheus ui \u4e0a\u770b\u5230\u76f8\u5173target\u548crules</p> <p></p>"},{"location":"chap4/chap4_Operator_probe/","title":"Prometheus Operator\u4e2d\u63a2\u9488\u7684\u4f7f\u7528\uff08Blackbox Exporter\uff09","text":"<p>\u9700\u8981\u5bf9\u670d\u52a1\u5668\u548c\u7ebf\u4e0a\u4e1a\u52a1\u8fdb\u884c\u4e00\u4e9b\u63a2\u9488\u6765\u5b9a\u65f6\u62e8\u6d4b\uff0c\u7528\u4e8e\u5bf9\u670d\u52a1\u7684\u5b58\u6d3b\u6027\u8fdb\u884c\u76d1\u63a7\u4e0e\u544a\u8b66\u3002\u5f88\u65e9\u4ee5\u524d\u5c31\u77e5\u9053prometheus\u793e\u533a\u63d0\u4f9b\u4e86 blackbox \u7684\u63a2\u9488\u65b9\u6848\uff0c\u4f46\u4e00\u76f4\u6ca1\u6709\u5173\u6ce8\uff0c\u6b63\u597d\u8d81\u8fd9\u6b21\u673a\u4f1a\u4e86\u89e3\u4e00\u4e0b\u3002</p> <p>Blackbox Exporter \u662f Prometheus \u793e\u533a\u63d0\u4f9b\u7684\u5b98\u65b9\u9ed1\u76d2\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff0c\u5176\u5141\u8bb8\u7528\u6237\u901a\u8fc7\uff1aHTTP, HTTPS, DNS, TCP, ICMP \u548c gRPC.\u7684\u65b9\u5f0f\u5bf9\u7f51\u7edc\u8fdb\u884c\u63a2\u6d4b\u3002</p> <p>\u76ee\u524d proemtheus operator \u4e2d\u7684 probe \u8d44\u6e90\u5df2\u5b9e\u73b0\u5bf9 blackbox-exporter \u7684\u652f\u6301\uff0c\u672c\u6587\u7684\u4ecb\u7ecd\u7684\u6240\u6709\u63a2\u9488\u4e5f\u5747\u5728 probe\u4e2d\u5b9e\u73b0\u3002</p>"},{"location":"chap4/chap4_Operator_probe/#_1","title":"\u73af\u5883\u51c6\u5907","text":"<p>\u5728\u4f7f\u7528\u4e4b\u524d\uff0c\u987b\u786e\u4fdd\u4f60\u7684 k8s\u96c6\u7fa4\u5185\u5df2\u7ecf\u90e8\u7f72\u4e86 prometheus operator\u548cprometheus-blackbox-exporter\uff0c\u5982\u679c\u6ca1\u6709\u5b89\u88c5\uff0c\u53ef\u4f7f\u7528 helm\u547d\u4ee4\u76f4\u63a5\u90e8\u7f72\u3002</p> <pre><code># \u6dfb\u52a0 promethues \u793e\u533a helm \u6e90 \u5e76\u66f4\u65b0\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update prometheus-community\n\n# \u5b89\u88c5 prometheus\nhelm install prometheus-community/prometheus-operator\n\n# \u5b89\u88c5 blackbox-exporter\nhelm install prometheus-community/prometheus-blackbox-exporter\n</code></pre> <p>\u5b89\u88c5\u6210\u529f\u540e\uff0c\u9700\u624b\u52a8\u914d\u7f6e black-exporter\u7684 configmap\uff0c\u5f15\u5165\u63a2\u9488\u6a21\u5757\u3002</p> <p>\u63d0\u793a\uff1a\u53ef\u4ee5\u5728<code>prometheus-blackbox-exporter</code>\u7684 <code>helm values</code> \u4e2d\u914d\u7f6e\u3002\u6587\u7ae0\u4e3a\u4e86\u76f4\u89c2\uff0c\u6240\u4ee5\u76f4\u63a5\u4fee\u6539 configmap</p> <pre><code> blackbox.yaml: |\n    modules:\n      dns:\n        dns:\n          preferred_ip_protocol: ip4\n          query_name: kubernetes.default.svc.cluster.local\n          transport_protocol: tcp\n        prober: dns\n      grpc:\n        grpc:\n          preferred_ip_protocol: ip4\n          tls: true\n        prober: grpc\n      grpc_plain:\n        grpc:\n          service: service1\n          tls: false\n        prober: grpc\n      http_2xx:\n        http:\n          follow_redirects: true\n          preferred_ip_protocol: ip4\n          valid_http_versions:\n          - HTTP/1.1\n          - HTTP/2.0\n        prober: http\n        timeout: 5s\n      http_post_2xx:\n        http:\n          method: POST\n          preferred_ip_protocol: ip4\n          valid_http_versions:\n          - HTTP/1.1\n          - HTTP/2\n        prober: http\n        headers:\n          content-type: application/json\n        body: '{\"k\": \"v\"}'   //\u81ea\u5b9a\u4e49\u7684 body \u6570\u636e\n        timeout: 5s\n      ping:\n        icmp:\n          preferred_ip_protocol: ip4\n        prober: icmp\n        timeout: 5s\n      tcp_connect:\n        prober: tcp\n        timeout: 5s\n</code></pre> <p>\u4ee5\u4e0a\u914d\u7f6e\uff0c\u8ba9 blackbox-exporter \u52a0\u8f7d\u4e86\u5b8c\u6574\u7684\u7f51\u7edc\u63a2\u9488\u6a21\u5757\u3002</p>"},{"location":"chap4/chap4_Operator_probe/#_2","title":"\u62e8\u6d4b","text":"<p>probe\u5b9e\u73b0\u4e86\u5bf9 blackbox-exporter \u7684\u914d\u7f6e\u7ba1\u7406\uff0c\u6781\u5927\u7684\u7b80</p>"},{"location":"chap4/chap4_Operator_probe/#1-icmp","title":"1. \u62e8\u6d4b ICMP","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: icmp-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: ping\n  prober:\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - 114.114.114.114\n      - baidu.com\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL <code>count by (__name__) ({job=\"probe/kubegems-monitoring/icmp-probe\"})</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>probe_dns_lookup_time_seconds{}  // icmp\u4e2d\u57df\u540d\u89e3\u6790\u8017\u65f6\nprobe_duration_seconds{}  // \u62e8\u6d4b\u8017\u65f6\nprobe_icmp_duration_seconds{}  // icmp \u7684\u8017\u65f6      \nprobe_success{}  //\u62e8\u6d4b\u7ed3\u679c\n</code></pre>"},{"location":"chap4/chap4_Operator_probe/#dns","title":"\u62e8\u6d4b DNS","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: dns-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: dns\n  prober:\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - kubegems.io\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL <code>count by (__name__) ({job=\"probe/kubegems-monitoring/dns-probe\"})</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>probe_dns_additional_rrs{}           // \u9644\u52a0\u8bb0\u5f55\u5217\u8868\u4e2d\u7684\u6761\u76ee\u6570\u91cf\nprobe_dns_answer_rrs{}                // \u54cd\u5e94\u8bb0\u5f55\u5217\u8868\u4e2d\u7684\u6761\u76ee\u6570\u91cf\nprobe_dns_authority_rrs{}             // \u6743\u5a01\u8bb0\u5f55\u5217\u8868\u4e2d\u7684\u6761\u76ee\u6570\u91cf\nprobe_dns_duration_seconds{}     // dns\u89e3\u6790\u8017\u65f6\n</code></pre>"},{"location":"chap4/chap4_Operator_probe/#tcp","title":"\u62e8\u6d4b TCP","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: tcp-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: tcp_connect\n  prober:\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - kubegems.io:443\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL <code>count by (__name__) ({job=\"probe/kubegems-monitoring/tcp-probe\"})</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>probe_dns_lookup_time_seconds{}\nprobe_duration_seconds{}\nprobe_failed_due_to_regex{}\nprobe_ip_addr_hash{}\nprobe_ip_protocol{}\nprobe_success{}\n</code></pre>"},{"location":"chap4/chap4_Operator_probe/#http-get","title":"\u62e8\u6d4b HTTP GET","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: http-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: http_2xx\n  prober:\n    path: /probe\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - https://kubegems.io\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL <code>count by (__name__) ({job=\"probe/kubegems-monitoring/http-probe\"})</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>probe_dns_lookup_time_seconds{}  // http\u62e8\u6d4b\u4e2d\u7684 dns \u67e5\u8be2\u8017\u65f6\nprobe_duration_seconds{}\nprobe_failed_due_to_regex{}\nprobe_http_content_length{}\nprobe_http_duration_seconds{}    // http handler \u5404\u9636\u6bb5\u5904\u7406\u8017\u65f6\nprobe_http_last_modified_timestamp_seconds{}\nprobe_http_redirects{}\nprobe_http_ssl{}    // \u662f\u5426\u542f\u7528 https\nprobe_http_status_code{}   // http \u72b6\u6001\u7801\nprobe_http_uncompressed_body_length{}\nprobe_http_version{}\nprobe_ssl_earliest_cert_expiry{}  // ssl\u8bc1\u4e66\u8fc7\u671f\u65f6\u95f4\nprobe_ssl_last_chain_expiry_timestamp_seconds{}\nprobe_ssl_last_chain_info{}\nprobe_success{}\nprobe_tls_version_info{}   // tls\u7248\u672c\n</code></pre>"},{"location":"chap4/chap4_Operator_probe/#grpc","title":"\u62e8\u6d4b GRPC","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: grpc-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: grpc_plain\n  prober:\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - 172.16.23.86:30590\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL <code>count by (__name__) ({job=\"probe/kubegems-monitoring/grpc-probe\"})</code>\uff0c</p> <p>\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>\nprobe_dns_lookup_time_seconds{}\nprobe_duration_seconds{}\nprobe_grpc_duration_seconds{}\nprobe_grpc_healthcheck_response{}\nprobe_grpc_ssl{}\nprobe_grpc_status_code{}\nprobe_ssl_earliest_cert_expiry{}\nprobe_success{}\n</code></pre>"},{"location":"chap4/chap4_blackbox/","title":"\u5982\u4f55\u5728Prometheus\u4e2d\u8fdb\u884c\u9ed1\u76d2\u76d1\u63a7(ICMP/DNS/TCP/HTTP/gRPC)","text":"<p>Blackbox Exporter \u662f Prometheus \u793e\u533a\u63d0\u4f9b\u7684\u5b98\u65b9\u9ed1\u76d2\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\uff0c\u5176\u5141\u8bb8\u7528\u6237\u901a\u8fc7\uff1aHTTP, HTTPS, DNS, TCP, ICMP \u548c gRPC.\u7684\u65b9\u5f0f\u5bf9\u7f51\u7edc\u8fdb\u884c\u63a2\u6d4b\u3002\u76ee</p> <p>\u524d proemtheus operator \u4e2d\u7684 probe \u8d44\u6e90\u5df2\u5b9e\u73b0\u5bf9 blackbox-exporter \u7684\u652f\u6301\uff0c\u672c\u6587\u7684\u4ecb\u7ecd\u7684\u6240\u6709\u63a2\u9488\u4e5f\u5747\u5728 probe\u4e2d\u5b9e\u73b0\u3002</p>"},{"location":"chap4/chap4_blackbox/#_1","title":"\u73af\u5883\u51c6\u5907","text":"<p>\u5728\u4f7f\u7528\u4e4b\u524d\uff0c\u987b\u786e\u4fdd\u4f60\u7684 k8s\u96c6\u7fa4\u5185\u5df2\u7ecf\u90e8\u7f72\u4e86 <code>prometheus operator</code> \u548c<code>prometheus-blackbox-exporter</code>\uff0c\u5982\u679c\u6ca1\u6709\u5b89\u88c5\uff0c\u53ef\u4f7f\u7528 helm\u547d\u4ee4\u76f4\u63a5\u90e8\u7f72\u3002</p> <pre><code># \u6dfb\u52a0 promethues \u793e\u533a helm \u6e90 \u5e76\u66f4\u65b0\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update prometheus-community\n\n# \u5b89\u88c5 prometheus\nhelm install prometheus-community/prometheus-operator\n\n# \u5b89\u88c5 blackbox-exporter\nhelm install prometheus-community/prometheus-blackbox-exporter\n</code></pre> <p>\u5b89\u88c5\u6210\u529f\u540e\uff0c\u9700\u624b\u52a8\u914d\u7f6e black-exporter\u7684 configmpa\uff0c\u5f15\u5165\u63a2\u9488\u6a21\u5757\u3002</p> <p>\u63d0\u793a\uff1a\u53ef\u4ee5\u5728<code>prometheus-blackbox-exporter</code>\u7684 helm values \u4e2d\u914d\u7f6e\u3002\u6587\u7ae0\u4e3a\u4e86\u76f4\u89c2\uff0c\u6240\u4ee5\u76f4\u63a5\u4fee\u6539 configmap</p> <pre><code>blackbox.yaml: |\n    modules:\n      dns:\n        dns:\n          preferred_ip_protocol: ip4\n          query_name: kubernetes.default.svc.cluster.local\n          transport_protocol: tcp\n        prober: dns\n      grpc:\n        grpc:\n          preferred_ip_protocol: ip4\n          tls: true\n        prober: grpc\n      grpc_plain:\n        grpc:\n          service: service1\n          tls: false\n        prober: grpc\n      http_2xx:\n        http:\n          follow_redirects: true\n          preferred_ip_protocol: ip4\n          valid_http_versions:\n          - HTTP/1.1\n          - HTTP/2.0\n        prober: http\n        timeout: 5s\n      http_post_2xx:\n        http:\n          method: POST\n          preferred_ip_protocol: ip4\n          valid_http_versions:\n          - HTTP/1.1\n          - HTTP/2\n        prober: http\n        headers:\n          content-type: application/json\n        body: '{\"k\": \"v\"}'   //\u81ea\u5b9a\u4e49\u7684 body \u6570\u636e\n        timeout: 5s\n      ping:\n        icmp:\n          preferred_ip_protocol: ip4\n        prober: icmp\n        timeout: 5s\n      tcp_connect:\n        prober: tcp\n        timeout: 5s\n</code></pre> <p>\u4ee5\u4e0a\u914d\u7f6e\uff0c\u8ba9 blackbox-exporter \u52a0\u8f7d\u4e86\u5b8c\u6574\u7684\u7f51\u7edc\u63a2\u9488\u6a21\u5757\u3002</p>"},{"location":"chap4/chap4_blackbox/#_2","title":"\u62e8\u6d4b","text":"<p><code>probe</code> \u5b9e\u73b0\u4e86\u5bf9 blackbox-exporter \u7684\u914d\u7f6e\u7ba1\u7406\uff0c\u6781\u5927\u7684\u7b80\u5316\u914d\u7f6e\u3002</p>"},{"location":"chap4/chap4_blackbox/#1-icmp","title":"1. \u62e8\u6d4b ICMP","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: icmp-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: ping\n  prober:\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - 114.114.114.114\n      - baidu.com\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL <code>count by (__name__) ({job=\"probe/kubegems-monitoring/icmp-probe\"})</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>probe_dns_lookup_time_seconds{}  // icmp\u4e2d\u57df\u540d\u89e3\u6790\u8017\u65f6\nprobe_duration_seconds{}  // \u62e8\u6d4b\u8017\u65f6\nprobe_icmp_duration_seconds{}  // icmp \u7684\u8017\u65f6      \nprobe_success{}  //\u62e8\u6d4b\u7ed3\u679c\n</code></pre>"},{"location":"chap4/chap4_blackbox/#dns","title":"\u62e8\u6d4b DNS","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: dns-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: dns\n  prober:\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - kubegems.io\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL <code>count by (__name__) ({job=\"probe/kubegems-monitoring/dns-probe\"})</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>probe_dns_additional_rrs{}           // \u9644\u52a0\u8bb0\u5f55\u5217\u8868\u4e2d\u7684\u6761\u76ee\u6570\u91cf\nprobe_dns_answer_rrs{}                // \u54cd\u5e94\u8bb0\u5f55\u5217\u8868\u4e2d\u7684\u6761\u76ee\u6570\u91cf\nprobe_dns_authority_rrs{}             // \u6743\u5a01\u8bb0\u5f55\u5217\u8868\u4e2d\u7684\u6761\u76ee\u6570\u91cf\nprobe_dns_duration_seconds{}     // dns\u89e3\u6790\u8017\u65f6\n</code></pre>"},{"location":"chap4/chap4_blackbox/#tcp","title":"\u62e8\u6d4b TCP","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: tcp-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: tcp_connect\n  prober:\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - kubegems.io:443\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL </p> <p><code>count by (__name__) ({job=\"probe/kubegems-monitoring/tcp-probe\"})</code></p> <p>\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>probe_dns_lookup_time_seconds{}\nprobe_duration_seconds{}\nprobe_failed_due_to_regex{}\nprobe_ip_addr_hash{}\nprobe_ip_protocol{}\nprobe_success{}\n</code></pre>"},{"location":"chap4/chap4_blackbox/#http-get","title":"\u62e8\u6d4b HTTP GET","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: http-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: http_2xx\n  prober:\n    path: /probe\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - https://kubegems.io\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL <code>count by (__name__) ({job=\"probe/kubegems-monitoring/http-probe\"})</code>\uff0c</p> <p>\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>\nprobe_dns_lookup_time_seconds{}  // http\u62e8\u6d4b\u4e2d\u7684 dns \u67e5\u8be2\u8017\u65f6\nprobe_duration_seconds{}\nprobe_failed_due_to_regex{}\nprobe_http_content_length{}\nprobe_http_duration_seconds{}    // http handler \u5404\u9636\u6bb5\u5904\u7406\u8017\u65f6\nprobe_http_last_modified_timestamp_seconds{}\nprobe_http_redirects{}\nprobe_http_ssl{}    // \u662f\u5426\u542f\u7528 https\nprobe_http_status_code{}   // http \u72b6\u6001\u7801\nprobe_http_uncompressed_body_length{}\nprobe_http_version{}\nprobe_ssl_earliest_cert_expiry{}  // ssl\u8bc1\u4e66\u8fc7\u671f\u65f6\u95f4\nprobe_ssl_last_chain_expiry_timestamp_seconds{}\nprobe_ssl_last_chain_info{}\nprobe_success{}\nprobe_tls_version_info{}   // tls\u7248\u672c\n</code></pre>"},{"location":"chap4/chap4_blackbox/#grpc","title":"\u62e8\u6d4b GRPC","text":"<pre><code>kind: Probe\napiVersion: monitoring.coreos.com/v1\nmetadata:\n  name: grpc-probe\n  namespace: kubegems-monitoring\nspec:\n  interval: 60s\n  module: grpc_plain\n  prober:\n    url: prometheus-blackbox-exporter.kubegems-monitoring.svc.cluster.local:9115\n  targets:\n    staticConfig:\n      static:\n      - 172.16.23.86:30590\n</code></pre> <p>\u901a\u8fc7\u67e5\u8be2PromQL <code>count by (__name__) ({job=\"probe/kubegems-monitoring/grpc-probe\"})</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6307\u6807</p> <pre><code>probe_dns_lookup_time_seconds{}\nprobe_duration_seconds{}\nprobe_grpc_duration_seconds{}\nprobe_grpc_healthcheck_response{}\nprobe_grpc_ssl{}\nprobe_grpc_status_code{}\nprobe_ssl_earliest_cert_expiry{}\nprobe_success{}\n</code></pre>"},{"location":"chap5/52Prometheus_Relabeling/","title":"\u7b2c\u4e8c\u8282 Prometheus Relabeling \u91cd\u65b0\u6807\u8bb0\u7684\u4f7f\u7528","text":"<p>Relabeling \u91cd\u65b0\u6807\u8bb0\u662f\u914d\u7f6e Prometheus \u5143\u4fe1\u606f\u7684\u65b9\u5f0f\uff0c\u5b83\u662f\u8f6c\u6362\u548c\u8fc7\u6ee4 Prometheus \u4e2d label \u6807\u7b7e\u5bf9\u8c61\u7684\u6838\u5fc3\uff0c\u672c\u6587\u6211\u4eec\u5c06\u4e86\u89e3 Relabeling \u89c4\u5219\u7684\u5de5\u4f5c\u539f\u7406\u4ee5\u53ca\u5728\u4e0d\u540c\u573a\u666f\u4e2d\u7684\u5e94\u7528\u65b9\u5f0f\u3002</p>"},{"location":"chap5/52Prometheus_Relabeling/#1","title":"1\u3001\u6982\u8ff0","text":"<ul> <li>\u53ea\u76d1\u89c6\u5177\u6709\u7279\u5b9a\u670d\u52a1\u53d1\u73b0\u6ce8\u89e3\u7684\u67d0\u4e9b\u76ee\u6807\uff0c\u901a\u5e38\u5728\u670d\u52a1\u53d1\u73b0\u4e2d\u4f7f\u7528</li> <li>\u5411\u76ee\u6807\u6293\u53d6\u8bf7\u6c42\u6dfb\u52a0 HTTP \u67e5\u8be2\u53c2\u6570</li> <li>\u4ec5\u5b58\u50a8\u4ece\u6307\u5b9a\u76ee\u6807\u4e2d\u63d0\u53d6\u6837\u672c\u7684\u5b50\u96c6</li> <li>\u5c06\u6293\u53d6\u5e8f\u5217\u7684\u4e24\u4e2a\u6807\u7b7e\u503c\u5408\u5e76\u4e3a\u4e00\u4e2a\u6807\u7b7e</li> </ul> <p>Relabeling \u662f\u4f5c\u4e3a\u4e00\u7cfb\u5217\u8f6c\u6362\u6b65\u9aa4\u5b9e\u73b0\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u5e94\u7528\u8fd9\u4e9b\u6b65\u9aa4\u6765\u8fc7\u6ee4\u6216\u4fee\u6539\u6807\u8bb0\u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e00\u4e0b\u7c7b\u578b\u7684\u6807\u8bb0\u5bf9\u8c61\u5e94\u7528 Relabeling \u64cd\u4f5c\uff1a</p> <ul> <li>\u53d1\u73b0\u7684\u6293\u53d6\u76ee\u6807\uff08<code>relabel_configs</code>\uff09</li> <li>\u6293\u53d6\u7684\u5355\u4e2a\u6837\u672c\uff08<code>metric_relabel_configs</code>\uff09</li> <li>\u53d1\u9001\u7ed9 Alertmanager \u7684\u62a5\u8b66\uff08<code>alert_relabel_configs</code>\uff09</li> <li>\u5199\u5230\u8fdc\u7a0b\u5b58\u50a8\u7684\u6837\u672c\uff08<code>write_relabel_configs</code>\uff09</li> </ul> <p></p> <p>\u6240\u6709\u8fd9\u4e9b relabeling \u914d\u7f6e\u5757\u90fd\u662f\u76f8\u540c\u7c7b\u578b\u7684 <code>relabel_config</code>\uff0c\u6bcf\u4e2a\u914d\u7f6e\u5757\u90fd\u7531\u4e00\u4e2a\u89c4\u5219\u5217\u8868\u7ec4\u6210\uff0c\u8fd9\u4e9b\u89c4\u5219\u4f9d\u6b21\u5e94\u7528\u4e8e\u6bcf\u4e2a\u6807\u8bb0\u7684\u5bf9\u8c61\u3002</p> <p></p> <p>\u4f8b\u5982\uff0c\u4e00\u4e2a relabeling \u89c4\u5219\u53ef\u4ee5\u6839\u636e\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5339\u914d\u6765\u4fdd\u7559\u6216\u4e22\u5f03\u4e00\u4e2a\u5bf9\u8c61\uff0c\u53ef\u4ee5\u4fee\u6539\u5176\u6807\u7b7e\uff0c\u4e5f\u53ef\u4ee5\u5c06\u4e00\u6574\u7ec4\u6807\u7b7e\u6620\u5c04\u5230\u53e6\u4e00\u7ec4\u3002</p> <p>\u4e00\u65e6\u4e00\u4e2a relabeling \u6b65\u9aa4\u51b3\u5b9a\u653e\u5f03\u4e00\u4e2a\u6709\u6807\u7b7e\u7684\u5bf9\u8c61\uff0c\u5c31\u4e0d\u4f1a\u5bf9\u8fd9\u4e2a\u5bf9\u8c61\u6267\u884c\u8fdb\u4e00\u6b65\u7684 relabeling \u6b65\u9aa4\uff0c\u5b83\u5c06\u4ece\u8f93\u51fa\u5217\u8868\u4e2d\u5220\u9664\u3002</p>"},{"location":"chap5/52Prometheus_Relabeling/#2","title":"2\u3001\u9690\u85cf\u7684\u6807\u7b7e\u4e0e\u5143\u6570\u636e","text":"<p>\u4ee5\u53cc\u4e0b\u5212\u7ebf<code>__</code>\u5f00\u5934\u7684\u6807\u7b7e\u5c5e\u4e8e\u7279\u6b8a\u7684\u6807\u7b7e\uff0c\u5b83\u4eec\u5728\u91cd\u65b0\u6807\u8bb0\u540e\u4f1a\u88ab\u5220\u9664\u3002</p> <p>\u6807\u8bb0\u5bf9\u8c61\u7684\u6765\u6e90\u6700\u521d\u53ef\u4ee5\u9644\u52a0\u8fd9\u4e9b\u9690\u85cf\u7684\u6807\u7b7e\uff0c\u4ee5\u63d0\u4f9b\u5173\u4e8e\u6807\u8bb0\u5bf9\u8c61\u7684\u989d\u5916\u5143\u6570\u636e\uff0c\u8fd9\u4e9b\u7279\u6b8a\u7684\u6807\u7b7e\u53ef\u4ee5\u5728 <code>relabeling</code> \u9636\u6bb5\u88ab\u7528\u6765\u5bf9\u5bf9\u8c61\u7684\u6807\u7b7e\u8fdb\u884c\u4fee\u6539\u3002</p> <p>\u5bf9\u4e8e\u6293\u53d6\u6307\u6807\uff0c\u5176\u4e2d\u5c31\u5305\u542b\u4e00\u4e9b\u9690\u85cf\u7684\u6807\u7b7e\uff0c\u53ef\u4ee5\u7528\u6765\u63a7\u5236\u76ee\u6807\u5e94\u8be5\u5982\u4f55\u88ab\u6293\u53d6\u3002</p> <ul> <li><code>__address__</code>\uff1a\u5305\u542b\u5e94\u8be5\u88ab\u6293\u53d6\u76ee\u6807\u7684\u5730\u5740\uff0c\u5b83\u6700\u521d\u9ed8\u8ba4\u4e3a\u670d\u52a1\u53d1\u73b0\u673a\u5236\u63d0\u4f9b\u7684 <code>&lt;host&gt;:&lt;port&gt;</code>\uff0c\u5982\u679c\u5728\u6b64\u4e4b\u524d\u6ca1\u6709\u660e\u786e\u5730\u5c06\u5b9e\u4f8b\u6807\u7b7e instance \u8bbe\u7f6e\u4e3a\u5176\u4ed6\u503c\uff0c\u90a3\u4e48\u5728<code>relabeling</code>\u4e4b\u540e\uff0c<code>Prometheus</code> \u4f1a\u5c06 <code>instance</code> \u6807\u7b7e\u8bbe\u7f6e\u4e3a <code>__address__</code> \u7684\u503c\u3002</li> <li><code>__scheme__</code>\uff1a\u6293\u53d6\u76ee\u6807\u7684\u8bf7\u6c42\u6a21\u5f0f\uff0c\u5305\u62ec http \u4e0e https\uff0c\u9ed8\u8ba4\u4e3a http\u3002</li> <li><code>__metrics_path__</code>\uff1a\u8868\u793a\u7528\u4e8e\u91c7\u96c6\u6307\u6807\u7684 HTTP \u8def\u5f84\uff0c\u9ed8\u8ba4\u4e3a <code>/metrics</code>\u3002</li> <li><code>__param_&lt;name&gt;</code>: \u5305\u542b HTTP \u67e5\u8be2\u53c2\u6570\u540d\u79f0\u548c\u5b83\u4eec\u7684\u503c\u3002</li> </ul> <p>\u4e0a\u9762\u7684\u8fd9\u4e9b\u6807\u7b7e\u90fd\u53ef\u4ee5\u4f7f\u7528 relabeling \u89c4\u5219\u6765\u8bbe\u7f6e\u6216\u8986\u76d6\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4e3a\u6293\u53d6\u76ee\u6807\u8fdb\u884c\u81ea\u5b9a\u4e49\u6293\u53d6\u884c\u4e3a\u3002</p> <p>\u6b64\u5916\uff0c\u670d\u52a1\u53d1\u73b0\u673a\u5236\u4e5f\u53ef\u4ee5\u63d0\u4f9b\u4e00\u7ec4\u4ee5 <code>__meta_</code> \u5f00\u5934\u7684\u6807\u7b7e\uff0c\u5305\u542b\u5173\u4e8e\u76ee\u6807\u7684\u7279\u5b9a\u53d1\u73b0\u5143\u6570\u636e\u3002</p> <p>\u4f8b\u5982\uff0c\u5f53\u53d1\u73b0 Kubernetes \u96c6\u7fa4\u4e2d\u7684 pod \u65f6\uff0cKubernetes \u670d\u52a1\u53d1\u73b0\u5f15\u64ce\u5c06\u4e3a\u6bcf\u4e2a pod \u76ee\u6807\u63d0\u4f9b\u4e00\u4e2a <code>__meta_kubernetes_pod_name</code> \u7684\u6807\u7b7e\uff0c\u5305\u542b\u88ab\u53d1\u73b0\u7684 pod \u7684\u540d\u5b57\uff0c\u4ee5\u53ca\u4e00\u4e2a <code>__meta_kubernetes_pod_ready</code> \u6807\u7b7e\uff0c\u8868\u660e pod \u662f\u5426\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\uff0c</p> <p>\u5173\u4e8e\u670d\u52a1\u53d1\u73b0\u751f\u6210\u7684\u5143\u6807\u7b7e\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config \u4e86\u89e3\u66f4\u591a\u3002</p> <p>\u5982\u679c\u4e00\u4e2a <code>relabeling</code> \u6b65\u9aa4\u9700\u8981\u5c06\u4e00\u4e2a\u503c\u4fdd\u5b58\u5230\u4e00\u4e2a\u4e34\u65f6\u6807\u7b7e\u4e2d\uff08\u4ee5\u4fbf\u5728\u968f\u540e\u7684\u6b65\u9aa4\u4e2d\u5904\u7406\uff09\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>__tmp</code> \u6807\u7b7e\u540d\u79f0\u524d\u7f00\u8fdb\u884c\u6807\u8bb0\uff0c\u4ee5 <code>__tmp</code> \u5f00\u901a\u7684\u6807\u7b7e\u662f\u4e0d\u4f1a\u88ab Prometheus \u672c\u8eab\u4f7f\u7528\u7684\u3002</p>"},{"location":"chap5/52Prometheus_Relabeling/#2-relabeling","title":"2 Relabeling \u89c4\u5219","text":"<p>Relabeling \u89c4\u5219\u4e3b\u8981\u7531\u4ee5\u4e0b\u7684\u4e00\u4e9b\u914d\u7f6e\u5c5e\u6027\u7ec4\u6210\uff0c\u4f46\u5bf9\u4e8e\u6bcf\u79cd\u7c7b\u578b\u7684\u64cd\u4f5c\uff0c\u53ea\u4f7f\u7528\u8fd9\u4e9b\u5b57\u6bb5\u7684\u4e00\u4e2a\u5b50\u96c6\u3002</p> <ul> <li><code>action</code>\uff1a\u6267\u884c\u7684 <code>relabeling</code> \u52a8\u4f5c\uff0c\u53ef\u9009\u503c\u5305\u62ec <code>replace</code>\u3001<code>keep</code>\u3001<code>drop</code>\u3001<code>hashmod</code>\u3001<code>labelmap</code>\u3001<code>labeldrop</code> \u6216\u8005 <code>labelkeep</code>\uff0c\u9ed8\u8ba4\u503c\u4e3a <code>replace</code>\u3002</li> <li><code>separator</code>\uff1a\u5206\u9694\u7b26\uff0c\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u7528\u4e8e\u5728\u8fde\u63a5\u6e90\u6807\u7b7e <code>source_labels</code> \u65f6\u5206\u9694\u5b83\u4eec\uff0c\u9ed8\u8ba4\u4e3a;\u3002</li> <li><code>source_labels</code>\uff1a\u6e90\u6807\u7b7e\uff0c\u4f7f\u7528\u914d\u7f6e\u7684\u5206\u9694\u7b26\u4e32\u8054\u7684\u6807\u7b7e\u540d\u79f0\u5217\u8868\uff0c\u5e76\u4e0e\u63d0\u4f9b\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u8fdb\u884c\u5339\u914d\u3002</li> <li><code>target_label</code>\uff1a\u76ee\u6807\u6807\u7b7e\uff0c\u5f53\u4f7f\u7528 replace \u6216\u8005 hashmod \u52a8\u4f5c\u65f6\uff0c\u5e94\u8be5\u88ab\u8986\u76d6\u7684\u6807\u7b7e\u540d\u3002</li> <li><code>regex</code>\uff1a\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u7528\u4e8e\u5339\u914d\u4e32\u8054\u7684\u6e90\u6807\u7b7e\uff0c\u9ed8\u8ba4\u4e3a<code>(.*)</code>\uff0c\u5339\u914d\u4efb\u4f55\u6e90\u6807\u7b7e\u3002</li> <li><code>modulus</code>\uff1a\u6a21\u6570\uff0c\u4e32\u8054\u7684\u6e90\u6807\u7b7e\u54c8\u5e0c\u503c\u7684\u6a21\uff0c\u4e3b\u8981\u7528\u4e8e Prometheus \u6c34\u5e73\u5206\u7247\u3002</li> <li><code>replacement</code>\uff1areplacement \u5b57\u7b26\u4e32\uff0c\u5199\u5728\u76ee\u6807\u6807\u7b7e\u4e0a\uff0c\u7528\u4e8e\u66ff\u6362 <code>relabeling</code> \u52a8\u4f5c\uff0c\u5b83\u53ef\u4ee5\u53c2\u8003\u7531 regex \u6355\u83b7\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u6355\u83b7\u7ec4\u3002</li> </ul>"},{"location":"chap5/52Prometheus_Relabeling/#2-1","title":"2-1 \u8bbe\u7f6e\u6216\u66ff\u6362\u6807\u7b7e\u503c","text":"<p><code>Relabeling</code> \u7684\u4e00\u4e2a\u5e38\u89c1\u64cd\u4f5c\u5c31\u662f\u8bbe\u7f6e\u6216\u8005\u8986\u76d6\u4e00\u4e2a\u6807\u7b7e\u7684\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 replace \u8fd9\u4e2a\u64cd\u4f5c\u6765\u5b8c\u6210\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a <code>action</code> \u5b57\u6bb5\uff0c\u5219\u9ed8\u8ba4\u5c31\u662f <code>replace</code>\u3002</p> <p>\u4e00\u4e2a replace \u52a8\u4f5c\u7684\u89c4\u5219\u914d\u7f6e\u65b9\u5f0f\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>action: replace\nsource_labels: [&lt;source label name list&gt;]\nseparator: &lt;source labels separator&gt; # \u9ed8\u8ba4\u4e3a ';'\nregex: &lt;regular expression&gt; # \u9ed8\u8ba4\u4e3a '(.*)' (\u5339\u914d\u4efb\u4f55\u503c))\nreplacement: &lt;replacement string&gt; # \u9ed8\u8ba4\u4e3a '$1' (\u4f7f\u7528\u7b2c\u4e00\u4e2a\u6355\u83b7\u7ec4\u4f5c\u4e3a replacement)\ntarget_label: &lt;target label&gt;\n</code></pre> <p>\u8be5\u64cd\u4f5c\u6309\u987a\u5e8f\u6267\u884c\u4ee5\u4e0b\u6b65\u9aa4\uff1a</p> <ul> <li>\u4f7f\u7528\u63d0\u4f9b\u7684 separator \u5206\u9694\u7b26\u5c06 <code>source_labels</code> \u4e2d\u7684\u6807\u7b7e\u5217\u8868\u503c\u8fde\u63a5\u8d77\u6765</li> <li>\u6d4b\u8bd5 <code>regex</code> \u4e2d\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u662f\u5426\u4e0e\u4e0a\u4e00\u6b65\u8fde\u63a5\u7684\u5b57\u7b26\u4e32\u5339\u914d\uff0c\u5982\u679c\u4e0d\u5339\u914d\uff0c\u5c31\u8df3\u5230\u4e0b\u4e00\u4e2a <code>relabeling</code> \u89c4\u5219\uff0c\u4e0d\u66ff\u6362\u4efb\u4f55\u4e1c\u897f</li> <li>\u5982\u679c\u6b63\u5219\u5339\u914d\uff0c\u5c31\u63d0\u53d6\u6b63\u5219\u8868\u8fbe\u5f0f\u6355\u83b7\u7ec4\u4e2d\u7684\u503c\uff0c\u5e76\u5c06 <code>replacement</code> \u5b57\u7b26\u4e32\u4e2d\u5bf9\u8fd9\u4e9b\u7ec4\u7684\u5f15\u7528(2, ...)\u7528\u5b83\u4eec\u7684\u503c\u66ff\u6362</li> <li>\u628a\u7ecf\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f\u66ff\u6362\u7684 replacement \u5b57\u7b26\u4e32\u4f5c\u4e3a <code>target_label</code> \u6807\u7b7e\u7684\u65b0\u503c\u5b58\u50a8\u8d77\u6765</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u6765\u7b80\u5355\u770b\u4e00\u770b replace \u64cd\u4f5c\u7684\u793a\u4f8b\u3002</p> <p>\u8bbe\u7f6e\u4e00\u4e2a\u56fa\u5b9a\u7684\u6807\u7b7e\u503c</p> <p>\u6700\u7b80\u5355\u7684 replace \u4f8b\u5b50\u5c31\u662f\u5c06\u4e00\u4e2a\u6807\u7b7e\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u56fa\u5b9a\u7684\u503c\uff0c\u6bd4\u5982\u4f60\u53ef\u4ee5\u628a env \u6807\u7b7e\u8bbe\u7f6e\u4e3a <code>production</code>\uff1a</p> <pre><code>action: replace\nreplacement: production\ntarget_label: env\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5e76\u6ca1\u6709\u8bbe\u7f6e\u89c4\u5219\u7684\u5927\u90e8\u5206\u5c5e\u6027\uff0c\u8fd9\u662f\u56e0\u4e3a\u5927\u90e8\u5206\u7684\u9ed8\u8ba4\u503c\u5df2\u7ecf\u53ef\u4ee5\u6ee1\u8db3\u8fd9\u91cc\u7684\u9700\u6c42\u4e86\uff0c\u8fd9\u91cc\u4f1a\u5c06\u66ff\u6362\u7684\u5b57\u7b26\u4e32 <code>production</code> \u4f5c\u4e3a <code>target_label</code> \u6807\u7b7e <code>env</code> \u7684\u65b0\u503c\u5b58\u50a8\u8d77\u6765\uff0c\u4e5f\u5c31\u662f\u5c06 <code>env</code>\u6807\u7b7e\u7684\u503c\u8bbe\u7f6e\u4e3a <code>production</code>\u3002</p> <p>\u66ff\u6362\u6293\u53d6\u4efb\u52a1\u7aef\u53e3</p> <p>\u53e6\u4e00\u4e2a\u7a0d\u5fae\u590d\u6742\u7684\u793a\u4f8b\u662f\u91cd\u5199\u4e00\u4e2a\u88ab\u6293\u53d6\u4efb\u52a1\u5b9e\u4f8b\u7684\u7aef\u53e3\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e00\u4e2a\u56fa\u5b9a\u7684 80 \u7aef\u53e3\u6765\u66ff\u6362 <code>__address__</code> \u6807\u7b7e\u7684\u7aef\u53e3\uff1a</p> <pre><code>action: replace\nsource_labels: [__address__]\nregex: ([^:]+)(?::\\d+)? # \u7b2c\u4e00\u4e2a\u6355\u83b7\u7ec4\u5339\u914d\u7684\u662f host\uff0c\u7b2c\u4e8c\u4e2a\u5339\u914d\u7684\u662f port \u7aef\u53e3\u3002\nreplacement: \"$1:80\"\ntarget_label: __address__\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u66ff\u6362\u7684\u6e90\u6807\u7b7e\u4e3a <code>__address__</code>\uff0c\u7136\u540e\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f <code>([^:]+)(?::\\d+)?</code>\u8fdb\u884c\u5339\u914d\uff0c\u8fd9\u91cc\u6709\u4e24\u4e2a\u6355\u83b7\u7ec4\uff0c\u7b2c\u4e00\u4e2a\u5339\u914d\u7684\u662f <code>host(1)</code>\uff0c\u7b2c\u4e8c\u4e2a\u5339\u914d\u7684\u662f\u7aef\u53e3(2)\uff0c</p> <p>\u6240\u4ee5\u5728 <code>replacement</code> \u5b57\u7b26\u4e32\u4e2d\u6211\u4eec\u4fdd\u7559\u7b2c\u4e00\u4e2a\u6355\u83b7\u7ec4 <code>$1</code>\uff0c\u7136\u540e\u5c06\u7aef\u53e3\u66f4\u6539\u4e3a <code>80</code>\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5c06 <code>__address__</code> \u7684\u5b9e\u4f8b\u7aef\u53e3\u66f4\u6539\u4e3a <code>80</code> \u7aef\u53e3\uff0c\u7136\u540e\u91cd\u65b0\u5199\u4f1a <code>__address__</code> \u8fd9\u4e2a\u76ee\u6807\u6807\u7b7e\u3002</p>"},{"location":"chap5/52Prometheus_Relabeling/#2-1_1","title":"2-1 \u4fdd\u7559\u6216\u4e22\u5f03\u5bf9\u8c61","text":"<p>Relabeling \u53e6\u4e00\u4e2a\u5e38\u89c1\u7684\u7528\u4f8b\u5c31\u662f\u8fc7\u6ee4\u6709\u6807\u7b7e\u7684\u5bf9\u8c61\uff0c<code>keep</code> \u6216 <code>drop</code> \u8fd9\u4e24\u4e2a\u52a8\u4f5c\u53ef\u4ee5\u6765\u5b8c\u6210\uff0c\u4f7f\u7528\u8fd9\u4e24\u4e2a\u64cd\u4f5c\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5b8c\u6210\u5982\u4e0b\u7684\u4e00\u4e9b\u64cd\u4f5c\uff1a</p> <ul> <li>\u6765\u81ea\u670d\u52a1\u53d1\u73b0\u7684\u54ea\u4e9b\u76ee\u6807\u5e94\u8be5\u88ab\u6293\u53d6</li> <li>\u4ece\u76ee\u6807\u4e2d\u6293\u53d6\u54ea\u4e9b\u6307\u5b9a\u7684\u5e8f\u5217\u6837\u672c\uff0c\u6216\u5c06\u5176\u53d1\u9001\u5230\u8fdc\u7a0b\u5b58\u50a8</li> <li>\u54ea\u4e9b\u62a5\u8b66\u8981\u53d1\u9001\u5230 Alertmanager</li> </ul> <p>\u4e00\u4e2a <code>keep</code> \u52a8\u4f5c\u7684\u914d\u7f6e\u89c4\u5219\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>action: keep\nsource_labels: [&lt;source label name list&gt;]\nseparator: &lt;source labels separator&gt; # \u9ed8\u8ba4\u4e3a ';'\nregex: &lt;regular expression&gt; # \u9ed8\u8ba4\u4e3a '(.*)' (\u5339\u914d\u4efb\u4f55\u503c)\n</code></pre> <p><code>keep</code> \u64cd\u4f5c\u540c\u6837\u6309\u987a\u5e8f\u6267\u884c\u5982\u4e0b\u6b65\u9aa4\uff1a</p> <ul> <li>\u4f7f\u7528 <code>separator</code> \u5206\u9694\u7b26\u5c06 <code>source_labels</code> \u4e2d\u5217\u51fa\u7684\u6807\u7b7e\u503c\u8fde\u63a5\u8d77\u6765</li> <li>\u6d4b\u8bd5 regex \u4e2d\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u662f\u5426\u4e0e\u4e0a\u4e00\u6b65\u7684\u8fde\u63a5\u5b57\u7b26\u4e32\u5339\u914d</li> <li>\u5982\u679c\u4e0d\u5339\u914d\uff0c\u8be5\u5bf9\u8c61\u5c06\u4ece\u6700\u7ec8\u8f93\u51fa\u5217\u8868\u4e2d\u5220\u9664</li> <li>\u5982\u679c\u5339\u914d\uff0c\u5219\u4fdd\u7559\u8be5\u5bf9\u8c61</li> </ul> <p>drop \u52a8\u4f5c\u548c keep \u7c7b\u4f3c\uff0c\u53ea\u662f\u5b83\u662f\u5220\u9664\u4e00\u4e2a\u5bf9\u8c61\u800c\u4e0d\u662f\u4fdd\u7559\u3002</p> <p>\u540c\u6837\u63a5\u4e0b\u6765\u770b\u4e00\u770b keep \u548c drop \u7684\u793a\u4f8b\u3002</p> <p>\u53ea\u6293\u53d6\u5177\u6709\u6ce8\u89e3\u7684\u76ee\u6807</p> <p>\u5728\u670d\u52a1\u53d1\u73b0\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u80fd\u53ea\u60f3\u6293\u53d6\u90a3\u4e9b\u5177\u6709\u7279\u5b9a\u5143\u6570\u636e\u6807\u7b7e\u7684\u76ee\u6807\uff0c\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u914d\u7f6e\u8ba9\u6211\u4eec\u53ea\u6293\u53d6 Kubernetes \u4e2d\u5177\u6709 <code>example.io/should_be_scraped=true</code> \u8fd9\u4e2a annotation \u7684\u76ee\u6807\u3002</p> <pre><code>action: keep\nsource_labels:\n  [__meta_kubernetes_service_annotation_example_io_should_be_scraped]\nregex: true\n</code></pre> <p>Kubernetes \u670d\u52a1\u53d1\u73b0\u673a\u5236\u4e0b\u9762\u4f1a\u5c06 labels \u6807\u7b7e\u4e0e annotation \u4f5c\u4e3a\u5143\u4fe1\u606f\u8f93\u51fa\u5230 Prometheus\uff0c\u8fd9\u4e9b\u5143\u4fe1\u606f\u90fd\u5305\u542b <code>__meta_</code> \u524d\u7f00\uff0c\u8fd9\u91cc\u6211\u4eec\u7684\u914d\u7f6e\u5c31\u662f\u4fdd\u7559\u5177\u6709 <code>example.io/should_be_scraped</code>\u8fd9\u4e2a <code>annotation</code> \u6807\u7b7e\uff0c\u4e14\u503c\u4e3a true \u7684\u76ee\u6807\u3002</p> <p>\u53ea\u5b58\u50a8\u7279\u5b9a\u7684\u6307\u6807</p> <p>\u5f53\u4f7f\u7528 <code>metric_relabel_configs</code>\u6765\u63a7\u5236\u76ee\u6807\u7684\u6293\u53d6\u65b9\u5f0f\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u89c4\u5219\u6765\u53ea\u5b58\u50a8\u6307\u6807\u540d\u79f0\u4ee5 <code>api_</code> \u6216 <code>http_</code> \u5f00\u5934\u7684\u6307\u6807\u3002</p> <pre><code>action: keep\nsource_labels: [__name__]\nregex: \"(api_|http_).*\"\n</code></pre>"},{"location":"chap5/52Prometheus_Relabeling/#2-2","title":"2-2 \u6807\u7b7e\u6620\u5c04","text":"<p>\u6709\u65f6\u6211\u4eec\u53ef\u80fd\u60f3\u628a\u6e90\u6807\u7b7e\u7684\u503c\u6620\u5c04\u5230\u4e00\u7ec4\u65b0\u7684\u6807\u7b7e\u4e2d\u53bb\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>labelmap</code> \u8fd9\u4e2a\u52a8\u4f5c\u4e86\u3002</p> <p><code>labelmap</code> \u6700\u5e38\u7528\u7684\u4f7f\u7528\u573a\u666f\u5c31\u662f\u4ece\u670d\u52a1\u53d1\u73b0\u4e2d\u83b7\u53d6\u4e00\u7ec4\u9690\u85cf\u7684\u6216\u4e34\u65f6\u7684\u5143\u6570\u636e\u6807\u7b7e\uff0c\u5e76\u5c06\u5b83\u4eec\u6620\u5c04\u5230\u65b0\u7684\u76ee\u6807\u6807\u7b7e\u4e2d\u3002</p> <p>labelmap \u52a8\u4f5c\u7684\u914d\u7f6e\u89c4\u5219\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>action: labelmap\nregex: &lt;regular expression&gt; # \u9ed8\u8ba4\u4e3a '(.*)'\nreplacement: &lt;replacement string&gt; # \u9ed8\u8ba4\u4e3a '$1'\n</code></pre> <p>\u548c\u524d\u9762\u7684\u4e00\u4e9b action \u4e0d\u540c\uff0c<code>labelmap</code> \u662f\u5bf9\u6807\u7b7e\u540d\u800c\u4e0d\u662f\u6807\u7b7e\u503c\u8fdb\u884c\u91cd\u65b0\u5339\u914d\u548c\u64cd\u4f5c\u3002<code>labelmap</code> \u6309\u987a\u5e8f\u6267\u884c\u4ee5\u4e0b\u6b65\u9aa4\uff1a</p> <ul> <li>\u5c06 regex \u4e2d\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6240\u6709\u6807\u7b7e\u540d\u8fdb\u884c\u5339\u914d</li> <li>\u5c06\u5339\u914d\u7684\u6807\u7b7e\u540d\u7684\u4efb\u4f55\u5339\u914d\u503c\u590d\u5236\u5230\u7531 replacement \u5b57\u7b26\u4e32\u51b3\u5b9a\u7684\u65b0\u7684\u6807\u7b7e\u540d\u4e2d</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u770b\u4e00\u4e2a\u4f7f\u7528 labelmap \u6620\u5c04 Kubernetes Service \u6807\u7b7e\u7684\u793a\u4f8b\u3002\u5f53\u4f7f\u7528\u57fa\u4e8e Kubernetes \u7684\u670d\u52a1\u53d1\u73b0\u6765\u53d1\u73b0 pod \u7aef\u70b9\u65f6\uff0c\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6bcf\u4e2a\u7aef\u70b9\u7684\u6700\u7ec8\u76ee\u6807\u6807\u7b7e\u4e5f\u5305\u542b Kubernetes Service \u6807\u7b7e\uff0c\u8fd9\u6837\u53ef\u4ee5\u66f4\u597d\u7684\u533a\u5206\u7aef\u70b9\u6570\u636e\u3002Kubernetes \u670d\u52a1\u53d1\u73b0\u673a\u5236\u4f1a\u5c06\u8fd9\u4e9b\u6807\u7b7e\u6dfb\u52a0\u5230 Prometheus \u4e2d\u53bb\uff0c\u6807\u7b7e\u540d\u79f0\u683c\u5f0f\u4e3a <code>__meta_kubernetes_service_label_&lt;labelname&gt;</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u63d0\u53d6\u8fd9\u4e9b\u5143\u6570\u636e\u6807\u7b7e\u4e2d\u7684 <code>&lt;labelname&gt;</code> \u90e8\u5206\uff0c\u5e76\u5c06\u76f8\u5e94\u7684\u6807\u7b7e\u503c\u6620\u5c04\u5230\u4e00\u7ec4\u4ee5 <code>k8s_</code> \u4e3a\u524d\u7f00\u7684\u65b0\u6807\u7b7e\u540d\u79f0\u4e0a\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>action: labelmap\nregex: __meta_kubernetes_service_label_(.+)\nreplacement: \"k8s_$1\"\n</code></pre> <p>\u901a\u8fc7\u4e0a\u9762\u7684 labelmap \u64cd\u4f5c\uff0c<code>regex</code> \u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u5339\u914d\u6807\u7b7e\u540d\uff0c\u7136\u540e\u5c06\u6807\u7b7e\u540d\u5bf9\u5e94\u7684\u503c\u590d\u5236\u5230 <code>k8s_$1</code> \u7684\u65b0\u6807\u7b7e\u4e2d\uff0c<code>$1</code> \u5c31\u662f\u5339\u914d\u7684\u6807\u7b7e\u540d\u8fd9\u4e2a\u6355\u83b7\u7ec4\u3002</p>"},{"location":"chap5/52Prometheus_Relabeling/#2-3","title":"2-3 \u4fdd\u7559\u6216\u5220\u9664\u6807\u7b7e","text":"<p>\u6709\u7684\u65f6\u5019\u6211\u4eec\u4e5f\u6709\u4fdd\u7559\u6216\u5220\u9664\u4e00\u4e9b\u6807\u7b7e\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u6709\u7684\u76ee\u6807\u5728\u65f6\u95f4\u5e8f\u5217\u4e0a\u63d0\u4f9b\u4e86\u8bb8\u591a\u989d\u5916\u7684\u6807\u7b7e\uff0c\u8fd9\u4e9b\u6807\u7b7e\u7528\u9014\u4e0d\u5927\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 labelkeep \u548c labeldrop \u8fd9\u4e24\u4e2a\u64cd\u4f5c\uff0c\u4f7f\u7528\u8fd9\u4e24\u4e2a\u64cd\u4f5c\u53ef\u4ee5\u6709\u9009\u62e9\u5730\u4fdd\u7559\u6216\u5220\u9664\u4e00\u4e9b\u6807\u7b7e\u3002</p> <p><code>labelkeep</code> \u7684\u914d\u7f6e\u89c4\u5219\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>action: labelkeep\nregex: &lt;regular expression&gt; # \u9ed8\u8ba4\u4e3a'(.*)'\n</code></pre> <ul> <li>\u9996\u5148\u5c06 regex \u4e2d\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u6240\u6709\u6807\u7b7e\u540d\u79f0\u8fdb\u884c\u5339\u914d</li> <li>\u5b83\u53ea\u4fdd\u7559\u90a3\u4e9b\u5339\u914d\u7684\u6807\u7b7e</li> </ul> <p><code>labeldrop</code> \u4e0e <code>labelkeep</code> \u7c7b\u4f3c\uff0c\u53ea\u662f\u5b83\u662f\u5220\u9664\u90a3\u4e9b\u5339\u914d\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u6807\u7b7e\u800c\u4e0d\u662f\u4fdd\u7559\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u770b\u4e00\u770b <code>labelkeep/labeldrop</code> \u64cd\u4f5c\u7684\u7b80\u5355\u793a\u4f8b\u3002</p> <p>\u4ece\u62a5\u8b66\u4e2d\u5220\u9664\u9ad8\u53ef\u7528\u526f\u672c\u6807\u7b7e</p> <p>\u5f53\u8fd0\u884c\u4e24\u4e2a\u76f8\u540c\u7684 Prometheus \u4f5c\u9ad8\u53ef\u7528\u7684\u65f6\u5019\uff0c\u901a\u5e38\u4e24\u4e2a\u670d\u52a1\u5668\u90fd\u88ab\u914d\u7f6e\u4e3a\u6709\u4e00\u4e2a\u5916\u90e8\u6807\u7b7e\uff08\u901a\u8fc7\u5168\u5c40\u914d\u7f6e\u9009\u9879 <code>external_labels</code>\uff09\uff0c\u8868\u660e\u5b83\u4eec\u4ee3\u8868\u54ea\u4e2a\u526f\u672c\uff0c\u4f8b\u5982\uff1a<code>replica: A</code> \u548c <code>replica: B</code>\uff0c\u5728\u4ece\u4e24\u4e2a\u526f\u672c\u5411\u540c\u4e00\u4e2a <code>Alertmanager</code> \u5b9e\u4f8b\u53d1\u9001\u62a5\u8b66\u4e4b\u524d\uff0c<code>Prometheus</code> \u9700\u8981\u5220\u9664\u8fd9\u4e2a\u526f\u672c\u6807\u7b7e\uff0c\u8fd9\u6837 Alertmanager \u5c31\u4e0d\u4f1a\u628a\u6536\u5230\u7684\u62a5\u8b66\u770b\u6210\u4e0d\u540c\u7684\u62a5\u8b66\u4e86\uff0c\u5426\u5219\u53ef\u80fd\u6211\u4eec\u4f1a\u6536\u5230\u4e24\u4e2a\u540c\u6837\u7684\u62a5\u8b66\u901a\u77e5\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 labeldrop \u6765\u5b9e\u73b0\u8fd9\u4e2a\u64cd\u4f5c\u3002</p> <pre><code>action: labeldrop\nregex: replica\n</code></pre> <p>\u8fd9\u6761\u914d\u7f6e\u89c4\u5219\u5f88\u7b80\u5355\u7684\uff0c\u5c31\u662f\u5339\u914d replica \u8fd9\u4e2a\u6807\u7b7e\uff0c\u7136\u540e\u6267\u884c labeldrop \u5220\u9664\u6807\u7b7e\u52a8\u4f5c\u5373\u53ef\u3002</p> <p>\u5220\u9664\u6307\u6807\u4e2d\u4e0d\u9700\u8981\u7684\u6807\u7b7e</p> <p>\u6709\u7684\u65f6\u5019\u6211\u4eec\u6293\u53d6\u7684\u6307\u6807\u5728\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u4e0a\u90fd\u9644\u52a0\u4e86\u4e00\u4e9b\u989d\u5916\u7684\u6807\u7b7e\uff0c\u8fd9\u4e9b\u6807\u7b7e\u5bf9\u4e8e\u6211\u4eec\u6765\u8bf4\u7528\u5904\u4e0d\u5927\uff0c\u8fd8\u4f1a\u589e\u52a0 Prometheus \u7684\u5b58\u50a8\u538b\u529b\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u60f3\u529e\u6cd5\u5220\u9664\u4e0d\u9700\u8981\u7684\u989d\u5916\u6807\u7b7e\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u60f3\u8981\u5220\u9664\u4e00 <code>info_</code> \u5f00\u5934\u7684\u6807\u7b7e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u914d\u7f6e\u89c4\u5219\u6765\u5b8c\u6210\u3002</p> <pre><code>action: labeldrop\nregex: info_.*\n</code></pre> <p>\u540c\u6837\u4e5f\u53ea\u662f\u914d\u7f6e\u4e00\u4e2a\u8981\u5220\u9664\u7684\u76ee\u6807\u6807\u7b7e\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u5373\u53ef\uff0c\u53ea\u8981\u5339\u914d\u4e86\u7684\u6807\u7b7e\u90fd\u4f1a\u6267\u884c <code>labeldrop</code> \u64cd\u4f5c\u5c06\u8be5\u6807\u7b7e\u8fdb\u884c\u5220\u9664\u3002</p>"},{"location":"chap5/52Prometheus_Relabeling/#2-4","title":"2-4 \u6807\u7b7e\u54c8\u5e0c\u548c\u5206\u7247","text":"<p>\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\u6211\u4eec\u53ef\u80fd\u9700\u8981\u8fd0\u884c\u591a\u4e2a\u51e0\u4e4e\u76f8\u540c\u7684 Prometheus \u526f\u672c\u6765\u6a2a\u5411\u6269\u5c55\uff0c\u6bcf\u4e2a\u526f\u672c\u53ea\u6293\u53d6\u90e8\u5206\u76ee\u6807\uff0c\u8fd9\u6837\u53ef\u4ee5\u964d\u4f4e Prometheus \u7684\u538b\u529b\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b hashmod \u64cd\u4f5c\u6709\u52a9\u4e8e\u6211\u4eec\u5bf9\u76ee\u6807\u8fdb\u884c\u5206\u7247\u64cd\u4f5c\u3002</p> <p>hashmod \u7684\u914d\u7f6e\u89c4\u5219\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>action: hashmod\nsource_labels: [&lt;source label name list&gt;]\nmodulus: &lt;modulus value&gt;\ntarget_label: &lt;target label&gt;\n</code></pre> <p>\u8be5\u64cd\u4f5c\u6309\u987a\u5e8f\u6267\u884c\u4e0b\u9762\u7684\u6b65\u9aa4\uff1a</p> <ul> <li>\u9996\u5148\u4f7f\u7528\u5206\u9694\u7b26\u5c06\u6e90\u6807\u7b7e\u96c6 <code>source_labels</code> \u7684\u503c\u8fde\u63a5\u8d77\u6765</li> <li>\u8ba1\u7b97\u8fde\u63a5\u540e\u7684\u5b57\u7b26\u4e32\u7684\u54c8\u5e0c\u503c</li> <li>\u5c06 <code>modulus</code> \u4e2d\u63d0\u4f9b\u7684\u6a21\u6570\u5e94\u7528\u4e8e\u54c8\u5e0c\u503c\uff0c\u4ee5\u5c06\u54c8\u5e0c\u503c\u9650\u5236\u5728 0 \u548c<code>modulus-1</code>\u4e4b\u95f4</li> <li>\u5c06\u4e0a\u4e00\u6b65\u7684\u6a21\u6570\u503c\u5b58\u50a8\u5728 <code>target_label</code> \u76ee\u6807\u6807\u7b7e\u4e2d</li> </ul> <p>\u4f7f\u7528 hashmod \u7684\u4e3b\u8981\u573a\u666f\u662f\u5c06\u4e00\u4e2a\u670d\u52a1\u7684\u6574\u4f53\u76ee\u6807\u8fdb\u884c\u5206\u7247\uff0c\u7528\u4e8e\u6c34\u5e73\u6269\u5c55 <code>Prometheus</code>\uff0c\u901a\u8fc7\u9996\u5148\u6839\u636e\u6bcf\u4e2a\u76ee\u6807\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u6807\u7b7e\u8ba1\u7b97\u57fa\u4e8e\u54c8\u5e0c\u7684\u6a21\u6570\u6765\u5b9e\u73b0\u7684\uff0c\u7136\u540e\u53ea\u4fdd\u7559\u5177\u6709\u7279\u5b9a\u8f93\u51fa\u6a21\u6570\u503c\u7684\u76ee\u6807\u3002</p> <p>\u6bd4\u5982\u4e3a\u4e86\u6839\u636e instance \u6807\u7b7e\u5bf9\u76ee\u6807\u8fdb\u884c\u5206\u7247\uff0c\u53ea\u4fdd\u7559\u5206\u7247 2 \u7684\u5b9e\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u628a <code>hashmod</code> \u548c keep \u7ed3\u5408\u8d77\u6765\u64cd\u4f5c\u3002</p> <pre><code>- action: hashmod\n  source_labels: [instance]\n  modulus: 10\n  target_label: __tmp_hashmod\n- action: keep\n  source_labels: [__tmp_hashmod]\n  regex: 2\n</code></pre> <p>\u9996\u5148\u901a\u8fc7 hashmod \u64cd\u4f5c\u5bf9 instance \u6807\u7b7e\u8fdb\u53bb\u54c8\u5e0c\u64cd\u4f5c\uff0c\u5c06\u53d6\u6a21\u540e\u7684\u503c\u5b58\u50a8\u5728\u4e34\u65f6\u6807\u7b7e <code>__tmp_hashmod</code> \u4e2d\uff0c\u7136\u540e\u901a\u8fc7\u7b2c\u4e8c\u4e2a <code>keep</code> \u64cd\u4f5c\uff0c\u53ea\u4fdd\u7559\u5206\u7247\u6570\u4e3a 2 \u7684\u6307\u6807\uff0c\u8fd9\u6837\u5c31\u8fbe\u5230\u4e86\u5206\u7247\u7684\u76ee\u7684\u3002</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u57fa\u672c\u4e0a\u5c31\u4e86\u89e3\u4e86 relabeling \u7684\u4f7f\u7528\uff0c\u540e\u7eed\u6211\u4eec\u53ef\u4ee5\u518d\u53bb\u4e86\u89e3\u670d\u52a1\u53d1\u73b0\u5728 Prometheus \u4e2d\u7684\u4f7f\u7528\u3002</p>"},{"location":"chap5/53Prometheus_auto_discovery/","title":"\u7b2c\u4e00\u8282 Prometheus \u670d\u52a1\u7684\u81ea\u52a8\u53d1\u73b0\u4f7f\u7528","text":"<p>\u672c\u6587\u6211\u4eec\u5c06\u5b66\u4e60 Prometheus \u4e2d\u662f\u5982\u4f55\u4f7f\u7528\u670d\u52a1\u53d1\u73b0\u6765\u67e5\u627e\u548c\u6293\u53d6\u76ee\u6807\u7684\u3002</p> <p>\u6211\u4eec\u77e5\u9053\u5728 Prometheus \u914d\u7f6e\u6587\u4ef6\u4e2d\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e2a <code>static_configs</code> \u6765\u914d\u7f6e\u9759\u6001\u7684\u6293\u53d6\u4efb\u52a1\uff0c\u4f46\u662f\u5728\u4e91\u73af\u5883\u4e0b\uff0c\u7279\u522b\u662f\u5bb9\u5668\u73af\u5883\u4e0b\uff0c\u6293\u53d6\u76ee\u6807\u5730\u5740\u662f\u7ecf\u5e38\u53d8\u52a8\u7684\uff0c\u6240\u4ee5\u7528\u9759\u6001\u7684\u65b9\u5f0f\u5c31\u4e0d\u80fd\u6ee1\u8db3\u8fd9\u4e9b\u573a\u666f\u4e86\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u76d1\u63a7\u7cfb\u7edf\u80fd\u591f\u52a8\u6001\u611f\u77e5\u8fd9\u4e2a\u53d8\u5316\uff0c\u4e0d\u53ef\u80fd\u6bcf\u6b21\u53d8\u52a8\u90fd\u53bb\u624b\u52a8\u91cd\u65b0\u914d\u7f6e\u7684\uff0c\u4e3a\u4e86\u5e94\u5bf9\u590d\u6742\u7684\u52a8\u6001\u73af\u5883\uff0cPrometheus \u4e5f\u63d0\u4f9b\u4e86\u4e0e\u57fa\u7840\u8bbe\u65bd\u4e2d\u7684\u670d\u52a1\u53d1\u73b0\u96c6\u6210\u7684\u529f\u80fd\u3002</p> <p></p> <p>Prometheus \u5df2\u7ecf\u652f\u6301\u591a\u79cd\u5185\u7f6e\u7684\u670d\u52a1\u53d1\u73b0\u673a\u5236\uff1a</p> <ul> <li>\u53d1\u73b0\u4e91\u670d\u52a1\u5546\u7684 VM \u865a\u62df\u673a</li> <li>Kubernetes \u4e0a\u7684\u81ea\u52a8\u53d1\u73b0</li> <li>\u901a\u7528\u7684\u670d\u52a1\u67e5\u627e\uff0c\u4f8b\u5982 DNS\u3001Consul\u3001Zookeeper \u6216\u81ea\u5b9a\u4e49\u53d1\u73b0\u673a\u5236</li> </ul> <p>\u6211\u4eec\u90fd\u53ef\u4ee5\u901a\u8fc7 Prometheus \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 <code>scrape_config</code> \u90e8\u5206\u8fdb\u884c\u914d\u7f6e\uff0cPrometheus \u4f1a\u4e0d\u65ad\u66f4\u65b0\u52a8\u6001\u7684\u6293\u53d6\u76ee\u6807\u5217\u8868\uff0c\u81ea\u52a8\u505c\u6b62\u6293\u53d6\u65e7\u7684\u5b9e\u4f8b\uff0c\u5f00\u59cb\u6293\u53d6\u65b0\u7684\u5b9e\u4f8b\uff0cPrometheus \u7279\u522b\u9002\u5408\u8fd0\u884c\u4e8e Kubernetes \u96c6\u7fa4\u4e0b\u9762\uff0c\u53ef\u4ee5\u81ea\u52a8\u53d1\u73b0\u76d1\u63a7\u76ee\u6807\u3002</p> <p>\u6b64\u5916\u5927\u90e8\u5206\u670d\u52a1\u53d1\u73b0\u673a\u5236\u8fd8\u4f1a\u63d0\u4f9b\u76ee\u6807\u7684\u4e00\u4e9b\u5143\u6570\u636e\uff0c\u901a\u5e38\u90fd\u662f\u5e26\u6709 <code>__</code> \u7684\u524d\u7f00\uff0c \u6bd4\u5982\u6807\u7b7e\u3001\u6ce8\u89e3\u3001\u670d\u52a1\u540d\u7b49\u7b49\uff0c\u53ef\u4ee5\u5728 <code>relabeling</code> \u9636\u6bb5\u4f7f\u7528\u8fd9\u4e9b\u5143\u6570\u636e\u6765\u8fc7\u6ee4\u4fee\u6539\u76ee\u6807\uff0c\u8fd9\u4e9b\u5143\u4fe1\u606f\u6807\u7b7e\u5728\u91cd\u65b0\u6807\u8bb0\u9636\u6bb5\u540e\u88ab\u5220\u9664\u3002</p>"},{"location":"chap5/53Prometheus_auto_discovery/#1-consul","title":"1\u3001\u57fa\u4e8e Consul \u7684\u670d\u52a1\u53d1\u73b0","text":"<p>Consul \u662f\u7531 HashiCorp \u5f00\u53d1\u7684\u4e00\u4e2a\u652f\u6301\u591a\u6570\u636e\u4e2d\u5fc3\u7684\u5206\u5e03\u5f0f\u670d\u52a1\u53d1\u73b0\u548c\u952e\u503c\u5bf9\u5b58\u50a8\u670d\u52a1\u7684\u5f00\u6e90\u8f6f\u4ef6\uff0c\u662f\u4e00\u4e2a\u901a\u7528\u7684\u670d\u52a1\u53d1\u73b0\u548c\u6ce8\u518c\u4e2d\u5fc3\u5de5\u5177\uff0c\u88ab\u5927\u91cf\u5e94\u7528\u4e8e\u57fa\u4e8e\u5fae\u670d\u52a1\u7684\u8f6f\u4ef6\u67b6\u6784\u5f53\u4e2d\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5c1d\u8bd5\u4f7f\u7528 Prometheus \u57fa\u4e8e Consul \u7684\u670d\u52a1\u53d1\u73b0\u6765\u76d1\u63a7\u524d\u9762\u7684 3 \u4e2a demo \u670d\u52a1\uff1a</p> <pre><code>192.168.31.46:10000\n192.168.31.46:10001\n192.168.31.46:10002\n</code></pre> <p>\u6211\u4eec\u5c06 demo \u670d\u52a1\u6ce8\u518c\u5230 Consul\uff0c\u7136\u540e\u914d\u7f6e Prometheus \u4ece Consul \u4e2d\u53d1\u73b0\u6f14\u793a\u670d\u52a1\u5b9e\u4f8b\uff0c\u5e76\u4f7f\u7528 <code>Relabeling</code> \u64cd\u4f5c\u6765\u8fc7\u6ee4\u8c03\u6574\u76ee\u6807\u6807\u7b7e\u3002</p> <p>\u5173\u4e8e Consul \u672c\u8eab\u7684\u4f7f\u7528\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 https://learn.hashicorp.com/consul \u4e86\u89e3\u66f4\u591a\u3002</p> <p></p>"},{"location":"chap5/53Prometheus_auto_discovery/#1-1-consul","title":"1-1 \u5b89\u88c5\u914d\u7f6e Consul","text":"<p>\u5728\u9875\u9762 https://www.consul.io/downloads \u4e0b\u8f7d\u7b26\u5408\u81ea\u5df1\u7cfb\u7edf\u7684\u5b89\u88c5\u6587\u4ef6\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u662f Linux \u7cfb\u7edf\uff0c\u4f7f\u7528\u4e0b\u9762\u547d\u4ee4\u4e0b\u8f7d\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code>$ wget https://releases.hashicorp.com/consul/1.10.2/consul_1.10.2_linux_amd64.zip\n$ unzip consul_1.10.2_linux_amd64.zip\n\n# \u5c06 consul \u4e8c\u8fdb\u5236\u79fb\u52a8\u5230 PATH \u8def\u5f84\u4e0b\u53bb\n\n$ mv consul /usr/local/bin\n\n$ consul version\nConsul v1.10.2\nRevision 3cb6eeedb\nProtocol 2 spoken by default, understands 2 to 3 (agent will automatically use protocol &gt;2 when speaking to compatible agents)\n</code></pre> <p>\u5f53\u6267\u884c <code>consul</code> \u547d\u4ee4\u540e\u6b63\u5e38\u6709\u547d\u4ee4\u63d0\u793a\uff0c\u8bc1\u660e\u5df2\u7ecf\u5b89\u88c5\u5b8c\u6210\u3002</p> <p>\u63a5\u7740\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e\u6ce8\u518c demo \u670d\u52a1\u7684 Consul \u914d\u7f6e\u6587\u4ef6 <code>demo-service.json</code>\uff1a</p> <pre><code>{\n  \"services\": [\n    {\n      \"id\": \"demo1\",\n      \"name\": \"demo\",\n      \"address\": \"192.168.31.46\",\n      \"port\": 10000,\n      \"meta\": {\n        \"env\": \"production\"\n      },\n      \"checks\": [\n        {\n          \"http\": \"http://192.168.31.46:10000/api/foo\",\n          \"interval\": \"1s\"\n        }\n      ]\n    },\n    {\n      \"id\": \"demo2\",\n      \"name\": \"demo\",\n      \"address\": \"192.168.31.46\",\n      \"port\": 10001,\n      \"meta\": {\n        \"env\": \"production\"\n      },\n      \"checks\": [\n        {\n          \"http\": \"http://192.168.31.46:10001/api/foo\",\n          \"interval\": \"1s\"\n        }\n      ]\n    },\n    {\n      \"id\": \"demo3\",\n      \"name\": \"demo\",\n      \"address\": \"192.168.31.46\",\n      \"port\": 10002,\n      \"meta\": {\n        \"env\": \"staging\"\n      },\n      \"checks\": [\n        {\n          \"http\": \"http://192.168.31.46:10002/api/foo\",\n          \"interval\": \"1s\"\n        }\n      ]\n    }\n  ]\n}\n</code></pre> <p>\u5f53\u7136\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u4e5f\u662f\u5728 Consul \u4e2d\u8fdb\u884c\u52a8\u6001\u6ce8\u518c\u670d\u52a1\uff0c\u4f46\u662f\u8fd9\u91cc\u6211\u4eec\u53ea\u662f\u7b80\u5355\u6f14\u793a Prometheus \u57fa\u4e8e Consul \u7684\u670d\u52a1\u53d1\u73b0\uff0c\u8fd9\u91cc\u53ea\u4f7f\u7528 Consul \u914d\u7f6e\u6587\u4ef6\u9759\u6001\u6ce8\u518c\u670d\u52a1\u5373\u53ef\u3002</p> <p><code>Consul</code> \u5141\u8bb8\u4f7f\u7528 JSON \u4e2d\u7684 <code>meta</code> \u5c5e\u6027\u5c06 <code>key-value</code> \u5143\u6570\u636e\u4e0e\u6bcf\u4e2a\u6ce8\u518c\u7684\u670d\u52a1\u5b9e\u4f8b\u76f8\u5173\u8054\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u7684 <code>env</code> \u5c5e\u6027\u548c\u90e8\u7f72\u73af\u5883 <code>production</code> \u6216 <code>staging</code> \u8fdb\u884c\u5173\u8054\uff0c\u540e\u9762\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 <code>Prometheus</code> \u91cc\u9762\u7684 <code>Relabeling</code> \u64cd\u4f5c\u63d0\u53d6\u8be5\u5b57\u6bb5\u5e76\u5c06\u5176\u6620\u5c04\u5230\u6bcf\u4e2a\u6293\u53d6\u5b9e\u4f8b\u7684\u6807\u7b7e\u4e2d\u53bb\u3002</p> <p>\u4e3a\u4e86\u67e5\u770b\u66f4\u591a\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 dev \u6a21\u5f0f\u4e0b\u8fd0\u884c Consul\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>\u2638 \u279c consul agent -dev -config-file=demo-service.json -client 0.0.0.0\n==&gt; Starting Consul agent...\n           Version: '1.10.2'\n           Node ID: 'a4a9418c-7f7d-a2da-c81e-94d3d37601aa'\n         Node name: 'node2'\n        Datacenter: 'dc1' (Segment: '&lt;all&gt;')\n            Server: true (Bootstrap: false)\n       Client Addr: [0.0.0.0] (HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600)\n      Cluster Addr: 127.0.0.1 (LAN: 8301, WAN: 8302)\n           Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false, Auto-Encrypt-TLS: false\n\n==&gt; Log data will now stream in as it occurs:\n......\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5728\u542f\u52a8\u547d\u4ee4\u540e\u9762\u4f7f\u7528 <code>-client</code> \u53c2\u6570\u6307\u5b9a\u4e86\u5ba2\u6237\u7aef\u7ed1\u5b9a\u7684 IP \u5730\u5740\uff0c\u9ed8\u8ba4\u4e3a <code>127.0.0.1</code>\u3002\u9664\u4e86\u6211\u4eec\u6ce8\u518c\u7684 3 \u4e2a demo \u670d\u52a1\u4e4b\u5916\uff0c<code>Consul agent</code> \u8fd8\u4f1a\u5c06\u81ea\u5df1\u6ce8\u518c\u4e3a\u4e00\u4e2a\u540d\u4e3a consul \u7684\u670d\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee <code>http://&lt;nodeip&gt;:8500</code> \u67e5\u770b\u6ce8\u518c\u7684\u670d\u52a1\u3002</p> <p></p> <p>\u5728 Consul UI \u9875\u9762\u4e2d\u53ef\u4ee5\u770b\u5230\u6709 consul \u548c demo \u4e24\u4e2a Service \u670d\u52a1\u3002</p>"},{"location":"chap5/53Prometheus_auto_discovery/#1-2-consul","title":"1-2 \u914d\u7f6e Consul \u81ea\u52a8\u53d1\u73b0","text":"<p>\u4e0a\u9762\u6211\u4eec\u901a\u8fc7 Consul \u6ce8\u518c\u4e86 3 \u4e2a demo \u670d\u52a1\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u914d\u7f6e Prometheus \u901a\u8fc7 Consul \u6765\u81ea\u52a8\u53d1\u73b0 demo \u670d\u52a1\u3002</p> <p>\u5728 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6 prometheus.yml \u6587\u4ef6\u4e2d\u7684 scrape_configs \u90e8\u5206\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u6293\u53d6\u914d\u7f6e\uff1a</p> <pre><code>scrape_configs:\n  - job_name: \"consul-sd-demo\"\n    consul_sd_configs:\n      - server: \"localhost:8500\"\n    relabel_configs:\n      - action: keep\n        source_labels: [__meta_consul_service, __meta_consul_health]\n        regex: demo;passing\n      - action: labelmap\n        regex: __meta_consul_service_metadata_(.*)\n        replacement: consul_$1\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e2a\u540d\u4e3a <code>consul-sd-demo</code> \u7684\u6293\u53d6\u4efb\u52a1\uff0c\u901a\u8fc7 <code>consul_sd_configs</code> \u914d\u7f6e\u7528\u4e8e\u81ea\u52a8\u53d1\u73b0\u7684 <code>Consul</code>\u670d\u52a1\u5730\u5740\uff0c\u7136\u540e\u4f7f\u7528 <code>relabel_configs</code> \u8fdb\u884c\u4e86\u91cd\u65b0\u6807\u8bb0\u914d\u7f6e\uff0c</p> <ul> <li>\u9996\u5148\u53ea\u4fdd\u7559\u670d\u52a1\u540d\u79f0\u4e3a <code>demo</code>\uff0c\u4e14\u5065\u5eb7\u72b6\u6001\u4e3a <code>passing</code> \u7684\uff0c\u5426\u5219\u4e5f\u4f1a\u6293\u53d6 <code>Consul Agent</code> \u672c\u8eab\uff0c\u800c\u5b83\u81ea\u8eab\u662f\u4e0d\u63d0\u4f9b <code>metrics</code> \u63a5\u53e3\u6570\u636e\u7684\uff0c</li> <li>\u53e6\u5916\u8fd8\u4f7f\u7528 <code>labelmap</code> \u8fdb\u884c\u4e86\u6807\u7b7e\u6620\u5c04\uff0c\u5c06\u6240\u6709 <code>Consul</code> \u5143\u6807\u7b7e\u6620\u5c04\u5230 Prometheus \u4e2d\u4ee5 <code>consul_</code> \u4e3a\u524d\u7f00\u7684\u6807\u7b7e\u4e2d\u3002</li> </ul> <p>\u914d\u7f6e\u5b8c\u6210\u540e\u91cd\u65b0\u542f\u52a8 Prometheus\uff0c\u7136\u540e\u91cd\u65b0\u67e5\u770b Prometheus \u9875\u9762\u4e0a\u7684 targets \u9875\u9762\uff0c\u9a8c\u8bc1\u4e0a\u9762\u7684\u914d\u7f6e\u662f\u5426\u5b58\u5728\uff1a</p> <p></p> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\u662f\u53ef\u4ee5\u770b\u5230\u4f1a\u6709\u4e00\u4e2a <code>consul-sd-demo</code> \u7684\u4efb\u52a1\uff0c\u4e0b\u9762\u6709 3 \u4e2a\u81ea\u52a8\u53d1\u73b0\u7684\u6293\u53d6\u76ee\u6807\u3002</p> <p>\u6211\u4eec\u5c06\u9f20\u6807\u60ac\u505c\u5728 <code>Labels</code> \u6807\u7b7e\u533a\u57df\u5c31\u53ef\u4ee5\u770b\u5230\u76ee\u6807\u4efb\u52a1\u5728\u91cd\u65b0\u6807\u8bb0 <code>Relabeling</code> \u4e4b\u524d\u7684\u539f\u59cb\u6807\u7b7e\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5c06\u67e5\u770b\u7b2c\u4e00\u4e2a <code>demo</code> \u5b9e\u4f8b\u5728 Relabel \u4e4b\u524d\u5305\u542b\u5982\u4e0b\u6240\u793a\u7684\u8fd9\u4e9b\u539f\u59cb\u6807\u7b7e\uff1a</p> <p></p> <p>\u901a\u8fc7\u67e5\u770b\u7f51\u7edc\u8bf7\u6c42\u63a5\u53e3 <code>http://&lt;promtheus addr&gt;/api/v1/targets?state=active</code> \u4e5f\u53ef\u4ee5\u83b7\u53d6\u5bf9\u5e94\u7684\u539f\u59cb\u6807\u7b7e\u6570\u636e\uff1a</p> <pre><code>{\n  \"discoveredLabels\": {\n    \"__address__\": \"192.168.31.46:10000\",\n    \"__meta_consul_address\": \"127.0.0.1\",\n    \"__meta_consul_dc\": \"dc1\",\n    \"__meta_consul_health\": \"passing\",\n    \"__meta_consul_node\": \"node2\",\n    \"__meta_consul_service\": \"demo\",\n    \"__meta_consul_service_address\": \"192.168.31.46\",\n    \"__meta_consul_service_id\": \"demo1\",\n    \"__meta_consul_service_metadata_env\": \"production\",\n    \"__meta_consul_service_port\": \"10000\",\n    \"__meta_consul_tagged_address_lan\": \"127.0.0.1\",\n    \"__meta_consul_tagged_address_lan_ipv4\": \"127.0.0.1\",\n    \"__meta_consul_tagged_address_wan\": \"127.0.0.1\",\n    \"__meta_consul_tagged_address_wan_ipv4\": \"127.0.0.1\",\n    \"__meta_consul_tags\": \",,\",\n    \"__metrics_path__\": \"/metrics\",\n    \"__scheme__\": \"http\",\n    \"job\": \"consul-sd-demo\"\n  },\n  \"labels\": {\n    \"consul_env\": \"production\",\n    \"instance\": \"192.168.31.46:10000\",\n    \"job\": \"consul-sd-demo\"\n  },\n  \"scrapePool\": \"consul-sd-demo\",\n  \"scrapeUrl\": \"http://192.168.31.46:10000/metrics\",\n  \"globalUrl\": \"http://192.168.31.46:10000/metrics\",\n  \"lastError\": \"\",\n  \"lastScrape\": \"2021-09-28T11:56:01.919216851+08:00\",\n  \"lastScrapeDuration\": 0.013357276,\n  \"health\": \"up\"\n}\n</code></pre> <p>\u6211\u4eec\u5728 <code>relabel_configs</code> \u4e2d\u9996\u5148\u914d\u7f6e\u4e86\u4e00\u4e2a <code>keep</code> \u64cd\u4f5c\uff0c\u53ea\u4fdd\u7559\u539f\u59cb\u6807\u7b7e <code>__meta_consul_service</code> \u503c\u4e3a <code>demo</code>\uff0c\u4e14 <code>__meta_consul_health</code> \u4e3a <code>passing</code> \u72b6\u6001\u7684\u6293\u53d6\u4efb\u52a1\u3002</p> <p>\u7136\u540e\u4f7f\u7528 labelmap \u8fdb\u884c\u6807\u7b7e\u6620\u5c04\uff0c\u8fd9\u91cc\u6211\u4eec\u5c06\u5339\u914d <code>__meta_consul_service_metadata_(.*)</code> \u6240\u6709\u6807\u7b7e\uff0c\u8fd9\u91cc\u53ea\u6709 <code>__meta_consul_service_metadata_env</code> \u8fd9\u4e2a\u539f\u59cb\u6807\u7b7e\u7b26\u5408\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5176\u4e2d\u7684 <code>env</code> \u5c31\u662f\u5339\u914d\u7684\u6355\u83b7\u7ec4\uff0c\u5728 <code>replacement</code> \u4e2d\u7528 <code>$1</code> \u4ee3\u66ff\uff0c\u66ff\u6362\u6210\u6807\u7b7e <code>consul_$1</code>\uff0c\u4e5f\u5c31\u662f <code>consul_env</code>\u8fd9\u4e2a\u6807\u7b7e\u4e86\uff0c\u6240\u4ee5 <code>Relabeling</code> \u8fc7\u540e\u5c31\u53ea\u5269\u4e0b\u4e0b\u9762\u7684\u51e0\u4e2a\u76ee\u6807\u6807\u7b7e\u4e86\uff1a</p> <pre><code>instance: \"192.168.31.46:10000\"\njob: \"consul-sd-demo\"\nconsul_env: \"production\"\n</code></pre> <p>\u5176\u4e2d\u7684 instance \u6807\u7b7e\u662f\u5728\u91cd\u65b0\u6807\u8bb0\u4e4b\u540e\uff0c\u81ea\u52a8\u4ece <code>__address__</code> \u8f6c\u53d8\u800c\u6765\u7684\u3002</p> <p>\u7531\u4e8e\u6ca1\u6709\u91cd\u65b0\u4fee\u6539 <code>__metrics_path__</code>\u548c <code>__scheme__</code> \u6807\u7b7e\uff0c\u6240\u4ee5\u9ed8\u8ba4\u7684\u6293\u53d6\u76ee\u6807\u5c31\u662f\u901a\u8fc7 HTTP \u7aef\u70b9 /metrics \u8fdb\u884c\u6293\u53d6\u3002</p> <p>\u73b0\u5728\u5982\u679c\u6211\u4eec\u5c06 demo1 \u8fd9\u4e2a\u670d\u52a1\u6740\u6389\uff0c\u5219\u5728 Consul \u4e2d\u6ce8\u518c\u7684\u670d\u52a1\u5c31\u4f1a\u51fa\u73b0\u4e00\u4e2a\u4e0d\u5065\u5eb7\u7684\u5b9e\u4f8b\uff1a</p> <p></p> <p>\u5f53\u7136\u6b64\u65f6 Prometheus \u4e2d\u5c31\u53ea\u5269\u4e0b\u4e24\u4e2a\u6b63\u5e38 demo \u670d\u52a1\u7684\u5b9e\u4f8b\u4e86\uff1a</p> <p></p> <p>\u5f53\u670d\u52a1\u6b63\u5e38\u540e\u5c31\u53c8\u53ef\u4ee5\u81ea\u52a8\u53d1\u73b0\u5bf9\u5e94\u7684\u670d\u52a1\u4e86\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u5b8c\u6210\u4e86 Prometheus \u57fa\u4e8e Consul \u7684\u4e00\u4e2a\u7b80\u5355\u7684\u81ea\u52a8\u53d1\u73b0\u914d\u7f6e\u3002</p>"},{"location":"chap5/53Prometheus_auto_discovery/#2","title":"2\u3001\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0","text":"<p>\u9664\u4e86\u57fa\u4e8e Consul \u7684\u670d\u52a1\u53d1\u73b0\u4e4b\u5916\uff0cPrometheus \u4e5f\u5141\u8bb8\u6211\u4eec\u8fdb\u884c\u81ea\u5b9a\u4e49\u7684\u53d1\u73b0\u96c6\u6210\uff0c\u53ef\u4ee5\u901a\u8fc7 watch \u4e00\u7ec4\u672c\u5730\u6587\u4ef6\u6765\u83b7\u53d6\u6293\u53d6\u76ee\u6807\u4ee5\u53ca\u6807\u7b7e\u4fe1\u606f\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0\u65b9\u5f0f\u3002</p> <p></p> <p>\u57fa\u4e8e\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0\u63d0\u4f9b\u4e86\u4e00\u79cd\u66f4\u901a\u7528\u7684\u65b9\u5f0f\u6765\u914d\u7f6e\u9759\u6001\u76ee\u6807\uff0c\u5e76\u4f5c\u4e3a\u4e00\u4e2a\u63a5\u53e3\u63d2\u5165\u81ea\u5b9a\u4e49\u670d\u52a1\u53d1\u73b0\u673a\u5236\u3002</p> <p>\u5b83\u8bfb\u53d6\u4e00\u7ec4\u5305\u542b\u96f6\u4e2a\u6216\u591a\u4e2a <code>&lt;static_config&gt;</code> \u5217\u8868\u7684\u6587\u4ef6\uff0c\u5bf9\u6240\u6709\u5b9a\u4e49\u7684\u6587\u4ef6\u7684\u53d8\u66f4\u901a\u8fc7\u78c1\u76d8\u76d1\u89c6\u88ab\u68c0\u6d4b\u5230\u5e76\u7acb\u5373\u5e94\u7528\uff0c\u6587\u4ef6\u53ef\u4ee5\u4ee5 YAML \u6216 JSON \u683c\u5f0f\u63d0\u4f9b\u3002\u6587\u4ef6\u5fc5\u987b\u5305\u542b\u4e00\u4e2a\u9759\u6001\u914d\u7f6e\u7684\u5217\u8868:</p> <pre><code>JSON json [ { \"targets\": [ \"&lt;host&gt;\", ... ], \"labels\": { \"&lt;labelname&gt;\": \"&lt;labelvalue&gt;\", ... } }, ... ]\n\nYAML yaml - targets: [ - '&lt;host&gt;' ] labels: [ &lt;labelname&gt;: &lt;labelvalue&gt; ... ]\n</code></pre> <p>\u6587\u4ef6\u5185\u5bb9\u4e5f\u4f1a\u5728\u6307\u5b9a\u7684\u5237\u65b0\u95f4\u9694\u65f6\u95f4\u5185\u5b9a\u671f\u91cd\u65b0\u8bfb\u53d6\u3002</p> <pre><code># Patterns for files from which target groups are extracted.\nfiles:\n  [ - &lt;filename_pattern&gt; ... ]\n\n# Refresh interval to re-read the files.\n[ refresh_interval: &lt;duration&gt; | default = 5m ]\n</code></pre> <p>\u5176\u4e2d <code>&lt;filename*pattern&gt;</code> \u53ef\u4ee5\u662f\u4e00\u4e2a\u4ee5<code>.json</code>\u3001<code>.yml</code> \u6216 .<code>yaml</code> \u7ed3\u5c3e\u7684\u8def\u5f84\uff0c\u6700\u540e\u4e00\u4e2a\u8def\u5f84\u6bb5\u53ef\u4ee5\u5305\u542b\u4e00\u4e2a\u5339\u914d\u4efb\u4f55\u5b57\u7b26\u5e8f\u5217\u7684 <code>*</code>\uff0c\u4f8b\u5982\uff1a<code>my/path/tg_*.json</code>\u3002</p>"},{"location":"chap5/53Prometheus_auto_discovery/#2-1","title":"2-1 \u521b\u5efa\u6587\u4ef6","text":"<pre><code>- targets:\n    - \"192.168.31.46:10000\"\n    - \"192.168.31.46:10001\"\n  labels:\n    env: production\n- targets:\n    - \"192.168.31.46:10002\"\n  labels:\n    env: staging\n</code></pre> <p>\u8be5\u6587\u4ef6\u4e2d\u6211\u4eec\u5217\u4e3e\u4e86 3 \u4e2a demo \u670d\u52a1\u5b9e\u4f8b\uff0c\u7ed9\u524d\u4e24\u4e2a\u5b9e\u4f8b\u6dfb\u52a0\u4e0a\u4e86 env=production \u7684\u6807\u7b7e\uff0c\u540e\u9762\u4e00\u4e2a\u52a0\u4e0a\u4e86 <code>env=staging</code> \u7684\u6807\u7b7e\uff0c\u5f53\u7136\u8be5\u6587\u4ef6\u4e5f\u53ef\u4ee5\u4f7f\u7528 JSON \u683c\u5f0f\u8fdb\u884c\u914d\u7f6e\uff1a</p> <pre><code>[\n  {\n    \"targets\": [ \"&lt;host&gt;\", ... ],\n    \"labels\": {\n      \"&lt;labelname&gt;\": \"&lt;labelvalue&gt;\", ...\n    }\n  },\n  ...\n]\n</code></pre> <p>\u5982\u679c\u662f YAML \u6587\u4ef6\u5219\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>\n- targets:\n  [ - '&lt;host&gt;' ]\n  labels:\n    [ &lt;labelname&gt;: &lt;labelvalue&gt; ... ]\n</code></pre>"},{"location":"chap5/53Prometheus_auto_discovery/#2-2","title":"2-2 \u914d\u7f6e\u6587\u4ef6\u670d\u52a1\u53d1\u73b0","text":"<p>\u7528\u4e8e\u53d1\u73b0\u7684\u76ee\u6807\u6587\u4ef6\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u8981\u8ba9 <code>Prometheus</code> \u80fd\u591f\u4ece\u4e0a\u9762\u7684 <code>targets.yml</code> \u6587\u4ef6\u4e2d\u81ea\u52a8\u8bfb\u53d6\u6293\u53d6\u76ee\u6807\uff0c\u9700\u8981\u5728 <code>prometheus.yml</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 <code>scrape_configs</code> \u90e8\u5206\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u6293\u53d6\u914d\u7f6e\uff1a</p> <pre><code>- job_name: \"file-sd-demo\"\n  file_sd_configs:\n    - files:\n        - \"targets.yml\"\n</code></pre> <p>\u91cd\u65b0 <code>reload</code> \u6216\u8005\u91cd\u542f\u4e0b Prometheus \u8ba9\u5176\u91cd\u65b0\u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6\u4fe1\u606f\uff0c\u7136\u540e\u540c\u6837\u524d\u5f80 <code>Prometheus UI</code> \u7684 targets \u9875\u9762\u4e0b\u9762\u67e5\u770b\u662f\u5426\u6709\u4e0a\u9762\u5b9a\u4e49\u7684\u6293\u53d6\u76ee\u6807\u3002</p> <p></p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u6539\u53d8 <code>targets.yml</code>\u7684\u5185\u5bb9\uff0c\u6bd4\u5982\u4e3a\u7b2c\u4e09\u4e2a\u5b9e\u4f8b\u589e\u52a0\u4e00\u4e2a <code>role: sd</code> \u7684\u6807\u7b7e\uff0c\u4e0d\u7528\u91cd\u65b0\u52a0\u8f7d<code>Prometheus</code> \u914d\u7f6e\uff0c<code>Prometheus</code> \u5c06 <code>watch</code> \u8be5\u6587\u4ef6\uff0c\u5e76\u81ea\u52a8\u63a5\u6536\u4efb\u4f55\u53d8\u5316\u3002</p> <p>\u6ce8\u610f\uff1a\u5f53\u5728\u751f\u4ea7\u73af\u5883 Prometheus \u670d\u52a1\u5668\u4e2d\u6539\u53d8 <code>file_sd</code> \u76ee\u6807\u6587\u4ef6\u65f6\uff0c\u9700\u8981\u786e\u4fdd\u6539\u53d8\u662f\u539f\u5b50\u7684\uff0c\u4ee5\u907f\u514d\u91cd\u65b0\u52a0\u8f7d\u51fa\u73b0\u9519\u8bef\uff0c\u6700\u597d\u7684\u65b9\u6cd5\u662f\u5728\u4e00\u4e2a\u5355\u72ec\u7684\u4f4d\u7f6e\u521b\u5efa\u66f4\u65b0\u7684\u6587\u4ef6\uff0c\u7136\u540e\u5c06\u5176\u91cd\u547d\u540d\u4e3a\u76ee\u6807\u6587\u4ef6\u540d\uff08\u4f7f\u7528<code>mv</code> \u547d\u4ee4\u6216 <code>rename()</code> \u7cfb\u7edf\u8c03\u7528\uff09\u3002</p> <p></p> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u57fa\u4e8e\u6587\u4ef6\u7684\u901a\u7528\u670d\u52a1\u53d1\u73b0\u673a\u5236\uff0c\u53ef\u4ee5\u8ba9\u6211\u4eec\u52a8\u6001\u5730\u6539\u53d8 Prometheus \u7684\u76d1\u63a7\u76ee\u6807\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u542f\u52a8\u6216\u91cd\u65b0\u52a0\u8f7d Prometheus \u670d\u52a1\u3002</p> <p>\u5f53\u7136\u9664\u4e86\u57fa\u4e8e Consul \u548c\u6587\u4ef6\u7684\u670d\u52a1\u53d1\u73b0\u4e4b\u5916\uff0c\u66f4\u591a\u7684\u65f6\u5019\u6211\u4eec\u4f1a\u5728 Kubernetes \u73af\u5883\u4e0b\u9762\u4f7f\u7528 Prometheus\uff0c\u7531\u4e8e\u8fd9\u90e8\u5206\u5185\u5bb9\u6bd4\u8f83\u72ec\u7acb\uff0c\u3002</p>"},{"location":"chap5/54prometheus_go_metrics_guideline/","title":"\u7b2c\u4e09\u8282 \u5982\u4f55\u4f7f\u7528 Prometheus \u4eea\u8868\u5316\u5e94\u7528","text":"<p>\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u4e86\u5982\u4f55\u5c06\u5e94\u7528\u7684\u76d1\u63a7\u6307\u6807\u5982\u4f55\u63a5\u5165 Prometheus\uff0c\u4f46\u662f\u5982\u4f55\u5728\u81ea\u5df1\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u66b4\u9732\u76d1\u63a7\u6307\u6807\u5462\uff1f</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u76f4\u63a5\u5728\u5e94\u7528\u4e2d\u96c6\u6210 metrics \u6307\u6807\u6570\u636e\uff0c\u4e5f\u53ef\u4ee5\u5355\u72ec\u5f00\u53d1\u4e00\u4e2a\u5bf9\u5e94\u7684 exporter \u6765\u66b4\u9732\u6307\u6807\uff0c\u6216\u8005\u6839\u636e\u9700\u6c42\u7f16\u5199\u811a\u672c\u63a8\u9001\u5230 pushgateway \u7f51\u5173\u751f\u6210\u76d1\u63a7\u6307\u6807\uff0c\u4e0d\u8fc7\u6700\u597d\u7684\u65b9\u5f0f\u662f\u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u96c6\u6210 Prometheus \u76d1\u63a7\u6307\u6807\u6570\u636e\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u6765\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 Prometheus \u5ba2\u6237\u7aef\u5e93\u6765\u66b4\u9732\u76d1\u63a7\u6307\u6807\uff0c\u4f7f\u7528\u4e00\u4e2a Prometheus Go \u5ba2\u6237\u7aef\u5e93\u6765\u4eea\u8868\u5316\u4e00\u4e2a Go \u5e94\u7528\u7a0b\u5e8f\uff0c\u76f4\u63a5\u5728\u4ee3\u7801\u4e2d\u6dfb\u52a0\u76f8\u5173\u6307\u6807\u4ee5\u83b7\u53d6\u5bf9\u5e94\u7528\u7a0b\u5e8f\u7684\u76d1\u63a7\u80fd\u529b\u3002</p>"},{"location":"chap5/54prometheus_go_metrics_guideline/#1","title":"1\u3001\u6293\u53d6\u6307\u6807","text":"<p>\u6211\u4eec\u5df2\u7ecf\u5f88\u6e05\u695a Prometheus \u662f\u5982\u4f55\u6293\u53d6\u76d1\u63a7\u6307\u6807\u7684\u4e86\uff0cPrometheus \u901a\u8fc7\u4e00\u4e2a HTTP \u8bf7\u6c42\u6293\u53d6\u76d1\u63a7\u76ee\u6807\uff0c\u9ed8\u8ba4\u8bf7\u6c42\u7684\u7aef\u70b9\u540d\u662f <code>/metrics</code>\u3002</p> <p></p> <p>\u76d1\u63a7\u76ee\u6807\u901a\u8fc7\u53d1\u9001\u6bcf\u4e2a\u88ab\u8ddf\u8e2a\u7684\u65f6\u95f4\u5e8f\u5217\u5355\u4e2a\u6837\u672c\uff0c\u4ee5\u53ca\u6837\u672c\u7684\u6307\u6807\u540d\u79f0\u3001\u6807\u7b7e\u96c6\u5408\u548c\u6837\u672c\u503c\u6765\u54cd\u5e94\u6bcf\u4e2a\u6307\u6807\u7684\u5f53\u524d\u72b6\u6001\u3002</p> <p>\u6293\u53d6\u5230\u6570\u636e\u540e Prometheus \u4f1a\u5b58\u50a8\u6bcf\u4e2a\u6837\u672c\uff0c\u5e76\u4e3a\u5176\u6dfb\u52a0\u4e00\u4e2a\u670d\u52a1\u5668\u7aef\u7684\u65f6\u95f4\u6233\uff0c\u4ece\u800c\u4ece\u5355\u4e2a\u6293\u53d6\u6784\u5efa\u6210\u4e00\u7ec4\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u6b64\u5916\u6211\u4eec\u518d\u56de\u987e\u4e0b\u83b7\u53d6\u7684\u76d1\u63a7\u6307\u6807\u683c\u5f0f\uff1a</p> <pre><code># HELP http_requests_total The total number of HTTP requests.\n# TYPE http_requests_total counter\nhttp_requests_total{method=\"post\",code=\"200\"} 1027\nhttp_requests_total{method=\"post\",code=\"400\"}    3\n\n# HELP process_open_fds Number of open file descriptors.\n# TYPE process_open_fds gauge\nprocess_open_fds 15\n\n# HELP http_request_duration_seconds A histogram of the request duration.\n# TYPE http_request_duration_seconds histogram\nhttp_request_duration_seconds_bucket{le=\"0.05\"} 24054\nhttp_request_duration_seconds_bucket{le=\"0.1\"} 33444\nhttp_request_duration_seconds_bucket{le=\"0.2\"} 100392\nhttp_request_duration_seconds_bucket{le=\"0.5\"} 129389\nhttp_request_duration_seconds_bucket{le=\"1\"} 133988\nhttp_request_duration_seconds_bucket{le=\"+Inf\"} 144320\nhttp_request_duration_seconds_sum 53423\nhttp_request_duration_seconds_count 144320\n\n# HELP rpc_duration_seconds A summary of RPC durations in seconds.\n# TYPE rpc_duration_seconds summary\nrpc_duration_seconds{quantile=\"0.01\"} 3.102\nrpc_duration_seconds{quantile=\"0.05\"} 3.272\nrpc_duration_seconds{quantile=\"0.5\"} 4.773\nrpc_duration_seconds{quantile=\"0.9\"} 9.001\nrpc_duration_seconds{quantile=\"0.99\"} 76.656\nrpc_duration_seconds_sum 5.7560473e+04\nrpc_duration_seconds_count 2693\n</code></pre> <p>\u6293\u53d6\u76ee\u6807\u53ea\u4f1a\u66b4\u9732\u5f53\u524d\u8bbf\u95ee\u7684\u503c\uff0c\u800c\u4e0d\u4f1a\u66b4\u9732\u5b83\u6240\u8ddf\u8e2a\u6570\u636e\u6240\u6709\u7684\u5386\u53f2\u6307\u6807\uff0c\u6307\u6807\u4e2d\u7684\u6bcf\u4e00\u884c\uff08\u6ce8\u91ca\u9664\u5916\uff09\u5c31\u662f\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u7684\u6837\u672c\uff0c\u6bcf\u4e2a\u5e8f\u5217\u5728\u540c\u4e00\u4e2a\u6293\u53d6\u4e2d\u53ea\u80fd\u51fa\u73b0\u4e00\u6b21\uff0c\u6240\u4ee5\uff0c\u4eea\u8868\u5316\u5e94\u7528\u53ea\u9700\u8981\u5728\u5185\u5b58\u4e2d\u8ddf\u8e2a\u5176\u6307\u6807\u7684\u5f53\u524d\u72b6\u6001\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u8ddf\u8e2a\u6216\u7f13\u5b58\u4efb\u4f55\u5386\u53f2\u6307\u6807\u72b6\u6001\u3002</p>"},{"location":"chap5/54prometheus_go_metrics_guideline/#2","title":"2\u3001\u5ba2\u6237\u7aef\u5e93","text":"<p>Prometheus \u5b98\u65b9\u5df2\u7ecf\u63d0\u4f9b\u4e86\u4e00\u4e9b\u8bed\u8a00\u7684\u5ba2\u6237\u7aef\u5e93\uff0c\u5305\u62ec Go\u3001Java\u3001Python\u3001Ruby\uff0c\u8fd8\u6709\u4e00\u4e9b\u975e\u5b98\u65b9\u7684\u7b2c\u4e09\u65b9\u5ba2\u6237\u7aef\u5e93\uff0c\u53ef\u4ee5\u7528\u6765\u5e2e\u52a9\u6211\u4eec\u5728\u5e94\u7528\u4e2d\u96c6\u6210 Prometheus \u6307\u6807\u670d\u52a1\u3002\u4f7f\u7528\u8fd9\u4e9b\u5e93\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u548c\u8ddf\u8e2a\u4e0d\u540c\u7c7b\u578b\u7684\u6307\u6807\uff0c\u53cd\u6620\u670d\u52a1\u5f53\u524d\u7684\u72b6\u6001\uff0c\u8fd9\u4e9b\u5e93\u90fd\u5141\u8bb8\u6211\u4eec\u521b\u5efa\u548c\u66f4\u65b0\u5355\u72ec\u7684\u6307\u6807\u5bf9\u8c61\uff0c\u5c06\u5b83\u4eec\u6ce8\u518c\u5230\u4e00\u4e2a\u6307\u6807\u6ce8\u518c\u4e2d\u5fc3\uff0c\u7136\u540e\u901a\u8fc7 HTTP \u66b4\u9732\u8be5\u6307\u6807\u6ce8\u518c\u4e2d\u5fc3\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u7528\u7684 <code>metrics</code> \u63a5\u53e3\u3002</p> <p></p> <p>Prometheus \u7684\u4eea\u8868\u5316\u5ba2\u6237\u7aef\u5e93\u4e2d\u5305\u542b\u4e0d\u540c\u7684\u6307\u6807\u7c7b\u578b\uff1a<code>counters</code>\u3001<code>gauges</code>\u3001<code>histograms</code> \u4ee5\u53ca <code>summaries</code>\uff0c\u548c <code>Prometheus</code> \u4e2d\u7684\u6307\u6807\u7c7b\u578b\u5bf9\u5e94\uff0c\u5177\u4f53\u8981\u4f7f\u7528\u54ea\u79cd\u7c7b\u578b\u7684\u6307\u6807\u53d6\u51b3\u4e8e\u6211\u4eec\u7684\u5b9e\u9645\u60c5\u51b5\u3002</p> <p>\u6839\u636e\u4e0d\u540c\u7684\u6307\u6807\u7c7b\u578b\uff0c\u5728\u6784\u5efa\u6307\u6807\u5bf9\u8c61\u7684\u65f6\u5019\u9700\u8981\u63d0\u4f9b\u4e0d\u540c\u7684\u9009\u9879\uff0c\u6bd4\u5982\u5728\u521b\u5efa\u76f4\u65b9\u56fe\u7684\u65f6\u5019\u9700\u8981\u6307\u5b9a\u5b58\u50a8\u6876 bucket\uff0c\u800c\u521b\u5efa\u8ba1\u6570\u5668\u7684\u65f6\u5019\u4e0b\u4e0d\u9700\u8981\u5176\u4ed6\u989d\u5916\u53c2\u6570\u7684\u3002\u6b64\u5916\u6784\u9020\u7684\u6307\u6807\u5bf9\u8c61\u8fd8\u4e3a\u6bcf\u79cd\u7c7b\u578b\u7684\u6307\u6807\u66b4\u9732\u4e86\u4e0d\u540c\u7684\u72b6\u6001\u66f4\u65b0\u65b9\u6cd5\uff0c\u4f8b\u5982\uff0c\u8ba1\u6570\u5668\u5177\u6709\u589e\u52a0\u5f53\u524d\u503c\u7684\u65b9\u6cd5\uff0c\u4f46\u4e0d\u4f1a\u66b4\u9732\u5c06\u8ba1\u6570\u5668\u8bbe\u7f6e\u4e3a\u4efb\u610f\u503c\u7684\u65b9\u6cd5\uff0c\u4f46\u662f\u4eea\u8868\u76d8\u662f\u5141\u8bb8\u6211\u4eec\u8bbe\u7f6e\u5f53\u524d\u503c\u7684\u3002</p> <p>\u53e6\u5916 Prometheus \u7684\u5ba2\u6237\u7aef\u5e93\u9875\u9762(https://prometheus.io/docs/instrumenting/clientlibs/)\u4e0a\u5217\u51fa\u7684\u6240\u6709\u5b98\u65b9\u5e93\u7684\u5b9e\u73b0\u90fd\u8003\u8651\u5230\u4e86\u6548\u7387\u548c\u5e76\u53d1\u5b89\u5168\u95ee\u9898\uff1a</p> <ul> <li>\u6548\u7387\uff1a\u5bf9\u6307\u6807\u5bf9\u8c61\u7684\u72b6\u6001\u66f4\u65b0\u8fdb\u884c\u4e86\u4f18\u5316</li> <li>\u5e76\u53d1\u5b89\u5168\uff1a\u6307\u6807\u5bf9\u8c61\u7684\u6240\u6709\u72b6\u6001\u66f4\u65b0\u4ee5\u53ca\u4ece\u6307\u6807\u72b6\u6001\u8bfb\u53d6\u90fd\u662f\u5e76\u53d1\u5b89\u5168\u7684\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u53ef\u4ee5\u4ece\u591a\u4e2a\u7ebf\u7a0b\uff08\u6216 Go \u4e2d\u7684 goroutines\uff09\u66f4\u65b0\u6307\u6807\u503c\uff0c\u800c\u65e0\u9700\u8003\u8651\u9501\u7684\u95ee\u9898\uff0c\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u8fd8\u80fd\u591f\u540c\u65f6\u5b89\u5168\u5730\u5904\u7406\u591a\u4e2a\u6307\u6807\u6293\u53d6\u3002</li> </ul> <p>\u6240\u4ee5\u6211\u4eec\u662f\u53ef\u4ee5\u653e\u5fc3\uff08\u5f53\u7136\u4e5f\u662f\u63a8\u8350\uff09\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u5ba2\u6237\u7aef\u5e93\u6765\u4eea\u8868\u5316\u6211</p>"},{"location":"chap5/54prometheus_go_metrics_guideline/#3","title":"3\u3001\u8ddf\u8e2a\u6307\u6807","text":"<p>\u5f53\u5bf9\u4e00\u4e2a\u7cfb\u7edf\u6216\u8005\u670d\u52a1\u8fdb\u884c\u4eea\u8868\u5316\u7684\u65f6\u5019\uff0c\u5c3d\u91cf\u63d0\u4f9b\u4e00\u4e9b\u6709\u610f\u4e49\u7684\u6d4b\u91cf\u6307\u6807\uff0c\u4e1a\u754c\u6709\u51e0\u4e2a\u6bd4\u8f83\u8457\u540d\u7684\u6307\u5bfc\u65b9\u9488\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u6765\u7406\u89e3\u5728\u4e00\u4e2a\u7cfb\u7edf\u4e2d\u5e94\u8be5\u6dfb\u52a0\u54ea\u4e9b\u6307\u6807\u3002</p>"},{"location":"chap5/54prometheus_go_metrics_guideline/#3-1-google","title":"3-1 Google \u7684\u56db\u5927\u9ec4\u91d1\u6307\u6807","text":"<p>\u6709 4 \u4e2a\u6765\u81ea Google SRE \u624b\u518c\u7684\u9ec4\u91d1\u6307\u6807\uff0c\u8fd9 4 \u4e2a\u6307\u6807\u4e3b\u8981\u9488\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6216\u7528\u6237\u90e8\u5206\u3002</p> <ul> <li>\u5ef6\u8fdf\uff08Latency\uff09\uff1a\u670d\u52a1\u8bf7\u6c42\u6240\u9700\u8017\u65f6\uff0c\u4f8b\u5982 HTTP \u8bf7\u6c42\u5e73\u5747\u5ef6\u8fdf\u3002\u9700\u8981\u533a\u5206\u6210\u529f\u8bf7\u6c42\u548c\u5931\u8d25\u8bf7\u6c42\uff0c\u56e0\u4e3a\u5931\u8d25\u8bf7\u6c42\u53ef\u80fd\u4f1a\u4ee5\u975e\u5e38\u4f4e\u7684\u5ef6\u8fdf\u8fd4\u56de\u9519\u8bef\u7ed3\u679c\u3002</li> <li>\u6d41\u91cf\uff08Traffic\uff09\uff1a\u8861\u91cf\u670d\u52a1\u5bb9\u91cf\u9700\u6c42\uff08\u9488\u5bf9\u7cfb\u7edf\u800c\u8a00\uff09\uff0c\u4f8b\u5982\u6bcf\u79d2\u5904\u7406\u7684 HTTP \u8bf7\u6c42\u6570\u6216\u8005\u6570\u636e\u5e93\u7cfb\u7edf\u7684\u4e8b\u52a1\u6570\u91cf\u3002</li> <li>\u9519\u8bef\uff08Errors\uff09\uff1a\u8bf7\u6c42\u5931\u8d25\u7684\u901f\u7387\uff0c\u7528\u4e8e\u8861\u91cf\u9519\u8bef\u53d1\u751f\u7684\u60c5\u51b5\uff0c\u4f8b\u5982 HTTP500 \u9519\u8bef\u6570\u7b49\u663e\u5f0f\u5931\u8d25\uff0c\u8fd4\u56de\u9519\u8bef\u5185\u5bb9\u6216\u65e0\u6548\u5185\u5bb9\u7b49\u9690\u5f0f\u5931\u8d25\uff0c\u4ee5\u53ca\u7531\u7b56\u7565\u539f\u56e0\u5bfc\u81f4\u7684\u5931\u8d25\uff08\u6bd4\u5982\u5f3a\u5236\u8981\u6c42\u54cd\u5e94\u65f6\u95f4\u8d85\u8fc7 30ms \u7684\u8bf7\u6c42\u4e3a\u9519\u8bef\uff09\u3002</li> <li>\u9971\u548c\u5ea6\uff08Saturation\uff09\uff1a\u8861\u91cf\u8d44\u6e90\u7684\u4f7f\u7528\u60c5\u51b5\uff0c\u4f8b\u5982\u5185\u5b58\u3001CPU\u3001I/O\u3001\u78c1\u76d8\u4f7f\u7528\u91cf\uff08\u5373\u5c06\u9971\u548c\u7684\u90e8\u5206\uff0c\u6bd4\u5982\u6b63\u5728\u5feb\u901f\u586b\u5145\u7684\u78c1\u76d8\uff09\u3002</li> </ul>"},{"location":"chap5/54prometheus_go_metrics_guideline/#3-2-use","title":"3-2 \u8d44\u6e90\u6307\u6807\u7684 USE \u65b9\u6cd5","text":"<p>USE \u662f Utilization\uff08\u4f7f\u7528\u7387\uff09\u3001Saturation\uff08\u9971\u548c\u5ea6\uff09\u3001Error\uff08\u9519\u8bef\uff09\u7684\u9996\u5b57\u6bcd\u7ec4\u5408\uff0c\u662f Netflix \u7684\u5185\u6838\u548c\u6027\u80fd\u5de5\u7a0b\u5e08 Brendan Gregg \u63d0\u51fa\u7684\uff0c\u4e3b\u8981\u7528\u4e8e\u5206\u6790\u7cfb\u7edf\u6027\u80fd\u95ee\u9898\uff0c\u53ef\u4ee5\u6307\u5bfc\u7528\u6237\u5feb\u901f\u8bc6\u522b\u8d44\u6e90\u74f6\u9888\u53ca\u9519\u8bef\uff0c\u4e3b\u8981\u53ef\u4ee5\u8003\u8651\u6dfb\u52a0\u4ee5\u4e0b\u6307\u6807\u3002</p> <ul> <li>\u4f7f\u7528\u7387\uff08Utilization\uff09\uff1a\u5173\u6ce8\u7cfb\u7edf\u8d44\u6e90\u7684\u4f7f\u7528\u60c5\u51b5\uff0c\u8fd9\u91cc\u7684\u8d44\u6e90\u4e3b\u8981\u5305\u62ec\u4f46\u4e0d\u9650\u4e8e CPU\u3001\u5185\u5b58\u3001\u7f51\u7edc\u3001\u78c1\u76d8\u7b49\uff0c100%\u4f7f\u7528\u7387\u901a\u5e38\u662f\u7cfb\u7edf\u6027\u80fd\u74f6\u9888\u7684\u6807\u5fd7\u3002</li> <li>\u9971\u548c\u5ea6\uff08Saturation\uff09\uff1a\u4f8b\u5982\u8c03\u5ea6\u5668\u8fd0\u884c\u961f\u5217\u957f\u5ea6\uff0c\u8fd9\u91cc\u4e3b\u8981\u662f\u9488\u5bf9\u8d44\u6e90\u7684\u9971\u548c\u5ea6\uff08\u6ce8\u610f\uff0c\u4e0d\u540c\u4e8e\u56db\u5927\u9ec4\u91d1\u6307\u6807\uff09\u3002\u4efb\u4f55\u8d44\u6e90\u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u7684\u9971\u548c\u90fd\u53ef\u80fd\u5bfc\u81f4\u7cfb\u7edf\u6027\u80fd\u7684\u4e0b\u964d\u3002</li> <li>\u9519\u8bef\uff08Errors\uff09\uff1a\u53d1\u751f\u4e86\u591a\u5c11\uff08\u4ee5\u53ca\u4ec0\u4e48\u7c7b\u578b\u7684\uff09\u9519\u8bef\u3002\u4f8b\u5982\uff0c\u7f51\u5361\u5728\u6570\u636e\u5305\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u68c0\u6d4b\u5230\u4ee5\u592a\u7f51\u7edc\u51b2\u7a81\u4e86 10 \u6b21\u3002</li> </ul>"},{"location":"chap5/54prometheus_go_metrics_guideline/#3-3-red","title":"3-3 \u8bf7\u6c42\u670d\u52a1\u7cfb\u7edf\u7684 RED \u65b9\u6cd5","text":"<p>RED \u65b9\u6cd5\u662f Weave Cloud \u57fa\u4e8e Google \u7684 4 \u4e2a\u9ec4\u91d1\u6307\u6807\u518d\u7ed3\u5408 Prometheus \u53ca Kubernetes \u5bb9\u5668\u5b9e\u8df5\u5f97\u51fa\u7684\u65b9\u6cd5\u8bba\uff0c\u7279\u522b\u9002\u7528\u4e8e\u5bf9\u4e91\u539f\u751f\u5e94\u7528\u4ee5\u53ca\u5fae\u670d\u52a1\u67b6\u6784\u5e94\u7528\u8fdb\u884c\u76d1\u63a7\u548c\u5ea6\u91cf\u3002\u5728\u56db\u5927\u9ec4\u91d1\u6307\u6807\u7684\u539f\u5219\u4e0b\uff0cRED \u65b9\u6cd5\u53ef\u4ee5\u6709\u6548\u5730\u5e2e\u52a9\u7528\u6237\u8861\u91cf\u4e91\u539f\u751f\u4ee5\u53ca\u5fae\u670d\u52a1\u5e94\u7528\u4e0b\u7684\u7528\u6237\u4f53\u9a8c\u95ee\u9898\u3002RED \u65b9\u6cd5\u4e3b\u8981\u5173\u6ce8\u4ee5\u4e0b 3 \u79cd\u5173\u952e\u6307\u6807\u3002</p> <ul> <li>Request Counters\uff1a\u8bf7\u6c42\u8ba1\u6570\u5668\u3002</li> <li>Errors Counters\uff1a\u9519\u8bef\u8ba1\u6570\u5668\u3002</li> <li>Request Duration\uff1a\u6bcf\u4e2a\u8bf7\u6c42\u6240\u82b1\u8d39\u7684\u65f6\u95f4\uff08histograms \u6216 summaries\uff09\u3002</li> </ul> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u4e0a\u8ff0\u4e09\u5927\u76d1\u63a7\u7406\u8bba\u7684\u6700\u4f73\u5b9e\u8df5\u662f\uff1a\u5728\u9075\u5faa Google \u56db\u5927\u9ec4\u91d1\u6307\u6807\u7684\u524d\u63d0\u4e0b\uff0c\u5bf9\u4e8e\u5728\u7ebf\u7cfb\u7edf\uff0c\u7ed3\u5408 RED \u65b9\u6cd5\u548c\u7f13\u5b58\u547d\u4e2d\u7387\u65b9\u5f0f\u8fdb\u884c\u76d1\u6d4b\uff1b\u5bf9\u4e8e\u79bb\u7ebf\u7cfb\u7edf\u6216\u8005\u4e3b\u673a\u76d1\u63a7\uff0c\u4ee5 USE \u65b9\u6cd5\u4e3a\u4e3b\u8fdb\u884c\u76d1\u6d4b\uff1b\u5bf9\u4e8e\u6279\u5904\u7406\u7cfb\u7edf\uff0c\u53ef\u4ee5\u91c7\u7528\u7c7b\u4f3c Pushgateway \u7684\u5f62\u5f0f\u8fdb\u884c\u76d1\u63a7\u3002</p> <p>\u5f53\u7136\u8fd9\u4e9b\u6307\u5357\u5e76\u4e0d\u80fd\u5b8c\u5168\u8986\u76d6\u6211\u4eec\u7684\u5b9e\u9645\u76d1\u63a7\u9700\u6c42\uff0c\u4f46\u662f\u5bf9\u4e8e\u6211\u4eec\u5728\u5e94\u7528\u4e2d\u6dfb\u52a0\u54ea\u4e9b\u6307\u6807\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f88\u597d\u7684\u6307\u5bfc\u4f5c\u7528\u3002Prometheus \u5b98\u65b9\u6587\u6863\u4e2d\u5173\u4e8e\u4eea\u8868\u5316\u7684\u6700\u4f73\u5b9e\u8df5(https://prometheus.io/docs/practices/instrumentation/)\u63d0\u4f9b\u4e86\u66f4\u591a\u5173\u4e8e\u4e0d\u540c\u7c7b\u578b\u7cfb\u7edf\u76d1\u63a7\u7684\u5efa\u8bae\u3002</p>"},{"location":"chap5/54prometheus_go_metrics_guideline/#4","title":"4\u3001\u6307\u6807\u547d\u540d","text":"<p>\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u7684\u6307\u6807\u540d\u79f0\u63cf\u8ff0\u4e86\u88ab\u76d1\u6d4b\u7cfb\u7edf\u7684\u67d0\u4e9b\u72b6\u6001\uff0c\u6bd4\u5982\u5728\u5982\u4e0b\u6240\u793a\u7684\u65f6\u95f4\u5e8f\u5217\u4e2d\uff1a</p> <pre><code>http_requests_total{job=\"nginx\",instance=\"localhost:8080\",method=\"POST\"}\n</code></pre> <p>\u6307\u6807\u540d\u79f0\u5c31\u662f\u6807\u7b7e\u524d\u9762\u7684 <code>http_requests_total</code>\uff0c\u8be5\u6307\u6807\u540d\u79f0\u672c\u8eab\u5b57\u9762\u610f\u601d\u5c31\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u7406\u89e3\u8be5\u6307\u6807\u7684\u542b\u4e49\u4e86\uff0c\u867d\u7136 Prometheus \u672c\u8eab\u5e76\u4e0d\u4f1a\u4ee5\u8bed\u4e49\u65b9\u5f0f\u89e3\u91ca\u6307\u6807\u540d\u79f0\u3002</p> <p>\u4e3a\u4e86\u5e2e\u52a9\u6807\u51c6\u5316\u6307\u6807\u547d\u540d\uff0cPrometheus \u5b98\u65b9\u6587\u6863\u4e0a\u5217\u51fa\u4e86\u5efa\u8bae\u9075\u5faa\u7684\u6307\u6807\u547d\u540d\u6700\u4f73\u5b9e\u8df5(https://prometheus.io/docs/practices/naming/#metric-names)\u3002</p> <ul> <li>\u5fc5\u987b\u7b26\u5408\u6570\u636e\u6a21\u578b\u4e2d\u7684\u6709\u6548\u5b57\u7b26</li> <li>\u5fc5\u987b\u6709\u4e00\u4e2a\u4e0e\u6307\u6807\u6240\u5c5e\u9886\u57df\u76f8\u5173\u7684\u5e94\u7528\u524d\u7f00\uff0c\u8fd9\u4e2a\u524d\u7f00\u6709\u65f6\u88ab\u5ba2\u6237\u7aef\u5e93\u6210\u4e3a\u547d\u540d\u7a7a\u95f4\uff0c\u5bf9\u4e8e\u7279\u5b9a\u4e0e\u67d0\u4e2a\u5e94\u7528\u7684\u6307\u6807\uff0c\u524d\u7f00\u901a\u5e38\u662f\u5e94\u7528\u540d\u79f0\u672c\u8eab\uff0c\u5f53\u7136\u6709\u65f6\u5019\u6307\u6807\u4e5f\u662f\u6bd4\u8f83\u901a\u7528\u7684\uff0c\u6bd4\u5982 <code>prometheus_notifications_total</code>\u662f\u7279\u5b9a\u4e8e <code>Prometheus</code>\u5e94\u7528\u7684\u6307\u6807\uff0c<code>http_request_duration_seconds</code> \u7528\u4e8e\u6240\u6709\u7684 HTTP \u8bf7\u6c42</li> <li>\u5fc5\u987b\u6709\u5355\u4e00\u7684\u5355\u4f4d\uff0c\u4e0d\u8981\u628a\u79d2\u548c\u6beb\u79d2\u6216\u5b57\u8282\u8fd9\u4e9b\u6df7\u5728\u4e00\u8d77</li> <li>\u5e94\u8be5\u4f7f\u7528\u57fa\u672c\u7684\u5355\u4f4d\uff0c\u6bd4\u5982\u79d2\u3001\u5b57\u8282\u3001\u7c73\u7b49</li> <li>\u5e94\u8be5\u6709\u4e00\u4e2a\u63cf\u8ff0\u5355\u4f4d\u7684\u540e\u7f00\uff0c\u91c7\u7528\u590d\u6570\u5f62\u5f0f\uff0c\u6b64\u5916\u7d2f\u79ef\u8ba1\u6570\u9664\u4e86\u5355\u4f4d\u4e4b\u5916\uff0c\u8fd8\u5e94\u8be5\u6709\u4e00\u4e2a\u603b\u6570 total \u4f5c\u4e3a\u540e\u7f00\uff0c\u6bd4\u5982 <code>http_reuqest_duration_seconds</code>\u3001<code>node_memory_usage_bytes</code>\u3001<code>http_requests_total</code> (\u6ca1\u6709\u5355\u4f4d\u7684\u7d2f\u8ba1\u8ba1\u6570)\u3001<code>process_cpu_seconds_total</code> (\u5e26\u5355\u4f4d\u7684\u7d2f\u8ba1\u8ba1\u6570)\u3001<code>foobar_build_info</code> (\u7528\u4e8e\u63d0\u4f9b\u5173\u4e8e\u8fd0\u884c\u4e2d\u7684\u5e94\u7528\u5143\u4fe1\u606f\u7684\u6307\u6807)</li> </ul> <p>\u8bf7\u6ce8\u610f\uff0c\u76f4\u65b9\u56fe\u548c\u6458\u8981\u8fd8\u751f\u6210\u5e26\u6709\u540e\u7f00 <code>_sum</code>\u3001<code>_count</code> \u548c <code>_bucket</code>\uff08\u5355\u4e2a\u76f4\u65b9\u56fe\u6876\u7684\u8ba1\u6570\u5668\uff09\u7684\u8ba1\u6570\u5668\u6307\u6807\uff0c\u4f46\u8fd9\u4e9b\u662f\u6839\u636e\u57fa\u672c\u6307\u6807\u540d\u79f0\u81ea\u52a8\u751f\u6210\u7684\u76f4\u65b9\u56fe\uff0c\u56e0\u6b64\u6211\u4eec\u4e0d\u9700\u8981\u624b\u52a8\u6307\u5b9a\u8fd9\u4e9b\u540e\u7f00\u3002</p> <p>\u4e00\u4e2a\u7ed9\u5b9a\u6307\u6807\u7684\u6240\u6709\u7ef4\u5ea6\u4e0a\u7684 <code>sum()</code> \u6216<code>avg()</code>\u5e94\u8be5\u662f\u6709\u610f\u4e49\u7684\uff08\u5c3d\u7ba1\u4e0d\u4e00\u5b9a\u6709\u7528\uff09\uff0c\u5982\u679c\u6ca1\u6709\u610f\u4e49\uff0c\u8bf7\u5c06\u6570\u636e\u62c6\u5206\u4e3a\u591a\u4e2a\u6307\u6807\u3002\u4f8b\u5982\uff0c\u5c06\u5404\u79cd\u961f\u5217\u7684\u5bb9\u91cf\u653e\u5728\u4e00\u4e2a\u6307\u6807\u4e2d\u662f\u53ef\u884c\u7684\uff0c\u800c\u5c06\u4e00\u4e2a\u961f\u5217\u7684\u5bb9\u91cf\u4e0e\u961f\u5217\u4e2d\u7684\u5f53\u524d\u5143\u7d20\u6570\u6df7\u5408\u5728\u4e00\u8d77\u5219\u662f\u4e0d\u89c4\u8303\u7684\u3002</p>"},{"location":"chap5/54prometheus_go_metrics_guideline/#_1","title":"\u6807\u7b7e","text":"<p>\u6211\u4eec\u77e5\u9053 Label \u6807\u7b7e\u662f Prometheus \u4e2d\u975e\u5e38\u91cd\u8981\u7684\u4e00\u4e2a\u5143\u7d20\uff0c\u5728\u6211\u4eec\u4eea\u8868\u5316\u5e94\u7528\u7684\u65f6\u5019\u4e3a\u6307\u6807\u6307\u5b9a\u5408\u9002\u7684\u6807\u7b7e\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002\u6211\u4eec\u77e5\u9053\u6bcf\u7ec4\u552f\u4e00\u7684\u6807\u7b7e\uff08\u5305\u62ec\u6307\u6807\u540d\u79f0\uff09\u90fd\u4f1a\u6807\u8bc6\u5e76\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u552f\u4e00\u7684\u65f6\u95f4\u5e8f\u5217\uff0cPrometheus \u4f1a\u5728\u67e5\u8be2\u671f\u95f4\u8ddf\u8e2a\u3001\u5b58\u50a8\u548c\u5904\u7406\u8be5\u65f6\u95f4\u5e8f\u5217\uff0c\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u91cf\u4e5f\u662f Prometheus \u4e3b\u8981\u7684\u6027\u80fd\u74f6\u9888\u4e4b\u4e00\uff0c\u5bf9\u4e8e\u7a0d\u597d\u6027\u80fd\u7684\u670d\u52a1\u5668\u6765\u8bf4\uff0c\u901a\u5e38\u53ef\u4ee5\u5f88\u597d\u7684\u5904\u7406\u51e0\u767e\u4e07\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u5f53\u7136\u6700\u597d\u4e0d\u8981\u592a\u5927\uff0c\u6240\u4ee5\u5728\u51b3\u5b9a\u5c06\u54ea\u4e9b\u6807\u7b7e\u7ef4\u5ea6\u6dfb\u52a0\u5230\u6307\u6807\u4e2d\u7684\u65f6\u5019\uff0c\u9700\u8981\u8003\u8651\u5230\u8fd9\u4e00\u70b9\u3002</p> <p>Prometheus \u603b\u7684\u65f6\u95f4\u5e8f\u5217\u6210\u672c\u9700\u8981\u901a\u8fc7\u6307\u6807\u4e0a\u7684\u4e0d\u540c\u6807\u7b7e\u7ef4\u5ea6\u76f8\u4e58\u5f97\u5230\uff0c\u6bd4\u5982\u6211\u4eec\u6309\u7167 status code \u548c method \u6765\u62c6\u5206 HTTP \u8bf7\u6c42\u8ba1\u6570\uff0c\u5219\u5e8f\u5217\u603b\u6570\u5c06\u662f\u4e0d\u540c\u7684 status code \u548c\u4e0d\u540c\u7684 method \u6570\u91cf\u7684\u4e58\u79ef\u5f97\u5230\u8fd9\u4e24\u4e2a\u7ef4\u5ea6\u7684\u6240\u6709\u6709\u6548\u7ec4\u5408\uff0c\u7136\u540e\u8fd8\u9700\u8981\u5c06\u8be5\u57fa\u6570\u4e58\u4ee5\u76f8\u540c\u7c7b\u578b\u7684\u53d7\u76d1\u63a7\u76ee\u6807\u7684\u6570\u91cf\uff0c\u4ee5\u5f97\u51fa Prometheus \u670d\u52a1\u5668\u7684\u603b\u4f53\u65f6\u95f4\u5e8f\u5217\u6210\u672c\uff0c\u6240\u4ee5\u5bf9\u4e8e\u6807\u7b7e\u7ef4\u5ea6\u7684\u63a7\u5236\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u80fd\u592a\u5c11\uff0c\u4e5f\u4e0d\u80fd\u592a\u591a\u3002</p> <p>\u4e3a\u907f\u514d\u65f6\u95f4\u5e8f\u5217\u6570\u91cf\u6fc0\u589e\uff0c\u8bf7\u4fdd\u6301\u4f60\u7684\u6bcf\u4e2a\u6807\u7b7e\u7684\u53ef\u80fd\u503c\u7684\u6570\u91cf\u6709\u4e00\u5b9a\u7684\u9650\u5236\u3002\u5c24\u5176\u8981\u907f\u514d\u4ee5\u4e0b\u793a\u4f8b\uff1a</p> <ul> <li>\u5728\u4e00\u4e2a\u6807\u7b7e\u503c\u4e2d\u5b58\u50a8\u516c\u5171 IP \u5730\u5740\u6216\u7535\u5b50\u90ae\u4ef6\u5730\u5740</li> <li>\u5728\u4e00\u4e2a\u6807\u7b7e\u503c\u4e2d\u5b58\u50a8\u5b8c\u6574\u7684 HTTP \u8def\u5f84\uff0c\u5982\u679c\u8fd9\u4e9b\u8def\u5f84\u5305\u542b ID \u6216\u5176\u4ed6\u65e0\u9650\u5236\u7684\u4fe1\u606f</li> <li>\u6216\u7c7b\u4f3c\u7684\u6a21\u5f0f</li> </ul> <p>\u8fd9\u5c06\u8fc5\u901f\u4ea7\u751f\u4e00\u4e2a\u4e0d\u65ad\u589e\u52a0\u7684\u65f6\u95f4\u7cfb\u5217\uff0c\u5728\u77ed\u65f6\u95f4\u5185\u4f7f Prometheus \u670d\u52a1\u5668\u8fc7\u8f7d\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u907f\u514d\u7528\u8fd9\u79cd\u65b9\u5f0f\u7684\u6807\u7b7e\u503c\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u5b66\u4e60\u4f7f\u7528 Prometheus \u7684 Go \u5ba2\u6237\u7aef\u5e93(https://github.com/prometheus/client_golang)\u6765\u4e3a\u4e00\u4e2a Go \u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u548c\u66b4\u9732\u76d1\u63a7\u6307\u6807\u3002</p>"},{"location":"chap6/25Alertmanager_AWS_SES/","title":"chap1 Alertmanager alerts with Amazon SES SMTP","text":""},{"location":"chap6/25Alertmanager_AWS_SES/#1-verify-your-domain-name-to-send-email-at-examplecom-with-ses","title":"1. Verify your domain name to send email at <code>example.com</code> with SES","text":"<ul> <li>Add domain name into SES: <code>sapjam-integration.com</code></li> <li>Which generate records name: <code>_amazonses.sapjam-integration.com</code></li> <li>Which generate records TXT: <code>...</code></li> <li>Add TXT records and 300 TTL to CCloud and Verify this Domain</li> </ul>"},{"location":"chap6/25Alertmanager_AWS_SES/#2-request-your-smtp-credentials-and-download-credentials","title":"2. Request your SMTP credentials and download credentials","text":""},{"location":"chap6/25Alertmanager_AWS_SES/#3-testing-email-sending-using-the-command-line","title":"3. Testing Email Sending Using the Command Line","text":"<ul> <li>To connect to the SMTP interface using implicit SSL(without)</li> </ul> <pre><code>openssl s_client -crlf -quiet -connect email-smtp.eu-central-1.amazonaws.com:465\n</code></pre> <ul> <li>Using the Command Line to Send Email Using the Amazon SES SMTP Interface</li> </ul> <pre><code>echo -n \"SMTPUsername\" | openssl enc -base64\necho -n \"SMTPPassword\" | openssl enc -base64\n</code></pre> <p><code>input.txt</code></p> <pre><code>EHLO example.com\nAUTH LOGIN\nBase64EncodedSMTPUserName\nBase64EncodedSMTPPassword\nMAIL FROM: sender@example.com\nRCPT TO: recipient@example.com\nDATA\nFrom: sender@example.com\nTo: recipient@example.com\nSubject: Amazon SES SMTP Test\n\nThis message was sent using the Amazon SES SMTP interface.\n.\nQUIT\n</code></pre> <pre><code>$ openssl s_client -crlf -quiet -connect email-smtp.eu-central-1.amazonaws.com:465 &lt; input.txt\ndepth=4 C = US, O = \"Starfield Technologies, Inc.\", OU = Starfield Class 2 Certification Authority\nverify return:1\ndepth=3 C = US, ST = Arizona, L = Scottsdale, O = \"Starfield Technologies, Inc.\", CN = Starfield Services Root Certificate Authority - G2\nverify return:1\ndepth=2 C = US, O = Amazon, CN = Amazon Root CA 1\nverify return:1\ndepth=1 C = US, O = Amazon, OU = Server CA 1B, CN = Amazon\nverify return:1\ndepth=0 CN = email-smtp.eu-central-1.amazonaws.com\nverify return:1\n220 email-smtp.amazonaws.com ESMTP SimpleEmailService-d-GI38EMLB2 hkD7YwduxMJw9KrXpof7\n250-email-smtp.amazonaws.com\n250-8BITMIME\n250-SIZE 10485760\n250-AUTH PLAIN LOGIN\n250 Ok\n334 VXNlcm5hbWU6\n334 UGFzc3dvcmQ6\n235 Authentication successful.\n250 Ok\n250 Ok\n354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;\n250 Ok 0107017033dbb64d-be13a01e-dbf1-44b7-b876-3622165dacc1-000000\n451 4.4.2 Timeout waiting for data from client.\n</code></pre>"},{"location":"chap6/25Alertmanager_AWS_SES/#moveout-smtp-from-sandbox","title":"Moveout SMTP from sandbox","text":"<p>My ticket template is like this:</p> <p></p> <p>After you received an email replied your ticket from AWS support team, you can check your current SMTP Sending Statistics and your SMTP can send email to anyone without verification.</p> <p></p>"},{"location":"chap6/25Alertmanager_AWS_SES/#add-smtp-with-alertmanger","title":"Add SMTP with Alertmanger","text":"<p><code>alertmanager.yaml</code></p> <pre><code>---\nglobal:\n  resolve_timeout: 5m\n  http_config: {}\n  smtp_from: alertmanager@sapjam-integration.com\n  smtp_hello: sapjam-integration.com\n  smtp_smarthost: email-smtp.eu-central-1.amazonaws.com:25\n  smtp_auth_username: A...\n  smtp_auth_password: B...\n  smtp_require_tls: true\n...\n</code></pre>"},{"location":"chap6/25Alertmanager_AWS_SES/#set-up-dkim-for-your-verified-domain-to-authenticate-email-in-amazon-ses-production-only","title":"Set up DKIM for your verified domain to authenticate email in Amazon SES (Production only)","text":"<p>Reference: https://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-email-authentication-dkim-easy-setup-domain.html</p> <p>DomainKeys Identified Mail (DKIM) is a standard that allows senders to sign their email messages with a cryptographic key. Email providers then use these signatures to verify that the messages weren't modified by a third party while in transit. The reason why we need to authenticate emails for production environment is mentioned at https://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-email-authentication.html.</p> <ul> <li>To set up Easy DKIM for a domain</li> <li>Open the Amazon SES console at https://console.aws.amazon.com/ses/.</li> <li>In the navigation pane, under Identity Management, choose Domains.</li> <li>In the list of domains, choose the domain that you want to set up Easy DKIM for.</li> <li>Under DKIM, choose Generate DKIM Settings.</li> <li>Copy the three CNAME records that appear in this section like below screenshot as example.</li> </ul> <p></p> <ul> <li>Add the CNAME records to the DNS configuration for your domain in your domain's DNS serve</li> </ul>"},{"location":"chap6/26Prometheus_Monitor_Argocd/","title":"Chap2 Prometheus Operator Monitor on ArgoCD","text":"<ol> <li>\u7b2c\u4e00\u6b65\uff0c\u4e3a<code>Argocd</code>\u521b\u5efa\u81ea\u5b9a\u4e49\u7684\u62a5\u8b66\u89c4\u5219</li> <li>\u7b2c\u4e8c\u6b65\u5efa\u7acb\u4e00\u4e2a <code>ServiceMonitor</code> \u5bf9\u8c61\uff0c\u7528\u4e8e <code>Prometheus</code> \u6dfb\u52a0\u76d1\u63a7\u9879</li> <li>\u7b2c\u4e09\u6b65\u4e3a <code>ServiceMonitor</code> \u5bf9\u8c61\u5173\u8054 <code>metrics</code> \u6570\u636e\u63a5\u53e3\u7684\u4e00\u4e2a <code>Service</code> \u5bf9\u8c61</li> <li>\u7b2c\u56db\u6b65\u786e\u4fdd <code>Service</code> \u5bf9\u8c61\u53ef\u4ee5\u6b63\u786e\u83b7\u53d6\u5230 <code>metrics</code> \u6570\u636e</li> </ol>"},{"location":"chap6/26Prometheus_Monitor_Argocd/#argocdmetrics","title":"argocd\u5df2\u7ecf\u66b4\u9732metrics","text":"<ul> <li><code>argocd-metrics</code>: 8082</li> <li><code>argocd-server-metrics</code>: 8083 </li> </ul> <pre><code>$ kubectl get svc -n argocd --show-labels | grep metrics\nargocd-metrics          ClusterIP   100.70.123.135   &lt;none&gt;        8082/TCP            116d   app.kubernetes.io/component=metrics,app.kubernetes.io/name=argocd-metrics,app.kubernetes.io/part-of=argocd\nargocd-server-metrics   ClusterIP   100.70.2.220     &lt;none&gt;        8083/TCP            116d   app.kubernetes.io/component=server,app.kubernetes.io/name=argocd-server-metrics,app.kubernetes.io/part-of=argocd\n</code></pre>"},{"location":"chap6/26Prometheus_Monitor_Argocd/#servicemonitor","title":"\u521b\u5efa ServiceMonitor","text":""},{"location":"chap6/26Prometheus_Monitor_Argocd/#servicemonitorsargocd-metricsyaml","title":"<code>servicemonitors/argocd-metrics.yaml</code>","text":"<pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: argocd-metrics\n  namespace: argocd\n  labels:\n    prometheus: kube-prometheus\nspec:\n  selector:\n    matchLabels:\n      \"app.kubernetes.io/name\": argocd-metrics\n  namespaceSelector:\n    matchNames:\n    - argocd\n  jobLabel: app.kubernetes.io/name\n  endpoints:\n  - port: metrics\n    interval: 10s\n</code></pre> <ul> <li>\u4e0a\u9762\u6211\u4eec\u5728 <code>argocd</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u4e86\u540d\u4e3a <code>argocd-metrics</code> \u7684 <code>ServiceMonitor</code> \u5bf9\u8c61\uff0c\u57fa\u672c\u5c5e\u6027\u548c\u524d\u9762\u7ae0\u8282\u4e2d\u7684\u4e00\u81f4\uff0c</li> <li>\u5339\u914d <code>argocd</code> \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u5177\u6709 <code>\"app.kubernetes.io/name\": argocd-metrics</code> \u8fd9\u4e2a <code>label</code> \u6807\u7b7e\u7684 <code>Service</code>\uff0c<code>jobLabel</code> \u8868\u793a\u7528\u4e8e\u68c0\u7d22 <code>job</code> \u4efb\u52a1\u540d\u79f0\u7684\u6807\u7b7e\uff0c</li> </ul> <pre><code>$ kubectl create -f argocd-metrics.yaml\n</code></pre>"},{"location":"chap6/26Prometheus_Monitor_Argocd/#servicemonitorsargocd-repo-server-metricsyaml","title":"<code>servicemonitors/argocd-repo-server-metrics.yaml</code>","text":"<pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: argocd-repo-server-metrics\n  namespace: argocd\n  labels:\n    prometheus: kube-prometheus\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: argocd-repo-server\n  namespaceSelector:\n    matchNames:\n    - argocd\n  jobLabel: app.kubernetes.io/name\n  endpoints:\n  - port: metrics\n</code></pre> <ul> <li>\u4e0a\u9762\u6211\u4eec\u5728 <code>argocd</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u4e86\u540d\u4e3a <code>argocd-repo-server-metrics</code> \u7684 <code>ServiceMonitor</code> \u5bf9\u8c61\uff0c\u57fa\u672c\u5c5e\u6027\u548c\u524d\u9762\u7ae0\u8282\u4e2d\u7684\u4e00\u81f4\uff0c</li> <li>\u5339\u914d <code>argocd</code> \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u5177\u6709 <code>\"app.kubernetes.io/name\": argocd-repo-server</code> \u8fd9\u4e2a <code>label</code> \u6807\u7b7e\u7684 <code>Service</code>\uff0c<code>jobLabel</code> \u8868\u793a\u7528\u4e8e\u68c0\u7d22 <code>job</code> \u4efb\u52a1\u540d\u79f0\u7684\u6807\u7b7e\uff0c</li> </ul>"},{"location":"chap6/26Prometheus_Monitor_Argocd/#argocd-server-metricsyaml","title":"<code>argocd-server-metrics.yaml</code>","text":"<pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: argocd-server-metrics\n  namespace: argocd\n  labels:\n    prometheus: kube-prometheus\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: argocd-server-metrics\n  namespaceSelector:\n    matchNames:\n    - argocd\n  endpoints:\n  - port: metrics\n</code></pre> <ul> <li>\u4e0a\u9762\u6211\u4eec\u5728 <code>argocd</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u4e86\u540d\u4e3a <code>argocd-server-metrics</code> \u7684 <code>ServiceMonitor</code> \u5bf9\u8c61\uff0c\u57fa\u672c\u5c5e\u6027\u548c\u524d\u9762\u7ae0\u8282\u4e2d\u7684\u4e00\u81f4\uff0c</li> <li>\u5339\u914d <code>argocd</code> \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u5177\u6709 <code>\"app.kubernetes.io/name\": argocd-server-metrics</code> \u8fd9\u4e2a <code>label</code> \u6807\u7b7e\u7684 <code>Service</code>\uff0c<code>jobLabel</code> \u8868\u793a\u7528\u4e8e\u68c0\u7d22 <code>job</code> \u4efb\u52a1\u540d\u79f0\u7684\u6807\u7b7e\uff0c</li> </ul>"},{"location":"chap6/26Prometheus_Monitor_Argocd/#service","title":"\u67e5\u770b Service","text":"<p><code>ServiceMonitor</code> \u521b\u5efa\u5b8c\u6210\u4e86\uff0c\u53ef\u4ee5\u67e5\u770b\u4e00\u4e0b\u5173\u8054\u7684\u5bf9\u5e94\u7684 <code>Service</code> \u5bf9\u8c61\uff0c</p> <pre><code>kubectl get svc -n argocd --show-labels\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE   LABELS\nargocd-metrics          ClusterIP   100.64.219.240   &lt;none&gt;        8082/TCP            18d   app.kubernetes.io/component=metrics,app.kubernetes.io/name=argocd-metrics,app.kubernetes.io/part-of=argocd\n...\nargocd-repo-server      ClusterIP   100.68.97.78     &lt;none&gt;        8081/TCP,8084/TCP   18d   app.kubernetes.io/component=repo-server,app.kubernetes.io/name=argocd-repo-server,app.kubernetes.io/part-of=argocd\n...\nargocd-server-metrics   ClusterIP   100.68.125.117   &lt;none&gt;        8083/TCP            18d   app.kubernetes.io/component=server,app.kubernetes.io/name=argocd-server-metrics,app.kubernetes.io/part-of=argocd\n</code></pre>"},{"location":"chap6/26Prometheus_Monitor_Argocd/#add-to-dashboard","title":"Add to dashboard","text":"<pre><code>grafanaDashboards+:: {\n    ...\n     'argocd-dashboard.json': (import 'jam-dashboards/argocd-dashboard.json'),\n}\n</code></pre>"},{"location":"chap6/26Prometheus_Monitor_Argocd/#prometheusrule-applied-after-received-metrics-data","title":"\u914d\u7f6e <code>PrometheusRule</code> (Applied after received metrics data)","text":"<p><code>kustomize/templates/kube-prometheus/agocd_rules.json</code></p> <pre><code>{\n  \"groups\": [\n    {\n      \"name\": \"argocd.rules\",\n      \"rules\": [\n        {\n          \"alert\": \"ArgoCDSyncProgress\",\n          \"expr\": \"sum(argocd_app_health_status{health_status=\\\"Progressing\\\",namespace=\\\"argocd\\\"}) + sum(argocd_app_sync_status{sync_status=\\\"OutOfSync\\\",project=~\\\"(dev|integration|stage|jam).*\\\"}) &gt; 0\",\n          \"for\": \"30s\",\n          \"labels\": {\n            \"severity\": \"page\",\n            \"source\": \"argocd\"\n          },\n          \"annotations\": {\n            \"description\": \"ArgoCD start syncing applocations\",\n            \"summary\": \"Deploying\"\n          }\n        }\n      ]\n    }\n  ]\n}\n</code></pre>"},{"location":"chap6/26Prometheus_Monitor_Argocd/#kustomizetemplateskube-prometheustemplatejsonnet","title":"<code>kustomize/templates/kube-prometheus/template.jsonnet</code>","text":"<pre><code>prometheusAlerts+:: {\n       groups+: (import 'alerts/ct_rules.json').groups + (import 'alerts/argocd_rules.json').groups + (import 'alerts/jam_es_rules.json').groups,\n    },\n\n</code></pre> <pre><code>[~/sap-jam/jam-on-k8s]$ cd kustomize/templates/kube-prometheus &amp;&amp; time docker run --rm -v $(pwd):$(pwd) --workdir $(pwd) quay.io/coreos/jsonnet-ci ./build.sh template.jsonnet\n</code></pre> <p><code>monitoring/kube-prometheus/prometheus-rules.yaml</code></p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: prometheus-k8s-rules\n  namespace: monitoring\nspec:\n  groups:\n  ...\n  - name: argocd.rules\n    rules:\n    - alert: ArgoCDSyncProgress\n      annotations:\n        description: ArgoCD start syncing applocations\n        summary: Check configuration\n      expr: sum(argocd_app_health_status{health_status=\"Progressing\",namespace=\"argocd\"}) &gt; 0\n      for: 1m\n      labels:\n        severity: page\n        source: argocd\n</code></pre> <pre><code>kubectl apply -f prometheus-rules.yaml\n</code></pre>"},{"location":"chap6/26Prometheus_Monitor_Argocd/#add-slack-alerts-fot-argo-deployment","title":"Add slack alerts fot argo deployment","text":"<pre><code>\"global\":\n  \"resolve_timeout\": \"5m\"\n  \"smtp_hello\": \"sapjam-integration.com\"\n  \"smtp_from\": \"...@sapjam-integration.com\"    \n  \"smtp_smarthost\": \"email-smtp.eu-central-1.amazonaws.com:25\" # 465 is implicit ssl port\n  \"smtp_auth_username\": \"\"                  # stage stmp username and password\n  \"smtp_auth_password\": \"\"\n  \"smtp_require_tls\": true  \n\"receivers\":\n- \"name\": \"jam-devops-email-alerts\"\n  \"email_configs\":\n    - \"send_resolved\": true\n      \"headers\":\n        \"Subject\": 'Integration702-Alert{{ template \"email.default.subject\" . }}'\n      \"to\": \"receiver@sap.com\"\n- \"name\": \"slack-deployment\"\n  \"slack_configs\":\n  - \"api_url\": \"https://hooks.slack.com/services/...\"\n    \"channel\": \"multi-cloud-deployment\"\n    \"send_resolved\": true\n    \"text\": \"&lt;!channel&gt; \\n`{{ .CommonAnnotations.instance }}` ArgoCD syncing {{ if eq .Status \\\"firing\\\" }}started :peperunner:{{ else }}done! :parrot_beer:{{ end }}\"\n    \"title\": \"Deployment for {{ .CommonAnnotations.instance }}\"\n\"route\":\n  \"group_by\":\n  - \"job\"\n  \"group_interval\": \"5m\"\n  \"group_wait\": \"30s\"\n  \"receiver\": \"jam-devops-email-alerts\"\n  \"repeat_interval\": \"24h\"\n  \"routes\":\n  - \"match\":\n      \"alertname\": \"ArgoCDSyncProgress\"\n    \"receiver\": \"slack-deployment\"\n  - \"match\":\n      \"severity\": \"critical\"\n    \"receiver\": \"jam-devops-email-alerts\"\n\n\"inhibit_rules\":\n- \"source_match\":\n    \"severity\": \"critical\"\n  \"target_match_re\":\n    \"severity\": \"warning|none\"\n  \"equal\":  ['prometheus']\n- \"source_match\":\n    \"alertname\": \"KubeControllerManagerDown\"\n  \"target_match_re\":\n    \"alertname\": \"KubeSchedulerDown\"\n  \"equal\":  [\"prometheus\"]\n- \"source_match\":\n    \"alertname\": \"KubeSchedulerDown\"\n  \"target_match_re\":\n    \"alertname\": \"KubeControllerManagerDown\"\n  \"equal\":  ['prometheus']\n</code></pre>"},{"location":"chap6/27Prometheus_Monitor_elasticsearch/","title":"Chap3 Prometheus Operator Monitor on ElasticSearch","text":"<ol> <li>\u7b2c\u4e00\u6b65\u5efa\u7acb\u4e00\u4e2a <code>ServiceMonitor</code> \u5bf9\u8c61\uff0c\u7528\u4e8e <code>Prometheus</code> \u6dfb\u52a0\u76d1\u63a7\u9879</li> <li>\u7b2c\u4e8c\u6b65\u4e3a <code>ServiceMonitor</code> \u5bf9\u8c61\u5173\u8054 <code>metrics</code> \u6570\u636e\u63a5\u53e3\u7684\u4e00\u4e2a <code>Service</code> \u5bf9\u8c61</li> <li>\u7b2c\u4e09\u6b65\u786e\u4fdd <code>Service</code> \u5bf9\u8c61\u53ef\u4ee5\u6b63\u786e\u83b7\u53d6\u5230 <code>Exporter</code> \u6570\u636e</li> </ol>"},{"location":"chap6/27Prometheus_Monitor_elasticsearch/#1-elasticsearch-exporter","title":"1 \u5b89\u88c5<code>elasticsearch-exporter</code>","text":"<pre><code>helm install jam-elasticsearch-exporter --set es.uri=http://elasticsearch-jam:9200,es.all=true,es.indices=true stable/elasticsearch-exporter -n $JAM_INSTANCE\n</code></pre> <ul> <li>name: <code>jam-elasticsearch-exporter</code></li> <li><code>es.uri</code>: <code>es.uri=http://elasticsearch-jam:9200</code></li> <li><code>es.all</code>: true</li> <li><code>es.indices</code>: true</li> </ul>"},{"location":"chap6/27Prometheus_Monitor_elasticsearch/#2-servicemonitor","title":"2 \u521b\u5efa ServiceMonitor","text":"<p><code>servicemonitors/elasticsearch.yaml</code></p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: elasticsearch\n  labels:\n    prometheus: kube-prometheus\nspec:\n  selector:\n    # note, this matches on the service, not the deployment or pod\n    matchLabels:\n      app: elasticsearch-exporter\n  jobLabel: app\n  endpoints:\n  - targetPort: 9108\n    path: /metrics\n</code></pre> <ul> <li>\u5177\u6709 <code>app: elasticsearch-exporter</code> \u8fd9\u4e2a <code>label</code> \u6807\u7b7e\u7684 <code>Service</code>\uff0c<code>jobLabel</code> \u8868\u793a\u7528\u4e8e\u68c0\u7d22 <code>job</code> \u4efb\u52a1\u540d\u79f0\u7684\u6807\u7b7e\uff0c</li> </ul> <pre><code>$ kubectl get servicemonitor --all-namespaces | grep elas\ndefault      elasticsearch                44d\n</code></pre>"},{"location":"chap6/27Prometheus_Monitor_elasticsearch/#service","title":"\u67e5\u770b Service","text":"<p><code>ServiceMonitor</code> \u521b\u5efa\u5b8c\u6210\u4e86\uff0c\u53ef\u4ee5\u67e5\u770b\u4e00\u4e0b\u5173\u8054\u7684\u5bf9\u5e94\u7684 <code>Service</code> \u5bf9\u8c61\uff0c</p> <pre><code>$ kubectl get svc -n integration701 | grep elasticsearch\nelasticsearch                            ClusterIP      None             &lt;none&gt;              9200/TCP,9300/TCP                         65d\nelasticsearch-internal                   ClusterIP      None             &lt;none&gt;           9300/TCP                                  2d23h\nelasticsearch-jam                        ClusterIP      None             &lt;none&gt;           9200/TCP,9300/TCP                         65d\nelasticsearch-jam-internal               ClusterIP      None             &lt;none&gt;         9300/TCP                                  2d23h\njam-elasticsearch-exporter               ClusterIP      100.65.144.114   &lt;none&gt;     9108/TCP                              44d\n</code></pre>"},{"location":"chap6/27Prometheus_Monitor_elasticsearch/#prometheusrule-applied-after-received-exporter-data","title":"\u914d\u7f6e <code>PrometheusRule</code> (Applied after received exporter data)","text":"<p><code>es_rule.yaml</code></p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: elasticsearch-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: elasticsearch.rules\n    rules:\n    - alert: ElasticHeapUsageTooHigh\n      expr: (elasticsearch_jvm_memory_used_bytes{area=\"heap\"} / elasticsearch_jvm_memory_max_bytes{area=\"heap\"}) * 100 &gt; 95\n      for: 5m\n      labels:\n        severity: critical\n      annotations:\n        summary: \"Elastic Heap Usage Too High (instance: {{ $labels.instance }}) \"\n        message: \"The heap usage is over 95% for 5m VALUE = {{ $value }} for pod {{ $labels.name }}\"\n    - alert: ElasticHeapUsageWarning\n      expr: (elasticsearch_jvm_memory_used_bytes{area=\"heap\"} / elasticsearch_jvm_memory_max_bytes{area=\"heap\"}) * 100 &gt; 80\n      for: 5m\n      labels:\n        severity: warning\n      annotations:\n        summary: \"Elastic Heap Usage warning (instance {{ $labels.instance }})\"\n        message: \"The heap usage is over 80% for 5m VALUE = {{ $value }} for pod {{ $labels.name }}\"\n    - alert: ElasticClusterRed\n      expr: elasticsearch_cluster_health_status{color=\"red\"} == 1\n      for: 5m\n      labels:\n        severity: critical\n      annotations:\n        summary: \"Elastic Cluster Red (instance {{ $labels.instance }})\"\n        message: \"Elastic Cluster Red status VALUE = {{ $value }} fetched by Service Monitor {{ $labels.service }}\"\n    - alert: ElasticClusterYellow\n      expr: elasticsearch_cluster_health_status{color=\"yellow\"} == 1\n      for: 5m\n      labels:\n        severity: warning\n      annotations:\n        summary: \"Elastic Cluster Yellow (instance {{ $labels.instance }})\"\n        message: \"Elastic Cluster Yellow status VALUE = {{ $value }} fetched by Service Monitor: {{ $labels.service }}\"\n    - alert: NumberOfJamElasticHealthyNodes\n      expr: elasticsearch_cluster_health_number_of_nodes &lt; kube_statefulset_replicas{namespace=~\"^(jam|integration|stage|dev).*\", statefulset=~\"elasticsearch-jam\"}\n      for: 5m\n      labels:\n        severity: critical\n      annotations:\n        summary: \"Number of Jam Elastic Healthy Nodes (instance {{ $labels.instance }})\"\n        message: \"Number of Healthy Nodes less then Jam Elasticsearch sts desired replicas in elasticsearch6 VALUE = {{ $value }}\"\n    - alert: NumberOfInitializingShards\n      expr: elasticsearch_cluster_health_initializing_shards &gt; 0\n      for: 10m\n      labels:\n        severity: critical\n      annotations:\n        summary: \"Number of initializing shards (instance {{ $labels.instance }})\"\n        message: \"Number of initializing shards for 10 min VALUE = {{ $value }}, The initializing shards value fetched by Service Monitor: {{ $labels.service }} \"\n    - alert: NumberOfUnassignedShards\n      expr: elasticsearch_cluster_health_unassigned_shards &gt; 0\n      for: 5m\n      labels:\n        severity: critical\n      annotations:\n        summary: \"Number of unassigned shards (instance {{ $labels.instance }})\"\n        message: \"Number of unassigned shards for 5 min VALUE = {{ $value }}\\n The unassigned shards value fetched by Service Monitor: {{ $labels.service }}\"\n    - alert: NumberOfSearchQueueHigh\n      expr: elasticsearch_thread_pool_queue_count &gt; 800\n      for: 2m\n      labels:\n        severity: critical\n      annotations:\n        summary: \"Number of search queue (Instance {{ $labels.instance }}, Name {{ $labels.name }} and Type {{ $labels.type }})\"\n        message: \"Number of high search queue for 2 min VALUE = {{ $value }}\"\n    - alert: NumberOfPendingTasks\n      expr: elasticsearch_cluster_health_number_of_pending_tasks &gt; 0\n      for: 10m\n      labels:\n        severity: warning\n      annotations:\n        summary: \"Number of pending tasks (instance {{ $labels.instance }})\"\n        message: \"Number of pending tasks for 10 min. Cluster works slowly, VALUE = {{ $value }} fetched by Service Monitor {{ $labels.service }} \"\n</code></pre> <p></p>"},{"location":"chap6/31Prometheus_Monitor_rabbitmq/","title":"Chap4 Prometheus Operator Monitor on Rabbitmq","text":"<ol> <li>\u7b2c\u4e00\u6b65\uff0c\u5b89\u88c5<code>rabbitmq-exporter</code>, <code>rabbit-ha</code> \u548c <code>rabbit-transient</code></li> <li>\u7b2c\u4e8c\u6b65\u4e3a <code>ServiceMonitor</code> \u5bf9\u8c61\u5173\u8054 <code>metrics</code> \u6570\u636e\u63a5\u53e3\u7684\u4e00\u4e2a <code>Service</code> \u5bf9\u8c61</li> <li>\u7b2c\u4e09\u6b65\u786e\u4fdd <code>Service</code> \u5bf9\u8c61\u53ef\u4ee5\u6b63\u786e\u83b7\u53d6\u5230 <code>metrics</code> \u6570\u636e</li> </ol>"},{"location":"chap6/31Prometheus_Monitor_rabbitmq/#rabbitmq-exporter","title":"\u5b89\u88c5<code>rabbitmq-exporter</code>","text":""},{"location":"chap6/31Prometheus_Monitor_rabbitmq/#rabbit-ha-rabbitmq-exporter","title":"<code>rabbit-ha rabbitmq-exporter</code>","text":"<pre><code>helm install prometheus-rabbitmq-exporter-ha --set rabbitmq.url=http://rabbitmq-ha:15672,rabbitmq.user=jambunny,rabbitmq.existingPasswordSecret=rabbit stable/prometheus-rabbitmq-exporter -n $JAM_INSTANCE\n</code></pre>"},{"location":"chap6/31Prometheus_Monitor_rabbitmq/#rabbit-transient-rabbitmq-exporter","title":"<code>rabbit-transient rabbitmq-exporter</code>","text":"<pre><code>helm install prometheus-rabbitmq-exporter-transient --set rabbitmq.url=http://rabbitmq-transient:15672,rabbitmq.user=jambunny,rabbitmq.existingPasswordSecret=rabbit stable/prometheus-rabbitmq-exporter -n $JAM_INSTANCE\n</code></pre> <ul> <li>Name: <code>prometheus-rabbitmq-exporter-ha</code>&amp;<code>prometheus-rabbitmq-exporter-transient</code></li> <li>rabbitmq.url: <code>http://rabbitmq-transient:15672</code></li> <li>rabbitmq.user: jambunny</li> <li>rabbitmq.existingPasswordSecret : rabbit</li> <li>stable/prometheus-rabbitmq-exporter</li> </ul> <pre><code>$ helm list  -n integration701  | grep rab\n...\nprometheus-rabbitmq-exporter-ha         integration701  1               2020-02-12 16:39:52.9999 +0800 CST      deployed        prometheus-rabbitmq-exporter-0.5.5        v0.29.0    \nprometheus-rabbitmq-exporter-transient  integration701  1               2020-02-12 16:40:42.605152 +0800 CST    deployed        prometheus-rabbitmq-exporter-0.5.5        v0.29.0 \n</code></pre>"},{"location":"chap6/31Prometheus_Monitor_rabbitmq/#servicemonitor","title":"\u521b\u5efa ServiceMonitor","text":"<p><code>rabbit-ha.yaml</code></p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: rabbit-ha\n  labels:\n    prometheus: kube-prometheus\nspec:\n  selector:\n    # note, this matches on the service, not the deployment or pod\n    matchLabels:\n      app: prometheus-rabbitmq-exporter\n      release: prometheus-rabbitmq-exporter-ha\n  jobLabel: app\n  endpoints:\n  - targetPort: 9419\n    path: /metrics\n  namespaceSelector:\n    matchNames:\n      - integration701\n</code></pre> <ol> <li>\u4e0a\u9762\u6211\u4eec\u5728 <code>default</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u4e86\u540d\u4e3a <code>rabbit-ha</code> \u7684 <code>ServiceMonitor</code> \u5bf9\u8c61</li> <li>\u5339\u914d <code>integration701</code> \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u5177\u6709 <code>app: prometheus-rabbitmq-exporter</code> \u548c <code>app: prometheus-rabbitmq-exporter</code>\u8fd9\u4e24\u4e2a <code>label</code> \u6807\u7b7e\u7684 <code>Service</code>\uff0c<code>jobLabel</code> \u8868\u793a\u7528\u4e8e\u68c0\u7d22 <code>job</code> \u4efb\u52a1\u540d\u79f0\u7684\u6807\u7b7e\uff0c</li> </ol>"},{"location":"chap6/31Prometheus_Monitor_rabbitmq/#rabbit-transientyaml","title":"<code>rabbit-transient.yaml</code>","text":"<pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: rabbit-transient\n  labels:\n    prometheus: kube-prometheus\nspec:\n  selector:\n    # note, this matches on the service, not the deployment or pod\n    matchLabels:\n      app: prometheus-rabbitmq-exporter\n      release: prometheus-rabbitmq-exporter-transient\n  jobLabel: app\n  endpoints:\n  - targetPort: 9419\n    path: /metrics\n  namespaceSelector:\n    matchNames:\n   - integration701\n</code></pre> <ol> <li>\u4e0a\u9762\u6211\u4eec\u5728 <code>default</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u521b\u5efa\u4e86\u540d\u4e3a <code>rabbit-transient</code> \u7684 <code>ServiceMonitor</code> \u5bf9\u8c61</li> <li>\u5339\u914d <code>integration701</code> \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u5177\u6709 <code>app: prometheus-rabbitmq-exporter</code> \u548c <code>app: prometheus-rabbitmq-exporter</code>\u8fd9\u4e24\u4e2a <code>label</code> \u6807\u7b7e\u7684 <code>Service</code>\uff0c<code>jobLabel</code> \u8868\u793a\u7528\u4e8e\u68c0\u7d22 <code>job</code> \u4efb\u52a1\u540d\u79f0\u7684\u6807\u7b7e\uff0c</li> </ol> <pre><code>$ kubectl get servicemonitor\nNAMESPACE    NAME                         AGE\ndefault      rabbit-ha                    44d\ndefault      rabbit-transient             44d\n</code></pre>"},{"location":"chap6/31Prometheus_Monitor_rabbitmq/#service","title":"\u67e5\u770b <code>Service</code>","text":"<pre><code>$ kubectl get svc -n integration701 | grep rab\nprometheus-rabbitmq-exporter-ha          ClusterIP      100.68.97.158    &lt;none&gt;                                                   \n                   9419/TCP                                  44d\nprometheus-rabbitmq-exporter-transient   ClusterIP      100.69.144.253   &lt;none&gt;                                                   \n                   9419/TCP                                  44d\nrabbitmq-exporter-ha                     ClusterIP      100.65.251.106   &lt;none&gt;                                                   \n                   9419/TCP                                  66d\nrabbitmq-exporter-transient              ClusterIP      100.66.131.184   &lt;none&gt;                                                   \n                   9419/TCP                                  66d\nrabbitmq-ha                              ClusterIP      100.71.17.211    &lt;none&gt;                                                   \n                   15672/TCP,5672/TCP                        65d\nrabbitmq-transient                       ClusterIP      100.71.81.171    &lt;none&gt;                                                   \n                   15672/TCP,5672/TCP                        65d\n</code></pre>"},{"location":"chap6/31Prometheus_Monitor_rabbitmq/#monitoringkube-prometheusprometheus-rulesyaml","title":"<code>monitoring/kube-prometheus/prometheus-rules.yaml</code>","text":""},{"location":"chap6/31Prometheus_Monitor_rabbitmq/#reference","title":"Reference","text":"<p><code>alerts.yaml</code></p>"},{"location":"chap6/31Prometheus_Monitor_rabbitmq/#jam-rabbitmq-ha-rules","title":"Jam <code>rabbitmq-ha-rules</code>","text":"<p><code>rabbitmq-ha-rules.yaml</code></p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: rabbitmq-ha-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: rabbitmq-ha.rules\n    rules:\n    - alert: RabbitMqHaClusterNodeDown\n      expr: rabbitmq_up{service=\"prometheus-rabbitmq-exporter-ha\"} == 0\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary:  \"[highly_available] Rabbitmq down (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"RabbitMQ-HA {{$labels.namespace}}/{{$labels.pod}} is down\"\n    - alert: RabbitMqHaClusterNotAllNodesRunning\n      expr: rabbitmq_running{service=\"prometheus-rabbitmq-exporter-ha\"} &lt; kube_statefulset_replicas{namespace=~\"^(jam|integration|stage|dev).*\", statefulset=~\"rabbitmq-ha\"}\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"[highly_available]  Some RabbitMQ-HA Cluster Nodes Are Down in Service (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"Some RabbitMQ-HA cluster nodes are down, currently running with VALUE = {{$value}}\"\n    - alert: RabbitMqHaClusterPartition\n      expr: rabbitmq_partitions{service=\"prometheus-rabbitmq-exporter-ha\"} &gt; 0\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"[highly_available] Cluster Partition Error (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"RabbitMQ-HA either some nodes are down or the cluster has partitioned with VALUE = {{$value}}\"\n    - alert: RabbitMqHaExchangeStatus\n      expr: rabbitmq_exchangesTotal{service=\"prometheus-rabbitmq-exporter-ha\"} == 0\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"[highly_available] Cluster Exchange are Missing (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"The count of RabbitMQ-HA cluster exchange is VALUE = {{$value}}\"\n    - alert: RabbitMqHaQueueStatus\n      expr: rabbitmq_queuesTotal{service=\"prometheus-rabbitmq-exporter-ha\"} == 0\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"[highly_available] Cluster Queues are Missing (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"The count of RabbitMQ-HA cluster queue is VALUE = {{$value}}\"\n    - alert: RabbitMqHaDiskSpaceAlarm\n      expr: rabbitmq_node_disk_free_alarm{service=\"prometheus-rabbitmq-exporter-ha\"} == 1\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"[highly_available] RabbitMQ-HA is Out of Disk Space (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"RabbitMQ-HA {{$labels.namespace}} / {{$labels.pod}} Disk Space Alarm is going off.  Which means the node hit highwater mark and has cut off network connectivity, see RabbitMQ WebUI\"\n    - alert: RabbitMqHaMemoryAlarm\n      expr: rabbitmq_node_mem_alarm{service=\"prometheus-rabbitmq-exporter-ha\"} == 1\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"[highly_available] RabbitMQ-HA is Out of Memory (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"RabbitMQ-HA {{$labels.namespace}} / {{$labels.pod}} High Memory Alarm is going off.  Which means the node hit highwater mark and has cut off network connectivity, see RabbitMQ WebUI\"\n    - alert: RabbitMqHaMemoryUsageHigh\n      expr: (rabbitmq_node_mem_used{service=\"prometheus-rabbitmq-exporter-ha\"} / rabbitmq_node_mem_limit{service=\"prometheus-rabbitmq-exporter-ha\"} ) * 100 &gt; 90\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"[highly_available] RabbitMQ-HA Node &gt; 90% Memory Usage (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"RabbitMQ-HA {{$labels.namespace}} / {{$labels.pod}}  Memory Usage &gt; 90%\"\n    - alert: RabbitMqHaFileDescriptorsLow\n      expr: (rabbitmq_fd_used{service=\"prometheus-rabbitmq-exporter-ha\"} / rabbitmq_fd_total{service=\"prometheus-rabbitmq-exporter-ha\"}) * 100 &gt; 90\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"RabbitMQ-HA Low File Descriptor Available (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"RabbitMQ-HA {{$labels.namespace}} / {{$labels.pod}} File Descriptor Usage &gt; 90%\"\n    - alert: RabbitMqHaDiskSpaceLow\n      expr: predict_linear(rabbitmq_node_disk_free{service=\"prometheus-rabbitmq-exporter-ha\"}[15m], 1 * 60 * 60) &lt; rabbitmq_node_disk_free_limit{service=\"prometheus-rabbitmq-exporter-ha\"}\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"[highly_available] RabbitMQ-HA is Low on Disk Space and will Run Out in the next hour (Detected by Service {{$labels.service}} and Exporter {{$labels.pod}})\"\n        description: \"RabbitMQ-HA {{$labels.namespace}} / {{$labels.pod}} will hit disk limit in the next hr based on last 15 mins trend.\"\n    - alert: RabbitMqHaNoConsumer\n      expr: rabbitmq_queue_consumers{service=\"prometheus-rabbitmq-exporter-ha\"} == 0\n      for: 5m\n      labels:\n        severity: critical\n        job: rabbitmq-ha\n      annotations:\n        summary: \"[highly_available] No Consumer Existing for Queues in RabbitMQ-HA  (instance {{$labels.instance}})\"\n        description: \"RabbitMQ-HA Queues has no consumers exist for {{$labels.queue}}\"\n</code></pre>"},{"location":"chap6/33Prometheus_Monitor_memcached/","title":"Chap5 Prometheus Operator Monitor on Memcached","text":""},{"location":"chap6/33Prometheus_Monitor_memcached/#reference","title":"Reference","text":"<ol> <li>Memcached Exporter for Prometheus(docker)</li> <li>Helm stable/memcached</li> </ol>"},{"location":"chap6/33Prometheus_Monitor_memcached/#check-stable-monitor-way-from-offical","title":"Check stable monitor way from offical","text":"<pre><code>helm template memcached &gt; memcached-stable.yaml\n\n---\n# Source: memcached/templates/svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: RELEASE-NAME-memcached\n  namespace: default\n  ...\nspec:\n  clusterIP: None\n  ports:\n  - name: memcache\n    port: 11211\n    targetPort: memcache\n  - name: metrics           ### Port for memcache metrics\n    port: 9150\n    targetPort: metrics\n  selector:\n    app.kubernetes.io/name: memcached\n    app.kubernetes.io/instance: RELEASE-NAME\n---\n# Source: memcached/templates/statefulset.yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: RELEASE-NAME-memcached\n  namespace: default\n  ...\n      containers:\n      - name: RELEASE-NAME-memcached\n        image: memcached:1.5.20\n        imagePullPolicy: \"\"\n        securityContext:\n          runAsUser: 1001\n        command:\n        - memcached\n        - -m 64\n        - -o\n        - modern\n        - -v\n        ports:\n        - name: memcache\n          containerPort: 11211\n        livenessProbe:\n          tcpSocket:\n            port: memcache\n          initialDelaySeconds: 30\n          timeoutSeconds: 5\n        readinessProbe:\n          tcpSocket:\n            port: memcache\n          initialDelaySeconds: 5\n          timeoutSeconds: 1\n        resources:\n          requests:\n            cpu: 50m\n            memory: 64Mi\n      - name: metrics\n        image: quay.io/prometheus/memcached-exporter:v0.6.0\n        imagePullPolicy: \"\"\n        securityContext:\n          runAsUser: 1001\n        ports:\n        - name: metrics\n          containerPort: 9150\n        resources:\n          {}\n  ...\n---\n# Source: memcached/templates/servicemonitor.yaml\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: RELEASE-NAME-memcached\n  namespace: default\n  labels:\n    app.kubernetes.io/name: memcached\n    helm.sh/chart: memcached-3.2.3\n    app.kubernetes.io/instance: RELEASE-NAME\n    app.kubernetes.io/version: \"1.5.20\"\n    app.kubernetes.io/managed-by: Helm\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: memcached\n      app.kubernetes.io/instance: RELEASE-NAME\n  endpoints:\n  - port: metrics\n    interval: 15s\n---\n# Source: memcached/templates/pdb.yaml\napiVersion: policy/v1beta1\nkind: PodDisruptionBudget\n...\n</code></pre>"},{"location":"chap6/33Prometheus_Monitor_memcached/#enable-monitor-on-memcached-with-memcached-metrics","title":"Enable Monitor on Memcached with Memcached metrics","text":"<ol> <li>Install memcached-exporter as sidecar for jam memcached app pod</li> <li>Add new metrics port and label for memcached app service </li> <li>Create ServiceMonitor to fetched the data from memcached app service by selector</li> <li>Create <code>Prometheusrules</code> for Jam memcached</li> </ol> <p>Install memcached-exporter in memcached Deployment</p> <pre><code>---\n# ----- [ memcached ] --------------------\n#\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cache-memcached\n  namespace: {{ .Values.jam.namespace }}\nspec:\n  selector:\n    matchLabels:\n      app: memcached # has to match .spec.template.metadata.labels\n  replicas: 1\n  revisionHistoryLimit: 3\n  template:\n    metadata:\n      labels:\n        app: memcached # has to match .spec.selector.matchLabels\n        scope: cache\n    spec:\n      containers:\n      - name: memcached\n        image: memcached:1.5-alpine\n        args: [\"-p\", \"11211\", \"-l\", \"0.0.0.0:11211,0.0.0.0:11212\"]\n      - name: memcached-metrics\n        image: quay.io/prometheus/memcached-exporter:v0.6.0\n        ports:\n        - name: metrics\n          containerPort: 9150\n</code></pre> <pre><code>- name: memcached-metrics\n  image: quay.io/prometheus/memcached-exporter:v0.6.0\n  ports:\n  - name: metrics\n    containerPort: 9150\n</code></pre> <p>Add new metrics <code>port</code> and <code>label</code> for memcached app service </p> <pre><code>#\n# Service heads for dependencies\n#\n---\n# ----- [ memcached ] --------------------\n#\napiVersion: v1\nkind: Service\nmetadata:\n  name: memcached\n  namespace: {{ .Values.jam.namespace }}\n  labels:\n    app: memcached\n    component: memcached-metrics\nspec:\n  selector:\n    app: memcached\n    scope: cache\n  ports:\n  - name: memcached\n    protocol: TCP\n    port: 11211\n    targetPort: 11211\n  - name: memcached-img\n    protocol: TCP\n    port: 11212\n    targetPort: 11212\n  - name: memcached-metrics\n    port: 9150\n    targetPort: metrics\n</code></pre> <pre><code>...\nlabels:\n  app: memcached\n  component: memcached-metrics\n...\nspec:\n  selector:\n    app: memcached\n    scope: cache\n  ports:\n  ...\n  - name: memcached-metrics\n    port: 9150\n    targetPort: metrics\n</code></pre> <p>Upgrade helm chart</p> <pre><code>$ helm upgrade jam-ct-memcached helm/jam/memcached/ -f instances/$JAM_INSTANCE-k8s.yaml --namespace $JAM_INSTANCE\n</code></pre> <pre><code>$ kubectl get svc -n dev902 --show-labels | grep mem\ndoc-memcached         ClusterIP      100.70.244.225   &lt;none&gt;     11211/TCP,11212/TCP   36d   app=memcached\nmemcached             ClusterIP      100.69.109.250   &lt;none&gt;      11211/TCP,11212/TCP,9150/TCP      36d   app=memcached,component=memcached-metrics\nmemcached-opensocial  ClusterIP      100.68.136.232   &lt;none&gt;      11211/TCP,11212/TCP   36d   app=memcached\n</code></pre> <p>Note, I don't konw why my metric works or not</p> <p>Therefore, exec in a pod and curl the metrics port to verify</p> <pre><code>$ kubectl exec -it ps-7bcbd5fcd9-cb8dq -n dev902 sh\n$ sh-4.2#  curl http://100.69.109.250:9150\n&lt;html&gt;\n             &lt;head&gt;&lt;title&gt;Memcached Exporter&lt;/title&gt;&lt;/head&gt;\n             &lt;body&gt;\n             &lt;h1&gt;Memcached Exporter&lt;/h1&gt;\n             &lt;p&gt;&lt;a href='/metrics'&gt;Metrics&lt;/a&gt;&lt;/p&gt;\n             &lt;/body&gt;\n             &lt;/html&gt;sh-4.2#\n### Looks like it works, let's curl the metrics out\n</code></pre> <pre><code>h-4.2#  curl http://100.69.109.250:9150/metrics\n# HELP go_gc_duration_seconds A summary of the GC invocation durations.\n# TYPE go_gc_duration_seconds summary\ngo_gc_duration_seconds{quantile=\"0\"} 0\ngo_gc_duration_seconds{quantile=\"0.25\"} 0\ngo_gc_duration_seconds{quantile=\"0.5\"} 0\ngo_gc_duration_seconds{quantile=\"0.75\"} 0\ngo_gc_duration_seconds{quantile=\"1\"} 0\ngo_gc_duration_seconds_sum 0\ngo_gc_duration_seconds_count 0\n...\npromhttp_metric_handler_requests_total{code=\"200\"} 0\npromhttp_metric_handler_requests_total{code=\"500\"} 0\npromhttp_metric_handler_requests_total{code=\"503\"} 0\n</code></pre>"},{"location":"chap6/33Prometheus_Monitor_memcached/#create-servicemonitor","title":"Create ServiceMonitor","text":"<pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: memcached\n  labels:\n    prometheus: kube-prometheus\nspec:\n  selector:\n    # note, this matches on the service, not the deployment or pod\n    matchLabels:\n      app: memcached\n      component: memcached-metrics  \n  jobLabel: app\n  namespaceSelector:\n    matchNames:\n        - dev902\n  endpoints:\n  - targetPort: metrics\n    path: /metrics\n    interval: 10s\n</code></pre> <pre><code>$ kubectl get ServiceMonitor\nNAME               AGE\n...\nmemcached          26s\n...\n</code></pre>"},{"location":"chap6/33Prometheus_Monitor_memcached/#verify-the-servicemonitor-works-or-not","title":"Verify the ServiceMonitor works or not","text":"<pre><code>kubectl port-forward svc/prometheus-operated -n monitoring 9090:9090\n</code></pre> <p>Status -&gt; targets</p> <p></p>"},{"location":"chap6/33Prometheus_Monitor_memcached/#prometheusrules-for-jam-memcached","title":"Prometheusrules for Jam memcached","text":"<pre><code>apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    prometheus: k8s\n    role: alert-rules\n  name: memcached-rules\n  namespace: monitoring\nspec:\n  groups:\n  - name: cache-memcached.rules\n    rules:\n    - alert: CacheMemcahedDown\n      annotations:\n        description: Cache Memcached {{$labels.namespace}}/{{$labels.pod}} is down\n        summary: 'Cache Memcached down (Detected by Service {{$labels.service}}'\n      expr: memcached_up{service=\"memcached\"} == 0\n      for: 5m\n      labels:\n        job: cache-memcached\n        severity: critical\n  - name: doc-memcached.rules\n    rules:\n    - alert: DocMemcahedDown\n      annotations:\n        description: Doc Memcached {{$labels.namespace}}/{{$labels.pod}} is down\n        summary: 'Doc Memcached down (Detected by Service {{$labels.service}}'\n      expr: memcached_up{service=\"doc-memcached\"} == 0\n      for: 5m\n      labels:\n        job: doc-memcached\n        severity: critical\n  - name: opensocial-memcached.rules\n    rules:\n    - alert: OpensocialMemcahedDown\n      annotations:\n        description: Doc Memcached {{$labels.namespace}}/{{$labels.pod}} is down\n        summary: 'Doc Memcached down (Detected by Service {{$labels.service}}'\n      expr: memcached_up{service=\"memcached-opensocial\"} == 0\n      for: 5m\n      labels:\n        job: opensocial-memcached\n        severity: critical\n</code></pre>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/","title":"\u5e94\u7528\u8fdb\u884c\u81ea\u5b9a\u4e49\u6307\u6807\u6269\u7f29\u5bb9 by Prometheus-Adapter and Flask-Exporter","text":""},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#1","title":"1 \u73af\u5883\u51c6\u5907","text":"<ul> <li><code>1.10.0+</code> \u7248\u672c\u7684 Kubernetes \u96c6\u7fa4</li> <li>\u53ef\u4ee5\u8bbf\u95ee\u96c6\u7fa4\u7684\u8282\u70b9\u4e0a\u5b89\u88c5 <code>Helm</code> \u548c <code>Kubectl</code> \u5de5\u5177</li> <li>\u5728\u96c6\u7fa4\u4e2d\u521d\u59cb\u5316\u4e86 <code>Helm</code></li> </ul>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#2-clone","title":"2 Clone \u9879\u76ee","text":"<p>\u672c\u6587\u4f7f\u7528\u5230\u7684\u76f8\u5173\u4ee3\u7801\u90fd\u7edf\u4e00\u653e\u7f6e\u5230\u4e86 <code>GitHub</code> \u4e0a\uff0c<code>Clone</code> \u4ee3\u7801\u5230\u672c\u5730\uff1a</p> <pre><code>$ git clone https://github.com/cnych/k8s-prometheus-custom-scaling.git\n$ cd k8s-prometheus-custom-scaling\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5148\u6765\u770b\u4e00\u4e0b\u5c06\u8981\u6269\u5bb9\u7684\u5e94\u7528\u3002\u662f\u4f7f\u7528 <code>Flask</code> \u4f5c\u4e3a\u540e\u7aef <code>React</code> \u4f5c\u4e3a\u524d\u7aef\u7684\u4e00\u4e2a\u9879\u76ee\uff0c\u53e6\u5916\u8fd8\u4f7f\u7528\u4e86 Flask Promethues Exporter \u8fd9\u4e2a\u7b2c\u4e09\u65b9\u5e93\uff0c\u6838\u5fc3\u7684\u540e\u7aef\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>from flask import Flask, render_template\nfrom prometheus_flask_exporter.multiprocess import GunicornInternalPrometheusMetrics\n\napplication = Flask(__name__, static_folder=\"./public\", template_folder=\"./templates\")\nmetrics = GunicornInternalPrometheusMetrics(application)\n\n\n@application.route(\"/\")\ndef index():\n    return render_template(\"index.html\")\n\n\n@application.route(\"/click-button\", methods=[\"POST\"])\n@metrics.counter(\"demo_app_button_clicks\", \"Number of button presses by user\")\ndef web_button():\n    return {}\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u672c\u5730\u5148\u4f7f\u7528 <code>docker-compose</code> \u6765\u8fd0\u884c\u8be5\u5e94\u7528\uff1a</p> <pre><code>$ docker-compose up -d\n</code></pre> <p>\u62a5\u9519\u4e86</p> <pre><code>...\nnpm WARN npm npm does not support Node.js v10.15.2\nnpm WARN npm You should probably upgrade to a newer version of node as we\nnpm WARN npm can't make any promises that npm will work with this version.\nnpm WARN npm Supported releases of Node.js are the latest release of 4, 6, 7, 8, 9.\nnpm WARN npm You can find the latest version at https://nodejs.org/\n...\n</code></pre> <p>\u4fee\u6539<code>Dockerfile</code>\u4e86 </p> <pre><code>FROM ubuntu:19.04\n\nRUN apt-get update\nRUN apt-get install -y python python-pip\nRUN apt-get install -y npm nodejs\n\nCOPY . /app\n\nRUN pip install -r /app/requirements.txt\nRUN npm install npm@latest -g    # update npm tp the latest version\nRUN npm install --prefix /app/demo_app/src --no-package-lock\nRUN npm run-script build --prefix /app/demo_app/src\n\nWORKDIR /app/demo_app\nENV prometheus_multiproc_dir /tmp\nEXPOSE 8000\nCMD [ \"gunicorn\", \"-c\", \"config.py\", \"-w\", \"4\", \"-b\", \"0.0.0.0:8000\", \"server\"]\n</code></pre> <p>\u542f\u52a8\u540e\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 <code>localhost:8000</code> \u6765\u8bbf\u95ee\u6211\u4eec\u7684\u5e94\u7528\uff1a</p> <p></p> <p>\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684 <code>Web</code> \u5e94\u7528\uff0c\u70b9\u51fb <code>Hit me!</code> \u6309\u94ae\u4f1a\u5411\u7f51\u7ad9\u7684\u4e00\u4e2a\u670d\u52a1\u7aef\u70b9\u53d1\u8d77\u4e00\u4e2a <code>POST</code> \u8bf7\u6c42\uff0c\u8be5\u7aef\u70b9\u4e0a\u7684 <code>Promethues</code> \u88c5\u9970\u5668\u4f1a\u5c06\u8be5\u8bf7\u6c42\u8bb0\u5f55\u4e0b\u6765\u3002</p> <p>\u6bcf\u6b21\u63a5\u6536\u5230 <code>POST</code> \u8bf7\u6c42\u65f6\uff0c\u5e94\u7528\u7a0b\u5e8f\u90fd\u4f1a\u589e\u52a0\u4e00\u4e2a <code>Prometheus Counter</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5e94\u7528\u7684 <code>/metrics</code> \u63a5\u53e3\u6765\u83b7\u53d6\u6307\u6807\u6570\u636e\uff0c\u6700\u7ec8\u6211\u4eec\u4f1a\u5c06\u8be5\u63a5\u53e3\u914d\u7f6e\u5230 <code>Prometheus</code> \u4e2d\u5b9a\u671f\u6293\u53d6\u6307\u6807\u6570\u636e\u3002</p> <pre><code>$ curl -s localhost:8000/metrics | grep demo_app_button_clicks\n# HELP demo_app_button_clicks_total Multiprocess metric\n# TYPE demo_app_button_clicks_total counter\ndemo_app_button_clicks_total 0.0\n</code></pre> <p><code>Prometheus Counter\uff08\u8ba1\u6570\u5668\uff09</code>\u53ea\u4f1a\u589e\u52a0\uff1a\u6c38\u8fdc\u4e0d\u4f1a\u51cf\u5c11\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u9875\u9762\u4e0a\u70b9\u51fb\u4e0b\u6309\u94ae\uff0c\u7136\u540e\u518d\u6765\u770b\u4e0b\u6307\u6807\u6570\u636e\u7684\u53d8\u5316\uff0c\u6b63\u5e38\u6765\u8bf4\u4f1a\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ curl -s localhost:8000/metrics | grep demo_app_button_clicks\n# HELP demo_app_button_clicks_total Multiprocess metric\n# TYPE demo_app_button_clicks_total counter\ndemo_app_button_clicks_total 3.0\n</code></pre>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#2-prometheus-operator","title":"2 \u5b89\u88c5 Prometheus Operator","text":"<p>\u6211\u4eec\u8fd9\u91cc\u6765\u4f7f\u7528 <code>Prometheus Operator</code>\uff0c\u8fd9\u4e2a <code>Operator</code> \u901a\u8fc7\u62bd\u8c61\u5316 Prometheus \u7684\u90e8\u7f72\u6765\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u52a0\u7b80\u5355\u65b9\u4fbf\u7684\u65b9\u6cd5\u6765\u4f7f\u7528 Prometheus\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u5728 kube-ops \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5b89\u88c5 <code>Prometheus Operator</code>\uff1a</p> <pre><code>helm install stable/prometheus-operator -f helm-values/prometheus-operator-values.yml -n prome-demo --namespace kube-ops\nNAME:   prome-demo\nLAST DEPLOYED: Mon Nov 18 16:19:55 2019\nNAMESPACE: kube-ops\nSTATUS: DEPLOYED\n\nRESOURCES:\n==&gt; v1/ClusterRole\nNAME                                       AGE\nprome-demo-grafana-clusterrole             35s\nprome-demo-prometheus-oper-operator        35s\nprome-demo-prometheus-oper-operator-psp    35s\nprome-demo-prometheus-oper-prometheus      35s\nprome-demo-prometheus-oper-prometheus-psp  35s\npsp-prome-demo-kube-state-metrics          35s\npsp-prome-demo-prometheus-node-exporter    35s\n...\n\nNOTES:\nThe Prometheus Operator has been installed. Check its status by running:\n  kubectl --namespace kube-ops get pods -l \"release=prome-demo\"\n\nVisit https://github.com/coreos/prometheus-operator for instructions on how\nto create &amp; configure Alertmanager and Prometheus instances using the Operator.\n</code></pre> <p>\u5728\u5b89\u88c5\u5b8c\u6210\u540e\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u63d0\u793a\u547d\u4ee4\u6765\u67e5\u770b Pod \u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl --namespace kube-ops get pods -l \"release=prome-demo\"\nNAME                                                   READY   STATUS    RESTARTS   AGE\nprome-demo-grafana-6c774cf988-d9dct                    2/2     Running   0          23h\nprome-demo-prometheus-node-exporter-srkr6              1/1     Running   0          23h\nprome-demo-prometheus-oper-operator-6f74cf9578-whvdx   2/2     Running   0          23h\n</code></pre>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#psp-configuration","title":"**\u53ef\u80fd\u51fa\u73b0\u7684\u95ee\u9898 <code>psp Configuration</code> **","text":"<pre><code>$ kubectl --namespace kube-ops get pods -l \"release=prome-demo\"\nNAME                                                   READY   STATUS         RESTARTS   AGE\nprome-demo-grafana-944f89874-kf8nt                     0/2     Init:Blocked   0          10m\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5927\u90e8\u5206 <code>Pod</code>\u90fd\u6b63\u5e38\u4e86\uff0c\u4f46\u662f <code>grafana</code> \u8fd9\u4e2a <code>Pod</code> \u73b0\u5728\u662f\u5904\u4e8e <code>Init:Blocked</code> \u72b6\u6001\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>kubectl describe</code> \u547d\u4ee4\u67e5\u770b\u4e0b <code>Pod</code> \u7684\u8fd0\u884c\u4e8b\u4ef6\uff1a</p> <pre><code>$ kubectl describe pod prome-demo-grafana-944f89874-kf8nt -n kube-ops\nName:               prome-demo-grafana-944f89874-kf8nt\nNamespace:          kube-ops\nPriority:           0\nPriorityClassName:  &lt;none&gt;\nNode:               ydzs-node2/10.151.30.23\nStart Time:         Fri, 27 Sep 2019 09:02:42 +0800\nLabels:             app=grafana\n                    pod-template-hash=944f89874\n                    release=prome-demo\nAnnotations:        checksum/config: 062340540c04487760c6487c9c4195fdca5ed6521330d6b842b61f3964fcabe4\n                    checksum/dashboards-json-config: 01ba4719c80b6fe911b091a7c05124b64eeece964e09c058ef8f9805daca546b\n                    checksum/sc-dashboard-provider-config: 511400f9e888cb5ae2906a914e06cbdcb1f19904cf150384c0bb9831723bee45\n                    checksum/secret: 5bf8b81f17dbd08ebd81e7e67fd393d5936aeadf8285480e899cd28a92267890\n                    container.apparmor.security.beta.kubernetes.io/grafana: runtime/default\n                    container.apparmor.security.beta.kubernetes.io/grafana-sc-dashboard: runtime/default\n                    container.apparmor.security.beta.kubernetes.io/grafana-sc-datasources: runtime/default\n                    kubernetes.io/psp: prome-demo-grafana\n                    seccomp.security.alpha.kubernetes.io/pod: docker/default\nStatus:             Pending\nReason:             AppArmor\nMessage:            Cannot enforce AppArmor: AppArmor is not enabled on the host\nIP:\nControlled By:      ReplicaSet/prome-demo-grafana-944f89874\n......\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u5176\u4e2d\u6709\u4e00\u53e5 <code>Cannot enforce AppArmor: AppArmor is not enabled on the host</code> \u8fd9\u6837\u7684 <code>Message</code> \u4fe1\u606f\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u96c6\u7fa4\u4e2d\u5f00\u542f\u4e86 <code>PSP</code> \u5b89\u5168\u7b56\u7565\uff0c\u800c\u6211\u4eec\u4f7f\u7528 <code>Helm</code> \u5b89\u88c5 <code>Prometheus Operator</code> \u7684\u65f6\u5019\uff0c\u4f1a\u7ed9\u6211\u4eec\u6dfb\u52a0\u4e0a\u4e00\u4e9b <code>PSP</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get psp -l release=prome-demo\nNAME                                    PRIV    CAPS   SELINUX    RUNASUSER   FSGROUP     SUPGROUP    READONLYROOTFS   VOLUMES\nprome-demo-grafana                      false          RunAsAny   RunAsAny    RunAsAny    RunAsAny    false            configMap,emptyDir,projected,secret,downwardAPI,persistentVolumeClaim\nprome-demo-grafana-test                 false          RunAsAny   RunAsAny    RunAsAny    RunAsAny    false            configMap,downwardAPI,emptyDir,projected,secret\nprome-demo-prometheus-node-exporter     false          RunAsAny   RunAsAny    MustRunAs   MustRunAs   false            configMap,emptyDir,projected,secret,downwardAPI,persistentVolumeClaim,hostPath\nprome-demo-prometheus-oper-operator     false          RunAsAny   RunAsAny    MustRunAs   MustRunAs   false            configMap,emptyDir,projected,secret,downwardAPI,persistentVolumeClaim\nprome-demo-prometheus-oper-prometheus   false          RunAsAny   RunAsAny    MustRunAs   MustRunAs   false            configMap,emptyDir,projected,secret,downwardAPI,persistentVolumeClaim\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u7f16\u8f91 <code>prome-demo-grafana</code> \u8fd9\u4e2a <code>PSP</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl edit psp prome-demo-grafana\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u96c6\u7fa4\u4e2d\u6ca1\u6709\u5b89\u88c5 <code>apparmor</code>\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u5c06 <code>annotations</code> \u5f53\u4e2d\u7684\u4e24\u884c\u6570\u636e\u5220\u9664\u5373\u53ef\uff1a</p> <pre><code>apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default\napparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default\n</code></pre>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#3","title":"3 \u6269\u5bb9","text":""},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#3-1","title":"3-1 \u90e8\u7f72\u5e94\u7528\u5230\u96c6\u7fa4\u4e2d","text":"<p>\u5728\u6211\u4eec\u7684\u4ee3\u7801\u76ee\u5f55\u4e0b\u9762\u6267\u884c\u4e0b\u9762\u7684\u90e8\u7f72\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl apply -f manifests/deployment.yml -f manifests/service.yml -f manifests/ingress.yml\ndeployment.apps/prometheus-demo-app created\nservice/prometheus-demo-app created\n</code></pre> <p>\u8fd9\u4f1a\u521b\u5efa\u4e00\u4e2a\u6211\u4eec\u5e94\u7528\u7684 <code>Deployment</code> \u548c <code>Service</code> \u8d44\u6e90\u5bf9\u8c61\u5230\u6211\u4eec\u96c6\u7fa4\u4e2d\uff0c</p> <p>\u6b64\u5916\uff0c\u8fd8\u5305\u62ec\u4e00\u4e2a <code>Ingress</code> \u8d44\u6e90\u5bf9\u8c61\uff0c\u7528\u6765\u66b4\u9732\u7ed9\u5916\u90e8\u7528\u6237\u4f7f\u7528\u7684\u3002</p> <pre><code>manifests/ingress.yml\n</code></pre> <ul> <li>\u5916\u90e8\u670d\u52a1\u53d1\u73b0\u4e4b ingress(\u4e00)</li> <li><code>nginx-ingress</code> \u7684\u5b89\u88c5\u4f7f\u7528</li> </ul> <pre><code>apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\n  name: prometheus-demo-app\nspec:\n  rules:\n    - host: prom-demo.ny152.com\n      http:\n        paths:\n          - path: /\n            backend:\n              serviceName: prometheus-demo-app\n              servicePort: 8080\n# apiVersion: traefik.containo.us/v1alpha1\n# kind: IngressRoute\n# metadata:\n#   name: prometheus-demo-app\n# spec:\n#   entryPoints:\n#     - web\n#   routes:\n#   - match: Host(`prom-demo.ny152.com`)  #\u6ce8\u610f\u4fee\u6539\n#     kind: Rule\n#     services:\n#     - name: prometheus-demo-app\n#       port: 8080\n</code></pre> <p>\u7136\u540e\u4e3a\u4e86\u65b9\u4fbf\u6211\u4eec\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee <code>Prometheus</code> \u7684 <code>Dashboard</code>\uff0c\u6211\u4eec\u5c06\u90e8\u7f72\u7684 <code>Prometheus</code> \u7684 <code>Service</code> \u6539\u6210 <code>NodePort</code> \u7c7b\u578b\uff1a</p> <pre><code>$ kubectl edit svc prome-demo-prometheus-oper-prometheus -n kube-ops\n# \u5c06 spec.type \u6539\u6210 NodePort\n\n$ kubectl get svc -n kube-ops -l release=prome-demo\nNAME                                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)            AGE\nprome-demo-grafana                      NodePort    10.106.151.204   &lt;none&gt;        80:31310/TCP       23h\nprome-demo-prometheus-node-exporter     ClusterIP   10.111.181.43    &lt;none&gt;        9100/TCP           23h\nprome-demo-prometheus-oper-operator     ClusterIP   10.110.17.60     &lt;none&gt;        8080/TCP,443/TCP   23h\nprome-demo-prometheus-oper-prometheus   NodePort    10.107.93.192    &lt;none&gt;        9090:31339/TCP     23h\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>http://NodeIP:31339</code> \u6765\u8bbf\u95ee\u6211\u4eec\u7684 <code>Prometheus</code> \u9875\u9762\u4e86\uff0c\u5207\u6362\u5230 <code>/targets</code> \u9875\u9762\u4e0b\u9762\uff0c\u5c31\u4f1a\u770b\u5230\u6b63\u5728\u76d1\u63a7\u7684\u7aef\u70b9\u5217\u8868\u4e86\uff0c\u5176\u4e2d\u5c31\u5305\u62ec\u5b89\u88c5 <code>Prometheus Operator</code> \u7684 <code>CRD</code> \u63a7\u5236\u5668\uff0c\u5f53\u7136\u53ef\u80fd\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6709\u4e00\u4e9b\u76d1\u63a7\u6570\u636e\u6709\u95ee\u9898\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u6211\u4eec\u6839\u636e\u81ea\u5df1\u96c6\u7fa4\u7684\u5b9e\u9645\u60c5\u51b5\u53bb\u505a\u5bf9\u5e94\u7684\u8c03\u6574\u4e86\uff1a</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u90e8\u7f72\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\u76d1\u63a7\uff0c\u8ba9 Proemthues \u4e5f\u53ef\u4ee5\u6293\u53d6\u5230\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\u76d1\u63a7\u6307\u6807\u6570\u636e\uff0c\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f manifests/service-monitor.yml\nservicemonitor.monitoring.coreos.com/prometheus-demo-app created\n</code></pre> <p>\u8be5\u8d44\u6e90\u5bf9\u8c61\u5185\u5bb9\u975e\u5e38\u7b80\u5355\uff0c\u5c31\u662f\u4e00\u4e2a\u7b80\u5355\u7684 <code>ServiceMonitor</code> \u5bf9\u8c61\uff0c<code>ServiceMonitor</code> \u662f <code>Prometheus</code> \u83b7\u53d6\u5e94\u7528\u76d1\u63a7\u6570\u636e\u7684\u4e00\u4e2a <code>CRD</code> \u5bf9\u8c61\uff0c\u5bf9 <code>ServiceMonitor</code> \u4e0d\u591f\u719f\u6089\u7684\u53ef\u4ee5\u67e5\u770b\u6211\u4eec\u524d\u9762\u7684Prometheus Operator \u7684\u76f8\u5173\u6587\u6863</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: prometheus-demo-app\n  namespace: kube-ops\nspec:\n  endpoints:\n  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token\n    interval: 15s\n    port: web\n  selector:\n    matchLabels:\n      app: prometheus-demo-app\n  namespaceSelector:\n    matchNames:\n    - default\n</code></pre> <p>\u8be5\u5bf9\u8c61\u901a\u77e5 <code>Prometheus Operator</code> \u914d\u7f6e\u8fd0\u884c\u4e2d\u7684 <code>Prometheus</code> \u5b9e\u4f8b\uff0c\u76d1\u542c\u5e26\u6709\u6807\u7b7e <code>app=prometheus-demo-app</code> \u7684\u670d\u52a1\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb <code>Prometheus</code> \u7684\u9875\u9762\u4e0a\u9762\u67e5\u770b <code>/targets</code> \u9875\u9762\u5c31\u4f1a\u53d1\u73b0\u6211\u4eec\u7684\u5e94\u7528\u5df2\u7ecf\u914d\u7f6e\u5728\u91cc\u9762\u4e86\uff0c\u7136\u540e\u5728 <code>Dashboard</code> \u9875\u9762\u4e0a\u8f93\u5165\u4e0b\u9762\u7684 <code>promql</code> \u8bed\u53e5\uff1a</p> <p></p> <pre><code>demo_app_button_clicks_total\n</code></pre> <p>\u8fd9\u4e2a\u6307\u6807\u5c31\u53cd\u5e94\u51fa\u4e86\u6211\u4eec\u5e94\u7528\u7a0b\u5e8f\u7684\u6240\u6709\u5b9e\u4f8b\u4e2d\u6309\u94ae\u7684\u603b\u5171\u70b9\u51fb\u6b21\u6570\u3002</p> <p></p>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#4","title":"4 \u6269\u5bb9","text":"<p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a Prometheus Adapter for Kubernetes Metrics APIs  \u7684 <code>k8s</code> \u7684 <code>API</code> \u6269\u5c55\u5e94\u7528\uff0c\u5b83\u53ef\u4ee5\u4f7f\u7528\u7528\u6237\u81ea\u5b9a\u4e49\u7684 <code>Prometheus</code> \u67e5\u8be2\u6765\u4f7f\u7528 <code>k8s</code> \u8d44\u6e90\u548c\u81ea\u5b9a\u4e49\u6307\u6807 API\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06 <code>Prometheus-Adapter</code> \u5b89\u88c5\u5230\u96c6\u7fa4\u4e2d\uff0c\u5e76\u6dfb\u52a0\u4e00\u4e2a\u89c4\u5219\u6765\u8ddf\u8e2a\u6bcf\u4e2a Pod \u7684\u8bf7\u6c42\u3002\u89c4\u5219\u7684\u5b9a\u4e49\u6211\u4eec\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff0c\u6bcf\u4e2a\u89c4\u5219\u5927\u81f4\u53ef\u4ee5\u5206\u4e3a4\u4e2a\u90e8\u5206\uff1a</p> <ul> <li><code>Discovery</code>\uff1a\u5b83\u6307\u5b9a <code>Adapter</code> \u5e94\u8be5\u5982\u4f55\u627e\u5230\u8be5\u89c4\u5219\u7684\u6240\u6709 <code>Prometheus</code> \u6307\u6807</li> <li><code>Association</code>\uff1a\u6307\u5b9a <code>Adapter</code> \u5e94\u8be5\u5982\u4f55\u786e\u5b9a\u548c\u7279\u5b9a\u7684\u6307\u6807\u5173\u8054\u7684 <code>Kubernetes</code> \u8d44\u6e90</li> <li><code>Naming</code>\uff1a\u6307\u5b9a <code>Adapter</code> \u5e94\u8be5\u5982\u4f55\u5728\u81ea\u5b9a\u4e49\u6307\u6807 <code>API</code> \u4e2d\u66b4\u9732\u6307\u6807</li> <li><code>Querying</code>\uff1a\u6307\u5b9a\u5982\u4f55\u5c06\u5bf9\u4e00\u4e2a\u83b7\u591a\u4e2a <code>Kubernetes</code> \u5bf9\u8c61\u4e0a\u7684\u7279\u5b9a\u6307\u6807\u7684\u8bf7\u6c42\u8f6c\u6362\u4e3a\u5bf9 <code>Prometheus</code> \u7684\u67e5\u8be2</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u5c31\u6765\u7f16\u5199\u6211\u4eec\u81ea\u5df1\u7684\u89c4\u5219\uff0c\u9996\u5148\u6dfb\u52a0 <code>rules</code> \u719f\u6089\u5230\u914d\u7f6e\u6587\u4ef6\u4e2d\uff1a</p> <pre><code>rules: []\n</code></pre>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#4-1-discover","title":"4-1 discover","text":"<p>\u6211\u4eec\u8fd9\u91cc\u53ea\u9700\u8981\u53d1\u73b0\uff08<code>discover</code>\uff09\u4e00\u4e2a\u6307\u6807 <code>demo_app_button_clicks_total</code>\uff0c\u6dfb\u52a0\u4e00\u4e2a\u975e\u7a7a\u7684 <code>Pod</code> \u6807\u7b7e\u5339\u914d\u6765\u8fc7\u6ee4\uff1a</p> <pre><code>rules:\n- seriesQuery: 'demo_app_button_clicks_total{pod!=\"\"}'\n</code></pre>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#4-2-association","title":"4-2 Association","text":"<p>\u5173\u8054\uff08<code>Association</code>\uff09\u5c31\u975e\u5e38\u7b80\u5355\u4e86\uff0c<code>Prometheus</code> \u6807\u7b7e\u90fd\u76f4\u63a5\u6620\u5c04\u5230 <code>Kubernetes</code> \u8d44\u6e90\uff08<code>job</code>\u3001<code>namespace</code>\u3001<code>pod</code> \u7b49\u7b49\uff09\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u6a21\u677f\u6765\u9690\u5c04\u8d44\u6e90\uff1a</p> <pre><code>rules:\n- seriesQuery: 'demo_app_button_clicks_total{pod!=\"\"}'\n  resources: {template: \"&lt;&lt;.Resource&gt;&gt;\"}\n</code></pre>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#4-3-naming","title":"4-3 naming","text":"<p>\u6211\u4eec\u6f14\u793a\u5e94\u7528\u7684\u6309\u94ae\u70b9\u51fb\u603b\u548c\u5b9e\u9645\u4e0a\u7528\u5904\u4e0d\u5927\uff0c\u6211\u4eec\u9700\u8981\u6309\u7167\u6bcf\u4e2a Pod \u6765\u8fdb\u884c\u6269\u5bb9\uff0c\u7136\u540e\u5728\u89c4\u5219\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u7b80\u5355\u7684\u547d\u540d\uff08<code>naming</code>\uff09\u5b9a\u4e49\uff1a</p> <pre><code>rules:\n- seriesQuery: 'demo_app_button_clicks_total{pod!=\"\"}'\n  resources: {template: \"&lt;&lt;.Resource&gt;&gt;\"}\n  name:\n    matches: \"^(.*)_total\"\n    as: \"${1}_per_second\"\n</code></pre>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#4-4-querying","title":"4-4 Querying","text":"<p>\u7136\u540e\u5c31\u53ef\u4ee5\u5b9a\u4e49\u67e5\u8be2\uff08<code>Querying</code>\uff09\u4e86\uff1a</p> <pre><code>seriesQuery: 'demo_app_button_clicks_total{pod!=\"\"}'\nresources: { template: \"&lt;&lt;.Resource&gt;&gt;\" }\nname:\n  matches: \"^(.*)_total\"\n  as: \"${1}_per_second\"\nmetricsQuery: \"sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)\"\n</code></pre> <p>\u8fd9\u662f\u4e00\u4e2a\u5e26\u53c2\u6570\u7684 <code>Prometheus</code> \u67e5\u8be2\uff0c\u5176\u4e2d\uff1a</p> <ul> <li><code>Series</code> \u662f\u6709 <code>seriesQuery</code> \u5339\u914d\u7684\u4efb\u4f55 <code>series</code>\uff0c\u8be5\u89c4\u5219\u53ea\u6709\u4e00\u4e2a <code>series</code>\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5c06 <code>demo_app_button_clicks+total</code> \u66ff\u6362\u6210<code>&lt;&lt;.Series&gt;&gt;</code>\u3002</li> <li><code>&lt;&lt;.LabelMatchers&gt;&gt;</code> \u662f <code>adapter</code> \u6765\u66ff\u6362\u6210\u6807\u7b7e\u67e5\u8be2\u7684\uff08\u6bd4\u5982\uff0c<code>pod='deployment-name-abcd-1234\uff09</code>\u3002</li> <li><code>&lt;&lt;.GroupBy&gt;&gt;</code> \u8868\u793a\u6211\u4eec\u60f3\u8981\u6269\u5c55\u7684\u8d44\u6e90\uff0c\u6211\u4eec\u8fd9\u91cc\u5c31\u662f <code>Pod</code> \u4e86\u3002</li> </ul> <p><code>Promethues-Adapter</code> \u7684\u4e00\u4e2a\u7f3a\u70b9\u662f\u914d\u7f6e\u662f\u901a\u8fc7\u9759\u6001\u6587\u4ef6\u548c\u5e94\u7528\u7a0b\u5e8f\u4e00\u8d77\u90e8\u7f72\u7684\uff0c\u800c\u4e0d\u662f\u901a\u8fc7 <code>ConfigMap</code> \u6216\u8005\u5176\u4ed6\u57fa\u4e8e <code>API</code> \u7684\u5bf9\u8c61\u6765\u914d\u7f6e\u7684\uff0c</p> <p>\u6211\u4eec\u8fd9\u91cc\u5c06\u4f7f\u7528\u53e6\u5916\u4e00\u4e2a <code>Helm Chart</code> \u6765\u90e8\u7f72\uff0c\u901a\u8fc7\u8986\u76d6 <code>values</code> \u6587\u4ef6\u6765\u914d\u7f6e\u89c4\u5219\u3002</p> <p><code>values</code> \u6587\u4ef6\u653e\u7f6e\u5728\u9879\u76ee\u76ee\u5f55 <code>helm-values/prometheus-adapter-values.yml</code>\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>rules:\n  default: false\n  custom:\n  - seriesQuery: 'demo_app_button_clicks_total'\n    resources: { template: \"&lt;&lt;.Resource&gt;&gt;\" }\n    name:\n      matches: \"^(.*)_total\"\n      as: \"${1}_per_second\"\n    metricsQuery: \"sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)\"\nprometheus:\n  url: http://prom-demo-prometheus-opera-prometheus.default\n</code></pre> <p>\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e00\u952e\u5b89\u88c5\uff1a</p> <pre><code>$ helm install stable/prometheus-adapter -n prome-adapter -f helm-values/prometheus-adapter-values.yml --namespace kube-ops\nLAST DEPLOYED: Fri Sep 27 10:54:56 2019\nNAMESPACE: kube-ops\nSTATUS: DEPLOYED\n\nRESOURCES:\n\n......\n\nNOTES:\nprome-adapter-prometheus-adapter has been deployed.\nIn a few minutes you should be able to list metrics using the following command(s):\n\n  kubectl get --raw /apis/custom.metrics.k8s.io/v1beta1\n</code></pre> <p>\u7b49\u4e00\u5c0f\u4f1a\u513f\uff0c\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u68c0\u6d4b\u662f\u5426\u751f\u6548\u4e86\uff1a</p> <p>\u6b63\u5e38\u6765\u8bf4\u4f1a\u770b\u5230\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get --raw=\"/apis/custom.metrics.k8s.io/v1beta1\" | jq\n{\n  \"kind\": \"APIResourceList\",\n  \"apiVersion\": \"v1\",\n  \"groupVersion\": \"custom.metrics.k8s.io/v1beta1\",\n  \"resources\": [\n    {\n      \"name\": \"jobs.batch/demo_app_button_clicks_per_second\",\n      \"singularName\": \"\",\n      \"namespaced\": true,\n      \"kind\": \"MetricValueList\",\n      \"verbs\": [\n        \"get\"\n      ]\n    },\n    {\n      \"name\": \"namespaces/demo_app_button_clicks_per_second\",\n      \"singularName\": \"\",\n      \"namespaced\": false,\n      \"kind\": \"MetricValueList\",\n      \"verbs\": [\n        \"get\"\n      ]\n    },\n    {\n      \"name\": \"pods/demo_app_button_clicks_per_second\",\n      \"singularName\": \"\",\n      \"namespaced\": true,\n      \"kind\": \"MetricValueList\",\n      \"verbs\": [\n        \"get\"\n      ]\n    },\n    {\n      \"name\": \"services/demo_app_button_clicks_per_second\",\n      \"singularName\": \"\",\n      \"namespaced\": true,\n      \"kind\": \"MetricValueList\",\n      \"verbs\": [\n        \"get\"\n      ]\n    }\n  ]\n}\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u53ef\u4ee5\u83b7\u53d6\u6211\u4eec\u81ea\u5df1 Pod \u7684\u6307\u6807\u6570\u636e\uff1a</p> <pre><code>$ kubectl get --raw=\"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/demo_app_button_clicks_per_second?pod=$(kubectl get po -l app=prometheus-demo-app -o name)\" | jq\n</code></pre> <p>\u6b63\u5e38\u4f1a\u8f93\u51fa\u5982\u4e0b\u6240\u793a\u7684\u4e00\u4e9b\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get --raw=\"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/demo_a\npp_button_clicks_per_second?pod=$(kubectl get po -l app=prometheus-demo-app -o name)\" | jq\n{\n  \"kind\": \"MetricValueList\",\n  \"apiVersion\": \"custom.metrics.k8s.io/v1beta1\",\n  \"metadata\": {\n    \"selfLink\": \"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/demo_app_button_clicks_per_second\"\n  },\n  \"items\": [\n    {\n      \"describedObject\": {\n        \"kind\": \"Pod\",\n        \"namespace\": \"default\",\n        \"name\": \"prometheus-demo-app-8585d447c6-77st2\",\n        \"apiVersion\": \"/v1\"\n      },\n      \"metricName\": \"demo_app_button_clicks_per_second\",\n      \"timestamp\": \"2019-11-18T08:49:26Z\",\n      \"value\": \"0\"\n    }\n  ]\n}\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u7684 <code>value</code> \u503c\u4e3a<code>0</code>\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5f00\u59cb\u70b9\u51fb\u9875\u9762\u4e0a\u9762\u7684\u6309\u94ae\uff0c\u6240\u4ee5\u901f\u7387\u662f\u6bcf\u79d2\u4e3a<code>0</code>\u3002\u6211\u4eec\u4e0a\u9762\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\u521b\u5efa\u4e86\u4e00\u4e2a <code>Ingress</code> \u5bf9\u8c61\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u57df\u540d\uff08\u505a\u597d <code>DNS</code> \u89e3\u6790\u540e\uff09\u76f4\u63a5\u8bbf\u95ee\u6211\u4eec\u7684\u5e94\u7528\uff0c\u7136\u540e\u70b9\u51fb\u9875\u9762\u4e0a\u9762\u7684\u6309\u94ae\u540e\uff0c\u91cd\u65b0\u6765\u8fd0\u884c\u4e0a\u9762\u7684\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u901f\u7387\u4f1a\u589e\u52a0\u3002</p> <p>\u8fd9\u91cc\u6211\u7528\u7684\u662f<code>NodePort</code>\u7684</p> <pre><code>$ kubectl edit svc prome-demo-prometheus-oper-prometheus  -n kube-ops\nservice/prome-demo-grafana edited\n</code></pre> <pre><code>$ kubectl get svc  -n kube-ops\nNAME                                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)            AGE\nprome-adapter-prometheus-adapter        ClusterIP   10.98.162.83     &lt;none&gt;        443/TCP            17h\nprome-demo-grafana                      ClusterIP   10.106.151.204   &lt;none&gt;        80/TCP             17h\nprome-demo-kube-state-metrics           ClusterIP   10.107.26.121    &lt;none&gt;        8080/TCP           17h\nprome-demo-prometheus-node-exporter     ClusterIP   10.111.181.43    &lt;none&gt;        9100/TCP           17h\nprome-demo-prometheus-oper-operator     ClusterIP   10.110.17.60     &lt;none&gt;        8080/TCP,443/TCP   17h\nprome-demo-prometheus-oper-prometheus   NodePort    10.107.93.192    &lt;none&gt;        9090:31339/TCP     17h\nprometheus-operated                     ClusterIP   None             &lt;none&gt;        9090/TCP           17h\n</code></pre> <pre><code>http://127.0.0.1:31339\n</code></pre>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#5-hpa","title":"5 \u90e8\u7f72 HPA \u5bf9\u8c61","text":"<p><code>Pod</code>\u6c34\u5e73\u81ea\u52a8\u4f38\u7f29\uff08<code>HPA</code>\uff09\u53ef\u4ee5\u6839\u636e\u4e00\u4e9b\u7279\u5b9a\u6761\u4ef6\u6765\u81ea\u52a8\u6dfb\u52a0\u65b0\u7684 <code>Pod</code> \u5230 <code>Deployment</code> \u4e2d\u53bb\uff0c\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a <code>HPA</code> \u5bf9\u8c61\uff0c\u8bbe\u5b9a\u76ee\u6807\u4e3a\u6bcf\u4e2a <code>Pod</code> \u6bcf\u79d2 <code>0.01</code> \u6b21\u70b9\u51fb\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u6d4b\u8bd5\u4e0b\u8ba9\u6211\u4eec\u7684\u5e94\u7528\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\uff0c\u9996\u5148\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u786e\u4fdd\u73b0\u5728\u53ea\u6709\u4e00\u4e2a Pod \u6b63\u5728\u8fd0\u884c\uff1a</p> <pre><code>$  kubectl get po -l app=prometheus-demo-app\nNAME                                   READY   STATUS    RESTARTS   AGE\nprometheus-demo-app-8585d447c6-77st2   1/1     Running   0          23h\n</code></pre> <p>\u7136\u540e\u521b\u5efa HPA \u5bf9\u8c61\uff0c\u5bf9\u8c61\u5bf9\u5e94\u7684\u8d44\u6e90\u6587\u4ef6\u4f4d\u4e8e\u4ee3\u7801\u6839\u76ee\u5f55\u4e0b\u9762 <code>manifests/hpa.yaml</code>\uff0c\u5b8c\u6574\u7684\u5185\u5bb9\u5982\u4e0b\u6240\u793a</p> <pre><code>kind: HorizontalPodAutoscaler\napiVersion: autoscaling/v2beta1\nmetadata:\n  name: prometheus-demo-app\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: prometheus-demo-app\n  # autoscale between 1 and 10 replicas\n  minReplicas: 1\n  maxReplicas: 10\n  metrics:\n  # use a \"Pods\" metric, which takes the average of the\n  # given metric across all pods controlled by the autoscaling target\n  - type: Pods\n    pods:\n      metricName: demo_app_button_clicks_per_second\n      targetAverageValue: 10m\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f manifests/hpa.yml\nhorizontalpodautoscaler.autoscaling/prometheus-demo-app created\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u6211\u4eec\u7684\u5e94\u7528\uff0c\u70b9\u51fb\u4e00\u4f1a\u513f\u9875\u9762\u4e0a\u9762\u7684\u6309\u94ae\uff0c\u7136\u540e\u91cd\u65b0\u8fd0\u884c\u4e0a\u9762\u7684\u547d\u4ee4\uff0c\u6b63\u5e38\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u7684\u5e94\u7528\u7684 <code>Deployment</code> \u5c31\u5df2\u7ecf\u5f00\u59cb\u6269\u5bb9\u4e86\uff1a</p> <pre><code>$ kubectl get po -l app=prometheus-demo-app\nNAME                                   READY   STATUS    RESTARTS   AGE\nprometheus-demo-app-8585d447c6-4sls9   1/1     Running   0          5m18s\nprometheus-demo-app-8585d447c6-77st2   1/1     Running   0          17h\nprometheus-demo-app-8585d447c6-8x59q   1/1     Running   0          5m18s\nprometheus-demo-app-8585d447c6-95vtx   1/1     Running   0          5m33s\nprometheus-demo-app-8585d447c6-dnklw   1/1     Running   0          5m3s\nprometheus-demo-app-8585d447c6-g9scp   1/1     Running   0          5m18s\nprometheus-demo-app-8585d447c6-kmkvk   1/1     Running   0          5m3s\nprometheus-demo-app-8585d447c6-rtf5x   1/1     Running   0          5m18s\nprometheus-demo-app-8585d447c6-stxpw   1/1     Running   0          5m33s\nprometheus-demo-app-8585d447c6-wtwv5   1/1     Running   0          5m33s\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u6307\u6807\u6570\u636e\u5bf9\u5e94\u7528\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u7684\u64cd\u4f5c\u3002</p>"},{"location":"chap7/23Kubernetes_Scale_Prometheus-Adapter/#6-grafana","title":"6 \u5728 <code>Grafana</code> \u4e2d\u663e\u793a\u7f29\u653e\u6570\u636e","text":"<p>\u8fd9\u90e8\u5206\u5185\u5bb9\u5176\u5b9e\u4e0d\u662f\u5fc5\u987b\u7684\uff0c\u53ea\u662f\u5355\u7eaf\u7684\u5728\u56fe\u8868\u4e0a\u5bf9\u6211\u4eec\u7684\u7f29\u653e\u6570\u636e\u8fdb\u884c\u5c55\u793a\uff0c\u8fd9\u53ef\u4ee5\u589e\u52a0\u6211\u4eec\u5bf9\u6574\u4e2a\u8fc7\u7a0b\u7684\u7406\u89e3\u3002</p> <p>\u6211\u4eec\u5c06\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5230\u7684 grafana \u7684 Dashboard \u6570\u636e\u653e\u7f6e\u5728\u4e86\u4ee3\u7801\u6839\u76ee\u5f55\u4e0b\u9762 manifests/<code>grafana-dashboard-configmap.yml</code>\uff0c\u5148\u901a\u8fc7 <code>ConfigMap</code> \u6765\u521b\u5efa\u8fd9\u4e2a Dashboard \u6570\u636e\uff1a</p> <pre><code>$ kubectl apply -f manifests/grafana-dashboard-configmap.yml\n</code></pre> <p>\u540c\u6837\u4e3a\u4e86\u65b9\u4fbf\u6211\u4eec\u8bbf\u95ee\uff0c\u5c06 <code>Prometheus Operator</code> \u4e0d\u662f\u7684 <code>grafana</code> \u7684 <code>Service</code> \u66f4\u6539\u6210 <code>NodePort</code> \u7c7b\u578b\uff1a</p> <pre><code>$ kubectl edit svc prome-demo-grafana -n kube-ops\nservice/prome-demo-grafana edited\n\n$ kubectl get svc\nNAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nkubernetes            ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          6d5h\nprometheus-demo-app   NodePort    10.108.214.168   &lt;none&gt;        8080:30062/TCP   23h\n</code></pre> <p></p> <p>\u8fd9\u4e2a\u65f6\u5019\u540c\u6837\u6211\u5c31\u53ef\u4ee5\u7528 <code>http://NodeIP:30062</code> \u6765\u8bbf\u95ee <code>grafana</code> \u5e94\u7528\u4e86\u3002\u9ed8\u8ba4\u7684\u7528\u6237\u540d\u4e3a <code>admin</code>\uff0c\u9ed8\u8ba4\u7684\u5bc6\u7801\u4e3a\uff1a<code>prom-operator</code>\uff0c\u8fdb\u5165\u9875\u9762\u540e\uff0c\u53ef\u4ee5\u9009\u62e9\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u7684 <code>Prometheus Demo App Dashboard</code> \u8fd9\u4e2a <code>Dashboard</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5e94\u7528\u5728\u6269\u7f29\u5bb9\u7684\u5b8c\u6574\u8fc7\u7a0b\uff1a</p> <p></p>"},{"location":"chap8/1Promql_basic1/","title":"1. \u521d\u8bc6 PromQL","text":"<p><code>Prometheus</code> \u63d0\u4f9b\u4e86\u4e00\u79cd\u529f\u80fd\u8868\u8fbe\u5f0f\u8bed\u8a00 <code>PromQL</code>\uff0c\u5141\u8bb8\u7528\u6237\u5b9e\u65f6\u9009\u62e9\u548c\u6c47\u805a\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u3002\u8868\u8fbe\u5f0f\u7684\u7ed3\u679c\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u663e\u793a\u4e3a\u56fe\u5f62\uff0c\u4e5f\u53ef\u4ee5\u663e\u793a\u4e3a\u8868\u683c\u6570\u636e\uff0c\u6216\u8005\u7531\u5916\u90e8\u7cfb\u7edf\u901a\u8fc7 <code>HTTP API</code> \u8c03\u7528\u3002</p>"},{"location":"chap8/1Promql_basic1/#1","title":"1 \u8868\u8fbe\u5f0f\u8bed\u8a00\u6570\u636e\u7c7b\u578b","text":"<p>\u5728 <code>Prometheus</code> \u7684\u8868\u8fbe\u5f0f\u8bed\u8a00\u4e2d\uff0c\u8868\u8fbe\u5f0f\u6216\u5b50\u8868\u8fbe\u5f0f\u5305\u62ec\u4ee5\u4e0b\u56db\u79cd\u7c7b\u578b\u4e4b\u4e00\uff1a</p> <ul> <li>\u77ac\u65f6\u5411\u91cf\uff08<code>Instant vector</code>\uff09  - \u4e00\u7ec4\u65f6\u95f4\u5e8f\u5217\uff0c\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u5305\u542b\u5355\u4e2a\u6837\u672c\uff0c\u5b83\u4eec\u5171\u4eab\u76f8\u540c\u7684\u65f6\u95f4\u6233\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8868\u8fbe\u5f0f\u7684\u8fd4\u56de\u503c\u4e2d\u53ea\u4f1a\u5305\u542b\u8be5\u65f6\u95f4\u5e8f\u5217\u4e2d\u7684\u6700\u65b0\u7684\u4e00\u4e2a\u6837\u672c\u503c\u3002\u800c\u76f8\u5e94\u7684\u8fd9\u6837\u7684\u8868\u8fbe\u5f0f\u79f0\u4e4b\u4e3a\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\u3002</li> <li>\u533a\u95f4\u5411\u91cf\uff08<code>Range vector</code>\uff09 - \u4e00\u7ec4\u65f6\u95f4\u5e8f\u5217\uff0c\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u5305\u542b\u4e00\u6bb5\u65f6\u95f4\u8303\u56f4\u5185\u7684\u6837\u672c\u6570\u636e\u3002</li> <li>\u6807\u91cf\uff08<code>Scalar</code>\uff09 - \u4e00\u4e2a\u6d6e\u70b9\u578b\u7684\u6570\u636e\u503c\u3002</li> <li>\u5b57\u7b26\u4e32\uff08<code>String</code>\uff09 - \u4e00\u4e2a\u7b80\u5355\u7684\u5b57\u7b26\u4e32\u503c\u3002</li> </ul> <p>\u6839\u7528\u6237\u8f93\u5165\u7684\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u6570\u636e\u7c7b\u578b\u662f\u5426\u5408\u6cd5\u53d6\u51b3\u4e8e\u7528\u4f8b\u7684\u4e0d\u540c\uff0c\u4f8b\u5982\uff1a\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u6570\u636e\u7c7b\u578b\u662f\u552f\u4e00\u53ef\u4ee5\u76f4\u63a5\u7ed8\u5236\u6210\u56fe\u8868\u7684\u6570\u636e\u7c7b\u578b\u3002</p>"},{"location":"chap8/1Promql_basic1/#2","title":"2 \u5b57\u9762\u91cf","text":"<p>\u5b57\u7b26\u4e32\u53ef\u4ee5\u7528\u5355\u5f15\u53f7\u3001\u53cc\u5f15\u53f7\u6216\u53cd\u5f15\u53f7\u6307\u5b9a\u4e3a\u6587\u5b57\u5e38\u91cf\u3002</p> <p><code>PromQL</code> \u9075\u5faa\u4e0e Go \u76f8\u540c\u7684\u8f6c\u4e49\u89c4\u5219\u3002\u5728\u5355\u5f15\u53f7\u6216\u53cc\u5f15\u53f7\u4e2d\uff0c\u7528\u53cd\u659c\u6760\u6765\u8868\u793a\u8f6c\u4e49\u5e8f\u5217\uff0c\u540e\u9762\u53ef\u4ee5\u8ddf <code>a, b, f, n, r, t, v \u6216 \\</code>\u3002\u7279\u6b8a\u5b57\u7b26\u53ef\u4ee5\u4f7f\u7528\u516b\u8fdb\u5236\uff08<code>\\nnn</code>\uff09\u6216\u8005\u5341\u516d\u8fdb\u5236\uff08<code>\\xnn</code>\uff0c<code>\\unnnn</code> \u548c <code>\\Unnnnnnnn</code>\uff09\u3002</p> <p>\u4e0e Go \u4e0d\u540c\uff0cPrometheus \u4e0d\u4f1a\u5bf9\u53cd\u5f15\u53f7\u5185\u7684\u6362\u884c\u7b26\u8fdb\u884c\u8f6c\u4e49\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>\"this is a string\"\n'these are unescaped: \\n \\\\ \\t'\n`these are not unescaped: \\n ' \" \\t`\n</code></pre> <p>\u6807\u91cf</p> <p>\u6807\u91cf\u6d6e\u70b9\u503c\u53ef\u4ee5\u5b57\u9762\u4e0a\u5199\u6210 <code>[-](digits)[.(digits)]</code> \u7684\u5f62\u5f0f\u3002</p> <pre><code>-2.43\n</code></pre>"},{"location":"chap8/1Promql_basic1/#3","title":"3 \u65f6\u95f4\u5e8f\u5217\u8fc7\u6ee4\u5668","text":""},{"location":"chap8/1Promql_basic1/#3-1","title":"3-1 \u77ac\u65f6\u5411\u91cf\u8fc7\u6ee4\u5668","text":"<p>\u77ac\u65f6\u5411\u91cf\u8fc7\u6ee4\u5668\u5141\u8bb8\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u6233\u5185\u9009\u62e9\u4e00\u7ec4\u65f6\u95f4\u5e8f\u5217\u548c\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u7684\u5355\u4e2a\u6837\u672c\u503c\u3002</p> <p>\u5728\u6700\u7b80\u5355\u7684\u5f62\u5f0f\u4e2d\uff0c\u8fd1\u6307\u5b9a\u6307\u6807\uff08<code>metric</code>\uff09\u540d\u79f0\u3002\u8fd9\u5c06\u751f\u6210\u5305\u542b\u6b64\u6307\u6807\u540d\u79f0\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\u7684\u5143\u7d20\u7684\u77ac\u65f6\u5411\u91cf\u3002</p> <p>\u4f8b\u5982\uff1a\u9009\u62e9\u6307\u6807\u540d\u79f0\u4e3a <code>http_requests_total</code> \u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\uff1a</p> <pre><code>http_requests_total\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7\u5411\u82b1\u62ec\u53f7<code>\uff08{}\uff09</code>\u91cc\u9644\u52a0\u4e00\u7ec4\u6807\u7b7e\u6765\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u4f8b\u5982\uff1a\u9009\u62e9\u6307\u6807\u540d\u79f0\u4e3a <code>http_requests_total</code>\uff0c<code>job</code> \u6807\u7b7e\u503c\u4e3a <code>prometheus</code>\uff0c<code>group</code> \u6807\u7b7e\u503c\u4e3a <code>canary</code> \u7684\u65f6\u95f4\u5e8f\u5217\uff1a</p> <pre><code>http_requests_total{job=\"prometheus\",group=\"canary\"}\n</code></pre> <p><code>PromQL</code> \u8fd8\u652f\u6301\u7528\u6237\u6839\u636e\u65f6\u95f4\u5e8f\u5217\u7684\u6807\u7b7e\u5339\u914d\u6a21\u5f0f\u6765\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u8fc7\u6ee4\uff0c\u76ee\u524d\u4e3b\u8981\u652f\u6301\u4e24\u79cd\u5339\u914d\u6a21\u5f0f\uff1a\u5b8c\u5168\u5339\u914d\u548c\u6b63\u5219\u5339\u914d\u3002\u603b\u5171\u6709\u4ee5\u4e0b\u51e0\u79cd\u6807\u7b7e\u5339\u914d\u8fd0\u7b97\u7b26\uff1a</p> <ul> <li><code>=</code> : \u9009\u62e9\u4e0e\u63d0\u4f9b\u7684\u5b57\u7b26\u4e32\u5b8c\u5168\u76f8\u540c\u7684\u6807\u7b7e\u3002</li> <li><code>!=</code> : \u9009\u62e9\u4e0e\u63d0\u4f9b\u7684\u5b57\u7b26\u4e32\u4e0d\u76f8\u540c\u7684\u6807\u7b7e\u3002</li> <li><code>=~</code> : \u9009\u62e9\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u63d0\u4f9b\u7684\u5b57\u7b26\u4e32\uff08\u6216\u5b50\u5b57\u7b26\u4e32\uff09\u76f8\u5339\u914d\u7684\u6807\u7b7e\u3002</li> <li><code>!~</code> : \u9009\u62e9\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u63d0\u4f9b\u7684\u5b57\u7b26\u4e32\uff08\u6216\u5b50\u5b57\u7b26\u4e32\uff09\u4e0d\u5339\u914d\u7684\u6807\u7b7e\u3002</li> </ul> <p>\u4f8b\u5982\uff1a\u9009\u62e9\u6307\u6807\u540d\u79f0\u4e3a <code>http_requests_total</code>\uff0c\u73af\u5883\u4e3a <code>staging</code>\u3001<code>testing</code> \u6216 <code>development</code>\uff0c<code>HTTP</code> \u65b9\u6cd5\u4e3a <code>GET</code> \u7684\u65f6\u95f4\u5e8f\u5217\uff1a</p> <pre><code>http_requests_total{environment=~\"staging|testing|development\",method!=\"GET\"}\n</code></pre> <p>\u6ca1\u6709\u6307\u5b9a\u6807\u7b7e\u7684\u6807\u7b7e\u8fc7\u6ee4\u5668\u4f1a\u9009\u62e9\u8be5\u6307\u6807\u540d\u79f0\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u6240\u6709\u7684 <code>PromQL</code> \u8868\u8fbe\u5f0f\u5fc5\u987b\u81f3\u5c11\u5305\u542b\u4e00\u4e2a\u6307\u6807\u540d\u79f0\uff0c\u6216\u8005\u4e00\u4e2a\u4e0d\u4f1a\u5339\u914d\u5230\u7a7a\u5b57\u7b26\u4e32\u7684\u6807\u7b7e\u8fc7\u6ee4\u5668\u3002</p> <p>\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u662f\u975e\u6cd5\u7684\uff08\u56e0\u4e3a\u4f1a\u5339\u914d\u5230\u7a7a\u5b57\u7b26\u4e32\uff09\uff1a</p> <pre><code>{job=~\".*\"} # \u975e\u6cd5\uff01\n</code></pre> <p>\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u662f\u5408\u6cd5\u7684\uff1a</p> <pre><code>{job=~\".+\"}              # \u5408\u6cd5\uff01\n{job=~\".*\",method=\"get\"} # \u5408\u6cd5\uff01\n</code></pre> <p>\u9664\u4e86\u4f7f\u7528 <code>&lt;metric name&gt;{label=value}</code> \u7684\u5f62\u5f0f\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u5185\u7f6e\u7684 <code>__name__</code> \u6807\u7b7e\u6765\u6307\u5b9a\u76d1\u63a7\u6307\u6807\u540d\u79f0\u3002</p> <p>\u4f8b\u5982\uff1a\u8868\u8fbe\u5f0f <code>http_requests_total</code> \u7b49\u6548\u4e8e <code>{__name__=\"http_requests_total\"}</code>\u3002</p> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528\u9664 <code>=</code> \u4e4b\u5916\u7684\u8fc7\u6ee4\u5668<code>\uff08=\uff0c=~\uff0c~\uff09</code>\u3002\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u9009\u62e9\u6307\u6807\u540d\u79f0\u4ee5 <code>job</code>: </p> <p>\u5f00\u5934\u7684\u6240\u6709\u6307\u6807\uff1a</p> <pre><code>{__name__=~\"job:.*\"}\n</code></pre> <p>Prometheus \u4e2d\u7684\u6240\u6709\u6b63\u5219\u8868\u8fbe\u5f0f\u90fd\u4f7f\u7528 RE2\u8bed\u6cd5\u3002</p>"},{"location":"chap8/1Promql_basic1/#4","title":"4 \u533a\u95f4\u5411\u91cf\u8fc7\u6ee4\u5668","text":"<p>\u533a\u95f4\u5411\u91cf\u4e0e\u77ac\u65f6\u5411\u91cf\u7684\u5de5\u4f5c\u65b9\u5f0f\u7c7b\u4f3c\uff0c\u552f\u4e00\u7684\u5dee\u5f02\u5728\u4e8e\u5728\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\u4e2d\u6211\u4eec\u9700\u8981\u5b9a\u4e49\u65f6\u95f4\u9009\u62e9\u7684\u8303\u56f4\uff0c\u65f6\u95f4\u8303\u56f4\u901a\u8fc7\u65f6\u95f4\u8303\u56f4\u9009\u62e9\u5668 <code>[]</code> \u8fdb\u884c\u5b9a\u4e49\uff0c\u4ee5\u6307\u5b9a\u5e94\u4e3a\u6bcf\u4e2a\u8fd4\u56de\u7684\u533a\u95f4\u5411\u91cf\u6837\u672c\u503c\u4e2d\u63d0\u53d6\u591a\u957f\u7684\u65f6\u95f4\u8303\u56f4\u3002</p> <p>\u65f6\u95f4\u8303\u56f4\u901a\u8fc7\u6570\u5b57\u6765\u8868\u793a\uff0c\u5355\u4f4d\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u5176\u4e2d\u4e4b\u4e00\u7684\u65f6\u95f4\u5355\u4f4d\uff1a</p> <ul> <li><code>s</code> - \u79d2</li> <li><code>m</code> - \u5206\u949f</li> <li><code>h</code> - \u5c0f\u65f6</li> <li><code>d</code> - \u5929</li> <li><code>w</code> - \u5468</li> <li><code>y</code> - \u5e74</li> </ul> <p>\u4f8b\u5982\uff1a\u9009\u62e9\u5728\u8fc7\u53bb <code>5</code> \u5206\u949f\u5185\u6307\u6807\u540d\u79f0\u4e3a <code>http_requests_total</code>\uff0c<code>job</code> \u6807\u7b7e\u503c\u4e3a <code>prometheus</code> \u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\uff1a</p> <pre><code>http_requests_total{job=\"prometheus\"}[5m]\n</code></pre>"},{"location":"chap8/1Promql_basic1/#5","title":"5 \u65f6\u95f4\u4f4d\u79fb\u64cd\u4f5c","text":"<p>\u5728\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\u6216\u8005\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\u4e2d\uff0c\u90fd\u662f\u4ee5\u5f53\u524d\u65f6\u95f4\u4e3a\u57fa\u51c6\uff1a</p> <pre><code>http_request_total{} # \u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\uff0c\u9009\u62e9\u5f53\u524d\u6700\u65b0\u7684\u6570\u636e\nhttp_request_total{}[5m] # \u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\uff0c\u9009\u62e9\u4ee5\u5f53\u524d\u65f6\u95f4\u4e3a\u57fa\u51c6\uff0c5\u5206\u949f\u5185\u7684\u6570\u636e\n</code></pre> <p>\u800c\u5982\u679c\u6211\u4eec\u60f3\u67e5\u8be2\uff0c<code>5</code> \u5206\u949f\u524d\u7684\u77ac\u65f6\u6837\u672c\u6570\u636e\uff0c\u6216\u6628\u5929\u4e00\u5929\u7684\u533a\u95f4\u5185\u7684\u6837\u672c\u6570\u636e\u5462? </p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u4f4d\u79fb\u64cd\u4f5c\uff0c\u4f4d\u79fb\u64cd\u4f5c\u7684\u5173\u952e\u5b57\u4e3a <code>offset</code>\u3002</p> <pre><code>http_requests_total offset 5m\n</code></pre> <p>\u6ce8\u610f\uff1a<code>offset</code> \u5173\u952e\u5b57\u9700\u8981\u7d27\u8ddf\u5728\u9009\u62e9\u5668\uff08<code>{}</code>\uff09\u540e\u9762\u3002\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u662f\u6b63\u786e\u7684\uff1a</p> <pre><code>sum(http_requests_total{method=\"GET\"} offset 5m) // GOOD.\n</code></pre> <p>\u4e0b\u9762\u7684\u8868\u8fbe\u5f0f\u662f\u4e0d\u5408\u6cd5\u7684\uff1a</p> <pre><code>sum(http_requests_total{method=\"GET\"}) offset 5m // INVALID.\n</code></pre> <p>\u8be5\u64cd\u4f5c\u540c\u6837\u9002\u7528\u4e8e\u533a\u95f4\u5411\u91cf\u3002</p> <p>\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u8fd4\u56de\u6307\u6807 </p> <p><code>http_requests_total</code> \u4e00\u5468\u524d\u7684 <code>5</code> \u5206\u949f\u4e4b\u5185\u7684 <code>HTTP</code> \u8bf7\u6c42\u91cf\u7684\u589e\u957f\u7387\uff1a</p> <pre><code>rate(http_requests_total[5m] offset 1w)\n</code></pre>"},{"location":"chap8/1Promql_basic1/#6","title":"6 \u9677\u9631","text":"<p>\u6267\u884c\u67e5\u8be2\u64cd\u4f5c\u65f6\uff0c\u72ec\u7acb\u4e8e\u5f53\u524d\u65f6\u523b\u88ab\u9009\u4e2d\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u6240\u5bf9\u5e94\u7684\u65f6\u95f4\u6233\uff0c\u8fd9\u4e2a\u65f6\u95f4\u6233\u4e3b\u8981\u7528\u6765\u8fdb\u884c\u805a\u5408\u64cd\u4f5c\uff0c\u5305\u62ec <code>sum</code>, <code>avg</code> \u7b49\uff0c\u5927\u591a\u6570\u805a\u5408\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u6240\u5bf9\u5e94\u7684\u65f6\u95f4\u6233\u6ca1\u6709\u5bf9\u9f50\u3002\u7531\u4e8e\u5b83\u4eec\u7684\u72ec\u7acb\u6027\uff0c\u6211\u4eec\u9700\u8981\u5728\u8fd9\u4e9b\u65f6\u95f4\u6233\u4e2d\u9009\u62e9\u4e00\u4e2a\u65f6\u95f4\u6233\uff0c\u5e76\u5df2\u8fd9\u4e2a\u65f6\u95f4\u6233\u4e3a\u57fa\u51c6\uff0c\u83b7\u53d6\u5c0f\u4e8e\u4e14\u6700\u63a5\u8fd1\u8fd9\u4e2a\u65f6\u95f4\u6233\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u3002</p> <p>\u5982\u679c\u91c7\u6837\u76ee\u6807\u6216\u544a\u8b66\u89c4\u5219\u4e0d\u518d\u8fd4\u56de\u4e4b\u524d\u5b58\u5728\u7684\u65f6\u95f4\u5e8f\u5217\u7684\u6837\u672c\uff0c\u5219\u8be5\u65f6\u95f4\u5e8f\u5217\u5c06\u88ab\u6807\u8bb0\u4e3a\u5931\u6548\u3002\u5982\u679c\u5220\u9664\u4e86\u91c7\u6837\u76ee\u6807\uff0c\u5219\u4e4b\u524d\u8fd4\u56de\u7684\u65f6\u95f4\u5e8f\u5217\u4e5f\u4f1a\u5f88\u5feb\u88ab\u6807\u8bb0\u4e3a\u5931\u6548\u3002</p> <p>\u5982\u679c\u5728\u67d0\u4e2a\u65f6\u95f4\u5e8f\u5217\u88ab\u6807\u8bb0\u4e3a\u5931\u6548\u540e\u5728\u8be5\u65f6\u95f4\u6233\u5904\u6267\u884c\u67e5\u8be2\u64cd\u4f5c\uff0c\u5219\u4e0d\u4f1a\u4e3a\u8be5\u65f6\u95f4\u5e8f\u5217\u8fd4\u56de\u4efb\u4f55\u503c\u3002\u5982\u679c\u968f\u540e\u5728\u8be5\u65f6\u95f4\u5e8f\u5217\u4e2d\u63d2\u5165\u4e86\u65b0\u7684\u6837\u672c\uff0c\u5219\u7167\u5e38\u8fd4\u56de\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u3002</p> <p>\u5982\u679c\u5728\u91c7\u6837\u65f6\u95f4\u6233\u524d 5 \u5206\u949f\uff08\u9ed8\u8ba4\u60c5\u51b5\uff09\u672a\u627e\u5230\u4efb\u4f55\u6837\u672c\uff0c\u5219\u8be5\u65f6\u95f4\u6233\u4e0d\u4f1a\u8fd4\u56de\u4efb\u4f55\u4efb\u4f55\u8be5\u65f6\u95f4\u5e8f\u5217\u7684\u503c\u3002\u8fd9\u5b9e\u9645\u4e0a\u610f\u5473\u7740\u4f60\u5728\u56fe\u8868\u4e2d\u770b\u5230\u7684\u6570\u636e\u90fd\u662f\u5728\u5f53\u524d\u65f6\u523b <code>5</code> \u5206\u949f\u524d\u7684\u6570\u636e\u3002</p> <p>\u5bf9\u4e8e\u5728\u91c7\u6837\u70b9\u4e2d\u5305\u542b\u65f6\u95f4\u6233\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u4e0d\u4f1a\u88ab\u6807\u8bb0\u4e3a\u5931\u6548\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4ec5\u4f7f\u7528 <code>5</code> \u5206\u949f\u9608\u503c\u68c0\u6d4b\u7684\u89c4\u5219\u3002</p>"},{"location":"chap8/1Promql_basic1/#7","title":"7 \u907f\u514d\u6162\u67e5\u8be2\u548c\u9ad8\u8d1f\u8f7d","text":"<p>\u5982\u679c\u4e00\u4e2a\u67e5\u8be2\u9700\u8981\u64cd\u4f5c\u975e\u5e38\u5927\u7684\u6570\u636e\u91cf\uff0c\u56fe\u8868\u7ed8\u5236\u5f88\u53ef\u80fd\u4f1a\u8d85\u65f6\uff0c\u6216\u8005\u670d\u52a1\u5668\u8d1f\u8f7d\u8fc7\u9ad8</p> <p>\u56e0\u6b64\uff0c\u5728\u5bf9\u672a\u77e5\u6570\u636e\u6784\u5efa\u67e5\u8be2\u65f6\uff0c\u59cb\u7ec8\u9700\u8981\u5728 <code>Prometheus</code> \u8868\u8fbe\u5f0f\u6d4f\u89c8\u5668\u7684\u8868\u683c\u89c6\u56fe\u4e2d\u6784\u5efa\u67e5\u8be2\uff0c\u76f4\u5230\u7ed3\u679c\u662f\u770b\u8d77\u6765\u5408\u7406\u7684\uff08\u6700\u591a\u4e3a\u6570\u767e\u4e2a\uff0c\u800c\u4e0d\u662f\u6570\u5343\u4e2a\uff09\u3002</p> <p>\u53ea\u6709\u5f53\u4f60\u5df2\u7ecf\u5145\u5206\u8fc7\u6ee4\u6216\u8005\u805a\u5408\u6570\u636e\u65f6\uff0c\u624d\u5207\u6362\u5230\u56fe\u8868\u6a21\u5f0f\u3002\u5982\u679c\u8868\u8fbe\u5f0f\u7684\u67e5\u8be2\u7ed3\u679c\u4ecd\u7136\u9700\u8981\u5f88\u957f\u65f6\u95f4\u624d\u80fd\u7ed8\u5236\u51fa\u6765\uff0c\u5219\u9700\u8981\u901a\u8fc7\u8bb0\u5f55\u89c4\u5219\u91cd\u65b0\u6e05\u6d17\u6570\u636e\u3002</p> <p>\u50cf <code>api_http_requests_total</code> \u8fd9\u6837\u7b80\u5355\u7684\u5ea6\u91cf\u6307\u6807\u540d\u79f0\u9009\u62e9\u5668\uff0c\u53ef\u4ee5\u6269\u5c55\u5230\u5177\u6709\u4e0d\u540c\u6807\u7b7e\u7684\u6570\u5343\u4e2a\u65f6\u95f4\u5e8f\u5217\u4e2d\uff0c\u8fd9\u5bf9\u4e8e <code>Prometheus</code> \u7684\u67e5\u8be2\u8bed\u8a00\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002</p> <p>\u8fd8\u8981\u8bb0\u4f4f\uff0c\u5bf9\u4e8e\u805a\u5408\u64cd\u4f5c\u6765\u8bf4\uff0c\u5373\u4f7f\u8f93\u51fa\u7684\u65f6\u95f4\u5e8f\u5217\u96c6\u975e\u5e38\u5c11\uff0c\u5b83\u4e5f\u4f1a\u5728\u670d\u52a1\u5668\u4e0a\u4ea7\u751f\u8d1f\u8f7d\u3002\u8fd9\u7c7b\u4f3c\u4e8e\u5728\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u67e5\u8be2\u4e00\u4e2a\u5b57\u6bb5\u7684\u603b\u548c\uff0c\u603b\u662f\u975e\u5e38\u7f13\u6162\u3002</p>"},{"location":"chap8/2Promql_basic2/","title":"2 PromQL \u64cd\u4f5c\u7b26 &amp; \u5185\u7f6e\u51fd\u6570","text":""},{"location":"chap8/2Promql_basic2/#1-promql","title":"1 PromQL \u64cd\u4f5c\u7b26","text":""},{"location":"chap8/2Promql_basic2/#1-1","title":"1-1 \u4e8c\u5143\u8fd0\u7b97\u7b26","text":"<p><code>Prometheus</code> \u7684\u67e5\u8be2\u8bed\u8a00\u652f\u6301\u57fa\u672c\u7684\u903b\u8f91\u8fd0\u7b97\u548c\u7b97\u672f\u8fd0\u7b97\u3002\u5bf9\u4e8e\u4e24\u4e2a\u77ac\u65f6\u5411\u91cf, \u5339\u914d\u884c\u4e3a\u53ef\u4ee5\u88ab\u6539\u53d8\u3002</p>"},{"location":"chap8/2Promql_basic2/#1-2","title":"1-2 \u7b97\u672f\u4e8c\u5143\u8fd0\u7b97\u7b26","text":"<p>\u5728 <code>Prometheus</code> \u7cfb\u7edf\u4e2d\u652f\u6301\u4e0b\u9762\u7684\u4e8c\u5143\u7b97\u672f\u8fd0\u7b97\u7b26\uff1a</p> <ul> <li><code>+</code> \u52a0\u6cd5</li> <li><code>-</code> \u51cf\u6cd5</li> <li><code>*</code> \u4e58\u6cd5</li> <li><code>/</code> \u9664\u6cd5</li> <li><code>%</code> \u6a21</li> <li><code>^</code> \u5e42\u7b49</li> </ul> <p>\u4e8c\u5143\u8fd0\u7b97\u64cd\u4f5c\u7b26\u652f\u6301 <code>scalar/scalar(\u6807\u91cf/\u6807\u91cf)</code>\u3001<code>vector/scalar(\u5411\u91cf/\u6807\u91cf)</code>\u3001\u548c <code>vector/vector(\u5411\u91cf/\u5411\u91cf)</code> \u4e4b\u95f4\u7684\u64cd\u4f5c\u3002</p> <p>\u5728\u4e24\u4e2a\u6807\u91cf\u4e4b\u95f4\u8fdb\u884c\u6570\u5b66\u8fd0\u7b97\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u4e5f\u662f\u6807\u91cf\u3002</p> <p>\u5728<code>\u5411\u91cf</code>\u548c<code>\u6807\u91cf</code>\u4e4b\u95f4\uff0c\u8fd9\u4e2a\u8fd0\u7b97\u7b26\u4f1a\u4f5c\u7528\u4e8e\u8fd9\u4e2a\u5411\u91cf\u7684\u6bcf\u4e2a\u6837\u672c\u503c\u4e0a\u3002</p> <p>\u4f8b\u5982\uff1a\u5982\u679c\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u77ac\u65f6\u5411\u91cf\u9664\u4ee5 2\uff0c\u64cd\u4f5c\u7ed3\u679c\u4e5f\u662f\u4e00\u4e2a\u65b0\u7684\u77ac\u65f6\u5411\u91cf\uff0c\u4e14\u5ea6\u91cf\u6307\u6807\u540d\u79f0\u4e0d\u53d8, \u5b83\u662f\u539f\u5ea6\u91cf\u6307\u6807\u77ac\u65f6\u5411\u91cf\u7684\u6bcf\u4e2a\u6837\u672c\u503c\u9664\u4ee5 2\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u60f3\u6839\u636e <code>node_disk_bytes_written</code> \u548c <code>node_disk_bytes_read</code> \u83b7\u53d6\u4e3b\u673a\u78c1\u76d8IO\u7684\u603b\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>node_disk_bytes_written + node_disk_bytes_read\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u8fd4\u56de\u7ed3\u679c\u7684\u793a\u4f8b\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{device=\"sda\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;1634967552@1518146427.807 + 864551424@1518146427.807\n{device=\"sdb\",instance=\"localhost:9100\",job=\"node_exporter\"}=&gt;0@1518146427.807 + 1744384@1518146427.807\n</code></pre>"},{"location":"chap8/2Promql_basic2/#1-3","title":"1-3 \u5e03\u5c14\u8fd0\u7b97\u7b26","text":"<p>\u76ee\u524d\uff0cPrometheus \u652f\u6301\u4ee5\u4e0b\u5e03\u5c14\u8fd0\u7b97\u7b26\uff1a</p> <ul> <li><code>==</code> (\u76f8\u7b49)</li> <li><code>!=</code> (\u4e0d\u76f8\u7b49)</li> <li><code>&gt;</code> (\u5927\u4e8e)</li> <li><code>&lt;</code> (\u5c0f\u4e8e)</li> <li><code>&gt;=</code> (\u5927\u4e8e\u7b49\u4e8e)</li> <li><code>&lt;=</code> (\u5c0f\u4e8e\u7b49\u4e8e)</li> </ul> <p>\u5e03\u5c14\u8fd0\u7b97\u7b26\u88ab\u5e94\u7528\u4e8e <code>scalar/scalar\uff08\u6807\u91cf/\u6807\u91cf\uff09</code>\u3001<code>vector/scalar\uff08\u5411\u91cf/\u6807\u91cf\uff09</code>\uff0c\u548c<code>vector/vector\uff08\u5411\u91cf/\u5411\u91cf\uff09</code>\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5e03\u5c14\u8fd0\u7b97\u7b26\u53ea\u4f1a\u6839\u636e\u65f6\u95f4\u5e8f\u5217\u4e2d\u6837\u672c\u7684\u503c\uff0c\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u8fc7\u6ee4\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u8fd0\u7b97\u7b26\u540e\u9762\u4f7f\u7528 <code>bool</code> \u4fee\u9970\u7b26\u6765\u6539\u53d8\u5e03\u5c14\u8fd0\u7b97\u7684\u9ed8\u8ba4\u884c\u4e3a\u3002\u4f7f\u7528 <code>bool</code> \u4fee\u6539\u7b26\u540e\uff0c\u5e03\u5c14\u8fd0\u7b97\u4e0d\u4f1a\u5bf9\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u8fc7\u6ee4\uff0c\u800c\u662f\u76f4\u63a5\u4f9d\u6b21\u77ac\u65f6\u5411\u91cf\u4e2d\u7684\u5404\u4e2a\u6837\u672c\u6570\u636e\u4e0e\u6807\u91cf\u7684\u6bd4\u8f83\u7ed3\u679c <code>0</code> \u6216\u8005 <code>1</code>\u3002</p> <p>\u5728\u4e24\u4e2a\u6807\u91cf\u4e4b\u95f4\u8fdb\u884c\u5e03\u5c14\u8fd0\u7b97\uff0c\u5fc5\u987b\u63d0\u4f9b <code>bool</code> \u4fee\u9970\u7b26\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u4e5f\u662f\u6807\u91cf\uff0c\u5373 <code>0\uff08false\uff09</code>\u6216 <code>1\uff08true\uff09</code>\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>2 &gt; bool 1 # \u7ed3\u679c\u4e3a 1\n</code></pre> <p>\u77ac\u65f6\u5411\u91cf\u548c\u6807\u91cf\u4e4b\u95f4\u7684\u5e03\u5c14\u8fd0\u7b97\uff0c\u8fd9\u4e2a\u8fd0\u7b97\u7b26\u4f1a\u5e94\u7528\u5230\u67d0\u4e2a\u5f53\u524d\u65f6\u523b\u7684\u6bcf\u4e2a\u65f6\u5e8f\u6570\u636e\u4e0a\uff0c\u5982\u679c\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u7684\u6837\u672c\u503c\u4e0e\u8fd9\u4e2a\u6807\u91cf\u6bd4\u8f83\u7684\u7ed3\u679c\u662f <code>false</code>\uff0c\u5219\u8fd9\u4e2a\u65f6\u5e8f\u6570\u636e\u88ab\u4e22\u5f03\u6389\uff0c\u5982\u679c\u662f <code>true</code>, \u5219\u8fd9\u4e2a\u65f6\u5e8f\u6570\u636e\u88ab\u4fdd\u7559\u5728\u7ed3\u679c\u4e2d\u3002</p> <p>\u5982\u679c\u63d0\u4f9b\u4e86 <code>bool</code> \u4fee\u9970\u7b26\uff0c\u90a3\u4e48\u6bd4\u8f83\u7ed3\u679c\u662f <code>0</code> \u7684\u65f6\u5e8f\u6570\u636e\u88ab\u4e22\u5f03\u6389\uff0c\u800c\u6bd4\u8f83\u7ed3\u679c\u662f <code>1</code> \u7684\u65f6\u5e8f\u6570\u636e\u88ab\u4fdd\u7559\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>http_requests_total &gt; 100 # \u7ed3\u679c\u4e3a true \u6216 false\nhttp_requests_total &gt; bool 100 # \u7ed3\u679c\u4e3a 1 \u6216 0\n</code></pre> <p>\u77ac\u65f6\u5411\u91cf\u4e0e\u77ac\u65f6\u5411\u91cf\u76f4\u63a5\u8fdb\u884c\u5e03\u5c14\u8fd0\u7b97\u65f6\uff0c\u540c\u6837\u9075\u5faa\u9ed8\u8ba4\u7684\u5339\u914d\u6a21\u5f0f\uff1a\u4f9d\u6b21\u627e\u5230\u4e0e\u5de6\u8fb9\u5411\u91cf\u5143\u7d20\u5339\u914d\uff08\u6807\u7b7e\u5b8c\u5168\u4e00\u81f4\uff09\u7684\u53f3\u8fb9\u5411\u91cf\u5143\u7d20\u8fdb\u884c\u76f8\u5e94\u7684\u64cd\u4f5c\uff0c\u5982\u679c\u6ca1\u627e\u5230\u5339\u914d\u5143\u7d20\uff0c\u6216\u8005\u8ba1\u7b97\u7ed3\u679c\u4e3a <code>false</code>\uff0c\u5219\u76f4\u63a5\u4e22\u5f03\u3002\u5982\u679c\u5339\u914d\u4e0a\u4e86\uff0c\u5219\u5c06\u5de6\u8fb9\u5411\u91cf\u7684\u5ea6\u91cf\u6307\u6807\u548c\u6807\u7b7e\u7684\u6837\u672c\u6570\u636e\u5199\u5165\u77ac\u65f6\u5411\u91cf\u3002\u5982\u679c\u63d0\u4f9b\u4e86 <code>bool</code> \u4fee\u9970\u7b26\uff0c\u90a3\u4e48\u6bd4\u8f83\u7ed3\u679c\u662f <code>0</code> \u7684\u65f6\u5e8f\u6570\u636e\u88ab\u4e22\u5f03\u6389\uff0c\u800c\u6bd4\u8f83\u7ed3\u679c\u662f <code>1</code> \u7684\u65f6\u5e8f\u6570\u636e\uff08\u53ea\u4fdd\u7559\u5de6\u8fb9\u5411\u91cf\uff09\u88ab\u4fdd\u7559\u3002</p>"},{"location":"chap8/2Promql_basic2/#1-4","title":"1-4 \u96c6\u5408\u8fd0\u7b97\u7b26","text":"<p>\u4f7f\u7528\u77ac\u65f6\u5411\u91cf\u8868\u8fbe\u5f0f\u80fd\u591f\u83b7\u53d6\u5230\u4e00\u4e2a\u5305\u542b\u591a\u4e2a\u65f6\u95f4\u5e8f\u5217\u7684\u96c6\u5408\uff0c\u6211\u4eec\u79f0\u4e3a\u77ac\u65f6\u5411\u91cf\u3002 </p> <p>\u901a\u8fc7\u96c6\u5408\u8fd0\u7b97\uff0c\u53ef\u4ee5\u5728\u4e24\u4e2a\u77ac\u65f6\u5411\u91cf\u4e0e\u77ac\u65f6\u5411\u91cf\u4e4b\u95f4\u8fdb\u884c\u76f8\u5e94\u7684\u96c6\u5408\u64cd\u4f5c\u3002\u76ee\u524d\uff0c<code>Prometheus</code> \u652f\u6301\u4ee5\u4e0b\u96c6\u5408\u8fd0\u7b97\u7b26\uff1a</p> <ul> <li><code>and</code> (\u5e76\u4e14)</li> <li><code>or</code> (\u6216\u8005)</li> <li> <p><code>unless</code> (\u6392\u9664)</p> </li> <li> <p>vector1 and vector2 \u4f1a\u4ea7\u751f\u4e00\u4e2a\u7531 <code>vector1</code> \u7684\u5143\u7d20\u7ec4\u6210\u7684\u65b0\u7684\u5411\u91cf\u3002\u8be5\u5411\u91cf\u5305\u542b <code>vector1</code> \u4e2d\u5b8c\u5168\u5339\u914d <code>vector2</code> \u4e2d\u7684\u5143\u7d20\u7ec4\u6210\u3002</p> </li> <li>vector1 or vector2 \u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u5411\u91cf\uff0c\u8be5\u5411\u91cf\u5305\u542b <code>vector1</code> \u4e2d\u6240\u6709\u7684\u6837\u672c\u6570\u636e\uff0c\u4ee5\u53ca <code>vector2</code> \u4e2d\u6ca1\u6709\u4e0e <code>vector1</code> \u5339\u914d\u5230\u7684\u6837\u672c\u6570\u636e\u3002</li> <li>vector1 unless vector2 \u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u5411\u91cf\uff0c\u65b0\u5411\u91cf\u4e2d\u7684\u5143\u7d20\u7531 <code>vector1</code> \u4e2d\u6ca1\u6709\u4e0e <code>vector2</code> \u5339\u914d\u7684\u5143\u7d20\u7ec4\u6210\u3002</li> </ul>"},{"location":"chap8/2Promql_basic2/#1-5","title":"1-5 \u5339\u914d\u6a21\u5f0f","text":"<p>\u5411\u91cf\u4e0e\u5411\u91cf\u4e4b\u95f4\u8fdb\u884c\u8fd0\u7b97\u64cd\u4f5c\u65f6\u4f1a\u57fa\u4e8e\u9ed8\u8ba4\u7684\u5339\u914d\u89c4\u5219\uff1a\u4f9d\u6b21\u627e\u5230\u4e0e\u5de6\u8fb9\u5411\u91cf\u5143\u7d20\u5339\u914d\uff08\u6807\u7b7e\u5b8c\u5168\u4e00\u81f4\uff09\u7684\u53f3\u8fb9\u5411\u91cf\u5143\u7d20\u8fdb\u884c\u8fd0\u7b97\uff0c\u5982\u679c\u6ca1\u627e\u5230\u5339\u914d\u5143\u7d20\uff0c\u5219\u76f4\u63a5\u4e22\u5f03\u3002</p> <p>\u63a5\u4e0b\u6765\u5c06\u4ecb\u7ecd\u5728 <code>PromQL</code> \u4e2d\u6709\u4e24\u79cd\u5178\u578b\u7684\u5339\u914d\u6a21\u5f0f\uff1a</p> <ul> <li>\u4e00\u5bf9\u4e00\uff08<code>one-to-one</code>\uff09</li> <li>\u591a\u5bf9\u4e00\uff08<code>many-to-one</code>\uff09</li> <li>\u4e00\u5bf9\u591a\uff08<code>one-to-many</code>\uff09</li> </ul> <p>\u4e00\u5bf9\u4e00\u5339\u914d</p> <p>\u4e00\u5bf9\u4e00\u5339\u914d\u6a21\u5f0f\u4f1a\u4ece\u64cd\u4f5c\u7b26\u4e24\u8fb9\u8868\u8fbe\u5f0f\u83b7\u53d6\u7684\u77ac\u65f6\u5411\u91cf\u4f9d\u6b21\u6bd4\u8f83\u5e76\u627e\u5230\u552f\u4e00\u5339\u914d(\u6807\u7b7e\u5b8c\u5168\u4e00\u81f4)\u7684\u6837\u672c\u503c\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>vector1 &lt;operator&gt; vector2\n</code></pre> <p>\u5728\u64cd\u4f5c\u7b26\u4e24\u8fb9\u8868\u8fbe\u5f0f\u6807\u7b7e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>on(label list)</code> \u6216\u8005 <code>ignoring(label list</code>\uff09\u6765\u4fee\u6539\u4fbf\u7b7e\u7684\u5339\u914d\u884c\u4e3a\u3002</p> <p>\u4f7f\u7528 <code>ignoreing</code>\u53ef\u4ee5\u5728\u5339\u914d\u65f6\u5ffd\u7565\u67d0\u4e9b\u4fbf\u7b7e\u3002\u800c <code>on</code> \u5219\u7528\u4e8e\u5c06\u5339\u914d\u884c\u4e3a\u9650\u5b9a\u5728\u67d0\u4e9b\u4fbf\u7b7e\u4e4b\u5185\u3002</p> <pre><code>&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;\n</code></pre> <p>\u4f8b\u5982\u5f53\u5b58\u5728\u6837\u672c\uff1a</p> <pre><code>method_code:http_errors:rate5m{method=\"get\", code=\"500\"}  24\nmethod_code:http_errors:rate5m{method=\"get\", code=\"404\"}  30\nmethod_code:http_errors:rate5m{method=\"put\", code=\"501\"}  3\nmethod_code:http_errors:rate5m{method=\"post\", code=\"500\"} 6\nmethod_code:http_errors:rate5m{method=\"post\", code=\"404\"} 21\n\nmethod:http_requests:rate5m{method=\"get\"}  600\nmethod:http_requests:rate5m{method=\"del\"}  34\nmethod:http_requests:rate5m{method=\"post\"} 120\n</code></pre> <p>\u4f7f\u7528 <code>PromQL</code> \u8868\u8fbe\u5f0f\uff1a</p> <pre><code>method_code:http_errors:rate5m{code=\"500\"} / ignoring(code) method:http_requests:rate5m\n</code></pre> <p><code>ignoring(code)</code></p> <p>\u8be5\u8868\u8fbe\u5f0f\u4f1a\u8fd4\u56de\u5728\u8fc7\u53bb <code>5</code>\u5206\u949f\u5185\uff0c<code>HTTP</code> \u8bf7\u6c42\u72b6\u6001\u7801\u4e3a <code>500</code> \u7684\u5728\u6240\u6709\u8bf7\u6c42\u4e2d\u7684\u6bd4\u4f8b\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u4f7f\u7528 <code>ignoring(code)</code>\uff0c\u64cd\u4f5c\u7b26\u4e24\u8fb9\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u77ac\u65f6\u5411\u91cf\u4e2d\u5c06\u627e\u4e0d\u5230\u4efb\u4f55\u4e00\u4e2a\u6807\u7b7e\u5b8c\u5168\u76f8\u540c\u7684\u5339\u914d\u9879\u3002</p> <p>\u56e0\u6b64\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>{method=\"get\"}  0.04            //  24 / 600\n{method=\"post\"} 0.05            //   6 / 120\n</code></pre> <p>\u540c\u65f6\u7531\u4e8e <code>method</code> \u4e3a <code>put</code> \u548c <code>del</code> \u7684\u6837\u672c\u627e\u4e0d\u5230\u5339\u914d\u9879\uff0c\u56e0\u6b64\u4e0d\u4f1a\u51fa\u73b0\u5728\u7ed3\u679c\u5f53\u4e2d\u3002</p> <p>\u591a\u5bf9\u4e00\u548c\u4e00\u5bf9\u591a</p> <p>\u591a\u5bf9\u4e00\u548c\u4e00\u5bf9\u591a\u4e24\u79cd\u5339\u914d\u6a21\u5f0f\u6307\u7684\u662f\u201c\u4e00\u201d\u4fa7\u7684\u6bcf\u4e00\u4e2a\u5411\u91cf\u5143\u7d20\u53ef\u4ee5\u4e0e\"\u591a\"\u4fa7\u7684\u591a\u4e2a\u5143\u7d20\u5339\u914d\u7684\u60c5\u51b5\u3002</p> <p>\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5fc5\u987b\u4f7f\u7528 <code>group</code> \u4fee\u9970\u7b26\uff1a<code>group_left</code> \u6216\u8005 <code>group_right</code> \u6765\u786e\u5b9a\u54ea\u4e00\u4e2a\u5411\u91cf\u5177\u6709\u66f4\u9ad8\u7684\u57fa\u6570\uff08\u5145\u5f53\u201c\u591a\u201d\u7684\u89d2\u8272\uff09\u3002</p> <pre><code>&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;\n&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;\n</code></pre> <p>\u591a\u5bf9\u4e00\u548c\u4e00\u5bf9\u591a\u4e24\u79cd\u6a21\u5f0f\u4e00\u5b9a\u662f\u51fa\u73b0\u5728\u64cd\u4f5c\u7b26\u4e24\u4fa7\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u5411\u91cf\u6807\u7b7e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\u3002</p> <p>\u56e0\u6b64\u9700\u8981\u4f7f\u7528 <code>ignoring</code> \u548c <code>on</code> \u4fee\u9970\u7b26\u6765\u6392\u9664\u6216\u8005\u9650\u5b9a\u5339\u914d\u7684\u6807\u7b7e\u5217\u8868\u3002</p> <p>\u4f8b\u5982\uff0c\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m\n</code></pre> <p>\u8be5\u8868\u8fbe\u5f0f\u4e2d\uff0c</p> <ul> <li>\u5de6\u5411\u91cf <code>method_code:http_errors:rate5m</code> \u5305\u542b\u4e24\u4e2a\u6807\u7b7e <code>method</code> \u548c <code>code</code>\u3002</li> <li>\u53f3\u5411\u91cf <code>method:http_requests:rate5m</code> \u4e2d\u53ea\u5305\u542b\u4e00\u4e2a\u6807\u7b7e <code>method</code>\uff0c\u56e0\u6b64\u5339\u914d\u65f6\u9700\u8981\u4f7f\u7528 <code>ignoring</code> \u9650\u5b9a\u5339\u914d\u7684\u6807\u7b7e\u4e3a <code>code</code>\u3002 </li> <li>\u5728\u9650\u5b9a\u5339\u914d\u6807\u7b7e\u540e\uff0c\u53f3\u5411\u91cf\u4e2d\u7684\u5143\u7d20\u53ef\u80fd\u5339\u914d\u5230\u591a\u4e2a\u5de6\u5411\u91cf\u4e2d\u7684\u5143\u7d20\u56e0\u6b64\u8be5\u8868\u8fbe\u5f0f\u7684\u5339\u914d\u6a21\u5f0f\u4e3a\u591a\u5bf9\u4e00\uff0c\u9700\u8981\u4f7f\u7528 <code>group</code> \u4fee\u9970\u7b26 <code>group_left</code> \u6307\u5b9a\u5de6\u5411\u91cf\u5177\u6709\u66f4\u597d\u7684\u57fa\u6570\u3002</li> </ul> <p>\u6700\u7ec8\u7684\u8fd0\u7b97\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>{method=\"get\", code=\"500\"}  0.04            //  24 / 600\n{method=\"get\", code=\"404\"}  0.05            //  30 / 600\n{method=\"post\", code=\"500\"} 0.05            //   6 / 120\n{method=\"post\", code=\"404\"} 0.175           //  21 / 120\n</code></pre> <p>\u63d0\u9192\uff1agroup \u4fee\u9970\u7b26\u53ea\u80fd\u5728\u6bd4\u8f83\u548c\u6570\u5b66\u8fd0\u7b97\u7b26\u4e2d\u4f7f\u7528\u3002\u5728\u903b\u8f91\u8fd0\u7b97 and\uff0cunless \u548c or \u64cd\u4f5c\u4e2d\u9ed8\u8ba4\u4e0e\u53f3\u5411\u91cf\u4e2d\u7684\u6240\u6709\u5143\u7d20\u8fdb\u884c\u5339\u914d\u3002</p>"},{"location":"chap8/2Promql_basic2/#1-6","title":"1-6 \u805a\u5408\u64cd\u4f5c","text":"<p><code>Prometheus</code> \u8fd8\u63d0\u4f9b\u4e86\u4e0b\u5217\u5185\u7f6e\u7684\u805a\u5408\u64cd\u4f5c\u7b26\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u7b26\u4f5c\u7528\u57df\u77ac\u65f6\u5411\u91cf\u3002\u53ef\u4ee5\u5c06\u77ac\u65f6\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u6837\u672c\u6570\u636e\u8fdb\u884c\u805a\u5408\uff0c\u5f62\u6210\u4e00\u4e2a\u5177\u6709\u8f83\u5c11\u6837\u672c\u503c\u7684\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <ul> <li><code>sum</code> (\u6c42\u548c)</li> <li><code>min</code> (\u6700\u5c0f\u503c)</li> <li><code>max</code> (\u6700\u5927\u503c)</li> <li><code>avg</code> (\u5e73\u5747\u503c)</li> <li><code>stddev</code> (\u6807\u51c6\u5dee)</li> <li><code>stdvar</code> (\u6807\u51c6\u5dee\u5f02)</li> <li><code>count</code> (\u8ba1\u6570)</li> <li><code>count_values</code>(\u5bf9 value \u8fdb\u884c\u8ba1\u6570)</li> <li><code>bottomk</code> (\u6837\u672c\u503c\u6700\u5c0f\u7684 k \u4e2a\u5143\u7d20)</li> <li><code>topk</code> (\u6837\u672c\u503c\u6700\u5927\u7684k\u4e2a\u5143\u7d20)</li> <li><code>quantile</code> (\u5206\u5e03\u7edf\u8ba1)</li> </ul> <p>\u8fd9\u4e9b\u64cd\u4f5c\u7b26\u88ab\u7528\u4e8e\u805a\u5408\u6240\u6709\u6807\u7b7e\u7ef4\u5ea6\uff0c\u6216\u8005\u901a\u8fc7 <code>without</code> \u6216\u8005 <code>by</code> \u5b50\u8bed\u53e5\u6765\u4fdd\u7559\u4e0d\u540c\u7684\u7ef4\u5ea6\u3002</p> <pre><code>&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]\n</code></pre> <p>\u5176\u4e2d\u53ea\u6709 <code>count_values</code>, <code>quantile</code>, <code>topk</code>, <code>bottomk</code> \u652f\u6301\u53c2\u6570(<code>parameter</code>)\u3002</p> <ul> <li><code>without</code> \u7528\u4e8e\u4ece\u8ba1\u7b97\u7ed3\u679c\u4e2d\u79fb\u9664\u5217\u4e3e\u7684\u6807\u7b7e\uff0c\u800c\u4fdd\u7559\u5176\u5b83\u6807\u7b7e\u3002</li> <li><code>by</code> \u5219\u6b63\u597d\u76f8\u53cd\uff0c\u7ed3\u679c\u5411\u91cf\u4e2d\u53ea\u4fdd\u7559\u5217\u51fa\u7684\u6807\u7b7e\uff0c\u5176\u4f59\u6807\u7b7e\u5219\u79fb\u9664\u3002</li> <li>\u901a\u8fc7 <code>without</code> \u548c <code>by</code> \u53ef\u4ee5\u6309\u7167\u6837\u672c\u7684\u95ee\u9898\u5bf9\u6570\u636e\u8fdb\u884c\u805a\u5408\u3002</li> </ul> <p>\u4f8b\u5982\uff1a</p> <p>\u5982\u679c\u6307\u6807 <code>http_requests_total</code> \u7684\u65f6\u95f4\u5e8f\u5217\u7684\u6807\u7b7e\u96c6\u4e3a <code>application</code>, <code>instance,</code> \u548c<code>group</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u8ba1\u7b97\u6240\u6709 <code>instance</code> \u4e2d\u6bcf\u4e2a<code>application</code> \u548c <code>group</code> \u7684\u8bf7\u6c42\u603b\u91cf\uff1a</p> <pre><code>sum(http_requests_total) without (instance)\n</code></pre> <p>\u7b49\u4ef7\u4e8e</p> <pre><code>sum(http_requests_total) by (application, group)\n</code></pre> <p>\u5982\u679c\u53ea\u9700\u8981\u8ba1\u7b97\u6574\u4e2a\u5e94\u7528\u7684 <code>HTTP</code> \u8bf7\u6c42\u603b\u91cf\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(http_requests_total)\n</code></pre> <p><code>count_values</code> \u7528\u4e8e\u65f6\u95f4\u5e8f\u5217\u4e2d\u6bcf\u4e00\u4e2a\u6837\u672c\u503c\u51fa\u73b0\u7684\u6b21\u6570\u3002<code>count_values</code> \u4f1a\u4e3a\u6bcf\u4e00\u4e2a\u552f\u4e00\u7684\u6837\u672c\u503c\u8f93\u51fa\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\uff0c\u5e76\u4e14\u6bcf\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u5305\u542b\u4e00\u4e2a\u989d\u5916\u7684\u6807\u7b7e\u3002\u8fd9\u4e2a\u6807\u7b7e\u7684\u540d\u5b57\u7531\u805a\u5408\u53c2\u6570\u6307\u5b9a\uff0c\u540c\u65f6\u8fd9\u4e2a\u6807\u7b7e\u503c\u662f\u552f\u4e00\u7684\u6837\u672c\u503c\u3002</p> <p>\u4f8b\u5982\u8981\u8ba1\u7b97\u8fd0\u884c\u6bcf\u4e2a\u6784\u5efa\u7248\u672c\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684</p> <pre><code>count_values(\"version\", build_version)\n</code></pre> <p>\u8fd4\u56de\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>{count=\"641\"}   1\n{count=\"3226\"}  2\n{count=\"644\"}   4\n</code></pre> <p><code>topk</code> \u548c <code>bottomk</code> \u5219\u7528\u4e8e\u5bf9\u6837\u672c\u503c\u8fdb\u884c\u6392\u5e8f\uff0c\u8fd4\u56de\u5f53\u524d\u6837\u672c\u503c\u524d <code>n</code> \u4f4d\uff0c\u6216\u8005\u540e <code>n</code> \u4f4d\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u83b7\u53d6 <code>HTTP</code> \u8bf7\u6c42\u6570\u524d <code>5</code> \u4f4d\u7684\u65f6\u5e8f\u6837\u672c\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>topk(5, http_requests_total)\n</code></pre> <p><code>quantile</code> \u7528\u4e8e\u8ba1\u7b97\u5f53\u524d\u6837\u672c\u6570\u636e\u503c\u7684\u5206\u5e03\u60c5\u51b5 <code>quantile(\u03c6, express)</code> \uff0c\u5176\u4e2d <code>0 \u2264 \u03c6 \u2264 1</code>\u3002</p> <p>\u4f8b\u5982\uff0c\u5f53 <code>\u03c6</code> \u4e3a <code>0.5</code> \u65f6\uff0c\u5373\u8868\u793a\u627e\u5230\u5f53\u524d\u6837\u672c\u6570\u636e\u4e2d\u7684\u4e2d\u4f4d\u6570\uff1a</p> <pre><code>quantile(0.5, http_requests_total)\n</code></pre> <p>\u8fd4\u56de\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>{}   656\n</code></pre>"},{"location":"chap8/2Promql_basic2/#1-7","title":"1-7 \u4e8c\u5143\u8fd0\u7b97\u7b26\u4f18\u5148\u7ea7","text":"<p>\u5728 Prometheus \u7cfb\u7edf\u4e2d\uff0c\u4e8c\u5143\u8fd0\u7b97\u7b26\u4f18\u5148\u7ea7\u4ece\u9ad8\u5230\u4f4e\u7684\u987a\u5e8f\u4e3a\uff1a</p> <ol> <li><code>^</code></li> <li><code>*, /, %</code></li> <li><code>+, -</code></li> <li><code>==, !=, &lt;=, &lt;, &gt;=, &gt;</code></li> <li><code>and, unless</code></li> <li><code>or</code></li> </ol> <p>\u5177\u6709\u76f8\u540c\u4f18\u5148\u7ea7\u7684\u8fd0\u7b97\u7b26\u662f\u6ee1\u8db3\u7ed3\u5408\u5f8b\u7684\uff08\u5de6\u7ed3\u5408\uff09\u3002\u4f8b\u5982\uff0c<code>2 * 3 % 2</code> \u7b49\u4ef7\u4e8e <code>(2 * 3) % 2</code>\u3002</p> <p>\u8fd0\u7b97\u7b26 <code>^</code> \u4f8b\u5916\uff0c<code>^</code> \u6ee1\u8db3\u7684\u662f\u53f3\u7ed3\u5408\uff0c\u4f8b\u5982\uff0c<code>2 ^ 3 ^ 2</code> \u7b49\u4ef7\u4e8e <code>2 ^ (3 ^ 2)</code>\u3002</p>"},{"location":"chap8/3Promql_basic3/","title":"3 PromQL \u5185\u7f6e\u51fd\u6570","text":"<p><code>Prometheus</code> \u63d0\u4f9b\u4e86\u5176\u5b83\u5927\u91cf\u7684\u5185\u7f6e\u51fd\u6570\uff0c\u53ef\u4ee5\u5bf9\u65f6\u5e8f\u6570\u636e\u8fdb\u884c\u4e30\u5bcc\u7684\u5904\u7406\u3002\u67d0\u4e9b\u51fd\u6570\u6709\u9ed8\u8ba4\u7684\u53c2\u6570\uff0c\u4f8b\u5982\uff1a<code>year(v=vector(time()) instant-vector)</code>\u3002\u5176\u4e2d\u53c2\u6570 <code>v</code> \u662f\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\uff0c\u5982\u679c\u4e0d\u63d0\u4f9b\u8be5\u53c2\u6570\uff0c\u5c06\u4f7f\u7528\u9ed8\u8ba4\u503c <code>vector(time())</code>\u3002<code>instant-vector</code> \u8868\u793a\u53c2\u6570\u7c7b\u578b\u3002</p>"},{"location":"chap8/3Promql_basic3/#abs","title":"<code>abs()</code>","text":"<p><code>abs(v instant-vector)</code> \u8fd4\u56de\u8f93\u5165\u5411\u91cf\u7684\u6240\u6709\u6837\u672c\u7684\u7edd\u5bf9\u503c\u3002</p>"},{"location":"chap8/3Promql_basic3/#absent","title":"<code>absent()</code>","text":"<ul> <li><code>absent(v instant-vector)</code>\uff0c\u5982\u679c\u4f20\u9012\u7ed9\u5b83\u7684\u5411\u91cf\u53c2\u6570\u5177\u6709\u6837\u672c\u6570\u636e\uff0c\u5219\u8fd4\u56de\u7a7a\u5411\u91cf\uff1b</li> <li>\u5982\u679c\u4f20\u9012\u7684\u5411\u91cf\u53c2\u6570\u6ca1\u6709\u6837\u672c\u6570\u636e\uff0c\u5219\u8fd4\u56de\u4e0d\u5e26\u5ea6\u91cf\u6307\u6807\u540d\u79f0\u4e14\u5e26\u6709\u6807\u7b7e\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u4e14\u6837\u672c\u503c\u4e3a1\u3002</li> </ul> <p>\u5f53\u76d1\u63a7\u5ea6\u91cf\u6307\u6807\u65f6\uff0c\u5982\u679c\u83b7\u53d6\u5230\u7684\u6837\u672c\u6570\u636e\u662f\u7a7a\u7684\uff0c \u4f7f\u7528 <code>absent</code> \u65b9\u6cd5\u5bf9\u544a\u8b66\u662f\u975e\u5e38\u6709\u7528\u7684\u3002\u4f8b\u5982\uff1a</p> <pre><code># \u8fd9\u91cc\u63d0\u4f9b\u7684\u5411\u91cf\u6709\u6837\u672c\u6570\u636e\nabsent(http_requests_total{method=\"get\"})  =&gt; no data\nabsent(sum(http_requests_total{method=\"get\"}))  =&gt; no data\n\n# \u7531\u4e8e\u4e0d\u5b58\u5728\u5ea6\u91cf\u6307\u6807 nonexistent\uff0c\u6240\u4ee5 \u8fd4\u56de\u4e0d\u5e26\u5ea6\u91cf\u6307\u6807\u540d\u79f0\u4e14\u5e26\u6709\u6807\u7b7e\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u4e14\u6837\u672c\u503c\u4e3a1\nabsent(nonexistent{job=\"myjob\"})  =&gt; {job=\"myjob\"}  1\n# \u6b63\u5219\u5339\u914d\u7684 instance \u4e0d\u4f5c\u4e3a\u8fd4\u56de labels \u4e2d\u7684\u4e00\u90e8\u5206\nabsent(nonexistent{job=\"myjob\",instance=~\".*\"})  =&gt; {job=\"myjob\"}  1\n\n# sum \u51fd\u6570\u8fd4\u56de\u7684\u65f6\u95f4\u5e8f\u5217\u4e0d\u5e26\u6709\u6807\u7b7e\uff0c\u4e14\u6ca1\u6709\u6837\u672c\u6570\u636e\nabsent(sum(nonexistent{job=\"myjob\"}))  =&gt; {}  1\n</code></pre>"},{"location":"chap8/3Promql_basic3/#ceil","title":"<code>ceil()</code>","text":"<p><code>ceil(v instant-vector)</code> \u5c06 <code>v</code> \u4e2d\u6240\u6709\u5143\u7d20\u7684\u6837\u672c\u503c\u5411\u4e0a\u56db\u820d\u4e94\u5165\u5230\u6700\u63a5\u8fd1\u7684\u6574\u6570\u3002\u4f8b\u5982\uff1a</p> <pre><code>node_load5{instance=\"192.168.1.75:9100\"} # \u7ed3\u679c\u4e3a 2.79\nceil(node_load5{instance=\"192.168.1.75:9100\"}) # \u7ed3\u679c\u4e3a 3\n</code></pre>"},{"location":"chap8/3Promql_basic3/#changes","title":"<code>changes()</code>","text":"<p><code>changes(v range-vector)</code> \u8f93\u5165\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\uff0c \u8fd4\u56de\u8fd9\u4e2a\u533a\u95f4\u5411\u91cf\u5185\u6bcf\u4e2a\u6837\u672c\u6570\u636e\u503c\u53d8\u5316\u7684\u6b21\u6570\uff08\u77ac\u65f6\u5411\u91cf\uff09\u3002\u4f8b\u5982\uff1a</p> <pre><code># \u5982\u679c\u6837\u672c\u6570\u636e\u503c\u6ca1\u6709\u53d1\u751f\u53d8\u5316\uff0c\u5219\u8fd4\u56de\u7ed3\u679c\u4e3a 1\nchanges(node_load5{instance=\"192.168.1.75:9100\"}[1m]) # \u7ed3\u679c\u4e3a 1\n</code></pre>"},{"location":"chap8/3Promql_basic3/#clamp_max","title":"<code>clamp_max()</code>","text":"<p><code>clamp_max(v instant-vector, max scalar)</code> \u51fd\u6570\uff0c\u8f93\u5165\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\u548c\u6700\u5927\u503c\uff0c\u6837\u672c\u6570\u636e\u503c\u82e5\u5927\u4e8e <code>max</code>\uff0c\u5219\u6539\u4e3a <code>max</code>\uff0c\u5426\u5219\u4e0d\u53d8\u3002\u4f8b\u5982\uff1a</p> <pre><code>node_load5{instance=\"192.168.1.75:9100\"} # \u7ed3\u679c\u4e3a 2.79\nclamp_max(node_load5{instance=\"192.168.1.75:9100\"}, 2) # \u7ed3\u679c\u4e3a 2\n</code></pre>"},{"location":"chap8/3Promql_basic3/#clamp_min","title":"<code>clamp_min()</code>","text":"<p><code>clamp_min(v instant-vector, min scalar)</code> \u51fd\u6570\uff0c\u8f93\u5165\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\u548c\u6700\u5c0f\u503c\uff0c\u6837\u672c\u6570\u636e\u503c\u82e5\u5c0f\u4e8e min\uff0c\u5219\u6539\u4e3a min\uff0c\u5426\u5219\u4e0d\u53d8\u3002\u4f8b\u5982\uff1a</p> <pre><code>node_load5{instance=\"192.168.1.75:9100\"} # \u7ed3\u679c\u4e3a 2.79\nclamp_min(node_load5{instance=\"192.168.1.75:9100\"}, 3) # \u7ed3\u679c\u4e3a 3\n</code></pre>"},{"location":"chap8/3Promql_basic3/#day_of_month","title":"<code>day_of_month()</code>","text":"<p><code>day_of_month(v=vector(time()) instant-vector)</code> \u51fd\u6570\uff0c\u8fd4\u56de\u88ab\u7ed9\u5b9a UTC \u65f6\u95f4\u6240\u5728\u6708\u7684\u7b2c\u51e0\u5929\u3002\u8fd4\u56de\u503c\u8303\u56f4\uff1a<code>1~31</code>\u3002</p>"},{"location":"chap8/3Promql_basic3/#day_of_week","title":"<code>day_of_week()</code>","text":"<p><code>day_of_week(v=vector(time()) instant-vector)</code> \u51fd\u6570\uff0c\u8fd4\u56de\u88ab\u7ed9\u5b9a UTC \u65f6\u95f4\u6240\u5728\u5468\u7684\u7b2c\u51e0\u5929\u3002\u8fd4\u56de\u503c\u8303\u56f4\uff1a<code>0~6</code>\uff0c<code>0</code> \u8868\u793a\u661f\u671f\u5929\u3002</p>"},{"location":"chap8/3Promql_basic3/#days_in_month","title":"<code>days_in_month()</code>","text":"<p><code>days_in_month(v=vector(time()) instant-vector)</code>\u51fd\u6570\uff0c\u8fd4\u56de\u5f53\u6708\u4e00\u5171\u6709\u591a\u5c11\u5929\u3002\u8fd4\u56de\u503c\u8303\u56f4\uff1a<code>28~31</code>\u3002</p>"},{"location":"chap8/3Promql_basic3/#delta","title":"<code>delta()</code>","text":"<p><code>delta(v range-vector)</code> \u7684\u53c2\u6570\u662f\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\uff0c\u8fd4\u56de\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\u3002\u5b83\u8ba1\u7b97\u4e00\u4e2a\u533a\u95f4\u5411\u91cf <code>v</code> \u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\u548c\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u4e4b\u95f4\u7684\u5dee\u503c\u3002\u7531\u4e8e\u8fd9\u4e2a\u503c\u88ab\u5916\u63a8\u5230\u6307\u5b9a\u7684\u6574\u4e2a\u65f6\u95f4\u8303\u56f4\uff0c\u6240\u4ee5\u5373\u4f7f\u6837\u672c\u503c\u90fd\u662f\u6574\u6570\uff0c\u4f60\u4ecd\u7136\u53ef\u80fd\u4f1a\u5f97\u5230\u4e00\u4e2a\u975e\u6574\u6570\u503c\u3002</p> <p>\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u4f8b\u5b50\u8fd4\u56de\u8fc7\u53bb\u4e24\u5c0f\u65f6\u7684 CPU \u6e29\u5ea6\u5dee\uff1a</p> <pre><code>delta(cpu_temp_celsius{host=\"zeus\"}[2h])\n</code></pre> <p>\u8fd9\u4e2a\u51fd\u6570\u4e00\u822c\u53ea\u7528\u5728 Gauge \u7c7b\u578b\u7684\u65f6\u95f4\u5e8f\u5217\u4e0a\u3002</p>"},{"location":"chap8/3Promql_basic3/#deriv","title":"<code>deriv()</code>","text":"<p><code>deriv(v range-vector)</code> \u7684\u53c2\u6570\u662f\u4e00\u4e2a\u533a\u95f4\u5411\u91cf,\u8fd4\u56de\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\u3002\u5b83\u4f7f\u7528\u7b80\u5355\u7684\u7ebf\u6027\u56de\u5f52\u8ba1\u7b97\u533a\u95f4\u5411\u91cf v \u4e2d\u5404\u4e2a\u65f6\u95f4\u5e8f\u5217\u7684\u5bfc\u6570\u3002</p> <p>\u8fd9\u4e2a\u51fd\u6570\u4e00\u822c\u53ea\u7528\u5728 <code>Gauge</code> \u7c7b\u578b\u7684\u65f6\u95f4\u5e8f\u5217\u4e0a\u3002</p>"},{"location":"chap8/3Promql_basic3/#exp","title":"<code>exp()</code>","text":"<p><code>exp(v instant-vector)</code> \u51fd\u6570\uff0c\u8f93\u5165\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\uff0c\u8fd4\u56de\u5404\u4e2a\u6837\u672c\u503c\u7684 <code>e</code> \u7684\u6307\u6570\u503c\uff0c\u5373 <code>e</code>\u7684 <code>N</code> \u6b21\u65b9\u3002\u5f53<code>N</code> \u7684\u503c\u8db3\u591f\u5927\u65f6\u4f1a\u8fd4\u56de<code>+Inf</code>\u3002\u7279\u6b8a\u60c5\u51b5\u4e3a\uff1a</p> <ul> <li><code>Exp(+Inf) = +Inf</code></li> <li><code>Exp(NaN) = NaN</code></li> </ul>"},{"location":"chap8/3Promql_basic3/#floor","title":"<code>floor()</code>","text":"<p><code>floor(v instant-vector)</code> \u51fd\u6570\u4e0e <code>ceil()</code> \u51fd\u6570\u76f8\u53cd\uff0c\u5c06 <code>v</code>\u4e2d\u6240\u6709\u5143\u7d20\u7684\u6837\u672c\u503c\u5411\u4e0b\u56db\u820d\u4e94\u5165\u5230\u6700\u63a5\u8fd1\u7684\u6574\u6570\u3002</p>"},{"location":"chap8/3Promql_basic3/#histogram_quantile","title":"<code>histogram_quantile()</code>","text":"<p><code>histogram_quantile(\u03c6 float, b instant-vector)</code> \u4ece <code>bucket</code> \u7c7b\u578b\u7684\u5411\u91cf <code>b</code> \u4e2d\u8ba1\u7b97 <code>\u03c6 (0 \u2264 \u03c6 \u2264 1)</code> \u5206\u4f4d\u6570\uff08\u767e\u5206\u4f4d\u6570\u7684\u4e00\u822c\u5f62\u5f0f\uff09\u7684\u6837\u672c\u7684\u6700\u5927\u503c\u3002</p> <p>\uff08\u6709\u5173 \u03c6 \u5206\u4f4d\u6570\u7684\u8be6\u7ec6\u8bf4\u660e\u4ee5\u53ca\u76f4\u65b9\u56fe\u6307\u6807\u7c7b\u578b\u7684\u4f7f\u7528\uff0c\u8bf7\u53c2\u9605\u76f4\u65b9\u56fe\u548c\u6458\u8981\uff09\u3002\u5411\u91cf<code>b</code> \u4e2d\u7684\u6837\u672c\u662f\u6bcf\u4e2a <code>bucket</code> \u7684\u91c7\u6837\u70b9\u6570\u91cf\u3002\u6bcf\u4e2a\u6837\u672c\u7684 <code>labels</code> \u4e2d\u5fc5\u987b\u8981\u6709 <code>le</code> \u8fd9\u4e2a <code>label</code> \u6765\u8868\u793a\u6bcf\u4e2a <code>bucket</code> \u7684\u4e0a\u8fb9\u754c\uff0c\u6ca1\u6709 <code>le</code> \u6807\u7b7e\u7684\u6837\u672c\u4f1a\u88ab\u5ffd\u7565\u3002</p> <p>\u76f4\u65b9\u56fe\u6307\u6807\u7c7b\u578b\u81ea\u52a8\u63d0\u4f9b\u5e26\u6709 <code>_bucket</code> \u540e\u7f00\u548c\u76f8\u5e94\u6807\u7b7e\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528 <code>rate()</code> \u51fd\u6570\u6765\u6307\u5b9a\u5206\u4f4d\u6570\u8ba1\u7b97\u7684\u65f6\u95f4\u7a97\u53e3\u3002</p> <p>\u4f8b\u5982\uff0c</p> <p>\u4e00\u4e2a\u76f4\u65b9\u56fe\u6307\u6807\u540d\u79f0\u4e3a <code>employee_age_bucket_bucket</code>\uff0c\u8981\u8ba1\u7b97\u8fc7\u53bb <code>10</code>\u5206\u949f\u5185 \u7b2c <code>90</code> \u4e2a\u767e\u5206\u4f4d\u6570\uff0c\u8bf7\u4f7f\u7528\u4ee5\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>histogram_quantile(0.9, rate(employee_age_bucket_bucket[10m]))\n</code></pre> <p>\u8fd4\u56de\uff1a</p> <pre><code>{instance=\"10.0.86.71:8080\",job=\"prometheus\"} 35.714285714285715\n</code></pre> <p>\u8fd9\u8868\u793a\u6700\u8fd1 <code>10</code> \u5206\u949f\u4e4b\u5185 <code>90%</code> \u7684\u6837\u672c\u7684\u6700\u5927\u503c\u4e3a <code>35.714285714285715</code>\u3002</p> <p>\u8fd9\u4e2a\u8ba1\u7b97\u7ed3\u679c\u662f\u6bcf\u7ec4\u6807\u7b7e\u7ec4\u5408\u6210\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u3002\u6211\u4eec\u53ef\u80fd\u4e0d\u4f1a\u5bf9\u6240\u6709\u8fd9\u4e9b\u7ef4\u5ea6\uff08\u5982 <code>job</code>\u3001<code>instance</code> \u548c<code>method</code>\uff09\u611f\u5174\u8da3\uff0c\u5e76\u5e0c\u671b\u5c06\u5176\u4e2d\u7684\u4e00\u4e9b\u7ef4\u5ea6\u8fdb\u884c\u805a\u5408\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 <code>sum()</code> \u51fd\u6570\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u6839\u636e job \u6807\u7b7e\u6765\u5bf9\u7b2c 90 \u4e2a\u767e\u5206\u4f4d\u6570\u8fdb\u884c\u805a\u5408\uff1a</p> <pre><code># histogram_quantile() \u51fd\u6570\u5fc5\u987b\u5305\u542b le \u6807\u7b7e\nhistogram_quantile(0.9, sum(rate(employee_age_bucket_bucket[10m])) by (job, le))\n</code></pre> <p>\u5982\u679c\u8981\u805a\u5408\u6240\u6709\u7684\u6807\u7b7e\uff0c\u5219\u4f7f\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>histogram_quantile(0.9,sum(rate(employee_age_bucket_bucket[10m])) by (le))\n</code></pre>"},{"location":"chap8/3Promql_basic3/#holt_winters","title":"<code>holt_winters()</code>","text":"<p><code>holt_winters(v range-vector, sf scalar, tf scalar)</code> \u51fd\u6570\u57fa\u4e8e\u533a\u95f4\u5411\u91cf <code>v</code>\uff0c\u751f\u6210\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e73\u6ed1\u503c\u3002\u5e73\u6ed1\u56e0\u5b50 <code>sf</code> \u8d8a\u4f4e, \u5bf9\u65e7\u6570\u636e\u7684\u91cd\u89c6\u7a0b\u5ea6\u8d8a\u9ad8\u3002\u8d8b\u52bf\u56e0\u5b50<code>tf</code> \u8d8a\u9ad8\uff0c\u5bf9\u6570\u636e\u7684\u8d8b\u52bf\u7684\u8003\u8651\u5c31\u8d8a\u591a\u3002\u5176\u4e2d\uff0c<code>0&lt; sf</code>, <code>tf &lt;=1</code>\u3002</p> <p><code>holt_winters</code> \u4ec5\u9002\u7528\u4e8e <code>Gauge</code> \u7c7b\u578b\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p>"},{"location":"chap8/3Promql_basic3/#hour","title":"<code>hour()</code>","text":"<p><code>hour(v=vector(time()) instant-vector)</code> \u51fd\u6570\u8fd4\u56de\u88ab\u7ed9\u5b9a UTC \u65f6\u95f4\u7684\u5f53\u524d\u7b2c\u51e0\u4e2a\u5c0f\u65f6\uff0c\u65f6\u95f4\u8303\u56f4\uff1a<code>0~23</code>\u3002</p>"},{"location":"chap8/3Promql_basic3/#idelta","title":"<code>idelta()</code>","text":"<p><code>idelta(v range-vector)</code> \u7684\u53c2\u6570\u662f\u4e00\u4e2a\u533a\u95f4\u5411\u91cf, \u8fd4\u56de\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\u3002\u5b83\u8ba1\u7b97\u6700\u65b0\u7684 2 \u4e2a\u6837\u672c\u503c\u4e4b\u95f4\u7684\u5dee\u503c\u3002</p> <p>\u8fd9\u4e2a\u51fd\u6570\u4e00\u822c\u53ea\u7528\u5728 Gauge \u7c7b\u578b\u7684\u65f6\u95f4\u5e8f\u5217\u4e0a\u3002</p>"},{"location":"chap8/3Promql_basic3/#increase","title":"<code>increase()</code>","text":"<p><code>increase(v range-vector)</code> \u51fd\u6570\u83b7\u53d6\u533a\u95f4\u5411\u91cf\u4e2d\u7684\u7b2c\u4e00\u4e2a\u548c\u6700\u540e\u4e00\u4e2a\u6837\u672c\u5e76\u8fd4\u56de\u5176\u589e\u957f\u91cf, \u5b83\u4f1a\u5728\u5355\u8c03\u6027\u53d1\u751f\u53d8\u5316\u65f6(\u5982\u7531\u4e8e\u91c7\u6837\u76ee\u6807\u91cd\u542f\u5f15\u8d77\u7684\u8ba1\u6570\u5668\u590d\u4f4d)\u81ea\u52a8\u4e2d\u65ad\u3002\u7531\u4e8e\u8fd9\u4e2a\u503c\u88ab\u5916\u63a8\u5230\u6307\u5b9a\u7684\u6574\u4e2a\u65f6\u95f4\u8303\u56f4\uff0c\u6240\u4ee5\u5373\u4f7f\u6837\u672c\u503c\u90fd\u662f\u6574\u6570\uff0c\u4f60\u4ecd\u7136\u53ef\u80fd\u4f1a\u5f97\u5230\u4e00\u4e2a\u975e\u6574\u6570\u503c\u3002</p> <p>\u4f8b\u5982\uff0c\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u8fd4\u56de\u533a\u95f4\u5411\u91cf\u4e2d\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u8fc7\u53bb <code>5</code> \u5206\u949f\u5185 <code>HTTP</code>\u8bf7\u6c42\u6570\u7684\u589e\u957f\u6570\uff1a</p> <pre><code>increase(http_requests_total{job=\"apiserver\"}[5m])\n</code></pre> <p><code>increase</code> \u7684\u8fd4\u56de\u503c\u7c7b\u578b\u53ea\u80fd\u662f\u8ba1\u6570\u5668\u7c7b\u578b\uff0c\u4e3b\u8981\u4f5c\u7528\u662f\u589e\u52a0\u56fe\u8868\u548c\u6570\u636e\u7684\u53ef\u8bfb\u6027\u3002\u4f7f\u7528 <code>rate</code> \u51fd\u6570\u8bb0\u5f55\u89c4\u5219\u7684\u4f7f\u7528\u7387\uff0c\u4ee5\u4fbf\u6301\u7eed\u8ddf\u8e2a\u6570\u636e\u6837\u672c\u503c\u7684\u53d8\u5316\u3002</p>"},{"location":"chap8/3Promql_basic3/#irate","title":"irate()","text":"<p><code>irate(v range-vector)</code> \u51fd\u6570\u7528\u4e8e\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u7684\u589e\u957f\u7387\uff0c\u4f46\u662f\u5176\u53cd\u5e94\u51fa\u7684\u662f\u77ac\u65f6\u589e\u957f\u7387\u3002<code>irate</code> \u51fd\u6570\u662f\u901a\u8fc7\u533a\u95f4\u5411\u91cf\u4e2d\u6700\u540e\u4e24\u4e2a\u4e24\u672c\u6570\u636e\u6765\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u7684\u589e\u957f\u901f\u7387\uff0c\u5b83\u4f1a\u5728\u5355\u8c03\u6027\u53d1\u751f\u53d8\u5316\u65f6(\u5982\u7531\u4e8e\u91c7\u6837\u76ee\u6807\u91cd\u542f\u5f15\u8d77\u7684\u8ba1\u6570\u5668\u590d\u4f4d)\u81ea\u52a8\u4e2d\u65ad\u3002\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u907f\u514d\u5728\u65f6\u95f4\u7a97\u53e3\u8303\u56f4\u5185\u7684\u201c\u957f\u5c3e\u95ee\u9898\u201d\uff0c\u5e76\u4e14\u4f53\u73b0\u51fa\u66f4\u597d\u7684\u7075\u654f\u5ea6\uff0c\u901a\u8fc7irate\u51fd\u6570\u7ed8\u5236\u7684\u56fe\u6807\u80fd\u591f\u66f4\u597d\u7684\u53cd\u5e94\u6837\u672c\u6570\u636e\u7684\u77ac\u65f6\u53d8\u5316\u72b6\u6001\u3002</p> <p>\u4f8b\u5982\uff0c\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u8fd4\u56de\u533a\u95f4\u5411\u91cf\u4e2d\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u8fc7\u53bb 5 \u5206\u949f\u5185\u6700\u540e\u4e24\u4e2a\u6837\u672c\u6570\u636e\u7684 HTTP \u8bf7\u6c42\u6570\u7684\u589e\u957f\u7387\uff1a</p> <pre><code>irate(http_requests_total{job=\"api-server\"}[5m])\n</code></pre> <p><code>irate</code> \u53ea\u80fd\u7528\u4e8e\u7ed8\u5236\u5feb\u901f\u53d8\u5316\u7684\u8ba1\u6570\u5668\uff0c\u5728\u957f\u671f\u8d8b\u52bf\u5206\u6790\u6216\u8005\u544a\u8b66\u4e2d\u66f4\u63a8\u8350\u4f7f\u7528 <code>rate</code> \u51fd\u6570\u3002\u56e0\u4e3a\u4f7f\u7528 <code>irate</code> \u51fd\u6570\u65f6\uff0c\u901f\u7387\u7684\u7b80\u77ed\u53d8\u5316\u4f1a\u91cd\u7f6e <code>FO</code>R \u8bed\u53e5\uff0c\u5f62\u6210\u7684\u56fe\u5f62\u6709\u5f88\u591a\u6ce2\u5cf0\uff0c\u96be\u4ee5\u9605\u8bfb\u3002</p> <p>\u5f53\u5c06 <code>irate()</code> \u51fd\u6570\u4e0e\u805a\u5408\u8fd0\u7b97\u7b26\uff08\u4f8b\u5982 <code>sum()</code>\uff09\u6216\u968f\u65f6\u95f4\u805a\u5408\u7684\u51fd\u6570\uff08\u4efb\u4f55\u4ee5 _over_time \u7ed3\u5c3e\u7684\u51fd\u6570\uff09\u4e00\u8d77\u4f7f\u7528\u65f6\uff0c\u5fc5\u987b\u5148\u6267\u884c irate \u51fd\u6570\uff0c\u7136\u540e\u518d\u8fdb\u884c\u805a\u5408\u64cd\u4f5c\uff0c\u5426\u5219\u5f53\u91c7\u6837\u76ee\u6807\u91cd\u65b0\u542f\u52a8\u65f6 irate() \u65e0\u6cd5\u68c0\u6d4b\u5230\u8ba1\u6570\u5668\u662f\u5426\u88ab\u91cd\u7f6e\u3002</p>"},{"location":"chap8/3Promql_basic3/#label_join","title":"<code>label_join()</code>","text":"<p><code>label_join(v instant-vector, dst_label string, separator string, src_label_1 string, src_label_2 string, ...)</code></p> <p>\u51fd\u6570\u53ef\u4ee5\u5c06\u65f6\u95f4\u5e8f\u5217 <code>v</code> \u4e2d\u591a\u4e2a\u6807\u7b7e <code>src_label</code> \u7684\u503c\uff0c\u901a\u8fc7 <code>separator</code>\u4f5c\u4e3a\u8fde\u63a5\u7b26\u5199\u5165\u5230\u4e00\u4e2a\u65b0\u7684\u6807\u7b7e <code>dst_label</code> \u4e2d\u3002\u53ef\u4ee5\u6709\u591a\u4e2a <code>src_label</code> \u6807\u7b7e\u3002</p> <p>\u4f8b\u5982\uff0c\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u8fd4\u56de\u7684\u65f6\u95f4\u5e8f\u5217\u591a\u4e86\u4e00\u4e2a <code>foo</code> \u6807\u7b7e\uff0c\u6807\u7b7e\u503c\u4e3a <code>etcd,etcd-k8s</code>\uff1a</p> <pre><code>up{endpoint=\"api\",instance=\"192.168.123.248:2379\",job=\"etcd\",namespace=\"monitoring\",service=\"etcd-k8s\"}\n=&gt; up{endpoint=\"api\",instance=\"192.168.123.248:2379\",job=\"etcd\",namespace=\"monitoring\",service=\"etcd-k8s\"}  1\n\nlabel_join(up{endpoint=\"api\",instance=\"192.168.123.248:2379\",job=\"etcd\",namespace=\"monitoring\",service=\"etcd-k8s\"}, \"foo\", \",\", \"job\", \"service\")\n=&gt; up{endpoint=\"api\",foo=\"etcd,etcd-k8s\",instance=\"192.168.123.248:2379\",job=\"etcd\",namespace=\"monitoring\",service=\"etcd-k8s\"}  1\n</code></pre>"},{"location":"chap8/3Promql_basic3/#label_replace","title":"<code>label_replace()</code>","text":"<p>\u4e3a\u4e86\u80fd\u591f\u8ba9\u5ba2\u6237\u7aef\u7684\u56fe\u6807\u66f4\u5177\u6709\u53ef\u8bfb\u6027\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>label_replace</code> \u51fd\u6570\u4e3a\u65f6\u95f4\u5e8f\u5217\u6dfb\u52a0\u989d\u5916\u7684\u6807\u7b7e\u3002<code>label_replace</code> \u7684\u5177\u4f53\u53c2\u6570\u5982\u4e0b\uff1a</p> <pre><code>label_replace(v instant-vector, dst_label string, replacement string, src_label string, regex string)\n</code></pre> <p>\u8be5\u51fd\u6570\u4f1a\u4f9d\u6b21\u5bf9 <code>v</code> \u4e2d\u7684\u6bcf\u4e00\u6761\u65f6\u95f4\u5e8f\u5217\u8fdb\u884c\u5904\u7406\uff0c\u901a\u8fc7 <code>regex</code> \u5339\u914d <code>src_label</code> \u7684\u503c\uff0c\u5e76\u5c06\u5339\u914d\u90e8\u5206 <code>relacement</code> \u5199\u5165\u5230 <code>dst_label</code> \u6807\u7b7e\u4e2d\u3002\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>label_replace(up, \"host\", \"$1\", \"instance\",  \"(.*):.*\")\n</code></pre> <p>\u51fd\u6570\u5904\u7406\u540e\uff0c\u65f6\u95f4\u5e8f\u5217\u5c06\u5305\u542b\u4e00\u4e2a <code>host</code> \u6807\u7b7e\uff0chost \u6807\u7b7e\u7684\u503c\u4e3a Exporter \u5b9e\u4f8b\u7684 IP \u5730\u5740\uff1a</p> <pre><code>up{host=\"localhost\",instance=\"localhost:8080\",job=\"cadvisor\"}   1\nup{host=\"localhost\",instance=\"localhost:9090\",job=\"prometheus\"}   1\nup{host=\"localhost\",instance=\"localhost:9100\",job=\"node\"}   1\n</code></pre>"},{"location":"chap8/3Promql_basic3/#ln","title":"<code>ln()</code>","text":"<p><code>ln(v instant-vector)</code> \u8ba1\u7b97\u77ac\u65f6\u5411\u91cf v \u4e2d\u6240\u6709\u6837\u672c\u6570\u636e\u7684\u81ea\u7136\u5bf9\u6570\u3002\u7279\u6b8a\u60c5\u51b5\uff1a</p> <ul> <li><code>ln(+Inf) = +Inf</code></li> <li><code>ln(0) = -Inf</code></li> <li><code>ln(x &lt; 0) = NaN</code></li> <li><code>ln(NaN) = NaN</code></li> </ul>"},{"location":"chap8/3Promql_basic3/#log2","title":"<code>log2()</code>","text":"<p><code>log2(v instant-vector)</code> \u51fd\u6570\u8ba1\u7b97\u77ac\u65f6\u5411\u91cf v \u4e2d\u6240\u6709\u6837\u672c\u6570\u636e\u7684\u4e8c\u8fdb\u5236\u5bf9\u6570\u3002\u7279\u6b8a\u60c5\u51b5\u540c\u4e0a\u3002</p>"},{"location":"chap8/3Promql_basic3/#log10","title":"<code>**log10()</code>**","text":"<p><code>log10(v instant-vector)</code> \u8ba1\u7b97\u77ac\u65f6\u5411\u91cf v \u4e2d\u6240\u6709\u6837\u672c\u6570\u636e\u7684\u5341\u8fdb\u5236\u5bf9\u6570\u3002\u7279\u6b8a\u60c5\u51b5\u540c\u4e0a\u3002</p>"},{"location":"chap8/3Promql_basic3/#minute","title":"<code>minute()</code>","text":"<p><code>minute(v=vector(time()) instant-vector)</code> \u51fd\u6570\u8fd4\u56de\u7ed9\u5b9a UTC \u65f6\u95f4\u5f53\u524d\u5c0f\u65f6\u7684\u7b2c\u591a\u5c11\u5206\u949f\u3002\u7ed3\u679c\u8303\u56f4\uff1a0~59\u3002</p>"},{"location":"chap8/3Promql_basic3/#month","title":"<code>month()</code>","text":"<p><code>month(v=vector(time()) instant-vector)</code> \u51fd\u6570\u8fd4\u56de\u7ed9\u5b9a UTC \u65f6\u95f4\u5f53\u524d\u5c5e\u4e8e\u7b2c\u51e0\u4e2a\u6708\uff0c\u7ed3\u679c\u8303\u56f4\uff1a<code>0~12</code>\u3002</p>"},{"location":"chap8/3Promql_basic3/#predict_linear","title":"<code>predict_linear()</code>","text":"<p><code>predict_linear(v range-vector, t scalar)</code> \u51fd\u6570\u53ef\u4ee5\u9884\u6d4b\u65f6\u95f4\u5e8f\u5217 <code>v</code> \u5728 <code>t</code> \u79d2\u540e\u7684\u503c\u3002</p> <p>\u5b83\u57fa\u4e8e\u7b80\u5355\u7ebf\u6027\u56de\u5f52\u7684\u65b9\u5f0f\uff0c\u5bf9\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u6837\u672c\u6570\u636e\u8fdb\u884c\u7edf\u8ba1\uff0c\u4ece\u800c\u53ef\u4ee5\u5bf9\u65f6\u95f4\u5e8f\u5217\u7684\u53d8\u5316\u8d8b\u52bf\u505a\u51fa\u9884\u6d4b\u3002\u8be5\u51fd\u6570\u7684\u8fd4\u56de\u7ed3\u679c\u4e0d\u5e26\u6709\u5ea6\u91cf\u6307\u6807\uff0c\u53ea\u6709\u6807\u7b7e\u5217\u8868\u3002</p> <p>\u4f8b\u5982\uff0c\u57fa\u4e8e <code>2</code> \u5c0f\u65f6\u7684\u6837\u672c\u6570\u636e\uff0c\u6765\u9884\u6d4b\u4e3b\u673a\u53ef\u7528\u78c1\u76d8\u7a7a\u95f4\u7684\u662f\u5426\u5728 4 \u4e2a\u5c0f\u65f6\u5019\u88ab\u5360\u6ee1\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>predict_linear(http_requests_total{code=\"200\",instance=\"120.77.65.193:9090\",job=\"prometheus\",method=\"get\"}[5m], 5)\n\u7ed3\u679c\uff1a\n{code=\"200\",handler=\"query_range\",instance=\"120.77.65.193:9090\",job=\"prometheus\",method=\"get\"}  1\n{code=\"200\",handler=\"prometheus\",instance=\"120.77.65.193:9090\",job=\"prometheus\",method=\"get\"}   4283.449995397104\n{code=\"200\",handler=\"static\",instance=\"120.77.65.193:9090\",job=\"prometheus\",method=\"get\"}   22.99999999999999\n...\n</code></pre> <p>\u8fd9\u4e2a\u51fd\u6570\u4e00\u822c\u53ea\u7528\u5728 Gauge \u7c7b\u578b\u7684\u65f6\u95f4\u5e8f\u5217\u4e0a\u3002</p>"},{"location":"chap8/3Promql_basic3/#rate","title":"<code>rate()</code>","text":"<p><code>rate(v range-vector)</code> \u51fd\u6570\u53ef\u4ee5\u76f4\u63a5\u8ba1\u7b97\u533a\u95f4\u5411\u91cf v \u5728\u65f6\u95f4\u7a97\u53e3\u5185\u5e73\u5747\u589e\u957f\u901f\u7387\uff0c\u5b83\u4f1a\u5728\u5355\u8c03\u6027\u53d1\u751f\u53d8\u5316\u65f6(\u5982\u7531\u4e8e\u91c7\u6837\u76ee\u6807\u91cd\u542f\u5f15\u8d77\u7684\u8ba1\u6570\u5668\u590d\u4f4d)\u81ea\u52a8\u4e2d\u65ad\u3002\u8be5\u51fd\u6570\u7684\u8fd4\u56de\u7ed3\u679c\u4e0d\u5e26\u6709\u5ea6\u91cf\u6307\u6807\uff0c\u53ea\u6709\u6807\u7b7e\u5217\u8868\u3002</p> <p>\u4f8b\u5982\uff0c\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u8fd4\u56de\u533a\u95f4\u5411\u91cf\u4e2d\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u8fc7\u53bb 5 \u5206\u949f\u5185 HTTP \u8bf7\u6c42\u6570\u7684\u6bcf\u79d2\u589e\u957f\u7387\uff1a</p> <pre><code>rate(http_requests_total[5m])\n\u7ed3\u679c\uff1a\n{code=\"200\",handler=\"label_values\",instance=\"120.77.65.193:9090\",job=\"prometheus\",method=\"get\"} 0\n{code=\"200\",handler=\"query_range\",instance=\"120.77.65.193:9090\",job=\"prometheus\",method=\"get\"}  0\n{code=\"200\",handler=\"prometheus\",instance=\"120.77.65.193:9090\",job=\"prometheus\",method=\"get\"}   0.2\n...\n</code></pre> <p>rate() \u51fd\u6570\u8fd4\u56de\u503c\u7c7b\u578b\u53ea\u80fd\u7528\u8ba1\u6570\u5668\uff0c\u5728\u957f\u671f\u8d8b\u52bf\u5206\u6790\u6216\u8005\u544a\u8b66\u4e2d\u63a8\u8350\u4f7f\u7528\u8fd9\u4e2a\u51fd\u6570\u3002</p>"},{"location":"chap8/3Promql_basic3/#resets","title":"<code>resets()</code>","text":"<p><code>resets(v range-vector)</code> \u7684\u53c2\u6570\u662f\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\uff0c\u5b83\u90fd\u8fd4\u56de\u4e00\u4e2a\u8ba1\u6570\u5668\u91cd\u7f6e\u7684\u6b21\u6570\u3002\u4e24\u4e2a\u8fde\u7eed\u6837\u672c\u4e4b\u95f4\u7684\u503c\u7684\u51cf\u5c11\u88ab\u8ba4\u4e3a\u662f\u4e00\u6b21\u8ba1\u6570\u5668\u91cd\u7f6e\u3002</p> <p>\u8fd9\u4e2a\u51fd\u6570\u4e00\u822c\u53ea\u7528\u5728\u8ba1\u6570\u5668\u7c7b\u578b\u7684\u65f6\u95f4\u5e8f\u5217\u4e0a\u3002</p>"},{"location":"chap8/3Promql_basic3/#round","title":"<code>round()</code>","text":"<p><code>round(v instant-vector, to_nearest=1 scalar)</code> \u51fd\u6570\u4e0e <code>ceil</code>\u548c <code>floor</code> \u51fd\u6570\u7c7b\u4f3c\uff0c\u8fd4\u56de\u5411\u91cf\u4e2d\u6240\u6709\u6837\u672c\u503c\u7684\u6700\u63a5\u8fd1\u7684\u6574\u6570\u3002<code>to_nearest</code> \u53c2\u6570\u662f\u53ef\u9009\u7684,\u9ed8\u8ba4\u4e3a <code>1</code>,\u8868\u793a\u6837\u672c\u8fd4\u56de\u7684\u662f\u6700\u63a5\u8fd1 <code>1</code> \u7684\u6574\u6570\u500d\u7684\u503c\u3002\u4f60\u4e5f\u53ef\u4ee5\u5c06\u8be5\u53c2\u6570\u6307\u5b9a\u4e3a\u4efb\u610f\u503c\uff08\u4e5f\u53ef\u4ee5\u662f\u5c0f\u6570\uff09\uff0c\u8868\u793a\u6837\u672c\u8fd4\u56de\u7684\u662f\u6700\u63a5\u8fd1\u5b83\u7684\u6574\u6570\u500d\u7684\u503c\u3002</p>"},{"location":"chap8/3Promql_basic3/#scalar","title":"<code>scalar()</code>","text":"<p><code>scalar(v instant-vector)</code> \u51fd\u6570\u7684\u53c2\u6570\u662f\u4e00\u4e2a\u5355\u5143\u7d20\u7684\u77ac\u65f6\u5411\u91cf,\u5b83\u8fd4\u56de\u5176\u552f\u4e00\u7684\u65f6\u95f4\u5e8f\u5217\u7684\u503c\u4f5c\u4e3a\u4e00\u4e2a\u6807\u91cf\u3002\u5982\u679c\u5ea6\u91cf\u6307\u6807\u7684\u6837\u672c\u6570\u91cf\u5927\u4e8e <code>1</code>\u6216\u8005\u7b49\u4e8e <code>0</code>, \u5219\u8fd4\u56de <code>NaN</code>\u3002</p>"},{"location":"chap8/3Promql_basic3/#sort","title":"<code>sort()</code>","text":"<p><code>sort(v instant-vector)</code>\u51fd\u6570\u5bf9\u5411\u91cf\u6309\u5143\u7d20\u7684\u503c\u8fdb\u884c\u5347\u5e8f\u6392\u5e8f\uff0c\u8fd4\u56de\u7ed3\u679c\uff1a<code>key: value = \u5ea6\u91cf\u6307\u6807\uff1a\u6837\u672c\u503c[\u5347\u5e8f\u6392\u5217]</code>\u3002</p>"},{"location":"chap8/3Promql_basic3/#sort_desc","title":"<code>sort_desc()</code>","text":"<p><code>sort(v instant-vector)</code> \u51fd\u6570\u5bf9\u5411\u91cf\u6309\u5143\u7d20\u7684\u503c\u8fdb\u884c\u964d\u5e8f\u6392\u5e8f\uff0c\u8fd4\u56de\u7ed3\u679c\uff1a<code>key: value = \u5ea6\u91cf\u6307\u6807\uff1a\u6837\u672c\u503c[\u964d\u5e8f\u6392\u5217]</code>\u3002</p>"},{"location":"chap8/3Promql_basic3/#sqrt","title":"<code>sqrt()</code>","text":"<p><code>sqrt(v instant-vector)</code> \u51fd\u6570\u8ba1\u7b97\u5411\u91cf v \u4e2d\u6240\u6709\u5143\u7d20\u7684\u5e73\u65b9\u6839\u3002</p>"},{"location":"chap8/3Promql_basic3/#time","title":"<code>time()</code>","text":"<p><code>time()</code> \u51fd\u6570\u8fd4\u56de\u4ece 1970-01-01 \u5230\u73b0\u5728\u7684\u79d2\u6570\u3002\u6ce8\u610f\uff1a\u5b83\u4e0d\u662f\u76f4\u63a5\u8fd4\u56de\u5f53\u524d\u65f6\u95f4\uff0c\u800c\u662f\u65f6\u95f4\u6233</p>"},{"location":"chap8/3Promql_basic3/#timestamp","title":"<code>timestamp()</code>","text":"<p><code>timestamp(v instant-vector)</code>\u51fd\u6570\u8fd4\u56de\u5411\u91cf v \u4e2d\u7684\u6bcf\u4e2a\u6837\u672c\u7684\u65f6\u95f4\u6233\uff08\u4ece 1970-01-01 \u5230\u73b0\u5728\u7684\u79d2\u6570\uff09\u3002</p>"},{"location":"chap8/3Promql_basic3/#vector","title":"<code>vector()</code>","text":"<p><code>vector(s scalar)</code> \u51fd\u6570\u5c06\u6807\u91cf s \u4f5c\u4e3a\u6ca1\u6709\u6807\u7b7e\u7684\u5411\u91cf\u8fd4\u56de\uff0c\u5373\u8fd4\u56de\u7ed3\u679c\u4e3a\uff1a<code>key: value= {}, s</code>\u3002</p>"},{"location":"chap8/3Promql_basic3/#year","title":"<code>year()</code>","text":"<p><code>year(v=vector(time()) instant-vector)</code> \u51fd\u6570\u8fd4\u56de\u88ab\u7ed9\u5b9a UTC \u65f6\u95f4\u7684\u5f53\u524d\u5e74\u4efd\u3002</p>"},{"location":"chap8/3Promql_basic3/#aggregation_over_time","title":"<code>&lt;aggregation&gt;_over_time()</code>","text":"<p>\u4e0b\u9762\u7684\u51fd\u6570\u5217\u8868\u5141\u8bb8\u4f20\u5165\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\uff0c\u5b83\u4eec\u4f1a\u805a\u5408\u6bcf\u4e2a\u65f6\u95f4\u5e8f\u5217\u7684\u8303\u56f4\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\uff1a</p> <ul> <li><code>avg_over_time(range-vector)</code> : \u533a\u95f4\u5411\u91cf\u5185\u6bcf\u4e2a\u5ea6\u91cf\u6307\u6807\u7684\u5e73\u5747\u503c\u3002</li> <li><code>min_over_time(range-vector)</code> : \u533a\u95f4\u5411\u91cf\u5185\u6bcf\u4e2a\u5ea6\u91cf\u6307\u6807\u7684\u6700\u5c0f\u503c\u3002</li> <li><code>max_over_time(range-vector)</code> : \u533a\u95f4\u5411\u91cf\u5185\u6bcf\u4e2a\u5ea6\u91cf\u6307\u6807\u7684\u6700\u5927\u503c\u3002</li> <li><code>sum_over_time(range-vector)</code> : \u533a\u95f4\u5411\u91cf\u5185\u6bcf\u4e2a\u5ea6\u91cf\u6307\u6807\u7684\u6c42\u548c\u3002</li> <li><code>count_over_time(range-vector)</code> : \u533a\u95f4\u5411\u91cf\u5185\u6bcf\u4e2a\u5ea6\u91cf\u6307\u6807\u7684\u6837\u672c\u6570\u636e\u4e2a\u6570\u3002</li> <li><code>quantile_over_time(scalar, range-vector)</code> : \u533a\u95f4\u5411\u91cf\u5185\u6bcf\u4e2a\u5ea6\u91cf\u6307\u6807\u7684\u6837\u672c\u6570\u636e\u503c\u5206\u4f4d\u6570\uff0c<code>\u03c6-quantile (0 \u2264 \u03c6 \u2264 1)</code>\u3002</li> <li><code>stddev_over_time(range-vector)</code> : \u533a\u95f4\u5411\u91cf\u5185\u6bcf\u4e2a\u5ea6\u91cf\u6307\u6807\u7684\u603b\u4f53\u6807\u51c6\u5dee\u3002</li> <li><code>stdvar_over_time(range-vector)</code>: \u533a\u95f4\u5411\u91cf\u5185\u6bcf\u4e2a\u5ea6\u91cf\u6307\u6807\u7684\u603b\u4f53\u6807\u51c6\u65b9\u5dee</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/","title":"9 Prometheus Operator \u5e38\u7528\u6307\u6807","text":"<p>Prometheus Operator \u5b89\u88c5\u5b8c\u6210\u540e\u4f1a\u6709\u5f88\u591a\u9ed8\u8ba4\u7684\u76d1\u63a7\u6307\u6807\uff0c\u4e00\u4e0d\u6ce8\u610f\u5c31\u5927\u91cf\u7684\u62a5\u8b66\u4ea7\u751f\uff0c\u6240\u4ee5\u6211\u4eec\u975e\u5e38\u6709\u5fc5\u8981\u4e86\u89e3\u4e0b\u8fd9\u4e9b\u5e38\u7528\u7684\u76d1\u63a7\u6307\u6807\uff0c\u6709\u90e8\u5206\u6307\u6807\u5f88\u6709\u53ef\u80fd\u5bf9\u4e8e\u6211\u4eec\u81ea\u5df1\u7684\u4e1a\u52a1\u53ef\u6709\u53ef\u65e0\uff0c\u6240\u4ee5\u53ef\u4ee5\u9002\u5f53\u7684\u8fdb\u884c\u4fee\u6539\uff0c\u8fd9\u91cc\u6211\u4eec\u5c31\u6765\u5bf9\u5e38\u7528\u7684\u51e0\u4e2a\u6307\u6807\u8fdb\u884c\u7b80\u5355\u7684\u8bf4\u660e\u3002</p>"},{"location":"chap8/42Prometheus_operator_metrics/#1-kubernetes","title":"1. Kubernetes \u8d44\u6e90\u76f8\u5173","text":""},{"location":"chap8/42Prometheus_operator_metrics/#11-cputhrottlinghigh","title":"1.1 CPUThrottlingHigh","text":"<p>\u5173\u4e8e CPU \u7684 limit \u5408\u7406\u6027\u6307\u6807\u3002\u67e5\u51fa\u6700\u8fd15\u5206\u949f\uff0c\u8d85\u8fc725%\u7684 CPU \u6267\u884c\u5468\u671f\u53d7\u5230\u9650\u5236\u7684\u5bb9\u5668\u3002\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(increase(container_cpu_cfs_throttled_periods_total{container!=\"\", }[5m])) by (container, pod, namespace)\n          /\nsum(increase(container_cpu_cfs_periods_total{}[5m])) by (container, pod, namespace)\n          &gt; ( 25 / 100 )\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>container_cpu_cfs_periods_total</code>\uff1a\u5bb9\u5668\u751f\u547d\u5468\u671f\u4e2d\u5ea6\u8fc7\u7684 cpu \u5468\u671f\u603b\u6570</li> <li><code>container_cpu_cfs_throttled_periods_total</code>\uff1a\u5bb9\u5668\u751f\u547d\u5468\u671f\u4e2d\u5ea6\u8fc7\u7684\u53d7\u9650\u7684 cpu \u5468\u671f\u603b\u6570</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#12-kubecpuovercommit","title":"1.2 KubeCPUOvercommit","text":"<p>\u96c6\u7fa4 CPU \u8fc7\u5ea6\u4f7f\u7528\u3002CPU \u5df2\u7ecf\u8fc7\u5ea6\u4f7f\u7528\u65e0\u6cd5\u5bb9\u5fcd\u8282\u70b9\u6545\u969c\uff0c\u8282\u70b9\u8d44\u6e90\u4f7f\u7528\u7684\u603b\u91cf\u8d85\u8fc7\u8282\u70b9\u7684 CPU \u603b\u91cf\uff0c\u6240\u4ee5\u5982\u679c\u6709\u8282\u70b9\u6545\u969c\u5c06\u5f71\u54cd\u96c6\u7fa4\u8d44\u6e90\u8fd0\u884c\u56e0\u4e3a\u6240\u9700\u8d44\u6e90\u5c06\u65e0\u6cd5\u88ab\u5206\u914d\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(namespace:kube_pod_container_resource_requests_cpu_cores:sum{})\n          /\nsum(kube_node_status_allocatable_cpu_cores)\n          &gt;\n(count(kube_node_status_allocatable_cpu_cores)-1) / count(kube_node_status_allocatable_cpu_cores)\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_pod_container_resource_requests_cpu_cores</code>\uff1a\u8d44\u6e90 CPU \u4f7f\u7528\u7684 cores \u6570\u91cf</li> <li><code>kube_node_status_allocatable_cpu_cores</code>\uff1a\u8282\u70b9 CPU cores \u6570\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#13-kubememoryovercommit","title":"1.3 KubeMemoryOvercommit","text":"<p>\u96c6\u7fa4\u5185\u5b58\u8fc7\u5ea6\u4f7f\u7528\u3002\u5185\u5b58\u5df2\u7ecf\u8fc7\u5ea6\u4f7f\u7528\u65e0\u6cd5\u5bb9\u5fcd\u8282\u70b9\u6545\u969c\uff0c\u8282\u70b9\u8d44\u6e90\u4f7f\u7528\u7684\u603b\u91cf\u8d85\u8fc7\u8282\u70b9\u7684\u5185\u5b58\u603b\u91cf\uff0c\u6240\u4ee5\u5982\u679c\u6709\u8282\u70b9\u6545\u969c\u5c06\u5f71\u54cd\u96c6\u7fa4\u8d44\u6e90\u8fd0\u884c\u56e0\u4e3a\u6240\u9700\u8d44\u6e90\u5c06\u65e0\u6cd5\u88ab\u5206\u914d\u3002\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(namespace:kube_pod_container_resource_requests_memory_bytes:sum{})\n          /\n        sum(kube_node_status_allocatable_memory_bytes)\n          &gt;\n        (count(kube_node_status_allocatable_memory_bytes)-1)\n          /\n        count(kube_node_status_allocatable_memory_bytes)\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_pod_container_resource_requests_memory_bytes</code>\uff1a\u8d44\u6e90\u5185\u5b58\u4f7f\u7528\u7684\u91cf</li> <li><code>kube_node_status_allocatable_memory_bytes</code>\uff1a\u8282\u70b9\u5185\u5b58\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#14-kubecpuquotaovercommit","title":"1.4 KubeCPUQuotaOvercommit","text":"<p>\u96c6\u7fa4CPU\u662f\u5426\u8d85\u5206\u3002\u67e5\u770b CPU \u8d44\u6e90\u5206\u914d\u7684\u989d\u5ea6\u662f\u5426\u8d85\u8fc7\u8fdb\u7fa4\u603b\u989d\u5ea6</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(kube_pod_container_resource_limits_cpu_cores{job=\"kube-state-metrics\"})\n          /\n        sum(kube_node_status_allocatable_cpu_cores)\n          &gt; 1.1\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_pod_container_resource_limits_cpu_cores</code>\uff1a\u8d44\u6e90\u5206\u914d\u7684 CPU \u8d44\u6e90\u989d\u5ea6</li> <li><code>kube_node_status_allocatable_cpu_cores</code>\uff1a\u8282\u70b9 CPU \u603b\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#15-kubememoryquotaovercommit","title":"1.5 KubeMemoryQuotaOvercommit","text":"<p>\u96c6\u7fa4\u8d85\u5206\u5185\u5b58\uff0c\u67e5\u770b\u5185\u5b58\u8d44\u6e90\u5206\u914d\u7684\u989d\u5ea6\u662f\u5426\u8d85\u8fc7\u8fdb\u7fa4\u603b\u989d\u5ea6</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(kube_pod_container_resource_limits_memory_bytes{job=\"kube-state-metrics\"})\n          /\n        sum(kube_node_status_allocatable_memory_bytes{job=\"kube-state-metrics\"})\n          &gt; 1.1\n</code></pre> <p>\u76f8\u5173\u6307\u6807:</p> <ul> <li><code>kube_pod_container_resource_limits_memory_bytes</code>\uff1a\u8d44\u6e90\u914d\u989d\u5185\u5b58\u91cf</li> <li><code>kube_node_status_allocatable_memory_bytes</code>\uff1a\u8282\u70b9\u5185\u5b58\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#16-kubememquotaexceeded","title":"1.6 KubeMEMQuotaExceeded","text":"<p>\u547d\u540d\u7a7a\u95f4\u7ea7\u5185\u5b58\u8d44\u6e90\u4f7f\u7528\u7684\u6bd4\u4f8b\uff0c\u5173\u4e4e\u8d44\u6e90\u914d\u989d\u3002\u5f53\u4f7f\u7528 request \u548c limit \u9650\u5236\u8d44\u6e90\u65f6\uff0c\u4f7f\u7528\u503c\u548c\u6700\u5927\u503c\u8fd8\u662f\u6709\u4e00\u70b9\u533a\u522b\uff0c\u5f53\u6709 request \u65f6\u8bf4\u660e\u6700\u4f4e\u5206\u914d\u4e86\u8fd9\u4e48\u591a\u8d44\u6e90\u3002\u9700\u8981\u6ce8\u610f\u5f53 request \u7b49\u4e8e limit \u65f6\u90a3\u4e48\u8bf4\u660e\u8d44\u6e90\u5df2\u7ecf\u662f100%\u5df2\u7ecf\u5206\u914d\u4f7f\u7528\u5f53\u76d1\u63a7\u544a\u8b66\u53d1\u51fa\u7684\u65f6\u5019\u9700\u8981\u533a\u5206\u3002\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum (kube_pod_container_resource_requests_memory_bytes{job=\"kube-state-metrics\"} ) by (namespace)/ (sum(kube_pod_container_resource_limits_memory_bytes{job=\"kube-state-metrics\"}) by (namespace)) &gt; 0.8\n</code></pre> <p>\u76f8\u5173\u6307\u6807:</p> <ul> <li><code>kube_pod_container_resource_requests_memory_bytes</code>\uff1a\u5185\u5b58\u8d44\u6e90\u4f7f\u7528\u91cf</li> <li><code>kube_pod_container_resource_limits_memory_bytes</code>\uff1a\u5185\u5b58\u8d44\u6e90\u6700\u5927\u503c</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#17-kubecpuquotaexceeded","title":"1.7 KubeCPUQuotaExceeded","text":"<p>\u547d\u540d\u7a7a\u95f4\u7ea7 CPU \u8d44\u6e90\u4f7f\u7528\u7684\u6bd4\u4f8b\uff0c\u5173\u4e4e\u8d44\u6e90\u914d\u989d\u3002\u5f53\u4f7f\u7528 request \u548c limit \u9650\u5236\u8d44\u6e90\u65f6\uff0c\u4f7f\u7528\u503c\u548c\u6700\u5927\u503c\u8fd8\u662f\u6709\u4e00\u70b9\u533a\u522b\uff0c\u5f53\u6709 request \u65f6\u8bf4\u660e\u6700\u4f4e\u5206\u914d\u4e86\u8fd9\u4e48\u591a\u8d44\u6e90\u3002\u9700\u8981\u6ce8\u610f\u5f53 request \u7b49\u4e8e limit \u65f6\u90a3\u4e48\u8bf4\u660e\u8d44\u6e90\u5df2\u7ecf\u662f100%\u5df2\u7ecf\u5206\u914d\u4f7f\u7528\u5f53\u76d1\u63a7\u544a\u8b66\u53d1\u51fa\u7684\u65f6\u5019\u9700\u8981\u533a\u5206\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum (kube_pod_container_resource_requests_cpu_cores{job=\"kube-state-metrics\"} ) by (namespace)/ (sum(kube_pod_container_resource_limits_cpu_cores{job=\"kube-state-metrics\"}) by (namespace)) &gt; 0.8\n</code></pre> <p>\u76f8\u5173\u6307\u6807:</p> <ul> <li><code>kube_pod_container_resource_requests_cpu_cores</code>\uff1aCPU \u4f7f\u7528\u91cf</li> <li><code>kube_pod_container_resource_limits_cpu_cores</code>\uff1aCPU \u9650\u989d\u6700\u5927\u503c</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#2-kubernetes","title":"2. Kubernetes \u5b58\u50a8\u76f8\u5173","text":""},{"location":"chap8/42Prometheus_operator_metrics/#21-kubepersistentvolumefillingup","title":"2.1 KubePersistentVolumeFillingUp","text":"<p>PVC \u5bb9\u91cf\u76d1\u63a7</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>kubelet_volume_stats_available_bytes{job=\"kubelet\", metrics_path=\"/metrics\"}\n          /\n        kubelet_volume_stats_capacity_bytes{job=\"kubelet\", metrics_path=\"/metrics\"}\n          &lt; 0.3\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kubelet_volume_stats_available_bytes</code>\uff1a\u5269\u4f59\u7a7a\u95f4</li> <li><code>kubelet_volume_stats_capacity_bytes</code>\uff1a\u7a7a\u95f4\u603b\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#22-kubepersistentvolumefillingup","title":"2.2 KubePersistentVolumeFillingUp","text":"<p>\u78c1\u76d8\u7a7a\u95f4\u8017\u5c3d\u9884\u6d4b\uff1a\u901a\u8fc7PVC\u8d44\u6e90\u4f7f\u75286\u5c0f\u65f6\u53d8\u5316\u7387\u9884\u6d4b \u63a5\u4e0b\u67654\u5929\u7684\u78c1\u76d8\u4f7f\u7528\u7387</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(kubelet_volume_stats_available_bytes{job=\"kubelet\", metrics_path=\"/metrics\"}\n            /\n          kubelet_volume_stats_capacity_bytes{job=\"kubelet\", metrics_path=\"/metrics\"}\n        ) &lt; 0.4\n        and\n        predict_linear(kubelet_volume_stats_available_bytes{job=\"kubelet\", metrics_path=\"/metrics\"}[6h], 4 * 24 * 3600) &lt; 0\n</code></pre> <p>\u76f8\u5173\u6307\u6807:</p> <ul> <li><code>kubelet_volume_stats_available_bytes</code>\uff1a\u5269\u4f59\u7a7a\u95f4</li> <li><code>kubelet_volume_stats_capacity_bytes</code>\uff1a\u7a7a\u95f4\u603b\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#23-kubepersistentvolumeerrors","title":"2.3 KubePersistentVolumeErrors","text":"<p>PV \u4f7f\u7528\u72b6\u6001\u76d1\u63a7\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>kube_persistentvolume_status_phase{phase=~\"Failed|Pending\",job=\"kube-state-metrics\"}\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_persistentvolume_status_phase</code>\uff1aPV \u4f7f\u7528\u72b6\u6001</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#3-kubernetes-system","title":"3. kubernetes system \u76f8\u5173","text":""},{"location":"chap8/42Prometheus_operator_metrics/#31-kubeversionmismatch","title":"3.1 KubeVersionMismatch","text":"<p>\u7ec4\u4ef6\u7248\u672c\u4e0e\u5f53\u524d\u96c6\u7fa4\u7248\u672c\u662f\u5426\u6709\u5dee\u5f02\u3002\u5bf9\u6bd4\u7ec4\u4ef6\u7248\u672c\u662f\u5426\u6709\u5dee\u5f02\uff0c\u9ed8\u8ba4\u4e3a1 \u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>count(count by (gitVersion) (label_replace(kubernetes_build_info{job!~\"kube-dns|coredns\"},\"gitVersion\",\"$1\",\"gitVersion\",\"(v[0-9]*.[0-9]*.[0-9]*).*\")))\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kubernetes_build_info</code>\uff1a\u83b7\u53d6\u7ec4\u4ef6\u4fe1\u606f</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#32-kubeclienterrors","title":"3.2 KubeClientErrors","text":"<p>\u5ba2\u6237\u7aef\u8bbf\u95ee\u67d0\u4e9b\u63a5\u53e3\u7684\u9519\u8bef\u7387\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(sum(rate(rest_client_requests_total{code=~\"5..\"}[5m])) by (instance, job)\n          /\n        sum(rate(rest_client_requests_total[5m])) by (instance, job))\n        &gt; 0.01\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>rest_client_requests_total</code>\uff1a\u72b6\u6001\u7801</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#4-apiserver","title":"4. APIServer \u76f8\u5173","text":""},{"location":"chap8/42Prometheus_operator_metrics/#41-kubeapierrorshigh","title":"4.1 KubeAPIErrorsHigh","text":"<p>APIServer \u8bf7\u6c42\u9519\u8bef\u7387\u30025\u5206\u949f\u5185 APIServer \u8bf7\u6c42\u9519\u8bef\u7387\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(rate(apiserver_request_total{job=\"apiserver\",code=~\"5..\"}[5m])) by (resource,subresource,verb)\n          /\n        sum(rate(apiserver_request_total{job=\"apiserver\"}[5m])) by (resource,subresource,verb) &gt; 0.0\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>apiserver_request_total\uff1aAPIServer</code> \u8bf7\u6c42\u6570</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#42-kubeclientcertificateexpiration","title":"4.2 KubeClientCertificateExpiration","text":"<p>kubelet \u5ba2\u6237\u7aef\u8bc1\u4e66\u8fc7\u671f\u3002\u76d1\u6d4b\u8bc1\u4e66\u72b6\u600130\u5929\u544a\u8b66\u548c7\u5929\u544a\u8b66\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>apiserver_client_certificate_expiration_seconds_count{job=\"apiserver\"} &gt; 0 and on(job) histogram_quantile(0.01, sum by (job, le) (rate(apiserver_client_certificate_expiration_seconds_bucket{job=\"apiserver\"}[5m]))) &lt; 2592000\napiserver_client_certificate_expiration_seconds_count{job=\"apiserver\"} &gt; 0 and on(job) histogram_quantile(0.01, sum by (job, le) (rate(apiserver_client_certificate_expiration_seconds_bucket{job=\"apiserver\"}[5m]))) &lt; 604800\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>apiserver_client_certificate_expiration_seconds_count</code>\uff1a\u8bc1\u4e66\u6709\u6548\u5269\u4f59\u65f6\u95f4</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#43-aggregatedapierrors","title":"4.3 AggregatedAPIErrors","text":"<p>\u81ea\u5b9a\u4e49\u6ce8\u518c\u7684 APIServer \u670d\u52a1\u53ef\u7528\u6027\u76d1\u63a7\uff0c\u5f53\u68c0\u6d4b\u5230\u81ea\u5b9a\u4e49\u6ce8\u518c\u7684 APIServer \u4e94\u5206\u949f\u4e0d\u7528\u6b21\u6570\u8fbe\u52302\u6b21\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum by(name, namespace)(increase(aggregator_unavailable_apiservice_count[5m])) &gt; 2\n</code></pre> <p>\u76f8\u5173\u6307\u6807:</p> <ul> <li><code>aggregator_unavailable_apiservice_count</code>\uff1a\u76d1\u6d4b\u81ea\u5b9a\u4e49\u6ce8\u518c\u7684 APIService \u4e0d\u53ef\u7528\u6b21\u6570\u3002</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#44-kubeapidown","title":"4.4 KubeAPIDown","text":"<p>APIserver \u5931\u8054\uff0c\u76d1\u63a7 APIServer \u670d\u52a1\uff0c\u5931\u8054\u539f\u56e0\u53ef\u80fd\u662f\u670d\u52a1 down \u8fd8\u53ef\u80fd\u662f\u7f51\u7edc\u51fa\u73b0\u72b6\u51b5\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>absent(up{job=\"apiserver\"} == 1)\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#5-kubelet","title":"5. kubelet \u76f8\u5173","text":""},{"location":"chap8/42Prometheus_operator_metrics/#51-kubenodenotready","title":"5.1 KubeNodeNotReady","text":"<p>\u8282\u70b9\u662f\u5426\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\u3002\u68c0\u6d4b\u8282\u70b9\u662f\u5426\u4e3a\u5c31\u7eea\u72b6\u6001\uff0c\u6216\u8005\u53ef\u80fd\u662f kubelet \u670d\u52a1down \u4e86\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>kube_node_status_condition{job=\"kube-state-metrics\",condition=\"Ready\",status=\"true\"} == 0\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_node_status_condition</code>\uff1a\u8282\u70b9\u72b6\u6001\u76d1\u6d4b</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#52-kubenodeunreachable","title":"5.2 KubeNodeUnreachable","text":"<p>\u8282\u70b9\u72b6\u6001\u4e3a Unreachable\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>kube_node_spec_unschedulable{job=\"kube-state-metrics\"} == 1\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#53-kubelettoomanypods","title":"5.3 KubeletTooManyPods","text":"<p>\u8282\u70b9\u8fd0\u884c\u8fc7\u591a\u7684 Pod\uff0c\u76d1\u6d4b\u8282\u70b9\u4e0a\u8fd0\u884c\u7684 Pods \u6570\u91cf\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>max(max(kubelet_running_pod_count{job=\"kubelet\", metrics_path=\"/metrics\"}) by(instance) * on(instance) group_left(node) kubelet_node_name{job=\"kubelet\", metrics_path=\"/metrics\"}) by(node) / max(kube_node_status_capacity_pods{job=\"kube-state-metrics\"} != 1) by(node) &gt; 0.95\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kubelet_running_pod_count</code>\uff1a\u8282\u70b9\u8fd0\u884c\u7684 Pods \u6570\u91cf</li> <li><code>kubelet_node_name</code>\uff1a\u8282\u70b9\u540d\u79f0</li> <li><code>kube_node_status_capacity_pods</code>\uff1a\u8282\u70b9\u53ef\u8fd0\u884c\u7684\u6700\u5927 Pod \u6570\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#54-kubenodereadinessflapping","title":"5.4 KubeNodeReadinessFlapping","text":"<p>\u76d1\u6d4b\u96c6\u7fa4\u72b6\u6001\uff0c\u67e5\u770b\u96c6\u7fa4\u5185\u8282\u70b9\u72b6\u6001\u6539\u53d8\u7684\u9891\u7387\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(changes(kube_node_status_condition{status=\"true\",condition=\"Ready\"}[15m])) by (node) &gt; 2\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#55-kubeletdown","title":"5.5 KubeletDown","text":"<p>\u76d1\u63a7 kubelet \u670d\u52a1\uff0cdown \u6216\u8005\u7f51\u7edc\u51fa\u73b0\u95ee\u9898\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>absent(up{job=\"kubelet\", metrics_path=\"/metrics\"} == 1)\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#6","title":"6. \u96c6\u7fa4\u7ec4\u4ef6","text":""},{"location":"chap8/42Prometheus_operator_metrics/#61-kubeschedulerdown","title":"6.1 KubeSchedulerDown","text":"<p>KubeScheduler \u5931\u8054\uff0c\u76d1\u6d4b KubeScheduler \u662f\u5426\u6b63\u5e38\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>absent(up{job=\"kube-scheduler\"} == 1)\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#62-kubecontrollermanagerdown","title":"6.2 KubeControllerManagerDown","text":"<p>\u76d1\u6d4b KubeControllerManager \u670d\u52a1\uff0cDown \u6216\u8005\u7f51\u7edc\u4e0d\u901a\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>absent(up{job=\"kube-controller-manager\"} == 1)\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#7","title":"7. \u5e94\u7528\u76f8\u5173","text":""},{"location":"chap8/42Prometheus_operator_metrics/#71-kubepodcrashlooping","title":"7.1 KubePodCrashLooping","text":"<p>Pod \u91cd\u542f\u65f6\u95f4\uff0c\u91cd\u542f\u65f6\u95f4\u8d85\u8fc73m\u544a\u8b66\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>rate(kube_pod_container_status_restarts_total{job=\"kube-state-metrics\"}[5m]) * 60 * 3 &gt; 0\n</code></pre> <p>\u76f8\u5173\u6307\u6807:</p> <ul> <li><code>kube_pod_container_status_restarts_total</code>\uff1a\u91cd\u542f\u72b6\u60010\u4e3a\u6b63\u5e38</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#72-kubepodnotready","title":"7.2 KubePodNotReady","text":"<p>Pods \u6ca1\u6709\u5c31\u7eea\uff0c\u68c0\u6d4b Pod \u662f\u5426\u5c31\u7eea\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum by (namespace, pod) (max by(namespace, pod) (kube_pod_status_phase{job=\"kube-state-metrics\", phase=~\"Pending|Unknown\"}) * on(namespace, pod) group_left(owner_kind) max by(namespace, pod, owner_kind) (kube_pod_owner{owner_kind!=\"Job\"})) &gt; 0\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_pod_status_phase</code>\uff1aPod \u72b6\u6001</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#73-kubedeploymentgenerationmismatch","title":"7.3 KubeDeploymentGenerationMismatch","text":"<p>Deployment \u90e8\u7f72\u5931\u8d25\uff0cDeployment \u751f\u6210\u7684\u8d44\u6e90\u4e0e\u5b9a\u4e49\u7684\u8d44\u6e90\u4e0d\u5339\u914d\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>kube_deployment_status_observed_generation{job=\"kube-state-metrics\"}\n          !=\n        kube_deployment_metadata_generation{job=\"kube-state-metrics\"}\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_deployment_status_observed_generation</code>\uff1aDeployment \u751f\u6210\u8d44\u6e90\u6570</li> <li><code>kube_deployment_metadata_generation</code>\uff1aDeployment \u5b9a\u4e49\u8d44\u6e90\u6570</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#74-kubedeploymentreplicasmismatch","title":"7.4 KubeDeploymentReplicasMismatch","text":"<p>\u67e5\u770b Deplyment \u526f\u672c\u662f\u5426\u8fbe\u5230\u9884\u671f\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(\n          kube_deployment_spec_replicas{job=\"kube-state-metrics\"}\n            !=\n          kube_deployment_status_replicas_available{job=\"kube-state-metrics\"}\n        ) and (\n          changes(kube_deployment_status_replicas_updated{job=\"kube-state-metrics\"}[3m])\n            ==\n          0\n        )\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_deployment_spec_replicas</code>                     \u8d44\u6e90\u5b9a\u4e49\u526f\u672c\u6570</li> <li><code>kube_deployment_status_replicas_available</code>        \u6b63\u5728\u8fd0\u884c\u526f\u672c\u6570</li> <li><code>kube_deployment_status_replicas_updated</code>          \u66f4\u65b0\u7684\u526f\u672c\u6570</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#75-kubestatefulsetreplicasmismatch","title":"7.5 KubeStatefulSetReplicasMismatch","text":"<p>\u76d1\u6d4b StatefulSet \u526f\u672c\u662f\u5426\u8fbe\u5230\u9884\u671f\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(\n          kube_statefulset_status_replicas_ready{job=\"kube-state-metrics\"}\n            !=\n          kube_statefulset_status_replicas{job=\"kube-state-metrics\"}\n        ) and (\n          changes(kube_statefulset_status_replicas_updated{job=\"kube-state-metrics\"}[5m])\n            ==\n          0\n        )\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_statefulset_status_replicas_ready</code>\uff1a\u5c31\u7eea\u526f\u672c\u6570</li> <li><code>kube_statefulset_status_replicas</code>\uff1a\u5f53\u524d\u526f\u672c\u6570</li> <li><code>kube_statefulset_status_replicas_updated</code>\uff1a\u66f4\u65b0\u7684\u526f\u672c\u6570</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#76-kubestatefulsetupdatenotrolledout","title":"7.6 KubeStatefulSetUpdateNotRolledOut","text":"<p>StatefulSet  \u66f4\u65b0\u5931\u8d25\u4e14\u672a\u56de\u6eda\uff0c\u5bf9\u6bd4\u7248\u672c\u53f7\u548c\u526f\u672c\u6570\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>max without (revision) (\n          kube_statefulset_status_current_revision{job=\"kube-state-metrics\"}\n            unless\n          kube_statefulset_status_update_revision{job=\"kube-state-metrics\"}\n        )\n          *\n        (\n          kube_statefulset_replicas{job=\"kube-state-metrics\"}\n            !=\n          kube_statefulset_status_replicas_updated{job=\"kube-state-metrics\"}\n        )\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_statefulset_status_replicas</code>\uff1a\u6bcf\u4e2a StatefulSet \u7684\u526f\u672c\u6570\u3002</li> <li><code>kube_statefulset_status_replicas_current</code>\uff1a\u6bcf\u4e2a StatefulSet \u7684\u5f53\u524d\u526f\u672c\u6570\u3002</li> <li><code>kube_statefulset_status_replicas_ready</code>\uff1a\u6bcf\u4e2aStatefulSet \u7684\u5c31\u7eea\u526f\u672c\u6570\u3002</li> <li><code>kube_statefulset_status_replicas_updated</code>\uff1a\u6bcf\u4e2aStatefulSet \u7684\u66f4\u65b0\u526f\u672c\u6570\u3002</li> <li><code>kube_statefulset_status_observed_generation</code>\uff1aStatefulSet \u63a7\u5236\u5668\u89c2\u5bdf\u5230\u7684\u751f\u6210\u3002</li> <li><code>kube_statefulset_replicas</code>\uff1aStatefulSet \u6240\u9700\u7684\u526f\u672c\u6570\u3002</li> <li><code>kube_statefulset_metadata_generation</code>\uff1a\u8868\u793a StatefulSet \u6240\u9700\u72b6\u6001\u7684\u7279\u5b9a\u751f\u6210\u7684\u5e8f\u5217\u53f7\u3002</li> <li><code>kube_statefulset_created</code>\uff1a\u521b\u5efa\u65f6\u95f4\u6233\u3002</li> <li><code>kube_statefulset_labels</code>\uff1aKubernetes \u6807\u7b7e\u8f6c\u6362\u4e3a Prometheus \u6807\u7b7e\u3002</li> <li><code>kube_statefulset_status_current_revision</code>\uff1a\u6307\u793a\u7528\u4e8e\u6309\u987a\u5e8f(0\uff0ccurrentReplicas)\u751f\u6210 Pod \u7684StatefulSet \u7684\u7248\u672c\u3002</li> <li><code>kube_statefulset_status_update_revision</code>\uff1a\u6307\u793a\u7528\u4e8e\u6309\u987a\u5e8f [replicas-updatedReplicas\uff0creplicas] \u751f\u6210 Pod \u7684 StatefulSet \u7684\u7248\u672c\u3002</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#77-kubedaemonsetrolloutstuck","title":"7.7 KubeDaemonSetRolloutStuck","text":"<p>\u76d1\u6d4b DaemonSet \u662f\u5426\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>kube_daemonset_status_number_ready{job=\"kube-state-metrics\"}\n          /\n        kube_daemonset_status_desired_number_scheduled{job=\"kube-state-metrics\"} &lt; 1.00\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_daemonset_status_number_ready</code>\uff1a\u5c31\u7eea\u7684 DaemonSet</li> <li><code>kube_daemonset_status_desired_number_scheduled</code>\uff1a\u5e94\u8be5\u8c03\u5ea6\u7684 DaemonSet \u6570\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#78-kubedaemonsetmisscheduled","title":"7.8 KubeDaemonSetMisScheduled","text":"<p>DaemonSet  \u8fd0\u884c\u5728\u4e0d\u8be5\u8fd0\u884c\u7684\u8282\u70b9\u4e0a\u9762\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>kube_daemonset_status_number_misscheduled{job=\"kube-state-metrics\"} &gt; 0\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_daemonset_status_number_misscheduled</code>\uff1a\u8fd0\u884c\u5728\u4e0d\u8be5\u8fd0\u884c\u7684\u8282\u70b9\u72b6\u6001</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#79-kubecontainerwaiting","title":"7.9 KubeContainerWaiting","text":"<p>\u76d1\u6d4b\u54ea\u4e9b\u5bb9\u5668\u662f\u5728\u7b49\u5f85\u72b6\u6001\u7684\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum by (namespace, pod, container) (kube_pod_container_status_waiting_reason{job=\"kube-state-metrics\"}) &gt; 0\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>kube_pod_container_status_waiting_reason</code>\uff1a\u5bb9\u5668\u58f0\u660e\u5468\u671f\u8fc7\u7a0b\u4e2d\u7684\u72b6\u6001\uff0c\u65e0\u8bba\u662f\u521b\u5efa\u6210\u529f\u8fd8\u662f\u5931\u8d25\u90fd\u5e94\u8be5\u662f0\u3002</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#8","title":"8. \u8282\u70b9\u76f8\u5173","text":""},{"location":"chap8/42Prometheus_operator_metrics/#81-nodeclocknotsynchronising","title":"8.1 NodeClockNotSynchronising","text":"<p>\u4e3b\u673a\u4e0e\u65f6\u95f4\u670d\u52a1\u5668\u5931\u8054\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>min_over_time(node_timex_sync_status[5m]) == 0\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>node_timex_sync_status</code>\uff1a\u540c\u6b65\u72b6\u6001\u3002</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#82-nodeclockskewdetected","title":"8.2 NodeClockSkewDetected","text":"<p>\u672c\u5730\u65f6\u95f4\u504f\u79fb\u91cf\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(node_timex_offset_seconds &gt; 0.05\n        and\n          deriv(node_timex_offset_seconds[5m]) &gt;= 0\n        )\n        or\n        (\n          node_timex_offset_seconds &lt; -0.05\n        and\n          deriv(node_timex_offset_seconds[5m]) &lt;= 0)\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>node_timex_offset_seconds</code>\uff1a\u8bef\u5dee</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#83-nodehighnumberconntrackentriesused","title":"8.3 NodeHighNumberConntrackEntriesUsed","text":"<p>\u94fe\u63a5\u72b6\u6001\u8ddf\u8e2a\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(node_nf_conntrack_entries / node_nf_conntrack_entries_limit) &gt; 0.75\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>node_nf_conntrack_entries</code>\uff1a\u94fe\u63a5\u72b6\u6001\u8ddf\u8e2a\u8868\u5206\u914d\u7684\u6570\u91cf</li> <li><code>node_nf_conntrack_entries_limit</code>\uff1a\u8868\u603b\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#84-nodenetworkreceiveerrs","title":"8.4 NodeNetworkReceiveErrs","text":"<p>\u7f51\u5361\u63a5\u6536\u9519\u8bef\u91cf\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>increase(node_network_receive_errs_total[2m]) &gt; 10\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>node_network_receive_errs_total</code>\uff1a\u63a5\u6536\u9519\u8bef\u603b\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#85-nodenetworktransmiterrs","title":"8.5 NodeNetworkTransmitErrs","text":"<p>\u7f51\u5361\u4f20\u8f93\u9519\u8bef\u91cf\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>increase(node_network_transmit_errs_total[2m]) &gt; 10\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>node_network_transmit_errs_total</code>\uff1a\u4f20\u8f93\u9519\u8bef\u603b\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#86-nodefilesystemalmostoutoffiles","title":"8.6 NodeFilesystemAlmostOutOfFiles","text":"<p>inode \u6570\u91cf\u76d1\u6d4b</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(\n          node_filesystem_files_free{job=\"node-exporter\",fstype!=\"\"} / node_filesystem_files{job=\"node-exporter\",fstype!=\"\"} * 100 &lt; 5\n        and\n          node_filesystem_readonly{job=\"node-exporter\",fstype!=\"\"} == 0\n        )\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>node_filesystem_files_free</code>\uff1a\u7a7a\u95f2\u7684 inode</li> <li><code>node_filesystem_files</code>\uff1ainodes \u603b\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#87-nodefilesystemfilesfillingup","title":"8.7 NodeFilesystemFilesFillingUp","text":"<p>inode \u8017\u5c3d\u9884\u6d4b\uff0c\u4ee56\u5c0f\u65f6\u66f2\u7ebf\u53d8\u5316\u9884\u6d4b\u63a5\u4e0b\u676524\u5c0f\u65f6\u548c4\u5c0f\u65f6\u53ef\u80fd\u4f7f\u7528\u7684 inodes\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(node_filesystem_files_free{job=\"node-exporter\",fstype!=\"\"} / node_filesystem_files{job=\"node-exporter\",fstype!=\"\"} * 100 &lt; 20\n        and\n          predict_linear(node_filesystem_files_free{job=\"node-exporter\",fstype!=\"\"}[6h], 4*60*60) &lt; 0\n        and\n          node_filesystem_readonly{job=\"node-exporter\",fstype!=\"\"} == 0)\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>node_filesystem_files_free</code>\uff1a\u7a7a\u95f2\u7684 inode</li> <li><code>node_filesystem_files</code>\uff1ainodes \u603b\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#88-nodefilesystemalmostoutofspace","title":"8.8 NodeFilesystemAlmostOutOfSpace","text":"<p>\u5206\u533a\u5bb9\u91cf\u4f7f\u7528\u7387\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(node_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\"} / node_filesystem_size_bytes{job=\"node-exporter\",fstype!=\"\"} * 100 &lt; 10\n        and\n          node_filesystem_readonly{job=\"node-exporter\",fstype!=\"\"} == 0\n        )\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>node_filesystem_avail_bytes</code>\uff1a\u7a7a\u95f2\u5bb9\u91cf</li> <li><code>node_filesystem_size_bytes</code>\uff1a\u603b\u5bb9\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#89-nodefilesystemspacefillingup","title":"8.9 NodeFilesystemSpaceFillingUp","text":"<p>\u5206\u533a\u5bb9\u91cf\u8017\u5c3d\u9884\u6d4b\uff0c\u4ee56\u5c0f\u65f6\u66f2\u7ebf\u53d8\u5316\u9884\u6d4b\u63a5\u4e0b\u676524\u5c0f\u65f6\u548c4\u5c0f\u65f6\u53ef\u80fd\u4f7f\u7528\u7684\u5bb9\u91cf\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>(node_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\"} / node_filesystem_size_bytes{job=\"node-exporter\",fstype!=\"\"} * 100 &lt; 15\n        and\n          predict_linear(node_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\"}[6h], 4*60*60) &lt; 0\n        and\n          node_filesystem_readonly{job=\"node-exporter\",fstype!=\"\"} == 0)\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>node_filesystem_avail_bytes</code>\uff1a\u7a7a\u95f2\u5bb9\u91cf</li> <li><code>node_filesystem_size_bytes</code>\uff1a\u603b\u5bb9\u91cf</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#9-etcd","title":"9. Etcd \u76f8\u5173","text":""},{"location":"chap8/42Prometheus_operator_metrics/#91-etcdlived","title":"9.1 Etcdlived","text":"<p>etcd \u5b58\u6d3b\u68c0\u6d4b\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>up{job=\"etcd\"} &lt; 1\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#92-etcdcluseterunavailable","title":"9.2 EtcdCluseterUnavailable","text":"<p>etcd \u96c6\u7fa4\u5065\u5eb7\u68c0\u67e5\uff0cdown \u6570\u91cf\u5927\u4e8e\u96c6\u7fa4\u53ef\u5141\u8bb8\u6545\u969c\u6570\u91cf\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>count(up{job=\"etcd\"} == 0) &gt; (count(up{job=\"etcd\"}) / 2 - 1)\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#93-etcdleadercheck","title":"9.3 EtcdLeaderCheck","text":"<p>\u68c0\u67e5 leader\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>max(etcd_server_has_leader) != 1\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#94-etcdbackendfsync","title":"9.4 EtcdBackendFsync","text":"<p>etcd io \u76d1\u6d4b\uff0c\u540e\u7aef\u63d0\u4ea4 \u5ef6\u65f6\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>histogram_quantile(0.99, sum(rate(etcd_disk_backend_commit_duration_seconds_bucket[5m])) by (instance, le)) &gt; 100\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#95-etcdwalfsync","title":"9.5 EtcdWalFsync","text":"<p>etcd io \u76d1\u6d4b\uff0c\u6587\u4ef6\u540c\u6b65\u5230\u78c1\u76d8\u5ef6\u65f6\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>histogram_quantile(0.99, sum(rate(etcd_disk_wal_fsync_duration_seconds_bucket[5m])) by (instance, le)) &gt; 100\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#96-etcddbsize","title":"9.6 EtcdDbSize","text":"<p>\u68c0\u6d4b\u6570\u636e\u5e93\u5927\u5c0f\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>etcd_debugging_mvcc_db_total_size_in_bytes/1024/1024 &gt; 1024\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#97-etcdgrpc","title":"9.7 EtcdGrpc","text":"<p>Grpc \u8c03\u7528\u901f\u7387\u3002\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(rate(grpc_server_handled_total{grpc_type=\"unary\"}[1m])) &gt; 100\n</code></pre>"},{"location":"chap8/42Prometheus_operator_metrics/#10-coredns","title":"10. CoreDNS \u76f8\u5173","text":""},{"location":"chap8/42Prometheus_operator_metrics/#101-dnsrequest","title":"10.1 DnsRequest","text":"<p>DNS \u67e5\u8be2\u901f\u7387\uff0c\u6bcf\u5206\u949f\u67e5\u8be2\u8d85\u8fc7100\u544a\u8b66\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(irate(coredns_dns_request_count_total{zone !=\"dropped\"}[1m])) &gt; 100\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>coredns_dns_request_count_total</code>\uff1a\u603b\u67e5\u8be2\u6570</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#102-dnsrequestfaild","title":"10.2 DnsRequestFaild","text":"<p>\u5f02\u5e38\u67e5\u8be2\uff0c\u5f02\u5e38\u72b6\u6001\u7801\uff0c\u4e0d\u662f NOERROR\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>irate(coredns_dns_response_rcode_count_total{rcode!=\"NOERROR\"} [1m]) &gt; 0\n</code></pre> <p>\u76f8\u5173\u6307\u6807\uff1a</p> <ul> <li><code>coredns_dns_response_rcode_count_total</code>\uff1a\u67e5\u8be2\u8fd4\u56de\u72b6\u6001\u7801</li> </ul> <p>DNS-Rcode\uff1a</p> <p>DNS-Rcode \u4f5c\u4e3a DNS \u5e94\u7b54\u62a5\u6587\u4e2d\u6709\u6548\u7684\u5b57\u6bb5\uff0c\u4e3b\u8981\u7528\u6765\u8bf4\u660e DNS \u5e94\u7b54\u72b6\u6001\uff0c\u662f\u6392\u67e5\u57df\u540d\u89e3\u6790\u5931\u8d25\u7684\u91cd\u8981\u6307\u6807\u3002\u901a\u5e38\u5e38\u89c1\u7684 Rcode \u503c\u5982\u4e0b\uff1a</p> <ul> <li>Rcode \u503c\u4e3a0\uff0c\u5bf9\u5e94\u7684 DNS \u5e94\u7b54\u72b6\u6001\u4e3a NOERROR\uff0c\u610f\u601d\u662f\u6210\u529f\u7684\u54cd\u5e94\uff0c\u5373\u8fd9\u4e2a\u57df\u540d\u89e3\u6790\u662f\u6210\u529f</li> <li>Rcode \u503c\u4e3a2\uff0c\u5bf9\u5e94\u7684 DNS \u5e94\u7b54\u72b6\u6001\u4e3a SERVFAIL\uff0c\u610f\u601d\u662f\u670d\u52a1\u5668\u5931\u8d25\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e2a\u57df\u540d\u7684\u6743\u5a01\u670d\u52a1\u5668\u62d2\u7edd\u54cd\u5e94\u6216\u8005\u54cd\u5e94 REFUSE\uff0c\u9012\u5f52\u670d\u52a1\u5668\u8fd4\u56de Rcode \u503c\u4e3a 2 \u7ed9 CLIENT</li> <li>Rcode \u503c\u4e3a3\uff0c\u5bf9\u5e94\u7684 DNS \u5e94\u7b54\u72b6\u6001\u4e3a NXDOMAIN\uff0c\u610f\u601d\u662f\u4e0d\u5b58\u5728\u7684\u8bb0\u5f55\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e2a\u5177\u4f53\u7684\u57df\u540d\u5728\u6743\u5a01\u670d\u52a1\u5668\u4e2d\u5e76\u4e0d\u5b58\u5728</li> <li>Rcode \u503c\u4e3a5\uff0c\u5bf9\u5e94\u7684 DNS \u5e94\u7b54\u72b6\u6001\u4e3a REFUSE\uff0c\u610f\u601d\u662f\u62d2\u7edd\uff0c\u4e5f\u5c31\u662f\u8fd9\u4e2a\u8bf7\u6c42\u6e90IP\u4e0d\u5728\u670d\u52a1\u7684\u8303\u56f4\u5185</li> </ul>"},{"location":"chap8/42Prometheus_operator_metrics/#103-dnspanic","title":"10.3 DnsPanic","text":"<p>DNS \u6050\u614c\u503c\uff0c\u53ef\u80fd\u6536\u5230\u653b\u51fb\u3002</p> <p>\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>irate(coredns_panic_count_total[1m]) &gt; 100\n</code></pre>"},{"location":"chap8/4Promql_basic4/","title":"4 PromQL\u7b80\u5355\u793a\u4f8b","text":""},{"location":"chap8/4Promql_basic4/#1","title":"1 \u7b80\u5355\u7684\u65f6\u95f4\u5e8f\u5217\u9009\u62e9","text":"<p>\u8fd4\u56de\u5ea6\u91cf\u6307\u6807 <code>http_requests_total</code> \u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\u6837\u672c\u6570\u636e\uff1a</p> <pre><code>http_requests_total\n</code></pre> <p>\u8fd4\u56de\u5ea6\u91cf\u6307\u6807\u540d\u79f0\u4e3a <code>http_requests_total</code>\uff0c</p> <p>\u6807\u7b7e\u5206\u522b\u662f <code>job=\"apiserver\"</code>, <code>handler=\"/api/comments\"</code> \u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\u6837\u672c\u6570\u636e\uff1a</p> <pre><code>http_requests_total{}\nhttp_requests_total{job=\"apiserver\", handler=\"/api/comments\"}\n</code></pre> <p>\u8fd4\u56de\u5ea6\u91cf\u6307\u6807\u540d\u79f0\u4e3a <code>http_requests_total</code>\uff0c</p> <ul> <li>\u6807\u7b7e\u5206\u522b\u662f <code>job=\"apiserver\",</code> <code>handler=\"/api/comments\"</code></li> <li>\u4e14\u662f <code>5</code> \u5206\u949f\u5185\u7684\u6240\u6709\u65f6\u95f4\u5e8f\u5217\u6837\u672c\u6570\u636e\uff1a</li> </ul> <pre><code>http_requests_total{job=\"apiserver\", handler=\"/api/comments\"}[5m]\n</code></pre> <pre><code>http_requests_total{label=\"value\"}[time]\n</code></pre> <p>\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\u8868\u8fbe\u5f0f\u4e0d\u80fd\u76f4\u63a5\u5c55\u793a\u5728 <code>Graph</code> \u56fe\u8868\u4e2d\uff0c\u4f46\u662f\u53ef\u4ee5\u5c55\u793a\u5728 <code>Console</code> \u89c6\u56fe\u4e2d\u3002</p> <p>\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u7279\u5b9a\u6a21\u5f0f\u5339\u914d\u6807\u7b7e\u4e3a <code>job</code> \u7684\u7279\u5b9a\u4efb\u52a1\u540d\uff0c\u83b7\u53d6\u8fd9\u4e9b\u4efb\u52a1\u7684\u65f6\u95f4\u5e8f\u5217\u3002\u5728\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d, \u6240\u6709\u4efb\u52a1\u540d\u79f0\u4ee5 <code>server</code> \u7ed3\u5c3e\u3002</p> <pre><code>http_requests_total{job=~\".*server\"}\n</code></pre> <p>Prometheus\u4e2d\u7684\u6240\u6709\u6b63\u5219\u8868\u8fbe\u5f0f\u90fd\u4f7f\u7528 RE2 \u8bed\u6cd5</p> <pre><code>http_requests_total{status!~\"4..\"}\n</code></pre>"},{"location":"chap8/4Promql_basic4/#2","title":"2 \u4f7f\u7528\u51fd\u6570\uff0c\u64cd\u4f5c\u7b26\u7b49","text":"<p>\u8fd4\u56de\u5ea6\u91cf\u6307\u6807 <code>http_requests_total</code> \u8fc7\u53bb <code>5</code> \u5206\u949f\u5185\u7684 <code>http</code> \u8bf7\u6c42\u6570\u7684\u5e73\u5747\u589e\u957f\u901f\u7387\uff1a</p> <pre><code>rate(http_requests_total[5m])\n</code></pre> <p>\u8fd4\u56de\u5ea6\u91cf\u6307\u6807 <code>http_requests_total</code> \u8fc7\u53bb <code>5</code> \u5206\u949f\u5185\u7684 <code>http</code> \u8bf7\u6c42\u6570\u7684\u5e73\u5747\u589e\u957f\u901f\u7387\u603b\u548c\uff0c\u7ef4\u5ea6\u662f <code>job</code>\uff1a</p> <pre><code>sum(rate(http_requests_total[5m])) by (job)\n\u7ed3\u679c\uff1a\n{job=\"apiserver\"}  0.16666666666666666\n{job=\"kubelet\"}  0.49999876544124355\n</code></pre> <p>\u5982\u679c\u4e24\u4e2a\u6307\u6807\u5177\u6709\u76f8\u540c\u7ef4\u5ea6\u7684\u6807\u7b7e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e8c\u5143\u64cd\u4f5c\u7b26\u8ba1\u7b97\u6837\u672c\u6570\u636e\uff0c</p> <p>\u8fd4\u56de\u503c\uff1a<code>key: value=\u6807\u7b7e\u5217\u8868\uff1a\u8ba1\u7b97\u6837\u672c\u503c</code>\u3002</p> <p>\u4f8b\u5982\uff0c\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u8fd4\u56de\u6bcf\u4e00\u4e2a\u5b9e\u4f8b\u7684\u7a7a\u95f2\u5185\u5b58\uff0c\u5355\u4f4d\u662f <code>MiB</code>\u3002</p> <pre><code>(instance_memory_limit_bytes - instance_memory_usage_bytes) / 1024 / 1024\n</code></pre> <p>\u5982\u679c\u60f3\u77e5\u9053\u6bcf\u4e2a\u5e94\u7528\u7684\u5269\u4f59\u5185\u5b58\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u8868\u8fbe\u5f0f\uff1a</p> <pre><code>sum(\n  instance_memory_limit_bytes - instance_memory_usage_bytes\n) by (app, proc) / 1024 / 1024\n</code></pre> <p>\u5982\u679c\u76f8\u540c\u7684\u96c6\u7fa4\u8c03\u5ea6\u7fa4\u663e\u793a\u5982\u4e0b\u7684\u6bcf\u4e2a\u5b9e\u4f8b\u7684 <code>CPU</code> \u4f7f\u7528\u7387\uff1a</p> <pre><code>instance_cpu_time_ns{app=\"lion\", proc=\"web\", rev=\"34d0f99\", env=\"prod\", job=\"cluster-manager\"}\ninstance_cpu_time_ns{app=\"elephant\", proc=\"worker\", rev=\"34d0f99\", env=\"prod\", job=\"cluster-manager\"}\ninstance_cpu_time_ns{app=\"turtle\", proc=\"api\", rev=\"4d3a513\", env=\"prod\", job=\"cluster-manager\"}\ninstance_cpu_time_ns{app=\"fox\", proc=\"widget\", rev=\"4d3a513\", env=\"prod\", job=\"cluster-manager\"}\n...\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u6309\u7167\u5e94\u7528\u548c\u8fdb\u7a0b\u7c7b\u578b\u6765\u83b7\u53d6 <code>CPU</code> \u5229\u7528\u7387\u6700\u9ad8\u7684 <code>3</code> \u4e2a\u6837\u672c\u6570\u636e\uff1a</p> <pre><code>topk(3, sum(rate(instance_cpu_time_ns[5m])) by (app, proc))\n</code></pre> <p>\u5047\u8bbe\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\u53ea\u6709\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u8868\u8fbe\u5f0f\u7edf\u8ba1\u51fa\u6bcf\u4e2a\u5e94\u7528\u7684\u5b9e\u4f8b\u6570\u91cf\uff1a</p> <pre><code>count(instance_cpu_time_ns) by (app)\n</code></pre>"},{"location":"chap8/56prometheus_promql_rate/","title":"7 PromQL\u67e5\u8be2\u4e4brate\u51fd\u6570\u7684\u4f7f\u7528","text":"<p>\u901a\u5e38\u6765\u8bf4\u76f4\u63a5\u7ed8\u5236\u4e00\u4e2a\u539f\u59cb\u7684 <code>Counter</code> \u7c7b\u578b\u7684\u6307\u6807\u6570\u636e\u7528\u5904\u4e0d\u5927\uff0c\u56e0\u4e3a\u5b83\u4eec\u4f1a\u4e00\u76f4\u589e\u52a0\uff0c\u4e00\u822c\u6765\u8bf4\u662f\u4e0d\u4f1a\u53bb\u76f4\u63a5\u5173\u5fc3\u8fd9\u4e2a\u6570\u503c\u7684\uff0c\u56e0\u4e3a <code>Counter</code> \u4e00\u65e6\u91cd\u7f6e\uff0c\u603b\u8ba1\u6570\u5c31\u6ca1\u6709\u610f\u4e49\u4e86\uff0c\u6bd4\u5982\u6211\u4eec\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>demo_api_request_duration_seconds_count{job=\"demo\"}\n</code></pre> <p>\u53ef\u4ee5\u5f97\u5230\u4e0b\u56fe\u6240\u793a\u7684\u56fe\u5f62\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u6240\u6709\u7684\u90fd\u662f\u4e0d\u65ad\u589e\u957f\u7684\uff0c\u4e00\u822c\u6765\u8bf4\u6211\u4eec\u66f4\u60f3\u8981\u77e5\u9053\u7684\u662f Counter \u6307\u6807\u7684\u53d8\u5316\u7387\uff0cPromQL \u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u51fd\u6570\u6765\u8ba1\u7b97\u53d8\u5316\u7387\u3002</p>"},{"location":"chap8/56prometheus_promql_rate/#rate","title":"rate","text":"<p>\u7528\u4e8e\u8ba1\u7b97\u53d8\u5316\u7387\u7684\u6700\u5e38\u89c1\u51fd\u6570\u662f <code>rate()</code>\uff0c<code>rate()</code> \u51fd\u6570\u7528\u4e8e\u8ba1\u7b97\u5728\u6307\u5b9a\u65f6\u95f4\u8303\u56f4\u5185\u8ba1\u6570\u5668\u6bcf\u79d2\u589e\u52a0\u91cf\u7684\u5e73\u5747\u503c\u3002</p> <p>\u56e0\u4e3a\u662f\u8ba1\u7b97\u4e00\u4e2a\u65f6\u95f4\u8303\u56f4\u5185\u7684\u5e73\u5747\u503c\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5728\u5e8f\u5217\u9009\u62e9\u5668\u4e4b\u540e\u6dfb\u52a0\u4e00\u4e2a\u8303\u56f4\u9009\u62e9\u5668\u3002</p> <p>\u4f8b\u5982\u6211\u4eec\u8981\u8ba1\u7b97 <code>demo_api_request_duration_seconds_count</code> \u5728\u6700\u8fd1\u4e94\u5206\u949f\u5185\u7684\u6bcf\u79d2\u5e73\u5747\u53d8\u5316\u7387\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>rate(demo_api_request_duration_seconds_count[5m])\n</code></pre> <p>\u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u56fe\u5f62\uff1a</p> <p></p> <p>\u73b0\u5728\u7ed8\u5236\u7684\u56fe\u5f62\u770b\u8d77\u6765\u663e\u7136\u66f4\u52a0\u6709\u610f\u4e49\u4e86\uff0c\u8fdb\u884c <code>rate</code> \u8ba1\u7b97\u7684\u65f6\u5019\u662f\u9009\u62e9\u6307\u5b9a\u65f6\u95f4\u8303\u56f4\u4e0b\u7684\u7b2c\u4e00\u548c\u6700\u540e\u4e00\u4e2a\u6837\u672c\u8fdb\u884c\u8ba1\u7b97\uff0c\u4e0b\u56fe\u662f\u8868\u793a\u77ac\u65f6\u8ba1\u7b97\u7684\u8ba1\u7b97\u65b9\u5f0f\uff1a</p> <p>\u73b0\u5728\u7ed8\u5236\u7684\u56fe\u5f62\u770b\u8d77\u6765\u663e\u7136\u66f4\u52a0\u6709\u610f\u4e49\u4e86\uff0c\u8fdb\u884c rate \u8ba1\u7b97\u7684\u65f6\u5019\u662f\u9009\u62e9\u6307\u5b9a\u65f6\u95f4\u8303\u56f4\u4e0b\u7684\u7b2c\u4e00\u548c\u6700\u540e\u4e00\u4e2a\u6837\u672c\u8fdb\u884c\u8ba1\u7b97\uff0c\u4e0b\u56fe\u662f\u8868\u793a\u77ac\u65f6\u8ba1\u7b97\u7684\u8ba1\u7b97\u65b9\u5f0f\uff1a</p> <p></p> <p>\u5f80\u5f80\u6211\u4eec\u9700\u8981\u7684\u662f\u7ed8\u5236\u4e00\u4e2a\u56fe\u5f62\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u8fdb\u884c\u533a\u95f4\u67e5\u8be2\uff0c\u6307\u5b9a\u4e00\u4e2a\u65f6\u95f4\u8303\u56f4\u5185\u8fdb\u884c\u591a\u6b21\u8ba1\u7b97\uff0c\u5c06\u7ed3\u679c\u4e32\u8054\u8d77\u6765\u5f62\u6210\u4e00\u4e2a\u56fe\u5f62\uff1a</p> <p></p> <p>\u5bf9\u4e8e <code>rate()</code> \u548c\u76f8\u5173\u51fd\u6570\u6709\u51e0\u4e2a\u9700\u8981\u8bf4\u660e\u7684\uff1a</p> <ul> <li>\u5f53\u88ab\u6293\u53d6\u6307\u6807\u8fdb\u7684\u7a0b\u91cd\u542f\u65f6\uff0cCounter \u6307\u6807\u53ef\u80fd\u4f1a\u91cd\u7f6e\u4e3a 0\uff0c\u4f46 rate() \u51fd\u6570\u4f1a\u81ea\u52a8\u5904\u7406\u8fd9\u4e2a\u95ee\u9898\uff0c\u5b83\u4f1a\u5047\u8bbe Counter \u6307\u6807\u7684\u503c\u53ea\u8981\u662f\u51cf\u5c11\u4e86\u5c31\u8ba4\u4e3a\u662f\u88ab\u91cd\u7f6e\u4e86\uff0c\u7136\u540e\u5b83\u53ef\u4ee5\u8c03\u6574\u540e\u7eed\u7684\u6837\u672c\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u65f6\u95f4\u5e8f\u5217\u7684\u503c\u4e3a<code>[5,10,4,6]</code>\uff0c\u5219\u5c06\u5176\u89c6\u4e3a<code>[5,10,14,16]</code>\u3002</li> <li>\u53d8\u5316\u7387\u662f\u4ece\u6307\u5b9a\u7684\u65f6\u95f4\u8303\u56f4\u4e0b\u5305\u542b\u7684\u6837\u672c\u8fdb\u884c\u8ba1\u7b97\u7684\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u4e2a\u65f6\u95f4\u7a97\u53e3\u7684\u8fb9\u754c\u5e76\u4e0d\u4e00\u5b9a\u5c31\u662f\u4e00\u4e2a\u6837\u672c\u6570\u636e\uff0c\u53ef\u80fd\u4f1a\u4e0d\u5b8c\u5168\u5bf9\u9f50\uff0c\u6240\u4ee5\uff0c\u5373\u4f7f\u5bf9\u4e8e\u6bcf\u6b21\u90fd\u662f\u589e\u52a0\u6574\u6570\u7684 Counter\uff0c\u4e5f\u53ef\u80fd\u8ba1\u7b97\u7ed3\u679c\u662f\u975e\u6574\u6570\u3002</li> </ul> <p></p> <p>\u53e6\u5916\u6211\u4eec\u9700\u8981\u6ce8\u610f\u5f53\u628a <code>rate()</code> \u4e0e\u4e00\u4e2a\u805a\u5408\u8fd0\u7b97\u7b26\uff08\u4f8b\u5982 <code>sum()</code>\uff09\u6216\u4e00\u4e2a\u968f\u65f6\u95f4\u805a\u5408\u7684\u51fd\u6570\uff08\u4efb\u4f55\u4ee5 <code>_over_time</code> \u7ed3\u5c3e\u7684\u51fd\u6570\uff09\u7ed3\u5408\u8d77\u6765\u4f7f\u7528\u65f6\uff0c\u603b\u662f\u5148\u53d6\u7528 <code>rate()</code> \u51fd\u6570\uff0c\u7136\u540e\u518d\u8fdb\u884c\u805a\u5408\uff0c\u5426\u5219\uff0c\u5f53\u4f60\u7684\u76ee\u6807\u91cd\u65b0\u542f\u52a8\u65f6\uff0c<code>rate()</code> \u51fd\u6570\u65e0\u6cd5\u68c0\u6d4b\u5230 <code>Counter</code> \u7684\u91cd\u7f6e\u3002</p> <p>\u6ce8\u610f\uff1a<code>rate()</code> \u51fd\u6570\u9700\u8981\u5728\u6307\u5b9a\u7a97\u53e3\u4e0b\u81f3\u5c11\u6709\u4e24\u4e2a\u6837\u672c\u624d\u80fd\u8ba1\u7b97\u8f93\u51fa\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u6bd4\u8f83\u597d\u7684\u505a\u6cd5\u662f\u9009\u62e9\u8303\u56f4\u7a97\u53e3\u5927\u5c0f\u81f3\u5c11\u662f\u6293\u53d6\u95f4\u9694\u76844\u500d\uff0c\u8fd9\u6837\u5373\u4f7f\u5728\u9047\u5230\u7a97\u53e3\u5bf9\u9f50\u6216\u6293\u53d6\u6545\u969c\u65f6\u4e5f\u6709\u53ef\u4ee5\u4f7f\u7528\u7684\u6837\u672c\u8fdb\u884c\u8ba1\u7b97\uff0c\u4f8b\u5982\uff0c\u5bf9\u4e8e 1 \u5206\u949f\u7684\u6293\u53d6\u95f4\u9694\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 4 \u5206\u949f\u7684 Rate \u8ba1\u7b97\uff0c\u4f46\u662f\u901a\u5e38\u5c06\u5176\u56db\u820d\u4e94\u5165\u4e3a 5 \u5206\u949f\u3002\u6240\u4ee5\u5982\u679c\u4f7f\u7528 query_range \u533a\u95f4\u67e5\u8be2\uff0c\u4f8b\u5982\u5728\u7ed8\u56fe\u4e2d\uff0c\u90a3\u4e48\u8303\u56f4\u5e94\u8be5\u81f3\u5c11\u662f\u6b65\u957f\u7684\u5927\u5c0f\uff0c\u5426\u5219\u4f1a\u4e22\u5931\u4e00\u4e9b\u6570\u636e\u3002</p>"},{"location":"chap8/56prometheus_promql_rate/#irate","title":"irate","text":"<p>\u7531\u4e8e\u4f7f\u7528 rate \u6216\u8005 increase \u51fd\u6570\u53bb\u8ba1\u7b97\u6837\u672c\u7684\u5e73\u5747\u589e\u957f\u901f\u7387\uff0c\u5bb9\u6613\u9677\u5165\u957f\u5c3e\u95ee\u9898\u5f53\u4e2d\uff0c\u5176\u65e0\u6cd5\u53cd\u5e94\u5728\u65f6\u95f4\u7a97\u53e3\u5185\u6837\u672c\u6570\u636e\u7684\u7a81\u53d1\u53d8\u5316\u3002</p> <p>\u4f8b\u5982\uff0c\u5bf9\u4e8e\u4e3b\u673a\u800c\u8a00\u5728 2 \u5206\u949f\u7684\u65f6\u95f4\u7a97\u53e3\u5185\uff0c\u53ef\u80fd\u5728\u67d0\u4e00\u4e2a\u7531\u4e8e\u8bbf\u95ee\u91cf\u6216\u8005\u5176\u5b83\u95ee\u9898\u5bfc\u81f4 CPU \u5360\u7528 100%\u7684\u60c5\u51b5\uff0c\u4f46\u662f\u901a\u8fc7\u8ba1\u7b97\u5728\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u5e73\u5747\u589e\u957f\u7387\u5374\u65e0\u6cd5\u53cd\u5e94\u51fa\u8be5\u95ee\u9898\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8be5\u95ee\u9898\uff0cPromQL \u63d0\u4f9b\u4e86\u53e6\u5916\u4e00\u4e2a\u7075\u654f\u5ea6\u66f4\u9ad8\u7684\u51fd\u6570<code>irate(v range-vector)</code>\u3002irate \u540c\u6837\u7528\u4e8e\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u7684\u8ba1\u7b97\u7387\uff0c\u4f46\u662f\u5176\u53cd\u5e94\u51fa\u7684\u662f\u77ac\u65f6\u589e\u957f\u7387\u3002</p> <p>irate \u51fd\u6570\u662f\u901a\u8fc7\u533a\u95f4\u5411\u91cf\u4e2d\u6700\u540e\u4e24\u4e2a\u6837\u672c\u6570\u636e\u6765\u8ba1\u7b97\u533a\u95f4\u5411\u91cf\u7684\u589e\u957f\u901f\u7387\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u907f\u514d\u5728\u65f6\u95f4\u7a97\u53e3\u8303\u56f4\u5185\u7684\u957f\u5c3e\u95ee\u9898\uff0c\u5e76\u4e14\u4f53\u73b0\u51fa\u66f4\u597d\u7684\u7075\u654f\u5ea6\uff0c\u901a\u8fc7 irate \u51fd\u6570\u7ed8\u5236\u7684\u56fe\u6807\u80fd\u591f\u66f4\u597d\u7684\u53cd\u5e94\u6837\u672c\u6570\u636e\u7684\u77ac\u65f6\u53d8\u5316\u72b6\u6001\u3002\u90a3\u65e2\u7136\u662f\u4f7f\u7528\u6700\u540e\u4e24\u4e2a\u70b9\u8ba1\u7b97\uff0c\u90a3\u4e3a\u4ec0\u4e48\u8fd8\u8981\u6307\u5b9a\u7c7b\u4f3c\u4e8e [1m] \u7684\u65f6\u95f4\u8303\u56f4\u5462\uff1f\u8fd9\u4e2a [1m] \u4e0d\u662f\u7528\u6765\u8ba1\u7b97\u7684\uff0cirate \u5728\u8ba1\u7b97\u7684\u65f6\u5019\u4f1a\u6700\u591a\u5411\u524d\u5728 [1m] \u8303\u56f4\u5185\u627e\u70b9\uff0c\u5982\u679c\u8d85\u8fc7 [1m] \u6ca1\u6709\u627e\u5230\u6570\u636e\u70b9\uff0c\u8fd9\u4e2a\u70b9\u7684\u8ba1\u7b97\u5c31\u653e\u5f03\u4e86\u3002</p> <p></p> <p>\u7531\u4e8e <code>rate()</code> \u63d0\u4f9b\u4e86\u66f4\u5e73\u6ed1\u7684\u7ed3\u679c\uff0c\u56e0\u6b64\u5728\u957f\u671f\u8d8b\u52bf\u5206\u6790\u6216\u8005\u544a\u8b66\u4e2d\u66f4\u63a8\u8350\u4f7f\u7528 rate \u51fd\u6570\uff0c\u56e0\u4e3a\u5f53\u901f\u7387\u53ea\u51fa\u73b0\u4e00\u4e2a\u77ed\u6682\u7684\u5cf0\u503c\u65f6\uff0c\u4e0d\u5e94\u8be5\u89e6\u53d1\u8be5\u62a5\u8b66\u3002</p> <p>\u4f7f\u7528 <code>irate()</code> \u51fd\u6570\u4e0a\u9762\u7684\u8868\u8fbe\u5f0f\u4f1a\u51fa\u73b0\u4e00\u4e9b\u77ed\u6682\u4e0b\u964d\u7684\u56fe\u5f62\uff1a</p> <p></p> <p>\u9664\u4e86\u8ba1\u7b97\u6bcf\u79d2\u901f\u7387\uff0c\u4f60\u8fd8\u53ef\u4ee5\u4f7f\u7528 <code>increase()</code> \u51fd\u6570\u67e5\u8be2\u6307\u5b9a\u65f6\u95f4\u8303\u56f4\u5185\u7684\u603b\u589e\u91cf\uff0c\u5b83\u57fa\u672c\u4e0a\u76f8\u5f53\u4e8e\u901f\u7387\u4e58\u4ee5\u65f6\u95f4\u8303\u56f4\u9009\u62e9\u5668\u4e2d\u7684\u79d2\u6570\uff1a</p> <pre><code>increase(demo_api_request_duration_seconds_count{job=\"demo\"}[1h])\n</code></pre> <p>\u6bd4\u5982\u4e0a\u9762\u8868\u8fbe\u5f0f\u7684\u7ed3\u679c\u548c\u4f7f\u7528 <code>rate()</code> \u51fd\u6570\u8ba1\u7b97\u7684\u7ed3\u679c\u6574\u4f53\u56fe\u5f62\u8d8b\u52bf\u90fd\u662f\u4e00\u6837\u7684\uff0c\u53ea\u662f Y \u8f74\u7684\u6570\u636e\u4e0d\u4e00\u6837\u800c\u5df2\uff0c\u4e00\u4e2a\u8868\u793a\u6570\u91cf\uff0c\u4e00\u4e2a\u8868\u793a\u767e\u5206\u6bd4\u3002</p> <p><code>rate()</code>\u3001<code>irate()</code> \u548c <code>increase()</code> \u51fd\u6570\u53ea\u80fd\u8f93\u51fa\u975e\u8d1f\u503c\u7684\u7ed3\u679c\uff0c\u5bf9\u4e8e\u8ddf\u8e2a\u4e00\u4e2a\u53ef\u4ee5\u4e0a\u5347\u6216\u4e0b\u964d\u7684\u503c\u7684\u6307\u6807\uff08\u5982\u6e29\u5ea6\u3001\u5185\u5b58\u6216\u78c1\u76d8\u7a7a\u95f4\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>delta()</code> \u548c <code>deriv()</code> \u51fd\u6570\u6765\u4ee3\u66ff\u3002</p> <ul> <li><code>deriv()</code> \u51fd\u6570\u53ef\u4ee5\u8ba1\u7b97\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\u4e2d\u5404\u4e2a\u65f6\u95f4\u5e8f\u5217\u4e8c\u9636\u5bfc\u6570\uff0c</li> <li>\u4f7f\u7528\u7b80\u5355\u7ebf\u6027\u56de\u5f52\uff0c<code>deriv(v range-vector)</code>\u7684\u53c2\u6570\u662f\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\uff0c\u8fd4\u56de\u4e00\u4e2a\u77ac\u65f6\u5411\u91cf\uff0c\u8fd9\u4e2a\u51fd\u6570\u4e00\u822c\u53ea\u7528\u5728 Gauge \u7c7b\u578b\u7684\u65f6\u95f4\u5e8f\u5217\u4e0a\u3002</li> </ul> <p>\u4f8b\u5982\uff0c\u8981\u8ba1\u7b97\u5728 15 \u5206\u949f\u7684\u7a97\u53e3\u4e0b\uff0c\u6bcf\u79d2\u949f\u78c1\u76d8\u4f7f\u7528\u91cf\u4e0a\u5347\u6216\u4e0b\u964d\u4e86\u591a\u5c11\uff1a</p> <p></p> <p>\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a <code>predict_linear()</code> \u51fd\u6570\u53ef\u4ee5\u9884\u6d4b\u4e00\u4e2a <code>Gauge</code> \u7c7b\u578b\u7684\u6307\u6807\u5728\u672a\u6765\u6307\u5b9a\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u503c\uff0c\u4f8b\u5982\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u8fc7\u53bb <code>15</code> \u5206\u949f\u7684\u53d8\u5316\u60c5\u51b5\uff0c\u6765\u9884\u6d4b\u4e00\u4e2a\u5c0f\u65f6\u540e\u7684\u78c1\u76d8\u4f7f\u7528\u91cf\u662f\u591a\u5c11\uff0c\u53ef\u4ee5\u7528\u5982\u4e0b\u6240\u793a\u7684\u8868\u8fbe\u5f0f\u6765\u67e5\u8be2\uff1a</p> <pre><code>predict_linear(demo_disk_usage_bytes{job=\"demo\"}[15m], 3600)\n</code></pre> <p></p> <p>\u8fd9\u4e2a\u51fd\u6570\u53ef\u4ee5\u7528\u4e8e\u62a5\u8b66\uff0c\u544a\u8bc9\u6211\u4eec\u78c1\u76d8\u662f\u5426\u4f1a\u5728\u51e0\u4e2a\u5c0f\u65f6\u5019\u5185\u7528\u5b8c\u3002</p>"},{"location":"chap8/5Promql_basic5/","title":"5 \u5728 HTTP API\u4e2d\u4f7f\u7528 PromQL","text":"<p><code>Prometheus</code> \u5f53\u524d\u7a33\u5b9a\u7684 <code>HTTP API</code> \u53ef\u4ee5\u901a\u8fc7 <code>/api/v1</code> \u8bbf\u95ee\u3002</p>"},{"location":"chap8/5Promql_basic5/#1-api","title":"1 API \u54cd\u5e94\u683c\u5f0f","text":"<p><code>Prometheus API</code> \u4f7f\u7528\u4e86 <code>JSON</code> \u683c\u5f0f\u7684\u54cd\u5e94\u5185\u5bb9\u3002 \u5f53 <code>API</code> \u8c03\u7528\u6210\u529f\u540e\u5c06\u4f1a\u8fd4\u56de <code>2xx</code> \u7684<code>HTTP</code> \u72b6\u6001\u7801\u3002</p> <p>\u53cd\u4e4b\uff0c\u5f53 API \u8c03\u7528\u5931\u8d25\u65f6\u53ef\u80fd\u8fd4\u56de\u4ee5\u4e0b\u51e0\u79cd\u4e0d\u540c\u7684 HTTP \u72b6\u6001\u7801\uff1a</p> <ul> <li><code>404 Bad Request</code> \uff1a\u5f53\u53c2\u6570\u9519\u8bef\u6216\u8005\u7f3a\u5931\u65f6\u3002</li> <li><code>422 Unprocessable Entity</code> : \u5f53\u8868\u8fbe\u5f0f\u65e0\u6cd5\u6267\u884c\u65f6\u3002</li> <li><code>503 Service Unavailable</code> : \u5f53\u8bf7\u6c42\u8d85\u65f6\u6216\u8005\u88ab\u4e2d\u65ad\u65f6\u3002</li> </ul> <p>\u6240\u6709\u7684 API \u8bf7\u6c42\u8fd4\u56de\u7684\u683c\u5f0f\u5747\u4f7f\u7528\u4ee5\u4e0b\u7684 JSON \u683c\u5f0f\uff1a</p> <pre><code>{\n  \"status\": \"success\" | \"error\",\n  \"data\": &lt;data&gt;,\n\n  // Only set if status is \"error\". The data field may still hold\n  // additional data.\n  \"errorType\": \"&lt;string&gt;\",\n  \"error\": \"&lt;string&gt;\"\n}\n</code></pre> <ul> <li>\u67e5\u8be2\u53c2\u6570\u540d\u79f0\u53ef\u4ee5\u7528\u4e2d\u62ec\u53f7 <code>[]</code> \u91cd\u590d\u6b21\u6570\u3002</li> <li><code>&lt;series_selector&gt;</code>\u5360\u4f4d\u7b26\u63d0\u4f9b\u50cf <code>http_requests_total</code> \u6216\u8005 <code>http_requests_total{method=~\"(GET|POST)\"}</code> \u7684 <code>Prometheus</code> \u65f6\u95f4\u5e8f\u5217\u9009\u62e9\u5668\uff0c\u5e76\u9700\u8981\u5728 <code>URL</code> \u4e2d\u7f16\u7801\u4f20\u8f93\u3002</li> <li><code>&lt;duration&gt;</code> \u5360\u4f4d\u7b26\u6307\u7684\u662f <code>[0-9]+[smhdwy]</code> \u5f62\u5f0f\u7684 <code>Prometheus</code> \u6301\u7eed\u65f6\u95f4\u5b57\u7b26\u4e32\u3002\u4f8b\u5982\uff1a<code>5m</code> \u8868\u793a <code>5</code> \u5206\u949f\u7684\u6301\u7eed\u65f6\u95f4\u3002</li> <li><code>&lt;bool&gt;</code> \u63d0\u4f9b\u5e03\u5c14\u503c\uff08\u5b57\u7b26\u4e32 <code>true</code> \u548c <code>false</code>\uff09\u3002</li> </ul>"},{"location":"chap8/5Promql_basic5/#2","title":"2 \u8868\u8fbe\u5f0f\u67e5\u8be2","text":"<p>\u901a\u8fc7 <code>HTTP API</code> \u6211\u4eec\u53ef\u4ee5\u5206\u522b\u901a\u8fc7 <code>/api/v1/query</code> \u548c <code>/api/v1/query_range</code>\u67e5\u8be2 <code>PromQL</code> \u8868\u8fbe\u5f0f\u5f53\u524d\u6216\u8005\u4e00\u5b9a\u65f6\u95f4\u8303\u56f4\u5185\u7684\u8ba1\u7b97\u7ed3\u679c\u3002</p>"},{"location":"chap8/5Promql_basic5/#2-1","title":"2-1 \u77ac\u65f6\u6570\u636e\u67e5\u8be2","text":"<p>\u901a\u8fc7\u4f7f\u7528 <code>QUERY API</code> \u6211\u4eec\u53ef\u4ee5\u67e5\u8be2 <code>PromQL</code> \u5728\u7279\u5b9a\u65f6\u95f4\u70b9\u4e0b\u7684\u8ba1\u7b97\u7ed3\u679c\u3002</p> <pre><code>GET /api/v1/query\n</code></pre> <p>URL \u8bf7\u6c42\u53c2\u6570</p> <ul> <li><code>query=&lt;string&gt;</code> : PromQL \u8868\u8fbe\u5f0f\u3002</li> <li><code>time=&lt;rfc3339 | unix_timestamp&gt;</code>: \u7528\u4e8e\u6307\u5b9a\u7528\u4e8e\u8ba1\u7b97 <code>PromQL</code> \u7684\u65f6\u95f4\u6233\u3002\u53ef\u9009\u53c2\u6570\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528\u5f53\u524d\u7cfb\u7edf\u65f6\u95f4\u3002</li> <li><code>timeout=&lt;duration&gt;</code> : \u8d85\u65f6\u8bbe\u7f6e\u3002\u53ef\u9009\u53c2\u6570\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528\u5168\u5c40\u8bbe\u7f6e\u7684\u53c2\u6570 <code>-query.timeout</code>\u3002</li> </ul> <p>\u5982\u679c <code>time</code> \u53c2\u6570\u7f3a\u7701\uff0c\u5219\u4f7f\u7528\u5f53\u524d\u670d\u52a1\u5668\u65f6\u95f4\u3002</p> <p>\u5f53 <code>API</code> \u8c03\u7528\u6210\u529f\u540e\uff0c<code>Prometheus</code> \u4f1a\u8fd4\u56de <code>JSON</code> \u683c\u5f0f\u7684\u54cd\u5e94\u5185\u5bb9\uff0c\u683c\u5f0f\u5982\u4e0a\u5c0f\u8282\u6240\u793a\u3002\u5e76\u4e14\u5728 <code>data</code> \u90e8\u5206\u8fd4\u56de\u67e5\u8be2\u7ed3\u679c\u3002<code>data</code> \u90e8\u5206\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>{\n  \"resultType\": \"matrix\" | \"vector\" | \"scalar\" | \"string\",\n  \"result\": &lt;value&gt;\n}\n</code></pre> <p><code>&lt;value&gt;</code> \u6307\u7684\u662f\u67e5\u8be2\u7ed3\u679c\u6570\u636e\uff0c\u5177\u4f53\u7684\u683c\u5f0f\u53d6\u51b3\u4e8e resultType\uff0c\u4e0d\u540c\u7684\u7ed3\u679c\u7c7b\u578b\uff0c\u4f1a\u6709\u4e0d\u540c\u7684\u7ed3\u679c\u6570\u636e\u683c\u5f0f\u3002</p> <p>\u4f8b\u5982\u4f7f\u7528\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u67e5\u8be2\u8868\u8fbe\u5f0f <code>up</code> \u5728\u65f6\u95f4\u70b9 <code>2015-07-01T20:10:51.781Z</code> \u7684\u8ba1\u7b97\u7ed3\u679c\uff1a</p> <pre><code>$ curl 'http://localhost:9090/api/v1/query?query=up&amp;time=2015-07-01T20:10:51.781Z'\n{\n   \"status\" : \"success\",\n   \"data\" : {\n      \"resultType\" : \"vector\",\n      \"result\" : [\n         {\n            \"metric\" : {\n               \"__name__\" : \"up\",\n               \"job\" : \"prometheus\",\n               \"instance\" : \"localhost:9090\"\n            },\n            \"value\": [ 1435781451.781, \"1\" ]\n         },\n         {\n            \"metric\" : {\n               \"__name__\" : \"up\",\n               \"job\" : \"node\",\n               \"instance\" : \"localhost:9100\"\n            },\n            \"value\" : [ 1435781451.781, \"0\" ]\n         }\n      ]\n   }\n}\n</code></pre>"},{"location":"chap8/5Promql_basic5/#3","title":"3 \u533a\u95f4\u6570\u636e\u67e5\u8be2","text":"<p>\u4f7f\u7528 <code>QUERY_RANGE API</code> \u6211\u4eec\u5219\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2 <code>PromQL</code> \u8868\u8fbe\u5f0f\u5728\u4e00\u6bb5\u65f6\u95f4\u8fd4\u56de\u5185\u7684\u8ba1\u7b97\u7ed3\u679c\u3002</p> <pre><code>GET /api/v1/query_range\n</code></pre> <p>URL \u8bf7\u6c42\u53c2\u6570\uff1a</p> <ul> <li><code>query=&lt;string&gt;</code> : PromQL \u8868\u8fbe\u5f0f\u3002</li> <li><code>start=&lt;rfc3339 | unix_timestamp&gt;</code> : \u8d77\u59cb\u65f6\u95f4\u6233\u3002</li> <li><code>end=&lt;rfc3339 | unix_timestamp&gt;</code>: \u7ed3\u675f\u65f6\u95f4\u6233\u3002</li> <li><code>step=&lt;duration | float&gt;</code>: \u67e5\u8be2\u65f6\u95f4\u6b65\u957f\uff0c\u65f6\u95f4\u533a\u95f4\u5185\u6bcf step \u79d2\u6267\u884c\u4e00\u6b21\u3002</li> <li><code>timeout=&lt;duration&gt;</code>: \u8d85\u65f6\u8bbe\u7f6e\u3002\u53ef\u9009\u53c2\u6570\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528\u5168\u5c40\u8bbe\u7f6e\u7684\u53c2\u6570 <code>-query.timeout</code>\u3002</li> </ul> <p>\u5f53\u4f7f\u7528 <code>QUERY_RANGE API</code> \u67e5\u8be2 <code>PromQL</code> \u8868\u8fbe\u5f0f\u65f6\uff0c\u8fd4\u56de\u7ed3\u679c\u4e00\u5b9a\u662f\u4e00\u4e2a\u533a\u95f4\u5411\u91cf\uff1a</p> <pre><code>{\n  \"resultType\": \"matrix\",\n  \"result\": &lt;value&gt;\n}\n</code></pre> <p>\u5728 <code>QUERY_RANGE API</code> \u4e2d PromQL \u53ea\u80fd\u4f7f\u7528\u77ac\u65f6\u5411\u91cf\u9009\u62e9\u5668\u7c7b\u578b\u7684\u8868\u8fbe\u5f0f\u3002</p> <p>\u4f8b\u5982\u4f7f\u7528\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u67e5\u8be2\u8868\u8fbe\u5f0f <code>up</code> \u5728 <code>30</code> \u79d2\u8303\u56f4\u5185\u4ee5 <code>15</code> \u79d2\u4e3a\u95f4\u9694\u8ba1\u7b97 PromQL \u8868\u8fbe\u5f0f\u7684\u7ed3\u679c\u3002</p> <pre><code>$ curl 'http://localhost:9090/api/v1/query_range?query=up&amp;start=2015-07-01T20:10:30.781Z&amp;end=2015-07-01T20:11:00.781Z&amp;step=15s'\n{\n   \"status\" : \"success\",\n   \"data\" : {\n      \"resultType\" : \"matrix\",\n      \"result\" : [\n         {\n            \"metric\" : {\n               \"__name__\" : \"up\",\n               \"job\" : \"prometheus\",\n               \"instance\" : \"localhost:9090\"\n            },\n            \"values\" : [\n               [ 1435781430.781, \"1\" ],\n               [ 1435781445.781, \"1\" ],\n               [ 1435781460.781, \"1\" ]\n            ]\n         },\n         {\n            \"metric\" : {\n               \"__name__\" : \"up\",\n               \"job\" : \"node\",\n               \"instance\" : \"localhost:9091\"\n            },\n            \"values\" : [\n               [ 1435781430.781, \"0\" ],\n               [ 1435781445.781, \"0\" ],\n               [ 1435781460.781, \"1\" ]\n            ]\n         }\n      ]\n   }\n}\n</code></pre>"},{"location":"chap8/5Promql_basic5/#3_1","title":"3 \u67e5\u8be2\u5143\u6570\u636e","text":""},{"location":"chap8/5Promql_basic5/#3-1","title":"3-1 \u901a\u8fc7\u6807\u7b7e\u9009\u62e9\u5668\u67e5\u627e\u65f6\u95f4\u5e8f\u5217","text":"<p>\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u8fd4\u56de\u4e0e\u7279\u5b9a\u6807\u7b7e\u96c6\u5339\u914d\u7684\u65f6\u95f4\u5e8f\u5217\u5217\u8868\uff1a</p> <pre><code>GET /api/v1/series\n</code></pre> <p>URL \u8bf7\u6c42\u53c2\u6570\uff1a</p> <ul> <li><code>match[]=&lt;series_selector&gt;</code>: \u8868\u793a\u6807\u7b7e\u9009\u62e9\u5668\u662f series_selector\u3002\u5fc5\u987b\u81f3\u5c11\u63d0\u4f9b\u4e00\u4e2a match[] \u53c2\u6570\u3002</li> <li><code>start=&lt;rfc3339 | unix_timestamp&gt;</code> : \u8d77\u59cb\u65f6\u95f4\u6233\u3002</li> <li><code>end=&lt;rfc3339 | unix_timestamp&gt;</code> : \u7ed3\u675f\u65f6\u95f4\u6233\u3002</li> </ul> <p>\u8fd4\u56de\u7ed3\u679c\u7684 <code>data</code> \u90e8\u5206\uff0c\u662f\u7531 <code>key-value</code> \u952e\u503c\u5bf9\u7684\u5bf9\u8c61\u5217\u8868\u7ec4\u6210\u7684\u3002</p> <p>\u4f8b\u5982\u4f7f\u7528\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u67e5\u8be2\u8868\u8fbe\u5f0f <code>up</code> \u6216 <code>process_start_time_seconds{job=\"prometheus\"}</code> \u7684\u8ba1\u7b97\u7ed3\u679c\uff1a</p> <pre><code>$ curl -g 'http://localhost:9090/api/v1/series?match[]=up&amp;match[]=process_start_time_seconds{job=\"prometheus\"}'\n{\n   \"status\" : \"success\",\n   \"data\" : [\n      {\n         \"__name__\" : \"up\",\n         \"job\" : \"prometheus\",\n         \"instance\" : \"localhost:9090\"\n      },\n      {\n         \"__name__\" : \"up\",\n         \"job\" : \"node\",\n         \"instance\" : \"localhost:9091\"\n      },\n      {\n         \"__name__\" : \"process_start_time_seconds\",\n         \"job\" : \"prometheus\",\n         \"instance\" : \"localhost:9090\"\n      }\n   ]\n}\n</code></pre>"},{"location":"chap8/5Promql_basic5/#3-2","title":"3-2 \u67e5\u8be2\u6807\u7b7e\u503c","text":"<p>\u4e0b\u9762\u8fd9\u4e2a\u4f8b\u5b50\u8fd4\u56de\u4e86\u5e26\u6709\u6307\u5b9a\u6807\u7b7e\u7684\u7684\u65f6\u95f4\u5e8f\u5217\u5217\u8868\uff1a</p> <pre><code>GET /api/v1/label/&lt;label_name&gt;/values\n</code></pre> <p>\u8fd4\u56de\u7ed3\u679c\u7684 <code>data</code> \u90e8\u5206\u662f\u4e00\u4e2a\u6807\u7b7e\u503c\u5217\u8868\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u8868\u8fbe\u5f0f\u8fd4\u56de\u7ed3\u679c\u7684 <code>data</code> \u90e8\u5206\u662f\u6807\u7b7e\u540d\u79f0\u4e3a <code>job</code> \u7684\u6240\u6709\u6807\u7b7e\u503c\uff1a</p> <pre><code>$ curl http://localhost:9090/api/v1/label/job/values\n{\n   \"status\" : \"success\",\n   \"data\" : [\n      \"node\",\n      \"prometheus\"\n   ]\n}\n</code></pre>"},{"location":"chap8/5Promql_basic5/#3-3","title":"3-3 \u54cd\u5e94\u6570\u636e\u683c\u5f0f","text":"<p>\u8868\u8fbe\u5f0f\u67e5\u8be2\u7ed3\u679c\u53ef\u80fd\u4f1a\u5728 <code>data</code> \u90e8\u5206\u7684 <code>result</code> \u5b57\u6bb5\u4e2d\u8fd4\u56de\u4ee5\u4e0b\u7684\u54cd\u5e94\u503c\u3002\u5176\u4e2d <code>&lt;sample_value&gt;</code> \u5360\u4f4d\u7b26\u662f\u6570\u503c\u6837\u672c\u503c\u3002\u7531\u4e8e <code>json</code> \u4e0d\u652f\u6301\u7279\u6b8a\u6d6e\u70b9\u503c\uff0c\u4f8b\u5982\uff1a<code>NaN</code>, <code>Inf</code>, \u548c <code>-Inf</code>\uff0c\u6240\u4ee5\u6837\u672c\u503c\u5c06\u4f1a\u4f5c\u4e3a\u5b57\u7b26\u4e32\uff08\u800c\u4e0d\u662f\u539f\u59cb\u6570\u503c\uff09\u6765\u8fdb\u884c\u4f20\u8f93\u3002</p> <p>\u533a\u95f4\u5411\u91cf</p> <p>\u5f53\u8fd4\u56de\u6570\u636e\u7c7b\u578b <code>resultType</code>\u4e3a <code>matrix</code> \u65f6\uff0c<code>result</code> \u54cd\u5e94\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>[\n  {\n    \"metric\": { \"&lt;label_name&gt;\": \"&lt;label_value&gt;\", ... },\n    \"values\": [ [ &lt;unix_time&gt;, \"&lt;sample_value&gt;\" ], ... ]\n  },\n  ...\n]\n</code></pre> <p>\u5176\u4e2d <code>metrics</code> \u8868\u793a\u5f53\u524d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u5f81\u7ef4\u5ea6\uff0c<code>values</code> \u5305\u542b\u5f53\u524d\u4e8b\u4ef6\u5e8f\u5217\u7684\u4e00\u7ec4\u6837\u672c\u3002</p>"},{"location":"chap8/5Promql_basic5/#3-4","title":"3-4 \u77ac\u65f6\u5411\u91cf","text":"<p>\u5f53\u8fd4\u56de\u6570\u636e\u7c7b\u578b <code>resultType</code> \u4e3a <code>vector</code> \u65f6\uff0c<code>result</code> \u54cd\u5e94\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>[\n  {\n    \"metric\": { \"&lt;label_name&gt;\": \"&lt;label_value&gt;\", ... },\n    \"value\": [ &lt;unix_time&gt;, \"&lt;sample_value&gt;\" ]\n  },\n  ...\n]\n</code></pre> <p>\u5176\u4e2d <code>metrics</code> \u8868\u793a\u5f53\u524d\u65f6\u95f4\u5e8f\u5217\u7684\u7279\u5f81\u7ef4\u5ea6\uff0c<code>values</code> \u5305\u542b\u5f53\u524d\u4e8b\u4ef6\u5e8f\u5217\u7684\u4e00\u7ec4\u6837\u672c\u3002</p>"},{"location":"chap8/5Promql_basic5/#3-5","title":"3-5 \u6807\u91cf","text":"<p>\u5f53\u8fd4\u56de\u6570\u636e\u7c7b\u578b <code>resultType</code> \u4e3a <code>scalar</code> \u65f6\uff0c<code>result</code> \u54cd\u5e94\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>[ &lt;unix_time&gt;, \"&lt;scalar_value&gt;\" ]\n</code></pre> <p>\u7531\u4e8e\u6807\u91cf\u4e0d\u5b58\u5728\u65f6\u95f4\u5e8f\u5217\u4e00\u8bf4\uff0c\u56e0\u6b64 <code>result</code> \u8868\u793a\u4e3a\u5f53\u524d\u7cfb\u7edf\u65f6\u95f4\u4e00\u4e2a\u6807\u91cf\u7684\u503c\u3002</p>"},{"location":"chap8/5Promql_basic5/#3-6","title":"3-6 \u5b57\u7b26\u4e32","text":"<p>\u5f53\u8fd4\u56de\u6570\u636e\u7c7b\u578b <code>resultType</code> \u4e3a<code>string</code> \u65f6\uff0c<code>result</code> \u54cd\u5e94\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>[ &lt;unix_time&gt;, \"&lt;string_value&gt;\" ]\n</code></pre> <p>\u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u54cd\u5e94\u5185\u5bb9\u683c\u5f0f\u548c\u6807\u91cf\u76f8\u540c\u3002</p>"},{"location":"chap8/60prometheus_job/","title":"8 \u89e3\u51b3 Prometheus \u76d1\u63a7 Kubernetes Job \u8bef\u62a5\u7684\u5751","text":"<p>\u662f\u5173\u4e8e Prometheus \u76d1\u63a7 Job \u4efb\u52a1\u8bef\u62a5\u7684\u95ee\u9898\uff08\u5df2\u7ecf\u540c\u6b65\u5230\u793e\u533a\u7f51\u7ad9\uff09\uff0c\u5927\u6982\u7684\u610f\u601d\u5c31 CronJob \u63a7\u5236\u7684 Job\uff0c\u524d\u9762\u6267\u884c\u5931\u8d25\u4e86\u4f1a\u89e6\u53d1\u62a5\u8b66\uff0c\u540e\u9762\u751f\u6210\u7684\u65b0\u7684 Job \u53ef\u4ee5\u6b63\u5e38\u6267\u884c\u540e\uff0c\u4f46\u662f\u8fd8\u662f\u4f1a\u6536\u5230\u524d\u9762\u7684\u62a5\u8b66\uff1a</p> <p>\u8fd9\u662f\u56e0\u4e3a\u4e00\u822c\u5728\u6267\u884c Job \u4efb\u52a1\u7684\u65f6\u5019\u6211\u4eec\u4f1a\u4fdd\u7559\u4e00\u4e9b\u5386\u53f2\u8bb0\u5f55\u65b9\u4fbf\u6392\u67e5\u95ee\u9898\uff0c\u6240\u4ee5\u5982\u679c\u4e4b\u524d\u6709\u5931\u8d25\u7684 Job \u4e86\uff0c\u5373\u4fbf\u7a0d\u540e\u4f1a\u53d8\u6210\u6210\u529f\u7684\uff0c\u90a3\u4e48\u4e4b\u524d\u7684 Job \u4e5f\u4f1a\u7ee7\u7eed\u5b58\u5728\uff0c\u800c\u5927\u90e8\u5206\u76f4\u63a5\u4f7f\u7528 kube-prometheus \u5b89\u88c5\u90e8\u7f72\u7684\u8bdd\u4f7f\u7528\u7684\u9ed8\u8ba4\u62a5\u8b66\u89c4\u5219\u662f <code>kube_job_status_failed &gt; 0</code>\uff0c\u8fd9\u663e\u7136\u662f\u4e0d\u51c6\u786e\u7684\uff0c</p> <p>\u53ea\u6709\u6211\u4eec\u53bb\u624b\u52a8\u5220\u9664\u4e4b\u524d\u8fd9\u4e2a\u5931\u8d25\u7684 Job \u4efb\u52a1\u624d\u53ef\u4ee5\u6d88\u9664\u8bef\u62a5\uff0c\u5f53\u7136\u8fd9\u79cd\u65b9\u5f0f\u662f\u53ef\u4ee5\u89e3\u51b3\u95ee\u9898\u7684\uff0c\u4f46\u662f\u4e0d\u591f\u81ea\u52a8\u5316\uff0c\u4e00\u5f00\u59cb\u6ca1\u6709\u60f3\u5f97\u5f88\u6df1\u5165\uff0c\u60f3\u53bb\u81ea\u52a8\u5316\u5220\u9664\u5931\u8d25\u7684 Job \u6765\u89e3\u51b3\uff0c\u4f46\u662f\u8fd9\u4e5f\u4f1a\u7ed9\u8fd0\u7ef4\u4eba\u5458\u5e26\u6765\u95ee\u9898\uff0c\u5c31\u662f\u4e0d\u65b9\u4fbf\u56de\u5934\u53bb\u6392\u67e5\u95ee\u9898\u3002\u4e0b\u9762\u6211\u4eec\u6765\u91cd\u65b0\u6574\u7406\u4e0b\u601d\u8def\u89e3\u51b3\u4e0b\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>CronJob \u4f1a\u5728\u8ba1\u5212\u7684\u6bcf\u4e2a\u6267\u884c\u65f6\u95f4\u521b\u5efa\u4e00\u4e2a Job \u5bf9\u8c61\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>.spec.successfulJobsHistoryLimit</code> \u548c <code>.spec.failedJobsHistoryLimit</code> \u5c5e\u6027\u6765\u4fdd\u7559\u591a\u5c11\u5df2\u5b8c\u6210\u548c\u5931\u8d25\u7684 Job\uff0c\u9ed8\u8ba4\u5206\u522b\u4e3a3\u548c1\uff0c\u6bd4\u5982\u4e0b\u9762\u58f0\u660e\u4e00\u4e2a CronJob \u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: batch/v1\nkind: CronJob\nmetadata:\n  name: hello\nspec:\n  schedule: \"*/1 * * * *\"\n  successfulJobsHistoryLimit: 1\n  failedJobsHistoryLimit: 1\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          containers:\n          - name: hello\n            image: busybox\n            imagePullPolicy: IfNotPresent\n            command:\n            - /bin/sh\n            - -c\n            - date;\n          restartPolicy: OnFailure\n</code></pre> <p>\u6839\u636e\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u89c4\u8303\uff0cKubernetes \u5c06\u53ea\u4fdd\u7559\u4e00\u4e2a\u5931\u8d25\u7684 Job \u548c\u4e00\u4e2a\u6210\u529f\u7684 Job\uff1a</p> <pre><code>NAME               COMPLETIONS   DURATION   AGE\nhello-4111706356   0/1           2m         10d\nhello-4111706356   1/1           5s         5s\n</code></pre> <p>\u8981\u89e3\u51b3\u4e0a\u9762\u7684\u8bef\u62a5\u95ee\u9898\uff0c\u540c\u6837\u8fd8\u662f\u9700\u8981\u4f7f\u7528\u5230 <code>kube-state-metrics</code> \u8fd9\u4e2a\u670d\u52a1\uff0c\u5b83\u901a\u8fc7\u76d1\u542c <code>Kubernetes APIServer</code> \u5e76\u751f\u6210\u6709\u5173\u5bf9\u8c61\u72b6\u6001\u7684\u6307\u6807\uff0c\u5b83\u5e76\u4e0d\u5173\u6ce8\u5355\u4e2a <code>Kubernetes</code> \u7ec4\u4ef6\u7684\u5065\u5eb7\u72b6\u51b5\uff0c\u800c\u662f\u5173\u6ce8\u5185\u90e8\u5404\u79cd\u5bf9\u8c61\u7684\u5065\u5eb7\u72b6\u51b5\uff0c\u4f8b\u5982 Deployment\u3001Node\u3001Job\u3001Pod \u7b49\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u3002\u8fd9\u91cc\u6211\u4eec\u5c06\u8981\u4f7f\u7528\u5230\u4ee5\u4e0b\u51e0\u4e2a\u6307\u6807\uff1a</p> <ul> <li><code>kube_job_owner</code>\uff1a\u7528\u6765\u67e5\u627e Job \u548c\u89e6\u53d1\u5b83\u7684 CronJob \u4e4b\u95f4\u7684\u5173\u7cfb</li> <li><code>kube_job_status_start_time</code>\uff1a\u83b7\u53d6 Job \u88ab\u89e6\u53d1\u7684\u65f6\u95f4</li> <li><code>kube_job_status_failed</code>\uff1a\u83b7\u53d6\u6267\u884c\u5931\u8d25\u7684\u4efb\u52a1</li> <li><code>kube_cronjob_spec_suspend</code>\uff1a\u8fc7\u6ee4\u6389\u6302\u8d77\u7684\u4f5c\u4e1a</li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u6307\u6807\u793a\u4f8b\uff0c\u5176\u4e2d\u5305\u542b CronJob \u89e6\u53d1\u8fd0\u884c\u7684hello \u4efb\u52a1\u751f\u6210\u7684\u6807\u7b7e\uff1a</p> <pre><code>kube_job_owner{job_name=\"hello-1604875860\", namespace=\"myNamespace\", owner_is_controller=\"true\", owner_kind=\"CronJob\", owner_name=\"hello\"} 1\nkube_job_status_start_time{job_name=\"hello-1604875860\", namespace=\"myNamespace\"} 1604875874\nkube_job_status_failed{job_name=\"hello-1604875860\", namespace=\"myNamespace\", reason=\"BackoffLimitExceeded\"} 1\nkube_cronjob_spec_suspend{cronjob=\"hello\",job=\"kube-state-metrics\", namespace=\"myNamespace\"} 0\n</code></pre> <p>\u8981\u60f3\u505a\u5230\u76d1\u63a7\u62a5\u8b66\u51c6\u786e\uff0c\u5176\u5b9e\u6211\u4eec\u53ea\u9700\u8981\u53bb\u83b7\u53d6\u540c\u4e00\u4e2a CronJob \u89e6\u53d1\u7684\u4e00\u7ec4 Job \u7684\u6700\u540e\u4e00\u6b21\u4efb\u52a1\uff0c\u53ea\u6709\u8be5 Job \u5728\u6267\u884c\u5931\u8d25\u7684\u65f6\u5019\u624d\u89e6\u53d1\u62a5\u8b66\u5373\u53ef\u3002</p> <p>\u7531\u4e8e <code>kube_job_status_failed</code> \u548c  <code>kube_job_status_start_time</code> \u6307\u6807\u4e2d\u5e76\u4e0d\u5305\u542b\u6240\u5c5e CronJob \u7684\u6807\u7b7e\uff0c\u6240\u4ee5\u7b2c\u4e00\u6b65\u9700\u8981\u52a0\u5165\u8fd9\u4e2a\u6807\u7b7e\uff0c\u800c <code>kube_job_owner</code> \u6307\u6807\u4e2d\u7684 <code>owner_name</code>\u5c31\u662f\u6211\u4eec\u9700\u8981\u7684\uff0c\u53ef\u4ee5\u7528\u4e0b\u9762\u7684 promql \u8bed\u53e5\u6765\u8fdb\u884c\u5408\u5e76\uff1a</p> <pre><code>max(\n  kube_job_status_start_time\n  * ON(job_name, namespace) GROUP_RIGHT()\n  kube_job_owner{owner_name != \"\"}\n  )\nBY (job_name, owner_name, namespace)\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 max \u51fd\u6570\u662f\u56e0\u4e3a\u6211\u4eec\u53ef\u80fd\u4f1a\u56e0\u4e3a HA \u8fd0\u884c\u591a\u4e2a <code>kube-state-metrics</code>\uff0c\u6240\u4ee5\u7528 max \u51fd\u6570\u6765\u8fd4\u56de\u6bcf\u4e2a Job \u4efb\u52a1\u7684\u4e00\u4e2a\u7ed3\u679c\u5373\u53ef\u3002\u5047\u8bbe\u6211\u4eec\u7684 Job \u5386\u53f2\u8bb0\u5f55\u5305\u542b 2 \u4e2a\u4efb\u52a1\uff08\u4e00\u4e2a\u5931\u8d25\uff0c\u53e6\u4e00\u4e2a\u6210\u529f\uff09\uff0c\u7ed3\u679c\u5c06\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>{job_name=\"hello-1623578940\", namespace=\"myNamespace\", owner_name=\"hello\"} 1623578959\n{job_name=\"hello-1617667200\", namespace=\"myNamespace\", owner_name=\"hello\"} 1617667204\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u77e5\u9053\u6bcf\u4e2a Job \u7684\u6240\u6709\u8005\u4e86\uff0c\u63a5\u7740\u6211\u4eec\u9700\u8981\u627e\u51fa\u6700\u540e\u6267\u884c\u7684\u4efb\u52a1\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6309 <code>owner_name</code> \u6807\u7b7e\u805a\u5408\u7ed3\u679c\u6765\u5b9e\u73b0\u8fd9\u4e00\u70b9\uff1a</p> <pre><code>max(\n  kube_job_status_start_time\n  * ON(job_name,namespace) GROUP_RIGHT()\n  kube_job_owner{owner_name!=\"\"}\n) \nBY (owner_name)\n</code></pre> <p>\u4e0a\u9762\u8fd9\u6761\u8bed\u53e5\u4f1a\u627e\u5230\u6bcf\u4e2a owner\uff08\u4e5f\u5c31\u662f CronJob\uff09\u6700\u65b0\u7684\u4efb\u52a1\u5f00\u59cb\u65f6\u95f4\uff0c\u7136\u540e\u518d\u548c\u4e0a\u9762\u7684\u8bed\u53e5\u8fdb\u884c\u5408\u5e76\uff0c\u4fdd\u7559\u5f00\u59cb\u65f6\u95f4\u76f8\u540c\u7684\u8bb0\u5f55\u5373\u4e3a\u6700\u65b0\u6267\u884c\u7684 Job \u4efb\u52a1\u4e86\uff1a</p> <pre><code>max(\n kube_job_status_start_time\n * ON(job_name,namespace) GROUP_RIGHT()\n kube_job_owner{owner_name!=\"\"}\n)\nBY (job_name, owner_name, namespace)\n== ON(owner_name) GROUP_LEFT()\nmax(\n kube_job_status_start_time\n * ON(job_name,namespace) GROUP_RIGHT()\n kube_job_owner{owner_name!=\"\"}\n)\nBY (owner_name)\n</code></pre> <p>\u7ed3\u679c\u5c06\u663e\u793a\u6bcf\u4e2a CronJob \u6700\u540e\u6267\u884c\u7684\u4f5c\u4e1a\uff0c\u5e76\u4e14\u4ec5\u663e\u793a\u6700\u540e\u4e00\u4e2a\uff1a</p> <pre><code>{job_name=\"hello-1623578940\", namespace=\"myNamespace\", owner_name=\"hello\"} 1623578959\n</code></pre> <p>\u4e3a\u4e86\u589e\u52a0\u53ef\u8bfb\u6027\u6211\u4eec\u8fd8\u53ef\u4ee5\u5c06 <code>job_name</code>\u3001<code>owner_name</code> \u6807\u7b7e\u66ff\u6362\u4e3a job \u548c cronjob\uff0c\u8fd9\u6837\u66f4\u5bb9\u6613\u770b\u660e\u767d\uff1a</p> <pre><code>label_replace(\n  label_replace(\n    max(\n      kube_job_status_start_time\n      * ON(job_name,namespace) GROUP_RIGHT()\n      kube_job_owner{owner_name!=\"\"}\n    )\n    BY (job_name, owner_name, namespace)\n    == ON(owner_name) GROUP_LEFT()\n    max(\n      kube_job_status_start_time\n      * ON(job_name,namespace) GROUP_RIGHT()\n      kube_job_owner{owner_name!=\"\"}\n    )\n    BY (owner_name),\n  \"job\", \"$1\", \"job_name\", \"(.+)\"),\n\"cronjob\", \"$1\", \"owner_name\", \"(.+)\")\n</code></pre> <p>\u73b0\u5728\u5c06\u4f1a\u770b\u5230\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u7ed3\u679c\uff1a</p> <pre><code>{job=\"hello-1623578940\", cronjob=\"hello\", job_name=\"hello-1623578940\", namespace=\"myNamespace\", owner_name=\"hello\"} 1623578959\n</code></pre> <p>\u7531\u4e8e\u4e0a\u9762\u7684\u67e5\u8be2\u8bed\u53e5\u6bd4\u8f83\u590d\u6742\uff0c\u5982\u679c\u6bcf\u6b21\u62a5\u8b66\u8bc4\u4f30\u7684\u65f6\u5019\u90fd\u53bb\u8fdb\u884c\u4e00\u6b21\u5b9e\u65f6\u8ba1\u7b97\u4f1a\u5bf9 Prometheus \u4ea7\u751f\u975e\u5e38\u5927\u7684\u538b\u529b\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u501f\u52a9\u8bb0\u5f55\u89c4\u5219\u6765\u5b9e\u73b0\u7c7b\u79bb\u7ebf\u8ba1\u7b97\u7684\u65b9\u5f0f\uff0c\u5927\u5927\u63d0\u9ad8\u6548\u7387\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684\u8bb0\u5f55\u89c4\u5219\uff0c\u7528\u6765\u8868\u793a\u83b7\u53d6\u6bcf\u4e2a CronJob \u6700\u540e\u6267\u884c\u7684\u4f5c\u4e1a\u8bb0\u5f55\uff1a</p> <pre><code>- record: job:kube_job_status_start_time:max\n  expr: |\n    label_replace(\n      label_replace(\n        max(\n          kube_job_status_start_time\n          * ON(job_name,namespace) GROUP_RIGHT()\n          kube_job_owner{owner_name!=\"\"}\n        )\n        BY (job_name, owner_name, namespace)\n        == ON(owner_name) GROUP_LEFT()\n        max(\n          kube_job_status_start_time\n          * ON(job_name,namespace) GROUP_RIGHT()\n          kube_job_owner{owner_name!=\"\"}\n        )\n        BY (owner_name),\n      \"job\", \"$1\", \"job_name\", \"(.+)\"),\n    \"cronjob\", \"$1\", \"owner_name\", \"(.+)\")\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u77e5\u9053\u4e86 CronJob \u6700\u8fd1\u5f00\u59cb\u6267\u884c\u7684 Job \u4e86\uff0c\u90a3\u4e48\u60f3\u8981\u8fc7\u6ee4\u51fa\u5931\u8d25\u7684\uff0c\u5219\u518d\u4f7f\u7528 <code>kube_job_status_failed</code> \u6307\u6807\u5c31\u53ef\u4ee5\u4e86\uff1a</p> <pre><code>- record: job:kube_job_status_failed:sum\n  expr: |\n    clamp_max(job:kube_job_status_start_time:max, 1)\n      * ON(job) GROUP_LEFT()\n      label_replace(\n        (kube_job_status_failed &gt; 0),\n        \"job\", \"$1\", \"job_name\", \"(.+)\"\n      )\n</code></pre> <p>\u8fd9\u91cc\u4f7f\u7528 <code>clamp_max</code> \u51fd\u6570\u5c06<code>job:kube_job_status_start_time:max</code> \u7684\u7ed3\u679c\u8f6c\u6362\u4e3a\u4e00\u7ec4\u4e0a\u9650\u4e3a 1 \u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u4f7f\u7528\u5b83\u6765\u901a\u8fc7\u4e58\u6cd5\u8fc7\u6ee4\u5931\u8d25\u7684\u4f5c\u4e1a\uff0c\u5f97\u5230\u5305\u542b\u4e00\u7ec4\u6700\u8fd1\u5931\u8d25\u7684 Job \u4efb\u52a1\uff0c\u8fd9\u91cc\u6211\u4eec\u4e5f\u6dfb\u52a0\u5230\u540d\u4e3a <code>kube_job_status_failed:sum</code> \u7684\u8bb0\u5f55\u89c4\u5219\u4e2d\u3002</p> <p>\u6700\u540e\u4e00\u6b65\u5c31\u662f\u76f4\u63a5\u4e3a\u5931\u8d25\u7684 Job \u4efb\u52a1\u6dfb\u52a0\u62a5\u8b66\u89c4\u5219\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>- alert: CronJobStatusFailed\n  expr: |\n    job:kube_job_status_failed:sum\n    * ON(cronjob, namespace) GROUP_LEFT()\n    (kube_cronjob_spec_suspend == 0)\n</code></pre> <p>\u4e3a\u907f\u514d\u8bef\u62a5\uff0c\u6211\u4eec\u5df2\u5c06\u6302\u8d77\u7684\u4efb\u52a1\u6392\u9664\u5728\u5916\u4e86\u3002\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u89e3\u51b3\u4e86 Prometheus \u76d1\u63a7 CronJob \u7684\u4efb\u52a1\u8bef\u62a5\u7684\u95ee\u9898\uff0c\u867d\u7136 kube-prometheus \u4e3a\u6211\u4eec\u5185\u7f6e\u4e86\u5927\u91cf\u7684\u76d1\u63a7\u62a5\u8b66\u89c4\u5219\uff0c\u4f46\u662f\u4e5f\u4e0d\u80fd\u5b8c\u5168\u8ff7\u4fe1\uff0c\u6709\u65f6\u5019\u5e76\u4e0d\u4e00\u5b9a\u9002\u5408\u5b9e\u9645\u7684\u9700\u6c42\u3002</p>"},{"location":"chap8/6Promql_adv1/","title":"6 Prometheus\u8bb0\u5f55\u89c4\u5219\u7684\u4f7f\u7528(Recording Rule)","text":"<p>PromQL \u8bed\u53e5\u67e5\u8be2\u6027\u80fd\u4f18\u5316</p> <p><code>Prometheus</code> \u4f5c\u4e3a\u73b0\u5728\u6700\u706b\u7684\u4e91\u539f\u751f\u76d1\u63a7\u5de5\u5177\uff0c\u5b83\u7684\u4f18\u79c0\u8868\u73b0\u662f\u6bcb\u5eb8\u7f6e\u7591\u7684\u3002\u4f46\u662f\u5728\u6211\u4eec\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0c\u5b58\u50a8\u5728 <code>Prometheus</code> \u4e2d\u7684\u76d1\u63a7\u6307\u6807\u6570\u636e\u8d8a\u6765\u8d8a\u591a\uff0c\u67e5\u8be2\u7684\u9891\u7387\u4e5f\u5728\u4e0d\u65ad\u7684\u589e\u52a0\uff0c\u5f53\u6211\u4eec\u7528 <code>Grafana</code> \u6dfb\u52a0\u66f4\u591a\u7684 <code>Dashboard</code> \u7684\u65f6\u5019\uff0c\u53ef\u80fd\u6162\u6162\u5730\u4f1a\u4f53\u9a8c\u5230 <code>Grafana</code> \u5df2\u7ecf\u65e0\u6cd5\u6309\u65f6\u6e32\u67d3\u56fe\u8868\uff0c\u5e76\u4e14\u5076\u5c14\u8fd8\u4f1a\u51fa\u73b0\u8d85\u65f6\u7684\u60c5\u51b5\uff0c\u7279\u522b\u662f\u5f53\u6211\u4eec\u5728\u957f\u65f6\u95f4\u6c47\u603b\u5927\u91cf\u7684\u6307\u6807\u6570\u636e\u7684\u65f6\u5019\uff0c<code>Prometheus</code> \u67e5\u8be2\u8d85\u65f6\u7684\u60c5\u51b5\u53ef\u80fd\u66f4\u591a\u4e86\uff0c\u8fd9\u65f6\u5c31\u9700\u8981\u4e00\u79cd\u80fd\u591f\u7c7b\u4f3c\u4e8e\u540e\u53f0\u6279\u5904\u7406\u7684\u673a\u5236\u5728\u540e\u53f0\u5b8c\u6210\u8fd9\u4e9b\u590d\u6742\u8fd0\u7b97\u7684\u8ba1\u7b97\uff0c\u5bf9\u4e8e\u4f7f\u7528\u8005\u800c\u8a00\u53ea\u9700\u8981\u67e5\u8be2\u8fd9\u4e9b\u8fd0\u7b97\u7ed3\u679c\u5373\u53ef\u3002</p> <p><code>Prometheus</code>  \u63d0\u4f9b\u4e00\u79cd\u8bb0\u5f55\u89c4\u5219\uff08<code>Recording Rule</code>\uff09 \u6765\u652f\u6301\u8fd9\u79cd\u540e\u53f0\u8ba1\u7b97\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u590d\u6742\u67e5\u8be2\u7684 <code>PromQL</code> \u8bed\u53e5\u7684\u6027\u80fd\u4f18\u5316\uff0c\u63d0\u9ad8\u67e5\u8be2\u6548\u7387</p>"},{"location":"chap8/6Promql_adv1/#1","title":"1 \u95ee\u9898","text":"<p>\u6bd4\u5982\u6211\u4eec\u60f3\u8981\u4e86\u89e3 <code>Kubernetes</code> \u8282\u70b9\u4e4b\u95f4 <code>CPU</code> \u548c\u5185\u5b58\u7684\u5b9e\u9645\u5229\u7528\u7387\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 <code>container_cpu_usage_seconds_total</code> \u548c  <code>container_memory_usage_bytes</code> \u8fd9\u4e24\u4e2a\u6307\u6807\u6765\u67e5\u8be2 <code>CPU</code>  \u548c\u5185\u5b58\u7684\u5229\u7528\u7387\u3002</p> <p>\u56e0\u4e3a\u6bcf\u4e2a\u8fd0\u884c\u4e2d\u7684\u5bb9\u5668\u90fd\u4f1a\u6536\u96c6\u8fd9\u4e24\u4e2a\u6307\u6807\u8fdb\u884c\uff0c\u4f46\u662f\u9700\u8981\u77e5\u9053\uff0c\u5bf9\u4e8e\u7a0d\u5fae\u5927\u70b9\u7684\u7ebf\u4e0a\u73af\u5883\uff0c\u53ef\u80fd\u6211\u4eec\u540c\u65f6\u8fd0\u884c\u7740\u6210\u5343\u4e0a\u4e07\u7684\u5bb9\u5668\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u4ee5\u6bcf5\u5206\u949f\u7684\u9891\u7387\u53bb\u67e5\u8be2\u4e0b\u4e00\u5468\u5185\u6570\u5343\u4e2a\u5bb9\u5668\u7684\u6570\u636e\u7684\u65f6\u5019\uff0c<code>Prometheus</code> \u5c31\u6bd4\u8f83\u96be\u4ee5\u5feb\u901f\u8fdb\u884c\u6570\u636e\u67e5\u8be2\u4e86\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u7528 <code>container_cpu_usage_seconds_total</code> \u603b\u6570\u9664\u4ee5 <code>kube_node_status_allocatable_cpu_cores</code>\u603b\u6570\u5f97\u51fa <code>CPU</code> \u5229\u7528\u7387\uff1a</p> <pre><code>sum(rate(container_cpu_usage_seconds_total[5m])) / avg_over_time(sum(kube_node_status_allocatable_cpu_cores)[5m:5m])\nLoad time: 15723ms\n</code></pre> <p>\u4f7f\u7528\u6eda\u52a8\u7a97\u53e3\u5c06 <code>container_memory_usage_bytes</code> \u603b\u6570\u9664\u4ee5 <code>kube_node_status_allocatable_memory_bytes</code> \u603b\u6570\u6765\u8ba1\u7b97\u5185\u5b58\u5229\u7528\u7387\uff1a</p> <pre><code>avg_over_time(sum(container_memory_usage_bytes)[15m:15m]) / avg_over_time(sum(kube_node_status_allocatable_memory_bytes)[5m:5m])\nLoad time: 18656ms\n</code></pre>"},{"location":"chap8/6Promql_adv1/#2","title":"2 \u8bb0\u5f55\u89c4\u5219","text":"<p>\u6211\u4eec\u8bf4\u4e86 <code>Prometheus</code> \u63d0\u4f9b\u4e86\u4e00\u79cd\u53eb\u505a \u8bb0\u5f55\u89c4\u5219\uff08<code>Recording Rule</code>\uff09\u7684\u65b9\u5f0f\u53ef\u4ee5\u6765\u4f18\u5316\u6211\u4eec\u7684\u67e5\u8be2\u8bed\u53e5\uff0c\u8bb0\u5f55\u89c4\u5219\u7684\u57fa\u672c\u601d\u60f3\u662f\uff0c\u5b83\u5141\u8bb8\u6211\u4eec\u57fa\u4e8e\u5176\u4ed6\u65f6\u95f4\u5e8f\u5217\u521b\u5efa\u81ea\u5b9a\u4e49\u7684 <code>meta-time</code>\u5e8f\u5217\uff0c\u5982\u679c\u4f60\u4f7f\u7528 <code>Prometheus Operator</code> \u7684\u8bdd\u53ef\u4ee5\u53d1\u73b0 <code>Prometheus</code>\u4e2d\u5df2\u7ecf\u6709\u4e86\u5927\u91cf\u6b64\u7c7b\u89c4\u5219\uff0c\u6bd4\u5982\uff1a</p> <pre><code>groups:\n  - name: k8s.rules\n    rules:\n    - expr: |\n        sum(rate(container_cpu_usage_seconds_total{image!=\"\", container!=\"\"}[5m])) by (namespace)\n      record: namespace:container_cpu_usage_seconds_total:sum_rate\n    - expr: |\n        sum(container_memory_usage_bytes{image!=\"\", container!=\"\"}) by (namespace)\n      record: namespace:container_memory_usage_bytes:sum\n</code></pre> <p>\u4e0a\u9762\u7684\u8fd9\u4e24\u4e2a\u89c4\u5219\u5c31\u5b8c\u5168\u53ef\u4ee5\u6267\u884c\u4e0a\u9762\u6211\u4eec\u7684\u67e5\u8be2\uff0c\u5b83\u4eec\u4f1a\u8fde\u7eed\u6267\u884c\u5e76\u4ee5\u5f88\u5c0f\u7684\u65f6\u95f4\u5e8f\u5217\u5c06\u7ed3\u679c\u5b58\u50a8\u8d77\u6765\u3002</p> <p><code>sum(rate(container_cpu_usage_seconds_total{job=\"kubelet\", image!=\"\", container_name!=\"\"}[5m])) by (namespace)</code> </p> <p>\u5c06\u4ee5\u9884\u5b9a\u4e49\u7684\u65f6\u95f4\u95f4\u9694\u8fdb\u884c\u8bc4\u4f30\uff0c\u5e76\u5b58\u50a8\u4e3a\u65b0\u7684\u6307\u6807\uff1a</p> <p><code>namespace:container_cpu_usage_seconds_total:sum_rate</code>\uff0c\u4e0e\u5185\u5b58\u67e5\u8be2\u76f8\u540c\u3002</p> <p>\u73b0\u5728\uff0c\u6211\u53ef\u4ee5\u5c06\u67e5\u8be2\u66f4\u6539\u4e3a\u5982\u4e0b\u6240\u793a\u5f97\u51fa CPU \u5229\u7528\u7387\uff1a</p> <pre><code>sum(namespace:container_cpu_usage_seconds_total:sum_rate) / avg_over_time(sum(kube_node_status_allocatable_cpu_cores)[5m:5m])\nLoad time: 1077ms\n</code></pre> <p>\u73b0\u5728\uff0c\u5b83\u7684\u8fd0\u884c\u901f\u5ea6\u63d0\u9ad8\u4e8614\u500d\uff01</p> <p>\u540c\u6837\u7684\u65b9\u5f0f\u8ba1\u7b97\u5185\u5b58\u5229\u7528\u7387\uff1a</p> <pre><code>sum(namespace:container_memory_usage_bytes:sum) / avg_over_time(sum(kube_node_status_allocatable_memory_bytes)[5m:5m])\nLoad time: 677ms\n</code></pre> <p>\u73b0\u5728\u8fd0\u884c\u901f\u5ea6\u63d0\u9ad8\u4e8627\u500d\uff01</p>"},{"location":"chap8/6Promql_adv1/#3","title":"3 \u8bb0\u5f55\u89c4\u5219\u7528\u6cd5","text":"<p>\u5728 <code>Prometheus</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>rule_files</code> \u5b9a\u4e49 <code>recoding rule</code> \u89c4\u5219\u6587\u4ef6\u7684\u8bbf\u95ee\u8def\u5f84\uff0c\u548c\u5b9a\u4e49\u62a5\u8b66\u89c4\u5219\u7684\u65b9\u5f0f\u57fa\u672c\u4e00\u81f4\uff1a</p> <pre><code>rule_files:\n  [ - &lt;filepath_glob&gt; ... ]\n</code></pre> <p>\u6bcf\u4e00\u4e2a\u89c4\u5219\u6587\u4ef6\u901a\u8fc7\u4ee5\u4e0b\u683c\u5f0f\u8fdb\u884c\u5b9a\u4e49\uff1a</p> <pre><code>groups:\n  [ - &lt;rule_group&gt; ]\n</code></pre> <p>\u4e00\u4e2a\u7b80\u5355\u7684\u89c4\u5219\u6587\u4ef6\u53ef\u80fd\u662f\u8fd9\u4e2a\u6837\u5b50\u7684\uff1a</p> <pre><code>groups:\n- name: example\n  rules:\n  - record: job:http_inprogress_requests:sum\n    expr: sum(http_inprogress_requests) by (job)\n</code></pre> <p><code>rule_group</code> \u7684\u5177\u4f53\u914d\u7f6e\u9879\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># \u5206\u7ec4\u7684\u540d\u79f0\uff0c\u5728\u4e00\u4e2a\u6587\u4ef6\u4e2d\u5fc5\u987b\u662f\u552f\u4e00\u7684\nname: &lt;string&gt;\n# \u8bc4\u4f30\u5206\u7ec4\u4e2d\u89c4\u5219\u7684\u9891\u7387\n[ interval: &lt;duration&gt; | default = global.evaluation_interval ]\nrules:\n  [ - &lt;rule&gt; ... ]\n</code></pre> <p>\u4e0e\u544a\u8b66\u89c4\u5219\u4e00\u81f4\uff0c\u4e00\u4e2a group \u4e0b\u53ef\u4ee5\u5305\u542b\u591a\u6761\u89c4\u5219 rule\u3002</p> <pre><code># \u8f93\u51fa\u7684\u65f6\u95f4\u5e8f\u5217\u540d\u79f0\uff0c\u5fc5\u987b\u662f\u4e00\u4e2a\u6709\u6548\u7684 metric \u540d\u79f0\nrecord: &lt;string&gt;\n# \u8981\u8ba1\u7b97\u7684 PromQL \u8868\u8fbe\u5f0f\uff0c\u6bcf\u4e2a\u8bc4\u4f30\u5468\u671f\u90fd\u662f\u5728\u5f53\u524d\u65f6\u95f4\u8fdb\u884c\u8bc4\u4f30\u7684\uff0c\u7ed3\u679c\u8bb0\u5f55\u4e3a\u4e00\u7ec4\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\uff0cmetrics \u540d\u79f0\u7531 record \u8bbe\u7f6e\nexpr: &lt;string&gt;\n# \u6dfb\u52a0\u6216\u8005\u8986\u76d6\u7684\u6807\u7b7e\nlabels:\n  [ &lt;labelname&gt;: &lt;labelvalue&gt; ]\n</code></pre> <p>\u6839\u636e\u89c4\u5219\u4e2d\u7684\u5b9a\u4e49\uff0c<code>Prometheus</code> \u4f1a\u5728\u540e\u53f0\u5b8c\u6210 <code>expr</code> \u4e2d\u5b9a\u4e49\u7684 <code>PromQL</code>\u8868\u8fbe\u5f0f\u8ba1\u7b97\uff0c\u5e76\u4e14\u5c06\u8ba1\u7b97\u7ed3\u679c\u4fdd\u5b58\u5230\u65b0\u7684\u65f6\u95f4\u5e8f\u5217 <code>record</code> \u4e2d\uff0c\u540c\u65f6\u8fd8\u53ef\u4ee5\u901a\u8fc7 labels \u6807\u7b7e\u4e3a\u8fd9\u4e9b\u6837\u672c\u6dfb\u52a0\u989d\u5916\u7684\u6807\u7b7e\u3002</p> <p>\u8fd9\u4e9b\u89c4\u5219\u6587\u4ef6\u7684\u8ba1\u7b97\u9891\u7387\u9ed8\u8ba4\u4e0e\u544a\u8b66\u89c4\u5219\u8ba1\u7b97\u9891\u7387\u4e00\u81f4\uff0c\u90fd\u901a\u8fc7 <code>global.evaluation_interval</code> \u8fdb\u884c\u5b9a\u4e49:</p> <pre><code>global:\n  [ evaluation_interval: &lt;duration&gt; | default = 1m ]\n</code></pre>"},{"location":"chap8/9promql_6errors/","title":"\u4f7f\u7528 Prometheus PromQL\u65f6\u9700\u8981\u907f\u514d\u8fd96\u4e2a\u9519\u8bef","text":"<p>https://promlabs.com/blog/2022/12/11/avoid-these-6-mistakes-when-getting-started-with-prometheus\uff0c\u8fd9\u4e9b\u90fd\u662f Prometheus \u65b0\u624b\u7ecf\u5e38\u72af\u7684\u9519\u8bef\u3002</p>"},{"location":"chap8/9promql_6errors/#1","title":"\u9519\u8bef 1\uff1a\u9ad8\u57fa\u6570\u70b8\u5f39","text":"<p>\u8fd9\u662f Prometheus \u4f7f\u7528\u8005\u7ecf\u5e38\u4f1a\u72af\u7684\u4e00\u4e2a\u9519\uff0c\u56e0\u4e3a Prometheus \u65f6\u5e8f\u662f\u57fa\u4e8e\u591a\u6807\u7b7e\u7684\uff0c\u5b83\u975e\u5e38\u7075\u6d3b\uff0c\u6709\u65f6\u4f60\u60f3\u65b0\u589e\u4e00\u4e2a\u6807\u7b7e\uff0c\u4ece\u800c\u5c06\u4e00\u4e2a\u7c97\u7c92\u5ea6\u7684\u6307\u6807\u8fdb\u884c\u62c6\u5206\uff0c\u4f46\u5207\u8bb0\u6dfb\u52a0\u7684\u6807\u7b7e\u503c\u5e94\u8be5\u505a\u5230\u5c3d\u91cf\u6536\u655b\uff0c\u4e0d\u7136\u4f1a\u5bfc\u81f4\u540c\u4e00\u6307\u6807\u540d\u7684\u6807\u7b7e\u6570\u91cf\u5de8\u5927\u800c\u5bfc\u81f4 Prometheus \u4e25\u91cd\u7684\u6027\u80fd\u95ee\u9898\uff08OOM\uff09\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u6bd4\u5982\u4f60\u6709\u4e00\u4e2a\u53ea\u5305\u542b method \u6807\u7b7e\u7684\u65f6\u95f4\u5e8f\u5217 <code>http_requests_total</code>\uff1a</p> <pre><code>http_requests_total{method=\"POST\"}\nhttp_requests_total{method=\"GET\"}\nhttp_requests_total{method=\"PUT\"}\nhttp_requests_total{method=\"DELETE\"}\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u95f4\u5e8f\u5217\u5b9a\u4e49\u6ca1\u95ee\u9898\uff0c\u56e0\u4e3a HTTP \u7684 method \u7c7b\u578b\u662f\u6709\u9650\u7684\uff0c\u4f46\u6709\u4e00\u5929\uff0c\u4f60\u53ef\u80fd\u60f3\u6839\u636e\u7528\u6237 id \u8fdb\u884c\u533a\u5206\uff0c\u7c7b\u4f3c\u8fd9\u6837\uff1a</p> <pre><code>http_requests_total{method=\"POST\",user_id=\"1\"}\nhttp_requests_total{method=\"POST\",user_id=\"2\"}\nhttp_requests_total{method=\"POST\",user_id=\"3\"}\n[\u2026many more\u2026]\nhttp_requests_total{method=\"POST\",user_id=\"16434313\"}\n\nhttp_requests_total{method=\"GET\",user_id=\"1\"}\nhttp_requests_total{method=\"GET\",user_id=\"2\"}\nhttp_requests_total{method=\"GET\",user_id=\"3\"}\n[\u2026many more\u2026]\nhttp_requests_total{method=\"GET\",user_id=\"16434313\"}\n[\u2026many more\u2026]\n</code></pre> <p>\u5982\u679c\u4f60\u6709\u975e\u5e38\u591a\u7684\u4e0d\u540c\u7528\u6237\uff0c\u6b64\u65f6\u5c31\u4f1a\u5b58\u5728\u4e25\u91cd\u7684\u9ad8\u57fa\u6570\u95ee\u9898\uff0c\u8fd9\u5c06\u5bfc\u81f4 Prometheus \u5185\u5b58\u4f7f\u7528\u6fc0\u589e\uff0c\u6700\u7ec8\u53ef\u80fd\u56e0\u4e3a OOM \u800c\u5bfc\u81f4\u5d29\u6e83\u3002</p> <p>\u6240\u4ee5\u8bf7\u7262\u8bb0\uff1a\u6307\u6807\u4e0a\u6807\u7b7e\u7684\u6bcf\u4e00\u79cd\u552f\u4e00\u7ec4\u5408\u90fd\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u65f6\u95f4\u5e8f\u5217\uff0cPrometheus \u90fd\u4f1a\u5bf9\u5176\u8fdb\u884c\u6444\u53d6\u3001\u7d22\u5f15\u3001\u5b58\u50a8\u548c\u5904\u7406\u3002</p> <p>\u867d\u7136\u9488\u5bf9\u5355\u4e2a\u6807\u7b7e\u7684\u4e0d\u540c\u503c\u7684\u6570\u91cf\u6ca1\u6709\u660e\u786e\u7684\u9650\u5236\uff0c\u4f46\u56e0\u4e3a\u4e0d\u540c\u503c\u90fd\u662f\u4e00\u4e2a\u65b0\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u4f60\u9700\u8981\u786e\u4fdd\u5176\u6570\u91cf\u4fdd\u6301\u5728\u4f60 Prometheus \u670d\u52a1\u5668\u5bb9\u91cf\u4e4b\u4e0b\uff08\u4e00\u4e2a\u5927\u578b Prometheus \u5355\u8282\u70b9\u80fd\u591f\u5904\u7406\u51e0\u767e\u4e07\u4e2a\u65f6\u95f4\u5e8f\u5217\uff09\uff0c\u6240\u4ee5\u4f60\u5728\u8bbe\u8ba1\u65f6\u95f4\u5e8f\u5217\u7684\u6807\u7b7e\u7684\u65f6\u5019\uff0c\u9700\u8981\u786e\u4fdd\u5b83\u4eec\u7684\u6240\u6709\u7ec4\u5408\u603b\u6570\u5728\u4f60 Prometheus \u670d\u52a1\u5668\u53ef\u4ee5\u627f\u53d7\u7684\u8303\u56f4\u5185\u3002</p> <p>\u5bf9\u6b64\uff0c\u6709\u4e00\u4e9b\u6807\u7b7e\u503c\u6211\u4eec\u8981\u7279\u522b\u6ce8\u610f\u907f\u514d\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u516c\u7f51 IP \u6216\u8005\u90ae\u4ef6\u5730\u5740\u3002</li> <li>HTTP \u8bf7\u6c42 Path \u5168\u8def\u5f84\uff0c\u5c24\u5176\u8fd9\u4e9b\u8def\u5f84\u5e26\u6709\u52a8\u6001 ID \u7b49\u4fe1\u606f\u3002</li> <li>\u8fdb\u7a0b ID\uff08\u9664\u975e\u662f\u6709\u9650\u96c6\u5408\uff09\u3002</li> </ul> <p>\u6709\u65f6\u4f60\u60f3\u5728\u4e0d\u5b8c\u5168\u5220\u9664\u6807\u7b7e\u7684\u60c5\u51b5\u4e0b\u89e3\u51b3\u6807\u7b7e\u9ad8\u57fa\u6570\u7684\u95ee\u9898\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u8981\u60f3\u529e\u6cd5\u51cf\u5c11\u5176\u503c\u7684\u57fa\u6570\u3002</p> <p>\u4f8b\u5982\uff0c\u5bf9\u4e8e <code>/api/users/739567637385/posts/28388445</code> \u7684 HTTP \u8bf7\u6c42, \u6211\u4eec\u5c06\u52a8\u6001\u4fe1\u606f\u90e8\u5206\u4f7f\u7528 <code>user_id</code> \u548c <code>post_id</code> \u5360\u4f4d\u7b26\u7edf\u4e00\u66ff\u6362\uff0c\u6240\u4ee5\u6574\u4e2a path \u53ef\u4ee5\u66ff\u6362\u4e3a <code>/api/users/{user_id}/posts/{post_id}</code>\uff0c\u4ece\u800c\u6709\u6548\u51cf\u5c11 path \u6807\u7b7e\u7684\u503c\u6570\u91cf\u3002</p>"},{"location":"chap8/9promql_6errors/#2","title":"\u9519\u8bef 2\uff1a\u5728\u544a\u8b66\u8868\u8fbe\u5f0f\u4e2d\u56e0\u805a\u5408\u800c\u4e22\u5931\u6709\u4ef7\u503c\u7684\u6807\u7b7e","text":"<p>\u5728\u505a\u544a\u8b66\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5f80\u5f80\u4f1a\u901a\u8fc7\u805a\u5408\u8ba1\u7b97\u53bb\u9664\u4e0d\u5173\u5fc3\u7684\u4e00\u4e9b\u6807\u7b7e\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u60f3\u786e\u5b9a\u67d0\u4e2a\u670d\u52a1\u7684\u603b\u4f53\u9519\u8bef\u7387\uff08\u8de8\u6240\u6709\u6807\u7b7e\u7ef4\u5ea6\uff09\u662f\u5426\u8fc7\u9ad8\uff0c\u53ef\u4ee5\u7f16\u5199\u5982\u4e0b\u7684\u89c4\u5219\uff1a</p> <pre><code>sum(rate(errors_total{job=\"my-job\"}[5m])) &gt; 10\n</code></pre> <p>\u8fd9\u770b\u4e0a\u53bb\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>sum()</code> \u805a\u5408\u5668\u4f1a\u53bb\u6389\u65f6\u5e8f\u7684\u6240\u6709\u6807\u7b7e\uff0c\u5b83\u4e0d\u4ec5\u4f1a\u5220\u9664\u4f60\u60f3\u8981\u805a\u5408\u7684\u7ef4\u5ea6\uff08\u5982\u5b9e\u4f8b\u3001\u9519\u8bef\u7c7b\u578b\u7b49\uff09\uff0c\u8fd8\u4f1a\u5220\u9664\u4e00\u4e9b\u6bd4\u8f83\u901a\u7528\u7684\u6807\u7b7e\uff0c\u8fd9\u4e9b\u6807\u7b7e\u5bf9\u4e8e Alertmanager \u4e2d\u8fdb\u884c\u544a\u8b66\u7684\u8def\u7531\u6216\u9759\u9ed8\u662f\u6709\u5e2e\u52a9\u7684\uff0c\u7279\u522b\u662f job \u6807\u7b7e\uff0c\u56e0\u4e3a\u4e0d\u540c job \u901a\u5e38\u7531\u4e0d\u540c\u7684\u8fd0\u7ef4\u56e2\u961f\u8d1f\u8d23\u3002</p> <p>\u56e0\u6b64\u6211\u4eec\u5e94\u8be5\u5c3d\u53ef\u80fd\u5728\u805a\u5408\u4e2d\u4fdd\u7559\u6b64\u6807\u7b7e\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>sum by(job) (rate(errors_total{job=\"my-job\"}[5m])) &gt; 10</code> \u8fd9\u4e2a\u544a\u8b66\u8868\u8fbe\u5f0f\u3002</p> <p>\u4e00\u4e2a\u66f4\u597d\u7684\u9009\u62e9\u662f\u901a\u8fc7\u4f7f\u7528 without() \u805a\u5408\u4fee\u9970\u7b26\u66ff\u6362 by() \u805a\u5408\u4fee\u9970\u7b26\uff0c\u4ece\u800c\u663e\u793a\u6392\u9664\u4e0d\u60f3\u8981\u7684\u6807\u7b7e\uff0c\u800c\u5c3d\u53ef\u80fd\u4fdd\u7559\u4e0b\u4e00\u4e9b\u4f60\u4e0d\u786e\u5b9a\u662f\u5426\u9700\u8981\u5220\u9664\u7684\u6807\u7b7e\uff1a</p> <pre><code>sum without(instance, type) (rate(errors_total{job=\"my-job\"}[5m])) &gt; 10\n</code></pre> <p>\u8fd9\u6837\uff0c\u805a\u5408\u65f6\u4f60\u6ca1\u6709\u660e\u786e\u6307\u5b9a\u5220\u9664\u7684\u6807\u7b7e\u5728 Alertmanager \u4e2d\u4ecd\u7136\u53ef\u4ee5\u4f7f\u7528\uff0c\u8fd9\u5bf9\u4e8e\u544a\u8b66\u7684\u805a\u5408\u548c\u8def\u7531\u975e\u5e38\u6709\u7528\uff0c\u4e5f\u80fd\u5e2e\u52a9\u4f60\u66f4\u597d\u4e86\u89e3\u62a5\u8b66\u7684\u6765\u6e90\u3002</p>"},{"location":"chap8/9promql_6errors/#3","title":"\u9519\u8bef 3\uff1a\u4f7f\u7528\u65e0\u4efb\u4f55\u9650\u5b9a\u8303\u56f4\u7684\u9009\u62e9\u5668","text":"<p>\u5728\u7f16\u5199 PromQL \u67e5\u8be2\uff08\u5c24\u5176\u662f\u544a\u8b66\uff09\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u683c\u5916\u5c0f\u5fc3\uff0c\u5e94\u8be5\u4ece\u5173\u5fc3\u7684\u4e1a\u52a1\u6216\u670d\u52a1\u7684\u6570\u636e\u4e2d\u8fdb\u884c\u67e5\u8be2\uff0c\u800c\u4e0d\u662f\u5168\u5c40\u8303\u56f4\u3002</p> <p>\u56e0\u4e3a\u4e0d\u540c\u7684\u4e1a\u52a1\u53ef\u80fd\u4f7f\u7528\u4e86\u76f8\u540c\u7684\u6307\u6807\u540d\u79f0\uff0c\u5b83\u4eec\u751a\u81f3\u8868\u8fbe\u4e86\u4e0d\u540c\u7684\u542b\u4e49\uff0c\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0c\u76f8\u540c\u6307\u6807\u540d\u79f0\u7684\u670d\u52a1\u4f1a\u8d8a\u6765\u8d8a\u591a\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5f71\u54cd\u5230\u4f60\u7684\u544a\u8b66\u89c4\u5219\u6216\u8005\u4eea\u8868\u76d8\u6570\u636e\u3002</p> <p>\u4e3a\u907f\u514d\u4e0d\u5c0f\u5fc3\u4ece\u4e0d\u76f8\u5173\u7684\u4efb\u52a1\u6216\u8005\u670d\u52a1\u4e2d\u67e5\u8be2\u6570\u636e\uff0c\u6211\u4eec\u4e00\u822c\u4f7f\u7528 job \u6807\u7b7e\u6765\u9650\u5b9a\u9009\u62e9\u5668\u7684\u8303\u56f4\uff0c\u786e\u4fdd\u5176\u67e5\u8be2\u7684\u6570\u636e\u90fd\u662f\u4f60\u5173\u5fc3\u7684\u4e1a\u52a1\u6216\u670d\u52a1\u3002</p> <p>\u4f8b\u5982\uff0c\u4ee5\u4e0b\u67e5\u8be2\u5c31\u662f\u4e00\u4e2a\u4e0d\u5b89\u5168\u7684\u88f8\u9009\u62e9\u5668\uff0c\u5b83\u53ef\u80fd\u4f1a\u4ece\u4f60\u4e0d\u671f\u671b\u7684\u5176\u4ed6 job \u4e2d\u9009\u62e9\u5177\u6709\u76f8\u540c\u6307\u6807\u540d\u7684\u6570\u636e\uff1a</p> <pre><code>rate(errors_total[5m]) &gt; 10\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528<code>{job=\"my-job\"}</code>\u7684\u9009\u62e9\u5668\u4ece\u800c\u5c06\u6307\u6807\u9650\u5b9a\u5728 my-job \u670d\u52a1\u8303\u56f4\uff1a</p> <pre><code>rate(errors_total{job=\"my-job\"}[5m]) &gt; 10\n</code></pre> <p>\u8fd9\u663e\u7136\u662f\u4e00\u4e2a\u66f4\u5b89\u5168\u7684\u65b9\u5f0f\uff0c\u5b83\u53ef\u4ee5\u6709\u6548\u907f\u514d\u4ece\u65e0\u5173\u670d\u52a1\u4e2d\u67e5\u8be2\u6570\u636e\uff0c\u5bf9\u4f60\u544a\u8b66\u4ea7\u751f\u5e72\u6270\uff0c\u4e5f\u80fd\u5927\u5927\u63d0\u5347\u67e5\u8be2\u6027\u80fd\u3002</p>"},{"location":"chap8/9promql_6errors/#4-for","title":"\u9519\u8bef 4\uff1a\u544a\u8b66\u89c4\u5219\u6ca1\u6709\u4f7f\u7528 for \u5b57\u6bb5","text":"<p>for \u5b57\u6bb5\u4e3b\u8981\u7528\u4e8e\u544a\u8b66\u89c4\u5219\u8bc4\u4f30\uff0c\u5b83\u5141\u8bb8\u4f60\u80fd\u591f\u6307\u5b9a\u4efb\u610f\u544a\u8b66\u9700\u8981\u5728\u8fde\u7eed\u7684\u89c4\u5219\u8bc4\u4f30\u5468\u671f\u4e2d\u51fa\u73b0\u591a\u957f\u65f6\u95f4\u624d\u4ece pending \u72b6\u6001\u53d8\u4e3a firing\uff0c\u5927\u591a\u6570\u544a\u8b66\u89c4\u5219\u53ef\u80fd\u6211\u4eec\u53ef\u4ee5\u5ffd\u7565\u8be5\u5b57\u6bb5\uff0c\u53ea\u9700\u8981\u4e24\u4e2a\u8bc4\u4f30\u5468\u671f\u5373\u53ef\u89e6\u53d1\u544a\u8b66\uff0c\u4f46\u6709\u65f6\uff0c\u6211\u4eec\u4e3a\u4e86\u6392\u9664\u6296\u52a8\u7684\u5e72\u6270\uff0c\u6bd4\u5982\u4e00\u4e9b CPU \u4f7f\u7528\u7387\uff0c\u6216\u8005\u67d0\u4e2a\u8282\u70b9\u56e0\u4e3a\u4e00\u4e24\u6b21\u6293\u53d6\u5f02\u5e38\u5c31\u5224\u5b9a down \u4e86</p> <p>\u5982\u4e0b\u8b66\u62a5\u89c4\u5219\uff0c\u5b83\u4f7f\u7528 up \u6307\u6807\u6765\u67e5\u627e\u65e0\u6cd5\u6210\u529f\u6293\u53d6\u7684\u76ee\u6807\uff0c\u5e76\u7701\u7565\u4e86\u53ef\u9009\u7684 for \u4fee\u9970\u7b26</p> <pre><code>alert: InstanceDown\nexpr: up == 0\n</code></pre> <p>\u4e00\u6b21\u5931\u8d25\u7684\u6293\u53d6\uff08\u5f88\u5bb9\u6613\u53d1\u751f\uff09\u5c06\u5bfc\u81f4\u89e6\u53d1\u6b64\u89c4\u5219\uff0c\u901a\u5e38\u4f60\u5e0c\u671b\u8ba9\u4f60\u7684\u8b66\u62a5\u89c4\u5219\u4e0d\u90a3\u4e48\u5bb9\u6613\u89e6\u53d1\uff0c\u5e76\u81f3\u5c11\u7b49\u5f85\u51e0\u5206\u949f\uff0c\u770b\u770b\u95ee\u9898\u662f\u5426\u771f\u7684\u5b58\u5728\uff0c\u7136\u540e\u518d\u89e6\u53d1\u901a\u77e5</p> <pre><code>alert: InstanceDown\nexpr: up == 0\nfor: 5m  # \u4e00\u4e2a\u5b9e\u4f8b\u53ea\u6709\u771f\u7684\u6302\u6389\u6216\u8005\u65e0\u6cd5\u8bbf\u95ee\u957f\u8fbe 5 \u5206\u949f\u624d\u521b\u5efa\u544a\u8b66\u4fe1\u606f\n</code></pre> <p>\u4e0d\u5e26 for \u9488\u5bf9\u4e00\u4e9b\u5185\u7f6e\u7684\u5e26\u6709\u5e73\u5747\u6570\u8ba1\u7b97\u7684\u67e5\u8be2\u8868\u8fbe\u5f0f\u4e5f\u540c\u6837\u6709\u95ee\u9898\uff0c\u4f8b\u5982\u8868\u793a\u9ad8\u9519\u8bef\u7387\u7684\u544a\u8b66\uff1a</p> <pre><code>alert: HighErrorRate\nexpr: rate(my_errors_total{job=\"my-job\"}[5m]) &gt; 10\n</code></pre> <p>\u8fd9\u4e2a\u89c4\u5219\u5c06\u5728\u7b2c\u4e00\u6b21\u67e5\u8be2\u5230\u6700\u8fd1 5m \u4e2d\u8be5\u9519\u8bef\u6570\u7684\u5e73\u5747\u503c &gt; 10 \u5c31\u7acb\u5373\u521b\u5efa\u544a\u8b66\uff0c\u867d\u7136 5m \u7684\u5e73\u5747\u5468\u671f\u80fd\u591f\u5e26\u6765\u4e00\u5b9a\u7684\u7a33\u5065\u6027\uff0c\u4f46\u662f\u7531\u4e8e Promtheus <code>rate()</code> \u7279\u6027\uff0c\u6211\u4eec\u8003\u8651\u4e00\u4e0b\uff0c\u4e00\u4e2a\u5b8c\u5168\u65b0\u7684\u670d\u52a1\u6216\u8005\u4e00\u6bb5\u65f6\u95f4\u672a\u6536\u96c6\u5230\u6570\u636e\u4f1a\u53d1\u751f\u4ec0\u4e48</p> <ul> <li>5 \u5206\u949f\u7684 rate() \u7a97\u53e3\u53ea\u4f1a\u8003\u8651\u4e00\u4e9b\u6700\u8fd1\u7684\u6837\u672c\uff0c\u5b9e\u9645\u4e0a\u5e76\u4e0d\u4f1a\u5bf9\u4e94\u5206\u949f\u7684\u6570\u636e\u8fdb\u884c\u5e73\u5747\u3002</li> <li>\u65f6\u95f4\u5e8f\u5217\u751a\u81f3\u6839\u672c\u8fd8\u6ca1\u4e94\u5206\u949f\u6570\u636e\uff0c\u8be5\u89c4\u5219\u4e5f\u53ef\u80fd\u4f1a\u7acb\u5373\u521b\u5efa\u544a\u8b66\u3002</li> </ul> <p>\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 for \u4fee\u9970\u7b26\u6765\u89e3\u51b3\u6b64\u95ee\u9898\uff1a</p> <pre><code>alert: HighErrorRate\nexpr: rate(my_errors_total{job=\"my-job\"}[5m]) &gt; 10\nfor: 5m\n</code></pre> <p>\u51e0\u4e4e\u5927\u591a\u6570\u7684\u544a\u8b66\u89c4\u5219\u90fd\u53ef\u4ee5\u6dfb\u52a0\u6b64\u53c2\u6570\uff0c\u4ece\u800c\u4f7f\u62a5\u8b66\u89c4\u5219\u66f4\u52a0\u7a33\u5065\uff0c\u4f46\u8bf7\u8bb0\u4f4f\uff0c\u8fd9\u4e5f\u4f1a\u5bfc\u81f4\u8b66\u62a5\u7684\u53cd\u5e94\u65f6\u95f4\u53d8\u6162\uff0c\u56e0\u6b64\u9700\u8981\u627e\u5230\u4e00\u4e2a\u5e73\u8861\u70b9\u3002</p>"},{"location":"chap8/9promql_6errors/#5rate","title":"\u9519\u8bef 5\uff1arate() \u7a97\u53e3\u65f6\u95f4\u592a\u77ed","text":"<p>\u5728\u592a\u77ed\u7684\u65f6\u95f4\u7a97\u53e3\u5185\u8ba1\u7b97\u901f\u7387\u65f6\uff0c\u5f97\u5230\u7684\u56fe\u8868\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e0d\u8fde\u7eed\u4e2d\u65ad\u7684\u60c5\u51b5\uff0c\u4f8b\u5982 <code>rate(my_counter[1m])\uff1frate()</code> \u548c\u5176\u4ed6 PromQL \u51fd\u6570\uff08\u5982 <code>increase()</code>\u3001<code>irate()</code>\u3001<code>deriv()</code>\uff09\u544a\u8bc9\u4f60\u65f6\u95f4\u5e8f\u5217\u5728\u7ed9\u5b9a\u65f6\u95f4\u7a97\u53e3\u5185\u4e0a\u5347\u6216\u4e0b\u964d\u7684\u901f\u5ea6\uff0c\u5728\u8f93\u5165\u65f6\u95f4\u7a97\u53e3\u4e0b\u81f3\u5c11\u9700\u8981\u4e24\u4e2a\u6837\u672c\uff0c\u4ece\u800c\u80fd\u591f\u544a\u8bc9\u4f60\u8fd9\u4e24\u4e2a\u6837\u672c\u4e4b\u95f4\u7684\u5e8f\u5217\u662f\u5982\u4f55\u53d1\u5c55\u7684\u3002\u5982\u679c\u5c06\u65f6\u95f4\u7a97\u53e3\u8bbe\u7f6e\u5f97\u592a\u5c0f\uff0c\u5219\u5728\u8be5\u7a97\u53e3\u4e0b\u53ef\u80fd\u53ea\u6709\u4e00\u4e2a\u6216\u96f6\u4e2a\u6837\u672c\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8f93\u51fa\u7ed3\u679c\u4e3a\u7a7a\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u91c7\u7528 20s \u7684\u65f6\u95f4\u7a97\u53e3\u5bf9\u4e00\u4e2a 15s \u6293\u53d6\u95f4\u9694\u7684\u6307\u6807\u8fdb\u884c rate()\uff0c\u90a3\u4e48\u5728\u8fd9 20 \u79d2\u65f6\u95f4\u7a97\u53e3\u5185\u5f88\u53ef\u80fd\u4e0d\u4f1a\u6db5\u76d6\u4e24\u4e2a\u6837\u672c\uff0c\u56e0\u6b64\u4f60\u4f1a\u5f97\u5230\u4e00\u4e2a\u4e0e\u5b9e\u9645\u7ed3\u679c\u5dee\u5f02\u5f88\u5927\u7684\u6bd4\u7387\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u91c7\u53d6\u66f4\u6781\u7aef\u7684\u505a\u6cd5\uff1a\u5982\u679c\u5c06 rate \u7a97\u53e3\u7f29\u5c0f\u5230 16s\uff0c\u5f53\u4e24\u4e2a\u76f8\u8ddd 15s \u7684\u70b9\u6070\u597d\u843d\u5728\u4efb\u610f\u5bf9\u9f50\u7684 16s \u7a97\u53e3\u4e2d\u65f6\uff0c\u5219\u53ea\u4f1a\u5076\u5c14\u5f97\u5230\u4e00\u4e2a\u8f93\u51fa\u70b9\uff1a</p> <p></p> <p></p> <p>\u5f53\u4f7f\u7528 Grafana \u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>$__rate_interval</code> \u6a21\u677f\u53d8\u91cf\u81ea\u52a8\u4e3a\u4f60\u9009\u62e9\u4e00\u4e2a\u5b89\u5168\u7684\u95f4\u9694\u3002</p>"},{"location":"chap8/9promql_6errors/#6rate","title":"\u9519\u8bef 6\uff1arate() \u76f8\u5173\u51fd\u6570\u7528\u9519\u4e86\u6307\u6807\u7c7b\u578b","text":"<p>\u867d\u7136 PromQL \u5728\u5176\u4ed6\u4e00\u4e9b\u65b9\u9762\u662f\u9759\u6001\u7c7b\u578b\u7684\uff0c\u4f46\u5b83\u4e0d\u80fd\u76f4\u63a5\u544a\u8bc9\u4f60\uff0c\u4f60\u662f\u5426\u628a\u9519\u8bef\u7684\u6307\u6807\u7c7b\u578b\u4f20\u5165\u4e86\u4e00\u4e2a\u4e0d\u662f\u4e3a\u5904\u7406\u5b83\u800c\u8bbe\u8ba1\u7684\u51fd\u6570\u3002</p>"},{"location":"chap8/9promql_6errors/#rate-gauge","title":"rate() \u51fd\u6570\u7528\u5728 gauge \u7c7b\u578b\u6307\u6807","text":"<p>rate()\u3001irate() \u548c increase() \u51fd\u6570\u88ab\u8bbe\u8ba1\u6210\u4e3a\u4ec5\u9002\u7528\u4e8e Counter \u7c7b\u578b\u6307\u6807\uff0cCounter \u7c7b\u578b\u662f\u8ffd\u8e2a\u7d2f\u8ba1\u8ba1\u6570\u7684\u6307\u6807\uff0c\u8fd9\u4e9b\u8ba1\u6570\u53ea\u4f1a\u4e0a\u5347\uff08\u6c38\u8fdc\u4e0d\u4f1a\u4e0b\u964d\uff09\uff0c\u9664\u4e86\u5728\u8ffd\u8e2a\u8fc7\u7a0b\u4e2d\u5076\u5c14\u56e0\u4e3a\u91cd\u542f\u800c\u91cd\u7f6e\u4e3a 0\u3002</p> <p>\u4e3a\u4e86\u5728 rate \u8ba1\u7b97\u4e2d\u5c3d\u53ef\u80fd\u6d88\u9664\u8ba1\u6570\u5668\u91cd\u7f6e\u7684\u5f71\u54cd\uff0c\u8fd9\u4e9b\u51fd\u6570\u5c1d\u8bd5\u5c06\u63d0\u4f9b\u7684\u65f6\u95f4\u7a97\u53e3\u5185\u6837\u672c\u7684\u503c\u7684\u4efb\u4f55\u51cf\u5c0f\u90fd\u89e3\u91ca\u4e3a\u91cd\u7f6e\u5e76\u5bf9\u5176\u8fdb\u884c\u8865\u507f\u3002</p> <p>\u8fd9\u79cd\u8ba1\u6570\u5668\u7684\u91cd\u7f6e\u68c0\u6d4b\u548c\u8865\u507f\u610f\u5473\u7740\u4f60\u53ea\u80fd\u4ece\u8fd9\u4e9b\u51fd\u6570\u4e2d\u83b7\u5f97\u6b63\u6570\u7684\u7ed3\u679c\uff08\u6216 0\uff09\u3002\u5982\u679c\u4f60\u4e0d\u5c0f\u5fc3\u4f20\u5165\u4e86\u4e00\u4e2a\u53ef\u4ee5\u81ea\u7136\u4e0a\u5347\u548c\u4e0b\u964d\u7684\u6307\u6807\uff08\u6bd4\u5982\u5185\u5b58\u4f7f\u7528\u91cf\uff09\uff0cPromQL \u5c06\u65e0\u6cd5\u5224\u65ad\u8fd9\u4e2a\u9519\u8bef\uff0c\u800c\u53ea\u4f1a\u8fd4\u56de\u4e00\u4e2a\u4e0d\u6b63\u786e\u7684\u8f93\u51fa\u503c\u3002\u8fd9\u662f\u56e0\u4e3a\u6bcf\u6b21\u4f60\u7684\u4eea\u8868\u6307\u6807\u4e0b\u964d\u65f6\uff0crate() \u90fd\u4f1a\u5c06\u5176\u7406\u89e3\u4e3a\u8ba1\u6570\u5668\u91cd\u7f6e\u5e76\u4e14\u4f1a\u9519\u8bef\u5730\u201c\u7ea0\u6b63\u201d\u5b83\u3002</p>"},{"location":"chap8/9promql_6errors/#deriv-counter","title":"deriv() \u51fd\u6570\u7528\u5728 counter \u7c7b\u578b\u6307\u6807","text":"<p>\u4f60\u53ef\u4ee5\u8ba4\u4e3a deriv() \u51fd\u6570\u5927\u81f4\u7b49\u540c\u4e8e rate()\uff0c\u4f46\u5b83\u4f5c\u7528\u4e8e Gauge \u7c7b\u578b\uff0cderiv() \u544a\u8bc9\u4f60\u5728\u8f93\u5165\u65f6\u95f4\u7a97\u53e3\u5185 Gauge \u7c7b\u578b\u6307\u6807\u6bcf\u79d2\u4e0a\u5347\u6216\u4e0b\u964d\u7684\u901f\u5ea6\u3002</p> <p>\u867d\u7136\u5e76\u4e0d\u5e38\u89c1\uff0c\u4f46\u8fd9\u91cc\u4e0e rate() \u76f8\u540c\u7684\u9677\u9631\u53ef\u80fd\u4f1a\u7ed9\u4f60\u5e26\u6765\u53e6\u5916\u7684\u56f0\u6270\uff1a\u56e0\u4e3a deriv() \u51fd\u6570\u6ca1\u6709\u5b9e\u73b0\u4efb\u4f55\u56f4\u7ed5 Counter \u7c7b\u578b\u91cd\u7f6e\u7684\u903b\u8f91\uff0c\u8bd5\u56fe\u4f7f\u7528 deriv() \u8ba1\u7b97\u4e00\u4e2a\u5728\u63d0\u4f9b\u7684\u7a97\u53e3\u4e0b\u6709\u91cd\u7f6e\u7684 Counter \u7684\u7c7b\u578b\u6307\u6807\uff0c\u5c31\u4f1a\u5f97\u5230\u4e00\u4e2a\u4e0d\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u6709\u65f6\u751a\u81f3\u662f\u4e00\u4e2a\u8d1f\u6570\u3002</p>"},{"location":"chap8/9promql_6errors/#_1","title":"\u5982\u4f55\u907f\u514d\u4f20\u5165\u9519\u8bef\u7c7b\u578b\u7684\u6307\u6807\uff1f","text":"<p>\u7531\u4e8e PromQL \u65e0\u6cd5\u81ea\u52a8\u68c0\u6d4b\u8fd9\u79cd\u4e0d\u6b63\u786e\u7684\u7528\u6cd5\uff0c\u6240\u4ee5\u5728\u4f7f\u7528\u8fd9\u4e9b\u51fd\u6570\u65f6\u5fc5\u987b\u683c\u5916\u5c0f\u5fc3\uff0c\u6211\u4eec\u9664\u4e86\u7ecf\u9a8c\u548c\u5df2\u6709\u77e5\u8bc6\u5916\uff0c\u8fd8\u53ef\u4ee5\u4f9d\u8d56\u4e00\u4e9b\u5f00\u6e90\u9879\u76ee\uff0c\u4f8b\u5982 PromLens \u67e5\u8be2\u6784\u5efa\u5668\u8fd9\u6837\u7684\u5de5\u5177\u6765\u8f85\u52a9\u68c0\u6d4b\u662f\u5426\u4f20\u4e86\u9519\u8bef\u7684\u6307\u6807\u7c7b\u578b\uff1a</p> <p></p>"},{"location":"chap9/10Elasticsearch/","title":"8. Elasticsearch: <code>elasticsearch_exporter</code>","text":"<p>https://github.com/justwatchcom/elasticsearch_exporter</p>"},{"location":"chap9/10Elasticsearch/#1-elastic-heap-usage-too-high","title":"1. Elastic Heap Usage Too High","text":"<p>The heap usage is over 90% for 5m</p> <pre><code>- alert: ElasticHeapUsageTooHigh\n  expr: (elasticsearch_jvm_memory_used_bytes{area=\"heap\"} / elasticsearch_jvm_memory_max_bytes{area=\"heap\"}) * 100 &gt; 90\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Elastic Heap Usage Too High (instance {{ $labels.instance }})\"\n    description: \"The heap usage is over 90% for 5m\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#2-elastic-heap-usage-warning","title":"2. Elastic Heap Usage warning","text":"<p>The heap usage is over 80% for 5m</p> <pre><code>- alert: ElasticHeapUsageWarning\n  expr: (elasticsearch_jvm_memory_used_bytes{area=\"heap\"} / elasticsearch_jvm_memory_max_bytes{area=\"heap\"}) * 100 &gt; 80\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Elastic Heap Usage warning (instance {{ $labels.instance }})\"\n    description: \"The heap usage is over 80% for 5m\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#3-elasticsearch-disk-out-of-space","title":"3. Elasticsearch disk out of space","text":"<p>The disk usage is over 90%</p> <pre><code>  - alert: ElasticsearchDiskOutOfSpace\n    expr: elasticsearch_filesystem_data_available_bytes / elasticsearch_filesystem_data_size_bytes * 100 &lt; 10\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Elasticsearch disk out of space (instance {{ $labels.instance }})\n      description: \"The disk usage is over 90%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#4-elasticsearch-disk-space-low","title":"4. Elasticsearch disk space low","text":"<p>The disk usage is over 80%</p> <pre><code>  - alert: ElasticsearchDiskSpaceLow\n    expr: elasticsearch_filesystem_data_available_bytes / elasticsearch_filesystem_data_size_bytes * 100 &lt; 20\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Elasticsearch disk space low (instance {{ $labels.instance }})\n      description: \"The disk usage is over 80%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n\n</code></pre>"},{"location":"chap9/10Elasticsearch/#5-elastic-cluster-red","title":"5. Elastic Cluster Red","text":"<p>Elastic Cluster Red status</p> <pre><code>- alert: ElasticClusterRed\n  expr: elasticsearch_cluster_health_status{color=\"red\"} == 1\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Elastic Cluster Red (instance {{ $labels.instance }})\"\n    description: \"Elastic Cluster Red status\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#6-elastic-cluster-yellow","title":"6. Elastic Cluster Yellow","text":"<p>Elastic Cluster Yellow status</p> <pre><code>- alert: ElasticClusterYellow\n  expr: elasticsearch_cluster_health_status{color=\"yellow\"} == 1\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Elastic Cluster Yellow (instance {{ $labels.instance }})\"\n    description: \"Elastic Cluster Yellow status\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#7-elasticsearch-healthy-nodes","title":"7. Elasticsearch Healthy Nodes","text":"<p>Missing node in Elasticsearch cluster</p> <pre><code>  - alert: ElasticsearchHealthyNodes\n    expr: elasticsearch_cluster_health_number_of_nodes &lt; 3\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Elasticsearch Healthy Nodes (instance {{ $labels.instance }})\n      description: \"Missing node in Elasticsearch cluster\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#8-number-of-elastic-healthy-nodes","title":"8. Number of Elastic Healthy Nodes","text":"<p>Number Healthy Nodes less then <code>number_of_nodes</code></p> <pre><code>- alert: NumberOfElasticHealthyNodes\n  expr: elasticsearch_cluster_health_number_of_nodes &lt; number_of_nodes\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Number of Elastic Healthy Nodes (instance {{ $labels.instance }})\"\n    description: \"Number Healthy Nodes less then number_of_nodes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#9-elasticsearch-relocating-shards","title":"9. Elasticsearch relocating shards","text":"<p>Elasticsearch is relocating shards</p> <pre><code>  - alert: ElasticsearchRelocatingShards\n    expr: elasticsearch_cluster_health_relocating_shards &gt; 0\n    for: 0m\n    labels:\n      severity: info\n    annotations:\n      summary: Elasticsearch relocating shards (instance {{ $labels.instance }})\n      description: \"Elasticsearch is relocating shards\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#10-elasticsearch-relocating-shards-too-long","title":"10. Elasticsearch relocating shards too long","text":"<p>Elasticsearch has been relocating shards for 15min</p> <pre><code>    - alert: ElasticsearchRelocatingShardsTooLong\n    expr: elasticsearch_cluster_health_relocating_shards &gt; 0\n    for: 15m\n    labels:\n      severity: warning\n    annotations:\n      summary: Elasticsearch relocating shards too long (instance {{ $labels.instance }})\n      description: \"Elasticsearch has been relocating shards for 15min\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#11-elasticsearch-initializing-shards","title":"11. Elasticsearch initializing shards","text":"<p>Elasticsearch is initializing shards</p> <pre><code>  - alert: ElasticsearchInitializingShards\n    expr: elasticsearch_cluster_health_initializing_shards &gt; 0\n    for: 0m\n    labels:\n      severity: info\n    annotations:\n      summary: Elasticsearch initializing shards (instance {{ $labels.instance }})\n      description: \"Elasticsearch is initializing shards\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#12-elasticsearch-initializing-shards-too-long","title":"12. Elasticsearch initializing shards too long","text":"<p>Elasticsearch has been initializing shards for 15 min</p> <pre><code>  - alert: ElasticsearchInitializingShardsTooLong\n    expr: elasticsearch_cluster_health_initializing_shards &gt; 0\n    for: 15m\n    labels:\n      severity: warning\n    annotations:\n      summary: Elasticsearch initializing shards too long (instance {{ $labels.instance }})\n      description: \"Elasticsearch has been initializing shards for 15 min\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#13-elasticsearch-unassigned-shards","title":"13. Elasticsearch unassigned shards","text":"<p>Elasticsearch has unassigned shards</p> <pre><code>  - alert: ElasticsearchUnassignedShards\n    expr: elasticsearch_cluster_health_unassigned_shards &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Elasticsearch unassigned shards (instance {{ $labels.instance }})\n      description: \"Elasticsearch has unassigned shards\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#14-elasticsearch-pending-tasks","title":"14. Elasticsearch pending tasks","text":"<p>Elasticsearch has pending tasks. Cluster works slowly.</p> <pre><code>  - alert: ElasticsearchPendingTasks\n    expr: elasticsearch_cluster_health_number_of_pending_tasks &gt; 0\n    for: 15m\n    labels:\n      severity: warning\n    annotations:\n      summary: Elasticsearch pending tasks (instance {{ $labels.instance }})\n      description: \"Elasticsearch has pending tasks. Cluster works slowly.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#15-elasticsearch-no-new-documents","title":"15 Elasticsearch no new documents","text":"<p>No new documents for 10 min!</p> <pre><code>  - alert: ElasticsearchNoNewDocuments\n    expr: increase(elasticsearch_indices_docs{es_data_node=\"true\"}[10m]) &lt; 1\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Elasticsearch no new documents (instance {{ $labels.instance }})\n      description: \"No new documents for 10 min!\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#16-number-of-pending-tasks","title":"16. Number of pending tasks","text":"<p>Number of pending tasks for 10 min. Cluster works slowly.</p> <pre><code>- alert: NumberOfPendingTasks\n  expr: elasticsearch_cluster_health_number_of_pending_tasks &gt; 0\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Number of pending tasks (instance {{ $labels.instance }})\"\n    description: \"Number of pending tasks for 10 min. Cluster works slowly.\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/10Elasticsearch/#17-number-of-elastic-healthy-data-nodes","title":"17. Number of Elastic Healthy Data Nodes","text":"<p>Number Healthy Data Nodes less then <code>number_of_data_nodes</code></p> <pre><code>- alert: NumberOfElasticHealthyDataNodes\n  expr: elasticsearch_cluster_health_number_of_data_nodes &lt; number_of_data_nodes\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Number of Elastic Healthy Data Nodes (instance {{ $labels.instance }})\"\n    description: \"Number Healthy Data Nodes less then number_of_data_nodes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/","title":"9.Cassandra <code>cassandra_exporter</code>","text":""},{"location":"chap9/11Cassandra/#1instaclustrcassandra_exporter","title":"1.instaclustr/cassandra_exporter","text":""},{"location":"chap9/11Cassandra/#91-cassandra-node-is-unavailable","title":"9.1. Cassandra Node is unavailable","text":"<p>Cassandra Node is unavailable - <code>{{ $labels.cassandra_cluster }} {{ $labels.exported_endpoint }}</code></p> <pre><code>  - alert: CassandraNodeIsUnavailable\n    expr: sum(cassandra_endpoint_active) by (cassandra_cluster,instance,exported_endpoint) &lt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra Node is unavailable (instance {{ $labels.instance }})\n      description: \"Cassandra Node is unavailable - {{ $labels.cassandra_cluster }} {{ $labels.exported_endpoint }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#92-cassandra-many-compaction-tasks-are-pending","title":"9.2 Cassandra many compaction tasks are pending","text":"<p>Many Cassandra compaction tasks are pending - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraManyCompactionTasksArePending\n    expr: cassandra_table_estimated_pending_compactions &gt; 100\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra many compaction tasks are pending (instance {{ $labels.instance }})\n      description: \"Many Cassandra compaction tasks are pending - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#93-cassandra-commitlog-pending-tasks","title":"9.3 Cassandra commitlog pending tasks","text":"<p>Cassandra commitlog pending tasks - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraCommitlogPendingTasks\n    expr: cassandra_commit_log_pending_tasks &gt; 15\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra commitlog pending tasks (instance {{ $labels.instance }})\n      description: \"Cassandra commitlog pending tasks - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#94-cassandra-compaction-executor-blocked-tasks","title":"9.4 Cassandra compaction executor blocked tasks","text":"<p>Some Cassandra compaction executor tasks are blocked - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraCompactionExecutorBlockedTasks\n    expr: cassandra_thread_pool_blocked_tasks{pool=\"CompactionExecutor\"} &gt; 15\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra compaction executor blocked tasks (instance {{ $labels.instance }})\n      description: \"Some Cassandra compaction executor tasks are blocked - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#95-cassandra-flush-writer-blocked-tasks","title":"9.5 Cassandra flush writer blocked tasks","text":"<p>Some Cassandra flush writer tasks are blocked - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraFlushWriterBlockedTasks\n    expr: cassandra_thread_pool_blocked_tasks{pool=\"MemtableFlushWriter\"} &gt; 15\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra flush writer blocked tasks (instance {{ $labels.instance }})\n      description: \"Some Cassandra flush writer tasks are blocked - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#96-cassandra-connection-timeouts-total","title":"9.6 Cassandra connection timeouts total","text":"<p>Some connection between nodes are ending in timeout - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraConnectionTimeoutsTotal\n    expr: avg(cassandra_client_request_timeouts_total) by (cassandra_cluster,instance) &gt; 5\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra connection timeouts total (instance {{ $labels.instance }})\n      description: \"Some connection between nodes are ending in timeout - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#97-cassandra-storage-exceptions","title":"9.7. Cassandra storage exceptions","text":"<p>Something is going wrong with cassandra storage - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraStorageExceptions\n    expr: changes(cassandra_storage_exceptions_total[1m]) &gt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra storage exceptions (instance {{ $labels.instance }})\n      description: \"Something is going wrong with cassandra storage - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#98-cassandra-tombstone-dump","title":"9.8. Cassandra tombstone dump","text":"<p>Cassandra tombstone dump - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraTombstoneDump\n    expr: avg(cassandra_table_tombstones_scanned{quantile=\"0.99\"}) by (instance,cassandra_cluster,keyspace) &gt; 100\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra tombstone dump (instance {{ $labels.instance }})\n      description: \"Cassandra tombstone dump - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#99-cassandra-client-request-unvailable-write","title":"9.9 Cassandra client request unvailable write","text":"<p>Some Cassandra client requests are unvailable to write - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraClientRequestUnvailableWrite\n    expr: changes(cassandra_client_request_unavailable_exceptions_total{operation=\"write\"}[1m]) &gt; 0\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra client request unvailable write (instance {{ $labels.instance }})\n      description: \"Some Cassandra client requests are unvailable to write - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#910-cassandra-client-request-unvailable-read","title":"9.10 Cassandra client request unvailable read","text":"<p>Some Cassandra client requests are unvailable to read - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraClientRequestUnvailableRead\n    expr: changes(cassandra_client_request_unavailable_exceptions_total{operation=\"read\"}[1m]) &gt; 0\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra client request unvailable read (instance {{ $labels.instance }})\n      description: \"Some Cassandra client requests are unvailable to read - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#911-cassandra-client-request-write-failure","title":"9.11. Cassandra client request write failure","text":"<p>Read failures have occurred, ensure there are not too many unavailable nodes - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraClientRequestWriteFailure\n    expr: increase(cassandra_client_request_failures_total{operation=\"write\"}[1m]) &gt; 0\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra client request write failure (instance {{ $labels.instance }})\n      description: \"Read failures have occurred, ensure there are not too many unavailable nodes - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#912-cassandra-client-request-read-failure","title":"9.12. Cassandra client request read failure","text":"<p>Read failures have occurred, ensure there are not too many unavailable nodes - <code>{{ $labels.cassandra_cluster }}</code></p> <pre><code>  - alert: CassandraClientRequestReadFailure\n    expr: increase(cassandra_client_request_failures_total{operation=\"read\"}[1m]) &gt; 0\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra client request read failure (instance {{ $labels.instance }})\n      description: \"Read failures have occurred, ensure there are not too many unavailable nodes - {{ $labels.cassandra_cluster }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#2-cassandra-criteocassandra_exporter","title":"2. Cassandra : criteo/cassandra_exporter","text":""},{"location":"chap9/11Cassandra/#1-cassandra-hints-count","title":"1. Cassandra hints count","text":"<p>Cassandra hints count has changed on <code>{{ $labels.instance }}</code> some nodes may go down</p> <pre><code>  - alert: CassandraHintsCount\n    expr: changes(cassandra_stats{name=\"org:apache:cassandra:metrics:storage:totalhints:count\"}[1m]) &gt; 3\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra hints count (instance {{ $labels.instance }})\n      description: \"Cassandra hints count has changed on {{ $labels.instance }} some nodes may go down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#2-cassandra-compaction-task-pending","title":"2 Cassandra compaction task pending","text":"<p>Many Cassandra compaction tasks are pending. You might need to increase I/O capacity by adding nodes to the cluster.</p> <pre><code>  - alert: CassandraCompactionTaskPending\n    expr: avg_over_time(cassandra_stats{name=\"org:apache:cassandra:metrics:compaction:pendingtasks:value\"}[1m]) &gt; 100\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra compaction task pending (instance {{ $labels.instance }})\n      description: \"Many Cassandra compaction tasks are pending. You might need to increase I/O capacity by adding nodes to the cluster.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#3-cassandra-viewwrite-latency","title":"3. Cassandra viewwrite latency","text":"<p>High viewwrite latency on <code>{{ $labels.instance }}</code> cassandra node</p> <pre><code>  - alert: CassandraViewwriteLatency\n    expr: cassandra_stats{name=\"org:apache:cassandra:metrics:clientrequest:viewwrite:viewwritelatency:99thpercentile\",service=\"cas\"} &gt; 100000\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra viewwrite latency (instance {{ $labels.instance }})\n      description: \"High viewwrite latency on {{ $labels.instance }} cassandra node\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#4-cassandra-bad-hacker","title":"4. Cassandra bad hacker","text":"<p>Increase of Cassandra authentication failures</p> <pre><code>  - alert: CassandraBadHacker\n    expr: rate(cassandra_stats{name=\"org:apache:cassandra:metrics:client:authfailure:count\"}[1m]) &gt; 5\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra bad hacker (instance {{ $labels.instance }})\n      description: \"Increase of Cassandra authentication failures\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#5-cassandra-node-down","title":"5. Cassandra node down","text":"<p>Cassandra node down</p> <pre><code>  - alert: CassandraNodeDown\n    expr: sum(cassandra_stats{name=\"org:apache:cassandra:net:failuredetector:downendpointcount\"}) by (service,group,cluster,env) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra node down (instance {{ $labels.instance }})\n      description: \"Cassandra node down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#6-cassandra-commitlog-pending-tasks","title":"6. Cassandra commitlog pending tasks","text":"<p>Unexpected number of Cassandra commitlog pending tasks</p> <pre><code>  - alert: CassandraCommitlogPendingTasks\n    expr: cassandra_stats{name=\"org:apache:cassandra:metrics:commitlog:pendingtasks:value\"} &gt; 15\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra commitlog pending tasks (instance {{ $labels.instance }})\n      description: \"Unexpected number of Cassandra commitlog pending tasks\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#7-cassandra-compaction-executor-blocked-tasks","title":"7. Cassandra compaction executor blocked tasks","text":"<p>Some Cassandra compaction executor tasks are blocked</p> <pre><code>  - alert: CassandraCompactionExecutorBlockedTasks\n    expr: cassandra_stats{name=\"org:apache:cassandra:metrics:threadpools:internal:compactionexecutor:currentlyblockedtasks:count\"} &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra compaction executor blocked tasks (instance {{ $labels.instance }})\n      description: \"Some Cassandra compaction executor tasks are blocked\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#8-cassandra-flush-writer-blocked-tasks","title":"8. Cassandra flush writer blocked tasks","text":"<p>Some Cassandra flush writer tasks are blocked</p> <pre><code>  - alert: CassandraFlushWriterBlockedTasks\n    expr: cassandra_stats{name=\"org:apache:cassandra:metrics:threadpools:internal:memtableflushwriter:currentlyblockedtasks:count\"} &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra flush writer blocked tasks (instance {{ $labels.instance }})\n      description: \"Some Cassandra flush writer tasks are blocked\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#9-cassandra-repair-pending-tasks","title":"9. Cassandra repair pending tasks","text":"<p>Some Cassandra repair tasks are pending</p> <pre><code>  - alert: CassandraRepairPendingTasks\n    expr: cassandra_stats{name=\"org:apache:cassandra:metrics:threadpools:internal:antientropystage:pendingtasks:value\"} &gt; 2\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra repair pending tasks (instance {{ $labels.instance }})\n      description: \"Some Cassandra repair tasks are pending\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#10-cassandra-repair-blocked-tasks","title":"10. Cassandra repair blocked tasks","text":"<p>Some Cassandra repair tasks are blocked</p> <pre><code>  - alert: CassandraRepairBlockedTasks\n    expr: cassandra_stats{name=\"org:apache:cassandra:metrics:threadpools:internal:antientropystage:currentlyblockedtasks:count\"} &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cassandra repair blocked tasks (instance {{ $labels.instance }})\n      description: \"Some Cassandra repair tasks are blocked\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#11-cassandra-connection-timeouts-total","title":"11. Cassandra connection timeouts total","text":"<p>Some connection between nodes are ending in timeout</p> <pre><code>  - alert: CassandraConnectionTimeoutsTotal\n    expr: rate(cassandra_stats{name=\"org:apache:cassandra:metrics:connection:totaltimeouts:count\"}[1m]) &gt; 5\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra connection timeouts total (instance {{ $labels.instance }})\n      description: \"Some connection between nodes are ending in timeout\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#12-cassandra-storage-exceptions","title":"12. Cassandra storage exceptions","text":"<p>Something is going wrong with cassandra storage</p> <pre><code>  - alert: CassandraStorageExceptions\n    expr: changes(cassandra_stats{name=\"org:apache:cassandra:metrics:storage:exceptions:count\"}[1m]) &gt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra storage exceptions (instance {{ $labels.instance }})\n      description: \"Something is going wrong with cassandra storage\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#13-cassandra-tombstone-dump","title":"13. Cassandra tombstone dump","text":"<p>Too much tombstones scanned in queries</p> <pre><code>  - alert: CassandraTombstoneDump\n    expr: cassandra_stats{name=\"org:apache:cassandra:metrics:table:tombstonescannedhistogram:99thpercentile\"} &gt; 1000\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra tombstone dump (instance {{ $labels.instance }})\n      description: \"Too much tombstones scanned in queries\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#14-cassandra-client-request-unvailable-write","title":"14. Cassandra client request unvailable write","text":"<p>Write failures have occurred because too many nodes are unavailable</p> <pre><code>  - alert: CassandraClientRequestUnvailableWrite\n    expr: changes(cassandra_stats{name=\"org:apache:cassandra:metrics:clientrequest:write:unavailables:count\"}[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra client request unvailable write (instance {{ $labels.instance }})\n      description: \"Write failures have occurred because too many nodes are unavailable\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#15-cassandra-client-request-unvailable-read","title":"15. Cassandra client request unvailable read","text":"<p>Read failures have occurred because too many nodes are unavailable</p> <pre><code>  - alert: CassandraClientRequestUnvailableRead\n    expr: changes(cassandra_stats{name=\"org:apache:cassandra:metrics:clientrequest:read:unavailables:count\"}[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra client request unvailable read (instance {{ $labels.instance }})\n      description: \"Read failures have occurred because too many nodes are unavailable\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#16-cassandra-client-request-write-failure","title":"16. Cassandra client request write failure","text":"<p>A lot of write failures encountered. A write failure is a non-timeout exception encountered during a write request. Examine the reason map to find to the root cause. The most common cause for this type of error is when batch sizes are too large.</p> <pre><code>  - alert: CassandraClientRequestWriteFailure\n    expr: increase(cassandra_stats{name=\"org:apache:cassandra:metrics:clientrequest:write:failures:oneminuterate\"}[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra client request write failure (instance {{ $labels.instance }})\n      description: \"A lot of write failures encountered. A write failure is a non-timeout exception encountered during a write request. Examine the reason map to find to the root cause. The most common cause for this type of error is when batch sizes are too large.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#17-cassandra-client-request-read-failure","title":"17. Cassandra client request read failure","text":"<p>A lot of read failures encountered. A read failure is a non-timeout exception encountered during a read request. Examine the reason map to find to the root cause. The most common cause for this type of error is when batch sizes are too large.</p> <pre><code>  - alert: CassandraClientRequestReadFailure\n    expr: increase(cassandra_stats{name=\"org:apache:cassandra:metrics:clientrequest:read:failures:oneminuterate\"}[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra client request read failure (instance {{ $labels.instance }})\n      description: \"A lot of read failures encountered. A read failure is a non-timeout exception encountered during a read request. Examine the reason map to find to the root cause. The most common cause for this type of error is when batch sizes are too large.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/11Cassandra/#18-cassandra-cache-hit-rate-key-cache","title":"18. Cassandra cache hit rate key cache","text":"<p>Key cache hit rate is below 85%</p> <pre><code>  - alert: CassandraCacheHitRateKeyCache\n    expr: cassandra_stats{name=\"org:apache:cassandra:metrics:cache:keycache:hitrate:value\"} &lt; .85\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cassandra cache hit rate key cache (instance {{ $labels.instance }})\n      description: \"Key cache hit rate is below 85%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/12Apache/","title":"5 Apache <code>apache_exporter</code>","text":"<p>Lusitaniae/apache_exporter</p>"},{"location":"chap9/12Apache/#1-apache-down","title":"1. Apache down","text":"<p>Apache down</p> <pre><code>  - alert: ApacheDown\n    expr: apache_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Apache down (instance {{ $labels.instance }})\n      description: \"Apache down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/12Apache/#2-apache-workers-load","title":"2. Apache workers load","text":"<p>Apache workers in busy state approach the max workers count 80% workers busy on <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: ApacheWorkersLoad\n    expr: (sum by (instance) (apache_workers{state=\"busy\"}) / sum by (instance) (apache_scoreboard) ) * 100 &gt; 80\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Apache workers load (instance {{ $labels.instance }})\n      description: \"Apache workers in busy state approach the max workers count 80% workers busy on {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/12Apache/#3-apache-restart","title":"3. Apache restart","text":"<p>Apache has just been restarted.</p> <pre><code>  - alert: ApacheRestart\n    expr: apache_uptime_seconds_total / 60 &lt; 1\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Apache restart (instance {{ $labels.instance }})\n      description: \"Apache has just been restarted.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/","title":"3 HaProxy <code>haproxy_exporter</code>","text":""},{"location":"chap9/13HaProxy/#1-embedded-exporter-haproxy-v2","title":"1 Embedded exporter (HAProxy &gt;= v2)","text":""},{"location":"chap9/13HaProxy/#11haproxy-high-http-4xx-error-rate-backend","title":"1.1.HAProxy high HTTP 4xx error rate backend","text":"<p>Too many HTTP requests with status 4xx (&gt; 5%) on backend <code>{{ $labels.fqdn }}/{{ $labels.backend }}</code></p> <pre><code>  - alert: HaproxyHighHttp4xxErrorRateBackend\n    expr: ((sum by (proxy) (rate(haproxy_server_http_responses_total{code=\"4xx\"}[1m])) / sum by (proxy) (rate(haproxy_server_http_responses_total[1m]))) * 100) &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy high HTTP 4xx error rate backend (instance {{ $labels.instance }})\n      description: \"Too many HTTP requests with status 4xx (&gt; 5%) on backend {{ $labels.fqdn }}/{{ $labels.backend }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#12-haproxy-high-http-5xx-error-rate-backend","title":"1.2. HAProxy high HTTP 5xx error rate backend","text":"<p>Too many HTTP requests with status 5xx (&gt; 5%) on backend <code>{{ $labels.fqdn }}/{{ $labels.backend }}</code></p> <pre><code>  - alert: HaproxyHighHttp5xxErrorRateBackend\n    expr: ((sum by (proxy) (rate(haproxy_server_http_responses_total{code=\"5xx\"}[1m])) / sum by (proxy) (rate(haproxy_server_http_responses_total[1m]))) * 100) &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy high HTTP 5xx error rate backend (instance {{ $labels.instance }})\n      description: \"Too many HTTP requests with status 5xx (&gt; 5%) on backend {{ $labels.fqdn }}/{{ $labels.backend }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#13-haproxy-high-http-4xx-error-rate-server","title":"1.3. HAProxy high HTTP 4xx error rate server","text":"<p>Too many HTTP requests with status 4xx (&gt; 5%) on server <code>{{ $labels.server }}</code></p> <pre><code>  - alert: HaproxyHighHttp4xxErrorRateServer\n    expr: ((sum by (server) (rate(haproxy_server_http_responses_total{code=\"4xx\"}[1m])) / sum by (server) (rate(haproxy_server_http_responses_total[1m]))) * 100) &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy high HTTP 4xx error rate server (instance {{ $labels.instance }})\n      description: \"Too many HTTP requests with status 4xx (&gt; 5%) on server {{ $labels.server }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#14-haproxy-high-http-5xx-error-rate-server","title":"1.4. HAProxy high HTTP 5xx error rate server","text":"<p>Too many HTTP requests with status 5xx (&gt; 5%) on server <code>{{ $labels.server }}</code></p> <pre><code>  - alert: HaproxyHighHttp5xxErrorRateServer\n    expr: ((sum by (server) (rate(haproxy_server_http_responses_total{code=\"5xx\"}[1m])) / sum by (server) (rate(haproxy_server_http_responses_total[1m]))) * 100) &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy high HTTP 5xx error rate server (instance {{ $labels.instance }})\n      description: \"Too many HTTP requests with status 5xx (&gt; 5%) on server {{ $labels.server }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#15-haproxy-server-response-errors","title":"1.5. HAProxy server response errors","text":"<p>Too many response errors to <code>{{ $labels.server }}</code> server (&gt; 5%).</p> <pre><code>  - alert: HaproxyServerResponseErrors\n    expr: (sum by (server) (rate(haproxy_server_response_errors_total[1m])) / sum by (server) (rate(haproxy_server_http_responses_total[1m]))) * 100 &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy server response errors (instance {{ $labels.instance }})\n      description: \"Too many response errors to {{ $labels.server }} server (&gt; 5%).\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#16-haproxy-backend-connection-errors","title":"1.6. HAProxy backend connection errors","text":"<p>Too many connection errors to <code>{{ $labels.fqdn }}/{{ $labels.backend }}</code> backend (&gt; 100 req/s). Request throughput may be too high.</p> <pre><code>  - alert: HaproxyBackendConnectionErrors\n    expr: (sum by (proxy) (rate(haproxy_backend_connection_errors_total[1m]))) &gt; 100\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy backend connection errors (instance {{ $labels.instance }})\n      description: \"Too many connection errors to {{ $labels.fqdn }}/{{ $labels.backend }} backend (&gt; 100 req/s). Request throughput may be too high.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#17-haproxy-server-connection-errors","title":"1.7. HAProxy server connection errors","text":"<p>Too many connection errors to <code>{{ $labels.server }}</code> server (&gt; 100 req/s). Request throughput may be too high.</p> <pre><code>  - alert: HaproxyServerConnectionErrors\n    expr: (sum by (proxy) (rate(haproxy_server_connection_errors_total[1m]))) &gt; 100\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy server connection errors (instance {{ $labels.instance }})\n      description: \"Too many connection errors to {{ $labels.server }} server (&gt; 100 req/s). Request throughput may be too high.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#18-haproxy-backend-max-active-session-80","title":"1.8. HAProxy backend max active session &gt; 80%","text":"<p>Session limit from backend <code>{{ $labels.proxy }}</code> to server <code>{{ $labels.server }}</code> reached 80% of limit - <code>{{ $value | printf \"%.2f\"}}%</code></p> <pre><code>  - alert: HaproxyBackendMaxActiveSession&gt;80%\n    expr: ((haproxy_server_max_sessions &gt;0) * 100) / (haproxy_server_limit_sessions &gt; 0) &gt; 80\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy backend max active session &gt; 80% (instance {{ $labels.instance }})\n      description: \"Session limit from backend {{ $labels.proxy }} to server {{ $labels.server }} reached 80% of limit - {{ $value | printf \\\"%.2f\\\"}}%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#19-haproxy-pending-requests","title":"1.9. HAProxy pending requests","text":"<p>Some HAProxy requests are pending on <code>{{ $labels.proxy }} - {{ $value | printf \"%.2f\"}}</code></p> <pre><code>  - alert: HaproxyPendingRequests\n    expr: sum by (proxy) (rate(haproxy_backend_current_queue[2m])) &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy pending requests (instance {{ $labels.instance }})\n      description: \"Some HAProxy requests are pending on {{ $labels.proxy }} - {{ $value | printf \\\"%.2f\\\"}}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#110-haproxy-http-slowing-down","title":"1.10. HAProxy HTTP slowing down","text":"<p>Average request time is increasing - <code>{{ $value | printf \"%.2f\"}}</code></p> <pre><code>  - alert: HaproxyHttpSlowingDown\n    expr: avg by (proxy) (haproxy_backend_max_total_time_seconds) &gt; 1\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy HTTP slowing down (instance {{ $labels.instance }})\n      description: \"Average request time is increasing - {{ $value | printf \\\"%.2f\\\"}}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#111-haproxy-retry-high","title":"1.11. HAProxy retry high","text":"<p>High rate of retry on <code>{{ $labels.proxy }} - {{ $value | printf \"%.2f\"}}</code></p> <pre><code>  - alert: HaproxyRetryHigh\n    expr: sum by (proxy) (rate(haproxy_backend_retry_warnings_total[1m])) &gt; 10\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy retry high (instance {{ $labels.instance }})\n      description: \"High rate of retry on {{ $labels.proxy }} - {{ $value | printf \\\"%.2f\\\"}}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#112-haproxy-has-no-alive-backends","title":"1.12. HAproxy has no alive backends","text":"<p>HAProxy has no alive active or backup backends for <code>{{ $labels.proxy }}</code></p> <pre><code>  - alert: HaproxyHasNoAliveBackends\n    expr: haproxy_backend_active_servers + haproxy_backend_backup_servers == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAproxy has no alive backends (instance {{ $labels.instance }})\n      description: \"HAProxy has no alive active or backup backends for {{ $labels.proxy }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#113-haproxy-frontend-security-blocked-requests","title":"1.13. HAProxy frontend security blocked requests","text":"<p>HAProxy is blocking requests for security reason</p> <pre><code>  - alert: HaproxyFrontendSecurityBlockedRequests\n    expr: sum by (proxy) (rate(haproxy_frontend_denied_connections_total[2m])) &gt; 10\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy frontend security blocked requests (instance {{ $labels.instance }})\n      description: \"HAProxy is blocking requests for security reason\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#114-haproxy-server-healthcheck-failure","title":"1.14. HAProxy server healthcheck failure","text":"<p>Some server healthcheck are failing on <code>{{ $labels.server }}</code></p> <pre><code>  - alert: HaproxyServerHealthcheckFailure\n    expr: increase(haproxy_server_check_failures_total[1m]) &gt; 0\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy server healthcheck failure (instance {{ $labels.instance }})\n      description: \"Some server healthcheck are failing on {{ $labels.server }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#2-haproxy-prometheushaproxy_exporter-haproxy-v2","title":"2 HaProxy : prometheus/haproxy_exporter (HAProxy &lt; v2)","text":""},{"location":"chap9/13HaProxy/#21-haproxy-down","title":"2.1. HAProxy down","text":"<p>HAProxy down</p> <pre><code>  - alert: HaproxyDown\n    expr: haproxy_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy down (instance {{ $labels.instance }})\n      description: \"HAProxy down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#22-haproxy-high-http-4xx-error-rate-backend","title":"2.2. HAProxy high HTTP 4xx error rate backend","text":"<p>Too many HTTP requests with status 4xx (&gt; 5%) on backend <code>{{ $labels.fqdn }}/{{ $labels.backend }}</code></p> <pre><code>  - alert: HaproxyHighHttp4xxErrorRateBackend\n    expr: sum by (backend) (rate(haproxy_server_http_responses_total{code=\"4xx\"}[1m])) / sum by (backend) (rate(haproxy_server_http_responses_total[1m]) * 100) &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy high HTTP 4xx error rate backend (instance {{ $labels.instance }})\n      description: \"Too many HTTP requests with status 4xx (&gt; 5%) on backend {{ $labels.fqdn }}/{{ $labels.backend }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#23-haproxy-high-http-5xx-error-rate-backend","title":"2.3. HAProxy high HTTP 5xx error rate backend","text":"<p>Too many HTTP requests with status 5xx (&gt; 5%) on backend <code>{{ $labels.fqdn }}/{{ $labels.backend }}</code></p> <pre><code>  - alert: HaproxyHighHttp5xxErrorRateBackend\n    expr: sum by (backend) (rate(haproxy_server_http_responses_total{code=\"5xx\"}[1m])) / sum by (backend) (rate(haproxy_server_http_responses_total[1m]) * 100) &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy high HTTP 5xx error rate backend (instance {{ $labels.instance }})\n      description: \"Too many HTTP requests with status 5xx (&gt; 5%) on backend {{ $labels.fqdn }}/{{ $labels.backend }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#24-haproxy-high-http-4xx-error-rate-server","title":"2.4. HAProxy high HTTP 4xx error rate server","text":"<p>Too many HTTP requests with status 4xx (&gt; 5%) on server <code>{{ $labels.server }}</code></p> <pre><code>  - alert: HaproxyHighHttp4xxErrorRateServer\n    expr: sum by (server) (rate(haproxy_server_http_responses_total{code=\"4xx\"}[1m])) / sum by (server) (rate(haproxy_server_http_responses_total[1m]) * 100) &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy high HTTP 4xx error rate server (instance {{ $labels.instance }})\n      description: \"Too many HTTP requests with status 4xx (&gt; 5%) on server {{ $labels.server }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#25-haproxy-high-http-5xx-error-rate-server","title":"2.5. HAProxy high HTTP 5xx error rate server","text":"<p>Too many HTTP requests with status 5xx (&gt; 5%) on server <code>{{ $labels.server }}</code></p> <pre><code>  - alert: HaproxyHighHttp5xxErrorRateServer\n    expr: sum by (server) (rate(haproxy_server_http_responses_total{code=\"5xx\"}[1m])) / sum by (server) (rate(haproxy_server_http_responses_total[1m]) * 100) &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy high HTTP 5xx error rate server (instance {{ $labels.instance }})\n      description: \"Too many HTTP requests with status 5xx (&gt; 5%) on server {{ $labels.server }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#26-haproxy-server-response-errors","title":"2.6. HAProxy server response errors","text":"<p>Too many response errors to <code>{{ $labels.server }}</code> server (&gt; 5%).</p> <pre><code>  - alert: HaproxyServerResponseErrors\n    expr: sum by (server) (rate(haproxy_server_response_errors_total[1m])) / sum by (server) (rate(haproxy_server_http_responses_total[1m]) * 100) &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy server response errors (instance {{ $labels.instance }})\n      description: \"Too many response errors to {{ $labels.server }} server (&gt; 5%).\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#27-haproxy-backend-connection-errors","title":"2.7. HAProxy backend connection errors","text":"<p>Too many connection errors to <code>{{ $labels.fqdn }}/{{ $labels.backend }}</code>backend (&gt; 100 req/s). Request throughput may be too high.</p> <pre><code>  - alert: HaproxyBackendConnectionErrors\n    expr: sum by (backend) (rate(haproxy_backend_connection_errors_total[1m])) &gt; 100\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy backend connection errors (instance {{ $labels.instance }})\n      description: \"Too many connection errors to {{ $labels.fqdn }}/{{ $labels.backend }} backend (&gt; 100 req/s). Request throughput may be too high.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#28-haproxy-server-connection-errors","title":"2.8. HAProxy server connection errors","text":"<p>Too many connection errors to <code>{{ $labels.server }}</code> server (&gt; 100 req/s). Request throughput may be too high.</p> <pre><code>  - alert: HaproxyServerConnectionErrors\n    expr: sum by (server) (rate(haproxy_server_connection_errors_total[1m])) &gt; 100\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy server connection errors (instance {{ $labels.instance }})\n      description: \"Too many connection errors to {{ $labels.server }} server (&gt; 100 req/s). Request throughput may be too high.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#29-haproxy-backend-max-active-session","title":"2.9. HAProxy backend max active session","text":"<p>HAproxy backend <code>{{ $labels.fqdn }}/{{ $labels.backend }}</code> is reaching session limit (&gt; 80%).</p> <pre><code>  - alert: HaproxyBackendMaxActiveSession\n    expr: ((sum by (backend) (avg_over_time(haproxy_backend_max_sessions[2m])) / sum by (backend) (avg_over_time(haproxy_backend_limit_sessions[2m]))) * 100) &gt; 80\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy backend max active session (instance {{ $labels.instance }})\n      description: \"HAproxy backend {{ $labels.fqdn }}/{{ $labels.backend }} is reaching session limit (&gt; 80%).\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#210-haproxy-pending-requests","title":"2.10. HAProxy pending requests","text":"<p>Some HAProxy requests are pending on <code>{{ $labels.fqdn }}/{{ $labels.backend }}</code> backend</p> <pre><code>  - alert: HaproxyPendingRequests\n    expr: sum by (backend) (haproxy_backend_current_queue) &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy pending requests (instance {{ $labels.instance }})\n      description: \"Some HAProxy requests are pending on {{ $labels.fqdn }}/{{ $labels.backend }} backend\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#211-haproxy-http-slowing-down","title":"2.11. HAProxy HTTP slowing down","text":"<p>Average request time is increasing</p> <pre><code>  - alert: HaproxyHttpSlowingDown\n    expr: avg by (backend) (haproxy_backend_http_total_time_average_seconds) &gt; 1\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy HTTP slowing down (instance {{ $labels.instance }})\n      description: \"Average request time is increasing\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#212-haproxy-retry-high","title":"2.12. HAProxy retry high","text":"<p>High rate of retry on <code>{{ $labels.fqdn }}/{{ $labels.backend }}</code> backend</p> <pre><code>  - alert: HaproxyRetryHigh\n    expr: sum by (backend) (rate(haproxy_backend_retry_warnings_total[1m])) &gt; 10\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy retry high (instance {{ $labels.instance }})\n      description: \"High rate of retry on {{ $labels.fqdn }}/{{ $labels.backend }} backend\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#213-haproxy-backend-down","title":"2.13. HAProxy backend down","text":"<p>HAProxy backend is down</p> <pre><code>  - alert: HaproxyBackendDown\n    expr: haproxy_backend_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy backend down (instance {{ $labels.instance }})\n      description: \"HAProxy backend is down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#214-haproxy-server-down","title":"2.14. HAProxy server down","text":"<p>HAProxy server is down</p> <pre><code>  - alert: HaproxyServerDown\n    expr: haproxy_server_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: HAProxy server down (instance {{ $labels.instance }})\n      description: \"HAProxy server is down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#215-haproxy-frontend-security-blocked-requests","title":"2.15. HAProxy frontend security blocked requests","text":"<p>HAProxy is blocking requests for security reason</p> <pre><code>  - alert: HaproxyFrontendSecurityBlockedRequests\n    expr: sum by (frontend) (rate(haproxy_frontend_requests_denied_total[2m])) &gt; 10\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy frontend security blocked requests (instance {{ $labels.instance }})\n      description: \"HAProxy is blocking requests for security reason\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/13HaProxy/#216-haproxy-server-healthcheck-failure","title":"2.16. HAProxy server healthcheck failure","text":"<p>Some server healthcheck are failing on <code>{{ $labels.server }}</code></p> <pre><code>  - alert: HaproxyServerHealthcheckFailure\n    expr: increase(haproxy_server_check_failures_total[1m]) &gt; 0\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: HAProxy server healthcheck failure (instance {{ $labels.instance }})\n      description: \"Some server healthcheck are failing on {{ $labels.server }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/14Traefikv1/","title":"4 Traefik","text":""},{"location":"chap9/14Traefikv1/#1-traefik-embedded-exporter-v2","title":"1 Traefik : Embedded exporter v2","text":""},{"location":"chap9/14Traefikv1/#11-traefik-service-down","title":"1.1. Traefik service down","text":"<p>All Traefik services are down</p> <pre><code>  - alert: TraefikServiceDown\n    expr: count(traefik_service_server_up) by (service) == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Traefik service down (instance {{ $labels.instance }})\n      description: \"All Traefik services are down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/14Traefikv1/#12-traefik-high-http-4xx-error-rate-service","title":"1.2. Traefik high HTTP 4xx error rate service","text":"<p>Traefik service 4xx error rate is above 5%</p> <pre><code>  - alert: TraefikHighHttp4xxErrorRateService\n    expr: sum(rate(traefik_service_requests_total{code=~\"4.*\"}[3m])) by (service) / sum(rate(traefik_service_requests_total[3m])) by (service) * 100 &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: Traefik high HTTP 4xx error rate service (instance {{ $labels.instance }})\n      description: \"Traefik service 4xx error rate is above 5%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/14Traefikv1/#13-traefik-high-http-5xx-error-rate-service","title":"1.3. Traefik high HTTP 5xx error rate service","text":"<p>Traefik service 5xx error rate is above 5%</p> <pre><code>  - alert: TraefikHighHttp5xxErrorRateService\n    expr: sum(rate(traefik_service_requests_total{code=~\"5.*\"}[3m])) by (service) / sum(rate(traefik_service_requests_total[3m])) by (service) * 100 &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: Traefik high HTTP 5xx error rate service (instance {{ $labels.instance }})\n      description: \"Traefik service 5xx error rate is above 5%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/14Traefikv1/#2-traefik-embedded-exporter-v1","title":"2. Traefik : Embedded exporter v1","text":""},{"location":"chap9/14Traefikv1/#21-traefik-backend-down","title":"2.1. Traefik backend down","text":"<p>All Traefik backends are down</p> <pre><code>- alert: TraefikBackendDown\n  expr: count(traefik_backend_server_up) by (backend) == 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Traefik backend down (instance {{ $labels.instance }})\"\n    description: \"All Traefik backends are down\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/14Traefikv1/#22-traefik-backend-errors","title":"2.2. Traefik backend errors","text":"<p>Traefik backend error rate is above 10%</p> <pre><code>- alert: TraefikBackendErrors\n  expr: sum(rate(traefik_backend_requests_total{code=~\"5.*\"}[5m])) by (backend) / sum(rate(traefik_backend_requests_total[5m])) by (backend) &gt; 0.1\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Traefik backend errors (instance {{ $labels.instance }})\"\n    description: \"Traefik backend error rate is above 10%\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/14Traefikv1/#23-traefik-high-http-5xx-error-rate-backend","title":"2.3. Traefik high HTTP 5xx error rate backend","text":"<p>Traefik backend 5xx error rate is above 5%</p> <pre><code>  - alert: TraefikHighHttp5xxErrorRateBackend\n    expr: sum(rate(traefik_backend_requests_total{code=~\"5.*\"}[3m])) by (backend) / sum(rate(traefik_backend_requests_total[3m])) by (backend) * 100 &gt; 5\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: Traefik high HTTP 5xx error rate backend (instance {{ $labels.instance }})\n      description: \"Traefik backend 5xx error rate is above 5%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/15PHP-FPM/","title":"1. PHP-FPM php-fpm-exporter","text":"<p>bakins/php-fpm-exporter</p>"},{"location":"chap9/15PHP-FPM/#php-fpm-max-children-reached","title":"PHP-FPM max-children reached","text":"<p>PHP-FPM reached max children - <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: Php-fpmMax-childrenReached\n    expr: sum(phpfpm_max_children_reached_total) by (instance) &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: PHP-FPM max-children reached (instance {{ $labels.instance }})\n      description: \"PHP-FPM reached max children - {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/16Java/","title":"2 Java : java-client","text":"<p>java-client</p>"},{"location":"chap9/16Java/#1-jvm-memory-filling-up","title":"1. JVM memory filling up","text":"<p>JVM memory is filling up (&gt; 80%)</p> <pre><code>- alert: JvmMemoryFillingUp\n  expr: jvm_memory_bytes_used / jvm_memory_bytes_max{area=\"heap\"} &gt; 0.8\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"JVM memory filling up (instance {{ $labels.instance }})\"\n    description: \"JVM memory is filling up (&gt; 80%)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/17zfs/","title":"17. ZFS : node-exporter","text":"<p>node-exporter</p>"},{"location":"chap9/18Kubernetes/","title":"1 Kubernetes : kube-state-metrics","text":"<p>kube-state-metrics</p>"},{"location":"chap9/18Kubernetes/#1-kubernetes-node-ready","title":"1. Kubernetes Node ready","text":"<p>Node <code>{{ $labels.node }}</code> has been unready for a long time</p> <pre><code>  - alert: KubernetesNodeReady\n    expr: kube_node_status_condition{condition=\"Ready\",status=\"true\"} == 0\n    for: 10m\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes Node ready (instance {{ $labels.instance }})\n      description: \"Node {{ $labels.node }} has been unready for a long time\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#2-kubernetes-memorypressure","title":"2. Kubernetes MemoryPressure","text":"<p><code>{{ $labels.node }}</code> has MemoryPressure condition</p> <pre><code>- alert: KubernetesMemorypressure\n  expr: kube_node_status_condition{condition=\"MemoryPressure\",status=\"true\"} == 1\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Kubernetes MemoryPressure (instance {{ $labels.instance }})\"\n    description: \"{{ $labels.node }} has MemoryPressure condition\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#3-kubernetes-diskpressure","title":"3. Kubernetes DiskPressure","text":"<p><code>{{ $labels.node }}</code> has DiskPressure condition</p> <pre><code>- alert: KubernetesDiskpressure\n  expr: kube_node_status_condition{condition=\"DiskPressure\",status=\"true\"} == 1\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Kubernetes DiskPressure (instance {{ $labels.instance }})\"\n    description: \"{{ $labels.node }} has DiskPressure condition\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#4-kubernetes-outofdisk","title":"4. Kubernetes OutOfDisk","text":"<p><code>{{ $labels.node }}</code> has OutOfDisk condition</p> <pre><code>- alert: KubernetesOutofdisk\n  expr: kube_node_status_condition{condition=\"OutOfDisk\",status=\"true\"} == 1\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Kubernetes OutOfDisk (instance {{ $labels.instance }})\"\n    description: \"{{ $labels.node }} has OutOfDisk condition\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#5-kubernetes-out-of-capacity","title":"5. Kubernetes out of capacity","text":"<p><code>{{ $labels.node }}</code> is out of capacity</p> <pre><code>  - alert: KubernetesOutOfCapacity\n    expr: sum by (node) ((kube_pod_status_phase{phase=\"Running\"} == 1) + on(uid) group_left(node) (0 * kube_pod_info{pod_template_hash=\"\"})) / sum by (node) (kube_node_status_allocatable{resource=\"pods\"}) * 100 &gt; 90\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes out of capacity (instance {{ $labels.instance }})\n      description: \"{{ $labels.node }} is out of capacity\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#6-kubernetes-container-oom-killer","title":"6. Kubernetes container oom killer","text":"<p>Container <code>{{ $labels.container }}</code> in pod <code>{{ $labels.namespace }}/{{ $labels.pod }}</code> has been OOMKilled <code>{{ $value }}</code> times in the last 10 minutes.</p> <pre><code>  - alert: KubernetesContainerOomKiller\n    expr: (kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m &gt;= 1) and ignoring (reason) min_over_time(kube_pod_container_status_last_terminated_reason{reason=\"OOMKilled\"}[10m]) == 1\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes container oom killer (instance {{ $labels.instance }})\n      description: \"Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} has been OOMKilled {{ $value }} times in the last 10 minutes.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#7-kubernetes-job-failed","title":"7. Kubernetes Job failed","text":"<p>Job <code>{{$labels.namespace}}/{{$labels.exported_job}}</code> failed to complete</p> <pre><code>- alert: KubernetesJobFailed\n  expr: kube_job_status_failed &gt; 0\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Kubernetes Job failed (instance {{ $labels.instance }})\"\n    description: \"Job {{$labels.namespace}}/{{$labels.exported_job}} failed to complete\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#8-kubernetes-cronjob-suspended","title":"8. Kubernetes CronJob suspended","text":"<p>CronJob <code>{{ $labels.namespace }}/{{ $labels.cronjob }}</code> is suspended</p> <pre><code>- alert: KubernetesCronjobSuspended\n  expr: kube_cronjob_spec_suspend != 0\n  for: 5m\n  labels:\n    severity: info\n  annotations:\n    summary: \"Kubernetes CronJob suspended (instance {{ $labels.instance }})\"\n    description: \"CronJob {{ $labels.namespace }}/{{ $labels.cronjob }} is suspended\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#9-kubernetes-persistentvolumeclaim-pending","title":"9. Kubernetes PersistentVolumeClaim pending","text":"<p>PersistentVolumeClaim <code>{{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }}</code> is pending</p> <pre><code>- alert: KubernetesPersistentvolumeclaimPending\n  expr: kube_persistentvolumeclaim_status_phase{phase=\"Pending\"} == 1\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Kubernetes PersistentVolumeClaim pending (instance {{ $labels.instance }})\"\n    description: \"PersistentVolumeClaim {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is pending\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#10-volume-out-of-disk-space","title":"10. Volume out of disk space","text":"<p>Volume is almost full (&lt; 10% left)</p> <pre><code>- alert: VolumeOutOfDiskSpace\n  expr: kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes * 100 &lt; 10\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Volume out of disk space (instance {{ $labels.instance }})\"\n    description: \"Volume is almost full (&lt; 10% left)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#11-volume-full-in-four-days","title":"11. Volume full in four days","text":"<p><code>{{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }}</code> is expected to fill up within four days. Currently <code>{{ $value | humanize }}%</code> is available.</p> <pre><code>- alert: VolumeFullInFourDays\n  expr: 100 * (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) &lt; 15 and predict_linear(kubelet_volume_stats_available_bytes[6h], 4 * 24 * 3600) &lt; 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Volume full in four days (instance {{ $labels.instance }})\"\n    description: \"{{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is expected to fill up within four days. Currently {{ $value | humanize }}% is available.\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#12-kubernetes-persistentvolume-error","title":"12. Kubernetes PersistentVolume error","text":"<p>Persistent volume is in bad state</p> <pre><code>  - alert: KubernetesPersistentvolumeError\n    expr: kube_persistentvolume_status_phase{phase=~\"Failed|Pending\", job=\"kube-state-metrics\"} &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes PersistentVolume error (instance {{ $labels.instance }})\n      description: \"Persistent volume is in bad state\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#13-statefulset-down","title":"13. StatefulSet down","text":"<p>A StatefulSet went down</p> <pre><code>- alert: StatefulsetDown\n  expr: (kube_statefulset_status_replicas_ready / kube_statefulset_status_replicas_current) != 1\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"StatefulSet down (instance {{ $labels.instance }})\"\n    description: \"A StatefulSet went down\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#14-kubernetes-hpa-scaling-ability","title":"14. Kubernetes HPA scaling ability","text":"<p>Pod is unable to scale</p> <pre><code>  - alert: KubernetesHpaScalingAbility\n    expr: kube_horizontalpodautoscaler_status_condition{status=\"false\", condition=\"AbleToScale\"} == 1\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes HPA scaling ability (instance {{ $labels.instance }})\n      description: \"Pod is unable to scale\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#15-kubernetes-hpa-metric-availability","title":"15. Kubernetes HPA metric availability","text":"<p>HPA is not able to collect metrics</p> <pre><code>  - alert: KubernetesHpaMetricAvailability\n    expr: kube_horizontalpodautoscaler_status_condition{status=\"false\", condition=\"ScalingActive\"} == 1\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes HPA metric availability (instance {{ $labels.instance }})\n      description: \"HPA is not able to collect metrics\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#16-kubernetes-hpa-scale-capability","title":"16. Kubernetes HPA scale capability","text":"<p>The maximum number of desired Pods has been hit</p> <pre><code>  - alert: KubernetesHpaScaleCapability\n    expr: kube_horizontalpodautoscaler_status_desired_replicas &gt;= kube_horizontalpodautoscaler_spec_max_replicas\n    for: 2m\n    labels:\n      severity: info\n    annotations:\n      summary: Kubernetes HPA scale capability (instance {{ $labels.instance }})\n      description: \"The maximum number of desired Pods has been hit\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#17-kubernetes-pod-not-healthy","title":"17. Kubernetes Pod not healthy","text":"<p>Pod has been in a non-ready state for longer than 15 minutes.</p> <pre><code>  - alert: KubernetesPodNotHealthy\n    expr: min_over_time(sum by (namespace, pod) (kube_pod_status_phase{phase=~\"Pending|Unknown|Failed\"})[15m:1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes Pod not healthy (instance {{ $labels.instance }})\n      description: \"Pod has been in a non-ready state for longer than 15 minutes.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#18-kubernetes-pod-crash-looping","title":"18. Kubernetes pod crash looping","text":"<p>Pod <code>{{ $labels.pod }}</code> is crash looping</p> <pre><code>  - alert: KubernetesPodCrashLooping\n    expr: increase(kube_pod_container_status_restarts_total[1m]) &gt; 3\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes pod crash looping (instance {{ $labels.instance }})\n      description: \"Pod {{ $labels.pod }} is crash looping\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#19-kubernetes-replicasset-mismatch","title":"19. Kubernetes ReplicasSet mismatch","text":"<p>Deployment Replicas mismatch</p> <pre><code>  - alert: KubernetesReplicassetMismatch\n    expr: kube_replicaset_spec_replicas != kube_replicaset_status_ready_replicas\n    for: 10m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes ReplicasSet mismatch (instance {{ $labels.instance }})\n      description: \"Deployment Replicas mismatch\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#20-kubernetes-deployment-replicas-mismatch","title":"20. Kubernetes Deployment replicas mismatch","text":"<p>Deployment Replicas mismatch</p> <pre><code>  - alert: KubernetesDeploymentReplicasMismatch\n    expr: kube_deployment_spec_replicas != kube_deployment_status_replicas_available\n    for: 10m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes Deployment replicas mismatch (instance {{ $labels.instance }})\n      description: \"Deployment Replicas mismatch\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#21-kubernetes-statefulset-replicas-mismatch","title":"21. Kubernetes StatefulSet replicas mismatch","text":"<p>A StatefulSet does not match the expected number of replicas.</p> <pre><code>  - alert: KubernetesStatefulsetReplicasMismatch\n    expr: kube_statefulset_status_replicas_ready != kube_statefulset_status_replicas\n    for: 10m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes StatefulSet replicas mismatch (instance {{ $labels.instance }})\n      description: \"A StatefulSet does not match the expected number of replicas.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#22-kubernetes-deployment-generation-mismatch","title":"22. Kubernetes Deployment generation mismatch","text":"<p>A Deployment has failed but has not been rolled back.</p> <pre><code>  - alert: KubernetesDeploymentGenerationMismatch\n    expr: kube_deployment_status_observed_generation != kube_deployment_metadata_generation\n    for: 10m\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes Deployment generation mismatch (instance {{ $labels.instance }})\n      description: \"A Deployment has failed but has not been rolled back.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#23-kubernetes-statefulset-generation-mismatch","title":"23. Kubernetes StatefulSet generation mismatch","text":"<p>A StatefulSet has failed but has not been rolled back.</p> <pre><code>  - alert: KubernetesStatefulsetGenerationMismatch\n    expr: kube_statefulset_status_observed_generation != kube_statefulset_metadata_generation\n    for: 10m\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes StatefulSet generation mismatch (instance {{ $labels.instance }})\n      description: \"A StatefulSet has failed but has not been rolled back.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#24-kubernetes-statefulset-update-not-rolled-out","title":"24. Kubernetes StatefulSet update not rolled out","text":"<p>StatefulSet update has not been rolled out.</p> <pre><code>  - alert: KubernetesStatefulsetUpdateNotRolledOut\n    expr: max without (revision) (kube_statefulset_status_current_revision unless kube_statefulset_status_update_revision) * (kube_statefulset_replicas != kube_statefulset_status_replicas_updated)\n    for: 10m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes StatefulSet update not rolled out (instance {{ $labels.instance }})\n      description: \"StatefulSet update has not been rolled out.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#25-kubernetes-daemonset-rollout-stuck","title":"25. Kubernetes DaemonSet rollout stuck","text":"<p>Some Pods of DaemonSet are not scheduled or not ready</p> <pre><code>  - alert: KubernetesDaemonsetRolloutStuck\n    expr: kube_daemonset_status_number_ready / kube_daemonset_status_desired_number_scheduled * 100 &lt; 100 or kube_daemonset_status_desired_number_scheduled - kube_daemonset_status_current_number_scheduled &gt; 0\n    for: 10m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes DaemonSet rollout stuck (instance {{ $labels.instance }})\n      description: \"Some Pods of DaemonSet are not scheduled or not ready\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#26-kubernetes-daemonset-misscheduled","title":"26. Kubernetes DaemonSet misscheduled","text":"<p>Some DaemonSet Pods are running where they are not supposed to run</p> <pre><code>  - alert: KubernetesDaemonsetMisscheduled\n    expr: kube_daemonset_status_number_misscheduled &gt; 0\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes DaemonSet misscheduled (instance {{ $labels.instance }})\n      description: \"Some DaemonSet Pods are running where they are not supposed to run\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#27-kubernetes-cronjob-too-long","title":"27. Kubernetes CronJob too long","text":"<p>CronJob <code>{{ $labels.namespace }}/{{ $labels.cronjob }}</code> is taking more than 1h to complete.</p> <pre><code>  - alert: KubernetesCronjobTooLong\n    expr: time() - kube_cronjob_next_schedule_time &gt; 3600\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes CronJob too long (instance {{ $labels.instance }})\n      description: \"CronJob {{ $labels.namespace }}/{{ $labels.cronjob }} is taking more than 1h to complete.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#28-kubernetes-job-slow-completion","title":"28. Kubernetes job slow completion","text":"<p>Kubernetes Job <code>{{ $labels.namespace }}/{{ $labels.job_name }}</code> did not complete in time.</p> <pre><code>  - alert: KubernetesJobSlowCompletion\n    expr: kube_job_spec_completions - kube_job_status_succeeded &gt; 0\n    for: 12h\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes job slow completion (instance {{ $labels.instance }})\n      description: \"Kubernetes Job {{ $labels.namespace }}/{{ $labels.job_name }} did not complete in time.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#29-kubernetes-api-server-errors","title":"29. Kubernetes API server errors","text":"<p>Kubernetes API server is experiencing high error rate</p> <pre><code>  - alert: KubernetesApiServerErrors\n    expr: sum(rate(apiserver_request_total{job=\"apiserver\",code=~\"^(?:5..)$\"}[1m])) / sum(rate(apiserver_request_total{job=\"apiserver\"}[1m])) * 100 &gt; 3\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes API server errors (instance {{ $labels.instance }})\n      description: \"Kubernetes API server is experiencing high error rate\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#30-kubernetes-api-client-errors","title":"30. Kubernetes API client errors","text":"<p>Kubernetes API client is experiencing high error rate</p> <pre><code>  - alert: KubernetesApiClientErrors\n    expr: (sum(rate(rest_client_requests_total{code=~\"(4|5)..\"}[1m])) by (instance, job) / sum(rate(rest_client_requests_total[1m])) by (instance, job)) * 100 &gt; 1\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes API client errors (instance {{ $labels.instance }})\n      description: \"Kubernetes API client is experiencing high error rate\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#31-kubernetes-client-certificate-expires-next-week","title":"31. Kubernetes client certificate expires next week","text":"<p>A client certificate used to authenticate to the apiserver is expiring next week.</p> <pre><code>  - alert: KubernetesClientCertificateExpiresNextWeek\n    expr: apiserver_client_certificate_expiration_seconds_count{job=\"apiserver\"} &gt; 0 and histogram_quantile(0.01, sum by (job, le) (rate(apiserver_client_certificate_expiration_seconds_bucket{job=\"apiserver\"}[5m]))) &lt; 7*24*60*60\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes client certificate expires next week (instance {{ $labels.instance }})\n      description: \"A client certificate used to authenticate to the apiserver is expiring next week.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#32-kubernetes-client-certificate-expires-soon","title":"32. Kubernetes client certificate expires soon","text":"<p>A client certificate used to authenticate to the apiserver is expiring in less than 24.0 hours.</p> <pre><code>  - alert: KubernetesClientCertificateExpiresSoon\n    expr: apiserver_client_certificate_expiration_seconds_count{job=\"apiserver\"} &gt; 0 and histogram_quantile(0.01, sum by (job, le) (rate(apiserver_client_certificate_expiration_seconds_bucket{job=\"apiserver\"}[5m]))) &lt; 24*60*60\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Kubernetes client certificate expires soon (instance {{ $labels.instance }})\n      description: \"A client certificate used to authenticate to the apiserver is expiring in less than 24.0 hours.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/18Kubernetes/#33-kubernetes-api-server-latency","title":"33. Kubernetes API server latency","text":"<p>Kubernetes API server has a 99th percentile latency of <code>{{ $value }}</code> seconds for <code>{{ $labels.verb }} {{ $labels.resource }}</code>.</p> <pre><code>  - alert: KubernetesApiServerLatency\n    expr: histogram_quantile(0.99, sum(rate(apiserver_request_latencies_bucket{subresource!=\"log\",verb!~\"^(?:CONNECT|WATCHLIST|WATCH|PROXY)$\"} [10m])) WITHOUT (instance, resource)) / 1e+06 &gt; 1\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kubernetes API server latency (instance {{ $labels.instance }})\n      description: \"Kubernetes API server has a 99th percentile latency of {{ $value }} seconds for {{ $labels.verb }} {{ $labels.resource }}.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/19Nomad/","title":"2. Nomad : prometheus-nomad-exporter","text":"<p>samber/prometheus-nomad-exporter</p>"},{"location":"chap9/19Nomad/#1-nomad-job-failed","title":"1. Nomad job failed","text":"<p>Nomad job failed</p> <pre><code>  - alert: NomadJobFailed\n    expr: nomad_nomad_job_summary_failed &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Nomad job failed (instance {{ $labels.instance }})\n      description: \"Nomad job failed\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/19Nomad/#2-nomad-job-lost","title":"2. Nomad job lost","text":"<p>Nomad job lost</p> <pre><code>  - alert: NomadJobLost\n    expr: nomad_nomad_job_summary_lost &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Nomad job lost (instance {{ $labels.instance }})\n      description: \"Nomad job lost\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/19Nomad/#3-nomad-job-queued","title":"3. Nomad job queued","text":"<p>Nomad job queued</p> <pre><code>  - alert: NomadJobQueued\n    expr: nomad_nomad_job_summary_queued &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Nomad job queued (instance {{ $labels.instance }})\n      description: \"Nomad job queued\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/19Nomad/#4-nomad-blocked-evaluation","title":"4. Nomad blocked evaluation","text":"<p>Nomad blocked evaluation</p> <pre><code>  - alert: NomadBlockedEvaluation\n    expr: nomad_nomad_blocked_evals_total_blocked &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Nomad blocked evaluation (instance {{ $labels.instance }})\n      description: \"Nomad blocked evaluation\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/","title":"1 Prometheus","text":""},{"location":"chap9/1Prometheus/#11-prometheus-self-monitoring","title":"1.1. Prometheus self-monitoring","text":""},{"location":"chap9/1Prometheus/#111-prometheus-job-missing","title":"1.1.1. Prometheus job missing","text":"<p>A Prometheus job has disappeared</p> <pre><code>- alert: PrometheusJobMissing\n    expr: absent(up{job=\"prometheus\"})\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus job missing (instance {{ $labels.instance }})\n      description: \"A Prometheus job has disappeared\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#112-prometheus-target-missing","title":"1.1.2. Prometheus target missing","text":"<p>A Prometheus target has disappeared. An exporter might be crashed.</p> <pre><code>- alert: PrometheusTargetMissing\n    expr: up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus target missing (instance {{ $labels.instance }})\n      description: \"A Prometheus target has disappeared. An exporter might be crashed.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#113-prometheus-all-targets-missing","title":"1.1.3. Prometheus all targets missing","text":"<p>A Prometheus job does not have living target anymore.</p> <pre><code>  - alert: PrometheusAllTargetsMissing\n    expr: count by (job) (up) == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus all targets missing (instance {{ $labels.instance }})\n      description: \"A Prometheus job does not have living target anymore.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#114-prometheus-configuration-reload-failure","title":"1.1.4 Prometheus configuration reload failure","text":"<p>Prometheus configuration reload error</p> <pre><code>- alert: PrometheusConfigurationReload\n  expr: prometheus_config_last_reload_successful != 1\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Prometheus configuration reload (instance {{ $labels.instance }})\"\n    description: \"Prometheus configuration reload error\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#115-prometheus-too-many-restarts","title":"1.1.5. Prometheus too many restarts","text":"<p>Prometheus has restarted more than twice in the last 15 minutes. It might be crashlooping.</p> <pre><code>  - alert: PrometheusTooManyRestarts\n    expr: changes(process_start_time_seconds{job=~\"prometheus|pushgateway|alertmanager\"}[15m]) &gt; 2\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus too many restarts (instance {{ $labels.instance }})\n      description: \"Prometheus has restarted more than twice in the last 15 minutes. It might be crashlooping.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n\n</code></pre>"},{"location":"chap9/1Prometheus/#116-prometheus-alertmanager-job-missing","title":"1.1.6. Prometheus AlertManager job missing","text":"<p>A Prometheus AlertManager job has disappeared</p> <pre><code>  - alert: PrometheusAlertmanagerJobMissing\n    expr: absent(up{job=\"alertmanager\"})\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus AlertManager job missing (instance {{ $labels.instance }})\n      description: \"A Prometheus AlertManager job has disappeared\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n\n</code></pre>"},{"location":"chap9/1Prometheus/#117-prometheus-alertmanager-configuration-reload-failure","title":"1.1.7. Prometheus AlertManager configuration reload failure","text":"<p>AlertManager configuration reload error</p> <pre><code>  - alert: PrometheusAlertmanagerConfigurationReloadFailure\n    expr: alertmanager_config_last_reload_successful != 1\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus AlertManager configuration reload failure (instance {{ $labels.instance }})\n      description: \"AlertManager configuration reload error\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#118-prometheus-alertmanager-config-not-synced","title":"1.1.8. Prometheus AlertManager config not synced","text":"<p>Configurations of AlertManager cluster instances are out of sync</p> <pre><code>  - alert: PrometheusAlertmanagerConfigNotSynced\n    expr: count(count_values(\"config_hash\", alertmanager_config_hash)) &gt; 1\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus AlertManager config not synced (instance {{ $labels.instance }})\n      description: \"Configurations of AlertManager cluster instances are out of sync\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#119-prometheus-alertmanager-e2e-dead-man-switch","title":"1.1.9 Prometheus AlertManager E2E dead man switch","text":"<p>Prometheus DeadManSwitch is an always-firing alert. It's used as an end-to-end test of Prometheus through the Alertmanager.</p> <pre><code>  - alert: PrometheusAlertmanagerE2eDeadManSwitch\n    expr: vector(1)\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus AlertManager E2E dead man switch (instance {{ $labels.instance }})\n      description: \"Prometheus DeadManSwitch is an always-firing alert. It's used as an end-to-end test of Prometheus through the Alertmanager.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n\n</code></pre>"},{"location":"chap9/1Prometheus/#1110-prometheus-not-connected-to-alertmanager","title":"1.1.10. Prometheus not connected to alertmanager","text":"<p>Prometheus cannot connect the alertmanager</p> <pre><code>  - alert: PrometheusNotConnectedToAlertmanager\n    expr: prometheus_notifications_alertmanagers_discovered &lt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus not connected to alertmanager (instance {{ $labels.instance }})\n      description: \"Prometheus cannot connect the alertmanager\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1111-prometheus-rule-evaluation-failures","title":"1.1.11. Prometheus rule evaluation failures","text":"<p>Prometheus encountered <code>{{ $value }}</code> rule evaluation failures, leading to potentially ignored alerts.</p> <pre><code>  - alert: PrometheusRuleEvaluationFailures\n    expr: increase(prometheus_rule_evaluation_failures_total[3m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus rule evaluation failures (instance {{ $labels.instance }})\n      description: \"Prometheus encountered {{ $value }} rule evaluation failures, leading to potentially ignored alerts.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1112-prometheus-template-text-expansion-failures","title":"1.1.12. Prometheus template text expansion failures","text":"<p>Prometheus encountered <code>{{ $value }}</code> template text expansion failures</p> <pre><code>  - alert: PrometheusTemplateTextExpansionFailures\n    expr: increase(prometheus_template_text_expansion_failures_total[3m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus template text expansion failures (instance {{ $labels.instance }})\n      description: \"Prometheus encountered {{ $value }} template text expansion failures\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1113-prometheus-rule-evaluation-slow","title":"1.1.13. Prometheus rule evaluation slow","text":"<p>Prometheus rule evaluation took more time than the scheduled interval. It indicates a slower storage backend access or too complex query.</p> <pre><code>  - alert: PrometheusRuleEvaluationSlow\n    expr: prometheus_rule_group_last_duration_seconds &gt; prometheus_rule_group_interval_seconds\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus rule evaluation slow (instance {{ $labels.instance }})\n      description: \"Prometheus rule evaluation took more time than the scheduled interval. It indicates a slower storage backend access or too complex query.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1114-prometheus-notifications-backlog","title":"1.1.14. Prometheus notifications backlog","text":"<p>The Prometheus notification queue has not been empty for 10 minutes</p> <pre><code>  - alert: PrometheusNotificationsBacklog\n    expr: min_over_time(prometheus_notifications_queue_length[10m]) &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus notifications backlog (instance {{ $labels.instance }})\n      description: \"The Prometheus notification queue has not been empty for 10 minutes\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1115-prometheus-alertmanager-notification-failing","title":"1.1.15. Prometheus AlertManager notification failing","text":"<p>Alertmanager is failing sending notifications</p> <pre><code>  - alert: PrometheusAlertmanagerNotificationFailing\n    expr: rate(alertmanager_notifications_failed_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus AlertManager notification failing (instance {{ $labels.instance }})\n      description: \"Alertmanager is failing sending notifications\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1116-prometheus-target-empty","title":"1.1.16. Prometheus target empty","text":"<p>Prometheus has no target in service discovery</p> <pre><code>  - alert: PrometheusTargetEmpty\n    expr: prometheus_sd_discovered_targets == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus target empty (instance {{ $labels.instance }})\n      description: \"Prometheus has no target in service discovery\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1117-prometheus-target-scraping-slow","title":"1.1.17. Prometheus target scraping slow","text":"<p>Prometheus is scraping exporters slowly</p> <pre><code>  - alert: PrometheusTargetScrapingSlow\n    expr: prometheus_target_interval_length_seconds{quantile=\"0.9\"} &gt; 60\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus target scraping slow (instance {{ $labels.instance }})\n      description: \"Prometheus is scraping exporters slowly\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1118-prometheus-large-scrape","title":"1.1.18. Prometheus large scrape","text":"<p>Prometheus has many scrapes that exceed the sample limit</p> <pre><code>  - alert: PrometheusLargeScrape\n    expr: increase(prometheus_target_scrapes_exceeded_sample_limit_total[10m]) &gt; 10\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus large scrape (instance {{ $labels.instance }})\n      description: \"Prometheus has many scrapes that exceed the sample limit\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1119-prometheus-target-scrape-duplicate","title":"1.1.19. Prometheus target scrape duplicate","text":"<p>Prometheus has many samples rejected due to duplicate timestamps but different values</p> <pre><code>  - alert: PrometheusTargetScrapeDuplicate\n    expr: increase(prometheus_target_scrapes_sample_duplicate_timestamp_total[5m]) &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Prometheus target scrape duplicate (instance {{ $labels.instance }})\n      description: \"Prometheus has many samples rejected due to duplicate timestamps but different values\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1120-prometheus-tsdb-checkpoint-creation-failures","title":"1.1.20. Prometheus TSDB checkpoint creation failures","text":"<p>Prometheus encountered <code>{{ $value }}</code> checkpoint creation failures</p> <pre><code>  - alert: PrometheusTsdbCheckpointCreationFailures\n    expr: increase(prometheus_tsdb_checkpoint_creations_failed_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus TSDB checkpoint creation failures (instance {{ $labels.instance }})\n      description: \"Prometheus encountered {{ $value }} checkpoint creation failures\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1121-prometheus-tsdb-checkpoint-deletion-failures","title":"1.1.21. Prometheus TSDB checkpoint deletion failures","text":"<p>Prometheus encountered <code>{{ $value }}</code> checkpoint deletion failures</p> <pre><code>  - alert: PrometheusTsdbCheckpointDeletionFailures\n    expr: increase(prometheus_tsdb_checkpoint_deletions_failed_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus TSDB checkpoint deletion failures (instance {{ $labels.instance }})\n      description: \"Prometheus encountered {{ $value }} checkpoint deletion failures\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1122-prometheus-tsdb-compactions-failed","title":"1.1.22. Prometheus TSDB compactions failed","text":"<p>Prometheus encountered <code>{{ $value }}</code> TSDB compactions failures</p> <pre><code>  - alert: PrometheusTsdbCompactionsFailed\n    expr: increase(prometheus_tsdb_compactions_failed_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus TSDB compactions failed (instance {{ $labels.instance }})\n      description: \"Prometheus encountered {{ $value }} TSDB compactions failures\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1123-prometheus-tsdb-head-truncations-failed","title":"1.1.23. Prometheus TSDB head truncations failed","text":"<p>Prometheus encountered <code>{{ $value }}</code> TSDB head truncation failures</p> <pre><code>  - alert: PrometheusTsdbHeadTruncationsFailed\n    expr: increase(prometheus_tsdb_head_truncations_failed_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus TSDB head truncations failed (instance {{ $labels.instance }})\n      description: \"Prometheus encountered {{ $value }} TSDB head truncation failures\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1124-prometheus-tsdb-reload-failures","title":"1.1.24. Prometheus TSDB reload failures","text":"<p>Prometheus encountered <code>{{ $value }}</code> TSDB reload failures</p> <pre><code>  - alert: PrometheusTsdbReloadFailures\n    expr: increase(prometheus_tsdb_reloads_failures_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus TSDB reload failures (instance {{ $labels.instance }})\n      description: \"Prometheus encountered {{ $value }} TSDB reload failures\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1125-prometheus-tsdb-wal-corruptions","title":"1.1.25. Prometheus TSDB WAL corruptions","text":"<p>Prometheus encountered <code>{{ $value }}</code> TSDB WAL corruptions</p> <pre><code>  - alert: PrometheusTsdbWalCorruptions\n    expr: increase(prometheus_tsdb_wal_corruptions_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus TSDB WAL corruptions (instance {{ $labels.instance }})\n      description: \"Prometheus encountered {{ $value }} TSDB WAL corruptions\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#1126-prometheus-tsdb-wal-truncations-failed","title":"1.1.26. Prometheus TSDB WAL truncations failed","text":"<p>Prometheus encountered <code>{{ $value }}</code> TSDB WAL truncation failures</p> <pre><code>  - alert: PrometheusTsdbWalTruncationsFailed\n    expr: increase(prometheus_tsdb_wal_truncations_failed_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Prometheus TSDB WAL truncations failed (instance {{ $labels.instance }})\n      description: \"Prometheus encountered {{ $value }} TSDB WAL truncation failures\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1Prometheus/#12-exporter-down","title":"1.2. Exporter down","text":""},{"location":"chap9/1Prometheus/#prometheus-exporter-down","title":"Prometheus exporter down","text":"<pre><code>- alert: ExporterDown\n  expr: up == 0\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Exporter down (instance {{ $labels.instance }})\"\n    description: \"Prometheus exporter down\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/1basic_resource/","title":"1 Basic resource monitoring","text":"<p>https://awesome-prometheus-alerts.grep.to/alertmanager</p>"},{"location":"chap9/1basic_resource/#1-prometheus-self-monitoring","title":"1 Prometheus self-monitoring","text":"<ul> <li>Prometheus job missing</li> <li>Prometheus target missing</li> <li>Prometheus all targets missing</li> <li>Prometheus configuration reload failure</li> <li>Prometheus too many restarts</li> <li>Prometheus AlertManager job missing</li> <li>Prometheus AlertManager configuration reload failure</li> <li>Prometheus AlertManager config not synced</li> <li>Prometheus AlertManager E2E dead man switch</li> <li>Prometheus not connected to alertmanager</li> <li>Prometheus rule evaluation failures</li> <li>Prometheus template text expansion failures</li> <li>Prometheus rule evaluation slow</li> <li>Prometheus notifications backlog</li> <li>Prometheus AlertManager notification failing</li> <li>Prometheus target empty</li> <li>Prometheus target scraping slow</li> <li>Prometheus large scrape</li> <li>Prometheus target scrape duplicate</li> <li>Prometheus TSDB checkpoint creation failures</li> <li>Prometheus TSDB checkpoint deletion failures</li> <li>Prometheus TSDB compactions failed</li> <li>Prometheus TSDB head truncations failed</li> <li>Prometheus TSDB reload failure</li> <li>Prometheus TSDB WAL corruptions</li> <li>Prometheus TSDB WAL truncations failed</li> <li>Prometheus exporter down</li> </ul>"},{"location":"chap9/1basic_resource/#2-host-node-exporter","title":"2 Host node-exporter","text":"<ol> <li>Out of memory</li> <li>Host memory under memory pressure</li> <li>Unusual network throughput in</li> <li>Unusual network throughput out</li> <li>Unusual disk read rate</li> <li>Unusual disk write rate</li> <li>Out of disk space</li> <li>Host disk will fill in 24 hours</li> <li>Out of inodes</li> <li>Host inodes will fill in 24 hours</li> <li>Unusual disk read latency</li> <li>Unusual disk write latency</li> <li>High CPU load</li> <li>Host CPU steal noisy neighbor</li> <li>Host Context switching</li> <li>Swap is filling up</li> <li>Host Systemd service crashed</li> <li>Host physical component too hot</li> <li>Host node overtemperature alarm</li> <li>Host RAID array got inactive</li> <li>Host RAID disk failure</li> <li>Host kernel version deviations</li> <li>Host OOM kill detected</li> <li>Host EDAC Correctable Errors detected</li> <li>Host EDAC Uncorrectable Errors detected</li> <li>Host Network Receive Errors</li> <li>Host Network Transmit Errors</li> <li>Host Network Interface Saturated</li> <li>Host Network Bond Degraded</li> <li>Host conntrack limit</li> <li>Host clock skew</li> <li>Host clock not synchronising</li> <li>Host requires reboot</li> </ol>"},{"location":"chap9/1basic_resource/#3-docker-containers-cadvisor","title":"3 Docker containers : cAdvisor","text":"<ol> <li>Container killed</li> <li>Container CPU usage</li> <li>Container Memory usage</li> <li>Container Volume usage</li> <li>Container Volume I/O usage</li> <li>Container absent</li> <li>Container high throttle rate</li> </ol>"},{"location":"chap9/1basic_resource/#4-blackbox-prometheus","title":"4. Blackbox : prometheus","text":"<ol> <li>Blackbox probe failed</li> <li>Blackbox slow probe</li> <li>Blackbox probe HTTP failure</li> <li>SSL certificate will expire soon</li> <li>SSL certificate expired</li> <li>Blackbox probe slow HTTP</li> <li>Blackbox probe slow ping</li> </ol>"},{"location":"chap9/1basic_resource/#5-windows-server","title":"5. Windows Server","text":"<ol> <li>Windows Server collector Error</li> <li>Windows Server service Status</li> <li>Windows Server CPU Usage</li> <li>Windows Server memory Usage</li> <li>Windows Server disk Space Usage</li> </ol>"},{"location":"chap9/1basic_resource/#6-vmware","title":"6. VMware","text":"<ol> <li>Virtual Machine Memory Warning</li> <li>Virtual Machine Memory Critical</li> <li>High Number of Snapshots</li> <li>Outdated Snapshots</li> </ol>"},{"location":"chap9/1basic_resource/#7netdata","title":"7.Netdata","text":"<ol> <li>Netdata high cpu usage</li> <li>Host CPU steal noisy neighbor</li> <li>Netdata high memory usage</li> <li>Netdata low disk space</li> <li>Netdata predicted disk full</li> <li>Netdata MD mismatch cnt unsynchronized blocks</li> <li>Netdata disk reallocated sectors</li> <li>Netdata disk current pending sector</li> <li>Netdata reported uncorrectable disk sectors</li> </ol>"},{"location":"chap9/20Consul/","title":"20. Consul : prometheus/consul_exporter","text":"<p>Consul Exporter</p>"},{"location":"chap9/20Consul/#1-service-healthcheck-failed","title":"1. Service healthcheck failed","text":"<ul> <li>Service: <code>{{ $labels.service_name }}</code> </li> <li>Healthcheck: <code>{{ $labels.service_id }}</code></li> </ul> <pre><code>- alert: ServiceHealthcheckFailed\n  expr: consul_catalog_service_node_healthy == 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Service healthcheck failed (instance {{ $labels.instance }})\"\n    description: \"Service: `{{ $labels.service_name }}` Healthcheck: `{{ $labels.service_id }}`\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/20Consul/#2-missing-consul-master-node","title":"2. Missing Consul master node","text":"<p>Numbers of consul raft peers less then expected<code>&lt;https://example.ru/ui/{{ $labels.dc }}/services/consul|Consul masters&gt;</code></p> <pre><code>- alert: MissingConsulMasterNode\n  expr: consul_raft_peers &lt; number_of_consul_master\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Missing Consul master node (instance {{ $labels.instance }})\"\n    description: \"Numbers of consul raft peers less then expected &lt;https://example.ru/ui/{{ $labels.dc }}/services/consul|Consul masters&gt;\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/20Consul/#3-consul-agent-unhealthy","title":"3. Consul agent unhealthy","text":"<p>A Consul agent is down</p> <pre><code>  - alert: ConsulAgentUnhealthy\n    expr: consul_health_node_status{status=\"critical\"} == 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Consul agent unhealthy (instance {{ $labels.instance }})\n      description: \"A Consul agent is down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/","title":"21. Etcd","text":""},{"location":"chap9/21Etcd/#211-insufficient-members","title":"21.1. Insufficient Members","text":"<p>Etcd cluster should have an odd number of members</p> <pre><code>- alert: InsufficientMembers\n  expr: count(etcd_server_id) &gt; (count(etcd_server_id) / 2 - 1)\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Insufficient Members (instance {{ $labels.instance }})\"\n    description: \"Etcd cluster should have an odd number of members\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#212-no-leader","title":"21.2. No Leader","text":"<p>Etcd cluster have no leader</p> <pre><code>- alert: NoLeader\n  expr: etcd_server_has_leader == 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"No Leader (instance {{ $labels.instance }})\"\n    description: \"Etcd cluster have no leader\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#213-high-number-of-leader-changes","title":"21.3. High number of leader changes","text":"<p>Etcd leader changed more than 3 times during last hour</p> <pre><code>- alert: HighNumberOfLeaderChanges\n  expr: increase(etcd_server_leader_changes_seen_total[1h]) &gt; 3\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"High number of leader changes (instance {{ $labels.instance }})\"\n    description: \"Etcd leader changed more than 3 times during last hour\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#214-high-number-of-failed-grpc-requests","title":"21.4. High number of failed GRPC requests","text":"<p>More than 1% GRPC request failure detected in Etcd for 5 minutes</p> <pre><code>- alert: HighNumberOfFailedGrpcRequests\n  expr: sum(rate(grpc_server_handled_total{grpc_code!=\"OK\"}[5m])) BY (grpc_service, grpc_method) / sum(rate(grpc_server_handled_total[5m])) BY (grpc_service, grpc_method) &gt; 0.01\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"High number of failed GRPC requests (instance {{ $labels.instance }})\"\n    description: \"More than 1% GRPC request failure detected in Etcd for 5 minutes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#215-high-number-of-failed-grpc-requests","title":"21.5. High number of failed GRPC requests","text":"<p>More than 5% GRPC request failure detected in Etcd for 5 minutes</p> <pre><code>- alert: HighNumberOfFailedGrpcRequests\n  expr: sum(rate(grpc_server_handled_total{grpc_code!=\"OK\"}[5m])) BY (grpc_service, grpc_method) / sum(rate(grpc_server_handled_total[5m])) BY (grpc_service, grpc_method) &gt; 0.05\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"High number of failed GRPC requests (instance {{ $labels.instance }})\"\n    description: \"More than 5% GRPC request failure detected in Etcd for 5 minutes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#216-grpc-requests-slow","title":"21.6. GRPC requests slow","text":"<p>GRPC requests slowing down, 99th percentil is over 0.15s for 5 minutes</p> <pre><code>- alert: GrpcRequestsSlow\n  expr: histogram_quantile(0.99, sum(rate(grpc_server_handling_seconds_bucket{grpc_type=\"unary\"}[5m])) by (grpc_service, grpc_method, le)) &gt; 0.15\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"GRPC requests slow (instance {{ $labels.instance }})\"\n    description: \"GRPC requests slowing down, 99th percentil is over 0.15s for 5 minutes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#217-high-number-of-failed-http-requests","title":"21.7. High number of failed HTTP requests","text":"<p>More than 1% HTTP failure detected in Etcd for 5 minutes</p> <pre><code>- alert: HighNumberOfFailedHttpRequests\n  expr: sum(rate(etcd_http_failed_total[5m])) BY (method) / sum(rate(etcd_http_received_total[5m])) BY (method) &gt; 0.01\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"High number of failed HTTP requests (instance {{ $labels.instance }})\"\n    description: \"More than 1% HTTP failure detected in Etcd for 5 minutes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#218-high-number-of-failed-http-requests","title":"21.8. High number of failed HTTP requests","text":"<p>More than 5% HTTP failure detected in Etcd for 5 minutes</p> <pre><code>- alert: HighNumberOfFailedHttpRequests\n  expr: sum(rate(etcd_http_failed_total[5m])) BY (method) / sum(rate(etcd_http_received_total[5m])) BY (method) &gt; 0.05\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"High number of failed HTTP requests (instance {{ $labels.instance }})\"\n    description: \"More than 5% HTTP failure detected in Etcd for 5 minutes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#219-http-requests-slow","title":"21.9. HTTP requests slow","text":"<p>HTTP requests slowing down, 99th percentil is over 0.15s for 5 minutes</p> <pre><code>- alert: HttpRequestsSlow\n  expr: histogram_quantile(0.99, rate(etcd_http_successful_duration_seconds_bucket[5m])) &gt; 0.15\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"HTTP requests slow (instance {{ $labels.instance }})\"\n    description: \"HTTP requests slowing down, 99th percentil is over 0.15s for 5 minutes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#2110-etcd-member-communication-slow","title":"21.10. Etcd member communication slow","text":"<p>Etcd member communication slowing down, 99th percentil is over 0.15s for 5 minutes</p> <pre><code>- alert: EtcdMemberCommunicationSlow\n  expr: histogram_quantile(0.99, rate(etcd_network_peer_round_trip_time_seconds_bucket[5m])) &gt; 0.15\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Etcd member communication slow (instance {{ $labels.instance }})\"\n    description: \"Etcd member communication slowing down, 99th percentil is over 0.15s for 5 minutes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#2111-high-number-of-failed-proposals","title":"21.11. High number of failed proposals","text":"<p>Etcd server got more than 5 failed proposals past hour</p> <pre><code>- alert: HighNumberOfFailedProposals\n  expr: increase(etcd_server_proposals_failed_total[1h]) &gt; 5\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"High number of failed proposals (instance {{ $labels.instance }})\"\n    description: \"Etcd server got more than 5 failed proposals past hour\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#2112-high-fsync-durations","title":"21.12. High fsync durations","text":"<p>Etcd WAL fsync duration increasing, 99th percentil is over 0.5s for 5 minutes</p> <pre><code>- alert: HighFsyncDurations\n  expr: histogram_quantile(0.99, rate(etcd_disk_wal_fsync_duration_seconds_bucket[5m])) &gt; 0.5\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"High fsync durations (instance {{ $labels.instance }})\"\n    description: \"Etcd WAL fsync duration increasing, 99th percentil is over 0.5s for 5 minutes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/21Etcd/#2113-high-commit-durations","title":"21.13. High commit durations","text":"<p>Etcd commit duration increasing, 99th percentil is over 0.25s for 5 minutes</p> <pre><code>- alert: HighCommitDurations\n  expr: histogram_quantile(0.99, rate(etcd_disk_backend_commit_duration_seconds_bucket[5m])) &gt; 0.25\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"High commit durations (instance {{ $labels.instance }})\"\n    description: \"Etcd commit duration increasing, 99th percentil is over 0.25s for 5 minutes\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/22Zookkeeper/","title":"11. Zookeeper: <code>kafka_zookeeper_exporter</code>","text":""},{"location":"chap9/22Zookkeeper/#1-zookeeper-kafka_zookeeper_exporter","title":"1 Zookeeper : <code>kafka_zookeeper_exporter</code>","text":""},{"location":"chap9/22Zookkeeper/#2-zookeeper-dabealuzookeeper-exporter","title":"2. Zookeeper : dabealu/zookeeper-exporter","text":""},{"location":"chap9/22Zookkeeper/#1-zookeeper-down","title":"1 Zookeeper Down","text":"<p>Zookeeper down on instance <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: ZookeeperDown\n    expr: zk_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Zookeeper Down (instance {{ $labels.instance }})\n      description: \"Zookeeper down on instance {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/22Zookkeeper/#2-zookeeper-missing-leader","title":"2 Zookeeper missing leader","text":"<p>Zookeeper cluster has no node marked as leader</p> <pre><code>  - alert: ZookeeperMissingLeader\n    expr: sum(zk_server_leader) == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Zookeeper missing leader (instance {{ $labels.instance }})\n      description: \"Zookeeper cluster has no node marked as leader\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/22Zookkeeper/#3-zookeeper-too-many-leaders","title":"3. Zookeeper Too Many Leaders","text":"<p>Zookeeper cluster has too many nodes marked as leader</p> <pre><code>  - alert: ZookeeperTooManyLeaders\n    expr: sum(zk_server_leader) &gt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Zookeeper Too Many Leaders (instance {{ $labels.instance }})\n      description: \"Zookeeper cluster has too many nodes marked as leader\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/22Zookkeeper/#4-zookeeper-not-ok","title":"4. Zookeeper Not Ok","text":"<p>Zookeeper instance is not ok</p> <pre><code>  - alert: ZookeeperNotOk\n    expr: zk_ruok == 0\n    for: 3m\n    labels:\n      severity: warning\n    annotations:\n      summary: Zookeeper Not Ok (instance {{ $labels.instance }})\n      description: \"Zookeeper instance is not ok\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/23Kafka/","title":"23. Kafka : <code>kafka_exporter</code>","text":""},{"location":"chap9/23Kafka/#1-kafka-danielqsjkafka_exporter","title":"1 Kafka <code>danielqsj/kafka_exporter</code>","text":""},{"location":"chap9/23Kafka/#1-kafka-topics","title":"1. Kafka Topics","text":"<p>Kafka topic in-sync partition</p> <pre><code>- alert: KafkaTopics\n  expr: sum(kafka_topic_partition_in_sync_replica) by (topic) &lt; 3\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Kafka Topics (instance {{ $labels.instance }})\"\n    description: \"Kafka topic in-sync partition\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/23Kafka/#2-kafka-consumers-group","title":"2. Kafka consumers group","text":"<p>Kafka consumers group</p> <pre><code>- alert: KafkaConsumersGroup\n  expr: sum(kafka_consumergroup_lag) by (consumergroup) &gt; 50\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Kafka consumers group (instance {{ $labels.instance }})\"\n    description: \"Kafka consumers group\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/23Kafka/#2-kafka-linkedinburrow","title":"2 Kafka : linkedin/Burrow","text":""},{"location":"chap9/23Kafka/#1-kafka-topic-offset-decreased","title":"1. Kafka topic offset decreased","text":"<p>Kafka topic offset has decreased</p> <pre><code>  - alert: KafkaTopicOffsetDecreased\n    expr: delta(kafka_burrow_partition_current_offset[1m]) &lt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kafka topic offset decreased (instance {{ $labels.instance }})\n      description: \"Kafka topic offset has decreased\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/23Kafka/#2-kafka-consumer-lag","title":"2. Kafka consumer lag","text":"<p>Kafka consumer has a 30 minutes and increasing lag</p> <pre><code>  - alert: KafkaConsumerLag\n    expr: kafka_burrow_topic_partition_offset - on(partition, cluster, topic) group_right() kafka_burrow_partition_current_offset &gt;= (kafka_burrow_topic_partition_offset offset 15m - on(partition, cluster, topic) group_right() kafka_burrow_partition_current_offset offset 15m) AND kafka_burrow_topic_partition_offset - on(partition, cluster, topic) group_right() kafka_burrow_partition_current_offset &gt; 0\n    for: 15m\n    labels:\n      severity: warning\n    annotations:\n      summary: Kafka consumer lag (instance {{ $labels.instance }})\n      description: \"Kafka consumer has a 30 minutes and increasing lag\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/24Linkerd/","title":"24. Linkerd","text":"<p>Embedded exporter</p>"},{"location":"chap9/24Linkerd/#1-linkerd-high-error-rate","title":"1. Linkerd high error rate","text":"<p>Linkerd error rate for <code>{{ $labels.deployment | $labels.statefulset | $labels.daemonset }}</code> is over 10%</p> <pre><code>  - alert: LinkerdHighErrorRate\n    expr: sum(rate(request_errors_total[1m])) by (deployment, statefulset, daemonset) / sum(rate(request_total[1m])) by (deployment, statefulset, daemonset) * 100 &gt; 10\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Linkerd high error rate (instance {{ $labels.instance }})\n      description: \"Linkerd error rate for {{ $labels.deployment | $labels.statefulset | $labels.daemonset }} is over 10%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/","title":"6 Istio : Embedded exporter","text":"<p>Embedded exporter </p>"},{"location":"chap9/25Istio/#1-istio-kubernetes-gateway-availability-drop","title":"1. Istio Kubernetes gateway availability drop","text":"<p>Gateway pods have dropped. Inbound traffic will likely be affected.</p> <pre><code>  - alert: IstioKubernetesGatewayAvailabilityDrop\n    expr: min(kube_deployment_status_replicas_available{deployment=\"istio-ingressgateway\", namespace=\"istio-system\"}) without (instance, pod) &lt; 2\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Istio Kubernetes gateway availability drop (instance {{ $labels.instance }})\n      description: \"Gateway pods have dropped. Inbound traffic will likely be affected.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/#2-istio-pilot-high-total-request-rate","title":"2. Istio Pilot high total request rate","text":"<p>Number of Istio Pilot push errors is too high (&gt; 5%). Envoy sidecars might have outdated configuration.</p> <pre><code>  - alert: IstioPilotHighTotalRequestRate\n    expr: sum(rate(pilot_xds_push_errors[1m])) / sum(rate(pilot_xds_pushes[1m])) * 100 &gt; 5\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Istio Pilot high total request rate (instance {{ $labels.instance }})\n      description: \"Number of Istio Pilot push errors is too high (&gt; 5%). Envoy sidecars might have outdated configuration.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/#3-istio-mixer-prometheus-dispatches-low","title":"3. Istio Mixer Prometheus dispatches low","text":"<p>Number of Mixer dispatches to Prometheus is too low. Istio metrics might not be being exported properly.</p> <pre><code>  - alert: IstioMixerPrometheusDispatchesLow\n    expr: sum(rate(mixer_runtime_dispatches_total{adapter=~\"prometheus\"}[1m])) &lt; 180\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Istio Mixer Prometheus dispatches low (instance {{ $labels.instance }})\n      description: \"Number of Mixer dispatches to Prometheus is too low. Istio metrics might not be being exported properly.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/#4-istio-high-total-request-rate","title":"4. Istio high total request rate","text":"<p>Global request rate in the service mesh is unusually high.</p> <pre><code>  - alert: IstioHighTotalRequestRate\n    expr: sum(rate(istio_requests_total{reporter=\"destination\"}[5m])) &gt; 1000\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Istio high total request rate (instance {{ $labels.instance }})\n      description: \"Global request rate in the service mesh is unusually high.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/#5-istio-low-total-request-rate","title":"5. Istio low total request rate","text":"<p>Global request rate in the service mesh is unusually low.</p> <pre><code>  - alert: IstioLowTotalRequestRate\n    expr: sum(rate(istio_requests_total{reporter=\"destination\"}[5m])) &lt; 100\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Istio low total request rate (instance {{ $labels.instance }})\n      description: \"Global request rate in the service mesh is unusually low.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/#6-istio-high-4xx-error-rate","title":"6. Istio high 4xx error rate","text":"<p>High percentage of HTTP 5xx responses in Istio (&gt; 5%).</p> <pre><code>  - alert: IstioHigh4xxErrorRate\n    expr: sum(rate(istio_requests_total{reporter=\"destination\", response_code=~\"4.*\"}[5m])) / sum(rate(istio_requests_total{reporter=\"destination\"}[5m])) * 100 &gt; 5\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Istio high 4xx error rate (instance {{ $labels.instance }})\n      description: \"High percentage of HTTP 5xx responses in Istio (&gt; 5%).\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/#7-istio-high-5xx-error-rate","title":"7. Istio high 5xx error rate****","text":"<p>High percentage of HTTP 5xx responses in Istio (&gt; 5%).</p> <pre><code>  - alert: IstioHigh5xxErrorRate\n    expr: sum(rate(istio_requests_total{reporter=\"destination\", response_code=~\"5.*\"}[5m])) / sum(rate(istio_requests_total{reporter=\"destination\"}[5m])) * 100 &gt; 5\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Istio high 5xx error rate (instance {{ $labels.instance }})\n      description: \"High percentage of HTTP 5xx responses in Istio (&gt; 5%).\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/#8-istio-high-request-latency","title":"8. Istio high request latency","text":"<p>Istio average requests execution is longer than 100ms.</p> <pre><code>  - alert: IstioHighRequestLatency\n    expr: rate(istio_request_duration_milliseconds_sum[1m]) / rate(istio_request_duration_milliseconds_count[1m]) &gt; 0.1\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Istio high request latency (instance {{ $labels.instance }})\n      description: \"Istio average requests execution is longer than 100ms.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/#9-istio-latency-99-percentile","title":"9. Istio latency 99 percentile","text":"<p>Istio 1% slowest requests are longer than 1s.</p> <pre><code>  - alert: IstioLatency99Percentile\n    expr: histogram_quantile(0.99, rate(istio_request_duration_milliseconds_bucket[1m])) &gt; 1\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Istio latency 99 percentile (instance {{ $labels.instance }})\n      description: \"Istio 1% slowest requests are longer than 1s.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/25Istio/#10-istio-pilot-duplicate-entry","title":"10. Istio Pilot Duplicate Entry","text":"<p>Istio pilot duplicate entry error.</p> <pre><code>  - alert: IstioPilotDuplicateEntry\n    expr: sum(rate(pilot_duplicate_envoy_clusters{}[5m])) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Istio Pilot Duplicate Entry (instance {{ $labels.instance }})\n      description: \"Istio pilot duplicate entry error.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/26Blackbox/","title":"4. Blackbox : prometheus/blackbox_exporter","text":"<p><code>prometheus/blackbox_exporter</code></p>"},{"location":"chap9/26Blackbox/#blackbox_exporteryml","title":"<code>blackbox_exporter.yml</code>","text":"<pre><code>modules:\n  http_get_2xx:\n    prober: http\n    timeout: 10s\n    http:\n      valid_http_versions: [\"HTTP/1.1\", \"HTTP/2\"]\n      method: GET\n  baidu.com:\n    prober: dns\n    timeout: 10s\n    dns:\n      query_name: \"baidu.com\"\n      query_type: \"A\"\n      preferred_ip_protocol: \"ip4\"\n</code></pre>"},{"location":"chap9/26Blackbox/#261-blackbox-probe-failed","title":"26.1 Blackbox probe failed","text":"<p>Probe failed</p> <pre><code>- alert: ProbeFailed\n  expr: probe_success == 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Probe failed (instance {{ $labels.instance }})\"\n    description: \"Probe failed\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/26Blackbox/#262-blackbox-slow-probe","title":"26.2. Blackbox slow probe","text":"<p>Blackbox probe took more than 1s to complete</p> <pre><code>- alert: SlowProbe\n  expr: avg_over_time(probe_duration_seconds[1m]) &gt; 1\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Slow probe (instance {{ $labels.instance }})\"\n    description: \"Blackbox probe took more than 1s to complete\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/26Blackbox/#263-blackbox-probe-http-failure","title":"26.3. Blackbox probe HTTP failure","text":"<p>HTTP status code is not<code>200-399</code></p> <pre><code>- alert: HttpStatusCode\n  expr: probe_http_status_code &lt;= 199 OR probe_http_status_code &gt;= 400\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"HTTP Status Code (instance {{ $labels.instance }})\"\n    description: \"HTTP status code is not 200-399\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/26Blackbox/#264-ssl-certificate-will-expire-soon","title":"26.4. SSL certificate will expire soon","text":"<p>SSL certificate expires in 30 days</p> <pre><code>- alert: SslCertificateWillExpireSoon\n  expr: probe_ssl_earliest_cert_expiry - time() &lt; 86400 * 30\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"SSL certificate will expire soon (instance {{ $labels.instance }})\"\n    description: \"SSL certificate expires in 30 days\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/26Blackbox/#265-ssl-certificate-expired","title":"26.5. SSL certificate expired","text":"<p>SSL certificate has expired already</p> <pre><code>- alert: SslCertificateExpired\n  expr: probe_ssl_earliest_cert_expiry - time()  &lt;= 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"SSL certificate expired (instance {{ $labels.instance }})\"\n    description: \"SSL certificate has expired already\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/26Blackbox/#266-blackbox-probe-slow-http","title":"26.6. Blackbox probe slow HTTP","text":"<p>HTTP request took more than 1s</p> <pre><code>- alert: HttpSlowRequests\n  expr: avg_over_time(probe_http_duration_seconds[1m]) &gt; 1\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"HTTP slow requests (instance {{ $labels.instance }})\"\n    description: \"HTTP request took more than 1s\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/26Blackbox/#267-blackbox-probe-slow-ping","title":"26.7. Blackbox probe slow ping","text":"<p>Blackbox ping took more than 1s</p> <pre><code>- alert: SlowPing\n  expr: avg_over_time(probe_icmp_duration_seconds[1m]) &gt; 1\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Slow ping (instance {{ $labels.instance }})\"\n    description: \"Blackbox ping took more than 1s\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/27OpenEBS/","title":"4. OpenEBS","text":""},{"location":"chap9/27OpenEBS/#1-used-pool-capacity","title":"1. Used pool capacity","text":"<p>OpenEBS Pool use more than 80% of his capacity <code>\\n VALUE = {{ $value }}\\n LABELS: {{ $labels }}</code></p> <pre><code>- alert: UsedPoolCapacity\n  expr: (openebs_used_pool_capacity_percent) &gt; 80\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Used pool capacity (instance {{ $labels.instance }})\"\n    description: \"OpenEBS Pool use more than 80% of his capacity\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/28Minio/","title":"5. Minio","text":""},{"location":"chap9/28Minio/#1-disk-down","title":"1. Disk down","text":"<p>Minio Disk is down\\n <code>VALUE = {{ $value }}\\n LABELS: {{ $labels }}</code></p> <pre><code>- alert: DiskDown\n  expr: minio_offline_disks &gt; 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Disk down (instance {{ $labels.instance }})\"\n    description: \"Minio Disk is down\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/28Minio/#2minio-disk-space-usage","title":"2.Minio disk space usage","text":"<p>Minio available free space is low (&lt; 10%)</p> <pre><code>  - alert: MinioDiskSpaceUsage\n    expr: disk_storage_available / disk_storage_total * 100 &lt; 10\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Minio disk space usage (instance {{ $labels.instance }})\n      description: \"Minio available free space is low (&lt; 10%)\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/29Juniper/","title":"7. Juniper : <code>junos_exporter</code>","text":"<p><code>czerwonk/junos_exporter</code></p>"},{"location":"chap9/29Juniper/#1-switch-is-down","title":"1. Switch is down","text":"<p>The switch appears to be down</p> <pre><code>- alert: SwitchIsDown\n  expr: junos_up == 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Switch is down (instance {{ $labels.instance }})\"\n    description: \"The switch appears to be down\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/29Juniper/#2-high-bandwith-usage-1gib","title":"2. High Bandwith Usage 1GiB","text":"<p>Interface is highly saturated for at least 1 min. (&gt; 0.90GiB/s)</p> <pre><code>- alert: HighBandwithUsage1gib\n  expr: irate(junos_interface_transmit_bytes[1m]) * 8 &gt; 1e+9 * 0.90\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"High Bandwith Usage 1GiB (instance {{ $labels.instance }})\"\n    description: \"Interface is highly saturated for at least 1 min. (&gt; 0.90GiB/s)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/29Juniper/#3-high-bandwith-usage-1gib","title":"3. High Bandwith Usage 1GiB","text":"<p>Interface is getting saturated for at least 1 min. (&gt; 0.80GiB/s)</p> <pre><code>- alert: HighBandwithUsage1gib\n  expr: irate(junos_interface_transmit_bytes[1m]) * 8 &gt; 1e+9 * 0.80\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"High Bandwith Usage 1GiB (instance {{ $labels.instance }})\"\n    description: \"Interface is getting saturated for at least 1 min. (&gt; 0.80GiB/s)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/","title":"2 Host node-exporter","text":""},{"location":"chap9/2Host_node-exporter/#21-out-of-memory","title":"2.1 Out of memory","text":"<p>Node memory is filling up (&lt; 10% left)</p> <pre><code>- alert: OutOfMemory\n  expr: node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100 &lt; 10\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Out of memory (instance {{ $labels.instance }})\"\n    description: \"Node memory is filling up (&lt; 10% left)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#22-host-memory-under-memory-pressure","title":"2.2. Host memory under memory pressure","text":"<p>The node is under heavy memory pressure. High rate of major page faults</p> <pre><code>  - alert: HostMemoryUnderMemoryPressure\n    expr: rate(node_vmstat_pgmajfault[1m]) &gt; 1000\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host memory under memory pressure (instance {{ $labels.instance }})\n      description: \"The node is under heavy memory pressure. High rate of major page faults\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#23-unusual-network-throughput-in","title":"2.3 Unusual network throughput in","text":"<p>Host network interfaces are probably receiving too much data (&gt; <code>100</code> MB/s)</p> <pre><code>- alert: UnusualNetworkThroughputIn\n  expr: sum by (instance) (irate(node_network_receive_bytes_total[2m])) / 1024 / 1024 &gt; 100\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Unusual network throughput in (instance {{ $labels.instance }})\"\n    description: \"Host network interfaces are probably receiving too much data (&gt; 100 MB/s)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#24-unusual-network-throughput-out","title":"2.4. Unusual network throughput out","text":"<p>Host network interfaces are probably sending too much data (&gt; 100 MB/s)</p> <pre><code>- alert: UnusualNetworkThroughputOut\n  expr: sum by (instance) (irate(node_network_transmit_bytes_total[2m])) / 1024 / 1024 &gt; 100\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Unusual network throughput out (instance {{ $labels.instance }})\"\n    description: \"Host network interfaces are probably sending too much data (&gt; 100 MB/s)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#25-unusual-disk-read-rate","title":"2.5. Unusual disk read rate","text":"<p>Disk is probably reading too much data (&gt; 50 MB/s)</p> <pre><code>- alert: UnusualDiskReadRate\n  expr: sum by (instance) (irate(node_disk_read_bytes_total[2m])) / 1024 / 1024 &gt; 50\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Unusual disk read rate (instance {{ $labels.instance }})\"\n    description: \"Disk is probably reading too much data (&gt; 50 MB/s)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#26-unusual-disk-write-rate","title":"2.6. Unusual disk write rate","text":"<p>Disk is probably writing too much data (&gt; 50 MB/s)</p> <pre><code>- alert: UnusualDiskWriteRate\n  expr: sum by (instance) (irate(node_disk_written_bytes_total[2m])) / 1024 / 1024 &gt; 50\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Unusual disk write rate (instance {{ $labels.instance }})\"\n    description: \"Disk is probably writing too much data (&gt; 50 MB/s)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#27-out-of-disk-space","title":"2.7 Out of disk space","text":"<p>Disk is almost full (&lt; 10% left)</p> <pre><code>- alert: OutOfDiskSpace\n  expr: node_filesystem_free_bytes{mountpoint =\"/rootfs\"} / node_filesystem_size_bytes{mountpoint =\"/rootfs\"} * 100 &lt; 10\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Out of disk space (instance {{ $labels.instance }})\"\n    description: \"Disk is almost full (&lt; 10% left)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#28-host-disk-will-fill-in-24-hours","title":"2.8 Host disk will fill in 24 hours","text":"<p>Filesystem is predicted to run out of space within the next 24 hours at current write rate</p> <pre><code>  # Please add ignored mountpoints in node_exporter parameters like\n  # \"--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|run)($|/)\".\n  # Same rule using \"node_filesystem_free_bytes\" will fire when disk fills for non-root users.\n  - alert: HostDiskWillFillIn24Hours\n    expr: (node_filesystem_avail_bytes * 100) / node_filesystem_size_bytes &lt; 10 and ON (instance, device, mountpoint) predict_linear(node_filesystem_avail_bytes{fstype!~\"tmpfs\"}[1h], 24 * 3600) &lt; 0 and ON (instance, device, mountpoint) node_filesystem_readonly == 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host disk will fill in 24 hours (instance {{ $labels.instance }})\n      description: \"Filesystem is predicted to run out of space within the next 24 hours at current write rate\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#29-out-of-inodes","title":"2.9 Out of inodes","text":"<p>Disk is almost running out of available inodes (&lt; 10% left)</p> <pre><code>- alert: OutOfInodes\n  expr: node_filesystem_files_free{mountpoint =\"/rootfs\"} / node_filesystem_files{mountpoint =\"/rootfs\"} * 100 &lt; 10\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Out of inodes (instance {{ $labels.instance }})\"\n    description: \"Disk is almost running out of available inodes (&lt; 10% left)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#210-host-inodes-will-fill-in-24-hours","title":"2.10. Host inodes will fill in 24 hours","text":"<p>Filesystem is predicted to run out of inodes within the next 24 hours at current write rate</p> <pre><code>  - alert: HostInodesWillFillIn24Hours\n    expr: node_filesystem_files_free{mountpoint =\"/rootfs\"} / node_filesystem_files{mountpoint=\"/rootfs\"} * 100 &lt; 10 and predict_linear(node_filesystem_files_free{mountpoint=\"/rootfs\"}[1h], 24 * 3600) &lt; 0 and ON (instance, device, mountpoint) node_filesystem_readonly{mountpoint=\"/rootfs\"} == 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host inodes will fill in 24 hours (instance {{ $labels.instance }})\n      description: \"Filesystem is predicted to run out of inodes within the next 24 hours at current write rate\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#211-unusual-disk-read-latency","title":"2.11 Unusual disk read latency","text":"<p>Disk latency is growing (read operations &gt; 100ms)</p> <pre><code>- alert: UnusualDiskReadLatency\n  expr: rate(node_disk_read_time_seconds_total[1m]) / rate(node_disk_reads_completed_total[1m]) &gt; 100\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Unusual disk read latency (instance {{ $labels.instance }})\"\n    description: \"Disk latency is growing (read operations &gt; 100ms)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#212-unusual-disk-write-latency","title":"2.12 Unusual disk write latency","text":"<p>Disk latency is growing (write operations &gt; 100ms)</p> <pre><code>- alert: UnusualDiskWriteLatency\n  expr: rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]) &gt; 100\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Unusual disk write latency (instance {{ $labels.instance }})\"\n    description: \"Disk latency is growing (write operations &gt; 100ms)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#213-high-cpu-load","title":"2.13 High CPU load","text":"<p>CPU load is &gt; 80%</p> <pre><code>- alert: HighCpuLoad\n  expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100) &gt; 80\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"High CPU load (instance {{ $labels.instance }})\"\n    description: \"CPU load is &gt; 80%\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#214-host-cpu-steal-noisy-neighbor","title":"2.14. Host CPU steal noisy neighbor","text":"<p>CPU steal is &gt; 10%. A noisy neighbor is killing VM performances or a spot instance may be out of credit.</p> <pre><code>  - alert: HostCpuStealNoisyNeighbor\n    expr: avg by(instance) (rate(node_cpu_seconds_total{mode=\"steal\"}[5m])) * 100 &gt; 10\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host CPU steal noisy neighbor (instance {{ $labels.instance }})\n      description: \"CPU steal is &gt; 10%. A noisy neighbor is killing VM performances or a spot instance may be out of credit.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#215-host-context-switching","title":"2.15 Host Context switching","text":"<p>Context switching is growing on node (&gt; 1000 / s)</p> <pre><code># 1000 context switches is an arbitrary number.\n# Alert threshold depends on nature of application.\n# Please read: https://github.com/samber/awesome-prometheus-alerts/issues/58\n\n- alert: ContextSwitching\n  expr: rate(node_context_switches_total[5m]) &gt; 1000\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Context switching (instance {{ $labels.instance }})\"\n    description: \"Context switching is growing on node (&gt; 1000 / s)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#216-swap-is-filling-up","title":"2.16 Swap is filling up","text":"<p>Swap is filling up (&gt;80%)</p> <pre><code>- alert: SwapIsFillingUp\n  expr: (1 - (node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes)) * 100 &gt; 80\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Swap is filling up (instance {{ $labels.instance }})\"\n    description: \"Swap is filling up (&gt;80%)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#217-host-systemd-service-crashed","title":"2.17 Host Systemd service crashed","text":"<p>SystemD service crashed</p> <pre><code>- alert: SystemdServiceCrashed\n  expr: node_systemd_unit_state{state=\"failed\"} == 1\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"SystemD service crashed (instance {{ $labels.instance }})\"\n    description: \"SystemD service crashed\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#218-host-physical-component-too-hot","title":"2.18. Host physical component too hot","text":"<p>Physical hardware component too hot</p> <pre><code>  - alert: HostPhysicalComponentTooHot\n    expr: node_hwmon_temp_celsius &gt; 75\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host physical component too hot (instance {{ $labels.instance }})\n      description: \"Physical hardware component too hot\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#219-host-node-overtemperature-alarm","title":"2.19. Host node overtemperature alarm","text":"<p>Physical node temperature alarm triggered</p> <pre><code>  - alert: HostNodeOvertemperatureAlarm\n    expr: node_hwmon_temp_crit_alarm_celsius == 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Host node overtemperature alarm (instance {{ $labels.instance }})\n      description: \"Physical node temperature alarm triggered\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#220-host-raid-array-got-inactive","title":"2.20. Host RAID array got inactive","text":"<p>RAID array <code>{{ $labels.device }}</code> is in degraded state due to one or more disks failures. Number of spare drives is insufficient to fix issue automatically.</p> <pre><code>  - alert: HostRaidArrayGotInactive\n    expr: node_md_state{state=\"inactive\"} &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Host RAID array got inactive (instance {{ $labels.instance }})\n      description: \"RAID array {{ $labels.device }} is in degraded state due to one or more disks failures. Number of spare drives is insufficient to fix issue automatically.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#221-host-raid-disk-failure","title":"2.21. Host RAID disk failure","text":"<p>At least one device in RAID array on <code>{{ $labels.instance }}</code> failed. Array <code>{{ $labels.md_device }}</code> needs attention and possibly a disk swap</p> <pre><code>  - alert: HostRaidDiskFailure\n    expr: node_md_disks{state=\"failed\"} &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host RAID disk failure (instance {{ $labels.instance }})\n      description: \"At least one device in RAID array on {{ $labels.instance }} failed. Array {{ $labels.md_device }} needs attention and possibly a disk swap\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#222-host-kernel-version-deviations","title":"2.22. Host kernel version deviations","text":"<p>Different kernel versions are running</p> <pre><code>  - alert: HostKernelVersionDeviations\n    expr: count(sum(label_replace(node_uname_info, \"kernel\", \"$1\", \"release\", \"([0-9]+.[0-9]+.[0-9]+).*\")) by (kernel)) &gt; 1\n    for: 6h\n    labels:\n      severity: warning\n    annotations:\n      summary: Host kernel version deviations (instance {{ $labels.instance }})\n      description: \"Different kernel versions are running\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#223-host-oom-kill-detected","title":"2.23. Host OOM kill detected","text":"<p>OOM kill detected</p> <pre><code>  - alert: HostOomKillDetected\n    expr: increase(node_vmstat_oom_kill[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host OOM kill detected (instance {{ $labels.instance }})\n      description: \"OOM kill detected\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#224-host-edac-correctable-errors-detected","title":"2.24. Host EDAC Correctable Errors detected","text":"<p>Host <code>{{ $labels.instance }}</code> has had <code>{{ printf \"%.0f\" $value }}</code> correctable memory errors reported by EDAC in the last 5 minutes.</p> <pre><code>  - alert: HostEdacCorrectableErrorsDetected\n    expr: increase(node_edac_correctable_errors_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: info\n    annotations:\n      summary: Host EDAC Correctable Errors detected (instance {{ $labels.instance }})\n      description: \"Host {{ $labels.instance }} has had {{ printf \\\"%.0f\\\" $value }} correctable memory errors reported by EDAC in the last 5 minutes.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#225-host-edac-uncorrectable-errors-detected","title":"2.25. Host EDAC Uncorrectable Errors detected","text":"<p>Host <code>{{ $labels.instance }}</code> has had <code>{{ printf \"%.0f\" $value }}</code> correctable memory errors reported by EDAC in the last 5 minutes.</p> <pre><code>  - alert: HostEdacCorrectableErrorsDetected\n    expr: increase(node_edac_correctable_errors_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: info\n    annotations:\n      summary: Host EDAC Correctable Errors detected (instance {{ $labels.instance }})\n      description: \"Host {{ $labels.instance }} has had {{ printf \\\"%.0f\\\" $value }} correctable memory errors reported by EDAC in the last 5 minutes.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#226-host-network-receive-errors","title":"2.26. Host Network Receive Errors","text":"<p>Host <code>{{ $labels.instance }}</code> interface <code>{{ $labels.device }}</code> has encountered <code>{{ printf \"%.0f\" $value }}</code> receive errors in the last two minutes.</p> <pre><code>  - alert: HostNetworkReceiveErrors\n    expr: rate(node_network_receive_errs_total[2m]) / rate(node_network_receive_packets_total[2m]) &gt; 0.01\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host Network Receive Errors (instance {{ $labels.instance }})\n      description: \"Host {{ $labels.instance }} interface {{ $labels.device }} has encountered {{ printf \\\"%.0f\\\" $value }} receive errors in the last two minutes.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#227-host-network-transmit-errors","title":"2.27. Host Network Transmit Errors","text":"<p>Host <code>{{ $labels.instance }}</code> interface <code>{{ $labels.device }}</code> has encountered <code>{{ printf \"%.0f\" $value }}</code> transmit errors in the last two minutes.</p> <pre><code>  - alert: HostNetworkTransmitErrors\n    expr: rate(node_network_transmit_errs_total[2m]) / rate(node_network_transmit_packets_total[2m]) &gt; 0.01\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host Network Transmit Errors (instance {{ $labels.instance }})\n      description: \"Host {{ $labels.instance }} interface {{ $labels.device }} has encountered {{ printf \\\"%.0f\\\" $value }} transmit errors in the last two minutes.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#228-host-network-interface-saturated","title":"2.28. Host Network Interface Saturated","text":"<p>The network interface <code>\"{{ $labels.device }}\"</code> on <code>\"{{ $labels.instance }}\"</code> is getting overloaded.</p> <pre><code>  - alert: HostNetworkInterfaceSaturated\n    expr: (rate(node_network_receive_bytes_total{device!~\"^tap.*\"}[1m]) + rate(node_network_transmit_bytes_total{device!~\"^tap.*\"}[1m])) / node_network_speed_bytes{device!~\"^tap.*\"} &gt; 0.8 &lt; 10000\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host Network Interface Saturated (instance {{ $labels.instance }})\n      description: \"The network interface \\\"{{ $labels.device }}\\\" on \\\"{{ $labels.instance }}\\\" is getting overloaded.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#229-host-network-bond-degraded","title":"2.29. Host Network Bond Degraded","text":"<p>Bond <code>\"{{ $labels.device }}\"</code> degraded on \"<code>{{ $labels.instance }}</code>\".</p> <pre><code>  - alert: HostNetworkBondDegraded\n    expr: (node_bonding_active - node_bonding_slaves) != 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host Network Bond Degraded (instance {{ $labels.instance }})\n      description: \"Bond \\\"{{ $labels.device }}\\\" degraded on \\\"{{ $labels.instance }}\\\".\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#230-host-conntrack-limit","title":"2.30. Host conntrack limit","text":"<p>The number of conntrack is approaching limit</p> <pre><code>  - alert: HostConntrackLimit\n    expr: node_nf_conntrack_entries / node_nf_conntrack_entries_limit &gt; 0.8\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host conntrack limit (instance {{ $labels.instance }})\n      description: \"The number of conntrack is approaching limit\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#231-host-clock-skew","title":"2.31. Host clock skew","text":"<p>Clock skew detected. Clock is out of sync. Ensure NTP is configured correctly on this host.</p> <pre><code>  - alert: HostClockSkew\n    expr: (node_timex_offset_seconds &gt; 0.05 and deriv(node_timex_offset_seconds[5m]) &gt;= 0) or (node_timex_offset_seconds &lt; -0.05 and deriv(node_timex_offset_seconds[5m]) &lt;= 0)\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host clock skew (instance {{ $labels.instance }})\n      description: \"Clock skew detected. Clock is out of sync. Ensure NTP is configured correctly on this host.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#232-host-clock-not-synchronising","title":"2.32. Host clock not synchronising","text":"<p>Clock not synchronising. Ensure NTP is configured on this host.</p> <pre><code>  - alert: HostClockNotSynchronising\n    expr: min_over_time(node_timex_sync_status[1m]) == 0 and node_timex_maxerror_seconds &gt;= 16\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host clock not synchronising (instance {{ $labels.instance }})\n      description: \"Clock not synchronising. Ensure NTP is configured on this host.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2Host_node-exporter/#233-host-requires-reboot","title":"2.33. Host requires reboot","text":"<p><code>{{ $labels.instance }}</code> requires a reboot.</p> <pre><code>  - alert: HostRequiresReboot\n    expr: node_reboot_required &gt; 0\n    for: 4h\n    labels:\n      severity: info\n    annotations:\n      summary: Host requires reboot (instance {{ $labels.instance }})\n      description: \"{{ $labels.instance }} requires a reboot.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/2database_broker/","title":"2 Databases and brokers","text":""},{"location":"chap9/2database_broker/#1-mysql-prometheus","title":"1. MySQL : prometheus","text":"<ol> <li>MySQL down</li> <li>MySQL too many connections (&gt; 80%)</li> <li>MySQL high threads running</li> <li>MySQL Slave IO thread not running</li> <li>MySQL Slave SQL thread not running</li> <li>MySQL Slave replication lag</li> <li>MySQL slow queries</li> <li>MySQL InnoDB log waits</li> <li>MySQL restarted</li> </ol>"},{"location":"chap9/2database_broker/#2-postgresql","title":"2. PostgreSQL","text":"<ol> <li>PostgreSQL down</li> <li>Postgresql restarted</li> <li>Postgresql exporter error</li> <li>Replication lag</li> <li>Table not vaccumed</li> <li>Table not analyzed</li> <li>Too many connections</li> <li>Not enough connections</li> <li>Dead locks</li> <li>High rollback rate</li> <li>Postgresql commit rate low</li> <li>Postgresql low XID consumption</li> <li>Postgresql high rate statement timeout</li> <li>Postgresql high rate deadlock</li> <li>Postgresql unused replication slot</li> <li>Postgresql too many dead tuples</li> <li>Postgresql split brain</li> <li>Postgresql promoted node</li> <li>Postgresql configuration changed</li> <li>Postgresql SSL compression active</li> <li>Postgresql too many locks acquired</li> <li>Slow queries</li> </ol>"},{"location":"chap9/2database_broker/#3-sql-server","title":"3. SQL Server","text":"<ol> <li>SQL Server down</li> </ol>"},{"location":"chap9/2database_broker/#4-pgbouncer","title":"4 PGBouncer","text":"<ol> <li>PGBouncer active connections</li> <li>PGBouncer errors</li> <li>PGBouncer max connections</li> </ol>"},{"location":"chap9/2database_broker/#5-redis","title":"5 Redis","text":"<ol> <li>Redis down</li> <li>Redis missing master</li> <li>Redis too many masters</li> <li>Redis disconnected slaves</li> <li>Redis replication broken</li> <li>Redis cluster flapping</li> <li>Missing backup</li> <li>Redis out of system memory</li> <li>Redis out of configured maxmemory</li> <li>Too many connections</li> <li>Not enough connections</li> <li>Rejected connections</li> </ol>"},{"location":"chap9/2database_broker/#6-mongodb","title":"6 MongoDB","text":"<p>percona/<code>mongodb_exporter</code></p> <ol> <li>MongoDB Down</li> <li>MongoDB replication lag</li> <li>MongoDB replication headroom</li> <li>MongoDB number cursors open</li> <li>MongoDB cursors timeouts</li> <li>MongoDB too many connections</li> <li>MongoDB virtual memory usage</li> </ol> <p><code>dcu/mongodb_exporter</code></p> <ol> <li>Mongodb replication lag is more than 10s</li> <li>MongoDB replication Status 3</li> <li>MongoDB replication Status 6</li> <li>MongoDB replication Status 8</li> <li>MongoDB replication Status 9</li> <li>MongoDB replication Status 10</li> <li>MongoDB number cursors open</li> <li>MongoDB cursors timeouts</li> <li>MongoDB too many connections</li> <li>MongoDB virtual memory usage</li> </ol>"},{"location":"chap9/2database_broker/#7-rabbitmq","title":"7 RabbitMQ","text":"<p><code>rabbitmq/rabbitmq-prometheus</code></p> <ol> <li>Rabbitmq node down</li> <li>Rabbitmq node not distributed</li> <li>Rabbitmq instances different versions</li> <li>Rabbitmq memory high</li> <li>Rabbitmq file descriptors usage</li> <li>Rabbitmq too many unack messages</li> <li>Rabbitmq too many connections</li> <li>Rabbitmq no queue consumer</li> <li>Rabbitmq unroutable messages</li> </ol> <p><code>kbudde/rabbitmq-exporter</code></p> <ol> <li>Rabbitmq node down</li> <li>Rabbitmq Cluster down</li> <li>Rabbitmq cluster partition</li> <li>Rabbitmq out of memory</li> <li>Too many connections</li> <li>Dead letter queue filling up</li> <li>Too many messages in queue</li> <li>Rabbitmq Slow queue consuming</li> <li>No consumer</li> <li>Too many consumers</li> <li>Unactive exchange</li> </ol>"},{"location":"chap9/2database_broker/#8-elasticsearch","title":"8 Elasticsearch","text":"<ol> <li>Elastic Heap Usage Too High</li> <li>Elastic Heap Usage warning</li> <li>Elasticsearch disk out of space</li> <li>Elasticsearch disk space low</li> <li>Elastic Cluster Red</li> <li>Elastic Cluster Yellow</li> <li>Elasticsearch Healthy Nodes</li> <li>Number of Elastic Healthy Nodes</li> <li>Elasticsearch relocating shards</li> <li>Elasticsearch relocating shards too long</li> <li>Elasticsearch initializing shards</li> <li>Elasticsearch initializing shards too long</li> <li>Elasticsearch unassigned shards</li> <li>Elasticsearch pending tasks</li> <li>Elasticsearch no new documents</li> <li>Number of pending tasks</li> <li>Number of Elastic Healthy Data Nodes</li> </ol>"},{"location":"chap9/2database_broker/#9cassandra","title":"9.Cassandra","text":"<p><code>instaclustr/cassandra_exporter</code></p> <ol> <li>Cassandra Node is unavailable</li> <li>Cassandra many compaction tasks are pending</li> <li>Cassandra commitlog pending tasks</li> <li>Cassandra compaction executor blocked tasks</li> <li>Cassandra flush writer blocked tasks</li> <li>Cassandra connection timeouts total</li> <li>Cassandra storage exceptions</li> <li>Cassandra tombstone dump</li> <li>Cassandra client request unvailable write</li> <li>Cassandra client request unvailable read</li> <li>Cassandra client request write failure</li> <li>Cassandra client request read failure</li> </ol> <p><code>criteo/cassandra_exporter</code></p> <ol> <li>Cassandra hints count</li> <li>Cassandra compaction task pending</li> <li>Cassandra viewwrite latency</li> <li>Cassandra bad hacker</li> <li>Cassandra node down</li> <li>Cassandra commitlog pending tasks</li> <li>Cassandra compaction executor blocked tasks</li> <li>Cassandra flush writer blocked tasks</li> <li>Cassandra repair pending tasks</li> <li>Cassandra repair blocked tasks</li> <li>Cassandra connection timeouts total</li> <li>Cassandra storage exceptions</li> <li>Cassandra tombstone dump</li> <li>Cassandra client request unvailable write</li> <li>Cassandra client request unvailable read</li> <li>Cassandra client request write failure</li> <li>Cassandra client request read failure</li> <li>Cassandra cache hit rate key cache</li> </ol>"},{"location":"chap9/2database_broker/#10-kafka","title":"10 Kafka","text":"<p><code>danielqsj/kafka_exporter</code></p> <ol> <li>Kafka Topics</li> <li>Kafka consumers group</li> </ol> <p>linkedin/Burrow</p> <ol> <li>Kafka topic offset decreased</li> <li>Kafka consumer lag</li> </ol>"},{"location":"chap9/2database_broker/#11-zookeeper","title":"11 Zookeeper","text":"<ol> <li>Zookeeper Down</li> <li>Zookeeper missing leader</li> <li>Zookeeper Too Many Leaders</li> <li>Zookeeper Not Ok</li> </ol>"},{"location":"chap9/2database_broker/#12-solr","title":"12 Solr","text":"<ol> <li>Solr update errors</li> <li>Solr query errors</li> <li>Solr replication errors</li> <li>Solr low live node count</li> </ol>"},{"location":"chap9/30CoreDNS/","title":"30. CoreDNS","text":""},{"location":"chap9/30CoreDNS/#1-coredns-panic-count","title":"1. CoreDNS Panic Count","text":"<p>Number of CoreDNS panics encountered</p> <pre><code>- alert: CorednsPanicCount\n  expr: increase(coredns_panic_count_total[10m]) &gt; 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"CoreDNS Panic Count (instance {{ $labels.instance }})\"\n    description: \"Number of CoreDNS panics encountered\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/31windows_server/","title":"5. Windows Server: <code>prometheus-community/windows_exporter</code>","text":"<p>https://github.com/prometheus-community/windows_exporter</p>"},{"location":"chap9/31windows_server/#51-windows-server-collector-error","title":"5.1. Windows Server collector Error","text":"<p>Collector <code>{{ $labels.collector }}</code> was not successful</p> <pre><code>  - alert: WindowsServerCollectorError\n    expr: windows_exporter_collector_success == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Windows Server collector Error (instance {{ $labels.instance }})\n      description: \"Collector {{ $labels.collector }} was not successful\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/31windows_server/#52-windows-server-service-status","title":"5.2 Windows Server service Status","text":"<p>Windows Service state is not OK</p> <pre><code>  - alert: WindowsServerServiceStatus\n    expr: windows_service_status{status=\"ok\"} != 1\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: Windows Server service Status (instance {{ $labels.instance }})\n      description: \"Windows Service state is not OK\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/31windows_server/#53-windows-server-cpu-usage","title":"5.3. Windows Server CPU Usage","text":"<p>CPU Usage is more than 80%</p> <pre><code>  - alert: WindowsServerCpuUsage\n    expr: 100 - (avg by (instance) (rate(windows_cpu_time_total{mode=\"idle\"}[2m])) * 100) &gt; 80\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Windows Server CPU Usage (instance {{ $labels.instance }})\n      description: \"CPU Usage is more than 80%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/31windows_server/#54-windows-server-memory-usage","title":"5.4. Windows Server memory Usage","text":"<p>Memory usage is more than 90%</p> <pre><code>  - alert: WindowsServerMemoryUsage\n    expr: 100 - ((windows_os_physical_memory_free_bytes / windows_cs_physical_memory_bytes) * 100) &gt; 90\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Windows Server memory Usage (instance {{ $labels.instance }})\n      description: \"Memory usage is more than 90%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/31windows_server/#55-windows-server-disk-space-usage","title":"5.5. Windows Server disk Space Usage","text":"<p>Disk usage is more than 80%</p> <pre><code>  - alert: WindowsServerDiskSpaceUsage\n    expr: 100.0 - 100 * ((windows_logical_disk_free_bytes / 1024 / 1024 ) / (windows_logical_disk_size_bytes / 1024 / 1024)) &gt; 80\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Windows Server disk Space Usage (instance {{ $labels.instance }})\n      description: \"Disk usage is more than 80%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/32VMware/","title":"6 VMware : pryorda/vmware_exporter","text":""},{"location":"chap9/32VMware/#61-virtual-machine-memory-warning","title":"6.1 Virtual Machine Memory Warning","text":"<p>High memory usage on <code>{{ $labels.instance }}: {{ $value | printf \"%.2f\"}}%</code></p> <pre><code>  - alert: VirtualMachineMemoryWarning\n    expr: vmware_vm_mem_usage_average / 100 &gt;= 80 and vmware_vm_mem_usage_average / 100 &lt; 90\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Virtual Machine Memory Warning (instance {{ $labels.instance }})\n      description: \"High memory usage on {{ $labels.instance }}: {{ $value | printf \\\"%.2f\\\"}}%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/32VMware/#62-virtual-machine-memory-critical","title":"6.2. Virtual Machine Memory Critical","text":"<p>High memory usage on <code>{{ $labels.instance }}: {{ $value | printf \"%.2f\"}}%</code></p> <pre><code>  - alert: VirtualMachineMemoryCritical\n    expr: vmware_vm_mem_usage_average / 100 &gt;= 90\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: Virtual Machine Memory Critical (instance {{ $labels.instance }})\n      description: \"High memory usage on {{ $labels.instance }}: {{ $value | printf \\\"%.2f\\\"}}%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/32VMware/#63-high-number-of-snapshots","title":"6.3. High Number of Snapshots","text":"<p>High snapshots number on <code>{{ $labels.instance }}: {{ $value }}</code></p> <pre><code>  - alert: HighNumberOfSnapshots\n    expr: vmware_vm_snapshots &gt; 3\n    for: 30m\n    labels:\n      severity: warning\n    annotations:\n      summary: High Number of Snapshots (instance {{ $labels.instance }})\n      description: \"High snapshots number on {{ $labels.instance }}: {{ $value }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/32VMware/#64-outdated-snapshots","title":"6.4. Outdated Snapshots","text":"<p>Outdated snapshots on <code>{{ $labels.instance }}: {{ $value | printf \"%.0f\"}}</code> days</p> <pre><code>  - alert: OutdatedSnapshots\n    expr: (time() - vmware_vm_snapshot_timestamp_seconds) / (60 * 60 * 24) &gt;= 3\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Outdated Snapshots (instance {{ $labels.instance }})\n      description: \"Outdated snapshots on {{ $labels.instance }}: {{ $value | printf \\\"%.0f\\\"}} days\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/33Netdata/","title":"7 Netdata : Embedded exporter","text":"<p>Embedded exporter</p>"},{"location":"chap9/33Netdata/#71-netdata-high-cpu-usage","title":"7.1. Netdata high cpu usage","text":"<p>Netdata high CPU usage (&gt; 80%)</p> <pre><code>  - alert: NetdataHighCpuUsage\n    expr: rate(netdata_cpu_cpu_percentage_average{dimension=\"idle\"}[1m]) &gt; 80\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Netdata high cpu usage (instance {{ $labels.instance }})\n      description: \"Netdata high CPU usage (&gt; 80%)\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/33Netdata/#72-host-cpu-steal-noisy-neighbor","title":"7.2. Host CPU steal noisy neighbor","text":"<p>CPU steal is &gt; 10%. A noisy neighbor is killing VM performances or a spot instance may be out of credit.</p> <pre><code>  - alert: HostCpuStealNoisyNeighbor\n    expr: rate(netdata_cpu_cpu_percentage_average{dimension=\"steal\"}[1m]) &gt; 10\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Host CPU steal noisy neighbor (instance {{ $labels.instance }})\n      description: \"CPU steal is &gt; 10%. A noisy neighbor is killing VM performances or a spot instance may be out of credit.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/33Netdata/#73-netdata-high-memory-usage","title":"7.3. Netdata high memory usage","text":"<p>Netdata high memory usage (&gt; 80%)</p> <pre><code>  - alert: NetdataHighMemoryUsage\n    expr: 100 / netdata_system_ram_MB_average * netdata_system_ram_MB_average{dimension=~\"free|cached\"} &lt; 20\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Netdata high memory usage (instance {{ $labels.instance }})\n      description: \"Netdata high memory usage (&gt; 80%)\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/33Netdata/#74-netdata-low-disk-space","title":"7.4. Netdata low disk space","text":"<p>Netdata low disk space (&gt; 80%)</p> <pre><code>  - alert: NetdataLowDiskSpace\n    expr: 100 / netdata_disk_space_GB_average * netdata_disk_space_GB_average{dimension=~\"avail|cached\"} &lt; 20\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Netdata low disk space (instance {{ $labels.instance }})\n      description: \"Netdata low disk space (&gt; 80%)\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/33Netdata/#75-netdata-predicted-disk-full","title":"7.5. Netdata predicted disk full","text":"<p>Netdata predicted disk full in 24 hours</p> <pre><code>  - alert: NetdataPredictedDiskFull\n    expr: predict_linear(netdata_disk_space_GB_average{dimension=~\"avail|cached\"}[3h], 24 * 3600) &lt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Netdata predicted disk full (instance {{ $labels.instance }})\n      description: \"Netdata predicted disk full in 24 hours\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/33Netdata/#76-netdata-md-mismatch-cnt-unsynchronized-blocks","title":"7.6. Netdata MD mismatch cnt unsynchronized blocks","text":"<p>RAID Array have unsynchronized blocks</p> <pre><code>  - alert: NetdataMdMismatchCntUnsynchronizedBlocks\n    expr: netdata_md_mismatch_cnt_unsynchronized_blocks_average &gt; 1024\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Netdata MD mismatch cnt unsynchronized blocks (instance {{ $labels.instance }})\n      description: \"RAID Array have unsynchronized blocks\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/33Netdata/#77-netdata-disk-reallocated-sectors","title":"7.7. Netdata disk reallocated sectors","text":"<p>Reallocated sectors on disk</p> <pre><code>  - alert: NetdataDiskReallocatedSectors\n    expr: increase(netdata_smartd_log_reallocated_sectors_count_sectors_average[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: info\n    annotations:\n      summary: Netdata disk reallocated sectors (instance {{ $labels.instance }})\n      description: \"Reallocated sectors on disk\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/33Netdata/#78-netdata-disk-current-pending-sector","title":"7.8. Netdata disk current pending sector","text":"<p>Disk current pending sector</p> <pre><code>  - alert: NetdataDiskCurrentPendingSector\n    expr: netdata_smartd_log_current_pending_sector_count_sectors_average &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Netdata disk current pending sector (instance {{ $labels.instance }})\n      description: \"Disk current pending sector\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/33Netdata/#79-netdata-reported-uncorrectable-disk-sectors","title":"7.9. Netdata reported uncorrectable disk sectors","text":"<p>Reported uncorrectable disk sectors</p> <pre><code>  - alert: NetdataReportedUncorrectableDiskSectors\n    expr: increase(netdata_smartd_log_offline_uncorrectable_sector_count_sectors_average[2m]) &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Netdata reported uncorrectable disk sectors (instance {{ $labels.instance }})\n      description: \"Reported uncorrectable disk sectors\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/34SQLServer/","title":"3 SQL Server","text":"<p>Ozarklake/prometheus-mssql-exporter</p>"},{"location":"chap9/34SQLServer/#1-sql-server-down","title":"1. SQL Server down","text":"<p>SQL server instance is down</p> <pre><code>  - alert: SqlServerDown\n    expr: mssql_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: SQL Server down (instance {{ $labels.instance }})\n      description: \"SQL server instance is down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/34SQLServer/#82-sql-server-deadlock","title":"8.2. SQL Server deadlock","text":"<p>SQL Server is having some deadlock.</p> <pre><code>  - alert: SqlServerDeadlock\n    expr: increase(mssql_deadlocks[1m]) &gt; 5\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: SQL Server deadlock (instance {{ $labels.instance }})\n      description: \"SQL Server is having some deadlock.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/35PGBouncer/","title":"4 PGBouncer","text":"<p>spreaker/prometheus-pgbouncer-exporter </p>"},{"location":"chap9/35PGBouncer/#1-pgbouncer-active-connections","title":"1 PGBouncer active connections","text":"<p>PGBouncer pools are filling up</p> <pre><code>  - alert: PgbouncerActiveConnections\n    expr: pgbouncer_pools_server_active_connections &gt; 200\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: PGBouncer active connections (instance {{ $labels.instance }})\n      description: \"PGBouncer pools are filling up\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/35PGBouncer/#2-pgbouncer-errors","title":"2. PGBouncer errors","text":"<p>PGBouncer is logging errors. This may be due to a a server restart or an admin typing commands at the pgbouncer console.</p> <pre><code>  - alert: PgbouncerErrors\n    expr: increase(pgbouncer_errors_count{errmsg!=\"server conn crashed?\"}[1m]) &gt; 10\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: PGBouncer errors (instance {{ $labels.instance }})\n      description: \"PGBouncer is logging errors. This may be due to a a server restart or an admin typing commands at the pgbouncer console.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/35PGBouncer/#3-pgbouncer-max-connections","title":"3. PGBouncer max connections","text":"<p>The number of PGBouncer client connections has reached <code>max_client_conn</code>.</p> <pre><code>  - alert: PgbouncerMaxConnections\n    expr: increase(pgbouncer_errors_count{errmsg=\"no more connections allowed (max_client_conn)\"}[30s]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: PGBouncer max connections (instance {{ $labels.instance }})\n      description: \"The number of PGBouncer client connections has reached max_client_conn.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/36solr/","title":"12 Solr : embedded exporter","text":"<p>embedded exporter </p>"},{"location":"chap9/36solr/#1-solr-update-errors","title":"1. Solr update errors","text":"<p>Solr collection <code>{{ $labels.collection }}</code>has failed updates for replica <code>{{ $labels.replica }} on {{ $labels.base_url }}</code>.</p> <pre><code>  - alert: SolrUpdateErrors\n    expr: increase(solr_metrics_core_update_handler_errors_total[1m]) &gt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Solr update errors (instance {{ $labels.instance }})\n      description: \"Solr collection {{ $labels.collection }} has failed updates for replica {{ $labels.replica }} on {{ $labels.base_url }}.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/36solr/#2-solr-query-errors","title":"2. Solr query errors","text":"<p>Solr has increased query errors in collection <code>{{ $labels.collection }}</code> for replica <code>{{ $labels.replica }}</code> on <code>{{ $labels.base_url }}</code>.</p> <pre><code>  - alert: SolrQueryErrors\n    expr: increase(solr_metrics_core_errors_total{category=\"QUERY\"}[1m]) &gt; 1\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Solr query errors (instance {{ $labels.instance }})\n      description: \"Solr has increased query errors in collection {{ $labels.collection }} for replica {{ $labels.replica }} on {{ $labels.base_url }}.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/36solr/#3-solr-replication-errors","title":"3. Solr replication errors","text":"<p>Solr collection <code>{{ $labels.collection }}</code> has failed updates for replica <code>{{ $labels.replica }}</code> on <code>{{ $labels.base_url }}</code>.</p> <pre><code>  - alert: SolrReplicationErrors\n    expr: increase(solr_metrics_core_errors_total{category=\"REPLICATION\"}[1m]) &gt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Solr replication errors (instance {{ $labels.instance }})\n      description: \"Solr collection {{ $labels.collection }} has failed updates for replica {{ $labels.replica }} on {{ $labels.base_url }}.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/36solr/#4-solr-low-live-node-count","title":"4. Solr low live node count","text":"<p>Solr collection <code>{{ $labels.collection }}</code> has less than two live nodes for replica <code>{{ $labels.replica }}</code> on <code>{{ $labels.base_url }}</code>.</p> <pre><code>  - alert: SolrLowLiveNodeCount\n    expr: solr_collections_live_nodes &lt; 2\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Solr low live node count (instance {{ $labels.instance }})\n      description: \"Solr collection {{ $labels.collection }} has less than two live nodes for replica {{ $labels.replica }} on {{ $labels.base_url }}.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/37Sidekiq/","title":"3 Sidekiq","text":""},{"location":"chap9/37Sidekiq/#strechsidekiq-prometheus-exporter","title":"Strech/sidekiq-prometheus-exporter","text":""},{"location":"chap9/37Sidekiq/#1-sidekiq-queue-size","title":"1 Sidekiq queue size","text":"<p>Sidekiq queue <code>{{ $labels.name }}</code> is growing</p> <pre><code>  - alert: SidekiqQueueSize\n    expr: sidekiq_queue_size &gt; 100\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Sidekiq queue size (instance {{ $labels.instance }})\n      description: \"Sidekiq queue {{ $labels.name }} is growing\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/37Sidekiq/#2-sidekiq-scheduling-latency-too-high","title":"2 Sidekiq scheduling latency too high","text":"<p>Sidekiq jobs are taking more than 1min to be picked up. Users may be seeing delays in background processing.</p> <pre><code>  - alert: SidekiqSchedulingLatencyTooHigh\n    expr: max(sidekiq_queue_latency) &gt; 60\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Sidekiq scheduling latency too high (instance {{ $labels.instance }})\n      description: \"Sidekiq jobs are taking more than 1min to be picked up. Users may be seeing delays in background processing.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/","title":"1 Ceph : Embedded exporter","text":"<p>Embedded exporter</p>"},{"location":"chap9/38ceph/#1-ceph-state","title":"1. Ceph State","text":"<p>Ceph instance unhealthy</p> <pre><code>  - alert: CephState\n    expr: ceph_health_status != 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Ceph State (instance {{ $labels.instance }})\n      description: \"Ceph instance unhealthy\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#2-ceph-monitor-clock-skew","title":"2. Ceph monitor clock skew","text":"<p>Ceph monitor clock skew detected. Please check ntp and hardware clock settings</p> <pre><code>  - alert: CephMonitorClockSkew\n    expr: abs(ceph_monitor_clock_skew_seconds) &gt; 0.2\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Ceph monitor clock skew (instance {{ $labels.instance }})\n      description: \"Ceph monitor clock skew detected. Please check ntp and hardware clock settings\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#3-ceph-monitor-low-space","title":"3. Ceph monitor low space","text":"<p>Ceph monitor storage is low.</p> <pre><code>  - alert: CephMonitorLowSpace\n    expr: ceph_monitor_avail_percent &lt; 10\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Ceph monitor low space (instance {{ $labels.instance }})\n      description: \"Ceph monitor storage is low.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#4-ceph-osd-down","title":"4. Ceph OSD Down","text":"<p>Ceph Object Storage Daemon Down</p> <pre><code>  - alert: CephOsdDown\n    expr: ceph_osd_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Ceph OSD Down (instance {{ $labels.instance }})\n      description: \"Ceph Object Storage Daemon Down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#5-ceph-high-osd-latency","title":"5. Ceph high OSD latency","text":"<p>Ceph Object Storage Daemon latency is high. Please check if it doesn't stuck in weird state.</p> <pre><code>  - alert: CephHighOsdLatency\n    expr: ceph_osd_perf_apply_latency_seconds &gt; 5\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Ceph high OSD latency (instance {{ $labels.instance }})\n      description: \"Ceph Object Storage Daemon latency is high. Please check if it doesn't stuck in weird state.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#6-ceph-osd-low-space","title":"6. Ceph OSD low space","text":"<p>Ceph Object Storage Daemon is going out of space. Please add more disks.</p> <pre><code>  - alert: CephOsdLowSpace\n    expr: ceph_osd_utilization &gt; 90\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Ceph OSD low space (instance {{ $labels.instance }})\n      description: \"Ceph Object Storage Daemon is going out of space. Please add more disks.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#7-ceph-osd-reweighted","title":"7. Ceph OSD reweighted","text":"<p>Ceph Object Storage Daemon takes too much time to resize.</p> <pre><code>  - alert: CephOsdReweighted\n    expr: ceph_osd_weight &lt; 1\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Ceph OSD reweighted (instance {{ $labels.instance }})\n      description: \"Ceph Object Storage Daemon takes too much time to resize.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#8-ceph-pg-down","title":"8. Ceph PG down","text":"<p>Some Ceph placement groups are down. Please ensure that all the data are available.</p> <pre><code>  - alert: CephPgDown\n    expr: ceph_pg_down &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Ceph PG down (instance {{ $labels.instance }})\n      description: \"Some Ceph placement groups are down. Please ensure that all the data are available.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#9-ceph-pg-incomplete","title":"9. Ceph PG incomplete","text":"<p>Some Ceph placement groups are incomplete. Please ensure that all the data are available.</p> <pre><code>  - alert: CephPgIncomplete\n    expr: ceph_pg_incomplete &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Ceph PG incomplete (instance {{ $labels.instance }})\n      description: \"Some Ceph placement groups are incomplete. Please ensure that all the data are available.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#10-ceph-pg-inconsistent","title":"10. Ceph PG inconsistent","text":"<p>Some Ceph placement groups are inconsistent. Data is available but inconsistent across nodes.</p> <pre><code>  - alert: CephPgInconsistent\n    expr: ceph_pg_inconsistent &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Ceph PG inconsistent (instance {{ $labels.instance }})\n      description: \"Some Ceph placement groups are inconsistent. Data is available but inconsistent across nodes.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#11-ceph-pg-activation-long","title":"11. Ceph PG activation long","text":"<p>Some Ceph placement groups are too long to activate.</p> <pre><code>  - alert: CephPgActivationLong\n    expr: ceph_pg_activating &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Ceph PG activation long (instance {{ $labels.instance }})\n      description: \"Some Ceph placement groups are too long to activate.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#12-ceph-pg-backfill-full","title":"12. Ceph PG backfill full","text":"<p>Some Ceph placement groups are located on full Object Storage Daemon on cluster. Those PGs can be unavailable shortly. Please check OSDs, change weight or reconfigure CRUSH rules.</p> <pre><code>  - alert: CephPgBackfillFull\n    expr: ceph_pg_backfill_toofull &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Ceph PG backfill full (instance {{ $labels.instance }})\n      description: \"Some Ceph placement groups are located on full Object Storage Daemon on cluster. Those PGs can be unavailable shortly. Please check OSDs, change weight or reconfigure CRUSH rules.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/38ceph/#13-ceph-pg-unavailable","title":"13. Ceph PG unavailable","text":"<p>Some Ceph placement groups are unavailable.</p> <pre><code>  - alert: CephPgUnavailable\n    expr: ceph_pg_total - ceph_pg_active &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Ceph PG unavailable (instance {{ $labels.instance }})\n      description: \"Some Ceph placement groups are unavailable.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/39SpeedTest/","title":"2 SpeedTest : Speedtest exporter","text":"<p>Speedtest exporter</p>"},{"location":"chap9/39SpeedTest/#1-speedtest-slow-internet-download","title":"1. SpeedTest Slow Internet Download","text":"<p>Internet download speed is currently <code>{{humanize $value}}</code> Mbps.</p> <pre><code>  - alert: SpeedtestSlowInternetDownload\n    expr: avg_over_time(speedtest_download[10m]) &lt; 100\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: SpeedTest Slow Internet Download (instance {{ $labels.instance }})\n      description: \"Internet download speed is currently {{humanize $value}} Mbps.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/39SpeedTest/#2-speedtest-slow-internet-upload","title":"2. SpeedTest Slow Internet Upload","text":"<p>Internet upload speed is currently <code>{{humanize $value}}</code> Mbps.</p> <pre><code>  - alert: SpeedtestSlowInternetUpload\n    expr: avg_over_time(speedtest_upload[10m]) &lt; 20\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: SpeedTest Slow Internet Upload (instance {{ $labels.instance }})\n      description: \"Internet upload speed is currently {{humanize $value}} Mbps.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/3Docker_cadvisor/","title":"3 Docker containers : cAdvisor","text":"<p>https://github.com/google/cadvisor</p>"},{"location":"chap9/3Docker_cadvisor/#31-container-killed","title":"3.1 Container killed","text":"<p>A container has disappeared</p> <pre><code>- alert: ContainerKilled\n  expr: time() - container_last_seen &gt; 60\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Container killed (instance {{ $labels.instance }})\"\n    description: \"A container has disappeared\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/3Docker_cadvisor/#32-container-cpu-usage","title":"3.2 Container CPU usage","text":"<p>Container CPU usage is above 80%</p> <pre><code>- alert: ContainerCpuUsage\n  expr: (sum(rate(container_cpu_usage_seconds_total[3m])) BY (ip, name) * 100) &gt; 80\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Container CPU usage (instance {{ $labels.instance }})\"\n    description: \"Container CPU usage is above 80%\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/3Docker_cadvisor/#33-container-memory-usage","title":"3.3 Container Memory usage","text":"<p>Container Memory usage is above 80%</p> <pre><code>- alert: ContainerMemoryUsage\n  expr: (sum(container_memory_usage_bytes) BY (ip) / sum(container_memory_max_usage_bytes) BY (ip) * 100) &gt; 80\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Container Memory usage (instance {{ $labels.instance }})\"\n    description: \"Container Memory usage is above 80%\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/3Docker_cadvisor/#34-container-volume-usage","title":"3.4 Container Volume usage","text":"<p>Container Volume usage is above 80%</p> <pre><code>- alert: ContainerVolumeUsage\n  expr: (1 - (sum(container_fs_inodes_free) BY (ip) / sum(container_fs_inodes_total) BY (ip)) * 100) &gt; 80\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Container Volume usage (instance {{ $labels.instance }})\"\n    description: \"Container Volume usage is above 80%\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/3Docker_cadvisor/#35-container-volume-io-usage","title":"3.5 Container Volume I/O usage","text":"<p>Container Volume IO usage is above 80%</p> <pre><code>- alert: ContainerVolumeIoUsage\n  expr: (sum(container_fs_io_current) BY (ip, name) * 100) &gt; 80\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Container Volume IO usage (instance {{ $labels.instance }})\"\n    description: \"Container Volume IO usage is above 80%\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/3Docker_cadvisor/#36-container-absent","title":"3.6 Container absent","text":"<p>A container is absent for 5 min</p> <pre><code>  # This rule can be very noisy in dynamic infra with legitimate container start/stop/deployment.\n  - alert: ContainerAbsent\n    expr: absent(container_last_seen)\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Container absent (instance {{ $labels.instance }})\n      description: \"A container is absent for 5 min\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/3Docker_cadvisor/#37-container-high-throttle-rate","title":"3.7. Container high throttle rate","text":"<p>Container is being throttled</p> <pre><code>  - alert: ContainerHighThrottleRate\n    expr: rate(container_cpu_cfs_throttled_seconds_total[3m]) &gt; 1\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Container high throttle rate (instance {{ $labels.instance }})\n      description: \"Container is being throttled\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n\n</code></pre>"},{"location":"chap9/3proxy_lb/","title":"3 Reverse proxies and load balancers","text":""},{"location":"chap9/3proxy_lb/#1-nginx","title":"1 Nginx","text":"<ol> <li>HTTP errors 4xx</li> <li>HTTP errors 5xx</li> <li>Nginx latency high</li> </ol>"},{"location":"chap9/3proxy_lb/#2-apache","title":"2 Apache","text":"<ol> <li>Apache down</li> <li>Apache workers load</li> <li>Apache restart</li> </ol>"},{"location":"chap9/3proxy_lb/#3-haproxy","title":"3 HaProxy","text":"<p>Embedded exporter (HAProxy &gt;= v2)</p> <ol> <li>HAProxy high HTTP 4xx error rate backend</li> <li>HAProxy high HTTP 5xx error rate backend</li> <li>HAProxy high HTTP 4xx error rate server</li> <li>HAProxy high HTTP 5xx error rate server</li> <li>HAProxy server response errors</li> <li>HAProxy backend connection errors</li> <li>HAProxy server connection errors</li> <li>HAProxy backend max active session &gt; 80%</li> <li>HAProxy pending requests</li> <li>HAProxy HTTP slowing down</li> <li>HAProxy retry high</li> <li>HAproxy has no alive backends</li> <li>HAProxy frontend security blocked requests</li> <li>HAProxy server healthcheck failure</li> </ol> <p>prometheus/haproxy_exporter (HAProxy &lt; v2)</p> <ol> <li>HAProxy down</li> <li>HAProxy high HTTP 4xx error rate backend</li> <li>HAProxy high HTTP 5xx error rate backend</li> <li>HAProxy high HTTP 4xx error rate server</li> <li>HAProxy high HTTP 5xx error rate server</li> <li>HAProxy server response errors</li> <li>HAProxy backend connection errors</li> <li>HAProxy server connection errors</li> <li>HAProxy backend max active session</li> <li>HAProxy pending requests</li> <li>HAProxy HTTP slowing down</li> <li>HAProxy retry high</li> <li>HAProxy backend down</li> <li>HAProxy server down</li> <li>HAProxy frontend security blocked requests</li> <li>HAProxy server healthcheck failure</li> </ol>"},{"location":"chap9/3proxy_lb/#4-traefik","title":"4 Traefik","text":"<p>ExporterV2: observability/metrics/prometheus/</p> <ol> <li>Traefik service down</li> <li>Traefik high HTTP 4xx error rate service </li> <li>Traefik high HTTP 5xx error rate service</li> </ol> <p>ExporterV1: observability/metrics/prometheus/</p> <ol> <li>Traefik backend down</li> <li>Traefik backend errors</li> <li>Traefik high HTTP 5xx error rate backend</li> </ol>"},{"location":"chap9/40ssl_tls/","title":"6. SSL/TLS : ssl_exporter","text":""},{"location":"chap9/40ssl_tls/#1-ssl-certificate-probe-failed","title":"1. SSL certificate probe failed","text":"<p>Failed to fetch SSL information <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: SslCertificateProbeFailed\n    expr: ssl_probe_success == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: SSL certificate probe failed (instance {{ $labels.instance }})\n      description: \"Failed to fetch SSL information {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/40ssl_tls/#2-ssl-certificate-oscp-status-unknown","title":"2. SSL certificate OSCP status unknown","text":"<p>Failed to get the OSCP status <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: SslCertificateOscpStatusUnknown\n    expr: ssl_ocsp_response_status == 2\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: SSL certificate OSCP status unknown (instance {{ $labels.instance }})\n      description: \"Failed to get the OSCP status {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/40ssl_tls/#3-ssl-certificate-revoked","title":"3. SSL certificate revoked","text":"<p>SSL certificate revoked <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: SslCertificateRevoked\n    expr: ssl_ocsp_response_status == 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: SSL certificate revoked (instance {{ $labels.instance }})\n      description: \"SSL certificate revoked {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/40ssl_tls/#4-ssl-certificate-expiry-7-days","title":"4. SSL certificate expiry (&lt; 7 days)","text":"<p><code>{{ $labels.instance }}</code> Certificate is expiring in 7 days</p> <pre><code>  - alert: SslCertificateExpiry(&lt;7Days)\n    expr: ssl_verified_cert_not_after{chain_no=\"0\"} - time() &lt; 86400 * 7\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: SSL certificate expiry (&lt; 7 days) (instance {{ $labels.instance }})\n      description: \"{{ $labels.instance }} Certificate is expiring in 7 days\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/41Freeswitch/","title":"9 Freeswitch","text":"<p>znerol/prometheus-freeswitch-exporter</p>"},{"location":"chap9/41Freeswitch/#1-freeswitch-down","title":"1. Freeswitch down","text":"<p>Freeswitch is unresponsive</p> <pre><code>  - alert: FreeswitchDown\n    expr: freeswitch_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Freeswitch down (instance {{ $labels.instance }})\n      description: \"Freeswitch is unresponsive\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/41Freeswitch/#2-freeswitch-sessions-warning","title":"2. Freeswitch Sessions Warning","text":"<p>High sessions usage on <code>{{ $labels.instance }}: {{ $value | printf \"%.2f\"}}%</code></p> <pre><code>  - alert: FreeswitchSessionsWarning\n    expr: (freeswitch_session_active * 100 / freeswitch_session_limit) &gt; 80\n    for: 10m\n    labels:\n      severity: warning\n    annotations:\n      summary: Freeswitch Sessions Warning (instance {{ $labels.instance }})\n      description: \"High sessions usage on {{ $labels.instance }}: {{ $value | printf \\\"%.2f\\\"}}%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/41Freeswitch/#3-freeswitch-sessions-critical","title":"3. Freeswitch Sessions Critical","text":"<p>High sessions usage on <code>{{ $labels.instance }}: {{ $value | printf \"%.2f\"}}%</code></p> <pre><code>  - alert: FreeswitchSessionsCritical\n    expr: (freeswitch_session_active * 100 / freeswitch_session_limit) &gt; 90\n    for: 5m\n    labels:\n      severity: critical\n    annotations:\n      summary: Freeswitch Sessions Critical (instance {{ $labels.instance }})\n      description: \"High sessions usage on {{ $labels.instance }}: {{ $value | printf \\\"%.2f\\\"}}%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/42vault/","title":"10. Hashicorp Vault","text":"<p>Embedded exporter</p>"},{"location":"chap9/42vault/#1-vault-sealed","title":"1. Vault sealed","text":"<p>Vault instance is sealed on <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: VaultSealed\n    expr: vault_core_unsealed == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Vault sealed (instance {{ $labels.instance }})\n      description: \"Vault instance is sealed on {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/42vault/#2-vault-too-many-pending-tokens","title":"2. Vault too many pending tokens","text":"<p>Too many pending tokens <code>{{ $labels.instance }}: {{ $value | printf \"%.2f\"}}%</code></p> <pre><code>  - alert: VaultTooManyPendingTokens\n    expr: avg(vault_token_create_count - vault_token_store_count) &gt; 0\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Vault too many pending tokens (instance {{ $labels.instance }})\n      description: \"Too many pending tokens {{ $labels.instance }}: {{ $value | printf \\\"%.2f\\\"}}%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/42vault/#3-vault-too-many-infinity-tokens","title":"3. Vault too many infinity tokens","text":"<p>Too many infinity tokens<code>{{ $labels.instance }}: {{ $value | printf \"%.2f\"}}%</code></p> <pre><code>  - alert: VaultTooManyInfinityTokens\n    expr: vault_token_count_by_ttl{creation_ttl=\"+Inf\"} &gt; 3\n    for: 5m\n    labels:\n      severity: warning\n    annotations:\n      summary: Vault too many infinity tokens (instance {{ $labels.instance }})\n      description: \"Too many infinity tokens {{ $labels.instance }}: {{ $value | printf \\\"%.2f\\\"}}%\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/43Thanos/","title":"1 Thanos","text":""},{"location":"chap9/43Thanos/#1-thanos-compaction-halted","title":"1. Thanos compaction halted","text":"<p>Thanos compaction has failed to run and is now halted.</p> <pre><code>  - alert: ThanosCompactionHalted\n    expr: thanos_compact_halted == 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Thanos compaction halted (instance {{ $labels.instance }})\n      description: \"Thanos compaction has failed to run and is now halted.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/43Thanos/#2-thanos-compact-bucket-operation-failure","title":"2. Thanos compact bucket operation failure","text":"<p>Thanos compaction has failing storage operations</p> <pre><code>  - alert: ThanosCompactBucketOperationFailure\n    expr: rate(thanos_objstore_bucket_operation_failures_total[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Thanos compact bucket operation failure (instance {{ $labels.instance }})\n      description: \"Thanos compaction has failing storage operations\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/43Thanos/#3-thanos-compact-not-run","title":"3. Thanos compact not run","text":"<p>Thanos compaction has not run in 24 hours.</p> <pre><code>  - alert: ThanosCompactNotRun\n    expr: (time() - thanos_objstore_bucket_last_successful_upload_time) &gt; 24*60*60\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Thanos compact not run (instance {{ $labels.instance }})\n      description: \"Thanos compaction has not run in 24 hours.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/44loki/","title":"2 Loki","text":""},{"location":"chap9/44loki/#1-loki-process-too-many-restarts","title":"1. Loki process too many restarts","text":"<p>A loki process had too many restarts <code>(target {{ $labels.instance }})</code></p> <pre><code>  - alert: LokiProcessTooManyRestarts\n    expr: changes(process_start_time_seconds{job=~\"loki\"}[15m]) &gt; 2\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Loki process too many restarts (instance {{ $labels.instance }})\n      description: \"A loki process had too many restarts (target {{ $labels.instance }})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/44loki/#2-loki-request-errors","title":"2. Loki request errors","text":"<p>The <code>{{ $labels.job }}</code> and <code>{{ $labels.route }}</code>are experiencing errors</p> <pre><code>  - alert: LokiRequestErrors\n    expr: 100 * sum(rate(loki_request_duration_seconds_count{status_code=~\"5..\"}[1m])) by (namespace, job, route) / sum(rate(loki_request_duration_seconds_count[1m])) by (namespace, job, route) &gt; 10\n    for: 15m\n    labels:\n      severity: critical\n    annotations:\n      summary: Loki request errors (instance {{ $labels.instance }})\n      description: \"The {{ $labels.job }} and {{ $labels.route }} are experiencing errors\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/44loki/#3-loki-request-panic","title":"3. Loki request panic","text":"<p>The <code>{{ $labels.job }}</code> is experiencing <code>{{ printf \"%.2f\" $value }}%</code> increase of panics</p> <pre><code>  - alert: LokiRequestPanic\n    expr: sum(increase(loki_panic_total[10m])) by (namespace, job) &gt; 0\n    for: 5m\n    labels:\n      severity: critical\n    annotations:\n      summary: Loki request panic (instance {{ $labels.instance }})\n      description: \"The {{ $labels.job }} is experiencing {{ printf \\\"%.2f\\\" $value }}% increase of panics\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/44loki/#4-loki-request-latency","title":"4. Loki request latency","text":"<p>The <code>{{ $labels.job }} {{ $labels.route }}</code> is experiencing <code>{{ printf \"%.2f\" $value }}</code>s 99th percentile latency</p> <pre><code>  - alert: LokiRequestLatency\n    expr: (histogram_quantile(0.99, sum(rate(loki_request_duration_seconds_bucket{route!~\"(?i).*tail.*\"}[5m])) by (le)))  &gt; 1\n    for: 5m\n    labels:\n      severity: critical\n    annotations:\n      summary: Loki request latency (instance {{ $labels.instance }})\n      description: \"The {{ $labels.job }} {{ $labels.route }} is experiencing {{ printf \\\"%.2f\\\" $value }}s 99th percentile latency\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/45Promtail/","title":"3. Promtail","text":""},{"location":"chap9/45Promtail/#1-promtail-request-errors","title":"1. Promtail request errors","text":"<p>The <code>{{ $labels.job }} {{ $labels.route }}</code> is experiencing <code>{{ printf \"%.2f\" $value }}%</code> errors.</p> <pre><code>  - alert: PromtailRequestErrors\n    expr: 100 * sum(rate(promtail_request_duration_seconds_count{status_code=~\"5..|failed\"}[1m])) by (namespace, job, route, instance) / sum(rate(promtail_request_duration_seconds_count[1m])) by (namespace, job, route, instance) &gt; 10\n    for: 5m\n    labels:\n      severity: critical\n    annotations:\n      summary: Promtail request errors (instance {{ $labels.instance }})\n      description: \"The {{ $labels.job }} {{ $labels.route }} is experiencing {{ printf \\\"%.2f\\\" $value }}% errors.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/45Promtail/#2-promtail-request-latency","title":"2. Promtail request latency","text":"<p>The <code>{{ $labels.job }} {{ $labels.route }}</code> is experiencing <code>{{ printf \"%.2f\" $value }}s</code> 99th percentile latency.</p> <pre><code>  - alert: PromtailRequestLatency\n    expr: histogram_quantile(0.99, sum(rate(promtail_request_duration_seconds_bucket[5m])) by (le)) &gt; 1\n    for: 5m\n    labels:\n      severity: critical\n    annotations:\n      summary: Promtail request latency (instance {{ $labels.instance }})\n      description: \"The {{ $labels.job }} {{ $labels.route }} is experiencing {{ printf \\\"%.2f\\\" $value }}s 99th percentile latency.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/46Cortex/","title":"4 Cortex","text":""},{"location":"chap9/46Cortex/#1-cortex-ruler-configuration-reload-failure","title":"1. Cortex ruler configuration reload failure","text":"<p>Cortex ruler configuration reload failure (instance <code>{{ $labels.instance }})</code></p> <pre><code>  - alert: CortexRulerConfigurationReloadFailure\n    expr: cortex_ruler_config_last_reload_successful != 1\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Cortex ruler configuration reload failure (instance {{ $labels.instance }})\n      description: \"Cortex ruler configuration reload failure (instance {{ $labels.instance }})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/46Cortex/#2-cortex-not-connected-to-alertmanager","title":"2. Cortex not connected to Alertmanager","text":"<p>Cortex not connected to Alertmanager <code>(instance {{ $labels.instance }})</code></p> <pre><code>  - alert: CortexNotConnectedToAlertmanager\n    expr: cortex_prometheus_notifications_alertmanagers_discovered &lt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cortex not connected to Alertmanager (instance {{ $labels.instance }})\n      description: \"Cortex not connected to Alertmanager (instance {{ $labels.instance }})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/46Cortex/#3-cortex-notification-are-being-dropped","title":"3. Cortex notification are being dropped","text":"<p>Cortex notification are being dropped due to errors (instance <code>{{ $labels.instance }}</code>)</p> <pre><code>  - alert: CortexNotificationAreBeingDropped\n    expr: rate(cortex_prometheus_notifications_dropped_total[5m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cortex notification are being dropped (instance {{ $labels.instance }})\n      description: \"Cortex notification are being dropped due to errors (instance {{ $labels.instance }})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/46Cortex/#4-cortex-notification-error","title":"4. Cortex notification error","text":"<p>Cortex is failing when sending alert notifications (instance <code>{{ $labels.instance }}</code>)</p> <pre><code>  - alert: CortexNotificationError\n    expr: rate(cortex_prometheus_notifications_errors_total[5m]) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cortex notification error (instance {{ $labels.instance }})\n      description: \"Cortex is failing when sending alert notifications (instance {{ $labels.instance }})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/46Cortex/#5-cortex-ingester-unhealthy","title":"5. Cortex ingester unhealthy","text":"<p>Cortex has an unhealthy ingester</p> <pre><code>  - alert: CortexIngesterUnhealthy\n    expr: cortex_ring_members{state=\"Unhealthy\", name=\"ingester\"} &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cortex ingester unhealthy (instance {{ $labels.instance }})\n      description: \"Cortex has an unhealthy ingester\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/46Cortex/#6-cortex-frontend-queries-stuck","title":"6. Cortex frontend queries stuck","text":"<p>There are queued up queries in query-frontend.</p> <pre><code>  - alert: CortexFrontendQueriesStuck\n    expr: sum by (job) (cortex_query_frontend_queue_length) &gt; 0\n    for: 5m\n    labels:\n      severity: critical\n    annotations:\n      summary: Cortex frontend queries stuck (instance {{ $labels.instance }})\n      description: \"There are queued up queries in query-frontend.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/47jekins/","title":"5 Jenkins","text":"<p>https://plugins.jenkins.io/prometheus/</p>"},{"location":"chap9/47jekins/#1-jenkins-offline","title":"1. Jenkins offline","text":"<p>Jenkins offline: <code>{{$labels.instance}}</code> in realm <code>{{$labels.realm}}/{{$labels.env}}</code> (<code>{{$labels.region}}</code>)</p> <pre><code>  - alert: JenkinsOffline\n    expr: jenkins_node_offline_value &gt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Jenkins offline (instance {{ $labels.instance }})\n      description: \"Jenkins offline: `{{$labels.instance}}` in realm {{$labels.realm}}/{{$labels.env}} ({{$labels.region}})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/47jekins/#2-jenkins-healthcheck","title":"2. Jenkins healthcheck","text":"<p>Jenkins healthcheck score: <code>{{$value}}</code>. Healthcheck failure for <code>{{$labels.instance}}</code> in realm <code>{{$labels.realm}}/{{$labels.env}}</code>(<code>{{$labels.region}}</code>)</p> <pre><code>  - alert: JenkinsHealthcheck\n    expr: jenkins_health_check_score &lt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Jenkins healthcheck (instance {{ $labels.instance }})\n      description: \"Jenkins healthcheck score: {{$value}}. Healthcheck failure for `{{$labels.instance}}` in realm {{$labels.realm}}/{{$labels.env}} ({{$labels.region}})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/47jekins/#3-jenkins-outdated-plugins","title":"3. Jenkins outdated plugins","text":"<p><code>{{ $value }}</code> plugins need update</p> <pre><code>  - alert: JenkinsOutdatedPlugins\n    expr: sum(jenkins_plugins_withUpdate) by (instance) &gt; 3\n    for: 1d\n    labels:\n      severity: warning\n    annotations:\n      summary: Jenkins outdated plugins (instance {{ $labels.instance }})\n      description: \"{{ $value }} plugins need update\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/47jekins/#4-jenkins-builds-health-score","title":"4. Jenkins builds health score","text":"<p>Healthcheck failure for <code>{{$labels.instance}}</code> in realm <code>{{$labels.realm}}/{{$labels.env}}</code> (<code>{{$labels.region}}</code>)</p> <pre><code>  - alert: JenkinsBuildsHealthScore\n    expr: default_jenkins_builds_health_score &lt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Jenkins builds health score (instance {{ $labels.instance }})\n      description: \"Healthcheck failure for `{{$labels.instance}}` in realm {{$labels.realm}}/{{$labels.env}} ({{$labels.region}})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/47jekins/#5-jenkins-run-failure-total","title":"5. Jenkins run failure total","text":"<p>Job run failures: (<code>{{$value}}</code>) <code>{{$labels.jenkins_job}}</code>. Healthcheck failure for <code>{{$labels.instance}}</code> in realm <code>{{$labels.realm}}/{{$labels.env}} ({{$labels.region}}</code>)</p> <pre><code>  - alert: JenkinsRunFailureTotal\n    expr: delta(jenkins_runs_failure_total[1h]) &gt; 100\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Jenkins run failure total (instance {{ $labels.instance }})\n      description: \"Job run failures: ({{$value}}) {{$labels.jenkins_job}}. Healthcheck failure for `{{$labels.instance}}` in realm {{$labels.realm}}/{{$labels.env}} ({{$labels.region}})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/47jekins/#6-jenkins-build-tests-failing","title":"6. Jenkins build tests failing","text":"<p>Last build tests failed: <code>{{$labels.jenkins_job}}</code>. Failed build Tests for job <code>{{$labels.jenkins_job}}</code> on <code>{{$labels.instance}}/{{$labels.env}}</code> (<code>{{$labels.region}}</code>)</p> <pre><code>  - alert: JenkinsBuildTestsFailing\n    expr: default_jenkins_builds_last_build_tests_failing &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Jenkins build tests failing (instance {{ $labels.instance }})\n      description: \"Last build tests failed: {{$labels.jenkins_job}}. Failed build Tests for job `{{$labels.jenkins_job}}` on {{$labels.instance}}/{{$labels.env}} ({{$labels.region}})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/47jekins/#7-jenkins-last-build-failed","title":"7. Jenkins last build failed","text":"<p>Last build failed: <code>{{$labels.jenkins_job}}</code>. Failed build for job <code>{{$labels.jenkins_job}}</code> on <code>{{$labels.instance}}/{{$labels.env}}</code>(<code>{{$labels.region}}</code>)</p> <pre><code>  # * RUNNING  -1 true  - The build had no errors.\n  # * SUCCESS   0 true  - The build had no errors.\n  # * UNSTABLE  1 true  - The build had some errors but they were not fatal. For example, some tests failed.\n  # * FAILURE   2 false - The build had a fatal error.\n  # * NOT_BUILT 3 false - The module was not built.\n  # * ABORTED   4 false - The build was manually aborted.\n  - alert: JenkinsLastBuildFailed\n    expr: default_jenkins_builds_last_build_result_ordinal == 2\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Jenkins last build failed (instance {{ $labels.instance }})\n      description: \"Last build failed: {{$labels.jenkins_job}}. Failed build for job `{{$labels.jenkins_job}}` on {{$labels.instance}}/{{$labels.env}} ({{$labels.region}})\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/4Nginx/","title":"4 Nginx : nginx-lua-prometheus","text":"<p>https://github.com/knyar/nginx-lua-prometheus</p>"},{"location":"chap9/4Nginx/#1-http-errors-4xx","title":"1. HTTP errors 4xx","text":"<p>Too many HTTP requests with status 4xx (&gt; 5%)</p> <pre><code>- alert: HttpErrors4xx\n  expr: sum(rate(nginx_http_requests_total{status=~\"^4..\"}[1m])) / sum(rate(nginx_http_requests_total[1m])) * 100 &gt; 5\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"HTTP errors 4xx (instance {{ $labels.instance }})\"\n    description: \"Too many HTTP requests with status 4xx (&gt; 5%)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/4Nginx/#2-http-errors-5xx","title":"2. HTTP errors 5xx","text":"<p>Too many HTTP requests with status 5xx (&gt; 5%)</p> <pre><code>- alert: HttpErrors5xx\n  expr: sum(rate(nginx_http_requests_total{status=~\"^5..\"}[1m])) / sum(rate(nginx_http_requests_total[1m])) * 100 &gt; 5\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"HTTP errors 5xx (instance {{ $labels.instance }})\"\n    description: \"Too many HTTP requests with status 5xx (&gt; 5%)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/4Nginx/#2-nginx-latency-high","title":"2. Nginx latency high","text":"<p>Nginx p99 latency is higher than 3 seconds</p> <pre><code>  - alert: NginxLatencyHigh\n    expr: histogram_quantile(0.99, sum(rate(nginx_http_request_duration_seconds_bucket[2m])) by (host, node)) &gt; 3\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Nginx latency high (instance {{ $labels.instance }})\n      description: \"Nginx p99 latency is higher than 3 seconds\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/4runtimes/","title":"4 Runtimes","text":""},{"location":"chap9/4runtimes/#1-php-fpm","title":"1 PHP-FPM","text":"<ol> <li>PHP-FPM max-children reached</li> </ol>"},{"location":"chap9/4runtimes/#2-java-java-client","title":"2 Java : java-client","text":"<ol> <li>JVM memory filling up</li> </ol>"},{"location":"chap9/4runtimes/#3-sidekiq","title":"3 Sidekiq","text":"<ol> <li>Sidekiq queue size</li> <li>Sidekiq scheduling latency too high</li> </ol>"},{"location":"chap9/5Orchestrators/","title":"5 Orchestrators","text":""},{"location":"chap9/5Orchestrators/#1-kubernetes","title":"1 Kubernetes","text":"<ol> <li>Kubernetes Node ready</li> <li>Kubernetes MemoryPressure</li> <li>Kubernetes DiskPressure</li> <li>Kubernetes OutOfDisk</li> <li>Kubernetes out of capacity</li> <li>Kubernetes container oom killer</li> <li>Kubernetes Job failed</li> <li>Kubernetes CronJob suspended</li> <li>Kubernetes PersistentVolumeClaim pending</li> <li>Volume out of disk space</li> <li>Volume full in four days</li> <li>Kubernetes PersistentVolume error</li> <li>StatefulSet down</li> <li>Kubernetes HPA scaling ability</li> <li>Kubernetes HPA metric availability</li> <li>Kubernetes HPA scale capability</li> <li>Kubernetes Pod not healthy</li> <li>Kubernetes pod crash looping</li> <li>Kubernetes ReplicasSet mismatch</li> <li>Kubernetes Deployment replicas mismatch</li> <li>Kubernetes StatefulSet replicas mismatch</li> <li>Kubernetes Deployment generation mismatch</li> <li>Kubernetes StatefulSet generation mismatch</li> <li>Kubernetes StatefulSet update not rolled out</li> <li>Kubernetes DaemonSet rollout stuck</li> <li>Kubernetes DaemonSet misscheduled</li> <li>Kubernetes CronJob too long</li> <li>Kubernetes job slow completion</li> <li>Kubernetes API server errors</li> <li>Kubernetes API client errors</li> <li>Kubernetes client certificate expires next week</li> <li>Kubernetes client certificate expires soon</li> <li>Kubernetes API server latency</li> </ol>"},{"location":"chap9/5Orchestrators/#2-nomad","title":"2 Nomad","text":"<ol> <li>Nomad job failed</li> <li>Nomad job lost</li> <li>Nomad job queued</li> <li>Nomad blocked evaluation</li> </ol>"},{"location":"chap9/5Orchestrators/#3-consul","title":"3 Consul","text":"<ol> <li>Service healthcheck failed</li> <li>Missing Consul master node</li> <li>Consul agent unhealthy</li> </ol>"},{"location":"chap9/5Orchestrators/#4-etcd","title":"4 Etcd","text":"<ol> <li>Insufficient Members</li> <li>No Leader</li> <li>High number of leader changes</li> <li>High number of failed GRPC requests</li> <li>High number of failed GRPC requests</li> <li>GRPC requests slow</li> <li>High number of failed HTTP requests</li> <li>High number of failed HTTP requests</li> <li>HTTP requests slow</li> <li>Etcd member communication slow</li> <li>High number of failed proposals</li> <li>High fsync durations</li> <li>High commit durations</li> </ol>"},{"location":"chap9/5Orchestrators/#5-linkerd","title":"5 Linkerd","text":"<ol> <li>Linkerd high error rate</li> </ol>"},{"location":"chap9/5Orchestrators/#6-istio","title":"6 Istio","text":"<ol> <li>Istio Kubernetes gateway availability drop</li> <li>Istio Pilot high total request rate</li> <li>Istio Mixer Prometheus dispatches low</li> <li>Istio high total request rate</li> <li>Istio low total request rate</li> <li>Istio high 4xx error rate</li> <li>Istio high 5xx error rate</li> <li>Istio high request latency</li> <li>Istio latency 99 percentile</li> <li>Istio Pilot Duplicate Entry</li> </ol>"},{"location":"chap9/5RabbitMQ/","title":"7. RabbitMQ","text":""},{"location":"chap9/5RabbitMQ/#rabbitmqrabbitmq-prometheus","title":"rabbitmq/rabbitmq-prometheus","text":""},{"location":"chap9/5RabbitMQ/#1-rabbitmq-node-down","title":"1. Rabbitmq node down","text":"<p>Less than 3 nodes running in RabbitMQ cluster</p> <pre><code>  - alert: RabbitmqNodeDown\n    expr: sum(rabbitmq_build_info) &lt; 3\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Rabbitmq node down (instance {{ $labels.instance }})\n      description: \"Less than 3 nodes running in RabbitMQ cluster\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#2-rabbitmq-node-not-distributed","title":"2. Rabbitmq node not distributed","text":"<p>Distribution link state is not 'up'</p> <pre><code>  - alert: RabbitmqNodeNotDistributed\n    expr: erlang_vm_dist_node_state &lt; 3\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Rabbitmq node not distributed (instance {{ $labels.instance }})\n      description: \"Distribution link state is not 'up'\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#3-rabbitmq-instances-different-versions","title":"3. Rabbitmq instances different versions","text":"<p>Running different version of Rabbitmq in the same cluster, can lead to failure.</p> <pre><code>  - alert: RabbitmqInstancesDifferentVersions\n    expr: count(count(rabbitmq_build_info) by (rabbitmq_version)) &gt; 1\n    for: 1h\n    labels:\n      severity: warning\n    annotations:\n      summary: Rabbitmq instances different versions (instance {{ $labels.instance }})\n      description: \"Running different version of Rabbitmq in the same cluster, can lead to failure.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#4-rabbitmq-memory-high","title":"4. Rabbitmq memory high","text":"<p>A node use more than 90% of allocated RAM</p> <pre><code>  - alert: RabbitmqMemoryHigh\n    expr: rabbitmq_process_resident_memory_bytes / rabbitmq_resident_memory_limit_bytes * 100 &gt; 90\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Rabbitmq memory high (instance {{ $labels.instance }})\n      description: \"A node use more than 90% of allocated RAM\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#5-rabbitmq-file-descriptors-usage","title":"5. Rabbitmq file descriptors usage","text":"<p>A node use more than 90% of file descriptors</p> <pre><code>  - alert: RabbitmqFileDescriptorsUsage\n    expr: rabbitmq_process_open_fds / rabbitmq_process_max_fds * 100 &gt; 90\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Rabbitmq file descriptors usage (instance {{ $labels.instance }})\n      description: \"A node use more than 90% of file descriptors\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#6-rabbitmq-too-many-unack-messages","title":"6. Rabbitmq too many unack messages","text":"<p>Too many unacknowledged messages</p> <pre><code>  - alert: RabbitmqTooManyUnackMessages\n    expr: sum(rabbitmq_queue_messages_unacked) BY (queue) &gt; 1000\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Rabbitmq too many unack messages (instance {{ $labels.instance }})\n      description: \"Too many unacknowledged messages\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#7-rabbitmq-too-many-connections","title":"7 Rabbitmq too many connections","text":"<p>The total connections of a node is too high</p> <pre><code>  - alert: RabbitmqTooManyConnections\n    expr: rabbitmq_connections &gt; 1000\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Rabbitmq too many connections (instance {{ $labels.instance }})\n      description: \"The total connections of a node is too high\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#8-rabbitmq-no-queue-consumer","title":"8 Rabbitmq no queue consumer","text":"<p>A queue has less than 1 consumer</p> <pre><code>  - alert: RabbitmqNoQueueConsumer\n    expr: rabbitmq_queue_consumers &lt; 1\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Rabbitmq no queue consumer (instance {{ $labels.instance }})\n      description: \"A queue has less than 1 consumer\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#9-rabbitmq-unroutable-messages","title":"9. Rabbitmq unroutable messages","text":"<p>A queue has unroutable messages</p> <pre><code>  - alert: RabbitmqUnroutableMessages\n    expr: increase(rabbitmq_channel_messages_unroutable_returned_total[1m]) &gt; 0 or increase(rabbitmq_channel_messages_unroutable_dropped_total[1m]) &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Rabbitmq unroutable messages (instance {{ $labels.instance }})\n      description: \"A queue has unroutable messages\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#2-rabbitmq-kbudderabbitmq-exporter","title":"2 RabbitMQ :  kbudde/rabbitmq-exporter","text":""},{"location":"chap9/5RabbitMQ/#101-rabbitmq-node-down","title":"10.1. Rabbitmq node down","text":"<p>RabbitMQ node down</p> <pre><code>- alert: RabbitmqDown\n  expr: rabbitmq_up == 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Rabbitmq down (instance {{ $labels.instance }})\"\n    description: \"RabbitMQ node down\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#102-rabbitmq-cluster-down","title":"10.2. Rabbitmq Cluster down","text":"<p>Less than 3 nodes running in RabbitMQ cluster</p> <pre><code>- alert: ClusterDown\n  expr: rabbitmq_running &lt; 3\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Cluster down (instance {{ $labels.instance }})\"\n    description: \"Less than 3 nodes running in RabbitMQ cluster\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#103-rabbitmq-cluster-partition","title":"10.3. Rabbitmq cluster partition","text":"<p>Cluster partition</p> <pre><code>- alert: ClusterPartition\n  expr: rabbitmq_partitions &gt; 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Cluster partition (instance {{ $labels.instance }})\"\n    description: \"Cluster partition\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#104-rabbitmq-out-of-memory","title":"10.4. Rabbitmq out of memory","text":"<p>Memory available for RabbmitMQ is low (&lt; 10%)</p> <pre><code>- alert: OutOfMemory\n  expr: rabbitmq_node_mem_used / rabbitmq_node_mem_limit * 100 &gt; 90\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Out of memory (instance {{ $labels.instance }})\"\n    description: \"Memory available for RabbmitMQ is low (&lt; 10%)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#105-too-many-connections","title":"10.5. Too many connections","text":"<p>RabbitMQ instance has too many connections (&gt; 1000)</p> <pre><code>- alert: TooManyConnections\n  expr: rabbitmq_connectionsTotal &gt; 1000\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Too many connections (instance {{ $labels.instance }})\"\n    description: \"RabbitMQ instance has too many connections (&gt; 1000)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#106-dead-letter-queue-filling-up","title":"10.6. Dead letter queue filling up","text":"<p>Dead letter queue is filling up (&gt; 10 msgs)</p> <pre><code>- alert: DeadLetterQueueFillingUp\n  expr: rabbitmq_queue_messages{queue=\"my-dead-letter-queue\"} &gt; 10\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Dead letter queue filling up (instance {{ $labels.instance }})\"\n    description: \"Dead letter queue is filling up (&gt; 10 msgs)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#107-too-many-messages-in-queue","title":"10.7. Too many messages in queue","text":"<p>Queue is filling up (&gt; 1000 msgs)</p> <pre><code>- alert: TooManyMessagesInQueue\n  expr: rabbitmq_queue_messages_ready{queue=\"my-queue\"} &gt; 1000\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Too many messages in queue (instance {{ $labels.instance }})\"\n    description: \"Queue is filling up (&gt; 1000 msgs)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#108-rabbitmq-slow-queue-consuming","title":"10.8. Rabbitmq Slow queue consuming","text":"<p>Queue messages are consumed slowly (&gt; 60s)</p> <pre><code>- alert: SlowQueueConsuming\n  expr: time() - rabbitmq_queue_head_message_timestamp{queue=\"my-queue\"} &gt; 60\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Slow queue consuming (instance {{ $labels.instance }})\"\n    description: \"Queue messages are consumed slowly (&gt; 60s)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#109-no-consumer","title":"10.9. No consumer","text":"<p>Queue has no consumer</p> <pre><code>- alert: NoConsumer\n  expr: rabbitmq_queue_consumers == 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"No consumer (instance {{ $labels.instance }})\"\n    description: \"Queue has no consumer\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#1010-too-many-consumers","title":"10.10. Too many consumers","text":"<p>Queue should have only 1 consumer</p> <pre><code>- alert: TooManyConsumers\n  expr: rabbitmq_queue_consumers &gt; 1\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Too many consumers (instance {{ $labels.instance }})\"\n    description: \"Queue should have only 1 consumer\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/5RabbitMQ/#1011-unactive-exchange","title":"10.11. Unactive exchange","text":"<p>Exchange receive less than 5 msgs per second</p> <pre><code>- alert: UnactiveExchange\n  expr: rate(rabbitmq_exchange_messages_published_in_total{exchange=\"my-exchange\"}[1m]) &lt; 5\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Unactive exchange (instance {{ $labels.instance }})\"\n    description: \"Exchange receive less than 5 msgs per second\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6Mysql/","title":"1. MySQL : prometheus/<code>mysqld_exporter</code>","text":"<p>https://github.com/prometheus/mysqld_exporter</p> <ul> <li>MYSQLDown</li> <li>MysqlQPSTooHigh</li> <li>\u57fa\u4e8ePrometheus\u6784\u5efaMySQL\u53ef\u89c6\u5316\u76d1\u63a7\u5e73\u53f0</li> </ul> <pre><code>groups:\n- name: MYSQL\u670d\u52a1\u76d1\u63a7\n  rules: \n  - alert: MYSQLDown\n    expr: mysql_up != 1\n    for: 10m\n    labels:\n      severity: critical\n    annotations:\n      summary: mysql server {{ $labels.realip }} is down. please check it in time.\n  - alert: MysqlQPSTooHigh\n    expr: (rate(mysql_global_status_queries{job=\"mysql_exporter\"}[5m]) or irate(mysql_global_status_queries{job=\"mysql_exporter\"}[5m])) &gt; 300\n    for: 10m\n    labels:\n      severity: critical\n    annotations:\n      summary: mysql server {{ $labels.realip }} QPS is too high. please keep an eyes on it.\n</code></pre>"},{"location":"chap9/6Mysql/#1-mysql-down","title":"1. MySQL down","text":"<p>MySQL instance is down on <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: MysqlDown\n    expr: mysql_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: MySQL down (instance {{ $labels.instance }})\n      description: \"MySQL instance is down on {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6Mysql/#12-mysql-too-many-connections-80","title":"1.2. MySQL too many connections (&gt; 80%)","text":"<p>More than 80% of MySQL connections are in use on <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: MysqlTooManyConnections(&gt;80%)\n    expr: max_over_time(mysql_global_status_threads_connected[1m]) / mysql_global_variables_max_connections * 100 &gt; 80\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: MySQL too many connections (&gt; 80%) (instance {{ $labels.instance }})\n      description: \"More than 80% of MySQL connections are in use on {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6Mysql/#13-mysql-high-threads-running","title":"1.3. MySQL high threads running","text":"<p>More than 60% of MySQL connections are in running state on <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: MysqlHighThreadsRunning\n    expr: max_over_time(mysql_global_status_threads_running[1m]) / mysql_global_variables_max_connections * 100 &gt; 60\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: MySQL high threads running (instance {{ $labels.instance }})\n      description: \"More than 60% of MySQL connections are in running state on {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6Mysql/#14-mysql-slave-io-thread-not-running","title":"1.4. MySQL Slave IO thread not running","text":"<p>MySQL Slave IO thread not running on <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: MysqlSlaveIoThreadNotRunning\n    expr: mysql_slave_status_master_server_id &gt; 0 and ON (instance) mysql_slave_status_slave_io_running == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: MySQL Slave IO thread not running (instance {{ $labels.instance }})\n      description: \"MySQL Slave IO thread not running on {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6Mysql/#15-mysql-slave-sql-thread-not-running","title":"1.5. MySQL Slave SQL thread not running","text":"<p>MySQL Slave SQL thread not running on <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: MysqlSlaveSqlThreadNotRunning\n    expr: mysql_slave_status_master_server_id &gt; 0 and ON (instance) mysql_slave_status_slave_sql_running == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: MySQL Slave SQL thread not running (instance {{ $labels.instance }})\n      description: \"MySQL Slave SQL thread not running on {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6Mysql/#16-mysql-slave-replication-lag","title":"1.6. MySQL Slave replication lag","text":"<p>MySQL replication lag on <code>{{ $labels.instance }}</code></p> <pre><code>  - alert: MysqlSlaveReplicationLag\n    expr: mysql_slave_status_master_server_id &gt; 0 and ON (instance) (mysql_slave_status_seconds_behind_master - mysql_slave_status_sql_delay) &gt; 30\n    for: 1m\n    labels:\n      severity: critical\n    annotations:\n      summary: MySQL Slave replication lag (instance {{ $labels.instance }})\n      description: \"MySQL replication lag on {{ $labels.instance }}\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6Mysql/#17-mysql-slow-queries","title":"1.7. MySQL slow queries","text":"<p>MySQL server mysql has some new slow query.</p> <pre><code>  - alert: MysqlSlowQueries\n    expr: increase(mysql_global_status_slow_queries[1m]) &gt; 0\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: MySQL slow queries (instance {{ $labels.instance }})\n      description: \"MySQL server mysql has some new slow query.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6Mysql/#18-mysql-innodb-log-waits","title":"1.8. MySQL InnoDB log waits","text":"<p>MySQL innodb log writes stalling</p> <pre><code>  - alert: MysqlInnodbLogWaits\n    expr: rate(mysql_global_status_innodb_log_waits[15m]) &gt; 10\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: MySQL InnoDB log waits (instance {{ $labels.instance }})\n      description: \"MySQL innodb log writes stalling\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6Mysql/#19-mysql-restarted","title":"1.9. MySQL restarted","text":"<p>MySQL has just been restarted, less than one minute ago on <code>{{ $labels.instance }}</code>.</p> <pre><code>  - alert: MysqlRestarted\n    expr: mysql_global_status_uptime &lt; 60\n    for: 0m\n    labels:\n      severity: info\n    annotations:\n      summary: MySQL restarted (instance {{ $labels.instance }})\n      description: \"MySQL has just been restarted, less than one minute ago on {{ $labels.instance }}.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/6network_sec_storage/","title":"6 Network, security and storage","text":""},{"location":"chap9/6network_sec_storage/#1-ceph","title":"1 Ceph","text":"<ol> <li>Ceph State</li> <li>Ceph monitor clock skew</li> <li>Ceph monitor low space</li> <li>Ceph OSD Down</li> <li>Ceph high OSD latency</li> <li>Ceph OSD low space</li> <li>Ceph OSD reweighted</li> <li>Ceph PG down</li> <li>Ceph PG incomplete</li> <li>Ceph PG inconsistent</li> <li>Ceph PG activation long</li> <li>Ceph PG backfill full</li> <li>Ceph PG unavailable</li> </ol>"},{"location":"chap9/6network_sec_storage/#2-speedtest","title":"2 SpeedTest","text":"<ol> <li>SpeedTest Slow Internet Download</li> <li>SpeedTest Slow Internet Upload</li> </ol>"},{"location":"chap9/6network_sec_storage/#3-zfs","title":"3 ZFS","text":""},{"location":"chap9/6network_sec_storage/#4-openebs","title":"4 OpenEBS","text":"<ol> <li>Used pool capacity</li> </ol>"},{"location":"chap9/6network_sec_storage/#5-minio","title":"5 Minio","text":"<ol> <li>Disk down</li> <li>Minio disk space usage</li> </ol>"},{"location":"chap9/6network_sec_storage/#6-ssltls","title":"6 SSL/TLS","text":"<ol> <li>SSL certificate probe failed</li> <li>SSL certificate OSCP status unknown</li> <li>SSL certificate revoked</li> <li>SSL certificate expiry (&lt; 7 days)</li> </ol> <p>7 Juniper</p> <ol> <li>Switch is down</li> <li>High Bandwith Usage 1Gi</li> <li>High Bandwith Usage 1GiB</li> </ol> <p>8 CoreDNS</p> <ol> <li>CoreDNS Panic Count</li> </ol> <p>9 Freeswitch</p> <ol> <li>Freeswitch down</li> <li>Freeswitch Sessions Warning</li> <li>Freeswitch Sessions Critical</li> </ol> <p>10  Hashicorp Vault</p> <ol> <li>Vault sealed</li> <li>Vault too many pending tokens</li> <li>Vault too many infinity tokens</li> </ol>"},{"location":"chap9/7PostgreSQL/","title":"2. PostgreSQL","text":"<p>https://github.com/wrouesnel/postgres_exporter/</p>"},{"location":"chap9/7PostgreSQL/#1-postgresql-down","title":"1. PostgreSQL down","text":"<p>PostgreSQL instance is down</p> <pre><code>- alert: PostgresqlDown\n  expr: pg_up == 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"PostgreSQL down (instance {{ $labels.instance }})\"\n    description: \"PostgreSQL instance is down\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#2-postgresql-restarted","title":"2. Postgresql restarted","text":"<p>Postgresql restarted</p> <pre><code>  - alert: PostgresqlRestarted\n    expr: time() - pg_postmaster_start_time_seconds &lt; 60\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Postgresql restarted (instance {{ $labels.instance }})\n      description: \"Postgresql restarted\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#3-postgresql-exporter-error","title":"3. Postgresql exporter error","text":"<p>Postgresql exporter is showing errors. A query may be buggy in query.yaml</p> <pre><code>  - alert: PostgresqlExporterError\n    expr: pg_exporter_last_scrape_error &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Postgresql exporter error (instance {{ $labels.instance }})\n      description: \"Postgresql exporter is showing errors. A query may be buggy in query.yaml\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#4-replication-lag","title":"4. Replication lag","text":"<p>PostgreSQL replication lag is going up (&gt; 10s)</p> <pre><code>- alert: ReplicationLag\n  expr: pg_replication_lag &gt; 10\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Replication lag (instance {{ $labels.instance }})\"\n    description: \"PostgreSQL replication lag is going up (&gt; 10s)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#5-table-not-vaccumed","title":"5 Table not vaccumed","text":"<p>Table has not been vaccum for 24 hours</p> <pre><code>- alert: TableNotVaccumed\n  expr: time() - pg_stat_user_tables_last_autovacuum &gt; 60 * 60 * 24\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Table not vaccumed (instance {{ $labels.instance }})\"\n    description: \"Table has not been vaccum for 24 hours\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#6-table-not-analyzed","title":"6. Table not analyzed","text":"<p>Table has not been analyzed for 24 hours</p> <pre><code>- alert: TableNotAnalyzed\n  expr: time() - pg_stat_user_tables_last_autoanalyze &gt; 60 * 60 * 24\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Table not analyzed (instance {{ $labels.instance }})\"\n    description: \"Table has not been analyzed for 24 hours\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#7-too-many-connections","title":"7. Too many connections","text":"<p>PostgreSQL instance has too many connections</p> <pre><code>- alert: TooManyConnections\n  expr: sum by (datname) (pg_stat_activity_count{datname!~\"template.*|postgres\"}) &gt; 100\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Too many connections (instance {{ $labels.instance }})\"\n    description: \"PostgreSQL instance has too many connections\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#8-not-enough-connections","title":"8. Not enough connections","text":"<p>PostgreSQL instance should have more connections (&gt; 5)</p> <pre><code>- alert: NotEnoughConnections\n  expr: sum by (datname) (pg_stat_activity_count{datname!~\"template.*|postgres\"}) &lt; 5\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Not enough connections (instance {{ $labels.instance }})\"\n    description: \"PostgreSQL instance should have more connections (&gt; 5)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#9-dead-locks","title":"9. Dead locks","text":"<p>PostgreSQL has dead-locks</p> <pre><code>- alert: DeadLocks\n  expr: rate(pg_stat_database_deadlocks{datname!~\"template.*|postgres\"}[1m]) &gt; 0\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Dead locks (instance {{ $labels.instance }})\"\n    description: \"PostgreSQL has dead-locks\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#10-high-rollback-rate","title":"10. High rollback rate","text":"<p>Ratio of transactions being aborted compared to committed is &gt; 2 %</p> <pre><code>- alert: HighRollbackRate\n  expr: rate(pg_stat_database_xact_rollback{datname!~\"template.*\"}[3m]) / rate(pg_stat_database_xact_commit{datname!~\"template.*\"}[3m]) &gt; 0.02\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"High rollback rate (instance {{ $labels.instance }})\"\n    description: \"Ratio of transactions being aborted compared to committed is &gt; 2 %\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#11-postgresql-commit-rate-low","title":"11. Postgresql commit rate low","text":"<p>Postgresql seems to be processing very few transactions</p> <pre><code>  - alert: PostgresqlCommitRateLow\n    expr: rate(pg_stat_database_xact_commit[1m]) &lt; 10\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Postgresql commit rate low (instance {{ $labels.instance }})\n      description: \"Postgresql seems to be processing very few transactions\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#12-postgresql-low-xid-consumption","title":"12. Postgresql low XID consumption","text":"<p>Postgresql seems to be consuming transaction IDs very slowly</p> <pre><code>  - alert: PostgresqlLowXidConsumption\n    expr: rate(pg_txid_current[1m]) &lt; 5\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Postgresql low XID consumption (instance {{ $labels.instance }})\n      description: \"Postgresql seems to be consuming transaction IDs very slowly\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#13-postgresql-high-rate-statement-timeout","title":"13. Postgresql high rate statement timeout","text":"<p>Postgres transactions showing high rate of statement timeouts</p> <pre><code>  - alert: PostgresqlHighRateStatementTimeout\n    expr: rate(postgresql_errors_total{type=\"statement_timeout\"}[1m]) &gt; 3\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Postgresql high rate statement timeout (instance {{ $labels.instance }})\n      description: \"Postgres transactions showing high rate of statement timeouts\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#14-postgresql-high-rate-deadlock","title":"14. Postgresql high rate deadlock","text":"<p>Postgres detected deadlocks</p> <pre><code>  - alert: PostgresqlHighRateDeadlock\n    expr: increase(postgresql_errors_total{type=\"deadlock_detected\"}[1m]) &gt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Postgresql high rate deadlock (instance {{ $labels.instance }})\n      description: \"Postgres detected deadlocks\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#15-postgresql-unused-replication-slot","title":"15. Postgresql unused replication slot","text":"<p>Unused Replication Slots</p> <pre><code>  - alert: PostgresqlUnusedReplicationSlot\n    expr: pg_replication_slots_active == 0\n    for: 1m\n    labels:\n      severity: warning\n    annotations:\n      summary: Postgresql unused replication slot (instance {{ $labels.instance }})\n      description: \"Unused Replication Slots\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n\n</code></pre>"},{"location":"chap9/7PostgreSQL/#16-postgresql-too-many-dead-tuples","title":"16. Postgresql too many dead tuples","text":"<p>PostgreSQL dead tuples is too large</p> <pre><code>  - alert: PostgresqlTooManyDeadTuples\n    expr: ((pg_stat_user_tables_n_dead_tup &gt; 10000) / (pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup)) &gt;= 0.1 unless ON(instance) (pg_replication_is_replica == 1)\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Postgresql too many dead tuples (instance {{ $labels.instance }})\n      description: \"PostgreSQL dead tuples is too large\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#17-postgresql-split-brain","title":"17. Postgresql split brain","text":"<p>Split Brain, too many primary Postgresql databases in read-write mode</p> <pre><code>  - alert: PostgresqlSplitBrain\n    expr: count(pg_replication_is_replica == 0) != 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Postgresql split brain (instance {{ $labels.instance }})\n      description: \"Split Brain, too many primary Postgresql databases in read-write mode\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n\n</code></pre>"},{"location":"chap9/7PostgreSQL/#18-postgresql-promoted-node","title":"18. Postgresql promoted node","text":"<p>Postgresql standby server has been promoted as primary node</p> <pre><code>  - alert: PostgresqlPromotedNode\n    expr: pg_replication_is_replica and changes(pg_replication_is_replica[1m]) &gt; 0\n    for: 0m\n    labels:\n      severity: warning\n    annotations:\n      summary: Postgresql promoted node (instance {{ $labels.instance }})\n      description: \"Postgresql standby server has been promoted as primary node\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#19-postgresql-configuration-changed","title":"19. Postgresql configuration changed","text":"<p>Postgres Database configuration change has occurred</p> <pre><code>  - alert: PostgresqlConfigurationChanged\n    expr: {__name__=~\"pg_settings_.*\"} != ON(__name__) {__name__=~\"pg_settings_([^t]|t[^r]|tr[^a]|tra[^n]|tran[^s]|trans[^a]|transa[^c]|transac[^t]|transact[^i]|transacti[^o]|transactio[^n]|transaction[^_]|transaction_[^r]|transaction_r[^e]|transaction_re[^a]|transaction_rea[^d]|transaction_read[^_]|transaction_read_[^o]|transaction_read_o[^n]|transaction_read_on[^l]|transaction_read_onl[^y]).*\"} OFFSET 5m\n    for: 0m\n    labels:\n      severity: info\n    annotations:\n      summary: Postgresql configuration changed (instance {{ $labels.instance }})\n      description: \"Postgres Database configuration change has occurred\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#20-postgresql-ssl-compression-active","title":"20. Postgresql SSL compression active","text":"<p>Database connections with SSL compression enabled. This may add significant jitter in replication delay. Replicas should turn off SSL compression via <code>sslcompression=0</code> in <code>recovery.conf</code>.</p> <pre><code>  - alert: PostgresqlSslCompressionActive\n    expr: sum(pg_stat_ssl_compression) &gt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Postgresql SSL compression active (instance {{ $labels.instance }})\n      description: \"Database connections with SSL compression enabled. This may add significant jitter in replication delay. Replicas should turn off SSL compression via `sslcompression=0` in `recovery.conf`.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7PostgreSQL/#21-postgresql-too-many-locks-acquired","title":"21. Postgresql too many locks acquired","text":"<p>Too many locks acquired on the database. If this alert happens frequently, we may need to increase the postgres setting <code>max_locks_per_transaction</code>.</p> <pre><code>  - alert: PostgresqlTooManyLocksAcquired\n    expr: ((sum (pg_locks_count)) / (pg_settings_max_locks_per_transaction * pg_settings_max_connections)) &gt; 0.20\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Postgresql too many locks acquired (instance {{ $labels.instance }})\n      description: \"Too many locks acquired on the database. If this alert happens frequently, we may need to increase the postgres setting max_locks_per_transaction.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n\n</code></pre>"},{"location":"chap9/7PostgreSQL/#22-slow-queries","title":"22. Slow queries","text":"<p>PostgreSQL executes slow queries (&gt; 1min)</p> <pre><code>- alert: SlowQueries\n  expr: avg(rate(pg_stat_activity_max_tx_duration{datname!~\"template.*\"}[1m])) BY (datname) &gt; 60\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Slow queries (instance {{ $labels.instance }})\"\n    description: \"PostgreSQL executes slow queries (&gt; 1min)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/7other/","title":"7 Others","text":""},{"location":"chap9/7other/#1-thanos","title":"1 Thanos","text":"<ol> <li>Thanos compaction halted</li> <li>Thanos compact bucket operation failure</li> <li>Thanos compact not run</li> </ol>"},{"location":"chap9/7other/#2-loki","title":"2 Loki","text":"<ol> <li>Loki process too many restarts</li> <li>Loki request errors</li> <li>Loki request panic</li> <li>Loki request latency</li> </ol>"},{"location":"chap9/7other/#3-promtail","title":"3. Promtail","text":"<ol> <li>Promtail request errors</li> <li>Promtail request latency</li> </ol>"},{"location":"chap9/7other/#4-cortex","title":"4. Cortex","text":"<ol> <li>Cortex ruler configuration reload failure</li> <li>Cortex not connected to Alertmanager</li> <li>Cortex notification are being dropped</li> <li>Cortex notification error</li> <li>Cortex ingester unhealthy</li> <li>Cortex frontend queries stuck</li> </ol>"},{"location":"chap9/7other/#5-jenkins","title":"5 Jenkins","text":"<ol> <li>Jenkins offline</li> <li>Jenkins healthcheck</li> <li>Jenkins outdated plugins</li> <li>Jenkins builds health score</li> <li>Jenkins run failure total</li> <li>Jenkins build tests failing</li> <li>Jenkins last build failed</li> </ol>"},{"location":"chap9/8Alerting_sleep/","title":"8 Alert Sleep Peacefully","text":""},{"location":"chap9/8Alerting_sleep/#1-alerting-time-window","title":"1 Alerting time window","text":"<p>In some applications, load and activity can vary over the day/week/year.</p> <p>In order to prevent alarm fatigue and busy pager, alerts can be disabled during a period of time (such as night or weekend).</p> <p>Example:</p> <ul> <li>Weekday: <code>node_load5 &gt; 10 and ON() (0 &lt; day_of_week() &lt; 6)</code></li> <li>Day time: <code>node_load5 &gt; 10 and ON() (8 &lt; hour() &lt; 18)</code></li> <li>Exclude December: <code>node_load5 &gt; 10 and ON() (month() != 12)</code></li> </ul>"},{"location":"chap9/8Alerting_sleep/#advanced-time-windows-and-timezones","title":"Advanced time windows and timezones","text":"<pre><code># rules.yml\n\n- record: is_european_summer_time\n  expr: |\n      (vector(1) and (month() &gt; 3 and month() &lt; 10))\n      or\n      (vector(1) and (month() == 3 and (day_of_month() - day_of_week()) &gt;= 25) and absent((day_of_month() &gt;= 25) and (day_of_week() == 0)))\n      or\n      (vector(1) and (month() == 10 and (day_of_month() - day_of_week()) &lt; 25) and absent((day_of_month() &gt;= 25) and (day_of_week() == 0)))\n      or\n      (vector(1) and ((month() == 10 and hour() &lt; 1) or (month() == 3 and hour() &gt; 0)) and ((day_of_month() &gt;= 25) and (day_of_week() == 0)))\n      or\n      vector(0)\n\n- record: europe_london_time\n  expr: time() + 3600 * is_european_summer_time\n- record: europe_paris_time\n  expr: time() + 3600 * (1 + is_european_summer_time)\n\n- record: europe_london_hour\n  expr: hour(europe_london_time)\n- record: europe_paris_hour\n  expr: hour(europe_paris_time)\n\n- record: europe_london_weekday\n  expr: 0 &lt; day_of_week(europe_london_time) &lt; 6\n- record: europe_paris_weekday\n  expr: 0 &lt; day_of_week(europe_paris_time) &lt; 6\n\n- record: europe_london_daytime\n  expr: 8 &lt; europe_london_hour &lt; 18\n- record: europe_paris_daytime\n  expr: 8 &lt; europe_paris_hour &lt; 18\n\n# new year's day / xmas / labor day / all saints' day / ...\n- record: europe_french_public_holidays\n  expr: |\n      (vector(1) and month(europe_paris_time) == 1 and day_of_month(europe_paris_time) == 1)\n      or\n      (vector(1) and month(europe_paris_time) == 12 and day_of_month(europe_paris_time) == 25)\n      or\n      (vector(1) and month(europe_paris_time) == 5 and day_of_month(europe_paris_time) == 1)\n      or\n      (vector(1) and month(europe_paris_time) == 11 and day_of_month(europe_paris_time) == 1)\n      or\n      vector(0)\n</code></pre> <pre><code>#  alerts.yml\n\n- alert: HighLoadQuietDuringWeekendAndNight\n  expr: node_load5 &gt; 10 and ON() (europe_london_weekday and europe_paris_weekday)\n\n- alert: HighLoadQuietDuringBackup\n  expr: node_load5 &gt; 10 and ON() absent(hour() == 2)\n\n- alert: HighLoad\n  expr: |\n      node_load5 &gt; 20 and ON() (europe_london_weekday and europe_paris_weekday)\n      or\n      node_load5 &gt; 10\n</code></pre> <p>Sources</p> <ul> <li>https://medium.com/@tom.fawcett/time-of-day-based-notifications-with-prometheus-and-alertmanager-1bf7a23b7695</li> <li>https://promcon.io/2019-munich/slides/improved-alerting-with-prometheus-and-alertmanager.pdf</li> </ul>"},{"location":"chap9/8Redis/","title":"5 Redis","text":"<p>https://github.com/oliver006/redis_exporter</p>"},{"location":"chap9/8Redis/#1-redis-down","title":"1. Redis down","text":"<p>Redis instance is down</p> <pre><code>- alert: RedisDown\n  expr: redis_up == 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Redis down (instance {{ $labels.instance }})\"\n    description: \"Redis instance is down\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#2-redis-missing-master","title":"2. Redis missing master","text":"<p>Redis cluster has no node marked as master.</p> <pre><code>  - alert: RedisMissingMaster\n    expr: (count(redis_instance_info{role=\"master\"}) or vector(0)) &lt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Redis missing master (instance {{ $labels.instance }})\n      description: \"Redis cluster has no node marked as master.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#3-redis-too-many-masters","title":"3. Redis too many masters","text":"<p>Redis cluster has too many nodes marked as master.</p> <pre><code>  - alert: RedisTooManyMasters\n    expr: count(redis_instance_info{role=\"master\"}) &gt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Redis too many masters (instance {{ $labels.instance }})\n      description: \"Redis cluster has too many nodes marked as master.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#4-redis-disconnected-slaves","title":"4. Redis disconnected slaves","text":"<p>Redis not replicating for all slaves. Consider reviewing the redis replication status.</p> <pre><code>  - alert: RedisDisconnectedSlaves\n    expr: count without (instance, job) (redis_connected_slaves) - sum without (instance, job) (redis_connected_slaves) - 1 &gt; 1\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Redis disconnected slaves (instance {{ $labels.instance }})\n      description: \"Redis not replicating for all slaves. Consider reviewing the redis replication status.\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#5-redis-replication-broken","title":"5. Redis replication broken","text":"<p>Redis instance lost a slave</p> <pre><code>  - alert: RedisReplicationBroken\n    expr: delta(redis_connected_slaves[1m]) &lt; 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: Redis replication broken (instance {{ $labels.instance }})\n      description: \"Redis instance lost a slave\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#6-redis-cluster-flapping","title":"6. Redis cluster flapping","text":"<p>Changes have been detected in Redis replica connection. This can occur when replica nodes lose connection to the master and reconnect (a.k.a flapping).</p> <pre><code>  - alert: RedisClusterFlapping\n    expr: changes(redis_connected_slaves[1m]) &gt; 1\n    for: 2m\n    labels:\n      severity: critical\n    annotations:\n      summary: Redis cluster flapping (instance {{ $labels.instance }})\n      description: \"Changes have been detected in Redis replica connection. This can occur when replica nodes lose connection to the master and reconnect (a.k.a flapping).\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#7-missing-backup","title":"7. Missing backup","text":"<p>Redis has not been backuped for 24 hours</p> <pre><code>- alert: MissingBackup\n  expr: time() - redis_rdb_last_save_timestamp_seconds &gt; 60 * 60 * 24\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Missing backup (instance {{ $labels.instance }})\"\n    description: \"Redis has not been backuped for 24 hours\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#8-redis-out-of-system-memory","title":"8. Redis out of system memory","text":"<p>Redis is running out of memory (&gt; 90%)</p> <pre><code>- alert: OutOfMemory\n  expr: redis_memory_used_bytes / redis_total_system_memory_bytes * 100 &gt; 90\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Out of memory (instance {{ $labels.instance }})\"\n    description: \"Redis is running out of memory (&gt; 90%)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#9-redis-out-of-configured-maxmemory","title":"9. Redis out of configured maxmemory","text":"<p>Redis is running out of configured maxmemory (&gt; 90%)</p> <pre><code>  - alert: RedisOutOfConfiguredMaxmemory\n    expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 &gt; 90\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: Redis out of configured maxmemory (instance {{ $labels.instance }})\n      description: \"Redis is running out of configured maxmemory (&gt; 90%)\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#10-too-many-connections","title":"10. Too many connections","text":"<p>Redis instance has too many connections</p> <pre><code>- alert: TooManyConnections\n  expr: redis_connected_clients &gt; 100\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Too many connections (instance {{ $labels.instance }})\"\n    description: \"Redis instance has too many connections\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#11-not-enough-connections","title":"11. Not enough connections","text":"<p>Redis instance should have more connections (&gt; 5)</p> <pre><code>- alert: NotEnoughConnections\n  expr: redis_connected_clients &lt; 5\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"Not enough connections (instance {{ $labels.instance }})\"\n    description: \"Redis instance should have more connections (&gt; 5)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/8Redis/#12-rejected-connections","title":"12. Rejected connections","text":"<p>Some connections to Redis has been rejected</p> <pre><code>- alert: RejectedConnections\n  expr: increase(redis_rejected_connections_total[1m]) &gt; 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"Rejected connections (instance {{ $labels.instance }})\"\n    description: \"Some connections to Redis has been rejected\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/","title":"6. MongoDB","text":"<p>https://github.com/percona/mongodb_exporter</p>"},{"location":"chap9/9Mongodb/#1-mongodb-down","title":"1. MongoDB Down","text":"<p>MongoDB instance is down</p> <pre><code>  - alert: MongodbDown\n    expr: mongodb_up == 0\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: MongoDB Down (instance {{ $labels.instance }})\n      description: \"MongoDB instance is down\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#2-mongodb-replication-lag","title":"2. MongoDB replication lag","text":"<p>Mongodb replication lag is more than 10s</p> <pre><code>- alert: MongodbReplicationLag\n  expr: avg(mongodb_replset_member_optime_date{state=\"PRIMARY\"}) - avg(mongodb_replset_member_optime_date{state=\"SECONDARY\"}) &gt; 10\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"MongoDB replication lag (instance {{ $labels.instance }})\"\n    description: \"Mongodb replication lag is more than 10s\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#3-mongodb-replication-headroom","title":"3. MongoDB replication headroom","text":"<p>MongoDB replication headroom is &lt;= 0</p> <pre><code>- alert: MongodbReplicationHeadroom\n  expr: (avg(mongodb_replset_oplog_tail_timestamp - mongodb_replset_oplog_head_timestamp) - (avg(mongodb_replset_member_optime_date{state=\"PRIMARY\"}) - avg(mongodb_replset_member_optime_date{state=\"SECONDARY\"}))) &lt;= 0\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"MongoDB replication headroom (instance {{ $labels.instance }})\"\n    description: \"MongoDB replication headroom is &lt;= 0\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#4-mongodb-number-cursors-open","title":"4. MongoDB number cursors open","text":"<p>Too many cursors opened by MongoDB for clients (&gt; 10k)</p> <pre><code>  - alert: MongodbNumberCursorsOpen\n    expr: mongodb_mongod_metrics_cursor_open{state=\"total\"} &gt; 10 * 1000\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: MongoDB number cursors open (instance {{ $labels.instance }})\n      description: \"Too many cursors opened by MongoDB for clients (&gt; 10k)\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#5-mongodb-cursors-timeouts","title":"5. MongoDB cursors timeouts","text":"<p>Too many cursors are timing out</p> <pre><code>  - alert: MongodbCursorsTimeouts\n    expr: increase(mongodb_mongod_metrics_cursor_timed_out_total[1m]) &gt; 100\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: MongoDB cursors timeouts (instance {{ $labels.instance }})\n      description: \"Too many cursors are timing out\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#6-mongodb-too-many-connections","title":"6. MongoDB too many connections","text":"<p>Too many connections (&gt; 80%)</p> <pre><code>  - alert: MongodbTooManyConnections\n    expr: avg by(instance) (rate(mongodb_connections{state=\"current\"}[1m])) / avg by(instance) (sum (mongodb_connections) by (instance)) * 100 &gt; 80\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: MongoDB too many connections (instance {{ $labels.instance }})\n      description: \"Too many connections (&gt; 80%)\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#7-mongodb-virtual-memory-usage","title":"7. MongoDB virtual memory usage","text":"<p>High memory usage</p> <pre><code>  - alert: MongodbVirtualMemoryUsage\n    expr: (sum(mongodb_memory{type=\"virtual\"}) BY (instance) / sum(mongodb_memory{type=\"mapped\"}) BY (instance)) &gt; 3\n    for: 2m\n    labels:\n      severity: warning\n    annotations:\n      summary: MongoDB virtual memory usage (instance {{ $labels.instance }})\n      description: \"High memory usage\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#mongodb-dcumongodb_exporter","title":"MongoDB : <code>dcu/mongodb_exporter</code>","text":""},{"location":"chap9/9Mongodb/#1-mongodb-replication-lag","title":"1. MongoDB replication lag","text":"<p>Mongodb replication lag is more than 10s</p> <pre><code>  - alert: MongodbReplicationLag\n    expr: avg(mongodb_replset_member_optime_date{state=\"PRIMARY\"}) - avg(mongodb_replset_member_optime_date{state=\"SECONDARY\"}) &gt; 10\n    for: 0m\n    labels:\n      severity: critical\n    annotations:\n      summary: MongoDB replication lag (instance {{ $labels.instance }})\n      description: \"Mongodb replication lag is more than 10s\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#2-mongodb-replication-status-3","title":"2. MongoDB replication Status 3","text":"<p>MongoDB Replication set member either perform startup self-checks, or transition from completing a rollback or resync</p> <pre><code>- alert: MongodbReplicationStatus3\n  expr: mongodb_replset_member_state == 3\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"MongoDB replication Status 3 (instance {{ $labels.instance }})\"\n    description: \"MongoDB Replication set member either perform startup self-checks, or transition from completing a rollback or resync\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#3-mongodb-replication-status-6","title":"3. MongoDB replication Status 6","text":"<p>MongoDB Replication set member as seen from another member of the set, is not yet known</p> <pre><code>- alert: MongodbReplicationStatus6\n  expr: mongodb_replset_member_state == 6\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"MongoDB replication Status 6 (instance {{ $labels.instance }})\"\n    description: \"MongoDB Replication set member as seen from another member of the set, is not yet known\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#4-mongodb-replication-status-8","title":"4 MongoDB replication Status 8","text":"<p>MongoDB Replication set member as seen from another member of the set, is unreachable</p> <pre><code>- alert: MongodbReplicationStatus8\n  expr: mongodb_replset_member_state == 8\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"MongoDB replication Status 8 (instance {{ $labels.instance }})\"\n    description: \"MongoDB Replication set member as seen from another member of the set, is unreachable\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#5-mongodb-replication-status-9","title":"5. MongoDB replication Status 9","text":"<p>MongoDB Replication set member is actively performing a rollback. Data is not available for reads</p> <pre><code>- alert: MongodbReplicationStatus9\n  expr: mongodb_replset_member_state == 9\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"MongoDB replication Status 9 (instance {{ $labels.instance }})\"\n    description: \"MongoDB Replication set member is actively performing a rollback. Data is not available for reads\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#14-mongodb-replication-status-10","title":"14. MongoDB replication Status 10","text":"<p>MongoDB Replication set member was once in a replica set but was subsequently removed</p> <pre><code>- alert: MongodbReplicationStatus10\n  expr: mongodb_replset_member_state == 10\n  for: 5m\n  labels:\n    severity: error\n  annotations:\n    summary: \"MongoDB replication Status 10 (instance {{ $labels.instance }})\"\n    description: \"MongoDB Replication set member was once in a replica set but was subsequently removed\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#15-mongodb-number-cursors-open","title":"15. MongoDB number cursors open","text":"<p>Too many cursors opened by MongoDB for clients (&gt; 10k)</p> <pre><code>- alert: MongodbNumberCursorsOpen\n  expr: mongodb_metrics_cursor_open{state=\"total_open\"} &gt; 10000\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"MongoDB number cursors open (instance {{ $labels.instance }})\"\n    description: \"Too many cursors opened by MongoDB for clients (&gt; 10k)\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#16-mongodb-cursors-timeouts","title":"16. MongoDB cursors timeouts","text":"<p>Too many cursors are timing out</p> <pre><code>- alert: MongodbCursorsTimeouts\n  expr: increase(mongodb_metrics_cursor_timed_out_total[10m]) &gt; 100\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"MongoDB cursors timeouts (instance {{ $labels.instance }})\"\n    description: \"Too many cursors are timing out\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#17-mongodb-too-many-connections","title":"17. MongoDB too many connections","text":"<p>Too many connections</p> <pre><code>- alert: MongodbTooManyConnections\n  expr: mongodb_connections{state=\"current\"} &gt; 500\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"MongoDB too many connections (instance {{ $labels.instance }})\"\n    description: \"Too many connections\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap9/9Mongodb/#10-mongodb-virtual-memory-usage","title":"10. MongoDB virtual memory usage","text":"<p>High memory usage</p> <pre><code>- alert: MongodbVirtualMemoryUsage\n  expr: (sum(mongodb_memory{type=\"virtual\"}) BY (ip) / sum(mongodb_memory{type=\"mapped\"}) BY (ip)) &gt; 3\n  for: 5m\n  labels:\n    severity: warning\n  annotations:\n    summary: \"MongoDB virtual memory usage (instance {{ $labels.instance }})\"\n    description: \"High memory usage\\n  VALUE = {{ $value }}\\n  LABELS: {{ $labels }}\"\n</code></pre>"},{"location":"chap_apm/1apm_prods/","title":"\u7b2c\u4e00\u8282 APM\u4ea7\u54c1\u843d\u5730\u5b9e\u6218","text":""},{"location":"chap_apm/1apm_prods/#1-cat","title":"1 \u7cfb\u7edf\u76d1\u63a7\uff1a\u8001\u724c\u76d1\u63a7\u70b9\u8bc4 CAT","text":"<p>CAT\uff08Central Application Tracking\uff09</p> <p>\u9996\u5148\uff0c\u4ece\u65f6\u95f4\u4e0a\u770b\uff0cCAT \u9996\u4e2a\u5f00\u6e90\u7248\u672c\u662f\u5728 2012 \u5e74\uff0c\u6b64\u65f6\u671f\u4e0e APM \u76f8\u5173\u91cd\u5927\u4e8b\u4ef6\u6709\uff1a</p> <ul> <li>Google \u516c\u53f8\u53d1\u5e03\u300aDapper \u8bba\u6587\u300b\uff1b</li> <li>\u7d27\u968f\u5176\u540e\uff0cNaver \u516c\u53f8\u53d1\u5e03\u5f00\u6e90\u65e0\u4fb5\u5165 APM \u7cfb\u7edfPinpoint\uff1b</li> <li>Twitter \u516c\u53f8\u53d1\u5e03\u5f00\u6e90 APM \u7cfb\u7edfZipkin\uff0cZipkin \u662f Spring Cloud \u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edfSpring-Cloud-Sleuth\u7684\u89e3\u51b3\u65b9\u6848\u3002</li> </ul>"},{"location":"chap_apm/1apm_prods/#1-1-cat","title":"1-1 CAT \u51ed\u4ec0\u4e48\u79f0\u4e3a\u201c\u8001\u724c\u76d1\u63a7\u201d\uff1f","text":"<ul> <li>Java \u5f00\u53d1\u5b9e\u73b0\u7684\u5b9e\u65f6\u5e94\u7528\u76d1\u63a7\u5e73\u53f0,  \u8d77\u521d\u4e13\u4e3a\u5927\u89c4\u6a21 Java \u5fae\u670d\u52a1\u96c6\u7fa4\u63d0\u4f9b\u5b9e\u65f6\u76d1\u63a7\u62a5\u8b66\u573a\u666f</li> <li>\u5e94\u7528\u670d\u52a1\u5728\u4ee3\u7801\u4e2d\u5f15\u5165 CAT \u5ba2\u6237\u7aef\u548c\u76f8\u5173\u57cb\u70b9\u96c6\u6210\u65b9\u6848\u5373\u53ef\u5b8c\u6210\u63a5</li> <li>\u670d\u52a1\u7aef\u7531\u4e24\u4e2a\u6a21\u5757\u7ec4\u6210\uff0c\u8d1f\u8d23\u6536\u96c6\u5206\u6790\u5ba2\u6237\u7aef\u6570\u636e\u7684\u6536\u96c6\u5668\u6a21\u5757\u548c\u8d1f\u8d23\u7ed9\u7528\u6237\u63d0\u4f9b\u62a5\u8868\u5c55\u793a\u7684\u63a7\u5236\u7aef\u6a21\u5757</li> </ul> <p>\u603b\u7684\u6765\u8bf4 CAT \u4ea7\u54c1\u67b6\u6784\u662f\u7531\u4e09\u4e2a\u6a21\u5757\u7ec4\u6210\uff0c\u67b6\u6784\u8bbe\u8ba1\u975e\u5e38\u6e05\u6670\uff1a</p> <ul> <li>Cat-client \u63d0\u4f9b\u7ed9\u5e94\u7528\u4ee5\u53ca\u4e2d\u95f4\u5c42\u57cb\u70b9\u7684\u5e95\u5c42 SDK</li> <li>Cat-consumer \u7528\u4e8e\u5b9e\u65f6\u5206\u6790\u4ece\u5ba2\u6237\u7aef\u63d0\u4f9b\u7684\u6570\u636e\uff08\u6536\u96c6\u5668\u6a21\u5757\uff09</li> <li>Cat-home \u4f5c\u4e3a\u7ed9\u7528\u6237\u63d0\u4f9b\u5c55\u793a\u7684\u63a7\u5236\u7aef\uff08\u63a7\u5236\u7aef\u6a21\u5757\uff09</li> </ul> <p></p>"},{"location":"chap_apm/1apm_prods/#1-2","title":"1-2 \u5b9e\u65f6\u7684\u4ee3\u7801\u6bb5\u76d1\u63a7\u62a5\u8868","text":"<p>CAT \u63d0\u4f9b\u4e86\u975e\u5e38\u4e30\u5bcc\u7684\u62a5\u8868\uff0c\u5e94\u7528\u670d\u52a1\u7b80\u5355\u63a5\u5165 CAT \u5ba2\u6237\u7aef\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 CAT \u670d\u52a1\u7aef\u5168\u65b9\u4f4d\u5730\u76d1\u63a7\u5e94\u7528\u96c6\u7fa4\u4e86</p> <p></p>"},{"location":"chap_apm/1apm_prods/#1-3","title":"1-3 \u5ba2\u6237\u7aef\u6027\u80fd\u635f\u8017\u4f4e","text":""},{"location":"chap_apm/1apm_prods/#1-4","title":"1-4 \u843d\u5730\u5b9e\u8df5\u8981\u70b9","text":"<ul> <li>\u5efa\u8bae\u6240\u6709\u5e94\u7528\u670d\u52a1\u63a5\u5165 CAT</li> <li>\u4e0d\u5efa\u8bae\u4f7f\u7528 CAT \u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u529f\u80fd<ul> <li>\u201c\u6811\u5f62\u201d\u6a21\u578b\u65e0\u6cd5\u8ffd\u8e2a\u6279\u5904\u7406\u6846\u67b6\u7684\u94fe\u8def<ul> <li>CAT \u4f7f\u7528 ROOT\u3001PARENT \u548c CHILD \u4e09\u4e2a\u53c2\u6570\u5b9e\u73b0\u4e86\u5206\u5e03\u5f0f\u94fe\u8def\u8ddf\u8e2a\u7684\u201c\u6811\u5f62\u201d\u6a21\u578b\uff0c\u800c\u201c\u6811\u5f62\u201d\u6a21\u578b\u662f\u65e0\u6cd5\u7ed8\u5236\u5206\u5e03\u5f0f\u96c6\u7fa4\u4e2d\u5b58\u5728\u6279\u5904\u7406\u6846\u67b6\u7684\u94fe\u8def\u7684\u3002</li> <li>\u5373\u4f7f\u4e0d\u9700\u8981\u8ffd\u8e2a\u6279\u5904\u7406\u6846\u67b6\u7684\u94fe\u8def\uff0cCAT \u5206\u5e03\u5f0f\u94fe\u8def\u8ddf\u8e2a\u4ee3\u7801\u4e5f\u9700\u8981\u8ba9\u6bcf\u4e2a RD \u7406\u89e3\u8ddf\u8e2a\u6a21\u578b\uff0c\u7136\u540e\u5206\u5e03\u5f0f\u8ddf\u8e2a\u7684\u4e0a\u4e0b\u6e38\u90fd\u9700\u8981\u53bb\u8fdb\u884c\u624b\u52a8\u57cb\u70b9\u624d\u53ef\u4ee5\u5b9e\u73b0</li> </ul> </li> <li>\u62a5\u8868\u5c55\u793a\u6548\u679c\u4e0d\u7406\u60f3\uff0c\u4e14\u8fc7\u65f6<ul> <li>CAT \u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u5c55\u793a\uff0c\u53ef\u901a\u8fc7 Transaction \u62a5\u8868\u7684 logview \u89c6\u56fe\u67e5\u770b\u3002\u4e2a\u4eba\u89c9\u5f97\u5176\u5c55\u793a\u6548\u679c\u76f8\u8f83 SkyWalking\u3001Zipkin \u7684\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u89c6\u56fe\u5b58\u5728\u660e\u663e\u5dee\u8ddd\u3002</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap_apm/1apm_prods/#1-5","title":"1-5 \u7ebf\u7a0b\u4f18\u5316","text":"<p>1.\u4e3a\u4ec0\u4e48\u8981\u8fdb\u884c\u7ebf\u7a0b\u4f18\u5316\uff1f</p> <ul> <li>\u4ece\u8f6f\u4ef6\u8d44\u6e90\u89d2\u5ea6\uff1aJava\u4ece\u5e94\u7528\u89c6\u89d2\u770b\uff0c\u7ebf\u7a0b\u7684\u4f18\u5316\u53ef\u4ee5\u4f18\u5316 JVM \u8d44\u6e90\uff0c\u4ece\u800c\u51cf\u5c11 GC\u3002</li> <li>\u4ece\u786c\u4ef6\u8d44\u6e90\u89d2\u5ea6\uff1a \u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a\u8282\u70b9\u8d44\u6e90\u8fd0\u884c\u591a\u4e2a\u8fdb\u7a0b\uff0c\u964d\u4f4e\u786c\u4ef6\u6210\u672c</li> <li>\u4ece\u53ef\u7528\u6027\u89d2\u5ea6\uff1a\u975e\u9884\u671f\u7684 GC \u5bfc\u81f4\u5e94\u7528\u8282\u70b9\u4e0d\u80fd\u6309\u7167\u9884\u671f\u54cd\u5e94\u6d88\u8d39\u8005\uff0c\u9020\u6210\u5e94\u7528\u670d\u52a1\u4e0d\u53ef\u7528\u3002</li> </ul> <p>2.\u4f7f\u7528\u7ebf\u7a0b\u7684\u6b63\u786e\u59ff\u52bf</p> <p></p> <p>\u6b63\u786e\u4f7f\u7528\u65b9\u5f0f\u662f</p> <ul> <li>\u4f7f\u7528\u7ebf\u7a0b\u6c60\u53bb\u7ba1\u7406\u7ebf\u7a0b\uff1b</li> <li>\u7ebf\u7a0b\u7684\u547d\u540d\u9700\u8981\u6709\u610f\u4e49\uff1b</li> <li>\u4efb\u52a1\u7ebf\u7a0b\u7684\u6570\u91cf\u9700\u8981\u4e0e\u5de5\u4f5c\u7ebf\u7a0b\u6302\u94a9\uff0c\u4e14\u9700\u8981\u8003\u8651\u6781\u7aef\u60c5\u51b5\uff0c\u5982\u6545\u969c\u91cd\u542f\u3002</li> </ul> <p>3.CAT \u6539\u9020</p> <p>\u4e3a\u4e86\u8ba9 Heartbeat \u62a5\u8868\u652f\u6301\u66f4\u7ec6\u7684\u6846\u67b6\u7ebf\u7a0b\u7c92\u5ea6\u76d1\u63a7\uff0c\u6211\u4eec\u9700\u8981\u638c\u63e1 CAT \u7684\u76d1\u63a7\u7ebf\u7a0b\u5b9e\u73b0\u539f\u7406\u3002Heartbeat \u529f\u80fd\u91c7\u96c6\u7ebf\u7a0b\u901a\u8fc7 <code>Java ThreadMXBean</code> \u83b7\u53d6\u8fdb\u7a0b\u4e2d\u7684\u7ebf\u7a0b\u4fe1</p> <p>\u539f\u7406\u5f88\u7b80\u5355\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u76d1\u63a7 Apache Dubbo \u7684\u6838\u5fc3\u7ebf\u7a0b\u548c\u6d3b\u8dc3\u7ebf\u7a0b\u6570\uff0c\u53ea\u9700\u8981\u5728\u6b64\u5904\u4ee3\u7801\u589e\u52a0\u524d\u7f00<code>DubboServerHandler-</code>\uff0c\u5373\u53ef\u76d1\u63a7 <code>Apache Dubbo</code> \u7684\u6838\u5fc3\u7ebf\u7a0b\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u7684\u7ebf\u7a0b\uff0c\u901a\u8fc7\u83b7\u53d6\u8fd0\u884c\u72b6\u6001\u6216\u8005\u975e\u7b49\u5f85\u72b6\u6001\u7684\u7ebf\u7a0b\uff0c\u5c31\u53ef\u4ee5\u7edf\u8ba1\u51fa\u6d3b\u8dc3\u7ebf\u7a0b\u6570\u3002</p> <p>4. \u4f18\u5316\u5b9e\u6218</p> <p>\u6b64\u5e94\u7528\u670d\u52a1\u5b58\u5728\u5927\u91cf\u7684\u5185\u7f6e\u6846\u67b6\uff08Apache Dubbo\u3001Netty\uff09\u7684\u8fc7\u5ea6\u7ebf\u7a0b\u4f7f\u7528\uff0c\u8fd9\u4e9b\u6846\u67b6\u6ee5\u7528\u7ebf\u7a0b\u7684\u5f62\u5f0f\u901a\u5e38\u4f1a\u5206\u4e3a\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\u3002</p> <ul> <li>\u7b2c\u4e00\u79cd\uff1a\u7ebf\u7a0b\u6c60\u4f7f\u7528\u4e00\u4e2a\u8f83\u5927\u7684\u56fa\u5b9a\u503c\u3002\u4f8b\u5982 Apache Dubbo \u4e3a\u4f8b\uff0c\u670d\u52a1\u63d0\u4f9b\u8005\u7684\u9ed8\u8ba4\u7ebf\u7a0b\u6570\u4e3a 200 \u7684 Fixed \u7684\u7ebf\u7a0b\u6c60\u3002</li> <li> <p>\u7b2c\u4e8c\u79cd\uff1a\u548c CPU \u6838\u5fc3\u6570\u6302\u94a9\u7684\u7ebf\u7a0b\u6c60\u3002\u975e\u5e38\u5178\u578b\u7684\u4ee3\u7801<code>Runtime.getRuntime().availableProcessors()*2</code> \u83b7\u53d6\u786c\u4ef6\u73af\u5883\u53ef\u7528\u7684 CPU \u6838\u5fc3\u6570 2 \u500d\u4f5c\u4e3a\u7ebf\u7a0b\u6c60\u4e2a\u6570\uff0c\u4f8b\u5982 Redisson\u3002</p> </li> <li> <p>\u6570\u91cf\u4f18\u5316</p> <ul> <li>\u7b2c\u4e00\u79cd\uff0c\u6846\u67b6\u4f7f\u7528\u7ebf\u7a0b\u6c60\u7684\u65b9\u5f0f\u663e\u7136\u5c31\u4e0d\u5408\u7406\u3002\u901a\u8fc7 CAT \u6539\u9020\uff0c\u53ef\u4ee5\u76d1\u63a7 Apache Dubbo \u7684\u7ebf\u7a0b\u6570\uff0c\u4f60\u4f1a\u53d1\u73b0\u4e00\u822c\u7684\u5e94\u7528\u670d\u52a1\u53ea\u7528\u4e86\u5341\u51e0\u4e2a\u7ebf\u7a0b\u3002<ul> <li>\u5efa\u8bae\uff0c\u53ef\u4ee5\u6839\u636e\u9ad8\u5cf0\u548c\u4e00\u5b9a\u7684\u672a\u6765\u9884\u4f30\u6765\u9002\u5f53\u7f29\u5c0f\u7ebf\u7a0b\u6c60\uff0c\u5e76\u4e14\u8003\u8651\u5c06\u7ebf\u7a0b\u6c60\u7c7b\u578b\u7531 Fixed \u6539\u4e3a Cache\uff0c\u5b9e\u73b0\u51cf\u5c11\u9879\u76ee\u7684\u542f\u52a8\u65f6\u95f4\u548c\u4e0d\u5fc5\u8981\u7684\u7ebf\u7a0b\u6c60\u6570\u91cf\u3002</li> </ul> </li> <li>\u7b2c\u4e8c\u79cd\uff0c\u4e3b\u8981\u4f1a\u5728\u516c\u53f8\u4f7f\u7528 IDC \u673a\u623f\uff0c\u91c7\u53d6\u7269\u7406\u673a\u591a\u8fdb\u7a0b\u6df7\u5408\u90e8\u7f72\u7684\u65b9\u5f0f\uff0c\u4f1a\u5b58\u5728\u7ebf\u7a0b\u6ee5\u7528\u8fc7\u591a\u7684\u60c5\u51b5\u3002<ul> <li>\u4ee5 Redis \u5ba2\u6237\u7aef Redisson \u4e3a\u4f8b\uff0cRedisson \u5ba2\u6237\u7aef\u4f7f\u7528 Netty \u4e0e Redis \u96c6\u7fa4\u901a\u8baf\uff0c\u9ed8\u8ba4\u7684 Netty threads \u4e3a 0\uff0c\u8fd9\u79cd\u914d\u7f6e\u4f1a\u5f62\u6210\u7ebf\u7a0b\u6570\u4e0e CPU \u6838\u5fc3\u6570\u6302\u94a9\u3002</li> <li>\u5bf9\u4e8e\u5e38\u89c4\u7684\u5fae\u670d\u52a1\u8fdb\u7a0b\uff0c\u57fa\u672c\u90fd\u4f1a\u7528\u5230\u7684\u6846\u67b6\u6709 HTTP Server\u3001HTTP Client\u3001JDBC\u3001RPC Framework\u3001MQ \u548c NoSQL\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5e95\u5411\u4e0a\uff0c\u5c06\u6bcf\u4e2a\u5e94\u7528\u670d\u52a1\u7684\u5404\u4e2a\u6846\u67b6\u4f18\u5316\u4efb\u52a1\u5206\u914d\u5230\u5404\u4e2a\u6210\u5458\u3002\u7136\u540e\u81ea\u9876\u5411\u4e0b\uff0c\u901a\u8fc7 CAT \u7684\u6301\u7eed\u8ddf\u8fdb\u4f18\u5316\uff0c\u770b\u662f\u5426\u8fbe\u5230\u4e86\u9884\u671f\u3002</li> </ul> </li> </ul> </li> <li> <p>\u4f53\u79ef\u4f18\u5316</p> <ul> <li>\u9002\u5f53\u7f29\u5c0f\u7ebf\u7a0b\u6808\u5230 512k \u4ee5\u4e0b\uff0c\u5728\u5e94\u7528\u670d\u52a1\u4f7f\u7528\u8f83\u591a\u7ebf\u7a0b\u65f6\uff0c\u4f18\u5316\u7684\u6548\u679c\u4f1a\u975e\u5e38\u660e\u663e</li> </ul> </li> </ul>"},{"location":"chap_apm/1apm_prods/#2-apm-apache-skywalking","title":"2 APM \u5f15\u9886\u8005\uff1aApache SkyWalking","text":""},{"location":"chap_apm/1apm_prods/#2-1-apache-skywalking","title":"2-1 Apache SkyWalking \u53d1\u5c55\u5386\u7a0b","text":"<p>\u8fd9\u91cc\u6211\u5148\u5bf9\u4e0b\u9762\u5185\u5bb9\u4f7f\u7528\u7684\u7248\u672c\u53f7\uff0c\u8fdb\u884c\u7b80\u8981\u8bf4\u660e\u3002\u7248\u672c\u540e\u7f00\u4e3a\u4ec0\u4e48\u662f\u201c.X\u201d\uff1f\u5176\u5b9e\u8f6f\u4ef6\u7684\u53d1\u5e03\u7248\u672c\u53f7\u5206\u4e3a\u4e09\u4e2a\u90e8\u5206\uff0c\u5373\u201cX.Y.Z\u201d\uff1a</p> <ul> <li>\u201cX\u201d\u4ee3\u8868\u4e3b\u8981\u7248\u672c\uff0c\u6b64\u7248\u672c\u53f7\u7684\u5347\u7ea7\u4ee3\u8868\u8f6f\u4ef6\u6709\u91cd\u5927\u7279\u6027\u53d1\u5e03\uff0c\u4e14\u7279\u6027\u5f88\u53ef\u80fd\u4e0d\u5411\u524d\u517c\u5bb9\uff1b</li> <li>\u201cY\u201d\u4ee3\u8868\u6b21\u8981\u7248\u672c\uff0c\u8fd9\u4e2a\u7248\u672c\u901a\u5e38\u4e0d\u63d0\u4f9b\u91cd\u8981\u7684\u529f\u80fd\u7279\u6027\uff0c\u800c\u4f1a\u5bf9\u4e3b\u8981\u7248\u672c\u5e26\u6765\u7684\u91cd\u5927\u7279\u6027\uff0c\u8fdb\u884c\u8fed\u4ee3\u5347\u7ea7\uff1b</li> <li>\u201cZ\u201d\u4ee3\u8868\u4fee\u590d\u7248\u672c\uff0c\u7528\u4e8e Bug \u4fee\u590d\u3002</li> </ul> <p></p>"},{"location":"chap_apm/1apm_prods/#2-2","title":"2-2 \u4f01\u4e1a\u7ea7\u843d\u5730","text":"<p>\u5982\u679c\u65e9\u671f\u843d\u5730\u65b9\u6848\u4e0d\u597d\uff0c\u77ed\u671f\u770b\u5230\u7684\u90fd\u662f APM \u5de5\u5177\u5e26\u6765\u7684\u95ee\u9898\uff0c\u5bf9 APM \u65e5\u540e\u7684\u63a8\u5e7f\u975e\u5e38\u4e0d\u5229\u3002</p> <p>1.\u63a2\u9488\u4e0d\u7a33\u5b9a\uff0c\u5982\u4f55\u53ca\u65f6\u6b62\u635f\u5e76\u4fee\u590d\uff1f</p> <ul> <li>\u89e3\u51b3\u601d\u8def\u662f\uff1a\u5b9e\u73b0\u79d2\u7ea7\u522b\u7684\u6545\u969c\u6062\u590d\u548c\u95ee\u9898\u73b0\u573a\u4fdd\u7559\uff0c\u7136\u540e\u901a\u8fc7\u6301\u7eed\u7684\u5b9e\u8df5\uff0c\u6700\u7ec8\u627e\u5230\u9002\u5408\u81ea\u5df1\u56e2\u961f\u7684\u65b9\u6cd5\u8bba\u3002</li> <li>\u6b62\u635f\u65b9\u6848\uff1a\u4e1a\u52a1\u65b9\u63a5\u5165 SkyWalking \u63a2\u9488\u65f6\uff0c\u9700\u8981\u8fdb\u884c\u4e00\u6bb5\u65f6\u95f4\u7684\u7070\u5ea6\u63a5\u5165\uff0c\u786e\u4fdd\u7070\u5ea6\u4e00\u6bb5\u65f6\u95f4\u6ca1\u6709\u95ee\u9898\uff0c\u624d\u53ef\u4ee5\u5168\u91cf\u63a5\u5165\u3002\u800c\u5982\u679c\u7070\u5ea6\u8282\u70b9\u51fa\u73b0\u4e86\u95ee\u9898\uff0c\u4e00\u4e9b CASE \u81ea\u52a8\uff08\u5982\u8fdb\u7a0b\u6302\u6389\uff09\u548c\u515c\u5e95\u624b\u52a8\u5c06\u901a\u8fc7\u811a\u672c\u4f7f\u7528 Dump \u547d\u4ee4\u5bf9\u73b0\u573a\u8fdb\u884c\u4fdd\u7559\uff0c\u7136\u540e\u6253\u901a\u53d1\u5e03\u5e73\u53f0\u5feb\u901f\u6458\u9664\u63a2\u9488\u5e76\u4e0a\u7ebf\u3002</li> </ul> <p>2.\u9488\u5bf9\u4e0d\u540c\u4e2d\u95f4\u4ef6\uff0c\u5982\u4f55\u8bbe\u8ba1\u5dee\u5f02\u5316\u843d\u5730\u65b9\u6848\uff1f</p> <p>APM \u76d1\u63a7\u5b58\u50a8\u7684\u6570\u636e\u90fd\u662f\u6d77\u91cf\u7ea7\u522b\u7684\u3002\u5982\u679c\u5168\u8bb0\u5f55\u4e0b\u6765\uff0c\u9700\u8981\u6295\u5165\u5927\u91cf\u7684\u8bbe\u5907\u8d44\u6e90\uff0c\u4f46\u5e26\u6765\u7684\u6536\u76ca\u5374\u5f88\u5c0f\uff0c</p> <p>\u5047\u8bbe\u8981\u8bbe\u8ba1\u4e00\u6b3e\u9488\u5bf9 Redis \u7684 APM \u7cfb\u7edf\uff0c\u4e5f\u5c31\u662f\u8981\u505a\u5230\u80fd\u76d1\u63a7\u5230\u7684\u6570\u636e\u6700\u5c0f\u7c92\u5ea6\u4e3a Redis \u64cd\u4f5c\u547d\u4ee4\uff0c\u90a3\u52bf\u5fc5\u8981\u505a\u51fa\u6027\u80fd\u6bd4 Redis \u8fd8\u8981\u597d\u7684\u4ea7\u54c1\u624d\u53ef\u4ee5</p> <p>\u5c06\u8981\u76d1\u63a7\u7684\u4e1a\u52a1\u7cfb\u7edf\u5feb\u901f\u7684\u5206\u4e3a\u4e24\u7c7b\uff1a</p> <ul> <li>\u9ad8 QPS \u4f4e\u4e1a\u52a1\u7f16\u6392\u80fd\u529b\u7684\u5e95\u5c42\u7cfb\u7edf</li> <li>\u4f4e QPS \u9ad8\u4e1a\u52a1\u8d4b\u80fd\u7684\u4e1a\u52a1\u7cfb\u7edf</li> </ul> <p>3.\u6570\u636e\u66b4\u9732\u7684\u540c\u65f6\uff0c\u5982\u4f55\u4fdd\u969c\u4fe1\u606f\u5b89\u5168\uff1f</p> <p>\u5f53\u4f60\u5f15\u5165 SkyWalking \u540e\uff0c\u4f1a\u53d1\u73b0\u56fa\u5b9a\u7684\u8d26\u6237\u5bc6\u7801\u767b\u5f55\u540e\uff0c\u8fd9\u4e9b\u6d89\u5bc6\u4fe1\u606f\u4fbf\u4e00\u89c8\u65e0\u4f59\u3002</p> <ul> <li>SkyWalking \u63a5\u5165\u516c\u53f8\u7684\u767b\u5f55\u7cfb\u7edf\uff0c\u6bcf\u4e2a APM \u6570\u636e\u90fd\u5fc5\u987b\u6709\u76f8\u5e94\u7684\u5e94\u7528\u5f52\u5c5e\u3002\u5f53\u7528\u6237\u67e5\u8be2\u6570\u636e\u65f6\uff0c\u53ea\u6709\u7528\u6237\u6240\u5728\u7684\u5e94\u7528\u5f52\u5c5e\u4e0e APM \u6570\u636e\u7684\u5e94\u7528\u5f52\u5c5e\u4e00\u81f4\u624d\u53ef\u4ee5\u5c55\u793a\u3002</li> <li>APM \u5728\u5b9a\u4f4d\u95ee\u9898\u65f6\uff0c\u9700\u8981\u76f8\u5173\u8d44\u6e90\u7684\u6570\u636e\u8054\u52a8\u5c55\u793a\uff0c\u624d\u80fd\u53d1\u6325\u51fa\u771f\u6b63\u7684\u4ef7\u503c\u3002\u6240\u4ee5\u5728\u5e94\u7528\u62d3\u6251\u548c\u5168\u94fe\u8def\u8ffd\u8e2a\u65f6\uff0c\u4f1a\u5c55\u793a\u76f8\u5173\u8054\u7684\u6280\u672f\u6570\u636e\uff0c\u5982\u7aef\u70b9\u4fe1\u606f\u3001\u8017\u65f6\u7b49\uff1b\u4f46\u4e0d\u4f1a\u5c55\u793a\u6838\u5fc3\u6570\u636e\uff0c\u5982\u63a5\u53e3\u7684\u51fa\u5165\u53c2\uff0c\u6267\u884c SQL \u5177\u4f53\u4fe1\u606f\u7b49\u3002</li> <li>\u540c\u65f6\u4e5f\u6709\u90e8\u5206\u76f8\u5173\u8054\u7684\u6570\u636e\u662f\u4e0d\u5bf9\u5916\u5c55\u793a\u7684\uff0c\u5982\u516c\u53f8\u7684\u4eba\u4e8b\u3001\u85aa\u916c\u7b49\uff0c\u53ea\u5bf9\u672c\u5e94\u7528\u8d1f\u8d23\u7684 RD \u5c55\u793a\u3002</li> </ul>"},{"location":"chap_apm/1apm_prods/#3-java-alibaba-arthas","title":"3 Java \u6027\u80fd\u5206\u6790\u795e\u5668 Alibaba Arthas","text":""},{"location":"chap_apm/1apm_prods/#3-1-arthas","title":"3-1 Arthas \u7684\u6838\u5fc3\u5e94\u7528\u573a\u666f\u5982\u4e0b","text":"<ul> <li>\u573a\u666f 1\uff1a\u8fd9\u4e2a\u7c7b\u4ece\u54ea\u4e2a jar \u5305\u52a0\u8f7d\u7684\uff1f\u4e3a\u4ec0\u4e48\u4f1a\u62a5\u5404\u79cd\u7c7b\u76f8\u5173\u7684 Exception\uff1f</li> <li>\u573a\u666f 2\uff1a\u6211\u6539\u7684\u4ee3\u7801\u4e3a\u4ec0\u4e48\u6ca1\u6709\u6267\u884c\uff1f\u96be\u9053\u662f\u6211\u6ca1 commit\uff1f\u5206\u652f\u641e\u9519\u4e86\uff1f</li> <li>\u573a\u666f 3\uff1a\u9047\u5230\u95ee\u9898\u65e0\u6cd5\u5728\u7ebf\u4e0a debug\uff0c\u96be\u9053\u53ea\u80fd\u901a\u8fc7\u52a0\u65e5\u5fd7\u518d\u91cd\u65b0\u53d1\u5e03\u5417\uff1f</li> <li>\u573a\u666f 4\uff1a\u7ebf\u4e0a\u9047\u5230\u67d0\u4e2a\u7528\u6237\u7684\u6570\u636e\u5904\u7406\u6709\u95ee\u9898\uff0c\u4f46\u7ebf\u4e0a\u540c\u6837\u65e0\u6cd5 debug\uff0c\u7ebf\u4e0b\u65e0\u6cd5\u91cd\u73b0\uff01</li> <li>\u573a\u666f 5\uff1a\u662f\u5426\u6709\u4e00\u4e2a\u5168\u5c40\u89c6\u89d2\u6765\u67e5\u770b\u7cfb\u7edf\u7684\u8fd0\u884c\u72b6\u51b5\uff1f</li> <li>\u573a\u666f 6\uff1a\u6709\u4ec0\u4e48\u529e\u6cd5\u53ef\u4ee5\u76d1\u63a7\u5230 JVM \u7684\u5b9e\u65f6\u8fd0\u884c\u72b6\u6001\uff1f</li> <li>\u573a\u666f 7\uff1a\u600e\u4e48\u5feb\u901f\u5b9a\u4f4d\u5e94\u7528\u7684\u70ed\u70b9\uff0c\u751f\u6210\u706b\u7130\u56fe\uff1f</li> </ul> <p>\u603b\u7ed3\u8d77\u6765\u5c31\u662f\uff0cArthas \u4e0d\u4ec5\u80fd\u89e3\u51b3\u5f00\u53d1\u8005\u65e0\u6cd5\u5bf9\u7ebf\u4e0a\u670d\u52a1\u8fdb\u884c Remote Debug \u7684\u96be\u9898\uff0c\u8fd8\u80fd\u4ee5\u5168\u5c40\u7684\u89c6\u89d2\u8fdb\u884c\u5728\u7ebf\u76d1\u63a7\u8bca\u65ad\u548c\u70ed\u4fee\u590d</p>"},{"location":"chap_apm/1apm_prods/#3-2","title":"3-2 \u5b66\u4e60\u8def\u5f84\uff1a\u547d\u4ee4+\u573a\u666f+\u539f\u7406","text":"<p>Arthas \u76ee\u524d\u5df2\u7ecf\u96c6\u6210\u4e86 41 \u4e2a\u5728\u7ebf\u547d\u4ee4</p> <ul> <li>1.\u901a\u8fc7\u5b9e\u64cd\uff0c\u719f\u6089\u547d\u4ee4</li> </ul> <p>\u6839\u636e\u5b98\u7f51\u7684\u5728\u7ebf\u6559\u7a0b\uff0c\u6309\u7167\u56db\u4e2a\u5206\u7c7b\uff1a\u57fa\u7840\u547d\u4ee4\u3001\u7cfb\u7edf\u547d\u4ee4\u3001\u7c7b\u547d\u4ee4\u548c\u589e\u5f3a\u547d\u4ee4\uff0c\u5c06\u8fd9\u4e9b\u547d\u4ee4\u901a\u901a\u5b9e\u64cd\u4e00\u904d\uff0c\u5bf9 Arthas \u547d\u4ee4\u6709\u4e2a\u5168\u5c40\u7684\u611f\u6027\u8ba4\u77e5\u3002</p> <ul> <li>2.\u6df1\u5165\u573a\u666f\uff0c\u8fdb\u884c\u8bca\u65ad</li> </ul> <p>\u4e0b\u9762\u4fbf\u662f\u6211\u5bf9 Arthas \u5b98\u7f51\u4e0a\u4e03\u5927\u573a\u666f\u7684\u603b\u7ed3\uff0c\u8fd9\u4e03\u4e2a\u573a\u666f\u4e5f\u6700\u80fd\u4f53\u73b0 Arthas \u4ea7\u54c1\u7684\u4ef7\u503c\u3002</p> <p></p>"},{"location":"chap_apm/1apm_prods/#3-3","title":"3-3 \u4e24\u5957\u90e8\u7f72\u65b9\u6848","text":""},{"location":"chap_apm/1apm_prods/#4-alibaba-sentinel","title":"4 Alibaba Sentinel \u65f6\u523b\u5b88\u536b\u6d41\u91cf\u5065\u5eb7","text":"<p>Sentinel \u662f\u963f\u91cc\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u67b6\u6784\u7684\u9ad8\u53ef\u7528\u9632\u62a4\u5de5\u5177\uff0c\u5b83\u4ee5\u6d41\u91cf\u4e3a\u5207\u5165\u70b9\uff0c\u63d0\u4f9b\u6d41\u91cf\u63a7\u5236\u3001\u6d41\u91cf\u5851\u5f62\u3001\u7194\u65ad\u964d\u7ea7\u548c\u8fc7\u8f7d\u4fdd\u62a4\u7b49\u591a\u7ef4\u5ea6\u7684\u9ad8\u53ef\u7528\u4fdd\u969c\u7b56\u7565</p> <p>Sentinel \u4fbf\u5f00\u59cb\u7740\u529b\u751f\u6001\u53d1\u5c55\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1aSentinel \u63d0\u4f9b\u66f4\u591a Java \u5fae\u670d\u52a1\u6846\u67b6\u7684\u5f00\u7bb1\u5373\u7528\u80fd\u529b\uff1b\u540c\u65f6 Sentinel \u4e13\u6ce8 API \u7f51\u5173\u670d\u52a1\uff0c\u8ba9\u5f00\u53d1\u8005\u7684\u9ad8\u53ef\u7528\u914d\u7f6e\u5c3d\u53ef\u80fd\u5730\u6536\u53e3\uff0c\u5e76\u7740\u529b\u4e8e\u62e5\u62b1\u591a\u8bed\u8a00\u751f\u6001\u548c\u4e91\u539f\u751f\u652f\u6301\u7684\u80fd\u529b\u5efa\u8bbe\u3002</p> <p></p> <ul> <li>Java \u5fae\u670d\u52a1\u6846\u67b6\u9002\u914d\uff1a Sentinel \u4e0e\u5176\u4ed6 APM \u7cfb\u7edf\uff08\u5982 SkyWalking\u3001CAT\uff09\u76d1\u63a7\u6846\u67b6\u7684\u5b9e\u73b0\u65b9\u5f0f\u7c7b\u4f3c\uff0c\u901a\u8fc7\u63d2\u4ef6\u5316\u6269\u5c55\u548c\u5b9e\u73b0\u6846\u67b6\u62e6\u622a\u5668\u7684\u65b9\u5f0f\uff0c\u5bf9 Java \u5fae\u670d\u52a1\u7684 Web \u670d\u52a1\u7aef\u3001RPC \u6846\u67b6\u3001HTTP \u5ba2\u6237\u7aef\u3001\u6d88\u606f\u961f\u5217\u7b49\u591a\u4e2a\u65b9\u5411\u7684\u6846\u67b6\u8fdb\u884c\u9002\u914d\u3002<ul> <li>\u5f15\u5165\u76f8\u5e94\u7684\u7ec4\u4ef6\u4f9d\u8d56\uff0c\u5e76\u5b8c\u6210\u7b80\u5355\u7684\u914d\u7f6e\uff0c\u5373\u53ef\u5b8c\u6210\u76f8\u5e94\u7684\u6846\u67b6\u63a5\u5165 Sentinel\u3002\u5982\u4e0a\u56fe\u53f3\u4fa7\u6240\u793a\uff1aSentinel \u9002\u914d\u7684\u6846\u67b6\u6709 Spring\u3001Dubbo\u3001RocketMQ \u7b49 Java \u5fae\u670d\u52a1\u6846\u67b6\u3002</li> </ul> </li> <li>API \u7f51\u5173\u670d\u52a1\uff1a Sentinel \u5bf9\u5f88\u591a\u5e38\u7528\u7684\u7f51\u5173\u670d\u52a1\u8fdb\u884c\u4e86\u9002\u914d\u3002<ul> <li>Sentinel \u8ba4\u4e3a\uff1a\u5728\u6d41\u91cf\u5904\u4e8e\u5165\u53e3\u6216\u662f\u8f6c\u53d1\u65f6\u8fdb\u884c\u9ad8\u53ef\u7528\u9632\u62a4\uff0c\u8981\u6bd4\u6d41\u91cf\u6765\u5230\u5e94\u7528\u670d\u52a1\u540e\u518d\u8fdb\u884c\u6d41\u91cf\u63a7\u5236\uff0c\u6709\u6548\u5f97\u591a\u3002\u5982\u4e0a\u56fe\u5de6\u4fa7\u6240\u793a\uff1aSentinel \u652f\u6301\u7684 API \u7f51\u5173\u7ec4\u4ef6\u6709 ZUUL\u3001Spring Cloud Gateway \u548c Nginx</li> </ul> </li> <li>\u591a\u8bed\u8a00\u652f\u6301\uff1a Sentinel \u5728\u5f00\u6e90\u540e\uff0c\u4e00\u76f4\u5728\u63a2\u7d22\u591a\u8bed\u8a00\u751f\u6001\u6f14\u8fdb\u7684\u8def\u7ebf\u3002<ul> <li>\u5f00\u6e90\u4e4b\u521d\uff0cSentinel \u53ea\u652f\u6301 Java\uff1b\u5f00\u6e90\u540e\uff0c\u793e\u533a\u5927\u529b\u53d1\u5c55\u591a\u8bed\u8a00\u751f\u6001\u3002\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u5df2\u7ecf\u6269\u5c55\u652f\u6301\u4e86 C++ \u548c GO \u8bed\u8a00\u7684\u539f\u751f\u5ba2\u6237\u7aef\u7248\u672c\u3002\u501f\u52a9\u591a\u8bed\u8a00\u7684\u751f\u6001\uff0cSentinel \u8986\u76d6\u4e86\u66f4\u591a\u3001\u66f4\u5e7f\u7684\u573a\u666f\uff0c\u5982 GO \u8bed\u8a00\u7684 Web \u5e94\u7528\u7b49\u3002\u5982\u4e0a\u56fe\u4e2d\u90e8\u6240\u793a\uff1aSentinel \u652f\u6301\u4e86 GO \u8bed\u8a00\u548c\u591a\u79cd\u4e91\u539f\u751f\u4ea7\u54c1</li> </ul> </li> </ul> <p>Sentinel \u4e00\u76f4\u5728\u505a\u4e91\u539f\u751f\u65b9\u5411\u4e0a\u7684\u63a2\u7d22\uff0c\u76ee\u524d\u5df2\u7ecf\u5177\u5907\u652f\u6301 Service Mesh \u9ad8\u53ef\u7528\u7684\u80fd\u529b\uff0c\u5305\u62ec Istio\u3001envoy \u548c\u8682\u8681 MOSN \u7b49\u67b6\u6784\u7684\u539f\u751f\u6d41\u63a7\u652f\u6301\uff0c\u672a\u6765\u4f1a\u5bf9\u4e91\u539f\u751f\u8fdb\u884c\u66f4\u591a\u573a\u666f\u843d\u5730\uff0c\u6bd4\u5982 kubernetes \u5e73\u53f0\u6574\u5408\u7b49\u3002</p>"},{"location":"chap_apm/1apm_prods/#1","title":"1.\u6280\u672f\u9aa8\u67b6\u56fe\uff0c\u6df1\u5165\u8bbe\u8ba1\u539f\u7406","text":""},{"location":"chap_apm/1apm_prods/#2-treenodebuilder-cluster-node-builder","title":"2 \u6784\u5efa\u8c03\u7528\u6811\uff08TreeNodeBuilder \u548c Cluster NODE Builder\uff09","text":"<p>\u89c4\u5219\u63a7\u5236\uff08Action\uff09</p> <p></p>"},{"location":"chap_apm/1apm_prods/#3","title":"3 \u670d\u52a1\u8282\u70b9\u5f15\u5165","text":"<ul> <li> <p>\u5bf9\u4e8e\u5ba2\u6237\u7aef\uff0c\u6211\u4eec\u5c06\u7edf\u4e00\u7684\u57fa\u5efa\u811a\u624b\u67b6\u4e2d\u5f15\u5165 Sentinel \u5ba2\u6237\u7aef\uff0c\u5373\u53ef\u5b8c\u6210\u90e8\u7f72\u3002\u5982\u679c\u5e94\u7528\u670d\u52a1\u6ca1\u6709\u811a\u624b\u67b6\u57fa\u5efa\uff0c\u7f51\u5173\u7684\u5e94\u7528\u670d\u52a1\u5f15\u5165 Sentinel \u5ba2\u6237\u7aef\u53ef\u4ee5\u4f18\u5148\u4e8e\u4e1a\u52a1\u7684\u5e94\u7528\u670d\u52a1\u3002</p> </li> <li> <p>\u5bf9\u4e8e\u670d\u52a1\u7aef\uff0c\u6211\u4eec\u9700\u8981\u5bf9 Sentinel \u5f15\u5165\u52a8\u6001\u6570\u636e\u6e90\uff0c\u89e3\u51b3\u5e94\u7528\u670d\u52a1\u91cd\u542f\u540e\uff0c\u89c4\u5219\u4e22\u5931\u7684\u95ee\u9898\u3002Sentinel \u5df2\u7ecf\u9002\u914d\u4e86\u6240\u6709\u5e38\u89c1\u7684\u52a8\u6001\u6570\u636e\u6e90\u7ec4\u4ef6\uff0c\u4f60\u53ef\u4ee5\u56e0\u5730\u5236\u5b9c\u5730\u9009\u62e9\u5176\u4e00\u8fdb\u884c\u90e8\u7f72\u3002\u4f8b\u5982\uff0c\u4f01\u4e1a\u5185\u90e8\u4f7f\u7528 Apollo \u89e3\u51b3\u4e86\u5206\u5e03\u5f0f\u914d\u7f6e\u7edf\u4e00\u7ba1\u7406\u7684\u95ee\u9898\uff0c\u90a3 Sentinel \u52a8\u6001\u6570\u636e\u6e90\u53ef\u4ee5\u4f7f\u7528sentinel-datasource-apollo\u7ec4\u4ef6\u5b8c\u6210 Sentinel \u670d\u52a1\u7aef\u7684\u52a8\u6001\u6570\u636e\u6e90\u3002</p> </li> </ul>"},{"location":"chap_apm/1apm_prods/#4-java-visualvm","title":"4 \u6545\u969c\u5b9a\u4f4d\uff1aJava VisualVM","text":"<p>Java VisualVM\uff08All-in-One Java Troubleshooting Tool\uff09\uff0cVisualVM \u662f\u7b2c\u4e00\u6b3e\u96c6\u6210\u4e86Java \u547d\u4ee4\u884c\u5de5\u5177\u548c\u652f\u6301\u5b9e\u65f6\u5728\u7ebf\u95ee\u9898\u5206\u6790\u7684\u8f7b\u91cf\u7ea7\u53ef\u89c6\u5316\u5de5\u5177\uff0c\u4f5c\u4e3a Oracle Java 6 \u7684\u4e00\u90e8\u5206\u5bf9\u5916\u53d1\u5e03\u3002</p>"},{"location":"chap_apm/1apm_prods/#1_1","title":"1.\u64cd\u4f5c\u6743\u9650","text":"<p>VisualVM \u4e0d\u652f\u6301\u591a\u7528\u6237-\u89d2\u8272\u6a21\u5f0f\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5c3d\u53ef\u80fd\u7f29\u5c0f\u4f7f\u7528 VisualVM \u64cd\u4f5c\u5e94\u7528\u670d\u52a1\u7684\u4eba\u5458\u8303\u56f4\u3002</p> <p>\u52a8\u6001\u7ba1\u7406\u4ea7\u54c1\u6811\u4e0a\u6bcf\u4e2a\u5e94\u7528\u670d\u52a1\u8282\u70b9\u4e0a\u7684\u5f52\u5c5e\u6210\u5458\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0 VisualVM \u5de5\u5177\u6743\u9650\u7684\u7edf\u4e00\u7ba1\u7406\u3002\u4f7f\u7528\u4ea7\u54c1\u6811\u5bf9\u6240\u6709 APM \u5de5\u5177\u7684\u4f7f\u7528\u6743\u9650\u8fdb\u884c\u6536\u53e3\uff0c\u5728\u56e2\u961f\u6108\u53d1\u58ee\u5927\u65f6\uff0c\u6536\u76ca\u4e5f\u4f1a\u8d8a\u6765\u8d8a\u5927\u3002</p>"},{"location":"chap_apm/1apm_prods/#2","title":"2.\u5b89\u5168\u9650\u5236","text":"<p>JMX\uff08Java Management Extensions\uff09</p> <p>JMX \u662f\u4e00\u4e2a\u89c4\u8303\uff0c\u5b83\u5b9e\u73b0\u4e86 Java \u8fdc\u7a0b\u76d1\u63a7\u7ba1\u7406\u7684\u63a5\u53e3\u3002</p>"},{"location":"chap_apm/1apm_prods/#3-visualvm","title":"3 VisualVM \u56db\u4e2a\u9009\u9879\u5361\u90fd\u6709\u54ea\u4e9b\u80fd\u529b\uff1f","text":"<ul> <li> <p>\u6982\u8ff0\uff1a\u6b64\u754c\u9762\u5c55\u793a\u8fdb\u7a0b\u76f8\u5173\u7684\u6982\u89c8\u4fe1\u606f\u3001JVM \u53c2\u6570\u548c\u7cfb\u7edf\u5c5e\u6027\u3002\u56e0\u4e3a\u4f01\u4e1a\u4e2d\u5f00\u53d1\u4eba\u5458\u662f\u65e0\u6cd5\u76f4\u89c2\u67e5\u770b\u7ebf\u4e0a\u914d\u7f6e\uff0c\u6240\u4ee5\u6982\u8ff0\u9009\u9879\u5361\u5f88\u597d\u5730\u5c55\u793a\u8fdb\u7a0b\u4f7f\u7528\u7684\u7ebf\u4e0a\u73af\u5883\u4fe1\u606f\uff0c\u53ef\u4ee5\u8ba9\u6211\u4eec\u5feb\u901f\u786e\u5b9a\u662f\u5426\u662f\u73af\u5883\u95ee\u9898\u9020\u6210\u7684\u7ebf\u4e0a\u95ee\u9898\u3002</p> </li> <li> <p>\u76d1\u89c6\uff1a\u6b64\u754c\u9762\u5c55\u793a\u5b9e\u65f6\u7684 CPU \u4f7f\u7528\u60c5\u51b5\u3001JVM \u5806\u4fe1\u606f\uff0c\u4ee5\u53ca Java 8 \u7684\u5143\u7a7a\u95f4\u4fe1\u606f\u3001\u7c7b\u52a0\u8f7d\u60c5\u51b5\u3001\u8fdb\u7a0b\u4e2d\u7684\u7ebf\u7a0b\u60c5\u51b5\u3002\u6b64\u9875\u9762\u7684\u76d1\u89c6\u6570\u636e\u4e0d\u652f\u6301\u8ffd\u6eaf\u5386\u53f2\uff0c\u6240\u4ee5\u8ffd\u6eaf\u5386\u53f2\u53ef\u4ee5\u4f7f\u7528 CAT \u7b49 APM \u5de5\u5177\u89e3\u51b3\u3002\u76d1\u89c6\u754c\u9762\u7684\u6267\u884c GC\u3001\u5806 Dump \u53ef\u4ee5\u4ee5\u6700\u5feb\u901f\u5ea6\u8fdb\u884c\u73b0\u573a\u4fdd\u7559\u3002</p> </li> <li> <p>\u7ebf\u7a0b\uff1a\u6b64\u9875\u754c\u9762\u5c55\u793a\u5b9e\u65f6\u8fd0\u884c\u7684\u5404\u4e2a\u7ebf\u7a0b\u60c5\u51b5\uff0c\u4e3b\u8981\u5305\u62ec\u7ebf\u7a0b\u5728\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u8fd0\u884c\u72b6\u51b5\uff0c\u901a\u8fc7\u4e0d\u540c\u989c\u8272\u7684\u6807\u8bc6\u7ebf\u7a0b\u5206\u522b\u5904\u4e8e\u7684 5 \u79cd\u5e38\u89c1\u72b6\u6001\uff1a\u8fd0\u884c\u3001\u4f11\u7720\u3001\u7b49\u5f85\u3001\u9a7b\u7559\u3001\u76d1\u89c6\uff1b\u53f3\u4e0a\u89d2\u201c\u7ebf\u7a0b Dump\u201d\u6309\u94ae\uff0c\u53ef\u4ee5\u5bf9\u7ebf\u7a0b\u8fdb\u884c\u5feb\u7167\u64cd\u4f5c\u3002</p> </li> <li> <p>\u62bd\u6837\u5668\uff1a\u6b64\u754c\u9762\u5bf9\u8fdb\u7a0b\u4f7f\u7528\u7684 CPU \u548c\u5185\u5b58\u8fdb\u884c\u91c7\u6837\uff0c\u8fdb\u884c\u6027\u80fd\u5206\u6790\u3002CPU \u62bd\u6837\uff0c\u901a\u8fc7\u65b9\u6cd5\u7684\u89c6\u89d2\uff0c\u67e5\u770b\u65b9\u6cd5\u5360\u7528 CPU \u7684\u60c5\u51b5\uff1b\u5185\u5b58\u62bd\u6837\uff0c\u901a\u8fc7\u7c7b\u540d\u5f52\u7c7b\u548c\u7ebf\u7a0b\u4f7f\u7528\u5185\u5b58\u7684\u89c6\u89d2\uff0c\u8fdb\u884c\u5185\u5b58\u5206\u914d\u7684\u8c03\u4f18\u3002</p> </li> </ul>"},{"location":"chap_apm/1apm_prods/#4-visualvm","title":"4 VisualVM \u7684\u63d2\u4ef6\u4f53\u7cfb","text":"<ul> <li>\u5bf9\u4e8e\u4f7f\u7528 Java 8 \u7684\u7528\u6237\uff0cVisualVM \u5df2\u7ecf\u5728 JDK \u7684 bin \u76ee\u5f55\u4e2d\u4e86\u3002\u4f46\u5f53\u4f60\u6253\u5f00\u63d2\u4ef6\u4ed3\u5e93\uff0c\u4f1a\u53d1\u73b0\u6ca1\u6709\u53ef\u4ee5\u5b89\u88c5\u7684\u63d2\u4ef6\uff0c\u662f\u56e0\u4e3a\u63d2\u4ef6\u7684\u5730\u5740\u5df2\u5931\u6548\uff0c\u9700\u8981\u6211\u4eec\u624b\u52a8\u66f4\u65b0\u5b98\u65b9\u7684\u63d2\u4ef6\u4e2d\u5fc3\u5730\u5740\u3002</li> <li>\u5bf9\u4e8e\u4f7f\u7528 Java 11 \u7684\u7528\u6237\uff0cVisualVM \u5728 JDK9 \u540e\uff0c\u5df2\u4e0d\u518d\u4e3a Oracle JDK \u7684\u4e00\u90e8\u5206\uff0c\u6211\u4eec\u9700\u8981\u53bbVisualVM\u5b98\u7f51\u8fdb\u884c\u4e0b\u8f7d\u3002</li> </ul> <p>\u76ee\u524d VisualVM \u5386\u7ecf\u4e86\u5341\u51e0\u5e74\u7684\u53d1\u5c55\uff0c\u603b\u5171\u6709 20 \u4e2a\u591a\u63d2\u4ef6\uff0c\u6839\u636e\u63d2\u4ef6\u7c7b\u578b\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b 8 \u79cd\u3002</p> <ul> <li>Profiling\uff08\u6027\u80fd\u5256\u6790\uff09\uff1aStartup Profiler\u3001BTrace Workbench</li> <li>Sources\uff08\u4ee3\u7801\u8d44\u6e90\uff09\uff1aVisualVM-GoToSource</li> <li>Tools\uff08\u5de5\u5177\uff09\uff1aThreads Inspector\u3001VisualVM-JConsole\u3001VisualVM-BufferMonitor\u3001VisualVM-TDA-Module\u3001KillApplication\u3001VisualVM-Coherence\u3001Visual GC\u3001VisualVM-MBeans</li> <li>Platform\uff08\u76d1\u63a7\uff09\uff1aVisualVM-Extensions</li> <li>Security\uff08\u5b89\u5168\uff09\uff1aVisualVM-Security</li> <li>Tracer\uff08\u8ffd\u8e2a\uff09\uff1aTracer-Monitor Probes\u3001Tracer-Collections Probes\u3001Tracer-JavaFX Probes\u3001Tracer-IO Probes\u3001Tracer-Swing Probes\u3001Tracer-Jvmstat Probes\u3001Tracer-JVM Probes</li> <li>UI\uff08\u9875\u9762\u589e\u5f3a\uff09\uff1aOQL Syntax Support</li> <li>Libraries\uff08\u7c7b\u5e93\uff09\uff1aGraalJS</li> </ul> <p>\u6bd4\u5982\uff1aStartup Profiler\u63d2\u4ef6\u662f\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u542f\u52a8\u9636\u6bb5\u8fdb\u884c\u5256\u6790\u7684\u5de5\u5177\uff1bGoToSource \u63d2\u4ef6\u662f\u652f\u6301\u6e90\u4ee3\u7801\u5bfc\u822a\u548c\u5c55\u793a\u3002</p>"},{"location":"chap_apm/1apm_prods/#4-kibana","title":"4 \u65e5\u5fd7\u53ef\u89c6\u5316\uff1aKibana","text":"<p>ELK \u662f Elastic \u516c\u53f8\u7684\u4e09\u4e2a\u5f00\u6e90\u9879\u76ee\u7684\u7f29\u5199\uff0c\u8fd9\u4e09\u4e2a\u9879\u76ee\u5206\u522b\u5982\u4e0b\u3002</p> <ul> <li>Elasticsearch\uff1a\u57fa\u4e8e Apache Lucene \u641c\u7d22\u5f15\u64ce\uff0c\u4f7f\u7528 RESTful \u63a5\u53e3\u5c4f\u853d\u4e86\u641c\u7d22\u67b6\u6784\u7684\u590d\u6742\u6027\u3002</li> <li>Logstash\uff1a\u670d\u52a1\u5668\u6570\u636e\u5904\u7406\u7ba1\u9053\u3002</li> <li>Kibana\uff1aElasticsearch \u641c\u7d22\u5f15\u64ce\u7684\u53ef\u89c6\u5316\u5e73\u53f0\u3002</li> </ul>"},{"location":"chap_apm/1apm_prods/#1_2","title":"1 \u91cd\u65b0\u8ba4\u8bc6\u65e5\u5fd7","text":"<p>\u5f53\u4e0b\u7684\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\u90fd\u662f\u5c06\u65e5\u5fd7\u4fe1\u606f\u59d4\u6258\u7ed9\u65e5\u5fd7\u6846\u67b6\u8fdb\u884c\u6253\u5370\uff0c\u6240\u4ee5\u65e5\u5fd7\u5185\u5bb9\u53ef\u4ee5\u5206\u4e3a\u4e24\u7c7b\uff1a</p> <ul> <li>\u65e5\u5fd7\u6846\u67b6\u6253\u5370\u7684\u65e5\u5fd7\u4fe1\u606f</li> <li>\u4e00\u7ebf\u5f00\u53d1\u4eba\u5458\u6253\u5370\u7684\u65e5\u5fd7\u4fe1\u606f</li> </ul> <p>\u9664\u4e86\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\u901a\u8fc7\u65e5\u5fd7\u6846\u67b6\u6253\u5370\u4e1a\u52a1\u65e5\u5fd7\u5916\uff0c\u5728\u6846\u67b6\u5c42\u9762\u8fd8\u6709\u6846\u67b6\u65e5\u5fd7\u3002</p> <p>\u5176\u4e2d\u65e5\u5fd7\u6846\u67b6\u6253\u5370\u7684\u4fe1\u606f\uff0c\u5e38\u7528\u7684\u5c5e\u6027\u5982\u4e0b\u3002</p> <ul> <li>\u65f6\u95f4\u6233\uff1a\u8c03\u7528\u65e5\u5fd7\u65b9\u6cd5\u65f6\u751f\u6210\u65f6\u95f4\u6233\uff0c\u89e3\u51b3\u5f02\u6b65\u6253\u5370\u3001\u5f02\u6b65\u6536\u96c6\u9020\u6210\u7684\u65f6\u95f4\u4e0d\u7cbe\u51c6\u95ee\u9898\u3002</li> <li>\u7ebf\u7a0b\u540d\u79f0\uff1a\u7531\u4e8e\u7ebf\u7a0b ID \u4e0d\u76f4\u89c2\uff0c\u6240\u4ee5\u901a\u5e38\u4f7f\u7528\u7ebf\u7a0b\u540d\u79f0\u6765\u6807\u8bc6\u7ebf\u7a0b\uff08\u6ce8\u610f\u4e0d\u53ef\u4ee5\u4f7f\u7528\u9ed8\u8ba4\u7ebf\u7a0b\u540d\u79f0\uff0c\u9700\u8981\u6839\u636e\u4f7f\u7528\u7ebf\u7a0b\u60c5\u51b5\u6765\u91cd\u547d\u540d\u7ebf\u7a0b\u540d\u79f0\uff09\u3002</li> <li>\u65e5\u5fd7\u7ea7\u522b\uff1a\u6839\u636e\u65e5\u5fd7\u7ea7\u522b\u7684\u4e0d\u540c\uff0c\u53ef\u7c97\u7565\u5730\u5bf9\u65e5\u5fd7\u8fdb\u884c\u9884\u5904\u7406\u3002\u6bd4\u5982 DEBUG\u3001TRACE \u7ea7\u522b\u7684\u65e5\u5fd7\u53ea\u6709\u5728\u5b9a\u4f4d\u95ee\u9898\u65f6\u624d\u8bb0\u5f55\uff1b\u5f53\u65e5\u5fd7\u4e3a ERROR \u7ea7\u522b\u65f6\uff0c\u7acb\u523b\u53d1\u51fa\u544a\u8b66\u3002</li> <li>\u8c03\u7528\u4f4d\u7f6e\uff1a\u8bb0\u5f55\u6253\u5370\u65e5\u5fd7\u7684\u7c7b\u540d\u548c\u884c\u53f7\uff0c\u6709\u52a9\u4e8e\u5f00\u53d1\u4eba\u5458\u5feb\u901f\u5bfb\u627e\u6e90\u4ee3\u7801\u7684\u4e0a\u4e0b\u6587\u73b0\u573a\u3002</li> <li>\u589e\u5f3a\u5c5e\u6027\uff1a\u5982\u5168\u94fe\u8def\u8ddf\u8e2a ID\uff0c\u7528\u4e8e\u8ffd\u6eaf\u5f15\u8d77\u65e5\u5fd7\u6253\u5370\u7684\u4e0a\u4e0b\u6e38\u3002</li> </ul>"},{"location":"chap_apm/1apm_prods/#2-kibana","title":"2 Kibana \u63a2\u7d22\u548c\u5206\u6790\u65e5\u5fd7","text":"<ul> <li>\u7b2c\u4e00\u79cd\uff1a\u901a\u8fc7 Kibana \u63a2\u7d22\uff08Discovery\uff09\u529f\u80fd\uff0c\u8fdb\u884c\u51c6\u786e\u3001\u5b9e\u65f6\u7684\u96c6\u4e2d\u65e5\u5fd7\u641c\u7d22\u3002</li> <li>\u7b2c\u4e8c\u79cd\uff1a\u521b\u5efa\u591a\u6837\u7684\u53ef\u89c6\u5316\u89c6\u56fe\uff08Visualize\uff09\uff0c\u5c06\u76f8\u5173\u8054\u7684\u89c6\u56fe\u7ec4\u5408\u6210\u4eea\u8868\u76d8\uff08Dashboard\uff09\u3002</li> <li>\u7b2c\u4e09\u79cd\uff1a\u901a\u8fc7 Elasticsearch SQL \u76f4\u63a5\u4ece Elasticsearch \u4e2d\u63d0\u53d6\u6570\u636e\uff0c\u52a0\u4e0a\u4e30\u5bcc\u5143\u7d20\u5e03\u5c40\u7ed8\u5236\u753b\u5e03\uff08Canvas\uff09\u3002</li> </ul> <p>\u4f7f\u7528\u65b9\u5f0f\u90fd\u662f\u5fc5\u987b\u57fa\u4e8e\u521b\u5efa\u7d22\u5f15\u6a21\u5f0f\uff08index pattern\uff09</p> <ul> <li>1.\u521b\u5efa\u7d22\u5f15\u6a21\u5f0f</li> </ul> <p>\u7d22\u5f15\u6a21\u5f0f\u544a\u8bc9 Kibana \u54ea\u4e9b Elasticsearch \u7d22\u5f15\u5305\u542b\u4e86\u4f60\u60f3\u5904\u7406\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u521b\u5efa\u7d22\u5f15\u6a21\u5f0f\u6709\u591a\u79cd\u65b9\u5f0f\uff0c\u6700\u5e38\u89c1\u7684\u5c31\u662f\u4f7f\u7528\u540e\u7f6e\u901a\u914d\u7b26\u3002</p> <p>\u5728\u5355\u4e2a Elasticsearch \u96c6\u7fa4\u5185\u90e8\u5b8c\u6210\u7d22\u5f15\u6a21\u5f0f\u7684\u521b\u5efa\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u96c6\u7fa4\u5185\u90e8\u6709\u591a\u4e2a\u4ee5\u201c\u5929\u201d\u4e3a\u5207\u5206\u7ef4\u5ea6\u7684\u65e5\u5fd7\u7d22\u5f15\u3002\u5982 <code>data_logs-20210307</code>\u3001<code>data_logs-20210306</code>\u3001d<code>ata_logs-20210305</code> \u7b49\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>data_logs-*</code> \u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u5b8c\u6210\u7d22\u5f15\u7684\u5339\u914d\u3002</p> <ul> <li> <p>2.\u63a2\u7d22\u65e5\u5fd7</p> <ul> <li>\u641c\u7d22\u6761\u4ef6\uff1a\u7f51\u7ad9\u8bf7\u6c42\u975e\u6b63\u5e38\u8fd4\u56de\uff08HTTP \u72b6\u6001\u7801\u975e 200\uff09\uff0c\u4e14\u5730\u57df\u4e3a\u4e2d\u56fd\u6d41\u91cf\u3002</li> <li>\u7ed3\u679c\u8fc7\u6ee4\uff1a\u7531\u4e8e\u65e5\u5fd7\u5c5e\u6027\u8f83\u591a\uff0c\u5b9e\u73b0\u53ea\u8fd4\u56de IP \u5730\u5740\u3001\u673a\u5668\u8bbe\u5907\u548c\u8bf7\u6c42\u7684 host\u3002</li> <li>\u65f6\u95f4\u8303\u56f4\uff1a\u6700\u8fd1\u4e03\u5929\u3002</li> </ul> </li> <li> <p>3.\u5236\u4f5c\u591a\u6837\u7684\u53ef\u89c6\u5316\u89c6\u56fe</p> </li> </ul> <p></p> <ul> <li>4.\u6784\u5efa\u4eea\u8868\u76d8</li> </ul> <p>\u4eea\u8868\u76d8\u662f\u76f8\u5173\u53ef\u89c6\u5316\u89c6\u56fe\u7684\u96c6\u5408\uff0c\u8fdb\u5165\u4eea\u8868\u76d8\u7684\u7f16\u8f91\u6a21\u5f0f\uff0c\u5f15\u5165\u76f8\u5173\u4e3b\u9898\u7684\u53ef\u89c6\u5316\u89c6\u56fe\u3002\u7136\u540e\u5bf9\u53ef\u89c6\u5316\u89c6\u56fe\u8fdb\u884c\u5c55\u793a\u5e03\u5c40\u8c03\u6574\uff0c\u5c31\u5b8c\u6210\u4e86\u4eea\u8868\u76d8\u7684\u521b\u5efa\u3002</p> <ul> <li> <p>5.\u7ed8\u5236\u753b\u5e03</p> <ul> <li>\u521b\u5efa\u7a7a\u767d\u5de5\u4f5c\u533a\u57df\uff08workpad\uff09</li> <li>\u9009\u62e9\u5143\u7d20\uff0c\u8bbe\u7f6e\u5143\u7d20\u7684\u989c\u8272\u3001\u56fe\u50cf\u548c\u6570\u636e</li> <li>\u6307\u5b9a\u5143\u7d20\u7684\u5c3a\u5bf8\u548c\u8c03\u6574\u5e03\u5c40</li> <li>\u4fdd\u5b58\u753b\u5e03\u7684\u6f14\u793a\u5e03\u5c40</li> </ul> </li> </ul> <p></p>"},{"location":"chap_apm/1apm_prods/#5-grafana","title":"5 \u591a\u6570\u636e\u6e90\u8ba9 Grafana \u76d1\u63a7\u62a5\u8b66\u66f4\u9ad8\u6548","text":""},{"location":"chap_apm/1apm_prods/#5-1-grafana","title":"5-1 Grafana \u7684\u6838\u5fc3\u8bbe\u8ba1","text":"<ul> <li>Zabbix</li> </ul> <p>\u4f46\u5f53\u4e0b\u5bf9\u7269\u7406\u8282\u70b9\u7684\u76d1\u63a7\u8bc9\u6c42\u8fd8\u662f\u5f88\u9700\u8981\u7684\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u5c06\u8bb2\u8ff0 Grafana \u5982\u4f55\u901a\u8fc7\u63d2\u4ef6\u751f\u6001\uff0c\u96c6\u6210 Zabbix \u6570\u636e\u6e90\uff0c\u5b8c\u6210\u5bf9\u7269\u7406\u8282\u70b9\u7684\u6027\u80fd\u6307\u6807\u76d1\u63a7\u3002</p> <p>Zabbix \u662f\u76d1\u63a7\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u5176\u5177\u5907\u7269\u7406\u673a\u6027\u80fd\u76d1\u63a7\u548c\u5bf9\u7f51\u7edc\u72b6\u51b5\u7684\u76d1\u63a7\u3002\u4f7f\u7528\u5ba2\u6237\u7aef\u3001\u670d\u52a1\u7aef\u6a21\u5f0f\u8fdb\u884c\u6536\u96c6\u6570\u636e\uff0c\u5373\u7269\u7406\u673a\u5b89\u88c5 Zabbix Agent \u5ba2\u6237\u7aef\u91c7\u96c6\u6570\u636e\u4f20\u9001\u7ed9\u670d\u52a1\u7aef\uff0c\u901a\u8fc7 web \u670d\u52a1\u76f4\u63a5\u5bf9\u63a5\u670d\u52a1\u7aef\u5b8c\u6210\u5c55\u793a\u3002\u7531\u4e8e Zabbix web \u5c55\u793a\u76d1\u63a7\u6570\u636e\u4e0d\u7406\u60f3\uff0c\u6240\u4ee5\u89e3\u51b3\u65b9\u6848\u662f\u901a\u8fc7 Grafana \u96c6\u6210 Zabbix \u6570\u636e\u6e90\u5b8c\u6210\u76d1\u63a7\u6570\u636e\u7684\u5c55\u793a\u3002</p> <p>Zabbix \u6570\u636e\u6e90\u5c5e\u4e8e\u975e\u5b98\u65b9\u652f\u6301\u7684\u6570\u636e\u6e90\uff0c\u9700\u8981\u4ece\u5f00\u653e\u7684\u63d2\u4ef6\u751f\u6001\u5f15\u5165\uff0c\u91cd\u542f Grafana \u670d\u52a1\u540e\uff0c\u5373\u53ef\u5728\u6570\u636e\u6e90\u4e2d\u770b\u5230 Zabbix \u6570\u636e\u6e90\u3002</p> <ul> <li>\u591a\u7ef4\u5ea6\u62a5\u8b66</li> </ul> <p>\u76f8\u8f83\u4e8e Kibana \u9700\u8981\u5c06\u7528\u6237\u5347\u7ea7\u4e3a\u9ec4\u91d1\u7528\u6237\u4ee5\u4e0a\u7ea7\u522b\u624d\u652f\u6301\u62a5\u8b66\u529f\u80fd\uff0cGrafana \u62a5\u8b66\u529f\u80fd\u662f\u5b8c\u5168\u5f00\u653e\u7684\uff0c\u53ea\u8981\u5c06 Grafana \u5347\u7ea7\u5230 4.0 \u7248\u672c\u4ee5\u4e0a\u5373\u53ef\u3002</p> <p>\u5728\u62a5\u8b66\u914d\u7f6e\u754c\u9762\uff0c\u53ef\u4ee5\u5c06\u62a5\u8b66\u4fe1\u606f\u53d1\u9001\u81f3\u804a\u5929\u5de5\u5177 Slack\u3001\u4e8b\u4ef6\u7ba1\u7406\u5e73\u53f0 PagerDuty \u7b49\u5728 Github \u4e3b\u6d41\u7684\u62a5\u8b66\u5a92\u4ecb\uff1b\u4e5f\u53ef\u4ee5\u6309\u7167\u4f01\u4e1a\u5fae\u4fe1\u548c\u9489\u9489\u7684 API \u5f00\u53d1\u6587\u6863\uff0c\u5bf9\u63a5\u56fd\u5185\u4e3b\u6d41\u529e\u516c\u5e73\u53f0\u3002\u901a\u8fc7\u914d\u7f6e\u62a5\u8b66\u5a92\u4ecb\u5e76\u96c6\u6210\u76d1\u63a7\u6570\u636e\u6e90\u540e\uff0c\u4fbf\u80fd\u4f9d\u636e\u53ef\u89c6\u5316\u9762\u677f\u7684\u6307\u6807\u914d\u7f6e\u62a5\u8b66\u7684\u89c4\u5219\u4e86\u3002</p> <p>Grafana\u62a5\u8b66\u89c4\u5219\u7684\u8bbe\u8ba1\u662f\u901a\u8fc7\u540e\u53f0\u7684\u4e00\u4e2a\u8c03\u5ea6\u7a0b\u5e8f\uff0c\u5b9a\u65f6\u5730\u901a\u8fc7\u67e5\u8be2\u5f15\u64ce\u8bc6\u522b\u51fa\u5f53\u524d\u53ef\u89c6\u5316\u9762\u677f\u4e2d\u7684\u6307\u6807\u662f\u5426\u89e6\u53ca\u62a5\u8b66\u89c4\u5219\u3002\u5982\u679c\u89e6\u53ca\uff0c\u5219\u8c03\u7528\u62a5\u8b66\u5a92\u4ecb\u4e0b\u8fbe\u62a5\u8b66\u901a\u77e5\u3002</p> <p>\u7531\u4e8e Grafana \u662f\u53ef\u89c6\u5316\u5e73\u53f0\uff0c\u76d1\u63a7\u6570\u636e\u7684\u83b7\u53d6\u65b9\u5f0f\u53ef\u89c6\u4f5c\u4e3a\u201c\u62c9\u6a21\u5f0f\u201d\uff0c\u4e14\u62a5\u8b66\u8bbe\u8ba1\u901a\u8fc7\u540e\u53f0\u8c03\u5ea6\u7a0b\u5e8f\u5b8c\u6210\uff0c\u6240\u4ee5\u6b64\u65b9\u6848\u7684\u8bbe\u8ba1\u6765\u62a5\u8b66\u4f1a\u7a0d\u8bb8\u6ede\u540e\u3002</p>"},{"location":"chap_apm/1apm_prods/#grafana","title":"\u5e94\u7528\u670d\u52a1\u914d\u7f6e Grafana \u6307\u6807","text":"<p>1.\u7528\u6237\u884c\u4e3a\u76d1\u63a7</p> <p>1\uff09\u7528\u6237\u751f\u547d\u5468\u671f\u76d1\u63a7</p> <p>\u5e38\u89c1\u751f\u547d\u5468\u671f\u5206\u4e3a\u5982\u4e0b\u56fe\u7684 5 \u5c42\uff0c\u4ece\u7528\u6237\u63a5\u89e6\u4ea7\u54c1\u5230\u9057\u5fd8\u4ea7\u54c1\u7684\u6574\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u76d1\u63a7\u5206\u6790\u7528\u6237\u5728\u4e0d\u540c\u9636\u6bb5\u7684\u8868\u73b0\uff0c\u6709\u7684\u653e\u77e2\u5730\u4f18\u5316\u4ea7\u54c1\u4f53\u9a8c\uff0c\u5f15\u5bfc\u7528\u6237\u5b8c\u6210\u8fd0\u8425\u7b56\u7565\u3002</p> <p></p> <p>2.\u6838\u5fc3\u573a\u666f\u76d1\u63a7</p> <ul> <li>\u4e1a\u52a1\u573a\u666f\uff1a\u901a\u8fc7\u4e00\u7ec4\u76f8\u5173\u8054\u7684\u6570\u636e\u6216\u4e8b\u4ef6\uff0c\u6765\u53cd\u6620\u81ea\u7136\u8bed\u8a00\u63cf\u8ff0\u7684\u4e1a\u52a1\u573a\u666f\u3002</li> <li>\u4e1a\u52a1\u5047\u8bbe\uff1a\u901a\u8fc7\u4e1a\u52a1\u573a\u666f\u53ef\u80fd\u5728\u672a\u6765\u53d1\u751f\u7684\u4e8b\u60c5\u505a\u4e00\u7cfb\u5217\u7684\u4e1a\u52a1\u5047\u8bbe\u3002</li> <li>\u76d1\u63a7\u65b9\u6848\uff1a\u4ee5\u4e1a\u52a1\u573a\u666f\u7684\u6570\u636e\u6307\u6807\u4e3a\u4f9d\u636e\uff0c\u76d1\u63a7\u4e1a\u52a1\u5047\u8bbe\u662f\u5426\u6210\u7acb\u3002</li> <li>\u5173\u952e\u4e3e\u63aa\uff1a\u5f53\u5047\u8bbe\u6210\u7acb\u65f6\uff0c\u542f\u52a8\u4e00\u4e9b\u5e94\u6025\u4e3e\u63aa\u3002</li> </ul> <p></p> <ul> <li>1.\u9884\u9632\u62d6\u57ae\u6838\u5fc3\u8d44\u6e90</li> <li>2.\u7528\u6237\u6743\u9650\u9694\u79bb</li> </ul>"},{"location":"chap_apm/1apm_prods/#6-apm","title":"6 \u719f\u6089 APM \u4ea7\u54c1","text":"<p>APM \u662f\u5e94\u7528\u6027\u80fd\u7ba1\u7406\uff08Application Performance Management\uff09\u7684\u7f29\u5199\u3002\u4ece\u5b8f\u89c2\u89d2\u5ea6\u4e0a\u770b\uff0c\u9762\u5411\u89e3\u51b3\u4ea7\u54c1\uff08\u5bf9\u7528\u6237\uff09\u4f53\u9a8c\u4e0d\u597d\u7684\u884c\u4e3a\uff0c\u90fd\u53ef\u4ee5\u79f0\u4e3a APM\uff0c\u56e0\u6b64 APM \u6d89\u53ca\u7684\u8303\u7574\u975e\u5e38\u5e7f\u6cdb</p> <p></p>"},{"location":"chap_apm/1apm_prods/#apache-skywalking","title":"Apache SkyWalking","text":"<ul> <li>\u901a\u8fc7\u94fe\u8def\u8ffd\u8e2a\u9875\u9762\u83b7\u53d6\u6162\u94fe\u8def\u7684 Endpoint\uff1b</li> <li>\u518d\u901a\u8fc7\u6027\u80fd\u5256\u6790\u9875\u9762\u4e0a\u7684\u8f93\u5165\u6846\uff0c\u63cf\u8ff0\u4f60\u8981\u5256\u6790\u7684 Endpoint\uff1b</li> <li>\u6700\u540e SkyWalking \u4f1a\u901a\u8fc7\u62bd\u6837\u5c55\u793a\u8fd9\u4e2a Endpoint \u5173\u8054\u7684\u7ebf\u7a0b\u5806\u6808\u4fe1\u606f</li> </ul>"},{"location":"chap_apm/1apm_prods/#alibaba-arthas","title":"Alibaba Arthas","text":"<ul> <li>\u901a\u8fc7\u65e5\u5fd7\u4e0a\u7684\u6570\u636e\u9762\u677f\uff08dashboard\uff09\u547d\u4ee4\u6216\u7ebf\u7a0b\uff08thread\uff09\u547d\u4ee4\uff0c\u83b7\u53d6\u60f3\u8981 Dump \u7684\u7ebf\u7a0b ID\uff1b</li> <li>\u518d\u901a\u8fc7\u7ebf\u7a0b\u547d\u4ee4\uff0c\u8ffd\u52a0\u7ebf\u7a0b ID \u53c2\u6570\u83b7\u53d6\u7ebf\u7a0b\u7684\u5806\u6808\u4fe1\u606f\uff1b</li> <li>\u6700\u540e\u901a\u8fc7\u5404\u79cd\u5728\u7ebf\u6545\u969c\u6392\u67e5\u547d\u4ee4\uff0c\u4ece\u800c\u53bb\u8bca\u65ad\u95ee\u9898\u3002</li> </ul>"},{"location":"chap_apm/1apm_prods/#java-visualvm","title":"Java VisualVM","text":"<ul> <li>\u901a\u8fc7\u5e94\u7528\u670d\u52a1\u4f7f\u7528\u65e5\u5fd7\u6846\u67b6\u4e2d\u6253\u5370\u7684\u7ebf\u7a0b\u540d\u79f0\uff0c\u6216 VisualVM \u53ef\u89c6\u5316\u5ba2\u6237\u7aef\u7684\u7ebf\u7a0b\u9009\u9879\u5361\u5c55\u793a\u7684\u5e94\u7528\u540d\u79f0\uff0c\u4ece\u800c\u83b7\u53d6\u7ebf\u7a0b\u5b9e\u65f6\u5de5\u4f5c\u72b6\u6001\uff1b</li> <li>\u518d\u901a\u8fc7\u7ebf\u7a0b\u540d\u79f0\uff0c\u4f7f\u7528 Threads intspector \u63d2\u4ef6\u83b7\u53d6\u7ebf\u7a0b\u7684\u5806\u6808\u4fe1\u606f\uff1b</li> <li>\u6700\u540e\u4f7f\u7528\u5404\u79cd\u63d2\u4ef6\u8fdb\u884c\u95ee\u9898\u8bca\u65ad\u3002</li> </ul>"},{"location":"chap_apm/2opentracing/","title":"\u7b2c\u4e8c\u8282 APM + OpenTracing \u539f\u7406","text":""},{"location":"chap_apm/2opentracing/#1-opentracing-dapperskywalking","title":"1 OpenTracing \u89e3\u5bc6: Dapper\u662f\u6811\uff0cSkyWalking\u662f\u56fe","text":""},{"location":"chap_apm/2opentracing/#_1","title":"\u4ec0\u4e48\u662f\u5206\u5e03\u5f0f\u94fe\u8def\u8ddf\u8e2a\uff1f","text":"<p>\u5206\u5e03\u5f0f\u8ffd\u8e2a\u5c31\u662f\u628a\u4e00\u6b21\u7528\u6237\u8bf7\u6c42\u5f15\u8d77\u7684\uff0c\u5728\u5206\u5e03\u5f0f\u96c6\u7fa4\u4e2d\u7684\u76f8\u5173\u65e5\u5fd7\uff0c\u4e32\u8054\u8d77\u6765\u7684\u8fc7\u7a0b\u3002</p> <p>\u5e02\u573a\u4e0a\u6d41\u884c\u7684\u5206\u5e03\u5f0f\u8ffd\u8e2a\u5b9e\u73b0\u662f\uff1a\u901a\u8fc7\u94fe\u8def\u6807\u8bc6\uff0c\u5c06\u4e00\u6b21\u7528\u6237\u8bf7\u6c42\uff0c\u5728\u5206\u5e03\u5f0f\u96c6\u7fa4\u4e2d\u5404\u4e2a\u5e94\u7528\u8282\u70b9\u6253\u5370\u7684\u65e5\u5fd7\u4e32\u8054\u8d77\u6765\u7684\u8fc7\u7a0b\uff0c\u5c31\u662f\u5206\u5e03\u5f0f\u94fe\u8def\u8ddf\u8e2a\u3002</p> <p>\u8ffd\u8e2a\u53c8\u53ef\u4ee5\u7b80\u5355\u5206\u4e3a\u4ee5\u4e0b\u4e24\u79cd\u3002</p> <ul> <li>\u5bf9\u4e8e\u8de8\u8fdb\u7a0b\u7684\u94fe\u8def\u8ffd\u8e2a\u65b9\u6848\uff0c\u6700\u4f18\u7684\u6280\u672f\u65b9\u6848\u662f\u5728\u8fdc\u7a0b\u8c03\u7528\u53d1\u751f\u65f6\uff0c\u901a\u8fc7\u5bf9\u8bf7\u6c42\u534f\u8bae\u589e\u52a0\u94fe\u8def\u6807\u8bc6\uff0c\u5c06\u4e0a\u4e0b\u6e38\u8c03\u7528\u94fe\u7ed1\u5b9a\u8d77\u6765\uff0c\u5c31\u5b9e\u73b0\u4e86\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u7684\u8de8\u8fdb\u7a0b\u8ffd\u8e2a\u3002</li> <li>\u5bf9\u4e8e\u8de8\u7ebf\u7a0b\u7684\u94fe\u8def\u8ffd\u8e2a\u65b9\u6848\uff0c\u5982 Java \u8bed\u8a00\u7684\u5fae\u670d\u52a1\u5e94\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e3b\u7ebf\u7a0b\u521b\u5efa\u5b50\u7ebf\u7a0b\u65f6\uff0c\u5c06\u4e3b\u7ebf\u7a0b\u7684\u94fe\u8def\u6807\u8bc6\u4ee3\u5165\u5b50\u7ebf\u7a0b\uff0c\u5c06\u4e3b-\u5b50\u7ebf\u7a0b\u7ed1\u5b9a\u8d77\u6765\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u8de8\u7ebf\u7a0b\u8ffd\u8e2a</li> </ul> <p>\u76ee\u524d\u4ee5 SkyWalking\u3001Zipkin \u4e3a\u4ee3\u8868\u7684\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf\u5df2\u7ecf\u88ab\u5e7f\u6cdb\u5730\u63a5\u5165\u5230\u7ebf\u4e0a\u5e94\u7528\u670d\u52a1\u4e86</p>"},{"location":"chap_apm/2opentracing/#_2","title":"\u65e9\u671f\u5bf9\u5178\u578b\u8ffd\u8e2a\u573a\u666f\u7684\u8bba\u8ff0","text":"<ul> <li>1.\u6807\u8bb0\u65b9\u6848\uff08\u6709\u4fb5\u5165\u3001\u51c6\u786e\u5ea6\u9ad8\uff09</li> </ul> <p>\u6807\u8bb0\u6cd5\u987e\u540d\u601d\u4e49\uff0c\u5c31\u662f\u5bf9\u5e94\u7528\u76d1\u63a7\u65e5\u5fd7\u6253\u6807\u8bb0\u3002\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u663e\u5f0f\u5730\u5bf9\u65e5\u5fd7\u6253\u6807\u8bb0\uff0c\u6216\u8005\u5728\u6846\u67b6\u62e6\u622a\u5668\u4e2d\u5bf9\u8bf7\u6c42\u8fdb\u884c\u6807\u8bb0\u3002\u901a\u8fc7\u8fd9\u4e9b\u6807\u8bb0\uff0c\u5c06\u4e00\u6b21\u8bf7\u6c42\u5f15\u8d77\u7684\u5e94\u7528\u670d\u52a1\u96c6\u7fa4\u4e2d\u7684\u76d1\u63a7\u65e5\u5fd7\u5168\u90e8\u4e32\u8054\u6c47\u603b\u8d77\u6765\u7684\u8fc7\u7a0b\u5c31\u662f\u6807\u8bb0\u65b9\u6848\u3002</p> <p>Dapper \u6240\u8bba\u8ff0\u7684\u793a\u4f8b</p> <p>\u524d\u53f0\u670d\u52a1 A \u6536\u5230 RequestX \u8bf7\u6c42\uff0cHttp Server \u6846\u67b6\u53d1\u73b0\u8bf7\u6c42\u4e2d\u6ca1\u6709\u6807\u8bb0\uff0c\u90a3\u4e48\u5bf9\u8fd9\u6b21\u6d41\u91cf\u8fdb\u884c\u6807\u8bb0\uff0c\u5e76\u8bc6\u522b\u4e3a\u7528\u6237\u8bf7\u6c42\u8fdb\u884c\u4f20\u64ad\u3002</p> <p>\u5f53\u8bf7\u6c42\u4f20\u64ad\u5230 B\u3001C\u3001D\u3001E\uff0c\u518d\u6253\u5370\u76d1\u63a7\u65e5\u5fd7\u65f6\uff0c\u76d1\u63a7\u65e5\u5fd7\u5c31\u5e26\u7740\u4e0e A \u884d\u751f\u51fa\u6765\u7684\u6807\u8bb0\uff0c\u8fd9\u6837\u8fd9\u6b21\u7528\u6237\u7684\u8bf7\u6c42\u901a\u8fc7 A \u670d\u52a1\u751f\u6210\u7684\u6807\u8bb0\u5c31\u5f88\u5bb9\u6613\u88ab\u6536\u96c6\u8d77\u6765\u4e86\u3002</p> <p></p> <p>\u4e0d\u96be\u770b\u51fa\uff0c\u6807\u8bb0\u6cd5\u7684\u4f18\u70b9\u662f\u7cbe\u51c6\uff1b\u4f46\u7f3a\u70b9\u4e5f\u663e\u800c\u6613\u89c1\uff0c\u9700\u8981\u6253\u6807\u8bb0\u3002</p> <ul> <li>2.\u9ed1\u76d2\u65b9\u6848\uff08\u65e0\u4fb5\u5165\u3001\u51c6\u786e\u5ea6\u4f4e\uff09</li> </ul> <p>\u9ed1\u76d2\u65b9\u6848\u5728\u65e0\u4fb5\u5165\u7684\u5b9e\u73b0\u4e0a\uff0c\u9ad8\u4e8e\u6807\u8bb0\u65b9\u6848\u4e00\u4e2a\u7ef4\u5ea6\u3002\u9ed1\u76d2\u65b9\u6848\u8ba4\u4e3a\u5e94\u7528\u670d\u52a1\u662f\u9ed1\u76d2\u7684\uff0c\u6211\u4eec\u53ea\u5173\u5fc3\u53ef\u89c1\u7684\u8bf7\u6c42\u4e0e\u65e5\u5fd7\uff0c\u901a\u8fc7\u673a\u5668\u5b66\u4e60\u7684\u65b9\u6cd5\uff0c\u5c06\u8fd9\u4e9b\u8bf7\u6c42\u548c\u65e5\u5fd7\u5173\u8054\u8d77\u6765</p> <p>\u6700\u5e38\u89c1\u7684\u673a\u5668\u5b66\u4e60\u65b9\u5f0f\u7528\u56de\u5f52\u5206\u6790\u7b49\u7edf\u8ba1\u5b66\u7b97\u6cd5\uff0c\u5c06\u8fd9\u4e9b\u788e\u7247\u5316\u7684\u8bf7\u6c42\u548c\u65e5\u5fd7\u901a\u8fc7\u63a8\u6d4b\uff0c\u91cd\u65b0\u7ec4\u5408\u6210\u5b8c\u6574\u7684\u94fe\u8def\u3002</p> <p>\u9ed1\u76d2\u65b9\u6848\u7684\u4f18\u52bf\u663e\u800c\u6613\u89c1\uff0c\u4e0d\u9700\u8981\u4efb\u4f55\u5e94\u7528\u670d\u52a1\u7684\u67b6\u6784\u4fee\u6539\u548c\u76d1\u63a7\u65e5\u5fd7\u7684\u53d8\u66f4\uff1b</p> <p>\u9ed1\u76d2\u65b9\u6848\u7684\u7f3a\u70b9\u5f88\u660e\u663e\uff0c\u673a\u5668\u5b66\u4e60\u7684\u7cbe\u5ea6\u662f\u9010\u6e10\u63d0\u9ad8\u7684\u3002\u6240\u4ee5\u4e0a\u7ebf\u65b0\u529f\u80fd\u65f6\uff0c\u5f80\u5f80\u5206\u5e03\u5f0f\u76d1\u63a7\u53ef\u7528\u5ea6\u975e\u5e38\u4f4e\uff0c\u800c\u4e14\u673a\u5668\u5b66\u4e60\u4f1a\u6d88\u8017\u5f88\u591a\u7684\u8fd0\u7b97\u8d44\u6e90\u3002</p>"},{"location":"chap_apm/2opentracing/#skywalking","title":"SkyWalking \u7684\u56fe\u5f62\u8ffd\u8e2a\u6a21\u578b (\u517c\u5bb9\u6811\u5f62\u6a21\u578b\u7684\u56fe\u5f62\u8ffd\u8e2a\u6a21\u578b)","text":"<p>1.\u514b\u670d\u6811\u5f62\u8ffd\u8e2a\u7684\u4e0d\u8db3\u2014\u2014\u65e0\u6cd5\u6279\u5904\u7406</p> <p>\u56fe\u4e0e\u6811\u6700\u5927\u7684\u533a\u522b\u5c31\u662f\u6bcf\u4e2a\u8282\u70b9\u53ef\u4ee5\u6709\u591a\u4e2a\u7236\u8282\u70b9</p> <p>\u3010\u9884\u6d4b\u7cfb\u7edf\u573a\u666f\u3011</p> <p>\u4e00\u4e2a\u5178\u578b\u7684\u573a\u666f\u5c31\u662f\u9884\u6d4b\u7cfb\u7edf\uff0c\u901a\u8fc7\u5404\u4e2a\u7cfb\u7edf\u7684\u884c\u4e3a\u6570\u636e\u5bf9\u4ea7\u54c1\u7684\u672a\u6765\u505a\u51fa\u9884\u6d4b\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p></p> <p>\u7528\u6237\u5bf9\u5404\u4e2a\u7cfb\u7edf\u7684\u64cd\u4f5c\u5f15\u53d1\u4e86\u4e00\u7cfb\u5217\u6570\u636e\uff0c\u8fd9\u4e9b\u6570\u636e\u4f1a\u63a8\u9001\u5230\u6d88\u606f\u961f\u5217\uff0c\u7136\u540e\u9884\u6d4b\u670d\u52a1\u6279\u91cf\u6d88\u8d39\u3002\u53ef\u4ee5\u770b\u5230\u9884\u6d4b\u670d\u52a1\u7684\u4e00\u6b21\u9884\u6d4b\u7b97\u6cd5\u4ee3\u7801\u5757\u7684\u6267\u884c\uff0c\u662f\u7531\u591a\u4e2a\u4e1a\u52a1\u670d\u52a1\u5f15\u53d1\u7684\u3002\u90a3\u4ece\u9884\u6d4b\u670d\u52a1\u8fd9\u4e2a\u70b9\u6765\u770b\uff0c\u5982\u4f55\u4e0e\u591a\u4e2a\u751f\u4ea7\u8005\u670d\u52a1\u4e32\u8054\u94fe\u8def\u5462\uff1f\u6811\u5f62\u8ffd\u8e2a\u6a21\u578b\u663e\u7136\u662f\u4e0d\u80fd\u6ee1\u8db3\u7684\u3002</p> <p>2.\u56fe\u5f62\u8ffd\u8e2a\u7684\u5b9e\u73b0\u2014\u2014\u652f\u6301\u6279\u5904\u7406\u548c\u201c\u65ad\u94fe\u201d\u573a\u666f</p> <p>\u4ee5 SkyWalking \u7684\u5b58\u50a8\u6a21\u578b\u4e3a\u4f8b</p> <ul> <li> <p>Span \u6253\u5305\uff1aSkyWalking \u5c06\u4e00\u4e2a\u4efb\u52a1\u7ebf\u7a0b\u4e2d\u7684\u6240\u6709 Span \u6253\u5305\u4e3a Segment\u3002\u4e00\u4e2a Segment \u4e2d\u7684 Span \u7531 0 \u9012\u589e\uff0c\u4e14\u5177\u6709\u76f8\u540c\u7236\u8282\u70b9\u4f9d\u8d56\u3002</p> </li> <li> <p>\u7236\u8282\u70b9\u63cf\u8ff0\uff1aSkyWalking \u7236\u8282\u70b9\u63cf\u8ff0\u7531\u591a\u4e2a\u5c5e\u6027\u7ec4\u6210\u3002</p> <ul> <li>Refs \u5c5e\u6027\uff1a\u63cf\u8ff0\u5f53\u524d Segment \u4e0e\u76f8\u5173\u751f\u4ea7\u8005\u7684 Segment \u6807\u8bc6\u3002</li> <li>\u5728 RPC \u8c03\u7528\u7684\u6811\u5f62\u8ffd\u8e2a\u94fe\u8def\u4e2d\uff0c\u4e3a 1 \u4e2a\u5143\u7d20\uff1b\u4f46\u662f\u5f53\u8ffd\u8e2a\u573a\u666f\u6709\u6279\u5904\u7406\u6846\u67b6\u65f6\uff0c\u94fe\u8def\u4ece\u6279\u5904\u7406\u6846\u67b6\u8d77\u5c31\u4e3a\u591a\u4e2a\u5143\u7d20\u3002</li> </ul> </li> <li> <p>\u5206\u5e03\u5f0f\u94fe\u8def ID\uff1a\u5206\u5e03\u5f0f\u94fe\u8def ID \u662f\u91cd\u8981\u7684\u94fe\u8def\u6807\u8bb0\uff0c\u5176\u6570\u636e\u7ed3\u6784\u4e3a\u6570\u7ec4\u3002</p> <ul> <li>\u5982\u9884\u6d4b\u573a\u666f\u4e2d\uff0c\u5546\u54c1\u7c7b\u76ee\u548c\u4ea4\u6613\u670d\u52a1\u7b49\u4e1a\u52a1\u670d\u52a1\u7684\u5206\u5e03\u5f0f\u94fe\u8def ID \u7684\u6570\u7ec4\u957f\u5ea6\u4e3a 1 \u4e2a\uff1b\u5f53\u9884\u6d4b\u670d\u52a1\u62c9\u53d6\u4e00\u6279\u7528\u6237\u8bf7\u6c42\u884c\u4e3a\u540e\uff0c\u5206\u5e03\u5f0f\u94fe\u8def\u8ddf\u8e2a ID \u5c31\u662f\u591a\u4e2a\u4e86\u3002\u6570\u91cf\u548c\u62c9\u53d6\u6d88\u606f\u4e2d\u7684\u7236\u8282\u70b9\u63cf\u8ff0\u6570\u91cf\u6709\u5173\u3002</li> </ul> </li> </ul>"},{"location":"chap_apm/2opentracing/#2-skywalking","title":"2 \u4eb2\u548c\u7ebf\u7a0b\u6a21\u578b\uff1a\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a SkyWalking","text":"<p>SkyWalking \u4f7f\u7528\u5b57\u8282\u7801\u589e\u5f3a\u6280\u672f\u5b9e\u73b0\u4e86\u76d1\u63a7\uff0c\u901a\u5e38\u7684\u573a\u666f\u4e0b\u5728\u5e94\u7528\u670d\u52a1\u7684\u542f\u52a8\u547d\u4ee4\u4e2d\uff0c\u589e\u52a0\u63a2\u9488\u5c5e\u6027\u5c31\u80fd\u5b8c\u6210\u63a5\u5165 SkyWalking \u7684 APM \u76d1\u63a7\u3002</p>"},{"location":"chap_apm/2opentracing/#_3","title":"\u5de5\u4f5c\u7ebf\u7a0b\u3001\u4efb\u52a1\u7ebf\u7a0b\u3001\u7ebf\u7a0b\u6c60\u662f\u5982\u4f55\u914d\u5408\u7684\uff1f","text":"<p>\u4e24\u4e2a\u5173\u952e\u8bcd\u6765\u63cf\u8ff0\u7ebf\u7a0b\uff0c\u90a3\u5c31\u662f\u5de5\u4f5c\u7ebf\u7a0b\u548c\u4efb\u52a1\u7ebf\u7a0b\u3002</p> <p>\u8fd9\u4e24\u4e2a\u8bcd\u6765\u81ea Java \u5e76\u53d1\u6846\u67b6\u5305\uff08java.util.concurrent\uff09\u4e2d\u7684\u7ebf\u7a0b\u6c60\u6267\u884c\u5668\u7c7b\uff08ThreadPoolExecutor\uff09\uff0c\u5176\u4e2d\u5f53\u524d\u6b63\u5728\u6267\u884c runWorker \u65b9\u6cd5\u7684\u7ebf\u7a0b\u662f\u5de5\u4f5c\u7ebf\u7a0b\uff1b\u5728 runWorker \u4e0d\u505c\u5faa\u73af\uff0c\u4ece\u7b49\u5f85\u6267\u884c\u961f\u5217\u4e2d\u83b7\u53d6\u7684\u5bf9\u8c61\u4e3a\u4efb\u52a1\u7ebf\u7a0b\u3002</p> <p>\u6700\u597d\u7684\u7ebf\u7a0b\u7ba1\u7406\u7b56\u7565\u5c31\u662f\u4f7f\u7528\u7ebf\u7a0b\u6c60\uff0c\u7ebf\u7a0b\u6c60\u6267\u884c\u8fc7\u7a0b\u5982\u4e0b\u6240\u793a\u3002</p> <p>\u6574\u4e2a\u6d41\u7a0b\u975e\u5e38\u7b80\u5355\u5730\u5206\u4e3a\u4e24\u90e8\u5206\uff1a</p> <p></p> <ul> <li>\u5728\u4e3b\u7ebf\u7a0b\u4e2d\u56e0\u4e3a\u6709\u5f02\u6b65\u5904\u7406\u529f\u80fd\uff0c\u6240\u4ee5\u521b\u5efa\u4efb\u52a1\u7ebf\u7a0b\u5e76\u63d0\u4ea4\u5230\u963b\u585e\u961f\u5217\uff1b</li> <li>\u5de5\u4f5c\u7ebf\u7a0b\u4f1a\u6301\u7eed\u4ece\u961f\u5217\u4e2d\u62ff\u53d6\u4efb\u52a1\u7ebf\u7a0b\u5e76\u6267\u884c\u3002</li> </ul> <p>\u4e0a\u56fe\u4e2d\u7684\u4e3b\u7ebf\u7a0b\uff0c\u662f\u5176\u4ed6\u7ebf\u7a0b\u6c60\u4e2d\u5de5\u4f5c\u7ebf\u7a0b\u5728\u6267\u884c\u7684\u4efb\u52a1\u7ebf\u7a0b</p>"},{"location":"chap_apm/2opentracing/#_4","title":"\u4ece\u76d1\u63a7\u89c6\u89d2\u91cd\u65b0\u8ba4\u8bc6\u7ebf\u7a0b","text":"<p>\u4ee5 Spring Boot \u5fae\u670d\u52a1\u4e3a\u4f8b\uff0c\u6765\u770b\u4e0b SkyWalking \u662f\u5982\u4f55\u5b9e\u73b0 Web \u670d\u52a1\u5668\u7684\u76d1\u63a7\u7684\u3002</p> <ul> <li>\u5de5\u4f5c\u7ebf\u7a0b</li> </ul> <p>\u5728 Spring Boot \u5fae\u670d\u52a1\u7684\u573a\u666f\u4e2d\uff0c\u4e3b\u7ebf\u7a0b\u662f\u5728 Tomcat \u5bb9\u5668\u7684\u7ebf\u7a0b\u6c60\u4e2d\u6b63\u5728\u54cd\u5e94\u7528\u6237\u8bf7\u6c42\u65f6\u6267\u884c\u7684\u4e1a\u52a1\u4ee3\u7801\u7684\u4efb\u52a1\u7ebf\u7a0b\u3002</p> <p>SkyWalking \u5728 Tomcat \u8fdb\u884c\u8f6c\u53d1\u8bf7\u6c42\u7684\u4ee3\u7801\u5757\u8fdb\u884c\u76d1\u63a7\u3002\u5728\u540c\u6b65\u6a21\u5f0f\u4e0b\uff0c\u6574\u4f53\u7684\u76d1\u63a7\u7c7b\u540c\u4e8e Spring AOP \u9762\u5411\u5207\u9762\u7684\u8bbe\u8ba1\u601d\u60f3\uff0c\u5728\u6267\u884c\u65b9\u6cd5\u7684\u524d\u540e\u8fdb\u884c\u76d1\u63a7\u6570\u636e\u7684\u6536\u96c6\uff0c\u4e5f\u5c31\u662f\u5bf9\u4efb\u52a1\u7ebf\u7a0b\u7684\u6267\u884c\u8fc7\u7a0b\u8fdb\u884c\u76d1\u63a7\u3002</p> <ul> <li>\u4efb\u52a1\u7ebf\u7a0b</li> </ul> <p>\u4e3a\u4e86\u5b9e\u73b0\u5728\u6267\u884c\u4efb\u52a1\u7ebf\u7a0b\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6bcf\u5904\u6536\u96c6\u7684\u76d1\u63a7\u4fe1\u606f\u53ef\u4ee5\u4e0d\u88ab\u5f00\u53d1\u4eba\u5458\u611f\u77e5\u5373\u53ef\u5b9e\u73b0\u5173\u8054\uff0cSkyWalking \u4f7f\u7528\u4e86 Java \u7ebf\u7a0b\u63d0\u4f9b\u7684\u7ebf\u7a0b\u672c\u5730\u53d8\u91cf\uff0c\u4e5f\u5c31\u662f ThreadLocal \u80fd\u529b\u6765\u5b9e\u73b0\u3002</p> <p>\u5728\u6267\u884c\u4efb\u52a1\u7ebf\u7a0b\u5f00\u59cb\u4e4b\u521d\uff0c\u5f53\u6808\u9488\u89e6\u53ca\u7b2c\u4e00\u4e2a SkyWalking \u76d1\u63a7\u57cb\u70b9\u540e\uff0c\u4f1a\u5728 ThreadLocal \u521b\u5efa\u5f53\u524d\u4efb\u52a1\u7ebf\u7a0b\u7684\u8ddf\u8e2a\u4fe1\u606f\uff0c\u91cd\u8981\u7684\u5c5e\u6027\u5982\u4e0b</p> <ul> <li>\u4efb\u52a1\u7ebf\u7a0b\u7c7b\u578b</li> </ul> <p>\u6839\u636e\u7b2c\u4e00\u4e2a\u76d1\u63a7\u57cb\u70b9\u7684\u7c7b\u578b\uff0c\u5c06\u4efb\u52a1\u7ebf\u7a0b\u5206\u4e3a\u662f\u8981\u8ffd\u8e2a\u8de8\u8fdb\u7a0b\u94fe\u8def\u8fd8\u662f\u8de8\u7ebf\u7a0b\u94fe\u8def \u5bf9\u4e8e\u8de8\u8fdb\u7a0b\u94fe\u8def\uff0c\u53c8\u53ef\u4ee5\u5206\u4e3a\u4e0a\u6e38\u662f\u4eba\u8fd8\u662f\u673a\u5668\u3002\u4ee5 SpringMvc \u8ffd\u8e2a\u4e3a\u4f8b\uff0c\u7b2c\u4e00\u4e2a\u76d1\u63a7\u57cb\u70b9\u9700\u8981\u8bc6\u522b HTTP Header \u4e2d\u7684\u6807\u8bb0\u4fe1\u606f\u3002</p> <ul> <li> <p>\u5168\u94fe\u8def\u8ddf\u8e2a\u6807\u8bc6</p> <ul> <li>\u82e5 HTTP Header \u6ca1\u6709\u94fe\u8def\u6807\u8bc6\u4fe1\u606f\uff0c\u5c31\u5c06\u8ffd\u8e2a\u7684\u94fe\u8def\u6e32\u67d3\u4e3a\u4eba\u4e3a\u8c03\u7528\uff0c\u5e76\u521b\u5efa\u5168\u94fe\u8def\u6807\u8bc6\u7ed1\u5b9a\u5230 ThreadLocal \u4fe1\u606f\u4e2d\uff1b</li> <li>\u53cd\u4e4b\uff0c\u8bc6\u522b HTTP Header \u7684\u94fe\u8def\u6807\u8bc6\uff0c\u89e3\u6790\u51fa\u5168\u94fe\u8def\u8ddf\u8e2a\u6807\u8bc6\uff0c\u5e76\u8ffd\u52a0\u5230 ThreadLocal \u4e2d\u7684\u5168\u94fe\u8def\u6807\u8bc6\u4fe1\u606f\u3002</li> </ul> </li> </ul> <p>\u5f53\u4efb\u52a1\u7ebf\u7a0b\u5f00\u59cb\u6267\u884c\u540e\uff0cSkyWalking \u76d1\u63a7\u57cb\u70b9\u4f1a\u6709\u4ee5\u4e0b\u4e24\u7c7b\uff1a\u8de8\u8fdb\u7a0b\u76d1\u63a7\u57cb\u70b9\u548c\u8de8\u7ebf\u7a0b\u76d1\u63a7\u57cb\u70b9\u3002</p> <ul> <li>\u5bf9\u4e8e\u8de8\u8fdb\u7a0b\u76d1\u63a7\uff0c\u9700\u8981\u627e\u5230\u9762\u5411\u4f20\u8f93\u7684\u8bf7\u6c42\u5934\u90e8\u5c5e\u6027\uff0c\u5c06 ThreadLocal \u4e2d\u7684\u5168\u94fe\u8def\u6807\u8bc6\u653e\u5165\u5176\u4e2d\u3002</li> <li>\u5bf9\u4e8e\u8de8\u7ebf\u7a0b\u76d1\u63a7\uff0c\u90a3\u5c31\u5f88\u7b80\u5355\u4e86\uff0c\u5728\u4e3b\u7ebf\u7a0b\u521b\u5efa\u4efb\u52a1\u7ebf\u7a0b\u65f6\uff0c\u6269\u5c55\u4efb\u52a1\u7ebf\u7a0b\u5bf9\u8c61\u7684\u5c5e\u6027\u3002\u5c06\u4e3b\u7ebf\u7a0b\u7684 ThreadLocal \u4e2d\u7684\u94fe\u8def\u6807\u8bc6\u653e\u5230\u6269\u5c55\u5c5e\u6027\u4e2d\uff0c\u5728\u4efb\u52a1\u7ebf\u7a0b\u6267\u884c\u65f6\uff0c\u8bc6\u522b\u8fd9\u4e2a\u5c5e\u6027\u5b8c\u6210\u4e32\u8054\u3002</li> </ul> <p>\u6700\u540e\uff0c\u5c31\u662f\u4efb\u52a1\u7ebf\u7a0b\u6267\u884c\u63a5\u8fd1\u7ed3\u675f\u65f6\uff0c\u76d1\u63a7\u4efb\u52a1\u7ebf\u7a0b\u7684\u7ed3\u675f\uff0c\u4f9d\u8d56\u4e8e\u9996\u4e2a\u76d1\u63a7\u65b9\u6cd5\u7684\u9000\u51fa\u65f6\u673a\uff0c\u6b64\u65f6\u9700\u8981\u6e05\u7406 SkyWalking \u6240\u6709\u76d1\u63a7\u7684 ThreadLocal \u4fe1\u606f</p> <p>\u6240\u4ee5\u5728\u7ebf\u7a0b\u590d\u7528\u7684\u65f6\u5019\uff0c\u82e5\u5728\u4efb\u52a1\u7ebf\u7a0b\u7ed3\u675f\u7684\u65f6\u5019\u6ca1\u6709\u6e05\u7406\u5e72\u51c0\uff0c\u90a3\u63a5\u4e0b\u6765\u6267\u884c\u7684\u4efb\u52a1\u7ebf\u7a0b\uff1a\u8f7b\u5219\u5185\u5b58\u6cc4\u6f0f\uff0c\u65e0\u6cd5\u4e32\u8054\u94fe\u8def\uff1b\u91cd\u5219\u5185\u5b58\u6ea2\u51fa\uff0c\u6574\u4e2a\u8fdb\u7a0b\u88ab\u4e0d\u505c\u7684 Long GC \u592f\u4f4f\u3002</p> <p>\u5728 SkyWalking \u7684\u76d1\u63a7\u7ebf\u7a0b\u6a21\u578b\u4e0b\uff0c\u82e5\u76d1\u63a7\u4e86\u5de5\u4f5c\u7ebf\u7a0b\uff0c\u5c31\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u60c5\u51b5\uff1a</p> <ul> <li>\u5de5\u4f5c\u7ebf\u7a0b\u5728\u542f\u52a8\u540e\uff0c\u5c31\u4f1a\u5f00\u542f\u76d1\u63a7\uff0c\u5728\u6267\u884c\u4efb\u52a1\u7ebf\u7a0b\u65f6\u4f1a\u4e0e\u4e3b\u7ebf\u7a0b\u8fdb\u884c\u5173\u8054\uff1b</li> <li>\u5728\u7ed3\u675f\u4efb\u52a1\u7ebf\u7a0b\u65f6\uff0c\u7531\u4e8e\u5de5\u4f5c\u7ebf\u7a0b\u5e76\u6ca1\u6709\u9000\u51fa\uff0c\u6240\u4ee5\u76d1\u63a7\u4fe1\u606f\u4e0d\u4f1a\u4e0a\u62a5\uff1b</li> <li>\u5f53\u590d\u7528\u5de5\u4f5c\u7ebf\u7a0b\uff0c\u518d\u6b21\u6267\u884c\u4efb\u52a1\u7ebf\u7a0b\u65f6\uff0c\u4f1a\u7ee7\u7eed\u4e0e\u65b0\u7684\uff08\u521b\u5efa\u672c\u6b21\u4efb\u52a1\u7ebf\u7a0b\u7684\uff09\u4e3b\u7ebf\u7a0b\u8fdb\u884c\u5173\u8054\u3002</li> </ul> <p>\u90a3\u6700\u7ec8\u7684\u7ed3\u679c\u5c31\u662f\uff1a\u6bcf\u4e00\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u5185\u90e8\u7684\u76d1\u63a7\u4fe1\u606f\u7531\u4e8e\u4e00\u76f4\u65e0\u6cd5\u4e0a\u62a5\u800c\u65e0\u6cd5\u5f97\u5230\u91ca\u653e\uff0c\u5360\u7528\u7684\u5185\u5b58\u7a7a\u95f4\u4f1a\u76f4\u7ebf\u4e0a\u5347\u3002\u4e14\u8fd9\u4e9b\u88ab\u5360\u7528\u7684\u5185\u5b58\u7531\u4e8e\u4e0d\u80fd\u5339\u914d\u5185\u5b58\u5783\u573e\u56de\u6536\u7b97\u6cd5\uff0cJVM \u8fdb\u7a0b\u5728\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u5230\u8fbe\u4e34\u754c\u503c\u540e\uff0c\u4f1a\u9891\u7e41\u6267\u884c\u5783\u573e\u56de\u6536\uff0c\u4f46\u901a\u8fc7\u5783\u573e\u56de\u6536\u65e5\u5fd7\u4f1a\u53d1\u73b0\u6536\u6548\u751a\u5fae\u3002</p>"},{"location":"chap_apm/3apm_tracing/","title":"3 \u600e\u4e48\u7406\u89e3\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u6280\u672f\uff1f","text":""},{"location":"chap_apm/3apm_tracing/#1","title":"1 \u4e3a\u4ec0\u4e48\u9700\u8981\u94fe\u8def\u8ffd\u8e2a","text":"<p>\u5728\u5b66\u4e60\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u7406\u89e3\u8fd9\u9879\u6280\u672f\u4ea7\u751f\u7684\u80cc\u666f\uff0c\u4ee5\u53ca\u5b83\u80fd\u591f\u5e2e\u6211\u4eec\u89e3\u51b3\u54ea\u4e9b\u68d8\u624b\u95ee\u9898\u3002</p> <p>\u63d0\u5230\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\uff0c\u6211\u4eec\u8981\u5148\u63d0\u5230\u5fae\u670d\u52a1\u3002\u76f8\u4fe1\u5f88\u591a\u4eba\u90fd\u63a5\u89e6\u8fc7\u5fae\u670d\u52a1\uff0c\u8fd9\u91cc\u518d\u56de\u987e\u4e00\u4e0b\u57fa\u672c\u6982\u5ff5\u3002</p> <p>\u5fae\u670d\u52a1\u662f\u4e00\u79cd\u5f00\u53d1\u8f6f\u4ef6\u7684\u67b6\u6784\u548c\u7ec4\u7ec7\u65b9\u6cd5\uff0c\u5b83\u4fa7\u91cd\u5c06\u670d\u52a1\u89e3\u8026\uff0c\u670d\u52a1\u4e4b\u95f4\u901a\u8fc7API\u901a\u4fe1\u3002\u4f7f\u5e94\u7528\u7a0b\u5e8f\u66f4\u6613\u4e8e\u6269\u5c55\u548c\u66f4\u5feb\u5730\u5f00\u53d1\uff0c\u4ece\u800c\u52a0\u901f\u65b0\u529f\u80fd\u4e0a\u7ebf\u3002</p> <p></p> <p>\u5fae\u670d\u52a1\u6f14\u53d8-\u4e9a\u9a6c\u900a\u4e91</p> <p>\u52a0\u901f\u7814\u53d1\u5feb\u901f\u8fed\u4ee3\uff0c\u8ba9\u5fae\u670d\u52a1\u5728\u4e1a\u52a1\u9a71\u52a8\u7684\u4e92\u8054\u7f51\u9886\u57df\u5168\u9762\u666e\u53ca\uff0c\u72ec\u9886\u98ce\u9a9a\u3002\u4f46\u662f\uff0c\u968f\u4e4b\u800c\u6765\u4e5f\u4ea7\u751f\u4e86\u65b0\u95ee\u9898\uff1a\u5f53\u751f\u4ea7\u7cfb\u7edf\u9762\u5bf9\u9ad8\u5e76\u53d1\uff0c\u6216\u8005\u89e3\u8026\u6210\u5927\u91cf\u5fae\u670d\u52a1\u65f6\uff0c\u4ee5\u524d\u5f88\u5bb9\u6613\u5c31\u80fd\u5b9e\u73b0\u7684\u76d1\u63a7\u3001\u9884\u8b66\u3001\u5b9a\u4f4d\u6545\u969c\u5c31\u53d8\u56f0\u96be\u4e86\u3002</p>"},{"location":"chap_apm/3apm_tracing/#2","title":"2 \u4ec0\u4e48\u662f\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a","text":"<p>\u521a\u624d\u8bf4\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u8feb\u5207\u9700\u8981\u4e00\u4e9b\u65b0\u5de5\u5177\uff0c\u5e2e\u6211\u4eec\u7406\u89e3\u5fae\u670d\u52a1\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u884c\u4e3a\u3001\u7cbe\u51c6\u5206\u6790\u6027\u80fd\u95ee\u9898\u3002\u4e8e\u662f\uff0c\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e0b\u94fe\u8def\u8ffd\u8e2a\u6280\u672f\uff08Distributed Tracing\uff09\u51fa\u73b0\u4e86\u3002</p> <p>\u5b83\u7684\u6838\u5fc3\u601d\u60f3\u662f\uff1a\u5728\u7528\u6237\u4e00\u6b21\u8bf7\u6c42\u670d\u52a1\u7684\u8c03\u2f64\u8fc7\u7a0b\u4e2d\uff0c\u65e0\u8bba\u8bf7\u6c42\u88ab\u5206\u53d1\u5230\u591a\u5c11\u4e2a\u5b50\u7cfb\u7edf\u4e2d\uff0c\u5b50\u7cfb\u7edf\u53c8\u8c03\u7528\u4e86\u66f4\u591a\u7684\u5b50\u7cfb\u7edf\uff0c\u6211\u4eec\u628a\u7cfb\u7edf\u4fe1\u606f\u548c\u7cfb\u7edf\u95f4\u8c03\u7528\u5173\u7cfb\u90fd\u8ffd\u8e2a\u8bb0\u5f55\u4e0b\u6765\u3002\u6700\u7ec8\u628a\u6570\u636e\u96c6\u4e2d\u8d77\u6765\u53ef\u89c6\u5316\u5c55\u793a\u3002\u5b83\u4f1a\u5f62\u6210\u4e00\u4e2a\u6709\u5411\u56fe\u7684\u94fe\u8def\uff0c\u770b\u8d77\u6765\u50cf\u4e0b\u9762\u8fd9\u6837\u3002</p> <p></p> <p>\u7535\u5546\u7cfb\u7edf\u7684\u94fe\u8def\u8ffd\u8e2a\u56fe</p> <p>\u540e\u6765\uff0c\u94fe\u8def\u8ffd\u8e2a\u6280\u672f\u76f8\u5173\u7cfb\u7edf\u6162\u6162\u6210\u719f\uff0c\u6d8c\u73b0\u4e86\u50cfDapper\u3001Zipkin\u3001HTrace\u3001OpenTelemetry\u7b49\u4f18\u79c0\u5f00\u6e90\u7cfb\u7edf\u3002\u4ed6\u4eec\u4e5f\u88ab\u4e1a\u754c\uff0c\u7279\u522b\u662f\u4e92\u8054\u7f51\u666e\u904d\u91c7\u7528\u3002</p> <p>\u76ee\u524dDapper\uff08\u8bde\u751f\u4e8eGoogle\u56e2\u961f\uff09\u5e94\u7528\u5f71\u54cd\u6700\u5927\uff0cOpenTelemetry\u5df2\u7ecf\u6210\u4e3a\u6700\u65b0\u4e1a\u754c\u6807\u51c6\uff0c\u6211\u4eec\u91cd\u70b9\u57fa\u4e8eOpenTelemetry\u8bb2\u89e3\u4e00\u4e0bTrace\u5185\u90e8\u7ed3\u6784</p>"},{"location":"chap_apm/3apm_tracing/#3-trace","title":"3 \u94fe\u8defTrace\u7684\u6838\u5fc3\u7ed3\u6784","text":""},{"location":"chap_apm/3apm_tracing/#3-1","title":"3-1 \u5feb\u901f\u5165\u95e8","text":"<p>\u6211\u4eec\u770b\u770b\u4e00\u4e2a\u4f8b\u5b50\uff0c\u67d0\u5546\u5bb6\u7ed9\uff08\u987e\u5ba2\uff09\u5f00\u8d26\u5355\uff08\u8981\u6c42\u4ed8\u6b3e\uff09\uff0c\u5728\u7cfb\u7edf\u4e2d\u5927\u4f53\u7684\u6d41\u7a0b\uff1a</p> <p></p> <ul> <li>\u5f53\u5546\u5bb6\u4ececlient\u53d1\u8d77\u5f00\u8d26\u5355\u670d\u52a1\uff0c\u8bf7\u6c42\u4ececlient\u7a0b\u5e8f\u5148\u540e\u8fdb\u884c\u4e86\u4e00\u7cfb\u5217\u64cd\u4f5c\uff1a</li> <li>\u7f51\u5173load balancer\uff1aclient\u7684https\u8bf7\u6c42\u5148\u7ecf\u8fc7\u7f51\u5173\uff0c\u7f51\u5173\u8c03\u7528\u4e0b\u9762\u7684\u5b50\u7cfb\u7edf</li> <li>\u8eab\u4efd\u8ba4\u8bc1auth\uff1a\u7f51\u5173RPC\u8bf7\u6c42\u5230\u670d\u52a1auth\uff0cauth\u53d1\u8d77\u8eab\u4efd\u8ba4\u8bc1\uff0c\u5b8c\u6210\u540e\u901a\u77e5\u7f51\u5173\u7a0b\u5e8f</li> <li>\u751f\u6210\u8d26\u5355billing\uff1a\u8eab\u4efd\u8ba4\u8bc1\u6210\u529f\u540e\uff0c\u7f51\u5173\u518d\u53d1\u9001RPC\u8bf7\u6c42\u5230\u670d\u52a1billing\uff0cbilling\u662f\u751f\u6210\u8d26\u5355\u7684\u64cd\u4f5c\uff0cbilling\u5904\u7406\u5b8c\u901a\u77e5\u7f51\u5173\u4e0b\u4e00\u6b65</li> <li>\u8d44\u6e90\u52a0\u8f7dresource\uff1abilling\u6210\u529f\uff0c\u7f51\u5173\u53d1\u9001\u4e00\u4e2aHTTP\u8bf7\u6c42\u5230\u670d\u52a1resource\uff0c\u52a0\u8f7d\u548c\u8d26\u5355\u76f8\u5173\u8d44\u6e90\uff0c\u6bd4\u5982\u9759\u6001\u56fe\u7247\uff0c\u76f8\u5173\u987e\u5ba2\u8d44\u6599\uff0cresource\u5b8c\u6210\u901a\u77e5\u7f51\u5173</li> <li>\u6700\u540e\u7f51\u5173\u7a0b\u5e8f\u5904\u7406\u5b8c\u5f00\u8d26\u5355\u670d\u52a1\uff0c\u8fd4\u56de\u7ed3\u679c\u7ed9client</li> </ul> <p>\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u628a\u5f00\u8d26\u5355\u670d\u52a1\u4e00\u4e2a\u6d41\u7a0b\u6216\u8005\u53eb\u4e00\u4e2a\u4e8b\u52a1\u79f0\u4e3aTrace\u3002\u8fd9\u91cc\u9762\u6709\u51e0\u4e2a\u64cd\u4f5c\uff0c\u5206\u522b\u662f\u8bf7\u6c42\u7f51\u5173\u3001\u8eab\u4efd\u8ba4\u8bc1\u3001\u751f\u6210\u8d26\u5355\u3001\u52a0\u8f7d\u8d44\u6e90\uff0c\u6211\u4eec\u628a\u6bcf\u4e2a\u64cd\u4f5c\uff08Operation\uff09\u79f0\u4e3a\u4e00\u4e2a Span\u3002</p>"},{"location":"chap_apm/3apm_tracing/#3-2-trace","title":"3-2 Trace\u6570\u636e\u6a21\u578b","text":"<p>\u6211\u4eec\u770b\u770bTrace\u5e7f\u4e49\u7684\u5b9a\u4e49\uff1aTrace\u662f\u591a\u4e2a Span \u7ec4\u6210\u7684\u4e00\u4e2a\u6709\u5411\u65e0\u73af\u56fe\uff08DAG\uff09\uff0c\u6bcf\u4e00\u4e2a Span \u4ee3\u8868 Trace \u4e2d\u88ab\u547d\u540d\u5e76\u8ba1\u65f6\u7684\u8fde\u7eed\u6027\u7684\u6267\u884c\u7247\u6bb5\u3002</p> <p>\u6211\u4eec\u4e00\u822c\u7528\u8fd9\u6837\u6570\u636e\u6a21\u578b\u63cf\u8ff0Trace\u548cSpan\u5173\u7cfb\uff1a</p> <pre><code>            [Span user click]  \u2190\u2190\u2190(the root Span)\n                       |         \n                 [Span gateway]  \n                       |\n     +------+----------+-----------------------+\n     |                 |                       |\n [Span auth]      [Span billing]     [Span loading resource] \n</code></pre> <p>\u5f00\u8d26\u5355Trace\u6570\u636e\u6a21\u578b</p> <p>\u6570\u636e\u6a21\u578b\u5305\u542b\u4e86Span\u4e4b\u95f4\u5173\u7cfb\u3002Span\u5b9a\u4e49\u4e86\u7236\u7ea7Span\uff0c\u5b50Span\u7684\u6982\u5ff5\u3002\u4e00\u4e2a\u7236\u7ea7\u7684Span\u4f1a\u5e76\u884c\u6216\u8005\u4e32\u884c\u542f\u52a8\u591a\u4e2a\u5b50Span\u3002\u56fe\u4e09\uff0cGateway\u5c31\u662fauth\u3001billing\u7684\u7236\u7ea7Span\u3002</p> <p>\u4e0a\u9762\u8fd9\u79cd\u56fe\u5bf9\u4e8e\u770b\u6e05\u5404\u7ec4\u4ef6\u7684\u7ec4\u5408\u5173\u7cfb\u662f\u5f88\u6709\u7528\u7684\uff0c\u4f46\u662f\uff0c\u5b83\u4e0d\u80fd\u5f88\u597d\u663e\u793a\u7ec4\u4ef6\u7684\u8c03\u7528\u65f6\u95f4\uff0c\u662f\u4e32\u884c\u8c03\u7528\u8fd8\u662f\u5e76\u884c\u8c03\u7528\u3002\u53e6\u5916\uff0c\u8fd9\u79cd\u56fe\u4e5f\u65e0\u6cd5\u663e\u793a\u670d\u52a1\u8c03\u7528\u7684\u65f6\u95f4\u548c\u5148\u540e\u987a\u5e8f\u3002\u56e0\u6b64\uff0c\u5728\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u4f1a\u7528\u53e6\u4e00\u79cd\u56fe\u5c55\u73b0\u4e00\u4e2a\u5178\u578b\u7684Trace\u8fc7\u7a0b\uff0c\u5982\u4e0b\u9762\u6240\u793a\uff1a</p> <p></p> <p>\u8fd9\u79cd\u5c55\u73b0\u65b9\u5f0f\u589e\u52a0\u663e\u793a\u4e86\u6267\u884c\u65f6\u95f4\u7684\u4e0a\u4e0b\u6587\uff0c\u76f8\u5173\u670d\u52a1\u95f4\u7684\u5c42\u6b21\u5173\u7cfb\uff0c\u4efb\u52a1\u7684\u4e32\u884c\u6216\u5e76\u884c\u8c03\u7528\u5173\u7cfb\u3002\u8fd9\u6837\u7684\u89c6\u56fe\u6709\u52a9\u4e8e\u53d1\u73b0\u7cfb\u7edf\u8c03\u7528\u7684\u5173\u952e\u8def\u5f84\u3002\u901a\u8fc7\u5173\u6ce8\u5173\u952e\u8def\u5f84\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u9879\u76ee\u56e2\u961f\u53ef\u80fd\u4e13\u6ce8\u4e8e\u4f18\u5316\u8def\u5f84\u4e2d\u7684\u5173\u952e\u4f4d\u7f6e\uff0c\u6700\u5927\u5e45\u5ea6\u7684\u63d0\u5347\u7cfb\u7edf\u6027\u80fd\u3002\u4f8b\u5982\uff1a\u53ef\u4ee5\u901a\u8fc7\u8ffd\u8e2a\u4e00\u4e2a\u7528\u6237\u8bf7\u6c42\u8bbf\u95ee\u94fe\u8def\uff0c\u89c2\u5bdf\u5e95\u5c42\u7684\u5b50\u7cfb\u7edf\u8c03\u7528\u60c5\u51b5\uff0c\u53d1\u73b0\u54ea\u4e9b\u64cd\u4f5c\u6709\u8017\u65f6\u91cd\u8981\u5173\u6ce8\u4f18\u5316\u3002</p>"},{"location":"chap_apm/3apm_tracing/#3-3-span","title":"3-3 Span\u57fa\u672c\u7ed3\u6784","text":"<p>\u524d\u9762\u63d0\u5230Span\u901a\u4fd7\u6982\u5ff5\uff1a\u4e00\u4e2a\u64cd\u4f5c\uff0c\u5b83\u4ee3\u8868\u7cfb\u7edf\u4e2d\u4e00\u4e2a\u903b\u8f91\u8fd0\u884c\u5355\u5143\u3002Span\u4e4b\u95f4\u901a\u8fc7\u5d4c\u5957\u6216\u8005\u987a\u5e8f\u6392\u5217\u5efa\u7acb\u56e0\u679c\u5173\u7cfb\u3002Span\u5305\u542b\u4ee5\u4e0b\u5bf9\u8c61\uff1a</p> <ul> <li>\u64cd\u4f5c\u540d\u79f0Name\uff1a\u8fd9\u4e2a\u540d\u79f0\u7b80\u5355\uff0c\u5e76\u5177\u6709\u53ef\u8bfb\u6027\u9ad8\u3002\u4f8b\u5982\uff1a\u4e00\u4e2aRPC\u65b9\u6cd5\u7684\u540d\u79f0\uff0c\u4e00\u4e2a\u51fd\u6570\u540d\uff0c\u6216\u8005\u4e00\u4e2a\u5927\u578b\u8ba1\u7b97\u8fc7\u7a0b\u4e2d\u7684\u5b50\u4efb\u52a1\u6216\u9636\u6bb5</li> <li>\u8d77\u59cb\u65f6\u95f4\u548c\u7ed3\u675f\u65f6\u95f4\uff1a\u64cd\u4f5c\u7684\u751f\u547d\u5468\u671f</li> <li>\u5c5e\u6027Attributes\uff1a\u4e00\u7ec4\u952e\u503c\u5bf9\u6784\u6210\u7684\u96c6\u5408\u3002\u503c\u53ef\u4ee5\u662f\u5b57\u7b26\u4e32\u3001\u5e03\u5c14\u6216\u8005\u6570\u5b57\u7c7b\u578b\uff0c\u4e00\u4e9b\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u4e5f\u79f0\u4e3aTags <li>\u4e8b\u4ef6Event</li> <li>\u4e0a\u4e0b\u6587 SpanContext\uff1aSpan\u4e0a\u4e0b\u6587\u5185\u5bb9</li> <li>\u94fe\u63a5Links\uff1a\u63cf\u8ff0Span\u8282\u70b9\u5173\u7cfb\u7684\u8fde\u7ebf\uff0c\u5b83\u7684\u63cf\u8ff0\u4fe1\u606f\u4fdd\u5b58\u5728SpanContext\u4e2d</li> <p></p> <p>\u5c5e\u6027Attributes\uff1a</p> <p>\u6211\u4eec\u5206\u6790\u4e00\u4e2aTrace\uff0c\u901a\u8fc7Span\u91cc\u952e\u503c\u5bf9<code>&lt;K,V&gt;</code>\u5f62\u5f0f\u7684Attributes\u83b7\u53d6\u57fa\u672c\u4fe1\u606f\u3002\u4e3a\u4e86\u7edf\u4e00\u7ea6\u5b9a\uff0cSpan\u63d0\u4f9b\u4e86\u57fa\u7840\u7684Attributes\u3002\u6bd4\u5982\uff0cSpan\u6709\u4e0b\u9762\u5e38\u7528\u7684Attributes\u5c5e\u6027\uff1a</p> <ul> <li>\u7f51\u7edc\u8fde\u63a5Attributes\uff1a\u8fd9\u4e9bAttributes\u7528\u5728\u7f51\u7edc\u64cd\u4f5c\u76f8\u5173</li> <li>\u7ebf\u7a0bAttributes</li> </ul> <p>\u8fd9\u4e9bAttributes\u8bb0\u5f55\u4e86\u542f\u52a8\u4e00\u4e2aSpan\u540e\u76f8\u5173\u7ebf\u7a0b\u4fe1\u606f\u3002\u8003\u8651\u5230\u7cfb\u7edf\u53ef\u4ee5\u662f\u4e0d\u540c\u5f00\u53d1\u8bed\u8a00\uff0c\u76f8\u5e94\u8fd8\u4f1a\u8bb0\u5f55\u76f8\u5173\u8bed\u8a00\u5e73\u53f0\u4fe1\u606f\u3002\u4e0b\u9762\u662f\u4e0d\u540c\u8bed\u8a00\u5f00\u53d1\u7684\u5e73\u53f0\u83b7\u53d6\u7ebf\u7a0bId\u3001Name\u65b9\u6cd5\uff1a</p> <p></p> <p>\u8bb0\u5f55\u7ebf\u7a0b\u4fe1\u606f\uff0c\u5bf9\u4e8e\u6211\u4eec\u6392\u67e5\u95ee\u9898\u65f6\u5019\u975e\u5e38\u5fc5\u8981\u7684\uff0c\u5f53\u51fa\u73b0\u4e00\u4e2a\u7a0b\u5e8f\u5f02\u5e38\uff0c\u6211\u4eec\u81f3\u5c11\u8981\u77e5\u9053\u5b83\u4ec0\u4e48\u8bed\u8a00\u5f00\u53d1\uff0c\u627e\u5230\u5bf9\u4e8e\u7814\u53d1\u5de5\u7a0b\u5e08\u3002\u7814\u53d1\u5de5\u7a0b\u5e08\u5f80\u5f80\u9700\u8981\u7ebf\u7a0b\u76f8\u5173\u4fe1\u606f\u5feb\u901f\u5b9a\u4f4d\u9519\u8bef\u6808\u3002</p> <p></p> <p>Span\u95f4\u5173\u7cfb\u63cf\u8ff0Links\uff1a</p> <p>\u6211\u4eec\u770b\u770b\u4e4b\u524dSpan\u6570\u636e\u6a21\u578b\uff1a</p> <pre><code>                [Span gateway]\n                   |     \n     +------+------+------------------+ \n     |             |                  |\n [Span auth]  [Span billing]     [Span loading resource]\n</code></pre> <p>\u4e00\u4e2aTrace\u6709\u5411\u65e0\u73af\u56fe\uff0cSpan\u662f\u56fe\u7684\u8282\u70b9\uff0c\u94fe\u63a5\u5c31\u662f\u8282\u70b9\u95f4\u7684\u8fde\u7ebf\u3002\u53ef\u4ee5\u770b\u5230\u4e00\u4e2aSpan\u8282\u70b9\u53ef\u4ee5\u6709\u591a\u4e2aLink\uff0c\u8fd9\u4ee3\u8868\u5b83\u6709\u591a\u4e2a\u5b50Span\u3002</p> <p>Trace\u5b9a\u4e49\u4e86Span\u95f4\u4e24\u79cd\u57fa\u672c\u5173\u7cfb\uff1a</p> <ul> <li>ChildOf\uff1aSpan A\u662fSpan B\u7684\u5b69\u5b50\uff0c\u5373\u201cChildOf\u201d\u5173\u7cfb</li> <li>FollowsFrom\uff1aSpan A\u662fSpan B\u7684\u7236\u7ea7Span</li> </ul> <p>Span\u4e0a\u4e0b\u6587\u4fe1\u606fSpanContext\uff1a</p> <p>\u5b57\u9762\u7406\u89e3Span\u4e0a\u4e0b\u6587\u5bf9\u8c61\u3002\u5b83\u4f5c\u7528\u5c31\u662f\u5728\u4e00\u4e2aTrace\u4e2d\uff0c\u628a\u5f53\u524dSpan\u548cTrace\u76f8\u5173\u4fe1\u606f\u4f20\u9012\u5230\u4e0b\u7ea7Span\u3002\u5b83\u7684\u57fa\u672c\u7ed3\u6784\u7c7b\u4f3c<code>&lt;Trace_id, Span_id, sampled&gt;</code>\uff0c\u6bcf\u4e2aSpanContext\u5305\u542b\u4ee5\u4e0b\u57fa\u672c\u5c5e\u6027\uff1a</p> <ul> <li>TraceId\uff1a\u968f\u673a16\u5b57\u8282\u6570\u7ec4\u3002\u6bd4\u5982\uff1a4bf92f3577b34da6a3ce929d0e0e4736</li> <li>SpanId\uff1a\u968f\u673a8\u5b57\u8282\u6570\u7ec4\u3002\u6bd4\u5982\uff1a00f067aa0ba902b7</li> <li>Baggage Items\u662f\u5b58\u5728\u4e8eTrace\u4e00\u4e2a\u952e\u503c\u5bf9\u96c6\u5408\uff0c\u4e5f\u9700\u8981Span\u95f4\u4f20\u8f93\u3002</li> </ul>"},{"location":"chap_apm/3apm_tracing/#3-4-trace","title":"3-4 Trace\u94fe\u8def\u4f20\u9012\u521d\u63a2","text":"<p>\u5728\u4e00\u4e2a\u94fe\u8def\u8ffd\u8e2a\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u4e00\u822c\u4f1a\u6709\u591a\u4e2aSpan\u64cd\u4f5c\uff0c\u4e3a\u4e86\u628a\u8c03\u7528\u94fe\u72b6\u6001\u5728Span\u4e2d\u4f20\u9012\u4e0b\u53bb\uff0c\u671f\u671b\u6700\u7ec8\u4fdd\u5b58\u4e0b\u6765\uff0c\u6bd4\u5982\u6253\u5165\u65e5\u5fd7\u3001\u4fdd\u5b58\u5230\u6570\u636e\u5e93\u3002SpanContext\u4f1a\u5c01\u88c5\u4e00\u4e2a\u952e\u503c\u5bf9\u96c6\u5408\uff0c\u7136\u540e\u5c06\u6570\u636e\u50cf\u884c\u674e\u4e00\u6837\u6253\u5305\uff0c\u8fd9\u4e2a\u6253\u5305\u7684\u884c\u674eOpenTelemetry\u79f0\u4e3aBaggage\uff08\u80cc\u5305\uff09\u3002</p> <p>Baggage\u4f1a\u5728\u4e00\u6761\u8ffd\u8e2a\u94fe\u8def\u4e0a\u7684\u6240\u6709Span\u5185\u5168\u5c40\u4f20\u8f93\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cBaggage\u4f1a\u968f\u7740\u6574\u4e2a\u94fe\u8def\u4e00\u540c\u4f20\u64ad\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7Baggage\u5b9e\u73b0\u5f3a\u5927\u7684\u8ffd\u8e2a\u529f\u80fd\u3002</p> <p>\u65b9\u4fbf\u7406\u89e3\uff0c\u6211\u4eec\u7528\u5f00\u8d26\u5355\u670d\u52a1\u6f14\u793aBaggage\u6548\u679c\uff1a</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u5728LoadBalancer\u8bf7\u6c42\u4e2d\u52a0\u4e00\u4e2aBaggage\uff0cLoadBalancer\u8bf7\u6c42\u4e86source\u670d\u52a1\u3002</p> <pre><code>@GetMapping(\"/loadBalancer\")\n@ResponseBody\npublic String loadBalancer(String tag){\n    Span span = Span.current();   \n    //\u4fdd\u5b58 Baggage\n Baggage.current()\n   .toBuilder()\n   .put(\"app.username\", \"XYZ\")\n   .build()\n   .makeCurrent();\n......\n    ##\u8bf7\u6c42 resource\nhttpTemplate.getForEntity(APIUrl+\"/resource\",String.class).getBody();  \n</code></pre> <p>\u7136\u540e\u6211\u4eec\u4eceresource\u670d\u52a1\u4e2d\u83b7\u53d6Baggage\u4fe1\u606f\uff0c\u5e76\u628a\u5b83\u5b58\u50a8\u5230Span\u7684Attributes\u4e2d\u3002</p> <pre><code>@GetMapping(\"/resource\")\n@ResponseBody\npublic String resource(){\n String baggage = Baggage.current().getEntryValue(\"app.username\");\n Span spanCur = Span.current(); \n    ##\u83b7\u53d6\u5f53\u524d\u7684 Span\uff0c\u628a Baggage \u5199\u7684 resource\n spanCur.setAttribute(\"app.username\", \n                         \"baggage \u4f20\u9012\u8fc7\u6765\u7684 value: \"+baggage); \n</code></pre> <p>\u6700\u7ec8\uff0c\u6211\u4eec\u4ece\u8ddf\u8e2a\u7cfb\u7edf\u7684\u94fe\u8defUI\u4e2d\u70b9\u51fbsource\u8fd9\u4e2aSpan\uff0c\u627e\u5230\u4f20\u9012\u7684Baggage\u4fe1\u606f\u3002</p> <p></p> <p>\u5f53\u7136\uff0cBaggage\u62e5\u6709\u5f3a\u5927\u529f\u80fd\uff0c\u4e5f\u4f1a\u6709\u5f88\u5927\u7684\u6d88\u8017\u3002\u7531\u4e8eBaggage\u7684\u5168\u5c40\u4f20\u8f93\uff0c\u6bcf\u4e2a\u952e\u503c\u90fd\u4f1a\u88ab\u62f7\u8d1d\u5230\u6bcf\u4e00\u4e2a\u672c\u5730\uff08local\uff09\u53ca\u8fdc\u7a0b\u7684\u5b50Span\uff0c\u5982\u679c\u5305\u542b\u7684\u6570\u91cf\u91cf\u592a\u5927\uff0c\u6216\u8005\u5143\u7d20\u592a\u591a\uff0c\u5b83\u5c06\u964d\u4f4e\u7cfb\u7edf\u7684\u541e\u5410\u91cf\u6216\u589e\u52a0RPC\u7684\u5ef6\u8fdf\u3002</p>"},{"location":"chap_apm/3apm_tracing/#3-5","title":"3-5 \u94fe\u8def\u6dfb\u52a0\u4e1a\u52a1\u76d1\u63a7","text":"<p>\u6211\u4eec\u8fdb\u884c\u7cfb\u7edf\u94fe\u8def\u8ffd\u8e2a\uff0c\u9664\u4e86Trace\u672c\u8eab\u81ea\u5e26\u4fe1\u606f\uff0c\u5982\u679c\u6211\u4eec\u8fd8\u5e0c\u671b\u6dfb\u52a0\u81ea\u5df1\u5173\u6ce8\u7684\u76d1\u63a7\u3002Trace\u652f\u6301\u7528\u6253\u6807\u7b7eTags\u65b9\u5f0f\u6765\u5b9e\u73b0\u3002</p> <p>Tags\u672c\u8d28\u8fd8\u662fSpan\u7684 Attributes\uff08\u5728OpenTelemetry \u5b9a\u4e49\u4e2d\uff0c\u7edf\u79f0Attributes\u3002\u5728Prometheus\u3001Jaeger\u91cc\u9762\u6cbf\u88adTags\u8001\u7684\u53eb\u6cd5\uff09\u3002</p> <p>\u6253Tags\u7684\u8fc7\u7a0b\uff0c\u5176\u5b9e\u5c31\u662f\u5728Span\u6dfb\u52a0\u6211\u4eec\u81ea\u5b9a\u4e49\u7684Attributes\u4fe1\u606f\uff0c\u8fd9\u4e9bTags\u5927\u90e8\u5206\u548c\u6211\u4eec\u4e1a\u52a1\u606f\u606f\u76f8\u5173\uff0c\u4e3a\u4e86\u66f4\u65b9\u4fbf\u505a\u4e1a\u52a1\u76d1\u63a7\u3001\u5206\u6790\u4e1a\u52a1\u3002</p> <p>\u6211\u4eec\u770b\u4e00\u4e2aJava\u6253Tags\u7684\u4f8b\u5b50\uff1a\u9875\u9762\u5b9a\u4e49\u597d\u4e86\u4e00\u4e2aTag\uff0c\u540d\u5b57\u53eb\u201cusername\u201d\u3002\u6211\u4eec\u8f93\u5165Tags\u7684\u503c\uff0c\u7136\u540e\u628aTags\u901a\u8fc7\u4e00\u4e2aHTTP\u8bf7\u6c42\u53d1\u9001\u7ed9\u4ed8\u8d26\u5355\u7684API\u3002</p> <p></p> <p>API\u83b7\u53d6Tags\u540e\uff0c\u628a\u5b83\u4fdd\u5b58\u5230\u5f53\u524dSpan\u7684Attribute\u4e2d\u3002\u8fd9\u4e2aSpan\u5bf9\u5e94\u7684\u662f\u4ee3\u7801\u91cc\u9762\u7684\u4e00\u4e2aGateway\u65b9\u6cd5\uff0c\u5982\u679c\u4e0d\u91cd\u540dSpan\u540d\u79f0\uff0c\u9ed8\u8ba4\u4f7f\u7528Gateway\u4f5c\u4e3aSpan\u540d\u79f0\u3002</p> <pre><code>@GetMapping(\"/loadBalancer\")\npublic String gateway(String tag){\n   Span Span = Span.current();  \n   ##\u83b7\u53d6\u5f53\u524d Span\uff0c\u6dfb\u52a0 username \u7684 tag\n   Span.setAttribute(\"username\", tag);\n   ...... }\n</code></pre> <p>\u6253\u4e86Tags\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8ddf\u8e2a\u7cfb\u7edf\u641c\u7d22Tag\u5173\u952e\u5b57\u3002\u901a\u8fc7Tag\u53ef\u4ee5\u5feb\u901f\u627e\u5230\u5bf9\u5e94\u7684Trace\u3002</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6839\u636eTags\u7684key\u6211\u4eec\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7b5b\u9009\u60f3\u8981\u7684Span\u4fe1\u606f\u3002\u5b9e\u9645\u573a\u666f\u91cc\uff0c\u6211\u4eec\u9762\u4e34\u662f\u4ece\u6210\u5343\u4e0a\u4e07\u94fe\u8def\u4e2d\u5feb\u901f\u5b9a\u4f4d\u8bbf\u95ee\u5f02\u5e38\u7684\u8bf7\u6c42\u3002\u6253Tags\u5bf9\u6211\u4eec\u8bca\u65ad\u7a0b\u5e8f\u975e\u5e38\u6709\u5e2e\u52a9\u3002</p> <p>Baggage\u548cSpan Tags\u7684\u533a\u522b\uff1a</p> <ul> <li> <p>Baggage\u5728\u5168\u5c40\u8303\u56f4\u5185\uff0c\uff08\u4f34\u968f\u4e1a\u52a1\u7cfb\u7edf\u7684\u8c03\u7528\uff09\u5728\u6240\u6709Span\u95f4\u4f20\u8f93\u6570\u636e\u3002Tags\u4e0d\u4f1a\u8fdb\u884c\u4f20\u8f93\uff0c\u56e0\u4e3a\u4ed6\u4eec\u4e0d\u4f1a\u88ab\u5b50\u7ea7\u7684 Span \u7ee7\u627f\u3002</p> </li> <li> <p>Span\u7684Tags\u53ef\u4ee5\u7528\u6765\u8bb0\u5f55\u4e1a\u52a1\u76f8\u5173\u7684\u6570\u636e\uff0c\u5e76\u5b58\u50a8\u4e8e\u8ffd\u8e2a\u7cfb\u7edf\u4e2d\u3002</p> </li> </ul>"},{"location":"chap_apm/3apm_tracing/#3-4","title":"3-4 \u5168\u94fe\u8def\u517c\u5bb9\u6027\u8003\u8651","text":"<p>\u5728\u4e0d\u540c\u7684\u5e73\u53f0\u3001\u4e0d\u540c\u7684\u5f00\u53d1\u8bed\u8a00\u3001\u4e0d\u540c\u7684\u90e8\u7f72\u73af\u5883(\u5bb9\u5668\u975e\u5bb9\u5668\uff09\u4e0b\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u5e95\u5c42\u8ffd\u8e2a\u7cfb\u7edf\u5b9e\u73b0\u517c\u5bb9\u6027\uff0c\u5c06\u76d1\u63a7\u6570\u636e\u8bb0\u5f55\u5230\u4e00\u4e2a\u53ef\u63d2\u62d4\u7684Tracer\u4e0a\u3002\u5728\u7edd\u5927\u90e8\u5206\u901a\u7528\u7684\u5e94\u7528\u573a\u666f\u4e0b\uff0c\u8ffd\u8e2a\u7cfb\u7edf\u8003\u8651\u4f7f\u7528\u67d0\u4e9b\u9ad8\u5ea6\u5171\u8bc6\u7684\u952e\u503c\u5bf9\uff0c\u4ece\u800c\u5bf9\u8bca\u65ad\u5e94\u7528\u7cfb\u7edf\u66f4\u6709\u517c\u5bb9\uff0c\u901a\u7528\u6027\u3002</p> <p>\u8fd9\u4e2a\u5171\u8bc6\u79f0\u4e3a\u8bed\u4e49\u7ea6\u5b9aSemantic conventions\u3002</p> <p>\u4f60\u4f1a\u4ece\u4e0b\u9762\u4e00\u4e9b\u8bed\u4e49\u7ea6\u5b9a\u770b\u51faTrace\u505a\u4e86\u54ea\u4e9b\u517c\u5bb9\u6027\u3002</p> <ul> <li>General\uff1a\u901a\u7528\u7ea6\u5b9a\uff0c\u4e4b\u524d\u63d0\u5230\u7f51\u7edc\u8fde\u63a5Attributes\uff0c\u7ebf\u7a0bAttributes</li> <li>HTTP\uff1a\u9488\u5bf9HTTP\u8bf7\u6c42\u7684\u6570\u636e\u7ea6\u5b9a</li> <li>Database\uff1a\u6570\u636e\u5e93\u6570\u636e\u7ea6\u5b9a\uff0c\u5305\u62ecSQL\u548cNoSQL\u4e0d\u540c\u7c7b\u578b</li> <li>RPC/RMI\uff1a\u6709\u5173\u8fdc\u7a0b\u8c03\u7528\u7684\u7ea6\u5b9a</li> <li>Messaging\uff1a\u6709\u5173\u6d88\u606f\u7cfb\u7edf\u7684Span\u7ea6\u5b9a\uff0c\u4f8b\u5982MQ\u7684\u8ba2\u9605\u3001\u53d1\u5e03\u7b49</li> <li>Exceptions\uff1a\u9488\u5bf9\u5f02\u5e38\uff0c\u9519\u8bef\u72b6\u6001\u7b49</li> </ul> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u8bbf\u95eeHTTP\u7684\u5e94\u7528\u670d\u52a1\u5668\u3002\u5e94\u7528\u7cfb\u7edf\u5904\u7406\u8bf7\u6c42\u4e2d\u7684URL\u3001IP\u3001HTTP\u52a8\u4f5c\uff08get/post\u7b49\uff09\u3001\u8fd4\u56de\u7801\uff0c\u5bf9\u4e8e\u5e94\u7528\u7cfb\u7edf\u7684\u8bca\u65ad\u662f\u975e\u5e38\u6709\u5e2e\u52a9\u7684\u3002\u76d1\u63a7\u8005\u53ef\u4ee5\u9009\u62e9HTTP\u7ea6\u5b9a\u53c2\u6570\u8bb0\u5f55\u7cfb\u7edf\u72b6\u6001\uff0c\u50cf\u4e0b\u9762Trace\u5c55\u793a\u7684\u7ed3\u679c\u3002</p> <p></p> <p>Trace\u9ed8\u8ba4\u7684\u8bed\u4e49\u7ea6\u5b9a</p>"},{"location":"chap_apm/3apm_tracing/#4","title":"4 \u94fe\u8def\u6570\u636e\u5982\u4f55\u4f20\u64ad","text":"<p>\u5728Trace\u4f20\u9012\u4e2d\u6709\u4e00\u4e2a\u6838\u5fc3\u7684\u6982\u5ff5\uff0c\u53ebCarrier\uff08\u642c\u8fd0\u5de5\u5177\uff09\u3002\u5b83\u8868\u793a\u201c\u642c\u8fd0\u201dSpan\u4e2dSpanContext\u7684\u5de5\u5177\u3002</p> <p>\u6bd4\u65b9\u8bf4Trace\u4e3a\u4e86\u628aSpan\u4fe1\u606f\u4f20\u9012\u4e0b\u53bb\uff0c\u5728HTTP\u8c03\u7528\u573a\u666f\u4e2d\uff0c\u4f1a\u6709HttpCarrier\uff0c\u5728RPC\u7684\u8c03\u7528\u573a\u666f\u4e2d\u4f1a\u6709RpcCarrier\u6765\u642c\u8fd0SpanContext\u3002Trace\u901a\u8fc7Carrier\u53ef\u4ee5\u628a\u94fe\u8def\u8ffd\u8e2a\u72b6\u6001\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u201c\u642c\u8fd0\u201d\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u91cc\u3002 </p>"},{"location":"chap_apm/3apm_tracing/#4-1","title":"4-1 \u6570\u636e\u4f20\u64ad\u57fa\u672c\u64cd\u4f5c","text":"<p>\u4e3a\u4e86\u66f4\u6e05\u6670\u770b\u61c2\u6570\u636e\u4f20\u64ad\u7684\u8fc7\u7a0b\uff0c\u6211\u4eec\u5148\u4e86\u89e3Span\u5728\u4f20\u64ad\u4e2d\u6709\u7684\u57fa\u672c\u64cd\u4f5c\uff1a</p> <p>1\u3001StartSpan\uff1aTrace\u5728\u5177\u4f53\u64cd\u4f5c\u4e2d\u81ea\u52a8\u751f\u6210\u4e00\u4e2aSpan</p> <p>2\u3001Inject\u6ce8\u5165\uff1a\u5c06Span\u7684SpanContext\u5199\u5165\u5230Carrier\u7684\u8fc7\u7a0b</p> <p>\u94fe\u8def\u6570\u636e\u4e3a\u4e86\u8fdb\u884c\u7f51\u7edc\u4f20\u8f93\uff0c\u9700\u8981\u6570\u636e\u8fdb\u884c\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u3002\u8fd9\u4e2a\u8fc7\u7a0bTrace\u901a\u8fc7\u4e00\u4e2a\u8d1f\u8d23\u6570\u636e\u5e8f\u5217\u5316\u53cd\u5e8f\u5217\u5316\u4e0a\u4e0b\u6587\u7684Formatter\u63a5\u53e3\u5b9e\u73b0\u7684\u3002</p> <p>\u4f8b\u5982\u5728HttpCarrier\u4f7f\u7528\u4e2d\u901a\u5e38\u5c31\u4f1a\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684HttpFormatter\u3002\u6240\u4ee5Inject\u6ce8\u5165\u662f\u59d4\u6258\u7ed9Formatter\u5c06SpanContext\u8fdb\u884c\u5e8f\u5217\u5316\u5199\u5165Carrier\u3002</p> <p>Formatter\u63d0\u4f9b\u4e0d\u540c\u573a\u666f\u5e8f\u5217\u5316\u7684\u6570\u636e\u683c\u5f0f\uff0c\u53eb\u505aFormat\u63cf\u8ff0\u3002\u6bd4\u5982\uff1a</p> <ul> <li>Text Map\uff1a\u57fa\u4e8e\u5b57\u7b26\u4e32\u7684Map\u8bb0\u5f55SpanContext\u4fe1\u606f\uff0c\u9002\u7528RPC\u7f51\u7edc\u4f20\u8f93</li> <li>HTTP Headers\uff1a\u65b9\u4fbf\u89e3\u6790HTTP Headers\u4fe1\u606f\uff0c\u7528\u4e8eHTTP\u4f20\u8f93</li> </ul> <p>\u4e00\u4e2aPython\u7a0b\u5e8f\u5b9e\u73b0Inject\u6ce8\u5165\u8fc7\u7a0b\uff0cFormatter\u5e8f\u5217\u5316SpanContext\u6210Text Map\u683c\u5f0f\u3002</p> <pre><code>##Trace \u751f\u6210\u4e00\u4e2aspan\n    tracer = Tracer()\n    span = tracer.start_span(operation_name='test')\n    tracer.inject(\n        span_context=span.context,\n        format=Format.TEXT_MAP,\n        carrier=carrier)\n</code></pre> <p>3\u3001Extract\u63d0\u53d6\uff1a\u5c06SpanContext\u4eceCarrier\u4e2dExtract\uff08\u63d0\u53d6\u51fa\u6765\uff09\u3002</p> <pre><code>span_ctx = tracer.extract(format=Format.TEXT_MAP, carrier={})\n</code></pre> <p>\u540c\u7406\uff0c\u4eceCarrier\u63d0\u53d6\u7684\u8fc7\u7a0b\u4e5f\u9700\u8981\u59d4\u6258Formatter\u5c06SpanContext\u53cd\u5e8f\u5217\u5316\u3002</p>"},{"location":"chap_apm/3apm_tracing/#4-1_1","title":"4-1 \u8fd0\u884c\u539f\u7406","text":"<p>\u94fe\u8def\u6570\u636e\u5728HTTP\u4f20\u9012</p> <p>\u6211\u4eec\u57fa\u4e8eHTTP\u901a\u4fe1\u89e3\u91ca\u4f20\u64ad\u539f\u7406\u3002\u7531\u56fe\u4e00\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5927\u81f4\u5206\u4e3a\u4e24\u6b65\uff1a</p> <p>1\u3001\u53d1\u9001\u7aef\u5c06 SpanContext \u6ce8\u5165\u5230\u8bf7\u6c42\u4e2d\uff0c\u76f8\u5e94\u4f2a\u4ee3\u7801\u5b9e\u73b0</p> <pre><code>/**\n** \u5c06 SpanContext \u4e2d\u7684 TraceId\uff0cSpanId\uff0cBaggage \u7b49\u6839\u636e format \u53c2\u6570\u6ce8\u5165\u5230\u8bf7\u6c42\u4e2d\uff08Carrier\uff09\n** carrier := opentracing.HTTPHeadersCarrier(httpReq.Header)\n** err := Tracer.Inject(Span.Context(), opentracing.HTTPHeaders, carrier)\n**/\nInject(sm SpanContext, format interface{}, carrier interface{}) error\n</code></pre> <p>2\u3001\u63a5\u6536\u7aef\u4ece\u8bf7\u6c42\u4e2d\u89e3\u6790\u51faSpanContext\uff0c\u76f8\u5e94\u4f2a\u4ee3\u7801\u5b9e\u73b0</p> <pre><code>// Inject() takes the `sm` SpanContext instance and injects it for\n// propagation within `carrier`. The actual type of `carrier` depends on\n/** \u6839\u636e format \u53c2\u6570\u4ece\u8bf7\u6c42\uff08Carrier\uff09\u4e2d\u89e3\u6790\u51fa SpanContext\uff08\u5305\u62ec TraceId\u3001SpanId\u3001baggage\uff09\u3002\n** \u4f8b\u5982\uff1a \n**  carrier := opentracing.HTTPHeadersCarrier(httpReq.Header)\n**  clientContext, err := Tracer.Extract(opentracing.HTTPHeaders, carrier)\n**/\nExtract(format interface{}, carrier interface{}) (SpanContext, error)\n</code></pre> <p>Carrier\u8d1f\u8d23\u5c06\u8ffd\u8e2a\u72b6\u6001\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u201cCarry\u201d\uff08\u642c\u8fd0\uff09\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u3002\u5bf9\u4e8e\u4e00\u4e2aCarrier\uff0c\u5982\u679c\u5df2\u7ecf\u88abInjected\uff0c\u90a3\u4e48\u5b83\u4e5f\u53ef\u4ee5\u88abExtracted\uff08\u63d0\u53d6\uff09\uff0c\u4ece\u800c\u5f97\u5230\u4e00\u4e2aSpanContext\u5b9e\u4f8b\u3002\u8fd9\u4e2aSpanContext\u4ee3\u8868\u7740\u88abInjected\u5230Carrier\u7684\u4fe1\u606f\u3002</p> <p>\u8bf4\u5230\u8fd9\u91cc\uff0c\u4f60\u53ef\u80fd\u60f3\u77e5\u9053\u8fd9\u4e2aCarrier\u5728HTTP\u4e2d\u5177\u4f53\u5728\u54ea\u3002\u5176\u5b9e\u5b83\u5c31\u4fdd\u5b58\u5230HTTP\u7684Headers\u4e2d\u3002\u800c\u4e14\uff0cW3C\u7ec4\u7ec7\u4e3aHTTP\u652f\u6301\u94fe\u8def\u8ffd\u8e2a\u4e13\u95e8\u5728Headers\u4e2d\u5b9a\u4e49\u4e86Trace\u6807\u51c6\uff1a</p> <p>https://www.w3.org/TR/trace-context/#trace-context-http-headers-format</p> <p>W3C\u7ec4\u7ec7\u662f\u5bf9\u7f51\u7edc\u6807\u51c6\u5236\u5b9a\u7684\u4e00\u4e2a\u975e\u76c8\u5229\u7ec4\u7ec7\uff0cW3C\u662f\u4e07\u7ef4\u7f51\u8054\u76df\u7684\u7f29\u5199\uff0c\u50cfHTML\u3001XHTML\u3001CSS\u3001XML\u7684\u6807\u51c6\u5c31\u662f\u7531W3C\u6765\u5b9a\u5236\u3002</p>"},{"location":"chap_apm/3apm_tracing/#4-2","title":"4-2 \u8de8\u8fdb\u7a0b\u95f4\u4f20\u64ad\u6570\u636e","text":"<p>\u6570\u636e\u4f20\u64ad\u6309\u7167\u573a\u666f\u5206\u4e3a\u4e24\u7c7b\uff1a\u8fdb\u7a0b\u5185\u4f20\u64ad\u3001\u8de8\u8fdb\u7a0b\u95f4\u4f20\u64ad<code>Cross-Process-Tracing</code>\u3002</p> <p>\u8fdb\u7a0b\u5185\u4f20\u64ad\u662f\u6307Trace\u5728\u4e00\u4e2a\u670d\u52a1\u5185\u90e8\u4f20\u9012\uff0c\u76d1\u63a7\u4e86\u670d\u52a1\u5185\u90e8\u76f8\u4e92\u8c03\u7528\u60c5\u51b5\uff0c\u76f8\u5f53\u6bd4\u8f83\u7b80\u5355\u3002\u8ffd\u8e2a\u7cfb\u7edf\u6700\u56f0\u96be\u7684\u90e8\u5206\u5c31\u662f\u5728\u5206\u5e03\u5f0f\u7684\u5e94\u7528\u73af\u5883\u4e0b\u4fdd\u6301\u8ffd\u8e2a\u7684\u6b63\u5e38\u5de5\u4f5c\u3002\u4efb\u4f55\u4e00\u4e2a\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u90fd\u9700\u8981\u7406\u89e3\u591a\u4e2a\u8de8\u8fdb\u7a0b\u8c03\u7528\u95f4\u7684\u56e0\u679c\u5173\u7cfb\uff0c\u65e0\u8bba\u4ed6\u4eec\u662f\u901a\u8fc7RPC\u6846\u67b6\u3001\u53d1\u5e03-\u8ba2\u9605\u673a\u5236\u3001\u901a\u7528\u6d88\u606f\u961f\u5217\u3001HTTP\u8bf7\u6c42\u8c03\u7528\u3001UDP\u4f20\u8f93\u6216\u8005\u5176\u4ed6\u4f20\u8f93\u6a21\u5f0f\u3002\u6240\u4ee5\u4e1a\u754c\u8c08\u8d77Tracing\u6280\u672f \u5f80\u5f80\u8bf4\u7684\u662f\u8de8\u8fdb\u7a0b\u95f4\u7684\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\uff08Distrubute Tracing\uff09\u3002</p> <p>\u6211\u4eec\u7528OpenTelemetry\u5b9e\u8df5\u4e00\u4e2aHTTP\u901a\u4fe1\u7684Trace\u4f8b\u5b50\uff1a</p> <p>\u8fd9\u662f\u4e00\u4e2a\u672c\u5730Localhost\u7684Java\u7a0b\u5e8f\uff0c\u6211\u4eec\u5411\u4e0b\u6e38\u670d\u52a1192.168.0.100\u53d1\u8d77\u4e00\u4e2aHTTP\u8bf7\u6c42\u3002</p> <p>\u7a0b\u5e8f\u4e2d\u4f7f\u7528OpenTelemetry\u7684inject\u6ce8\u5165\uff0c\u901a\u8fc7HTTP Headers\u628aLocalhost\u7684Trace\u4f20\u9012\u7ed9192.168.0.100\u7684\u4e0b\u6e38\u670d\u52a1\u3002\u4f20\u64ad\u524d\uff0c\u624b\u52a8\u8fd8\u521b\u5efa\u4e24\u4e2a\u60f3\u8981\u4e00\u5757\u4f20\u64ad\u7684Attributes\u3002</p> <pre><code>@GetMapping(\"/contextR\")\n@ResponseBody\npublic String contextR() {\n TextMapSetter&lt;HttpURLConnection&gt; setter = new TextMapSetter&lt;HttpURLConnection&gt;() {\n  @Override\n  public void set(HttpURLConnection carrier, String key, String value) {\n   // \u6211\u4eec\u628a\u4e0a\u4e0b\u6587\u653e\u5230 HTTP \u7684 Header\n   carrier.setRequestProperty(key, value);\n  }\n };\n Span spanCur = Span.current();\n Span outGoing = tracer.spanBuilder(\"/resource\").setSpanKind(SpanKind.CLIENT).startSpan();\n try {\n  URL url = new URL(\"http://192.168.0.100:8080/resource\");\n  HttpURLConnection transportLayer = (HttpURLConnection) url.openConnection();\n  outGoing.setAttribute(\"http.method\", \"GET\");\n  outGoing.setAttribute(\"http.url\", url.toString());   \n  // \u5c06\u5f53\u524d Span \u7684\u4e0a\u4e0b\u6587\u6ce8\u5165\u5230\u8fd9\u4e2a HTTP \u8bf7\u6c42\u4e2d\n  OpenTelemetry.getPropagators().getTextMapPropagator().inject(Context.current(), transportLayer, setter);\n  // Make outgoing call\n...\n</code></pre> <p>\u8fd0\u884c\u7a0b\u5e8f\uff0c\u4ece\u76d1\u63a7\u5e73\u53f0\u6211\u4eec\u770b\u5230\uff0cTrace\u4ece\u672c\u5730\u7684\u7a0b\u5e8f\u6210\u529f\u4f20\u9012\u5230\u4e86192.168.0.100\u3002</p> <p></p>"},{"location":"chap_apm/3apm_tracing/#5-trace","title":"5 \u624b\u52a8\u63a7\u5236Trace\uff1a\u81ea\u52a8\u6784\u5efa","text":"<p>\u4e0a\u9762\u6211\u4eec\u63d0\u5230Trace\uff0c\u90fd\u662f\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u81ea\u52a8\u5b8c\u6210\u7684\u3002\u867d\u7136\u8fd9\u5f88\u901a\u7528\uff0c\u4f46\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u6211\u4eec\u6709\u4e9b\u65f6\u5019\u8fd8\u60f3\u67e5\u770b\u66f4\u591a\u7684\u8ddf\u8e2a\u7ec6\u8282\u548c\u6dfb\u52a0\u4e1a\u52a1\u76d1\u63a7\u3002\u94fe\u8def\u8ffd\u8e2a\u6280\u672f\u652f\u6301\u5e94\u7528\u7a0b\u5e8f\u5f00\u53d1\u4eba\u5458\u624b\u5de5\u65b9\u5f0f\u5728\u8ddf\u8e2a\u7684\u8fc7\u7a0b\u4e2d\u6dfb\u52a0\u989d\u5916\u7684\u4fe1\u606f\uff0c\u751a\u81f3\u624b\u52a8\u542f\u52a8Span\uff0c\u4ee5\u671f\u5f85\u76d1\u63a7\u66f4\u9ad8\u7ea7\u522b\u7684\u7cfb\u7edf\u884c\u4e3a\uff0c\u6216\u5e2e\u52a9\u8c03\u8bd5\u95ee\u9898\u3002</p> <p>OpenTelemetry\u652f\u6301\u4ee5SDK\u548cAPI\u65b9\u5f0f\u624b\u52a8\u6784\u5efaTrace\u3002API\u3001SDK\u90fd\u53ef\u4ee5\u505a\u4e00\u4e9b\u57fa\u672cTrace\u64cd\u4f5c\uff0c\u53ef\u4ee5\u7406\u89e3API\u662fMin\u5b9e\u73b0\uff0cSDK\u662fAPI\u7684\u8d85\u96c6\u3002\u751f\u4ea7\u73af\u5883\u6839\u636e\u5b9e\u9645\u573a\u666f\u9009\u62e9\u7528\u54ea\u4e00\u4e2a\u3002</p> <p></p>"},{"location":"chap_apm/3apm_tracing/#5-1-span","title":"5-1 \u521b\u5efaSpan","text":"<p>\u8981\u521b\u5efaSpan\uff0c\u53ea\u9700\u6307\u5b9aSpan\u7684\u540d\u79f0\u3002\u624b\u52a8\u521b\u5efaSpan\u9700\u8981\u663e\u5f0f\u7ed3\u675f\u64cd\u4f5c\uff0c\u5b83\u7684\u5f00\u59cb\u548c\u7ed3\u675f\u65f6\u95f4\u7531\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\u81ea\u52a8\u8ba1\u7b97\u3002Java\u4ee3\u7801\u5b9e\u4f8b\uff1a</p> <pre><code>Span Span = Tracer.SpanBuilder(\"\u624b\u5de5\u521b\u5efa SpanOne\").startSpan();\ntry{\n......\n} finally {\n    Span.end(); //\u624b\u52a8\u521b\u5efa Span\uff0c\u6211\u4eec\u9700\u8981\u624b\u52a8\u7ed3\u675f Span\n}\n</code></pre> <p>\u5e94\u7528\u7a0b\u5e8f\u8fd0\u884c\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u83b7\u53d6\u4e00\u4e2aSpan\u3002</p> <pre><code>Span Span = Span.current()\n</code></pre>"},{"location":"chap_apm/3apm_tracing/#5-2-span","title":"5-2 \u521b\u5efa\u5e26\u94fe\u63a5Span","text":"<p>\u4e00\u4e2aSpan\u53ef\u4ee5\u8fde\u63a5\u4e00\u4e2a\u6216\u591a\u4e2a\u56e0\u679c\u76f8\u5173\u7684\u5176\u4ed6Span\u3002\u5b9e\u4f8b\u4e2d\u6211\u4eec\u521b\u5efa\u4e00\u4e2aSpan\u3002</p> <p>\u53eb\u505a\u201c\u624b\u5de5\u521b\u5efaSpanOne\u201d\uff0c\u7136\u540e\u5206\u522b\u521b\u5efa\u4e86\u4e09\u4e2aSpan\uff0c\u901a\u8fc7link\u628a\u5b83\u4eec\u5173\u8054\u6210\u5b69\u5b50Span\u3002\u6700\u540e\u53c8\u521b\u5efa\u4e86\u4e00\u4e2aSpan \u201cchildThree-Child\u201d\uff0c\u628a\u5b83\u4f5c\u4e3a\u201cchildThree\u201d\u7684\u5b69\u5b50Span \u5173\u8054</p> <pre><code>@GetMapping(\"/createSpanAndLink\")\npublic String createSpanAndLink() {\n    String SpanName = \"\u624b\u5de5\u521b\u5efa SpanOne\";\n    //\u521b\u5efa\u4e00\u4e2a Span\uff0c\u7136\u540e\u521b\u5efa\u4e09\u4e2a child Span\uff0c\u6700\u540e\u5173\u8054 Span\n    Span SpanOne = Tracer.SpanBuilder(SpanName)             \n            .startSpan();\n    Span childSpan = Tracer.SpanBuilder(\"childOne\")\n            .addLink(SpanOne.getSpanContext()).startSpan();\n    Span childSpan2 = Tracer.SpanBuilder(\"childTwo\")\n            .addLink(SpanOne.getSpanContext()).startSpan();\n    Span childSpan3 = Tracer.SpanBuilder(\"childThree\")\n            .addLink(SpanOne.getSpanContext()).startSpan();\n    //\u521b\u5efa\u4e00\u4e2a Span\uff0c\u5173\u8054 childSpan3,\u4f5c\u4e3a\u5b83\u7684 childSpan\n    Span childSpan3Child = Tracer.SpanBuilder(\"childThree-Child\")\n            .addLink(childSpan3.getSpanContext()).startSpan();\n}\n</code></pre> <p>\u6211\u4eec\u770b\u770b\u8fd0\u884c\u7a0b\u5e8f\u540e\uff0c\u6536\u96c6\u7684Trace\u7684\u6548\u679c\uff1aLink\u5c06\u5404\u4e2aSpan\u8fde\u63a5\u8d77\u6765\u3002</p> <p></p>"},{"location":"chap_apm/3apm_tracing/#5-3-span","title":"5-3 \u521b\u5efa\u5e26\u4e8b\u4ef6\u7684Span","text":"<p>Span\u53ef\u4ee5\u643a\u5e26\u96f6\u4e2a\u6216\u591a\u4e2aSpan\u5c5e\u6027\u7684\u547d\u540d\u4e8b\u4ef6\u8fdb\u884c\u6ce8\u91ca\uff0c\u6bcf\u4e00\u4e2a\u4e8b\u4ef6\u90fd\u662f\u4e00\u4e2a key:value\u952e\u503c\u5bf9\uff0c\u5e76\u81ea\u52a8\u643a\u5e26\u76f8\u5e94\u7684\u65f6\u95f4\u6233\u3002\u65f6\u95f4\u6233\u8868\u793a\u4e8b\u4ef6\u7684\u6301\u7eed\u65f6\u95f4\u3002</p> <pre><code>@GetMapping(\"/event\")\npublic String event(){\n Span span = Span.current();    \n span.updateName(\"\u521b\u5efa eventDemo\"); \n //\u624b\u52a8\u66f4\u65b0 Event \u6301\u7eed\u65f6\u95f4\n    span.addEvent(\"timeEvent\",System.currentTimeMillis()+2000, \n                  TimeUnit.MILLISECONDS);  \n    //\u7ed9 Event \u6dfb\u52a0\u76f8\u5173\u4fe1\u606f\n    Attributes appInfo = Attributes.of(AttributeKey\n                         .stringKey(\"app.id\"), \"123456\",\n                    AttributeKey.stringKey(\"app.name\"), \"\u5e94\u7528\u7a0b\u5e8f demo\");     span.addEvent(\"auth.appinfo\", appInfo);  \n    logger.info(\"this is a event\"); }\n</code></pre> <p>\u5728\u4e0a\u9762\u7a0b\u5e8f\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u7ed9\u4e8b\u4ef6\u624b\u52a8\u6dfb\u52a0\u65f6\u95f4\u6233\uff0c\u8fd9\u5728\u590d\u6742\u7cfb\u7edf\u73af\u5883\u4e0b\u8fd8\u539f\u771f\u5b9e\u6301\u7eed\u4e8b\u4ef6\u5f88\u6709\u610f\u4e49\u7684\u3002\u770b\u770b\u8fd0\u884c\u7a0b\u5e8f\u540e\uff0c\u8ffd\u8e2a\u5e73\u53f0\u4e0bSpan\u751f\u6210\u7684\u7684\u6548\u679c\uff1a</p> <p></p>"},{"location":"chap_apm/3apm_tracing/#6","title":"6 \u6570\u636e\u5982\u4f55\u4e0a\u62a5","text":"<p>\u6709\u4e86\u7a0b\u5e8f\u7684Trace\u6570\u636e\uff0c\u5305\u542bTraceId\u3001Span\u3001Spancontext\u4e00\u7cfb\u5217\u6570\u636e\u3002\u63a5\u4e0b\u6765\u9700\u8981\u4e0a\u62a5\u5230\u76d1\u63a7\u7cfb\u7edf\uff0c\u901a\u8fc7\u89c6\u56fe\u65b9\u5f0f\u5c55\u793a\u51faTrace\u6574\u4e2a\u5168\u8c8c\u3002\u6211\u4eec\u4e60\u60ef\u628aTrace\u6570\u636e\u4e0a\u62a5\u5230\u76d1\u63a7\u8fc7\u7a0b\u79f0\u4e3a\u6570\u636e\u6536\u96c6\uff08Data Collection\uff09\u3002\u770b\u770b\u6570\u636e\u6536\u96c6\u57fa\u672c\u539f\u7406\uff1a</p> <p></p> <p>\u4ece\u56fe\u4e2d\uff0c\u770b\u5230\u94fe\u8def\u6536\u96c6\u8fc7\u7a0b\u4e2d\uff0c\u6570\u636e\u4e0a\u62a5\u6838\u5fc3\u7684\u51e0\u4e2a\u7ec4\u4ef6\uff1a</p> <ul> <li>Collector\uff1a\u6570\u636e\u6536\u96c6\u7684\u5904\u7406\u5668\uff0c\u5b83\u540c\u65f6\u89e3\u6790\u3001\u52a0\u5de5\u76d1\u63a7\u6570\u636e\uff0c\u76ee\u7684\u662f\u7ed9\u76d1\u63a7\u5c55\u793a\u5e73\u53f0\u66f4\u76f4\u89c2\u7684\u89c6\u56fe\uff0c\u4fbf\u6377\u7684\u67e5\u8be2\u3002</li> <li>Exporters\uff1a\u91c7\u96c6\u5668\uff0c\u4ece\u54ea\u4e2a\u5e94\u7528\u7a0b\u5e8f\u83b7\u5f97Trace\u6570\u636e\uff0c\u76ee\u524d\u4e3b\u6d41\u8ddf\u8e2a\u7cfb\u7edf\u51e0\u4e4e\u53ef\u4ee5\u652f\u6301\u4efb\u4f55\u8bed\u8a00\u5e73\u53f0\u4e0b\u5f00\u53d1\u7a0b\u5e8f\uff0c\u5e76\u4e14\u517c\u5bb9\u4e3b\u6d41\u64cd\u4f5c\u7cfb\u7edf\u548c\u5bb9\u5668\u3002\u4e3a\u4e86\u652f\u6301Trace\u6807\u51c6\u5316\u5230\u8fd9\u79cd\u7a0b\u5e8f\uff0c\u5de5\u7a0b\u5e08\u53ef\u8c13\u5455\u5fc3\u6ca5\u8840\uff0c\u4e2d\u95f4\u8fc7\u7a0b\u6781\u4e0d\u5bb9\u6613\u3002</li> </ul> <p>Data Collection\u5728\u6570\u636e\u91c7\u96c6\u65f6\u5019\uff0cCollector\u548cExporters\u6709\u4e24\u79cd\u5b9e\u73b0\uff1aAgent\u548cGateway\u3002\u9650\u4e8e\u7bc7\u5e45\uff0c\u6211\u4eec\u5728\u540e\u9762\u6587\u7ae0\u8be6\u7ec6\u7ed9\u5927\u5bb6\u8bb2\u89e3\u3002</p>"},{"location":"chap_apm/3apm_tracing/#7","title":"7 \u603b\u7ed3","text":"<p>\u4eca\u5929\u8bb2\u89e3\u4e86\u94fe\u8def\u8ffd\u8e2a\u7684\u6570\u636e\u4f20\u64ad\u3001\u6570\u636e\u4e0a\u62a5\u7684\u539f\u7406\u3002\u5982\u679c\u4f60\u60f3\u52a8\u624b\u5b9e\u8df5\u6587\u7ae0\u4e2d\u7684\u4ee3\u7801, GitHub\u5f00\u653e\u4e86\u5730\u5740\uff1ahttps://github.com/laziobird/opentelemetry-jaeger</p> <p>APM\u4e3a\u6211\u4eec\u7ebf\u4e0a\u5e94\u7528\u7a0b\u5e8f\u5728\u6545\u969c\u5b9a\u4f4d\u3001\u6027\u80fd\u8c03\u4f18\u8d77\u5230\u5de8\u5927\u4f5c\u7528\u3002\u540c\u65f6\uff0c\u6211\u8fd8\u4f1a\u57fa\u4e8eAPM\u8c08\u8c08\u5b9e\u9645\u9879\u76ee\u4e2d\uff0c\u6bd4\u5982\u5bb9\u5668\uff08Kubernetes\uff09\u3001\u670d\u52a1\u7f51\u683c\uff08Istio\uff09\u73af\u5883\u4e0b\uff0cTrace\u6570\u636e\u91c7\u96c6\u5177\u4f53\u5b9e\u73b0\u548c\u5982\u4f55\u505a\u76d1\u63a7\u3002</p>"},{"location":"chap_apm/4apm_prod/","title":"4 \u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5982\u4f55\u9009\u62e9\u9760\u8c31\u7684APM\u7cfb\u7edf\uff1f","text":""},{"location":"chap_apm/4apm_prod/#1-apm","title":"1 APM \u73b0\u72b6","text":"<p>\u6211\u4eec\u7528\u4e00\u5f20\u56fe\u63cf\u8ff0\u4e0b APM \u5728\u7cfb\u7edf\u7a33\u5b9a\u6027\u4fdd\u969c\u7684\u4f4d\u7f6e\uff1a</p> <p></p> <p>\u76ee\u524d APM \u5f00\u6e90\u3001\u5546\u4e1a\u5316\u4ea7\u54c1\u6bd4\u8f83\u6210\u719f\uff0c\u5927\u90e8\u5206\u516c\u53f8\u751f\u4ea7\u73af\u5883\u90fd\u90e8\u7f72\u4e86 APM \u7cfb\u7edf\u3002\u672c\u6587\u4ece\u4e3b\u6d41 APM \u4ea7\u54c1\u4ecb\u7ecd\u51fa\u53d1\uff0c\u901a\u8fc7\u751f\u4ea7\u73af\u5883\u4e2d\u5173\u6ce8\u7684\u51e0\u4e2a\u91cd\u8981\u7ef4\u5ea6\uff0c\u7ed9\u5230\u5927\u5bb6\u4e00\u4e9b\u9002\u5408\u81ea\u8eab\u516c\u53f8\u573a\u666f\u7684 APM \u9009\u578b\u65b9\u6848\u5efa\u8bae\u3002</p>"},{"location":"chap_apm/4apm_prod/#2","title":"2 \u4e3b\u6d41\u7ade\u54c1\u6982\u8ff0","text":"<p>\u6211\u5e26\u5927\u5bb6\u5927\u81f4\u56de\u987e\u4e0b\u76ee\u524d\u56fd\u5185\u3001\u5916\u90fd\u6709\u54ea\u4e9b\u6bd4\u8f83\u6709\u53e3\u7891\u548c\u5e02\u573a\u5360\u6709\u7387\u7684 APM \u76d1\u63a7\u4ea7\u54c1\uff1a</p> <p></p> <ul> <li>\u9664\u4e0a\u9762\u63d0\u53ca\u4ea7\u54c1 \uff0c\u5e02\u9762\u4e0a\u8fd8\u6709\u8b6c\u5982\uff1a\u5f00\u6e90 ZipKin\u3001Elastic APM\u3001Dynatrace\u3001\u56fd\u5185\u7684 OneAPM\u3001\u535a\u777f\u7b49\u3002\u9650\u4e8e\u7bc7\u5e45\u548c\u4e2a\u4eba\u4e86\u89e3\u7a0b\u5ea6\uff0c\u672c\u6587\u4e0d\u505a\u5bf9\u6bd4\u3002\u6211\u4e3b\u8981\u6536\u5f55\u7684\u5224\u5b9a\u7ef4\u5ea6\uff1a</li> <li>\u4ea7\u54c1\u4f53\u9a8c\uff1a\u4fa7\u91cd\u751f\u4ea7\u73af\u5883\u7684 APM \u529f\u80fd\u4e0a\u6613\u7528\u6027\u3001\u5b9e\u7528\u6027\uff0c\u4e2a\u4eba\u559c\u597d\u7a0b\u5ea6\u3002</li> <li>\u6570\u636e\u91c7\u6837\uff1a\u5f88\u591a APM \u5728\u751f\u4ea7\u73af\u5883\u4e2d\u6536\u96c6\u94fe\u8def\u6570\u636e\u8fc7\u591a\uff0c\u4f1a\u9047\u5230\u5f88\u591a\u6027\u80fd\u95ee\u9898\u3002\u7279\u522b\u5927\u578b\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\uff0cAPM \u91c7\u6837\u80fd\u529b\u3001\u5b58\u50a8\u80fd\u529b\u51b3\u5b9a APM \u7684\u9760\u8c31\u7a0b\u5ea6\u3002</li> <li>Agent\u80fd\u529b\uff1a\u4ece Agent \u7684\u6280\u672f\u751f\u6001\u3001\u652f\u6301\u7ec4\u4ef6\u3001\u5f00\u53d1\u8bed\u8a00\u80fd\u529b\u3002\u53ef\u80fd\u5f88\u591a\u516c\u53f8\u751f\u4ea7\u7cfb\u7edf\u5728\u8fd9\u4e2a\u7ef4\u5ea6\u5c31\u5df2\u7ecf\u505a\u4e86APM\u7684\u9009\u578b\u4e86\u3002\u6bd4\u5982\u4f60\u662f .Net \u4e1a\u52a1\u7cfb\u7edf\uff0c\u4e0a\u9762\u63d0\u5230\u4e00\u5927\u534a\u538b\u6839\u4e0d\u652f\u6301\u3002</li> <li>\u62a5\u8b66 + DB \u652f\u6301\uff1a\u9884\u8b66\u3001\u544a\u8b66\u7684\u80fd\u529b\u3001\u5bf9\u8c03\u7528\u94fe\u8def\u4e2d\u6700\u5178\u578b\u6570\u636e\u5e93\u652f\u6301\u80fd\u529b\u3002</li> <li>\u4e91\u539f\u751f\u7684\u652f\u6301\u80fd\u529b\uff1a\u5728 Kubernetes \u548c Istio \u751f\u4ea7\u73af\u5883\u7684\u6210\u719f\u5ea6\uff0c\u8fd9\u4e2a\u95e8\u69db\u4e5f\u6392\u9664\u4e86\u5f88\u591a APM\uff0c\u7279\u522b\u662f\u4e00\u4e9b\u5f00\u6e90\u4ea7\u54c1\uff0c\u8fd9\u5757\u666e\u904d\u505a\u5f97\u4e0d\u7406\u60f3\u3002</li> <li>\u6570\u636e\u5927\u5c4f\uff1a\u9898\u5916\u8bdd\uff0c\u6570\u636e\u5927\u5c4f\u662f\u516c\u53f8\u671f\u671b\u5bf9\u6027\u80fd\u76d1\u63a7\u5de5\u5177\u52a0\u5f3a\u4e1a\u52a1\u76d1\u63a7\u7684\u4f53\u73b0\u3002</li> <li>\u793e\u533a\u548c\u6587\u6863\u652f\u6301\uff1a\u4ea7\u54c1\u5bf9\u5e94\u7684\u6280\u672f\u793e\u533a\u6210\u719f\u5ea6\u548c\u4ea7\u54c1\u6587\u6863\u7684\u8d28\u91cf</li> <li>\u5176\u5b83\uff1a\u65e5\u5fd7\u3001\u6570\u636e\u5927\u5c4f\uff0c\u81ea\u68c0\uff0c\u5b58\u50a8\u80fd\u529b\u3002\u9650\u4e8e\u4f18\u5148\u7ea7\u548c\u672c\u6587\u7bc7\u5e45\uff0c\u4ee5\u540e\u505a\u66f4\u591a\u76f8\u5173\u5206\u4eab</li> </ul>"},{"location":"chap_apm/4apm_prod/#3","title":"3 \u4ea7\u54c1\u4f7f\u7528\u4f53\u9a8c","text":"<p>\u6838\u5fc3\u529f\u80fd\uff1a\u4e1a\u52a1\u94fe\u8def\u56fe\u3001\u94fe\u8def\u8ffd\u8e2a\u5206\u6790\u3002</p> <p>\u4eae\u70b9\uff1aPinpoint \u7684\u76d1\u63a7\u94fe\u8def\u89c6\u56fe\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\u7528\u7684\u6bd4\u8f83\u987a\u624b\u3002</p> <p>\u63a8\u8350\u7406\u7531\uff1a\u4e1a\u52a1\u94fe\u8def\u56fe\u66f4\u76f4\u89c2\u3001\u94fe\u8def\u8ffd\u8e2a\u5206\u6790\u66f4\u61c2\u4e1a\u52a1\u3002</p> <p></p> <p>Pinpoint \u94fe\u8def\u5206\u6790\u6307\u6807\u4e30\u5bcc\u3001\u4ece\u62d3\u6251\u56fe\u94bb\u53d6\u8be6\u7ec6\u94fe\u8def\u66f4\u9ad8\u6548\uff1a</p> <p></p> <p>\u5907\u6ce8\uff1a\u4e00\u822c\u6210\u719f\u7684 APM\uff0c\u8003\u8651\u5230\u6570\u636e\u5e93\u6838\u5fc3\u573a\u666f\uff0c\u5728\u8c03\u7528\u94fe\u4e2d\uff0c\u4e00\u822c\u652f\u6301 SQL \u4f20\u53c2\u5b8c\u6574\u663e\u793a\u3002</p>"},{"location":"chap_apm/4apm_prod/#4","title":"4 \u6570\u636e\u91c7\u6837","text":"<p>\u8c03\u7528\u94fe\u6570\u636e\u603b\u4f53\u4f53\u91cf\u4e0e\u4e1a\u52a1\u4f53\u91cf\u6b63\u76f8\u5173\uff0c\u5168\u91cf\u91c7\u96c6\u8c03\u7528\u94fe\u6570\u636e\u5c06\u4f1a\u7ed9\u516c\u53f8\u7cfb\u7edf\u6574\u4f53\u5e26\u6765\u4e24\u65b9\u9762\u538b\u529b\uff1a</p> <ul> <li>\u56e0\u6570\u636e\u4e0a\u62a5\u9020\u6210\u7684\u6bcf\u4e2a\u4e1a\u52a1\u670d\u52a1\u7684\u7f51\u7edc I/O \u538b\u529b</li> <li>\u56e0\u6570\u636e\u91c7\u96c6\u3001\u5206\u6790\u9020\u6210\u7684\u8c03\u7528\u94fe\u8ffd\u8e2a\u670d\u52a1\u7684\u8ba1\u7b97\u548c\u5b58\u50a8\u538b\u529b \u4e3a\u4e86\u964d\u4f4e\u8fd9\u4e24\u65b9\u9762\u538b\u529b\uff0c\u91c7\u6837\u662f\u5927\u591a\u6570\u8c03\u7528\u94fe\u8ffd\u8e2a\u7cfb\u7edf\u7684\u5fc5\u5907\u6a21\u5757\u3002</li> </ul> <p>\u5b9e\u8df5\u4e2d\u5e38\u7528\u7684\u91c7\u7528\u7b56\u7565\u53ef\u4ee5\u5206\u4e3a\u4e09\u7c7b\uff1a</p> <ul> <li>\u5934\u90e8\u8fde\u8d2f\u91c7\u6837\uff1aHead-based coherent sampling</li> <li>\u5c3e\u90e8\u8fde\u8d2f\u91c7\u6837\uff1aTail-based coherent sampling</li> <li>\u5355\u5143\u91c7\u6837\uff1aUnitary sampling \u76ee\u524d\u5e94\u7528\u6700\u5e7f\u6cdb\u7684\u91c7\u6837\u7b56\u7565\u4e3b\u8981\u662f\u5c3e\u90e8\u91c7\u6837</li> </ul> <p>\u4e0b\u9762\u662f\u5b83\u4eec\u57fa\u672c\u539f\u7406\u56fe\u3002</p> <p></p> <p>Skywalking\uff1a\u91c7\u6837\u673a\u5236\u6210\u719f\uff0c\u505a\u5728 server-side\uff0c\u80fd\u591f\u652f\u6301\u7b80\u5355\u7684\u91c7\u6837\u767e\u5206\u6bd4 sample rate\u914d\u7f6e\uff0c\u5141\u8bb8 forceSampleErrorSegment\uff1a\u9519\u8bef\u94fe\u8def\u5f3a\u5236\u91c7\u7528\u3002\u66f4\u8be6\u7ec6\u914d\u7f6e\uff1a</p> <p>https://skywalking.apache.org/docs/main/latest/en/setup/backend/trace-sampling/</p> <p>\u4eae\u70b9\uff1a\u5355\u72ec\u505a\u4e86Slow SQL sampling \u6570\u636e\u5e93\u6162\u67e5\u8be2\u7684\u91c7\u6837\u914d\u7f6e\u3002</p> <p>https://skywalking.apache.org/docs/main/v8.5.0/en/setup/backend/slow-db-statement/</p> <p>Pinpoint\uff1a\u57fa\u672c\u91c7\u6837\uff0c\u652f\u6301\u767e\u5206\u6bd4\u91c7\u6837 Percent \u548c\u7b80\u5355\u7684\u603b\u6570\u91c7\u6837 Counting</p> <p>\u542c\u4e91\uff1a\u57fa\u672c\u91c7\u6837</p> <p>\u5bf9\u5f02\u5e38\u91c7\u96c6\u652f\u6301\u7b80\u5355\u914d\u7f6e\uff1aExceptionTrace Setting</p> <p>Jaeger\uff1a\u4f9d\u8d56\u4e8e Opentelemetry \u5e95\u5c42\u5b9e\u73b0\uff0c\u652f\u6301\u5c3e\u90e8\u91c7\u6837\uff0c\u5f02\u5e38\u91c7\u6837\uff0c\u8fc7\u6ee4\u89c4\u5219\u91c7\u6837\u7b49</p> <p>https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/tailsamplingprocessor</p> <p>Datadog \u3001\u817e\u8baf\u4e91\u3001\u963f\u91cc Arms\uff1aAPM \u90fd\u6709\u57fa\u672c\u91c7\u6837\uff0c\u91c7\u6837\u652f\u6301\u7b56\u7565\u4e5f\u975e\u5e38\u4e30\u5bcc</p> <p>\u4eae\u70b9\uff1a\u8fd8\u8fdb\u4e00\u6b65\u652f\u6301\u4e30\u5bcc\u7684 DB\u3001RUM\uff08\u524d\u7aef\u91c7\u6837\uff09</p> <p>\u7b80\u5355\u770b\u4e00\u4e2a\u817e\u8baf\u4e91\u4e0b\u9762 APM \u91c7\u6837\u914d\u7f6e\u3002</p> <p></p>"},{"location":"chap_apm/4apm_prod/#5-agent","title":"5 Agent \u80fd\u529b","text":"<p>\u8003\u8651\u6211\u4eec\u4e1a\u52a1\u7cfb\u7edf\u5728\u4e0d\u540c\u8bed\u8a00\u5f00\u53d1\u3001\u4e0d\u540c\u64cd\u4f5c\u73af\u5883\u4e0b\u8fd0\u884c\u3002\u800c\u4e14\uff0c\u968f\u7740\u4e91\u539f\u751f\u548c\u5fae\u670d\u52a1\u7684\u53d1\u5c55\uff0c\u73b0\u5728\u4e1a\u52a1\u7cfb\u7edf\u4e5f\u9010\u6b65\u90e8\u7f72\u5728\u5bb9\u5668\u548c\u670d\u52a1\u7f51\u683c\u4e2d\u3002\u8fd9\u589e\u52a0\u4e86 APM \u4ea7\u54c1\u7684\u6280\u672f\u96be\u5ea6\uff0c\u5b9e\u9645\u60c5\u51b5\uff1a\u5f88\u591a APM \u90fd\u652f\u6301\u4e0d\u4e86\u6240\u6709\u573a\u666f\uff0c\u53ea\u80fd Case By Case \u8003\u91cf\u3002</p> <p>\u56e0\u4e3a APM \u666e\u904d\u901a\u8fc7 Agent \u65b9\u5f0f\u91c7\u96c6\u94fe\u8def\u6570\u636e\u3002\u5982\u679c\u8981\u770b APM \u4ea7\u54c1\u662f\u5426\u652f\u6301\u4f60\u7684\u4e1a\u52a1\u7cfb\u7edf\uff0c\u6700\u76f4\u63a5\u65b9\u5f0f\u770b Agent \u7aef\u5b9e\u73b0\u80fd\u529b\u4e86\u3002</p>"},{"location":"chap_apm/4apm_prod/#5-1","title":"5-1 \u5f00\u6e90\u4ea7\u54c1","text":"<p>Pinpoint \u867d\u7136\u56fd\u5185 Java \u7cfb\u7edf\u6709\u4e00\u5b9a\u4f7f\u7528\u91cf\u3002\u4f46\u662f Pinpoint \u63a2\u9488\u5347\u7ea7\u6162\uff0c\u6700\u8fd1\u5feb\u534a\u5e74\u6ca1\u6709\u5347\u7ea7\u3002\u6700\u65b0 Java \u4e3b\u6d41\u4e2d\u95f4\u4ef6\u5f88\u591a\u4e0d\u652f\u6301\uff0c\u5bf9\u4e8e Kubernetes\u3001Istio \u8fd8\u652f\u6301\u4e0d\u4e86\u3002</p> <p>\u542c\u4e91\u5f88\u4e45\u6ca1\u7ef4\u62a4\uff0c\u6700\u65b0 Java \u63a2\u9488\u662f 2020 \u5e74\u505a\u4e86\u66f4\u65b0\u3002Kubernetes\u3001Istio \u4e0a\u4e0d\u4e86\u751f\u4ea7\u73af\u5883</p> <pre><code>#### 2020-09-04 *Version:2.7.1*\n1.\u91cd\u6784Webflux\u63d2\u4ef6\uff0c\u652f\u6301Spring Webflux 5.0.7.RELEASE ~ 5.2.8.RELEASE\n</code></pre> <p>Skywalking \u5e73\u5747\u4e24\u4e2a\u6708\u4e00\u4e2a\u5468\u671f\uff0c\u4e3b\u8981\u652f\u6301 Java \u4e3b\u6d41\u4e2d\u95f4\u4ef6\u7248\u672c\u5347\u7ea7\u3001\u5b83\u5bf9 Kubenetes\u3001Istio \u6210\u719f\u7684\u652f\u6301\uff0c\u8fed\u4ee3\u517c\u5bb9\u4e0d\u540c\u6700\u65b0\u7248\u672c\u3002Python\u3001Go \u4e5f\u5f00\u59cb\u505a\u4e86\u652f\u6301\u3002</p> <p>Istio \u6700\u65b0\u7248\u672c\u652f\u6301\uff1aIstio 1.10.3\u30011.11.4\u30011.12.0 release</p> <p>Java \u6700\u65b0\u7248\u672c\u652f\u6301\uff1aJDK 16\u300117</p>"},{"location":"chap_apm/4apm_prod/#5-2","title":"5-2 \u5546\u4e1a\u4ea7\u54c1","text":"<p>https://github.com/DataDog/dd-trace-java/releases</p> <p>\u6211\u603b\u7ed3\u6700\u8fd1\u4e00\u4e2a\u6708\uff0cDatadog Agent \u505a\u4e86\u4e00\u4e9b\u91cd\u8981\u66f4\u65b0\uff1a</p> <ul> <li>\u652f\u6301SAP\u7684\u94fe\u8def\u8ffd\u8e2a\uff1aEnable tracing of SAP's HANA in-memory DB</li> <li>\u652f\u6301 MQ \u4e2d\u95f4\u4ef6 Kafka \u6570\u636e\u6d41\u76d1\u63a7\uff1aData streams monitoring for Kafka</li> <li>\u652f\u6301\u6700\u65b0 Apache HttpClient 5 \u76d1\u63a7\uff1aApache HttpClient 5 instrumentation</li> </ul> <p>\u4eae\u70b9\uff1a\u5f00\u6e90\u7684 Skywalking\u3001\u5546\u4e1a\u7684 Datadog \u5728\u4e3b\u6d41\u7684\u7ec4\u4ef6\u76d1\u63a7\u652f\u6301\u4e0a\u4e0b\u4e86\u529f\u592b\uff0c\u800c\u4e14\u5bf9\u4e91\u539f\u751f\u4e0a Kubernetes \u5bb9\u5668\u548c Istio \u4e5f\u6210\u719f\u8fd0\u7528\u5230\u751f\u4ea7\u73af\u5883\uff0c\u8fd9\u662f\u5927\u90e8\u5206\u5176\u4ed6APM\u4ea7\u54c1\u6ca1\u6709\u505a\u5230\u7684\u3002</p> <p>\u63a8\u8350\uff1a\u4ece\u8fd9\u4e9b\u65b9\u9762\u770b\uff0c\u5982\u679c\u4f60\u7684\u4e1a\u52a1\u7cfb\u7edf\u4e0d\u662f\u4e3b\u6d41\u7684 APM \u76d1\u63a7\u5bf9\u8c61\uff0c\u6bd4\u5982\u91c7\u7528 .Net \u8bed\u8a00\u5f00\u53d1\uff0c\u6216\u8005\u7528\u5230\u4e86 SAP \u516c\u53f8\u7684 IT \u7cfb\u7edf\uff0c\u90a3\u4e48\u4f60\u8003\u8651\u7684\u6700\u91cd\u8981\u4f18\u5148\u7ea7\u662f\u54ea\u4e9b APM \u80fd\u771f\u6b63\u652f\u6301\u3002</p> <p>\u53e6\u4e00\u65b9\u9762\uff0c\u5982\u679c\u4f60\u7684\u4e1a\u52a1\u7cfb\u7edf\u7528\u5230\u4e86\u6700\u65b0\u7684\u4e00\u4e9b\u7ec4\u4ef6\u7248\u672c\u6216\u8005\u8bed\u8a00\u6846\u67b6\uff0c\u6bd4\u5982 Java \u7528\u4e86\u6700\u65b0\u7248\u672c\uff0c\u90a3\u5f88\u591a\u5f00\u6e90 APM \u662f\u6ca1\u6709\u53bb\u8fed\u4ee3\u66f4\u65b0\u7684\u3002</p>"},{"location":"chap_apm/4apm_prod/#5-3","title":"5-3 \u603b\u7ed3","text":"<p>\u6bd5\u7adf\u5546\u4e1a\u7aef\u7684 APM \u6709\u66f4\u591a\u6280\u672f\u50a8\u5907\uff0c\u548c\u4e13\u6ce8\u80fd\u529b\u53bb\u517c\u5bb9\u66f4\u591a\u7684\u7ec4\u4ef6\u3002\u5f53\u7136\u5728\u751f\u4ea7\u73af\u5883\uff0c\u4e00\u4e9b\u516c\u53f8\u7528\u4e86\u5f00\u6e90\uff0c\u501f\u52a9\u672c\u8eab\u6280\u672f\u80fd\u529b\uff0c\u91c7\u7528\u81ea\u7814\u65b9\u5f0f\uff0c\u505a\u4e86\u4e00\u4e9b\u4e2a\u6027\u5316\u76d1\u63a7\u7684\u6280\u672f\u65b9\u6848\u3002\u5230\u5e95\u662f\u5f00\u6e90\u8fd8\u662f\u5546\u4e1a\uff0c\u6700\u6838\u5fc3\u662f\u770b\u6027\u4ef7\u6bd4\u3002\u5982\u679c\u4f60\u786e\u5b9e\u81ea\u7814\u4e0d\u4e86\uff0c\u5f00\u6e90\u4e5f\u4e0d\u80fd\u652f\u6301\u516c\u53f8\u67d0\u4e9b\u6838\u5fc3\u7ec4\u4ef6\uff0c\u8003\u8651\u5546\u4e1a APM \u4ea7\u54c1\u4e5f\u662f\u4e00\u79cd\u9009\u62e9\u3002</p>"},{"location":"chap_apm/4apm_prod/#6","title":"6 \u544a\u8b66\u7ba1\u7406\u80fd\u529b","text":"<p>\u544a\u8b66\u7ba1\u7406\u63d0\u4f9b\u4e86\u53ef\u9760\u7684\u544a\u8b66\u6536\u655b\u3001\u901a\u77e5\uff0c\u5e2e\u52a9\u4e1a\u52a1\u7cfb\u7edf\u5feb\u901f\u68c0\u6d4b\u548c\u4fee\u590d\u4e1a\u52a1\u544a\u8b66\u3002</p> <p>\u544a\u8b66\u7ba1\u7406\u4ece\u529f\u80fd\u4e0a\uff0c\u5305\u542b\u57fa\u672c\u529f\u80fd\uff1a\u6dfb\u52a0\u76d1\u63a7\u4e8b\u4ef6\u3001\u914d\u7f6e\u544a\u8b66\u3001\u544a\u8b66\u63a8\u9001\u3002</p> <p>\u5728\u5b9e\u9645\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u4e00\u65b9\u9762\u4e1a\u52a1\u7cfb\u7edf\u5f80\u5f80\u590d\u6742\uff0c\u670d\u52a1\u4f17\u591a\uff0c\u7b80\u5355\u4e00\u4e2a\u4e2a\u6dfb\u52a0\u76d1\u63a7\u4e8b\u4ef6\uff0c\u4f1a\u5bfc\u81f4\u8fd0\u7ef4\u5de5\u4f5c\u91cf\u9aa4\u589e\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4e1a\u52a1\u544a\u8b66\u4e0d\u5149\u8981\u53ca\u65f6\u63a8\u9001\uff0c\u4e5f\u9700\u8981\u63d0\u4f9b\u8db3\u591f\u4e30\u5bcc\u7684\u62a5\u8b66\u6570\u636e\u548c\u53cb\u597d\u53ef\u89c6\u5316\u5c55\u793a\uff0c\u8ba9 IT \u4eba\u5458\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898\u548c\u4fee\u590d\u6545\u969c\u3002</p> <p>\u4ece\u8fd9\u4e9b\u7ef4\u5ea6\uff0c\u5f88\u591a APM \u63d0\u4f9b\u4e86\u544a\u8b66\u9ad8\u7ea7\u529f\u80fd\uff1a\u544a\u8b66\u6a21\u677f\uff0c\u914d\u7f6e\u544a\u8b66\u81ea\u52a8\u5316\uff0c\u66f4\u53cb\u597d\u7684\u544a\u8b66\u754c\u9762\u3002</p> <p>\u6211\u4eec\u770b\u770b\u4e3b\u6d41APM\u5177\u4f53\u5bf9\u544a\u8b66\u652f\u6301\uff1a</p> <p>Skywalking \u544a\u8b66\u901a\u8fc7\u811a\u672c\u914d\u7f6e\uff1a</p> <p>https://github.com/apache/skywalking/blob/master/docs/en/setup/backend/backend-alarm.md</p> <p>Skywalking \u62a5\u8b66\u754c\u9762\u4e0d\u592a\u53cb\u597d\uff0c\u67e5\u770b\u62a5\u8b66\u548c\u6dfb\u52a0\u62a5\u8b66\u4e8b\u4ef6\u6bd4\u8f83\u9ebb\u70e6\u3002</p> <p>\u4e0d\u8fc7 Skywalking \u544a\u8b66\u6d88\u606f\u63a8\u9001\u6e90\u6bd4\u8f83\u4e30\u5bcc\uff0c\u6bd4\u5982\u98de\u4e66\u3001\u9489\u9489\u3001Slack\u3002</p> <p>\u8fd8\u5f00\u653e\u544a\u8b66 hook\uff0c\u8fd9\u6837\u5f00\u53d1\u8005\u57fa\u4e8e\u81ea\u5b9a\u4e49\u66f4\u591a\u544a\u8b66\u63a8\u52a8\u6e90\u3002</p> <p>Pinpoint \u57fa\u672c\u544a\u8b66\u6a21\u677f\u5e93\u3001\u505a\u4e86\u544a\u8b66\u6d88\u606f\u7b80\u5355\u5206\u7ec4\uff0c\u4f46\u662f\u4e0d\u5f00\u653e\u81ea\u5b9a\u4e49\u544a\u8b66\u6e90\uff0c\u6709\u7b80\u5355\u6a21\u677f\u3002</p> <p>\u6bd4\u8d77\u5f00\u6e90 APM\uff0c\u5546\u4e1a\u5316 APM \u544a\u8b66\u9ad8\u7ea7\u529f\u80fd\u6bd4\u8f83\u5f3a\u4e86\u3002</p> <p>\u6211\u4eec\u770b\u770b Datadog\u3001\u56fd\u5185\u89c2\u6d4b\u4e91\u3001\u963f\u91cc\u4e91 Arms \u7684\u9ad8\u7ea7\u529f\u80fd\uff1a</p> <p>\u544a\u8b66\u6a21\u677f\u5e93\uff1a\u4e30\u5bcc\u7684\u544a\u8b66\u6a21\u677f\uff0c\u4e0d\u7528\u81ea\u5df1\u624b\u52a8\u521b\u5efa</p> <p></p> <p>\u76d1\u63a7\u914d\u7f6e\u66f4\u52a0\u81ea\u52a8\u5316\uff0c\u6bd4\u5982\u4e0b\u9762\u5bf9 MySQL \u544a\u8b66\uff0c\u901a\u8fc7\u7075\u6d3b\u7684\u76d1\u63a7\u9600\u503c\u548c\u6307\u6807\u914d\u7f6e\uff0c\u53ef\u4ee5\u5f88\u5feb\u901f\u548c\u5b9e\u7528\u505a\u5230\u76d1\u63a7\u3002\u8fd9\u4e2a\u6bd4\u8d77\u7eaf\u811a\u672c\u65b9\u5f0f\uff0c\u6781\u5927\u8282\u7ea6\u4e86\u7cfb\u7edf\u8fd0\u7ef4\u7684\u5de5\u4f5c\u91cf\u3002\u5f53\u7136\uff0c\u8981\u63d0\u4f9b\u8fd9\u6837\u7684\u9ad8\u7ea7\u529f\u80fd\uff0c\u5bf9 APM \u4ea7\u54c1\u5f00\u53d1\u6295\u5165\u4e5f\u662f\u5f88\u5927\u7684\u3002</p> <p></p> <p>\u53cb\u597d\u7684\u544a\u8b66\u5927\u5c4f\uff1a\u8986\u76d6\u6574\u4e2a IT \u7cfb\u7edf\u7684\u544a\u8b66\u72b6\u51b5\uff0c\u901a\u8fc7\u94bb\u53d6\u67e5\u770b\u5177\u4f53\u67d0\u9879\u670d\u52a1</p> <p></p> <p>\u76f8\u6bd4\u4e8e\u5546\u4e1a\u7684 APM \u624d\u80fd\u5177\u5907\u9ad8\u7ea7\u529f\u80fd\uff0c\u5f00\u6e90\u4ea7\u54c1\u9650\u4e8e\u8d44\u6e90\u6709\u9650\uff0c\u5f88\u96be\u628a\u544a\u8b66\u80fd\u591f\u505a\u5230\u5982\u6b64\u3002\u76ee\u524d\uff0c\u4ece\u5f00\u6e90\u4e0a\u80fd\u591f\u628a\u544a\u8b66\u505a\u5f97\u8fd9\u6837\u63a5\u8fd1\u7684\uff0c\u53ef\u4ee5\u770b\u770b\u56fd\u5185\u7684\u4e13\u95e8\u505a\u76d1\u63a7\u62a5\u8b66\u7684\u591c\u83ba\u56e2\u961f\uff0c\u5f00\u6e90\u76d1\u63a7\u4ea7\u54c1 Nightingale\uff0c\u539f\u6765 Open-falcon \u7684\u524d\u8eab\uff0c\u5728\u56fd\u5185\u4e5f\u662f\u6709\u4f17\u591a\u7684\u62e5\u62a4\u8005\u3002</p> <p>https://n9e.gitee.io/usage/</p> <p>\u544a\u8b66\u7ba1\u7406\u5bf9\u5e94 APM \u662f\u4e00\u4e2a\u76f8\u5bf9\u91cd\u8981\u529f\u80fd\uff0c\u5c3d\u7ba1\u5546\u4e1a APM \u8fdc\u597d\u4e8e\u5f00\u6e90\u4ea7\u54c1\uff0c\u6bd5\u7adf\u4ed8\u8d39\u3002\u6240\u4ee5\u5927\u5bb6\u5728\u5b9e\u9645\u9879\u76ee\u4e2d\u9009\u578b\u8fd8\u662f\u575a\u6301\u6027\u4ef7\u6bd4\uff0c\u4f60\u8981\u770b\u770b\u516c\u53f8\u4e1a\u52a1\u7cfb\u7edf\u5bf9\u8fd9\u4e9b\u9ad8\u7ea7\u529f\u80fd\u7684\u8feb\u5207\u6027\u548c\u6295\u5165\u4ef7\u503c\u3002\u786e\u5b9e\u6709\u4e00\u4e9b\u516c\u53f8\u4e5f\u5728\u5f00\u6e90\u57fa\u7840\u4e0a\u81ea\u7814\u4e86\u8fd9\u4e9b\u9ad8\u7ea7\u529f\u80fd\u3002</p>"},{"location":"chap_apm/4apm_prod/#7-db","title":"7 \u5bf9 DB \u7684\u652f\u6301","text":"<p>\u6570\u636e\u5e93\u662f\u4e1a\u52a1\u7cfb\u7edf\u91cc\u9762\u975e\u5e38\u6838\u5fc3\u7ec4\u4ef6\uff0c\u751f\u4ea7\u73af\u5883\u5e38\u5e38\u53ef\u80fd\u56e0\u4e3a\u6570\u636e\u5e93\u627f\u8f7d\u80fd\u529b\u51fa\u73b0\u6027\u80fd\u95ee\u9898\uff0c\u6700\u5e38\u89c1\u7684\u4f8b\u5b50\u5c31\u662f\u6162\u67e5\u8be2\u3002\u901a\u8fc7 APM \u53ef\u4ee5\u770b\u5230\u5b8c\u6574\u6162\u67e5\u8be2 SQL \u8bed\u53e5\u548c\u8017\u65f6\uff0c\u4e5f\u53ef\u4ee5\u505a\u6162\u67e5\u8be2\u548c\u5176\u4ed6\u6570\u636e\u5e93 \u5f02\u5e38\u6307\u6807\u544a\u8b66\uff0c\u8fd9\u6837\u5feb\u901f\u5b9a\u4f4d\u6570\u636e\u5e93\u6027\u80fd\u6545\u969c\u3002\u6570\u636e\u5e93\u652f\u6301\u5b9e\u7528\u5ea6\u4f53\u73b0\u5728\u4e24\u4e2a\u65b9\u9762\u3002</p> <p>SQL \u8c03\u7528\u94fe\u4f20\u53c2\u5b8c\u6574\u663e\u793a\uff0c\u6bd4\u5982 Skywalking\uff0c\u901a\u8fc7\u914d\u7f6e\uff0c\u770b\u5230\u7684\u5b8c\u6574SQL\uff1a</p> <p></p> <p>SQL\u4f20\u53c2\u663e\u793a\u6548\u679c</p> <p>\u652f\u6301\u6162\u67e5\u8be2\u548c\u76f8\u5173\u6027\u80fd\u6307\u6807\u7684\u91c7\u96c6\u548c\u5c55\u793a\uff0c\u6bd4\u5982\u542c\u4e91\u6162\u67e5\u8be2\u5206\u6790\uff0c\u5b83\u63d0\u4f9b\u652f\u6301\u6570\u636e\u5e93 Oracle\u3001MySQL\u3001MS SQL Server\u3002</p> <p></p> <p>\u521a\u624d\u63d0\u5230\u4e24\u4e2a\u6838\u5fc3\u7ef4\u5ea6\uff0c\u6709\u7684 APM \u4f1a\u6709\u4e0d\u652f\u6301\u7684\u60c5\u51b5\uff1a\u5404\u79cd\u6570\u636e\u5e93\u6bd4\u8f83\u591a\uff0c\u8981\u770b\u5177\u4f53\u8bf4\u660e\u3002</p> <p>\u6574\u4f53\u770b\uff0cDB \u76d1\u63a7\u53cb\u597d\u6027\u8fd8\u662f\u4f53\u73b0\u7ec6\u8282\u65b9\u9762\uff0c\u6bd4\u5982\u6709\u4e9b APM \u63d0\u4f9b\u56fe\u5f62\u5316\u754c\u9762\u52a8\u6001\u914d\u7f6e\u6162\u67e5\u8be2\u548c\u62a5\u8b66\uff0c\u7684\u786e\u8fd0\u7ef4\u4f7f\u7528\u4e0a\u4f1a\u5927\u5927\u4fbf\u5229\u3002</p> <p>\u6240\u4ee5\uff0c\u751f\u4ea7\u73af\u5883\u4e0b\u4f7f\u7528 APM \u5bf9 DB \u76d1\u63a7\u66f4\u591a\u8003\u8651\u6548\u7387\u7684\u95ee\u9898\u3002</p> <p>\u4e00\u822c\u573a\u666f Pinpoint\u3001Skywalking \u8db3\u591f\u7528\u3002</p>"},{"location":"chap_apm/4apm_prod/#8-kubernetes-istio","title":"8 Kubernetes \u548c Istio \u7684\u652f\u6301","text":"<p>\u5bf9\u5e94 Kubernetes\u3001Istio \u7684\u4ef7\u503c\u672c\u6587\u4e2d\u4e0d\u518d\u8d58\u8ff0\uff0c\u5728\u5b9e\u9645\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u80fd\u771f\u6b63\u652f\u6301\u597d Kubernetes\u3001Istio \u7684 APM \u786e\u5b9e\u4e0d\u591a\uff0c\u5f88\u591a\u8fc7\u53bb\u4e3b\u6d41\u7684 APM \u90fd\u4e0d\u652f\u6301\u7684\uff0c\u751a\u81f3\u662f\u4e00\u4e9b\u5546\u4e1a\u7684 APM \u4ea7\u54c1\u3002</p> <p>Pinpoint \u76ee\u524d\u6700\u65b0\u5f00\u59cb\u652f\u6301 Kubernetes\uff0c\u4e0d\u8fc7\u5230\u4e0d\u4e86\u751f\u4ea7\u73af\u5883\uff0cIstio \u5b8c\u5168\u4e0d\u652f\u6301\u3002</p> <p>https://github.com/pinpoint-apm/pinpoint-kubernetes/issues</p> <p>Skywalking \u5728 Kubernetes\u3001Istio \u53ef\u89c2\u6d4b\u652f\u6301\u975e\u5e38\u6210\u719f\u3002</p> <p>\u8fd9\u662f Skywalking \u5f88\u5927\u4eae\u70b9\uff0c\u800c\u4e14 Skywalking \u5bf9\u4ed6\u4eec\u652f\u6301\u6709\u4e00\u5b9a\u65f6\u95f4\uff0c\u8d9f\u8fc7\u5f88\u591a\u5751\u3002</p> <p>\u4e4b\u524d\u751f\u4ea7\u73af\u5883\uff0cIstio \u672c\u8eab\u6027\u80fd\u7f3a\u9677\uff0cSkywalking \u505a\u4e86\u5f88\u591a\u4f18\u5316\uff1a</p> <p>\u6bd4\u5982\u8bf4 Skywalking \u4ece Istio \u6027\u80fd\u5f88\u5dee\u7684 Mixer \u65b9\u6848\u9010\u6e10\u8fc1\u79fb\u5230 Envoy \u7684 Access Log Service\uff0c\u4ee5\u89e3\u51b3\u670d\u52a1\u7f51\u683c\u89c2\u5bdf\u7684\u6027\u80fd\u74f6\u9888\u3002\u66f4\u591a\uff0c\u53c2\u8003\u8fd9\u7bc7\u5e72\u8d27\uff1a</p> <p>https://www.tetrate.io/blog/observe-service-mesh-with-skywalking-and-envoy-access-log-service/</p> <p>Datadog Kubernetes\u3001Istio \u652f\u6301\u5f88\u5f3a\u608d\u4e86\u3002</p> <p>\u6bd4\u5982\u652f\u6301\u7075\u6d3b\u7684\u65e5\u5fd7\u8fc7\u6ee4\u7ba1\u7406\uff0c\u53ef\u4ee5\u4f18\u5316 Kubernetes \u4e0b\u65e5\u5fd7\u7684\u91c7\u96c6\u7b56\u7565\u3002</p> <p>https://docs.datadoghq.com/agent/logs/advanced_log_collection/?tab=kubernetes#filter-logs</p> <p>Datadog \u57fa\u4e8e Pod \u53bb\u7ba1\u7406\u5bb9\u5668\u8282\u70b9\u7684\u94fe\u8def\u8ffd\u8e2a\uff0c\u53ef\u4ee5\u652f\u6301 name\u3001image\u3001kube_namespace \u8fd9\u4e9b\u7c92\u5ea6\u7ba1\u7406\uff0c\u53ef\u8c13\u76f8\u5f53\u901a\u7528\u3002</p> <p></p> <p>Istio \u4e5f\u6709\u4e30\u5bcc\u652f\u6301\uff0c\u66b4\u9732\u5f88\u591a Envoy \u76d1\u63a7\u6307\u6807\uff1a</p> <p>https://docs.datadoghq.com/integrations/envoy</p>"},{"location":"chap_apm/4apm_prod/#9","title":"9 \u793e\u533a\u548c\u6587\u6863\u6210\u719f\u5ea6","text":""},{"location":"chap_apm/4apm_prod/#9-1","title":"9-1 \u6280\u672f\u6587\u6863","text":"<p>Skywalking\u3001Datadog\u3001Arms \u6587\u6863\u975e\u5e38\u5b8c\u6574\u4e30\u5bcc\uff0c\u540c\u65f6\u5728\u7f51\u4e0a\u641c\u7d22\u4e00\u4e9b\u95ee\u9898\uff0c\u90fd\u80fd\u627e\u5230\u5408\u9002\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u8fd9\u70b9\u5bf9\u4e8e\u7ef4\u62a4\u8005\u6765\u8bf4\u662f\u975e\u5e38\u6709\u4ef7\u503c\u7684\u3002</p> <p>\u4e0d\u8fc7 Arms \u6587\u6863\u76f4\u89c2\u663e\u5f97\u6bd4\u8f83\u51cc\u4e71\uff0c\u6bd5\u7adf\u5b83\u662f\u5f88\u591a\u56e2\u961f\uff0c\u4e0d\u540c\u5b50\u7cfb\u7edf\u96c6\u6210\u800c\u6765\uff0c\u7565\u5fae\u81c3\u80bf\u3002</p> <p>\u50cf Skywalking \u5f00\u6e90\u4ea7\u54c1\u505a\u4e86\u4e00\u4e9b APM \u6280\u672f\u5e03\u9053\uff0c\u641c\u7d22\u7f51\u4e0a\u5f88\u591a\u94fe\u8def\u8ffd\u8e2a\u6280\u672f\u6587\u7ae0\u90fd\u6765\u4e8e\u4ed6\u4eec\uff0c\u8fd9\u662f\u5f00\u6e90\u793e\u533a\u7684\u4e00\u4e9b\u8d21\u732e\u3002</p> <p>\u5b8c\u6574\u3001\u9ad8\u8d28\u91cf\u6280\u672f\u6587\u6863\u5bf9\u5e94\u4f7f\u7528\u5f00\u53d1\u8005\u6765\u8bf4\uff0c\u4f5c\u7528\u5f53\u7136\u4e0d\u8a00\u800c\u55bb\u3002\u53e6\u5916\u4e00\u9762\uff0c\u597d\u7684\u4ea7\u54c1\u6587\u6863\uff0c\u6709\u52a9\u4e8e\u6211\u4eec\u66f4\u591a\u4e86\u89e3\u5185\u90e8\u8fd0\u884c\u539f\u7406\u3002</p> <p>\u63a8\u8350\u603b\u7ed3\uff1a\u4e0a\u751f\u4ea7\u73af\u5883\uff0c\u6211\u4eec\u5f80\u5f80\u5e0c\u671b\u9762\u5bf9\u7cfb\u7edf\u662f\u53ef\u63a7\u7684\uff0c\u5b8c\u5584\u3001\u6210\u719f\u7684\u6280\u672f\u6587\u6863\u5bf9\u4e8e\u9009\u578b\u6765\u8bf4\u662f\u4e00\u4e2a\u5f88\u57fa\u672c\u7684\u8981\u6c42\u3002\u5f00\u6e90\u8fd8\u6709\u597d\u5904\u5728\u4e8e\u4ee3\u7801\u5f00\u653e\u6027\uff0c\u4e0d\u7528\u62c5\u5fc3\u9ed1\u76d2\u60c5\u51b5\u4e0a\u4e00\u4e2a\u76d1\u63a7\uff0c\u5982\u679c\u56e2\u961f\u6280\u672f\u80fd\u529b\u8db3\u591f\u5f3a\uff0c\u4e5f\u80fd\u81ea\u5df1 fixed \u6216\u8005\u4f18\u5316\u95ee\u9898\u3002</p>"},{"location":"chap_apm/4apm_prod/#9-2","title":"9-2 \u793e\u533a\u751f\u6001","text":"<p>\u5f00\u6e90\u4ea7\u54c1\u4e00\u5927\u4f18\u52bf\u5728\u4e8e\u5f00\u653e\u6027\uff0c\u4e3b\u8981\u4f53\u73b0\u793e\u533a\u548c\u6280\u672f\u652f\u6301\u4e0a\u3002</p> <p>\u6bd4\u5982Skywalking\u3001Opentelemetry\u3001Pinpoint \u56fd\u5185\u90fd\u6709\u6d3b\u8dc3\u7684\u793e\u7fa4\uff1a</p>"},{"location":"chap_apm/5apm_Sentry/","title":"\u7b2c\u4e94\u8282 Sentry+OpenTelemetry\u524d\u540e\u7aef\u5168\u94fe\u8def\u6253\u901a","text":"<p>\u81ea\u4ece\u5fae\u670d\u52a1\u5927\u884c\u5176\u9053\uff0c\u5bb9\u5668\u5316\u548ck8s\u7f16\u6392\u4e00\u7edf\u5929\u4e0b\u4e4b\u540e\uff0c\u201c\u53ef\u89c2\u6d4b\u6027\u201d \u4fbf\u88ab\u63d0\u51fa\u6765\u3002\u8fd9\u4e2a\u6982\u5ff5\u662f\u6307\uff0c\u5bf9\u4e8e\u5e94\u7528\u6216\u8005\u5bb9\u5668\u7684\u8fd0\u884c\u72b6\u51b5\u7684\u638c\u63a7\u7a0b\u5ea6\uff0c\u5176\u4e2d\u5206\u4e3a\u4e86\u4e09\u4e2a\u6a21\u5757\uff1a<code>Metrics</code>\u3001<code>Tracing</code>\u3001<code>Logging</code>\u3002</p> <p>Metrics \u6307\u5e94\u7528\u91c7\u96c6\u7684\u6307\u6807\uff1bTracing \u6307\u5e94\u7528\u7684\u8ffd\u8e2a\uff1bLogging \u6307\u5e94\u7528\u7684\u65e5\u5fd7\u3002</p> <p>\u65e5\u5fd7\u81ea\u4e0d\u7528\u591a\u8bf4\uff0c\u8fd9\u662f\u6700\u539f\u59cb\u7684\u8c03\u8bd5\u548c\u6570\u636e\u91c7\u96c6\u80fd\u529b\u3002Metrics \u6bd4\u8f83\u706b\u7684\u65b9\u6848\u5c31\u662f Prometheus + Grafana\uff0c\u601d\u8def\u5c31\u662f\u901a\u8fc7\u5e94\u7528\u5185\u57cb\u5165SDK\uff0c\u9009\u62e9 Pull \u6216\u8005 Push \u7684\u65b9\u5f0f\u5c06\u6570\u636e\u6536\u96c6\u5230 prometheus \u4e2d\uff0c\u7136\u540e\u901a\u8fc7 Grafana \u5b9e\u73b0\u53ef\u89c6\u5316\uff0c\u5f53\u7136\u8fd9\u4e0d\u662f\u672c\u6587\u7684\u91cd\u70b9\u5c31\u6b64\u7565\u8fc7\u3002</p> <p>Tracing \u4e5f\u5e76\u4e0d\u662f\u53ef\u89c2\u6d4b\u6027\u63d0\u51fa\u540e\u624d\u8bde\u751f\u7684\u6982\u5ff5\uff0c\u5728\u5fae\u670d\u52a1\u5316\u7684\u8fdb\u7a0b\u4e2d\u5c31\u5df2\u7ecf\u6709Google\u7684Dapper\u843d\u5730\u5b9e\u8df5\uff0c\u5e76\u6162\u6162\u5f62\u6210 OpenTracing \u89c4\u8303\uff0c\u8fd9\u4e00\u89c4\u8303\u53c8\u88ab\u591a\u5bb6\u7b2c\u4e09\u65b9\u6846\u67b6\u6240\u652f\u6301\uff0c\u5982 Jaeger\u3001Zipkin \u7b49\u3002</p> <p>OpenTelemetry \u5c31\u662f\u7ed3\u5408\u4e86 OpenTracing + OpenCensus \u89c4\u8303\uff0c\u7ea6\u5b9a\u5e76\u63d0\u4f9b\u5b8c\u6210\u7684\u53ef\u89c2\u6d4b\u6027\u5957\u4ef6\uff0c\u53ea\u662f\u76ee\u524d\uff082021-12-15\uff09\u7a33\u5b9a\u4e0b\u6765\u7684\u53ea\u6709 Tracing \u8fd9\u4e00\u90e8\u5206\u800c\u5df2\u3002\u5bf9 OpenTelemetry \u53d1\u5c55\u5386\u53f2\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u81ea\u884c\u4e86\u89e3\u3002</p>"},{"location":"chap_apm/5apm_Sentry/#_1","title":"\u6548\u679c\u9884\u89c8","text":"<p>\u94fe\u8def\u603b\u89c8\uff0c\u5305\u542b\u4e86\u524d\u7aef\u9875\u9762\u7684\u751f\u547d\u5468\u671f + \u6574\u4e2a\u4e86\u94fe\u8def\u91c7\u96c6\u5230\u7684Span\u805a\u5408\u3002</p> <p></p> <p>\u524d\u7aef\u9875\u9762\u6307\u6807\u91c7\u96c6\u6982\u89c8\uff0c\u5305\u542b\u4e86\u8be5\u9875\u9762\u751f\u547d\u5468\u671f\u5185\u7684\u52a8\u4f5c\u548c\u65e5\u5fd7\u7b49\u3002</p> <p></p> <p>\u670d\u52a1\u7aef\u94fe\u8def\u7ec6\u8282\uff0c\u5305\u542b\u4e86\u670d\u52a1\u7aef\u94fe\u8def\u91c7\u96c6\u7684\u6807\u7b7e\u548c\u65e5\u5fd7\uff08\u4e8b\u4ef6\uff09\u7b49\u4fe1\u606f\u3002</p> <p></p> <p>propagation\u517c\u5bb9jaeger\u6548\u679c\uff0c\u4fdd\u8bc1jaeger\u4fa7\u94fe\u8def\u5b8c\u6574\uff0c\u4f7f\u7528\u4e00\u81f4\u7684 traceId\u68c0\u7d22\u3002\u56e0\u4e3a\u670d\u52a1\u4fa7 sentry \u662f\u6e10\u8fdb\u66f4\u65b0\u7684\uff0c\u56e0\u6b64\u6ca1\u6709\u63a5\u5165\u7684\u5e94\u7528\u5e76\u4e0d\u4f1a\u5c55\u793a\u5728sentry\u4fa7\uff0c \u7b49\u5230\u5b8c\u5168\u66f4\u65b0\u540e\u5c31\u4f1a\u5b8c\u6574\u3002</p> <p></p> <p></p>"},{"location":"chap_apm/5apm_Sentry/#_2","title":"\u80cc\u666f","text":"<p>\u76ee\u524d\u8fd0\u884c\u4e2d\u7684\u94fe\u8def\u8ffd\u8e2a\u7ec4\u4ef6\u662f\u91c7\u7528 opentracing + jaeger \u5b9e\u73b0\uff0c\u8fd9\u5957\u65b9\u6848\u552f\u4e8c\u7684\u4e0d\u8db3\u5c31\u662f\uff1a</p> <ul> <li>opentracing \u5df2\u7ecf\u88ab opentelemetry \u517c\u5bb9\uff0c\u4e14 opentelemetry \u5728\u53ef\u89c2\u6d4b\u6027\u4e0a\u66f4\u5168\u9762\uff0c\u66f4\u7075\u6d3b\u3002</li> <li>\u6d4f\u89c8\u5668\u4fa7\u652f\u6301\u4e0d\u5b8c\u5584\uff08\u53ef\u4ee5\u53c2\u89c1 https://github.com/jaegertracing/jaeger-client-javascript \uff09\u3002</li> </ul> <p>\u524d\u7aef\u91c7\u7528 sentry \u6765\u91c7\u96c6\u524d\u7aef\u9875\u9762\u6570\u636e\uff08APP + WEB \u90fd\u652f\u6301\u5f88\u597d\uff09\uff0c\u56e0\u6b64\u624d\u6709\u4e86\u8fd9\u4e48\u4e00\u4e2a \u524d\u540e\u7aef\u94fe\u8def\u6253\u901a\u7684\u9700\u6c42\u3002\u6253\u901a\u603b\u7ed3/#sentry\u4f5c\u4e3a\u94fe\u8def\u91c7\u96c6\u7ec4\u4ef6\u7684\u4f18\u7f3a\u70b9)</p> <p>\u6700\u5f00\u59cb\u7684\u9700\u6c42\u76ee\u6807\u662f\u540e\u7aef\u76f8\u5173 Tracing SDK \u5168\u90e8\u4f7f\u7528sentry\u66ff\u6362\uff0c\u4f46\u662f\u7ed3\u5408\u4e0a\u8ff0\u5bf9\u4e8esentry\u7684\u8c03\u7814\uff0c\u53d1\u73b0\u76f4\u63a5\u63a5\u5165sentry\u5e76\u4e0d\u662f\u4e00\u4e2a\u597d\u7684\u9009\u62e9\uff1a</p> <ul> <li>\u76f8\u5173\u7684 Tracing \u6982\u5ff5\u6ca1\u6709\u88ab\u6211\u4e2a\u4eba\u548c\u793e\u533a\u63a5\u53d7\uff0c\u793e\u533a\u5185\u4e3b\u6d41\u7684\u8fd8\u662f OpenTracing \u548c OpenTeletemetry \u89c4\u8303\uff0c\u800c\u4e14\u8fd9\u4e24\u4e2a\u89c4\u8303\u90fd\u662f\u76f8\u4e92\u517c\u5bb9\u7684\uff08\u4e2a\u4eba\u8ba4\u4e3a\uff1aOpenTelemetry \u5927\u6709\u4e00\u7edf\u53ef\u89c2\u6d4b\u6027\u7684\u8d8b\u52bf\uff0c\u4ed6\u4eec\u7acb\u9879\u4e5f\u662f\u671d\u7740\u8fd9\u4e2a\u65b9\u5411\u524d\u8fdb\uff09\u3002</li> <li>\u5b98\u65b9go-SDK\u6d3b\u8dc3\u5ea6\u4f4e\u4e4e\u60f3\u8c61\uff0c\u53c2\u89c1 https://github.com/getsentry/sentry-go/issues/387 \u622a\u6b62\u672c\u6587\u65f6\uff08since 2021-10-22\uff09\u4ecd\u7136\u6ca1\u6709\u4efb\u4f55\u56de\u590d\uff0c\u8fdb\u4e00\u6b65\u963b\u6b62\u6211\u76f4\u63a5\u4f7f\u7528sentry\u3002</li> <li>\u8c03\u7814 OpenTelemetry \u5728\u7814\u7a76\u5b83\u7684\u67b6\u6784\u8bbe\u8ba1\u65f6\uff0c\u53d1\u73b0\u5176\u8bbe\u8ba1\u4e2d\u5305\u542b\u4e86\u4e00\u4e2a Collector\uff08\u8be6\u7ec6\u4ecb\u7ecd\u53c2\u89c1 \u9644\u5f55/OpenTelemetry\u4e2d\u7684\u6982\u5ff5\uff09 \u3002\u4ece\u793a\u610f\u56fe\u6211\u4eec\u4e5f\u53ef\u4ee5\u770b\u51fa\uff0c\u5b83\u7684\u4f5c\u7528\u8fd1\u4f3c\u4e8e Jaeger Collector / Agent\uff0c\u4f46\u662f\u76f8\u6bd4\u4e8e Jaeger \u5b83\u66f4\u5f00\u653e\uff0c\u652f\u6301\u591a\u79cd Vendor (Jaeger / Zipkin \u7b49\u7b49)\uff0c\u66f4\u52a0\u7075\u6d3b\u3002</li> </ul> <p></p> <ul> <li>\u5982\u679c\u66ff\u6362\u4e86 sentry \u52a0\u5165\u662f\u4e0d\u662f\u4ee5\u540e\u8fd8\u53ef\u80fd\u66f4\u6362\u65b0\u7684\u91c7\u96c6\u7ec4\u4ef6\uff0c\u670d\u52a1\u8fd9\u4e48\u591a\u518d\u6765\u6362\u4e00\u904d\u8fd8\u662f\u8d39\u65f6\u8d39\u529b</li> </ul>"},{"location":"chap_apm/5apm_Sentry/#_3","title":"\u65b9\u6848\u63cf\u8ff0","text":"<p>\u90a3\u4e48\u57fa\u4e8e\u4ee5\u4e0a\u7684\u8003\u8651\uff0c\u8bbe\u8ba1\u4e86\u5982\u4e0b\u7684\u6539\u9020\u65b9\u6848</p> <ul> <li>\u5728\u5e94\u7528\u4fa7 Tracing SDK \u5168\u90e8\u66ff\u6362\u4e3a otel SDK\uff08\u540e\u9762\u7ecf\u8fc7\u8003\u8651\uff0c\u8fd8\u662f\u81ea\u5df1\u505a\u4e86\u4e00\u4e2a\u9632\u8150\u7684 Tracing API\u5c01\u88c5\uff09\u3002<ul> <li>\u4e3a\u4e86\u4fdd\u8bc1\u6e10\u8fdb\u66f4\u65b0\u670d\u52a1\u7aef\u94fe\u8def\u91c7\u96c6\u7684\u540c\u65f6\uff0c\u5728Jaeger Dashborad\u4e2d\u7684\u94fe\u8def\u4e0d\u65ad\uff0c\u5728 propagator \u5b9e\u73b0 otel \u5230 jaeger \u7684\u8f6c\u6362\u3002</li> </ul> </li> <li>\u81ea\u5df1\u5b9e\u73b0\u4e00\u4e2a Sentry Trace Exporter, \u5c06\u5ba2\u6237\u7aef\u4e0a\u62a5\u7684\u94fe\u8def\uff0c\u518d\u6295\u9012\u5230 sentry\u3002</li> <li>Collector \u914d\u7f6e exporter \u65f6\uff0c\u540c\u65f6\u4e0a\u62a5\u5230 sentry \u548c jaeger</li> </ul> <p>https://github.com/yeqown/opentelemetry-quake</p>"},{"location":"chap_apm/5apm_Sentry/#_4","title":"\u671f\u95f4\u9047\u5230\u7684\u95ee\u9898","text":""},{"location":"chap_apm/5apm_Sentry/#trace-exporter","title":"\u600e\u4e48\u5b9a\u5236\u81ea\u5df1\u7684 Trace Exporter\uff1f","text":"<p>\u4e3b\u8981\u8fd8\u662f\u53c2\u8003 https://github.com/open-telemetry/opentelemetry-collector-contrib \u4ed3\u5e93\u4e2d\u7684\u5b9e\u73b0\u3002Collector \u8bbe\u8ba1\u65f6\u5df2\u7ecf\u8003\u8651\u4e86\u7528\u6237\u81ea\u5b9a\u4e49\uff0c\u6240\u4ee5\u6309\u7167\u5b98\u65b9\u7684\u7ea6\u5b9a\u5f00\u53d1\u5373\u53ef\uff0c\u81f3\u4e8e sentryexporter \u5728\u5b98\u65b9\u4ed3\u5e93\u5df2\u7ecf\u5b58\u5728\u4e86\uff0c\u6240\u4ee5\u6211\u53ea\u662f\u5b9a\u5236\u5316\u4e86\u4e00\u4e0b\u3002</p> <p>\u8fd9\u91cc\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u4f60\u7684collector\u9700\u8981\u4f7f\u7528\u7279\u5b9a\u7684\u63d2\u4ef6\uff0c\u90a3\u4e48\u9700\u8981\u4f7f\u7528\u5b98\u65b9\u7684 https://github.com/open-telemetry/opentelemetry-collector/cmd/builder \u6765\u81ea\u5df1\u5b9a\u5236\u7f16\u8bd1 collector, \u8fd9\u4e00\u70b9\u4e5f\u53ef\u4ee5\u5728\u6211\u63d0\u4f9b\u7684\u5b9e\u8df5\u4ee3\u7801\u4e2d\u627e\u5230\u3002</p>"},{"location":"chap_apm/5apm_Sentry/#collector-agent","title":"Collector \u548c Agent \u7684\u5dee\u5f02\uff1f","text":"<p>\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\uff1a\u4e2d\u5fc3\u5316\u548c\u5206\u5e03\u5f0f\u90e8\u7f72\u7684\u533a\u522b\uff0c\u5728\u5b9e\u73b0\u4e0a\u5e76\u6ca1\u6709\u533a\u522b\u3002\u81f3\u4e8e\u4f60\u5e94\u8be5\u4f7f\u7528\u54ea\u79cd\u90e8\u7f72\u65b9\u5f0f\uff0c\u5f53\u7136\u89c6\u4f60\u7684\u96c6\u7fa4\u89c4\u6a21\u800c\u5b9a\uff0c\u5982\u679c\u53ea\u6709\u4e0d\u5230100\u4e2a\u670d\u52a1\u5b9e\u4f8b\uff0c\u4e2a\u4eba\u89c9\u5f97\u4ec5\u4ec5collector\u8db3\u4ee5\uff0c\u76f4\u5230\u4e0d\u8db3\u4ee5\u627f\u8f7d\u3002\u53cd\u4e4b\uff0c\u5982\u679c\u4f60\u96c6\u7fa4\u4e2d\u8282\u70b9\u4f17\u591a\uff0c\u670d\u52a1\u5b9e\u4f8b\u4e5f\u4f17\u591a\uff0c\u90a3\u4e48\u6700\u597d\u4e00\u5f00\u59cb\u5c31\u4e0aagent\u3002</p>"},{"location":"chap_apm/5apm_Sentry/#k8s-agent-collector","title":"k8s \u4e2d\u5982\u4f55\u4ee5 agent \u65b9\u5f0f\u90e8\u7f72 collector\uff1f","text":"<p>\u5b98\u65b9\u4e5f\u5df2\u7ecf\u63d0\u4f9b\u4e86\u6837\u4f8b\u4ee3\u7801\uff0c\u53ef\u4ee5\u53c2\u8003 https://github.com/open-telemetry/opentelemetry-collector/examples/k8s/otel-config.yaml\u3002</p> <p>\u5927\u81f4\u601d\u8def\u4e3a\uff1a\u901a\u8fc7DaemonSet \u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a Collector \u5b9e\u4f8b\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5982\u679c\u60f3\u8981\u914d\u7f6e <code>NODE_IP:PORT</code> \u7684\u65b9\u5f0f\u8ba9\u8be5\u8282\u70b9\u4e0a\u7684\u670d\u52a1\u76f4\u8fde agent\uff0c\u90a3\u4e48\u9700\u8981\u5728 <code>otel-config.yaml</code> \u4e2d\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>apiVersion: apps/v1\n# ....\ntemplate:\n    metadata:\n    labels:\n        app: opentelemetry\n        component: otel-agent\n    spec:\n        hostNetwork: true                  # \u589e\u52a0\u8fd9\u4e00\u884c\n        dnsPolicy: ClusterFirstWithHostNet # \u589e\u52a0\u8fd9\u4e00\u884c\n        containers:\n            # ...\n</code></pre> <p>\u5f53\u7136\u4e0d\u6b62\u8fd9\u4e48\u4e00\u79cd\u65b9\u5f0f\uff0c\u6bd4\u5982\u8fd8\u53ef\u4ee5\u4f7f\u7528 hostPort, \u89c6\u4f60\u7684k8s\u96c6\u7fa4\u914d\u7f6e\u800c\u5b9a\u3002</p>"},{"location":"chap_apm/5apm_Sentry/#sentry","title":"sentry\u4f5c\u4e3a\u94fe\u8def\u91c7\u96c6\u7ec4\u4ef6\u7684\u4f18\u7f3a\u70b9","text":"<p>\u7f3a\u70b9:</p> <p>sentry \u7684\u4e3b\u8981\u573a\u666f\u5e76\u4e0d\u662f\u5728\u4e8e\u94fe\u8def\u91c7\u96c6\uff0c\u800c\u662f\u5728\u4e8e\u524d\u7aef\u9875\u9762\u91c7\u96c6\uff08\u9875\u9762\u52a0\u8f7d/\u8def\u5f84/\u65e5\u5fd7\uff09\uff0c\u5305\u62ec\u9875\u9762\u5f02\u5e38\u6570\u636e\uff1b\u4e3b\u8981\u6839\u636e\u5728\u4e8e\u5b83\u72ec\u6709\uff08\u6216\u8bb8\uff09\u7684\u94fe\u8def\u91c7\u96c6\u6982\u5ff5\u3002\u5176\u4e2d\u5e38\u89c1\u7684\u5982\u4e0b\uff1a</p> <p></p> <p>\u4f18\u70b9:</p> <ul> <li>\u5df2\u7ecf\u652f\u6301\u524d\u540e\u7aef\u94fe\u8def\u6253\u901a\uff0c\u96c6\u6210\u5c55\u793a\u524d\u7aef\u9875\u9762\u4e0a\u53d1\u751f\u7684\u4e00\u5207\u884c\u4e3a\u3002</li> <li>\u5355\u72ec\u5bf9\u5f02\u5e38\u8fdb\u884c\u91c7\u96c6\u548c\u5c55\u793a\u3002</li> </ul>"},{"location":"chap_apm/5apm_Sentry/#opentelemetry","title":"OpenTelemetry\u4e2d\u7684\u6982\u5ff5","text":"<p>\u8fd9\u91cc\u53ea\u662f\u7f57\u5217\u4e86 Tracing \u76f8\u5173\u7684\u6982\u5ff5\uff1a</p> <p></p>"},{"location":"chap_apm/6k8s_watching/","title":"\u7b2c\u516d\u8282 \u804a\u804a\u53ef\u89c2\u6d4b\u6027\u4e4b\u6570\u636e\u6a21\u578b","text":"<p>\u5728 201x \u5e74\uff0c\u968f\u7740\u5bb9\u5668\u6280\u672f\u7684\u51fa\u73b0\uff0c\u5bb9\u5668\u7684\u90e8\u7f72\u65b9\u5f0f\u9010\u6e10\u88ab\u5404\u5927\u4e92\u8054\u7f51\u516c\u53f8\u91c7\u7528\uff0c\u76f8\u6bd4\u7269\u7406\u673a/\u865a\u62df\u673a\uff0c\u5bb9\u5668\u7684\u597d\u5904\u662f\u73af\u5883\u9694\u79bb\u3001\u8f7b\u91cf\u3001\u5feb\u901f\u3002</p> <p>\u4f46\u662f\u7ba1\u7406\u5bb9\u5668\u662f\u4e00\u4ef6\u590d\u6742\u7684\u4e8b\u60c5\uff0c\u540e\u6765\u51fa\u73b0\u4e86 Kubernetes\uff0c\u6210\u4e3a\u4e86\u4e8b\u5b9e\u4e0a\u7684\u5bb9\u5668\u7ba1\u7406\u6807\u51c6\uff0c\u76ee\u524d\u5404\u5927\u516c\u53f8\u90fd\u5728\u4f7f\u7528 Kubernetes\u3002</p> <p>\u56e0\u4e3a\u5bb9\u5668\u548c Kubernetes \u964d\u4f4e\u4e86\u670d\u52a1\uff08\u5e94\u7528\uff09\u7684\u90e8\u7f72\u548c\u5347\u7ea7\u6210\u672c\uff0c\u6240\u4ee5\u50ac\u751f\u4e86\u300c\u5fae\u670d\u52a1\u300d\u7684\u6982\u5ff5\uff0c\u670d\u52a1\u4ece\u300c\u5355\u4f53\u590d\u6742\u670d\u52a1\u300d\u5411\u300c\u591a\u4e2a\u7b80\u5355\u670d\u52a1\u300d\u6f14\u53d8\uff0c\u5728\u4e4b\u524d\uff0c\u9700\u8981\u7740\u91cd\u8003\u8651\u670d\u52a1\u5185\u7684\u67b6\u6784\u8bbe\u8ba1\uff0c\u5355\u4e2a\u670d\u52a1\u5bf9\u5916\u63d0\u4f9b\u5c3d\u53ef\u80fd\u591a\u7684\u80fd\u529b\uff0c\u800c\u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u4f1a\u76f4\u63a5\u628a\u5355\u4e2a\u670d\u52a1\u62c6\u5206\u6210\u591a\u4e2a\u670d\u52a1\uff0c\u670d\u52a1\u4e4b\u95f4\u7528 API \u8c03\u7528\u3002</p> <p>\u8fd9\u91cc\u4e5f\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u67b6\u6784\u8bbe\u8ba1\u7684\u91cd\u8981\u6027\u964d\u4f4e\uff0cAPI \u8bbe\u8ba1\u7684\u91cd\u8981\u6027\u63d0\u9ad8\u3002</p> <p>\u53e6\u5916\uff0c\u62c6\u5206\u51fa\u5fae\u670d\u52a1\u540e\uff0c\u7f16\u7a0b\u7684\u96be\u5ea6\u4e8b\u5b9e\u4e0a\u964d\u4f4e\u4e86\uff0c\u5bf9\u7f16\u7a0b\u4eba\u5458\u7684\u8981\u6c42\u4e5f\u964d\u4f4e\u4e86\u3002</p> <p>\u8fd9\u8bf4\u660e\u4e00\u4e2a\u4e8b\u5b9e\uff0c\u968f\u7740\u57fa\u7840\u8bbe\u65bd\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u4f1a\u6709\u8d8a\u6765\u8d8a\u591a\u7684\u300c\u7f16\u7a0b\u80fd\u529b\u300d\u6c89\u6dc0\u6210\u57fa\u7840\u8bbe\u65bd\uff0c\u4f7f\u7f16\u7a0b\u7684\u96be\u5ea6\u4e0d\u65ad\u964d\u4f4e\uff1a\u8f6f\u4ef6\u5f00\u53d1\u4e0d\u65ad\u5411\u7b80\u5355\u7684\u65b9\u5f0f\u53d1\u5c55\u3002</p> <p>\u4f46\u662f\uff0c\u968f\u7740\u5fae\u670d\u52a1\u7684\u53d1\u5c55\uff0c\u670d\u52a1\u53d8\u5f97\u592a\u591a\u4e86\uff0c\u7ba1\u7406\u8d1f\u8d23\u5ea6\u53c8\u4e0a\u5347\u4e86\uff0c\u6bd4\u5982\u600e\u4e48\u53bb\u89e3\u51b3\u670d\u52a1\u53d1\u73b0\u7684\u95ee\u9898\u3001\u600e\u4e48\u63a7\u5236\u6d41\u91cf\u3001\u670d\u52a1\u4e4b\u95f4\u600e\u4e48\u505a\u9694\u79bb\uff0c\u670d\u52a1\u72b6\u6001\u600e\u4e48\u89c2\u6d4b\u7b49\u7b49\u3002\u8fd9\u65f6\u5019\u53c8\u51fa\u73b0\u4e86\u300c\u670d\u52a1\u6cbb\u7406\u300d\u7684\u6982\u5ff5\uff0c\u5173\u4e8e\u670d\u52a1\u6cbb\u7406\uff0c\u6709\u4e00\u4e2a\u65b0\u7684\u8bcd\uff1aService Mesh\uff0c\u73b0\u5728\u4e8b\u5b9e\u6807\u51c6\u662f Istio\u3002</p>"},{"location":"chap_apm/6k8s_watching/#_2","title":"\u6982\u8ff0","text":"<p>\u53ef\u89c2\u6d4b\u6027\u662f\u4e3a\u4e86\u5e94\u5bf9\u5fae\u670d\u52a1\u7684\u590d\u6742\u573a\u666f\u4e0b\u53d1\u660e\u51fa\u6765\u7684\u4e00\u4e2a\u8bcd\uff0c\u672c\u8d28\u4e0a\u662f\u4e3a\u4e86\u8861\u91cf\u7cfb\u7edf\u8fd0\u884c\u7684\u72b6\u6001\uff0c\u53ef\u89c2\u6d4b\u6027\u662f\u670d\u52a1\u6cbb\u7406\u7684\u4e00\u4e2a\u7ef4\u5ea6\uff0c\u548c\u529f\u80fd\u6027\u3001\u53ef\u6d4b\u8bd5\u6027\u3001\u53ef\u8fd0\u7ef4\u6027\u4e00\u6837\u3002</p> <p>\u4e00\u822c\u5e38\u8bf4\u53ef\u89c2\u6d4b\u6027\u5305\u542b\u4e09\u4e2a\u5ea6\u91cf\u89d2\u5ea6\uff1aMetric\u3001Logging\u3001Tracing\uff0c\u5176\u5b9e\u8fd8\u6709\u4e00\u4e2a\uff1aProfiling\u3002</p> <ul> <li>Metric\uff1a\u6307\u6807\uff0c\u5bf9\u7cfb\u7edf\u4e2d\u67d0\u4e00\u7c7b\u4fe1\u606f\u7684\u805a\u5408\u7edf\u8ba1\uff0c\u6bd4\u5982 QPS\u3001\u5ef6\u8fdf\u3001\u9519\u8bef\u7387\u7b49\u3002</li> <li>Logging\uff1a\u65e5\u5fd7\uff0c\u5bf9\u7cfb\u7edf\u6240\u505a\u884c\u4e3a\u7684\u4e00\u79cd\u8bb0\u5f55\uff0c\u5b83\u662f\u79bb\u6563\u7684\uff0c\u6ca1\u6709\u76f8\u5173\u6027\uff0c\u4e3a\u4e86\u533a\u5206\u8fd9\u79cd\u8bb0\u5f55\u7684\u91cd\u8981\u7a0b\u5ea6\uff0c\u4f1a\u5206\u7ea7\u522b\uff08DEBUG\u3001INFO\u3001WARN\u3001ERROR\u3001FATAL\uff09\u3002</li> <li>Tracing\uff1a\u8c03\u7528\u94fe\uff0c\u5b83\u53cd\u6620\u7684\u662f\u8bf7\u6c42\u7ecf\u8fc7\u67d0\u4e2a\u7ec4\u4ef6\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u7ecf\u8fc7\u7ec4\u4ef6\u7684\u6570\u636e\u53eb\u505a Span\uff0cSpan \u53ef\u4ee5\u4f53\u73b0\u7ecf\u8fc7\u7ec4\u4ef6\u7684\u72b6\u6001\u3001\u4e00\u4e9b\u5173\u952e\u5c5e\u6027\u548c\u4e8b\u4ef6\u3001\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002Span \u4e4b\u95f4\u901a\u8fc7 Trace ID \u5173\u8054\u3002</li> <li>Profiling\uff1a\u4e00\u822c\u53eb\u505a Continuous Profiling\uff0c\u6301\u7eed\u5206\u6790\uff0c\u5b83\u53cd\u6620\u7684\u662f\u7a0b\u5e8f\u5185\u90e8\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u6bd4\u5982\u6808\u8c03\u7528\u3001\u6267\u884c\u65f6\u95f4\u7b49\u3002\u53ef\u4ee5\u628a Profiling \u53ef\u89c6\u5316\u6210\u706b\u7130\u56fe\u65b9\u9762\u5206\u6790\u95ee\u9898\u3002</li> </ul> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u57fa\u4e8e\u8fd9\u4e9b\u5ea6\u91cf\u5904\u7406\u6545\u969c\u7684\u6d41\u7a0b\u662f\uff1aMetric \u2192 Tracing \u2192 Logging \u2192 Profiling</p>"},{"location":"chap_apm/6k8s_watching/#_3","title":"\u6570\u636e\u6a21\u578b","text":"<p>\u5728 Tracing \u9886\u57df\uff0c\u4e4b\u524d\u6709\u4e24\u4e2a\u9879\u76ee\uff0c\u4e00\u4e2a\u662f OpenTracing\uff0c\u5b83\u662f\u4e00\u4e2a\u89c4\u8303\uff0c</p> <ul> <li>Jaeger \u5c31\u662f\u57fa\u4e8e OpenTracing \u7684\u5f00\u6e90\u5b9e\u73b0\uff0c</li> <li>\u53e6\u4e00\u4e2a\u662f OpenCensus\uff0c\u5b83\u662f Google \u5f00\u6e90\u7684\u5ea6\u91cf\u5de5\u5177\u3002</li> </ul> <p>\u8fd9\u4e24\u4e2a\u9879\u76ee\u529f\u80fd\u9ad8\u5ea6\u91cd\u5408\uff0c\u5728 CNCF \u4e3b\u5bfc\u4e0b\u5408\u5e76\u6210\u4e86 OpenTelemetry\uff0c\u800c OpenTracing \u548c OpenCensus \u4e5f\u4e0d\u518d\u7ef4\u62a4\u3002</p> <p>\u5f53\u7136 OpenTelemetry \u4e0d\u6b62\u505a Tracing\uff0c\u8fd8\u8986\u76d6 Metric \u548c Logging\uff0c\u5b83\u7684\u76ee\u6807\u662f\u7edf\u4e00\u53ef\u89c2\u6d4b\u6027\u7684\u6807\u51c6\u534f\u8bae\uff0c\u5305\u62ec\u6570\u636e\u6a21\u578b\u3001API \u89c4\u8303\u3001\u591a\u8bed\u8a00 SDK\u3001\u91c7\u96c6\u5668\u3002</p> <p>OpenTelemetry \u53ea\u505a\u7edf\u4e00\u7684\u534f\u8bae\u548c\u89c4\u8303\uff0c\u5177\u4f53\u6570\u636e\u7684\u540e\u7aef\u5b58\u50a8\u548c\u5c55\u793a\u4e0d\u662f\u5b83\u7684\u8303\u56f4\u3002\u534f\u8bae\u548c\u89c4\u8303\u662f\u53ef\u89c2\u6d4b\u6027\u5bf9\u5916\u66b4\u9732\u7684\u300c\u63a5\u53e3\u300d\uff0c\u5b83\u7684\u7edf\u4e00\u5bf9\u4e8e\u4f7f\u7528\u65b9\u6765\u8bf4\u662f\u5de8\u5927\u7684\u597d\u5904\uff0c\u76ee\u524d\u6765\u770b\uff0cOpenTelemetry \u672a\u6765\u4f1a\u6210\u4e3a\u4e8b\u5b9e\u6807\u51c6\u3002</p> <p>\u4e3a\u4e86\u5bf9\u63a5\u4e0d\u540c\u7684\u540e\u7aef\u5b9e\u73b0\uff0cOpenTelemetry \u63d0\u4f9b\u4e86\u5404\u79cd Exporter\uff0c\u6bd4\u5982\u4e3a\u5bf9\u63a5 Prometheus \u63d0\u4f9b\u4e86 Prometheus Exporter\uff0c\u5bf9\u63a5 Cortex \u548c Thanos \u63d0\u4f9b\u4e86 Prometheus Remote Write Exporter\uff0c\u5bf9\u63a5 Loki \u63d0\u4f9b\u4e86 Loki Exporter\uff0c\u5bf9\u63a5 Jaeger \u63d0\u4f9b\u4e86 Jaeger gRPC Exporter\u3002</p> <p>\u4e0d\u8fc7\uff0c\u76ee\u524d OpenTelemetry \u8fd8\u4e0d\u6210\u719f\uff0c\u672c\u6587\u7684\u6570\u636e\u6a21\u578b\u57fa\u4e8e\u6211\u4eec\u4e8b\u5b9e\u4e0a\u4f7f\u7528\u7684\u540e\u7aef\u5b9e\u73b0\u6765\u8ba8\u8bba\u3002</p> <ul> <li>Metric \u6211\u4eec\u4f7f\u7528\u5206\u5e03\u5f0f Prometheus \u65b9\u6848 Cortex\uff0c\u6570\u636e\u6a21\u578b\u548c Prometheus \u4e00\u81f4</li> <li>Logging \u6211\u4eec\u4f7f\u7528 Loki</li> <li>Tracing \u6211\u4eec\u4f7f\u7528 Grafana Tempo\uff0cTempo \u672c\u8eab\u517c\u5bb9 Zipkin\u3001Jaeger\u3001OpenTelemetry \u7b49\u534f\u8bae\uff0c\u6240\u4ee5 Tracing \u76f4\u63a5\u91c7\u7528 OpenTelemetry \u7684\u6570\u636e\u6a21\u578b</li> <li>Profiling \u7684\u540e\u7aef\u5b9e\u73b0\u57fa\u672c\u53ef\u4ee5\u590d\u7528 Loki\uff0c\u6570\u636e\u6a21\u578b\u4e5f\u548c Logging \u7c7b\u4f3c</li> </ul> <p>\u5148\u770b Metric\uff0c\u5b83\u7684\u6570\u636e\u6a21\u578b\uff1aLabelSet + Timestamp + Number</p> <ul> <li>LabelSet \u5c31\u662f Series\uff0c\u662f\u82e5\u5e72\u4e2a label name / value \u7ec4\u5408\uff0c\u6307\u6807\u540d\u79f0\u4e5f\u662f\u4e00\u4e2a label name / value\u3002</li> <li>Timestamp \u662f\u65f6\u95f4\u6233\uff0c\u7cbe\u5ea6\u662f\u6beb\u7c73\u3002</li> <li>Number \u662f\u6570\u503c\uff0c\u7c7b\u578b\u662f float64\u3002</li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a Metric \u4f8b\u5b50\uff1a</p> <p></p> <p>\u53e6\u5916\uff0cPrometheus \u5185\u7f6e\u51e0\u79cd Metric \u7c7b\u578b\uff0c\u5305\u62ec Counter\u3001Gauge\u3001Histogram\u3001Summary\uff0cCounter \u662f\u81ea\u589e\u7684\uff0cGauge \u53ef\u589e\u53ef\u51cf\uff0cHistogram \u662f\u76f4\u65b9\u56fe\uff0cSummary \u662f\u6458\u8981\uff0cHistogram \u548c Summary \u533a\u522b\u662f Histogram \u9700\u8981\u901a\u8fc7 <code>_bucket</code> \u6765\u8ba1\u7b97 P \u503c\uff0c\u800c Summary \u5728\u5ba2\u6237\u7aef\u76f4\u63a5\u8ba1\u7b97\u597d P \u503c\uff0c\u76f4\u63a5\u5b58\u50a8\u5373\u53ef\u3002</p> <p>\u53e6\u5916\uff0cPrometheus \u8fd8\u6709\u5f88\u591a\u5185\u7f6e\u51fd\u6570\uff0c\u6765\u505a Metric \u7684\u805a\u5408\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002</p> <p>\u518d\u770b Logging\uff0c\u6570\u636e\u6a21\u578b\uff1aLabelSet + Timestamp + String</p> <p>\u548c Metric \u7c7b\u4f3c\uff0c\u53ea\u662f Number \u6362\u6210\u4e86 String\uff0cTimestamp \u7cbe\u5ea6\u662f\u7eb3\u79d2\u3002</p> <p>\u5728 Loki \u4e2d\uff0c\u4f7f\u7528 Logql \u8bed\u6cd5\u67e5\u8be2\u65e5\u5fd7\uff08\u548c Promql \u7c7b\u4f3c\uff09\uff0c\u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff1a</p> <pre><code>{container=\"query-frontend\",namespace=\"loki-dev\"} |= \"metrics.go\" | logfmt | duration &gt; 10s and throughput_mb &lt; 500\n</code></pre> <p>\u4e0b\u4e00\u4e2a\u662f Tracing\uff0cTracing \u6bd4\u8f83\u590d\u6742\uff1aOperation Name + Start / End Timestamp + Attributes + Events + Parent + SpanContext</p> <ul> <li>Operation Name\uff1a\u64cd\u4f5c\u540d</li> <li>Start / End Timestamp\uff1a\u5f00\u59cb\u548c\u7ed3\u675f\u65f6\u95f4</li> <li>Attributes\uff1aKV \u5bf9\uff0c\u5305\u62ec Status\uff08\u6bd4\u5982 OK\u3001Cancelled\u3001Permission Denied\uff09\u3001</li> <li>SpanKind\uff08CLIENT\u3001SERVER\u3001PRODUCER\u3001CONSUMER\u3001INTERNAL \u7b49\uff09\u3001\u81ea\u5b9a\u4e49\u4fe1\u606f\u7b49</li> <li>Events\uff1a\u82e5\u5e72\u4e2a\u5143\u7ec4\u5217\u8868\uff0c\u6bcf\u4e2a\u5143\u7ec4\u5305\u62ec timestamp\u3001name\u3001Attributes\uff0c\u7528\u4e8e\u8bb0\u5f55\u4e00\u7cfb\u5217\u91cd\u8981\u4e8b\u4ef6</li> <li>Parent \u5305\u542b\u7236\u4eb2\u7684 Span ID\u3001Trace ID</li> <li>SpanContext \u5305\u542b\u81ea\u8eab\u7684 Span ID\u3001Trace ID</li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff1a</p> <p></p> <p>\u6700\u540e\u770b Profiling\uff0c\u6570\u636e\u6a21\u578b\uff1aLabelSet + Timestamp + []byte</p> <p>Profiling \u7684\u6570\u636e\u683c\u5f0f\u662f protocol buffers\uff0c\u6240\u4ee5\u7528 <code>[]byte</code>\u3002</p> <p>\u4e0a\u9762\u4ecb\u7ecd\u4e86\u56db\u79cd\u6570\u636e\u6a21\u578b\uff0c\u5176\u5b9e\u5728\u5b9e\u9645\u573a\u666f\u4e2d\uff0c\u5b83\u4eec\u4e4b\u95f4\u4e5f\u4f1a\u4e92\u76f8\u878d\u5408\uff0c\u4e0b\u9762\u8bf4\u51e0\u79cd\u5e38\u89c1\u7684\u878d\u5408\u573a\u666f\u3002</p> <p>\u7b2c\u4e00\uff0cMetric \u548c Tracing \u878d\u5408\u3002</p> <p>\u8fd9\u91cc\u8981\u7528\u5230 Exemplar\uff0cExemplar \u6700\u65e9\u88ab\u7528\u5728 Google \u7684 StackDriver \u4e2d\uff0c\u540e\u9762\u6210\u4e3a\u4e86 OpenMetrics \u6807\u51c6\u7684\u4e00\u90e8\u5206\uff0c\u5728\u5e94\u7528\u901a\u8fc7\u6807\u51c6 /metrics \u7aef\u53e3\u66b4\u9732 Metric \u65f6\uff0cExemplar \u4fe1\u606f\u4e5f\u4f1a\u88ab\u4e00\u8d77\u66b4\u9732\u3002</p> <p>Prometheus \u76ee\u524d\u5df2\u652f\u6301 Exemplar\uff0cPrometheus \u901a\u8fc7 <code>/metrics</code> \u91c7\u96c6\u6570\u636e\u65f6\u4e5f\u4f1a\u628a Exemplar \u5b58\u50a8\u4e0b\u6765\uff0c\u5e76\u66b4\u9732\u5355\u72ec\u7684 API \u6765\u83b7\u53d6 Exemplar \u4fe1\u606f\u3002</p> <pre><code>$ curl -g 'http://localhost:9090/api/v1/query_exemplar?query=test_exemplar_metric_total&amp;start=2020-09-14T15:22:25.479Z&amp;end=020-09-14T15:23:25.479Z'\n{\n    \"status\": \"success\",\n    \"data\": [\n        {\n            \"seriesLabels\": {\n                \"__name__\": \"test_exemplar_metric_total\",\n                \"instance\": \"localhost:8090\",\n                \"job\": \"prometheus\",\n                \"service\": \"bar\"\n            },\n            \"exemplars\": [\n                {\n                    \"labels\": {\n                        \"traceID\": \"EpTxMJ40fUus7aGY\"\n                    },\n                    \"value\": 6,\n                    \"timestamp\": 1600096945479,\n                    \"hasTimestamp\": true\n                }\n            ]\n        },\n    ]\n}\n</code></pre> <p>\u501f\u52a9 Exemplar\uff0c\u53ef\u4ee5\u628a Trace ID \u4f5c\u4e3a\u4e00\u4e2a label pair \u52a0\u5165 Exemplar \u4e2d\uff0c\u4ece\u800c\u53ef\u4ee5\u5728Prometheus \u67e5\u8be2\u5230 Tracing \u7684\u4fe1\u606f\uff0c\u4ece\u800c\u5c06 Metric \u548c Tracing \u8fde\u63a5\u8d77\u6765\u3002</p> <p></p> <p>\u7b2c\u4e8c\uff0cLogging \u548c Tracing \u878d\u5408\u3002</p> <p>\u53ea\u8981\u4f7f\u7528\u5e26\u6709 Tracing \u5e93\u7684 SDK\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u4f1a\u5e26\u4e0a Trace ID\uff0c\u5e76\u628a\u8fd9\u4e9b ID \u6253\u5728\u65e5\u5fd7\u4e2d\u3002</p> <p>\u901a\u8fc7 Trace ID \u53ef\u4ee5\u5b9a\u4f4d\u5230\u4e00\u4e2a\u552f\u4e00\u7684 Tracing\uff0c \u8df3\u8f6c\u5230 Tracing \u7cfb\u7edf\u7684 UI \u8fdb\u884c\u67e5\u8be2\u3002</p> <p>\u7b2c\u4e09\uff0cMetric \u548c Profiling \u878d\u5408\u3002</p> <p>\u57fa\u4e8e Exemplar\uff0c\u628a Profiling ID \u4e5f\u653e\u5165 Exemplar \u4e2d\uff0cPrometheus \u652f\u6301\u5b58\u50a8\u548c\u67e5\u8be2\u5373\u53ef\u3002</p> <p>\u81f3\u4e8e\u5c55\u793a\uff0c\u53ef\u4ee5\u5728 Grafana \u4e0a\u5f00\u53d1\u4e00\u4e2a pprof \u7684 Panel \u63d2\u4ef6\uff0c\u8fd9\u6837\u53ef\u4ee5\u5c55\u793a Profiling\u3002</p>"},{"location":"chap_ot/0OpenTelemetrey_intro/","title":"0 OpenTelemetry\u4fdd\u59c6\u5165\u95e8\u653b\u7565\u53efPPT-2023","text":"<ul> <li>\u5206\u5e03\u5f0f\u8ffd\u8e2a</li> <li>OpenTelemetry \u662f\u4ec0\u4e48\uff1f</li> <li>OpenTelemetry \u68c0\u6d4b\uff08\u81ea\u52a8\u548c\u624b\u52a8\uff09</li> <li>OpenTelemetry \u534f\u8bae\uff08OTLP\uff09</li> <li>OpenTelemetry Collectors</li> <li>OpenTelemetry Collectors \u90e8\u7f72\u6a21\u5f0f</li> <li>OpenTelemetry \u540e\u7aef</li> <li>OpenTelemetry on Kubernetes</li> <li>OpenTelemetry Operator</li> <li>OpenTelemetry \u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f</li> </ul>"},{"location":"chap_ot/0OpenTelemetrey_intro/#_1","title":"\u5206\u5e03\u5f0f\u8ffd\u8e2a","text":""},{"location":"chap_ot/0OpenTelemetrey_intro/#_2","title":"\u4e3a\u4ec0\u4e48\u6211\u4eec\u9700\u8981\u8ffd\u8e2a\uff1f","text":"<p>\u6211\u4eec\u9700\u8981\u4e3a\u4ec0\u4e48\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1f\u4e3a\u4ec0\u4e48\u6211\u4eec\u4e0d\u80fd\u53ea\u4f7f\u7528\u6307\u6807\u548c\u65e5\u5fd7\u5462\uff1f\u5047\u8bbe\u4f60\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684\u5fae\u670d\u52a1\u67b6\u6784</p> <p></p> <p>\u73b0\u5728\u60f3\u8c61\u4e00\u4e0b\u6765\u81ea\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u3002</p> <p>\u4ece\u4e0a\u9762\u7684\u67b6\u6784\u56fe\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\uff0c\u4e00\u4e2a\u8bf7\u6c42\u53ef\u80fd\u8981\u7ecf\u8fc7\u51e0\u5341\u4e2a\u6216\u51e0\u767e\u4e2a\u7f51\u7edc\u8c03\u7528\u3002\u8fd9\u4f7f\u5f97\u6211\u4eec\u5f88\u96be\u77e5\u9053\u8bf7\u6c42\u6240\u7ecf\u8fc7\u7684\u6574\u4e2a\u8def\u5f84\uff0c\u5982\u679c\u53ea\u6709\u65e5\u5fd7\u548c\u6307\u6807\uff0c\u90a3\u4e48\u6545\u969c\u6392\u67e5\u4f1a\u975e\u5e38\u590d\u6742\u3002</p> <p>\u5f53\u6211\u4eec\u7684\u5e94\u7528\u51fa\u73b0\u95ee\u9898\u65f6\uff0c\u6211\u4eec\u9700\u8981\u89e3\u51b3\u5f88\u591a\u95ee\u9898\u3002</p> <ul> <li>\u6211\u4eec\u5982\u4f55\u627e\u51fa\u6839\u672c\u539f\u56e0\uff1f</li> <li>\u6211\u4eec\u5982\u4f55\u76d1\u89c6\u5b83\u6240\u7ecf\u8fc7\u7684\u6240\u6709\u670d\u52a1\uff1f</li> </ul> <p>\u5206\u5e03\u5f0f\u8ddf\u8e2a\u53ef\u4ee5\u5e2e\u52a9\u67e5\u770b\u6574\u4e2a\u8bf7\u6c42\u8fc7\u7a0b\u4e2d\u670d\u52a1\u4e4b\u95f4\u7684\u4ea4\u4e92\uff0c\u5e76\u53ef\u4ee5\u8ba9\u6211\u4eec\u6df1\u5165\u4e86\u89e3\u7cfb\u7edf\u4e2d\u8bf7\u6c42\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u3002\u5b83\u5e2e\u52a9\u6211\u4eec\u53d1\u73b0\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u9519\u8bef\u3001\u74f6\u9888\u548c\u6027\u80fd\u95ee\u9898\u3002</p> <p>\u8ffd\u8e2a\u4ece\u7528\u6237\u4e0e\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u4ea4\u4e92\u7684\u4e00\u523b\u5f00\u59cb\uff0c\u6211\u4eec\u5e94\u8be5\u80fd\u591f\u770b\u5230\u6574\u4e2a\u8bf7\u6c42\u76f4\u5230\u6700\u540e\u4e00\u5c42\u3002</p> <p>\u8ddf\u8e2a\u6570\u636e\uff08\u4ee5 span \u7684\u5f62\u5f0f\uff09\u751f\u6210\u4fe1\u606f\uff08\u5143\u6570\u636e\uff09\uff0c\u53ef\u4ee5\u5e2e\u52a9\u4e86\u89e3\u8bf7\u6c42\u5ef6\u8fdf\u6216\u9519\u8bef\u662f\u5982\u4f55\u53d1\u751f\u7684\uff0c\u4ee5\u53ca\u5b83\u4eec\u5bf9\u6574\u4e2a\u8bf7\u6c42\u4f1a\u4ea7\u751f\u4ec0\u4e48\u6837\u7684\u5f71\u54cd\u3002</p> <p></p> <p>\u6574\u4e2a\u7684\u8fd9\u4e00\u4e2a\u5b83\u53eb\u505aTrace\u4e00\u4e2a\u94fe\u8def\uff0c \u7136\u540e\u6bd4\u5982\u8bf4A\u5230B\uff0cB\u5230C\u8fd9\u4e9b\uff0c\u8fd9\u4e9b\u5176\u5b9e\u53eb\u505a\u4e00\u4e2a\u4e00\u4e2a\u7684Span</p>"},{"location":"chap_ot/0OpenTelemetrey_intro/#_3","title":"\u5982\u4f55\u5b9e\u73b0\u8ffd\u8e2a\uff1f","text":"<p>\u4e3a\u4e86\u5b9e\u73b0\u8ffd\u8e2a\uff0c\u6211\u4eec\u9700\u8981\u505a\u4ee5\u4e0b\u51e0\u4ef6\u4e8b\uff1a</p> <ol> <li>\u68c0\u6d4b\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f</li> <li>\u6536\u96c6\u548c\u5904\u7406\u6570\u636e</li> <li>\u5b58\u50a8\u548c\u53ef\u89c6\u5316\u6570\u636e\uff0c\u4ee5\u4fbf\u6211\u4eec\u53ef\u4ee5\u67e5\u8be2\u5b83</li> </ol> <p>\u4e3a\u6b64\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e24\u4e2a\u5f00\u6e90\u9879\u76ee\uff1aOpenTelemetry \u548c Grafana Tempo\u3002</p> <p></p>"},{"location":"chap_ot/0OpenTelemetrey_intro/#opentelemetry","title":"OpenTelemetry \u662f\u4ec0\u4e48\uff1f","text":"<p>OpenTelemetry \u53ef\u4ee5\u7528\u4e8e\u4ece\u5e94\u7528\u7a0b\u5e8f\u6536\u96c6\u6570\u636e\u3002</p> <p>\u5b83\u662f\u4e00\u7ec4\u5de5\u5177\u3001API \u548c SDK \u96c6\u5408\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5b83\u4eec\u6765\u68c0\u6d4b\u3001\u751f\u6210\u3001\u6536\u96c6\u548c\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\uff08\u6307\u6807\u3001\u65e5\u5fd7\u548c\u8ffd\u8e2a\uff09\uff0c\u4ee5\u5e2e\u52a9\u5206\u6790\u5e94\u7528\u7684\u6027\u80fd\u548c\u884c\u4e3a\u3002</p> <p></p> <ul> <li> <p>Microservice \u662f\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801</p> <ul> <li>\u53ef\u80fd\u9700\u8981\u901a\u8fc7API\u6216\u8005SDK\u96c6\u6210</li> <li>\u5e94\u7528\u624b\u52a8\u53bb\u505a\u4e00\u4e9b\u57cb\u70b9</li> <li>\u6709\u4e00\u4e9b\u7f16\u7a0b\u8bed\u8a00\uff0c\u6bd4\u5982\u8bf4\u50cfjava\uff0c Python\u8fd9\u4e9b\uff0c\u4e5f\u652f\u6301auto\u57cb\u70b9</li> <li>\u628a\u57cb\u70b9\u57cb\u8fdb\u53bb\u4e4b\u540e\uff0c\u4f1a\u751f\u6210\u4e00\u751f\u6210\u6211\u4eec\u7684\u9065\u6d4b\u6570\u636e\uff0c\u53ef\u4ee5\u7528\u8fd9\u91cc\u7684OTLP</li> </ul> </li> <li> <p>\u6240\u8c13\u7684OpenTelemetry \u662f\u4e00\u4e2a\u6570\u636e\u89c4\u8303\u7684\u4e00\u4e2a\u534f\u8bae\uff0c\u4f1a\u628a\u8fd9\u4e2a\u6570\u636e\u53d1\u9001\u5230\u53d1\u9001\u5230\u4e00\u4e2a\u91c7\u96c6\u5668\uff0c\u6309\u7167\u6211\u4eec\u8fd9\u79cd\u89c4\u8303\u7684\u8bdd\uff0c \u90fd\u53ef\u4ee5\u76f4\u63a5\u53d1\u9001\u5230\u8fd9\u4e2a\u91c7\u96c6\u5668\u8fd9\u8fb9\uff0c \u7136\u540e\u91c7\u96c6\u5668\u8fd9\u8fb9\uff0c\u4ed6\u53ef\u4ee5\u53bb\u505a\u4e00\u7cfb\u5217\u7684\u5904\u7406\uff0c \u6bd4\u5982\u52a0\u4e00\u4e9b\u539f\u4fe1\u606f\uff0c\u505a\u4e00\u4e9b\u88c1\u526a\uff0c\u91c7\u6837\u3002</p> </li> <li>\u5904\u7406\u5b8c\u6210\u8fc7\u540e\uff0c\u53ef\u4ee5\u53bb\u9009\u62e9\u53d1\u9001\u5230Jager, metrics \u6570\u636e\u53ef\u4ee5\u53d1\u9001\u5230Prometheus\u91cc\u9762\u53bb\uff0c\u65e5\u5fd7\u6570\u636e\u53d1\u9001\u5230Loki</li> </ul> <p></p> <p>OpenTelemetry \u662f\uff1a</p> <ul> <li>\u5f00\u6e90\u7684</li> <li>\u53d7\u5230\u53ef\u89c2\u6d4b\u9886\u57df\u884c\u4e1a\u9886\u5bfc\u8005\u7684\u91c7\u7528\u548c\u652f\u6301</li> <li>\u4e00\u4e2a CNCF \u9879\u76ee</li> <li>\u4e0e\u4f9b\u5e94\u5546\u65e0\u5173\u7684</li> </ul> <p>OpenTelemetry \u5305\u62ec\u53ef\u89c2\u6d4b\u6027\u7684\u4e09\u4e2a\u652f\u67f1\uff1a\u8ffd\u8e2a\u3001\u6307\u6807\u548c\u65e5\u5fd7\u3002\uff08\u672c\u6587\u5c06\u91cd\u70b9\u5173\u6ce8\u8ffd\u8e2a\uff09</p> <ul> <li>\u5206\u5e03\u5f0f\u8ffd\u8e2a\u662f\u4e00\u79cd\u8ddf\u8e2a\u670d\u52a1\u8bf7\u6c42\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u4ece\u5f00\u59cb\u5230\u7ed3\u675f\u7684\u65b9\u6cd5\u3002</li> <li>\u6307\u6807\u662f\u5bf9\u4e00\u6bb5\u65f6\u95f4\u5185\u6d3b\u52a8\u7684\u6d4b\u91cf\uff0c\u4ee5\u4fbf\u4e86\u89e3\u7cfb\u7edf\u6216\u5e94\u7528\u7a0b\u5e8f\u7684\u6027\u80fd\u3002</li> <li>\u65e5\u5fd7\u662f\u7cfb\u7edf\u6216\u5e94\u7528\u7a0b\u5e8f\u5728\u7279\u5b9a\u65f6\u95f4\u70b9\u53d1\u751f\u7684\u4e8b\u4ef6\u7684\u6587\u672c\u8bb0\u5f55\u3002</li> </ul>"},{"location":"chap_ot/0OpenTelemetrey_intro/#opentelemetry_1","title":"OpenTelemetry \u4e0e\u4f9b\u5e94\u5546\u65e0\u5173","text":"<p>OpenTelemetry \u63d0\u4f9b\u4e86\u4e00\u4e2a\u4e0e\u4f9b\u5e94\u5546\u65e0\u5173\u7684\u53ef\u89c2\u6d4b\u6027\u6807\u51c6\uff0c\u56e0\u4e3a\u5b83\u65e8\u5728\u6807\u51c6\u5316\u8ddf\u8e2a\u7684\u751f\u6210\u3002\u901a\u8fc7 OpenTelemetry\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u68c0\u6d4b\u57cb\u70b9\u4e0e\u540e\u7aef\u5206\u79bb\u3002\u8fd9\u610f\u5473\u7740\u6211\u4eec\u4e0d\u4f9d\u8d56\u4e8e\u4efb\u4f55\u5de5\u5177\uff08\u6216\u4f9b\u5e94\u5546\uff09</p> <p>\u6211\u4eec\u4e0d\u4ec5\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u6211\u4eec\u60f3\u8981\u7684\u7f16\u7a0b\u8bed\u8a00\uff0c\u8fd8\u53ef\u4ee5\u6311\u9009\u4efb\u4f55\u517c\u5bb9\u7684\u5b58\u50a8\u540e\u7aef\uff0c\u4ece\u800c\u907f\u514d\u88ab\u7ed1\u5b9a\u5728\u7279\u5b9a\u7684\u5546\u4e1a\u4f9b\u5e94\u5546\u4e0a\u9762\u3002</p> <p>\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u68c0\u6d4b\u4ed6\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u800c\u65e0\u9700\u77e5\u9053\u6570\u636e\u5c06\u5b58\u50a8\u5728\u54ea\u91cc\u3002</p> <p>OpenTelemetry \u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u521b\u5efa\u8ddf\u8e2a\u6570\u636e\u7684\u5de5\u5177\uff0c\u4e3a\u4e86\u83b7\u53d6\u8fd9\u4e9b\u6570\u636e\uff0c\u6211\u4eec\u9996\u5148\u9700\u8981\u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\u6765\u6536\u96c6\u6570\u636e\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528 OpenTelemetry SDK\u3002</p>"},{"location":"chap_ot/0OpenTelemetrey_intro/#_4","title":"\u68c0\u6d4b\uff08\u57cb\u70b9\uff09","text":"<p>\u5e94\u7528\u7a0b\u5e8f\u7684\u68c0\u6d4b\u6570\u636e\u53ef\u4ee5\u4f7f\u7528\u81ea\u52a8\u6216\u624b\u52a8\uff08\u6216\u6df7\u5408\uff09\u65b9\u5f0f\u751f\u6210\u3002 \u8981\u4f7f\u7528 OpenTelemetry \u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u524d\u5f80\u8bbf\u95ee OpenTelemetry \u5b58\u50a8\u5e93\uff0c\u9009\u62e9\u9002\u7528\u4e8e\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u8bed\u8a00\uff0c\u7136\u540e\u6309\u7167\u8bf4\u660e\u8fdb\u884c\u64cd\u4f5c\u3002</p> <p>\u81ea\u52a8\u68c0\u6d4b</p> <p>\u4f7f\u7528\u81ea\u52a8\u68c0\u6d4b\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u65b9\u5f0f\uff0c\u56e0\u4e3a\u5b83\u7b80\u5355\u3001\u5bb9\u6613\uff0c\u4e0d\u9700\u8981\u8fdb\u884c\u5f88\u591a\u4ee3\u7801\u66f4\u6539\u3002</p> <p>\u5982\u679c\u4f60\u6ca1\u6709\u5fc5\u8981\u7684\u77e5\u8bc6\uff08\u6216\u65f6\u95f4\uff09\u6765\u521b\u5efa\u9002\u5408\u4f60\u5e94\u7528\u7a0b\u5e8f\u91cf\u8eab\u7684\u8ffd\u8e2a\u4ee3\u7801\uff0c\u90a3\u4e48\u8fd9\u79cd\u65b9\u6cd5\u5c31\u975e\u5e38\u5408\u9002\u3002</p> <p>\u5f53\u4f7f\u7528\u81ea\u52a8\u68c0\u6d4b\u65f6\uff0c\u5c06\u521b\u5efa\u4e00\u7ec4\u9884\u5b9a\u4e49\u7684 spans\uff0c\u5e76\u586b\u5145\u76f8\u5173\u5c5e\u6027\u3002</p> <p>\u624b\u52a8\u68c0\u6d4b</p> <p>\u624b\u52a8\u68c0\u6d4b\u662f\u6307\u4e3a\u5e94\u7528\u7a0b\u5e8f\u7f16\u5199\u7279\u5b9a\u7684\u57cb\u70b9\u4ee3\u7801\u3002\u8fd9\u662f\u5411\u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u53ef\u89c2\u6d4b\u6027\u4ee3\u7801\u7684\u8fc7\u7a0b\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u66f4\u6709\u6548\u5730\u6ee1\u8db3\u4f60\u7684\u9700\u6c42\uff0c\u56e0\u4e3a\u53ef\u4ee5\u81ea\u5df1\u6dfb\u52a0\u5c5e\u6027\u548c\u4e8b\u4ef6\u3002\u8fd9\u6837\u505a\u7684\u7f3a\u70b9\u662f\u9700\u8981\u5bfc\u5165\u5e93\u5e76\u81ea\u5df1\u5b8c\u6210\u6240\u6709\u5de5\u4f5c\u3002</p> <p></p> <p>\u4f20\u64ad\u5668</p> <p>\u53ef\u4ee5\u5c06 W3C tracecontext\u3001baggage \u548cb3 \u7b49\u4f20\u64ad\u5668\uff08Propagators\uff09\u6dfb\u52a0\u5230\u914d\u7f6e\u4e2d\u3002</p> <p>\u4e0d\u540c\u7684\u4f20\u64ad\u5668\u5b9a\u4e49\u7279\u5b9a\u7684\u884c\u4e3a\u89c4\u8303\uff0c\u4ee5\u4fbf\u8de8\u8fdb\u7a0b\u8fb9\u754c\u4f20\u64ad\u5e26\u4e0a\u4e0a\u4e0b\u6587\u6570\u636e\u3002</p> <ul> <li>Trace Context\uff1a\u7528\u4e8e\u5728 HTTP headers \u4e2d\u7f16\u7801 trace \u6570\u636e\uff0c\u4ee5\u4fbf\u5728\u4e0d\u540c\u7684\u670d\u52a1\u95f4\u4f20\u9012\u8fd9\u4e9b\u6570\u636e\u3002</li> <li>Baggage\uff1a\u7528\u4e8e\u5728 span \u4e4b\u95f4\u4f20\u9012\u952e\u503c\u5bf9\u6570\u636e\uff0c\u4f8b\u5982\u7528\u6237 ID\u3001\u8bf7\u6c42 ID \u7b49\u3002</li> <li>B3\uff1a\u7528\u4e8e\u5728 HTTP headers \u4e2d\u7f16\u7801 trace \u6570\u636e\uff0c\u4ee5\u4fbf\u5728\u4e0d\u540c\u7684\u670d\u52a1\u95f4\u4f20\u9012\u8fd9\u4e9b\u6570\u636e\uff08\u4e3b\u8981\u7528\u4e8e Zipkin \u6216\u5176\u517c\u5bb9\u7684\u7cfb\u7edf\uff09\u3002</li> </ul> <p>Trace Context</p> <p>\u5728\u6574\u4e2a\u94fe\u8def\u7684\u5f62\u6210\u8fc7\u7a0b\u5f53\u4e2d\uff0c \u600e\u4e48\u77e5\u9053B\u662fC\u7684\u7236\u7ea7\uff0c\u6240\u8c13\u7684\u4f20\u64ad\u5668\u6765\u5b9e\u73b0\u7684\uff0c\u5728OpenTelemetry\u91cc\u9762\uff0c\u5b83\u6709\u4e2aPropagator\u7684\u4e00\u4e2aAPI\u63a5\u53e3\u3002\u6709\u51e0\u79cd\u89c4\u8303\u3002</p> <p>\u76ee\u524d\u7684\u8bddOpenTelemetry\u4e3b\u8981\u652f\u6301\u7684\u5c31\u662fW3C\uff0cW3C\u4ed6\u4eec\u89c4\u8303\u7684\u4e00\u4e2atrace context. </p> <p>\u6bd4\u5982\u7236\u7ea7\u7684trace id\u4ee5\u53ca\u7236\u6781\u7684\u4e00\u4e2aspan id, \u4ee5\u53ca\u5b83\u7684\u91c7\u6837\u662f\u5426\u91c7\u6837\uff0c\u8fd9\u6b64\u4fe1\u606f\u7ed9\u4ed6\u4ee5header\u7684\u5f62\u5f0f\uff0c \u90a3\u4e2aheader\u7684\u4e00\u4e2akey\u53eb\u505aTRSPARENT, \u901a\u8fc7\u8fd9\u4e2aheader\u5c31\u53ef\u4ee5\u4f20\u9012\u4e0b\u53bb, \u7136\u540e\u4f20\u9012\u5230\u4e0b\u4e00\u7ea7\u7684\u65f6\u5019\uff0c\u5f53\u4e0b\u4e00\u7ea7\u80af\u5b9a\u8981\u4ece\u4f60\u7684\u8bf7\u6c42\u5934\u91cc\u9762\u53bb\u53d6\u3002 \u5982\u679c\u4f60\u4ece\u8bf7\u6c42\u5934\u91cc\u9762\u80fd\u53d6\u5230\u7684\u4e00\u4e2a\uff0c Traceparent \u8fd9\u6837\u7684\u4e00\u4e2aheader\uff0c\u5c31\u4f1a\u628a\u5b83\u89e3\u6790\u51fa\u6765\u3002  \u5c31\u4f1a\u628a\u4e0a\u4e00\u5c42\u7684\u8fd9\u4e2aSpan head, \u4f5c\u4e3a\u8fd9\u4e00\u5c42\u7684\u4e00\u4e2a\u7236\u7ea7ID\uff0c </p> <p>\u91c7\u6837</p> <p>\u91c7\u6837\u662f\u4e00\u79cd\u901a\u8fc7\u51cf\u5c11\u6536\u96c6\u548c\u53d1\u9001\u5230\u540e\u7aef\u7684\u8ffd\u8e2a\u6837\u672c\u6570\u91cf\u6765\u63a7\u5236 OpenTelemetry \u5f15\u5165\u7684\u566a\u58f0\u548c\u5f00\u9500\u7684\u673a\u5236\u3002</p> <p>\u53ef\u4ee5\u544a\u8bc9 OpenTelemetry \u6839\u636e\u8981\u53d1\u9001\u7684\u8ffd\u8e2a/\u6d41\u91cf\u7684\u6570\u91cf\u6267\u884c\u91c7\u6837\u3002\uff08\u6bd4\u5982\u53ea\u91c7\u6837 10% \u7684\u8ffd\u8e2a\u6570\u636e\uff09\u3002</p> <p></p> <p>\u4e24\u79cd\u5e38\u89c1\u7684\u91c7\u6837\u6280\u672f\u662f\u5934\u91c7\u6837\u548c\u5c3e\u91c7\u6837\u3002</p>"},{"location":"chap_ot/0OpenTelemetrey_intro/#opentelemetry-otlp","title":"OpenTelemetry \u534f\u8bae\uff08OTLP\uff09","text":"<p>OpenTelemetry \u534f\u8bae\uff08OTLP\uff09\u89c4\u8303\u63cf\u8ff0\u4e86\u9065\u6d4b\u6570\u636e\u5728\u9065\u6d4b\u6e90\u3001\u6536\u96c6\u5668\u548c\u9065\u6d4b\u540e\u7aef\u4e4b\u95f4\u7684\u7f16\u7801\u3001\u4f20\u8f93\u548c\u4f20\u9012\u673a\u5236\u3002</p> <p>\u6bcf\u79cd\u8bed\u8a00\u7684 SDK \u90fd\u63d0\u4f9b\u4e86\u4e00\u4e2a OTLP \u5bfc\u51fa\u5668\uff0c\u53ef\u4ee5\u914d\u7f6e\u8be5\u5bfc\u51fa\u5668\u6765\u901a\u8fc7 OTLP \u5bfc\u51fa\u6570\u636e\u3002\u7136\u540e\uff0cOpenTelemetry SDK \u4f1a\u5c06\u4e8b\u4ef6\u8f6c\u6362\u4e3a OTLP \u6570\u636e\u3002</p> <p>OTLP \u662f\u4ee3\u7406\uff08\u914d\u7f6e\u4e3a\u5bfc\u51fa\u5668\uff09\u548c\u6536\u96c6\u5668\uff08\u914d\u7f6e\u4e3a\u63a5\u6536\u5668\uff09\u4e4b\u95f4\u7684\u901a\u4fe1\u3002</p>"},{"location":"chap_ot/0OpenTelemetrey_intro/#opentelemetry-collectors","title":"OpenTelemetry Collectors","text":"<p>\u5e94\u7528\u7a0b\u5e8f\u7684\u9065\u6d4b\u6570\u636e\u53ef\u4ee5\u53d1\u9001\u5230 OpenTelemetry Collectors \u6536\u96c6\u5668\u3002</p> <p></p> <p>\u6536\u96c6\u5668\u662f OpenTelemetry \u7684\u4e00\u4e2a\u7ec4\u4ef6\uff0c\u5b83\u63a5\u6536\u9065\u6d4b\u6570\u636e\uff08span\u3001metrics\u3001logs \u7b49\uff09\uff0c\u5904\u7406\uff08\u9884\u5904\u7406\u6570\u636e\uff09\u5e76\u5bfc\u51fa\u6570\u636e\uff08\u5c06\u5176\u53d1\u9001\u5230\u60f3\u8981\u7684\u901a\u4fe1\u540e\u7aef\uff09\u3002</p> <p></p> <p>Receivers</p> <p>\u63a5\u6536\u5668 Receivers \u662f\u6570\u636e\u8fdb\u5165\u6536\u96c6\u5668\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u662f\u63a8\u9001\u6216\u62c9\u53d6\u3002OpenTelemetry \u6536\u96c6\u5668\u53ef\u4ee5\u4ee5\u591a\u79cd\u683c\u5f0f\u63a5\u6536\u9065\u6d4b\u6570\u636e\u3002</p> <p></p> <pre><code>otlp:\n  protocols:\n    http:\n    grpc:\n      endpoint: \"0.0.0.0:4317\"\n</code></pre> <p>\u540c\u6837\u4e0b\u9762\u7684\u793a\u4f8b\uff0c\u5b83\u53ef\u4ee5\u4ee5 Jaeger Thrift HTTP \u534f\u8bae\u65b9\u5f0f\u63a5\u6536\u9065\u6d4b\u6570\u636e\u3002</p> <pre><code>jaeger: # Jaeger \u534f\u8bae\u63a5\u6536\u5668\n  protocols: # \u5b9a\u4e49\u63a5\u6536\u5668\u652f\u6301\u7684\u534f\u8bae\n    thrift_http: # \u901a\u8fc7 Jaeger Thrift HTTP \u534f\u8bae\u63a5\u6536\u6570\u636e\n      endpoint: \"0.0.0.0:14278\"\n</code></pre> <p>Processors</p> <p>\u4e00\u65e6\u63a5\u6536\u5230\u6570\u636e\uff0c\u6536\u96c6\u5668\u5c31\u53ef\u4ee5\u5904\u7406\u6570\u636e\u3002\u5904\u7406\u5668\u5728\u63a5\u6536\u548c\u5bfc\u51fa\u4e4b\u95f4\u5904\u7406\u6570\u636e\u3002\u5904\u7406\u5668\u662f\u53ef\u9009\u7684\uff0c\u4f46\u6709\u4e9b\u662f\u63a8\u8350\u7684\u3002</p> <p>\u6bd4\u5982 batch \u5904\u7406\u5668\u662f\u975e\u5e38\u63a8\u8350\u7684\u3002\u6279\u5904\u7406\u5668\u63a5\u6536\u8de8\u5ea6\u3001\u6307\u6807\u6216\u65e5\u5fd7\uff0c\u5e76\u5c06\u5b83\u4eec\u653e\u5165\u6279\u6b21\u4e2d\u3002\u6279\u5904\u7406\u6709\u52a9\u4e8e\u66f4\u597d\u5730\u538b\u7f29\u6570\u636e\uff0c\u51cf\u5c11\u4f20\u8f93\u6570\u636e\u6240\u9700\u7684\u4f20\u51fa\u8fde\u63a5\u6570\u91cf\u3002\u8be5\u5904\u7406\u5668\u652f\u6301\u57fa\u4e8e\u5927\u5c0f\u548c\u65f6\u95f4\u7684\u6279\u5904\u7406\u3002</p> <pre><code>processors:\n  batch:\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u914d\u7f6e\u5904\u7406\u5668\u5e76\u4e0d\u4f1a\u542f\u7528\u5b83\u3002\u9700\u8981\u901a\u8fc7 service \u90e8\u5206\u7684 pipelines \u542f\u7528\u3002</p> <pre><code>service:\n  pipelines:\n    traces:\n      receivers: [jaeger]\n      processors: [batch]\n      exporters: [zipkin]\n</code></pre> <p>Exporters</p> <p>\u4e3a\u4e86\u53ef\u89c6\u5316\u548c\u5206\u6790\u9065\u6d4b\u6570\u636e\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u4f7f\u7528\u5bfc\u51fa\u5668\u3002\u5bfc\u51fa\u5668\u662f OpenTelemetry \u7684\u4e00\u4e2a\u7ec4\u4ef6\uff0c\u4e5f\u662f\u6570\u636e\u53d1\u9001\u5230\u4e0d\u540c\u7cfb\u7edf/\u540e\u7aef\u7684\u65b9\u5f0f\u3002</p> <p>\u6bd4\u5982 <code>console exporter</code> \u662f\u4e00\u79cd\u5e38\u89c1\u7684\u5bfc\u51fa\u5668\uff0c\u5bf9\u4e8e\u5f00\u53d1\u548c\u8c03\u8bd5\u4efb\u52a1\u975e\u5e38\u6709\u7528\uff0c\u4ed6\u4f1a\u5c06\u6570\u636e\u6253\u5370\u5230\u63a7\u5236\u53f0\u3002</p> <p>\u5728 exporters \u90e8\u5206\uff0c\u53ef\u4ee5\u6dfb\u52a0\u66f4\u591a\u76ee\u7684\u5730\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60f3\u5c06\u8ffd\u8e2a\u6570\u636e\u53d1\u9001\u5230 Grafana Tempo\uff0c\u53ea\u9700\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u914d\u7f6e\uff1a</p> <pre><code>exporters:\n  logging:\n  otlp:\n    endpoint: \"&lt;tempo_endpoint&gt;\"\n    headers:\n      authorization: Basic &lt;api_token&gt;\n</code></pre> <p>\u5f53\u7136\u6700\u7ec8\u8981\u751f\u6548\u4e5f\u9700\u8981\u5728 service \u90e8\u5206\u7684 pipelines \u4e2d\u542f\u7528\u3002</p> <pre><code>service:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: []\n      exporters: [logging, otlp]\n</code></pre> <p>OpenTelemetry \u9644\u5e26\u4e86\u5404\u79cd\u5bfc\u51fa\u5668\uff0c\u5728 OpenTelemetry \u6536\u96c6\u5668 Contrib \u5b58\u50a8\u5e93\u4e2d\u53ef\u4ee5\u627e\u5230\u3002</p> <p>Extensions</p> <p>\u6269\u5c55\u4e3b\u8981\u9002\u7528\u4e8e\u4e0d\u6d89\u53ca\u5904\u7406\u9065\u6d4b\u6570\u636e\u7684\u4efb\u52a1\u3002\u6269\u5c55\u7684\u793a\u4f8b\u5305\u62ec\u5065\u5eb7\u76d1\u63a7\u3001\u670d\u52a1\u53d1\u73b0\u548c\u6570\u636e\u8f6c\u53d1\u3002\u6269\u5c55\u662f\u53ef\u9009\u7684\u3002</p> <p>\u6269\u5c55\u4e3b\u8981\u7528\u4e8e\u4e0d\u6d89\u53ca\u5904\u7406\u9065\u6d4b\u6570\u636e\u7684\u4efb\u52a1\u3002\u6bd4\u5982\u5065\u5eb7\u76d1\u63a7\u3001\u670d\u52a1\u53d1\u73b0\u548c\u6570\u636e\u8f6c\u53d1\u7b49\u3002\u6269\u5c55\u662f\u53ef\u9009\u7684\u3002</p> <pre><code>extensions:\n  health_check:\n  pprof:\n  zpages:\n  memory_ballast:\n    size_mib: 512\n</code></pre>"},{"location":"chap_ot/0OpenTelemetrey_intro/#opentelemetry-collector","title":"OpenTelemetry Collector \u90e8\u7f72\u6a21\u5f0f/\u7b56\u7565","text":"<p>OpenTelemetry \u6536\u96c6\u5668\u53ef\u4ee5\u901a\u8fc7\u4e0d\u540c\u7684\u65b9\u5f0f\u8fdb\u884c\u90e8\u7f72\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u8003\u8651\u4e0b\u5982\u4f55\u90e8\u7f72\u5b83\u3002\u5177\u4f53\u9009\u62e9\u54ea\u79cd\u7b56\u7565\u53d6\u51b3\u4e8e\u4f60\u7684\u56e2\u961f\u548c\u7ec4\u7ec7\u60c5\u51b5\u3002</p> <p>Agent \u6a21\u5f0f</p> <p>\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cOpenTelemetry \u68c0\u6d4b\u7684\u5e94\u7528\u7a0b\u5e8f\u5c06\u6570\u636e\u53d1\u9001\u5230\u4e0e\u5e94\u7528\u7a0b\u5e8f\u4e00\u8d77\u9a7b\u7559\u7684\uff08\u6536\u96c6\u5668\uff09\u4ee3\u7406\u3002\u7136\u540e\uff0c\u8be5\u4ee3\u7406\u7a0b\u5e8f\u5c06\u63a5\u7ba1\u5e76\u5904\u7406\u6240\u6709\u6765\u81ea\u5e94\u7528\u7a0b\u5e8f\u7684\u8ffd\u8e2a\u6570\u636e\u3002</p> <p>\u6536\u96c6\u5668\u53ef\u4ee5\u901a\u8fc7 sidecar \u65b9\u5f0f\u90e8\u7f72\u4e3a\u4ee3\u7406\uff0csidecar \u53ef\u4ee5\u914d\u7f6e\u4e3a\u76f4\u63a5\u5c06\u6570\u636e\u53d1\u9001\u5230\u5b58\u50a8\u540e\u7aef\u3002</p> <p></p> <p>Gateway \u6a21\u5f0f</p> <p>\u8fd8\u53ef\u4ee5\u51b3\u5b9a\u5c06\u6570\u636e\u53d1\u9001\u5230\u53e6\u4e00\u4e2a OpenTelemetry \u6536\u96c6\u5668\uff0c\u7136\u540e\u4ece\uff08\u4e2d\u5fc3\uff09\u6536\u96c6\u5668\u8fdb\u4e00\u6b65\u5c06\u6570\u636e\u53d1\u9001\u5230\u5b58\u50a8\u540e\u7aef\u3002\u5728\u8fd9\u79cd\u914d\u7f6e\u4e2d\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u4e2d\u5fc3\u7684 OpenTelemetry \u6536\u96c6\u5668\uff0c\u5b83\u4f7f\u7528 deployment \u6a21\u5f0f\u90e8\u7f72\uff0c\u5177\u6709\u8bb8\u591a\u4f18\u52bf\uff0c\u5982\u81ea\u52a8\u6269\u5c55\u3002</p> <p></p> <p>\u4f7f\u7528\u4e2d\u5fc3\u6536\u96c6\u5668\u7684\u4e00\u4e9b\u4f18\u70b9\u662f\uff1a</p> <ul> <li>\u6d88\u9664\u5bf9\u56e2\u961f\u7684\u4f9d\u8d56</li> <li>\u5f3a\u5236\u6267\u884c\u6279\u5904\u7406\u3001\u91cd\u8bd5\u3001\u52a0\u5bc6\u3001\u538b\u7f29\u7684\u914d\u7f6e/\u7b56\u7565</li> <li>\u5728\u4e2d\u5fc3\u4f4d\u7f6e\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1</li> <li>\u4e30\u5bcc\u7684\u5143\u6570\u636e\u4fe1\u606f</li> <li>\u8fdb\u884c\u62bd\u6837\u51b3\u7b56</li> <li>\u901a\u8fc7 HPA \u8fdb\u884c\u6269\u5c55</li> </ul> <p>\u90e8\u7f72\u6a21\u5f0f\u603b\u7ed3</p> <p>\u4e0b\u9762\u6211\u4eec\u603b\u7ed3\u4e0b\u5e38\u89c1\u7684\u4e00\u4e9b\u90e8\u7f72\u7b56\u7565\u3002</p> <p>\u57fa\u672c\u7248 - \u5ba2\u6237\u7aef\u4f7f\u7528 OTLP \u8fdb\u884c\u68c0\u6d4b\uff0c\u5c06\u6570\u636e\u53d1\u9001\u5230\u4e00\u7ec4\u6536\u96c6\u5668\u3002</p> <p></p> <p>\u53ef\u4ee5\u5c06\u6570\u636e\u53d1\u9001\u5230\u591a\u4e2a\u5bfc\u51fa\u5668\u3002</p> <p></p> <p>\u5728 Kubernetes \u4e0a\u90e8\u7f72 OpenTelemetry Collector \u65f6\u53ef\u4ee5\u4f7f\u7528\u7684\u6a21\u5f0f</p> <p>sidecar \u6a21\u5f0f\uff1a</p> <p></p> <p>\u4ee3\u7406\u4f5c\u4e3a sidecar\uff0c\u5176\u4e2d\u4f7f\u7528 OpenTelemetry Collector \u5c06\u5bb9\u5668\u6dfb\u52a0\u5230\u5de5\u4f5c\u8d1f\u8f7d Pod\u3002\u7136\u540e\uff0c\u8be5\u5b9e\u4f8b\u88ab\u914d\u7f6e\u4e3a\u5c06\u6570\u636e\u53d1\u9001\u5230\u53ef\u80fd\u4f4d\u4e8e\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u6216\u96c6\u7fa4\u4e2d\u7684\u5916\u90e8\u6536\u96c6\u5668\u3002</p> <p>daemonset \u6a21\u5f0f\uff1a</p> <p>Agent \u4f5c\u4e3a DaemonSet\uff0c\u8fd9\u6837\u6211\u4eec\u6bcf\u4e2a Kubernetes \u8282\u70b9\u5c31\u6709\u4e00\u4e2a\u4ee3\u7406 pod\u3002</p> <p></p> <p>\u8d1f\u8f7d\u5747\u8861 - \u57fa\u4e8e trace id \u7684\u8d1f\u8f7d\u5747\u8861\uff1a</p> <p></p> <p>\u591a\u96c6\u7fa4 - \u4ee3\u7406\u3001\u5de5\u4f5c\u8d1f\u8f7d\u548c\u63a7\u5236\u5e73\u9762\u6536\u96c6\u5668\uff1a</p> <p></p> <p>\u591a\u79df\u6237\u6a21\u5f0f</p> <p>\u4e24\u4e2a\u79df\u6237\uff0c\u6bcf\u4e2a\u79df\u6237\u90fd\u6709\u81ea\u5df1\u7684 Jaeger\u3002</p> <p></p> <p>\u4fe1\u53f7\u6a21\u5f0f</p> <p>\u4e24\u4e2a\u6536\u96c6\u5668\uff0c\u6bcf\u4e2a\u6536\u96c6\u5668\u5bf9\u5e94\u4e00\u79cd\u9065\u6d4b\u6570\u636e\u7c7b\u578b\u3002</p> <p></p>"},{"location":"chap_ot/0OpenTelemetrey_intro/#opentelemetry_2","title":"OpenTelemetry \u540e\u7aef","text":"<p>OpenTelemetry \u6536\u96c6\u5668\u5e76\u4e0d\u63d0\u4f9b\u81ea\u5df1\u7684\u540e\u7aef\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u4f9b\u5e94\u5546\u6216\u5f00\u6e90\u4ea7\u54c1\uff01</p> <p>\u5c3d\u7ba1 OpenTelemetry \u4e0d\u63d0\u4f9b\u81ea\u5df1\u7684\u540e\u7aef\uff0c\u4f46\u901a\u8fc7\u4f7f\u7528\u5b83\uff0c\u6211\u4eec\u4e0d\u4f1a\u4f9d\u8d56\u4e8e\u4efb\u4f55\u5de5\u5177\u6216\u4f9b\u5e94\u5546\uff0c\u56e0\u4e3a\u5b83\u4e0e\u4f9b\u5e94\u5546\u65e0\u5173\u3002\u6211\u4eec\u4e0d\u4ec5\u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u60f3\u8981\u7684\u4efb\u4f55\u7f16\u7a0b\u8bed\u8a00\uff0c\u800c\u4e14\u8fd8\u53ef\u4ee5\u9009\u62e9\u5b58\u50a8\u540e\u7aef\uff0c\u5e76\u4e14\u53ea\u9700\u914d\u7f6e\u53e6\u4e00\u4e2a\u5bfc\u51fa\u5668\u5373\u53ef\u8f7b\u677e\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u540e\u7aef/\u4f9b\u5e94\u5546</p> <p>\u4e3a\u4e86\u53ef\u89c6\u5316\u548c\u5206\u6790\u9065\u6d4b\u6570\u636e\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728 OpenTelemetry \u91c7\u96c6\u5668\u79cd\u914d\u7f6e\u4e00\u4e2a\u5bfc\u51fa\u5668\u3002\u6bd4\u5982 Jaeger \u5c31\u662f\u4e00\u4e2a\u975e\u5e38\u6d41\u884c\u7684\u7528\u4e8e\u5206\u6790\u548c\u67e5\u8be2\u6570\u636e\u7684\u5f00\u6e90\u4ea7\u54c1\u3002</p> <p>]</p> <p>\u6211\u4eec\u53ef\u4ee5\u5728 OpenTelemetry \u6536\u96c6\u5668\u4e2d\u914d\u7f6e Jaeger \u5bfc\u51fa\u5668\uff0c\u4ee5\u4fbf\u5c06\u6570\u636e\u53d1\u9001\u5230 Jaeger\u3002</p> <pre><code>exporters:\n  jaeger:\n    endpoint: \"http://localhost:14250\"\n</code></pre>"},{"location":"chap_ot/0OpenTelemetrey_intro/#opentelemetry-on-kubernetes","title":"OpenTelemetry on Kubernetes","text":"<p>\u5728 Kubernetes \u4e0a\u4f7f\u7528 OpenTelemetry\uff0c\u4e3b\u8981\u5c31\u662f\u90e8\u7f72 OpenTelemetry \u6536\u96c6\u5668\u3002\u6211\u4eec\u5efa\u8bae\u4f7f\u7528 OpenTelemetry Operator \u6765\u90e8\u7f72\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u8f7b\u677e\u90e8\u7f72\u548c\u7ba1\u7406 OpenTelemetry \u6536\u96c6\u5668\uff0c\u8fd8\u53ef\u4ee5\u81ea\u52a8\u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\u3002</p>"},{"location":"chap_ot/0OpenTelemetrey_intro/#_5","title":"\u90e8\u7f72","text":"<p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 Helm Chart \u6765\u90e8\u7f72 OpenTelemetry Operator\uff0c\u9996\u5148\u6dfb\u52a0 Helm Chart \u4ed3\u5e93\uff1a</p> <pre><code>$ helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts\n$ helm repo update\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u90e8\u7f72\u4e00\u4e2a\u51c6\u5165\u63a7\u5236\u5668\uff0c\u7528\u4e8e\u9a8c\u8bc1 OpenTelemetry Operator \u7684\u914d\u7f6e\u662f\u5426\u6b63\u786e\uff0c\u4e3a\u4e86\u4f7f APIServer \u80fd\u591f\u4e0e Webhook \u7ec4\u4ef6\u8fdb\u884c\u901a\u4fe1\uff0cWebhook \u9700\u8981\u4e00\u4e2a\u7531 APIServer \u914d\u7f6e\u4e3a\u53ef\u4fe1\u4efb\u7684 TLS \u8bc1\u4e66\u3002</p> <p>\u4e3a\u4e86\u7b80\u5355\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528\u81ea\u52a8\u751f\u6210\u7b7e\u540d\u8bc1\u4e66\u7684\u65b9\u5f0f\uff0c\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e00\u952e\u5b89\u88c5 OpenTelemetry Operator\uff1a</p> <pre><code>$ helm upgrade --install --set admissionWebhooks.certManager.enabled=false --set admissionWebhooks.certManager.autoGenerateCert=true opentelemetry-operator open-telemetry/opentelemetry-operator --namespace kube-otel --create-namespace\n</code></pre> <ul> <li><code>--set admissionWebhooks.certManager.enabled=false</code></li> </ul> <p>\u6b63\u5e38\u90e8\u7f72\u5b8c\u6210\u540e\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684 Pod \u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c\uff1a</p> <pre><code>$ kubectl get pods -n kube-otel -l app.kubernetes.io/name=opentelemetry-operator\nNAME                                      READY   STATUS    RESTARTS   AGE\nopentelemetry-operator-6f77dc895c-4wn8z   2/2     Running   0          33s\n</code></pre> <p>\u6b64\u5916\u8fd8\u4f1a\u81ea\u52a8\u4e3a\u6211\u4eec\u6dfb\u52a0\u4e24\u4e2a OpenTelemetry \u76f8\u5173\u7684 CRD\uff1a</p> <pre><code>$ kubectl get crd |grep opentelemetry\ninstrumentations.opentelemetry.io           2023-09-05T03:23:28Z\nopentelemetrycollectors.opentelemetry.io    2023-09-05T03:23:28Z\n</code></pre> <p></p> <p>\u5230\u8fd9\u91cc OpenTelemetry Operator \u5c31\u90e8\u7f72\u5b8c\u6210\u4e86\u3002</p> <p>\u7136\u540e\u6211\u4eec\u8fd9\u91cc\u9009\u62e9\u4f7f\u7528\u4e2d\u5fc3 OpenTelemetry \u6536\u96c6\u5668\uff0c\u5e76\u8ba9\u5176\u4ed6 OpenTelemetry \u4ee3\u7406\u5c06\u6570\u636e\u53d1\u9001\u5230\u8be5\u6536\u96c6\u5668\u3002\u4ece\u4ee3\u7406\u63a5\u6536\u7684\u6570\u636e\u5c06\u5728\u6b64\u6536\u96c6\u5668\u4e0a\u8fdb\u884c\u5904\u7406\uff0c\u5e76\u901a\u8fc7\u5bfc\u51fa\u5668\u53d1\u9001\u5230\u5b58\u50a8\u540e\u7aef\u3002\u6574\u4e2a\u5de5\u4f5c\u6d41\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <pre><code># central-collector.yaml\napiVersion: opentelemetry.io/v1alpha1\nkind: OpenTelemetryCollector\nmetadata:\n  name: simplest\nspec:\n  config: |\n    receivers:\n      otlp:\n        protocols:\n          grpc:\n          http:\n    processors:\n      memory_limiter:\n        check_interval: 1s\n        limit_percentage: 75\n        spike_limit_percentage: 15\n      batch:\n        send_batch_size: 10000\n        timeout: 10s\n\n    exporters:\n      logging:\n      otlp:\n        endpoint: \"&lt;tempo_endpoint&gt;\"\n        headers:\n          authorization: Basic &lt;api_token&gt; # echo -n \"&lt;your user id&gt;:&lt;your api key&gt;\" | base64\n\n    service:\n      pipelines:\n        traces:\n          receivers: [otlp]\n          processors: [memory_limiter, batch]\n          exporters: [logging, otlp]\n</code></pre> <p>\u5728\u8fd9\u91cc OpenTelemetry Collector \u901a\u8fc7 grpc \u548c http \u4e24\u79cd\u534f\u8bae\u6765\u63a5\u6536\u9065\u6d4b\u6570\u636e\uff0c\u5e76\u901a\u8fc7\u65e5\u5fd7\u8bb0\u5f55\u5bfc\u51fa\u548c Grafana Tempo \u6765\u8bb0\u5f55\u8fd9\u4e9b Span\uff0c\u8fd9\u4f1a\u5c06 Span \u5199\u5165\u63a5\u6536 Span \u7684 OpenTelemetry Collector \u5b9e\u4f8b\u7684\u63a7\u5236\u53f0\u548c Grafana Tempo \u540e\u7aef\u53bb\u3002</p> <p>\u7136\u540e\u6211\u4eec\u5c06\u4f7f\u7528 Sidecar \u6a21\u5f0f\u90e8\u7f72 OpenTelemetry \u4ee3\u7406\u3002\u8be5\u4ee3\u7406\u4f1a\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u8ffd\u8e2a\u53d1\u9001\u5230\u6211\u4eec\u7684\u4e2d\u5fc3\uff08\u7f51\u5173\uff09OpenTelemetry \u6536\u96c6\u5668\u3002</p> <p></p> <p></p> <p></p> <pre><code># sidecar.yaml\napiVersion: opentelemetry.io/v1alpha1\nkind: OpenTelemetryCollector\nmetadata:\n  name: sidecar\nspec:\n  mode: sidecar\n  config: |\n    receivers:\n      otlp:\n        protocols:\n          grpc:\n          http:\n    processors:\n      batch:\n    exporters:\n      logging:\n      otlp:\n        endpoint: \"&lt;path_to_central_collector&gt;.&lt;namespace&gt;:4317\"\n    service:\n      telemetry:\n        logs:\n          level: \"debug\"\n         metrics:\n           address: 0.0.0.0:8888\n      pipelines:\n        traces:\n          receivers: [otlp]\n          processors: [batch]\n          exporters: [logging, otlp]\n</code></pre> <p></p>"},{"location":"chap_ot/0OpenTelemetrey_intro/#_6","title":"\u81ea\u52a8\u68c0\u6d4b","text":"<p>OpenTelemetry Operator \u53ef\u4ee5\u6ce8\u5165\u548c\u914d\u7f6e OpenTelemetry \u81ea\u52a8\u68c0\u6d4b\u5e93\u3002\u76ee\u524d\u652f\u6301 DotNet\u3001Java\u3001NodeJS\u3001Python \u548c Golang\uff08\u9700\u8981\u624b\u52a8\u5f00\u542f\uff09\u3002</p> <p>\u8981\u4f7f\u7528\u81ea\u52a8\u68c0\u6d4b\uff0c\u9700\u8981\u4e3a SDK \u548c\u68c0\u6d4b\u914d\u7f6e\u6dfb\u52a0\u4e00\u4e2a Instrumentation \u8d44\u6e90\u3002\u6bd4\u5982\u5bf9\u4e8e Java \u5e94\u7528\u7a0b\u5e8f\uff0c\u914d\u7f6e\u5982\u4e0b</p> <pre><code>apiVersion: opentelemetry.io/v1alpha1\nkind: Instrumentation\nmetadata:\n  name: java-instrumentation\nspec:\n  propagators:\n    - tracecontext\n    - baggage\n    - b3\n  sampler:\n    type: always_on\n  java:\n</code></pre> <p>\u5982\u679c\u662f Python \u5e94\u7528\u7a0b\u5e8f\uff0c\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: opentelemetry.io/v1alpha1\nkind: Instrumentation\nmetadata:\n  name: python-instrumentation\nspec:\n  propagators:\n    - tracecontext\n    - baggage\n    - b3\n  sampler:\n    type: always_on\n  python:\n</code></pre> <p>\u8981\u542f\u7528\u68c0\u6d4b\uff0c\u6211\u4eec\u9700\u8981\u66f4\u65b0\u90e8\u7f72\u6587\u4ef6\u5e76\u5411\u5176\u6dfb\u52a0\u6ce8\u89e3\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6211\u4eec\u544a\u8bc9 OpenTelemetry Operator \u5c06 sidecar \u548c java \u5de5\u5177\u6ce8\u5165\u5230\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u3002</p> <pre><code>annotations:\n  instrumentation.opentelemetry.io/inject-java: \"true\"\n  sidecar.opentelemetry.io/inject: \"true\"\n</code></pre>"},{"location":"chap_ot/0OpenTelemetrey_intro/#_7","title":"\u793a\u4f8b\u5e94\u7528","text":"<p>\u8fd9\u91cc\u6211\u4eec\u5c06\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a Petclinic \u7684 Java \u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd9\u662f\u4e00\u4e2a\u4f7f\u7528 Maven \u6216 Gradle \u6784\u5efa\u7684 Spring Boot \u5e94\u7528\u7a0b\u5e8f\u3002\u8be5\u5e94\u7528\u7a0b\u5e8f\u5c06\u4f7f\u7528 OpenTelemetry \u751f\u6210\u6570\u636e</p> <p>\u5bf9\u4e8e Java \u5e94\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u8f7d OpenTelemetry \u63d0\u4f9b\u7684 opentelemetry-javaagent \u8fd9\u4e2a jar \u5305\u6765\u4f7f\u7528 OpenTelemetry \u81ea\u52a8\u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>\u53ea\u9700\u8981\u5c06\u8fd9\u4e2a jar \u5305\u6dfb\u52a0\u5230\u5e94\u7528\u7a0b\u5e8f\u7684\u542f\u52a8\u547d\u4ee4\u4e2d\u5373\u53ef\uff0c\u6bd4\u5982\uff1a</p> <pre><code>java -javaagent:opentelemetry-javaagent.jar -jar target/*.jar\n</code></pre> <p>Java \u81ea\u52a8\u68c0\u6d4b\u4f7f\u7528\u53ef\u9644\u52a0\u5230\u4efb\u4f55 Java 8+ \u5e94\u7528\u7a0b\u5e8f\u7684 Java \u4ee3\u7406 JAR\u3002\u5b83\u52a8\u6001\u6ce8\u5165\u5b57\u8282\u7801\u4ee5\u4ece\u8bb8\u591a\u6d41\u884c\u7684\u5e93\u548c\u6846\u67b6\u6355\u83b7\u9065\u6d4b\u6570\u636e\u3002</p> <p>\u5b83\u53ef\u7528\u4e8e\u6355\u83b7\u5e94\u7528\u7a0b\u5e8f\u6216\u670d\u52a1\u201c\u8fb9\u7f18\u201d\u7684\u9065\u6d4b\u6570\u636e\uff0c\u4f8b\u5982\u5165\u7ad9\u8bf7\u6c42\u3001\u51fa\u7ad9 HTTP \u8c03\u7528\u3001\u6570\u636e\u5e93\u8c03\u7528\u7b49\u3002\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0a\u547d\u4ee4\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u63d2\u6869\uff0c\u5e76\u751f\u6210\u94fe\u8def\u6570\u636e\uff0c\u800c\u5bf9\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u6ca1\u6709\u4efb\u4f55\u4fee\u6539\u3002</p> <p>\u5c24\u5176\u662f\u5728 Kubernetes \u73af\u5883\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 OpenTelemetry Operator \u6765\u6ce8\u5165\u548c\u914d\u7f6e OpenTelemetry \u81ea\u52a8\u68c0\u6d4b\u5e93\uff0c\u8fd9\u6837\u8fde javaagent \u6211\u4eec\u90fd\u4e0d\u9700\u8981\u53bb\u624b\u52a8\u6ce8\u5165\u4e86\u3002</p> <p>\u6211\u4eec\u9996\u5148\u90e8\u7f72 Petclinic \u5e94\u7528\u7a0b\u5e8f\u3002</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: petclinic\nspec:\n  selector:\n    matchLabels:\n      app: petclinic\n  template:\n    metadata:\n      labels:\n        app: petclinic\n    spec:\n      containers:\n        - name: app\n          image: cnych/spring-petclinic:latest\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u4e3a Java \u5e94\u7528\u7a0b\u5e8f\u6dfb\u52a0\u4e00\u4e2a Instrumentation \u8d44\u6e90\u3002</p> <pre><code># java-instrumentation.yaml\napiVersion: opentelemetry.io/v1alpha1\nkind: Instrumentation\nmetadata:\n  name: java-instrumentation\nspec:\n  propagators:\n    - tracecontext\n    - baggage\n    - b3\n  sampler:\n    type: always_on\n  java:\n    image: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-java:latest\n    go:\n        image: ghcr.io/open-telemetry/opentelemetry-go-instrumentation/autoinstrumentation-go:latest\n        env:\n            name: OTEL_EXPORTER_OTLP_INSECURE\n            value: \"true\"\n</code></pre> <p>\u4e3a\u4e86\u542f\u7528\u81ea\u52a8\u68c0\u6d4b\uff0c\u6211\u4eec\u9700\u8981\u66f4\u65b0\u90e8\u7f72\u6587\u4ef6\u5e76\u5411\u5176\u6dfb\u52a0\u6ce8\u89e3\u3002\u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u544a\u8bc9 OpenTelemetry Operator \u5c06 sidecar \u548c java-instrumentation \u6ce8\u5165\u5230\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u3002\u4fee\u6539 Deployment \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code># petclinic.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: petclinic\nspec:\n  selector:\n    matchLabels:\n      app: petclinic\n  template:\n    metadata:\n      labels:\n        app: petclinic\n      annotations:\n        instrumentation.opentelemetry.io/inject-java: \"true\"\n        sidecar.opentelemetry.io/inject: \"sidecar\"\n    spec:\n      containers:\n        - name: app\n          image: cnych/spring-petclinic:latest\n</code></pre> <p>\u7136\u540e\u518d\u521b\u5efa\u4e00\u4e2a NodePort \u7c7b\u578b\u7684 Service \u670d\u52a1\u6765\u66b4\u9732\u5e94\u7528\u7a0b\u5e8f\u3002</p> <pre><code># petclinic-svc.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: petclinic\nspec:\n  selector:\n    app: petclinic\n  type: NodePort\n  ports:\n    - protocol: TCP\n      port: 80\n      targetPort: 8080  \n</code></pre> <p>\u76f4\u63a5\u5e94\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f central-collector.yaml\n$ kubectl apply -f sidecar.yaml\n$ kubectl apply -f java-instrumentation.yaml\n$ kubectl apply -f petclinic.yaml\n$ kubectl apply -f petclinic-svc.yaml\n</code></pre> <p>\u6b63\u5e38\u90e8\u7f72\u5b8c\u6210\u540e\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684 Pod \u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c\uff1a</p> <pre><code>$ kubectl get pods\nNAME                                 READY   STATUS    RESTARTS   AGE\npetclinic-6fdd56f4d7-qfff7           2/2     Running   0          62s\nsimplest-collector-87d8bf9bf-dh8pl   1/1     Running   0          36m\n$ kubectl get svc\nNAME                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                        AGE\npetclinic                       NodePort    10.103.6.52      &lt;none&gt;        80:30941/TCP                   46s\nsimplest-collector              ClusterIP   10.102.131.126   &lt;none&gt;        4317/TCP,4318/TCP              17m\nsimplest-collector-headless     ClusterIP   None             &lt;none&gt;        4317/TCP,4318/TCP              17m\nsimplest-collector-monitoring   ClusterIP   10.98.65.171     &lt;none&gt;        8888/TCP                       17m\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>http://&lt;node_ip&gt;:30941</code> \u6765\u8bbf\u95ee Petclinic \u5e94\u7528\u7a0b\u5e8f\u4e86\u3002</p> <p></p> <p>\u5f53\u6211\u4eec\u8bbf\u95ee\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u5e94\u7528\u7a0b\u5e8f\u5c31\u5c06\u751f\u6210\u8ffd\u8e2a\u6570\u636e\uff0c\u5e76\u5c06\u5176\u53d1\u9001\u5230\u6211\u4eec\u7684\u4e2d\u5fc3\u6536\u96c6\u5668\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95ee Grafana Tempo \u6765\u67e5\u770b\u8ffd\u8e2a\u6570\u636e\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95ee\u4e2d\u5fc3\u6536\u96c6\u5668\u7684\u63a7\u5236\u53f0\u6765\u67e5\u770b\u8ffd\u8e2a\u6570\u636e\u3002\u56e0\u4e3a\u6211\u4eec\u5728\u4e2d\u5fc3\u6536\u96c6\u5668\u4e2d\u914d\u7f6e\u4e86\u65e5\u5fd7\u8bb0\u5f55\u5bfc\u51fa\u5668\u548c Grafana Tempo \u4e24\u4e2a\u5bfc\u51fa\u5668\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u914d\u7f6e\u5176\u4ed6\u5bfc\u51fa\u5668\u3002</p> <pre><code>$ kubectl logs -f petclinic-6fdd56f4d7-qfff7 -c otc-container\n# ......\n2023-09-10T04:11:41.164Z        info    TracesExporter  {\"kind\": \"exporter\", \"data_type\": \"traces\", \"name\": \"logging\", \"resource spans\": 1, \"spans\": 76}\n2023-09-10T04:12:11.012Z        info    TracesExporter  {\"kind\": \"exporter\", \"data_type\": \"traces\", \"name\": \"logging\", \"resource spans\": 1, \"spans\": 3}\n2023-09-10T04:12:16.221Z        info    TracesExporter  {\"kind\": \"exporter\", \"data_type\": \"traces\", \"name\": \"logging\", \"resource spans\": 1, \"spans\": 23}\n^C\n$ kubectl logs -f simplest-collector-677f4779ff-x8h2m\n# ......\n2023-09-10T04:11:09.221Z        info    service/service.go:161  Everything is ready. Begin running and processing data.\n2023-09-10T04:11:49.222Z        info    TracesExporter  {\"kind\": \"exporter\", \"data_type\": \"traces\", \"name\": \"logging\", \"resource spans\": 1, \"spans\": 76}\n2023-09-10T04:12:19.224Z        info    TracesExporter  {\"kind\": \"exporter\", \"data_type\": \"traces\", \"name\": \"logging\", \"resource spans\": 2, \"spans\": 26}\n</code></pre> <p>\u6240\u4ee5\u5728 Grafana Tempo \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684\u8ffd\u8e2a\u6570\u636e\uff1a</p> <p></p> <p></p> <p></p> <p>\u540c\u6837\u5982\u679c\u4f60\u518d\u6dfb\u52a0\u4e00\u4e2a Jaeger \u7684\u5bfc\u51fa\u5668\uff0c\u90a3\u4e48\u4f60\u4e5f\u53ef\u4ee5\u5728 Jaeger \u4e2d\u770b\u5230\u5bf9\u5e94\u7684\u8ffd\u8e2a\u6570\u636e\u3002</p> <p>\u5982\u679c\u5728\u90e8\u7f72\u4e2d\u9047\u5230\u4efb\u4f55\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b\u5e94\u7528\u7a0b\u5e8f\u548c\u5bb9\u5668\u7684\u65e5\u5fd7\u6765\u8fdb\u884c\u6392\u67e5</p> <ul> <li>https://medium.com/@magstherdev/opentelemetry-up-and-running-b4c58eaf8c05</li> <li>https://medium.com/@magstherdev/opentelemetry-on-kubernetes-c167f024b35f</li> <li>https://medium.com/@magstherdev/opentelemetry-in-action-fc61263c852</li> <li>https://github.com/open-telemetry/opentelemetry-go-instrumentation</li> </ul>"},{"location":"chap_ot/1OpenTelemetry_intro/","title":"1 \u4e91\u539f\u751f\u53ef\u89c2\u6d4b OpenTelemetry \u57fa\u7840\u77e5\u8bc6","text":""},{"location":"chap_ot/1OpenTelemetry_intro/#1-opentelemetry_1","title":"1 \u4ec0\u4e48\u662f OpenTelemetry\uff1f","text":"<p>OpenTelemetry \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u53ef\u89c2\u6d4b\u6027\u6846\u67b6\uff0c\u7531\u4e91\u539f\u751f\u57fa\u91d1\u4f1a(CNCF)\u6258\u7ba1\u3002\u5b83\u662f OpenCensus \u548c OpenTracing \u9879\u76ee\u7684\u5408\u5e76\u3002\u65e8\u5728\u4e3a\u6240\u6709\u7c7b\u578b\u7684\u53ef\u89c2\u6d4b\u4fe1\u53f7(\u5982\u8ddf\u8e2a\u3001\u6307\u6807\u548c\u65e5\u5fd7)\u63d0\u4f9b\u5355\u4e00\u6807\u51c6\u3002</p> <ul> <li>https://opentelemetry.io</li> <li>https://www.cncf.io</li> <li>https://opencensus.io</li> </ul> <p>OpenTelemetry \u6307\u5b9a\u4e86\u5982\u4f55\u6536\u96c6\u9065\u6d4b\u6570\u636e\u5e76\u5c06\u5176\u53d1\u9001\u5230\u540e\u7aef\u5e73\u53f0\u3002\u901a\u8fc7\u63d0\u4f9b\u901a\u7528\u7684\u6570\u636e\u683c\u5f0f\u548c API, OpenTelemetry \u4f7f\u7ec4\u7ec7\u66f4\u5bb9\u6613\u5171\u4eab\u548c\u91cd\u7528\u9065\u6d4b\u6570\u636e\uff0c\u4ece\u800c\u4e0e\u5404\u79cd\u53ef\u89c2\u6d4b\u6027\u5de5\u5177\u548c\u5e73\u53f0\u96c6\u6210\u3002</p> <p>OpenTelemetry \u67b6\u6784\u4fc3\u8fdb\u4e86\u7075\u6d3b\u6027\u3001\u4e92\u64cd\u4f5c\u6027\u548c\u53ef\u6269\u5c55\u6027\uff0c\u4f7f\u5f00\u53d1\u4eba\u5458\u80fd\u591f\u91c7\u7528\u6ee1\u8db3\u5176\u7279\u5b9a\u9700\u6c42\u548c\u73af\u5883\u7684\u53ef\u89c2\u6d4b\u6027\u5b9e\u8df5\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_1","title":"\u9065\u6d4b\u6570\u636e\u7c7b\u578b","text":"<p>OpenTelemetry \u652f\u6301\u4e0d\u540c\u7684\u9065\u6d4b\u6570\u636e\u7c7b\u578b\uff1a</p> <ul> <li><code>OpenTelemetry Trace</code> \u8868\u793a\u8de8\u591a\u4e2a\u7ec4\u4ef6\u548c\u670d\u52a1\u7684\u8bf7\u6c42\u6216\u64cd\u4f5c\u7684\u6267\u884c\u8def\u5f84\u3002<ul> <li>\u5b83\u4eec\u63d0\u4f9b\u8be6\u7ec6\u7684\u65f6\u95f4\u548c\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u4e86\u89e3\u8bf7\u6c42\u6d41\u5e76\u786e\u5b9a\u6027\u80fd\u74f6\u9888\u3002</li> </ul> </li> <li><code>OpenTelemetry Metrics</code> \u662f\u5bf9\u7cfb\u7edf\u884c\u4e3a\u6216\u8d44\u6e90\u5229\u7528\u7387\u7684\u5b9a\u91cf\u6d4b\u91cf\u3002<ul> <li>\u5b83\u4eec\u6709\u52a9\u4e8e\u76d1\u63a7\u548c\u5206\u6790\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6027\u80fd\uff0c\u5e76\u53ef\u7528\u4e8e\u8b66\u62a5\u3001\u5bb9\u91cf\u89c4\u5212\u548c\u8d8b\u52bf\u5206\u6790\u3002</li> </ul> </li> <li>OpenTelemetry Logs \u5305\u542b\u6709\u5173\u5e94\u7528\u7a0b\u5e8f\u4e2d\u53d1\u751f\u7684\u4e8b\u4ef6\u3001\u9519\u8bef\u548c\u6d3b\u52a8\u7684\u7ed3\u6784\u5316\u6216\u975e\u7ed3\u6784\u5316\u6587\u672c\u4fe1\u606f\u3002<ul> <li>\u5b83\u4eec\u5bf9\u4e8e\u8c03\u8bd5\u3001\u5ba1\u8ba1\u548c\u6545\u969c\u6392\u9664\u975e\u5e38\u6709\u7528\u3002</li> </ul> </li> </ul>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry","title":"\u5982\u4f55\u4f7f\u7528 OpenTelemetry?","text":"<p>\u5f00\u59cb\u4f7f\u7528 OpenTelemetry \u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u9009\u62e9\u4e00\u4e2a\u5206\u5e03\u5f0f\u8ddf\u8e2a\u5de5\u5177( Jaeger/SigNoz/Uptrace)\u5e76\u9075\u5faa\u4ed6\u4eec\u7684\u6587\u6863\u3002</p> <ul> <li>https://www.jaegertracing.io</li> <li>https://signoz.io</li> <li>https://uptrace.dev</li> </ul>"},{"location":"chap_ot/1OpenTelemetry_intro/#_2","title":"\u672f\u8bed\u8868","text":"<ul> <li>OpenTelemetry API \u662f\u4e00\u4e2a\u7f16\u7a0b\u63a5\u53e3\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u6765\u68c0\u6d4b\u4ee3\u7801\u4ee5\u6536\u96c6\u9065\u6d4b\u6570\u636e\uff0c\u5982\u8ddf\u8e2a\u3001\u6307\u6807\u548c\u65e5\u5fd7\u3002</li> <li>OpenTelemetry SDK \u662f OpenTelemetry API \u7684\u5b98\u65b9\u5b9e\u73b0\uff0c\u7528\u4e8e\u5904\u7406\u548c\u5c06\u6536\u96c6\u7684\u9065\u6d4b\u6570\u636e\u5bfc\u51fa\u5230\u540e\u7aef\u3002</li> <li>OpenTelemetry Instrumentation \u662f\u6d41\u884c\u6846\u67b6\u548c\u5e93\u7684\u63d2\u4ef6\uff0c\u5b83\u4eec\u4f7f\u7528 OpenTelemetry API \u6765\u8bb0\u5f55\u91cd\u8981\u7684\u64cd\u4f5c\uff0c\u4f8b\u5982 HTTP \u8bf7\u6c42\u3001DB \u67e5\u8be2\u3001\u65e5\u5fd7\u3001\u9519\u8bef\u7b49\u7b49\u3002</li> <li>OpenTelemetry Collector \u662f\u5e94\u7528\u7a0b\u5e8f\u548c\u540e\u7aef\u4e4b\u95f4\u7684\u4ee3\u7406\u3002<ul> <li>\u5b83\u63a5\u6536\u9065\u6d4b\u6570\u636e\uff0c\u5bf9\u5176\u8fdb\u884c\u8f6c\u6362\uff0c\u7136\u540e\u5c06\u6570\u636e\u5bfc\u51fa\u5230\u53ef\u4ee5\u6c38\u4e45\u5b58\u50a8\u6570\u636e\u7684\u540e\u7aef\u3002</li> <li>Collector \u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u4ee3\u7406\uff0c\u4ece\u88ab\u76d1\u89c6\u7684\u7cfb\u7edf\u4e2d\u63d0\u53d6\u9065\u6d4b\u6570\u636e\uff0c\u4f8b\u5982\uff0cOpenTelemetry Redis \u6216\u6587\u4ef6\u7cfb\u7edf\u6307\u6807\u3002</li> </ul> </li> <li>OTLP \u662f SDK \u548c Collector \u4f7f\u7528\u7684 OpenTelemetry \u534f\u8bae\uff0c\u7528\u4e8e\u5c06\u6570\u636e\u5bfc\u51fa\u5230\u540e\u7aef\u6216\u5176\u4ed6\u6536\u96c6\u5668\u3002\u4f5c\u4e3a\u4f20\u8f93\u534f\u8bae\uff0cOTLP \u53ef\u4ee5\u4f7f\u7528 gRPC (OTLP/gRPC) \u6216 HTTP (OTLP/HTTP)\u3002</li> <li>OpenTelemetry Backend \u8d1f\u8d23\u63a5\u6536\u3001\u5b58\u50a8\u548c\u5206\u6790 OpenTelemetry \u6536\u96c6\u7684\u9065\u6d4b\u6570\u636e\u3002\u5b83\u5145\u5f53\u6570\u636e\u7684\u4e2d\u592e\u5b58\u50a8\u5e93\u6216\u5904\u7406\u7ba1\u9053\uff0c\u5141\u8bb8\u60a8\u805a\u5408\u3001\u67e5\u8be2\u3001\u53ef\u89c6\u5316\u5e76\u4ece\u5e94\u7528\u7a0b\u5e8f\u751f\u6210\u7684\u9065\u6d4b\u6570\u636e\u4e2d\u83b7\u5f97\u89c1\u89e3\u3002</li> <li>OpenTelemetry Jaeger \u662f OpenTelemetry \u751f\u6001\u7cfb\u7edf\u4e2d\u7684\u4e00\u4e2a\u9879\u76ee\uff0c\u901a\u5e38\u88ab\u7528\u4f5c\u9ed8\u8ba4\u7684 OpenTelemetry \u540e\u7aef\uff0c\u7528\u4e8e\u5b58\u50a8\u3001\u5206\u6790\u548c\u53ef\u89c6\u5316\u9065\u6d4b\u6570\u636e\u3002</li> </ul>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry_1","title":"OpenTelemetry \u67b6\u6784","text":""},{"location":"chap_ot/1OpenTelemetry_intro/#_3","title":"\u6982\u89c8\u56fe","text":"<p>OpenTelemetry \u67b6\u6784\u65e8\u5728\u63d0\u4f9b\u4e00\u79cd\u6807\u51c6\u5316\u7684\u65b9\u6cd5\u6765\u6536\u96c6\u3001\u4f20\u8f93\u548c\u5904\u7406\u6765\u81ea\u5e94\u7528\u7a0b\u5e8f\u548c\u670d\u52a1\u7684\u9065\u6d4b\u6570\u636e\u3002\u5b83\u7531\u51e0\u4e2a\u5173\u952e\u7ec4\u4ef6\u7ec4\u6210\uff0c\u8fd9\u4e9b\u7ec4\u4ef6\u534f\u540c\u5de5\u4f5c\u4ee5\u5b9e\u73b0\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u7684\u53ef\u89c2\u6d4b\u6027\u3002</p> <p></p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_4","title":"\u53ef\u89c2\u6d4b\u6027\u4fe1\u53f7","text":"<p>OpenTelemetry \u63d0\u4f9b\u4e86\u4e00\u79cd\u6355\u83b7\u53ef\u89c2\u6d4b\u6027\u4fe1\u53f7\u7684\u6807\u51c6\u5316\u65b9\u6cd5\uff1a</p> <ul> <li>Metrics(\u6307\u6807) \u8868\u660e\u5b58\u5728\u95ee\u9898\u3002</li> <li>Traces(\u8ddf\u8e2a) \u4f1a\u544a\u8bc9\u4f60\u95ee\u9898\u51fa\u5728\u54ea\u91cc\u3002</li> <li>Logs(\u65e5\u5fd7) \u53ef\u4ee5\u5e2e\u52a9\u60a8\u627e\u5230\u6839\u672c\u539f\u56e0\u3002</li> </ul> <p>OpenTelemetry Metrics \u662f\u5e2e\u52a9\u91cf\u5316\u7cfb\u7edf\u884c\u4e3a\u7684\u5b9a\u91cf\u6307\u6807\u3002</p> <p>\u5b83\u4eec\u63d0\u4f9b\u6709\u5173\u5e94\u7528\u7a0b\u5e8f\u67d0\u4e9b\u65b9\u9762\u7684\u5f53\u524d\u72b6\u6001\u6216\u901f\u7387\u7684\u4fe1\u606f\uff0c\u4f8b\u5982 CPU \u4f7f\u7528\u60c5\u51b5\u3001\u5185\u5b58\u6d88\u8017\u6216\u8bf7\u6c42\u5ef6\u8fdf\u3002OpenTelemetry \u5141\u8bb8\u60a8\u5b9a\u4e49\u548c\u8bb0\u5f55\u81ea\u5b9a\u4e49\u6307\u6807\uff0c\u4ee5\u76d1\u89c6\u5e94\u7528\u7a0b\u5e8f\u7684\u6027\u80fd\u548c\u8fd0\u884c\u72b6\u51b5\u3002</p> <p>https://opentelemetry.io/docs/concepts/signals/metrics/</p> <p>OpenTelemetry Traces \u63d0\u4f9b\u4e86\u8bf7\u6c42\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u6267\u884c\u8def\u5f84\u7684\u8be6\u7ec6\u8bb0\u5f55\u3002</p> <p>\u5b83\u4eec\u6355\u83b7\u5355\u4e2a\u64cd\u4f5c\u53ca\u5176\u5173\u7cfb\u7684\u65f6\u95f4\u4fe1\u606f\uff0c\u4f7f\u60a8\u80fd\u591f\u4e86\u89e3\u8bf7\u6c42\u6d41\u3001\u786e\u5b9a\u74f6\u9888\u5e76\u89e3\u51b3\u6027\u80fd\u95ee\u9898\u3002\u4f7f\u7528 OpenTelemetry\uff0c\u60a8\u53ef\u4ee5\u5bf9\u4ee3\u7801\u8fdb\u884c\u68c0\u6d4b\uff0c\u4ee5\u751f\u6210\u5206\u5e03\u5f0f\u8ddf\u8e2a\u5e76\u5728\u670d\u52a1\u4e4b\u95f4\u8fdb\u884c\u5173\u8054\u3002</p> <p>https://opentelemetry.io/docs/concepts/signals/traces/</p> <p>OpenTelemetry Logs \u662f\u5728\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u671f\u95f4\u53d1\u751f\u7684\u4e8b\u4ef6\u6216\u6d88\u606f\u7684\u6587\u672c\u8bb0\u5f55\u3002</p> <p>\u5b83\u4eec\u5e2e\u52a9\u60a8\u7406\u89e3\u5e94\u7528\u7a0b\u5e8f\u884c\u4e3a\u3001\u8bca\u65ad\u95ee\u9898\u548c\u5ba1\u8ba1\u6d3b\u52a8\u3002OpenTelemetry \u63d0\u4f9b\u4e86\u4e00\u79cd\u673a\u5236\uff0c\u53ef\u4ee5\u4ece\u5e94\u7528\u7a0b\u5e8f\u4e2d\u6355\u83b7\u7ed3\u6784\u5316\u65e5\u5fd7\uff0c\u5e76\u7528\u4e0a\u4e0b\u6587\u4fe1\u606f\u4e30\u5bcc\u5b83\u4eec\u3002</p> <p>https://opentelemetry.io/docs/concepts/signals/logs/</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#instrumentation","title":"Instrumentation \u5e93(\u68c0\u6d4b\u5de5\u5177\u7a0b\u5e8f)","text":"<p>OpenTelemetry \u4e3a\u4e0d\u540c\u7684\u7f16\u7a0b\u8bed\u8a00\u63d0\u4f9b\u4e86\u5e93\uff0c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u5e93\u6765\u68c0\u6d4b\u4ed6\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u5e76\u6536\u96c6\u9065\u6d4b\u6570\u636e\u3002</p> <p>Instrumentation \u5b98\u65b9\u8be6\u7ec6\u6587\u6863</p> <p>https://opentelemetry.io/docs/instrumentation/</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry-sdk","title":"OpenTelemetry SDK","text":"<p>OpenTelemetry SDK\uff08\u8f6f\u4ef6\u5f00\u53d1\u5de5\u5177\u5305\uff09\u662f\u4e00\u4e2a\u5e93\u548c\u5de5\u5177\u7684\u96c6\u5408\uff0c\u4f7f\u5f00\u53d1\u4eba\u5458\u80fd\u591f\u5bf9\u5176\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u68c0\u6d4b\u5e76\u6536\u96c6\u9065\u6d4b\u6570\u636e\u4ee5\u8fdb\u884c\u76d1\u63a7\u3002</p> <p>Otel SDK \u63d0\u4f9b\u4e86\u4e00\u4e2a\u6807\u51c6\u5316\u548c\u53ef\u6269\u5c55\u7684\u6846\u67b6\uff0c\u7528\u4e8e\u5c06 OpenTelemetry \u96c6\u6210\u5230\u5404\u79cd\u7f16\u7a0b\u8bed\u8a00\u548c\u73af\u5883\u4e2d\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#exporters","title":"Exporters(\u5bfc\u51fa\u5668)","text":"<p>OpenTelemetry \u5bfc\u51fa\u5668\u8d1f\u8d23\u5c06\u9065\u6d4b\u6570\u636e\u53d1\u9001\u5230\u5916\u90e8\u7cfb\u7edf\u6216\u540e\u7aef\u8fdb\u884c\u5b58\u50a8\u3001\u5206\u6790\u548c\u53ef\u89c6\u5316\u3002</p> <p>OpenTelemetry \u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u5bfc\u51fa\u7a0b\u5e8f\uff0c\u652f\u6301\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\u7684\u4e0d\u540c\u534f\u8bae\u548c\u683c\u5f0f\u3002\u8fd9\u6837\u7684\u5bfc\u51fa\u5668\u5141\u8bb8\u7528\u6237\u5c06 OpenTelemetry \u4e0e\u5176\u9996\u9009\u7684\u76d1\u63a7\u548c\u5206\u6790\u5de5\u5177\u65e0\u7f1d\u96c6\u6210\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry_2","title":"OpenTelemetry \u534f\u8bae","text":"<p>OpenTelemetry Protocol\uff08OTLP\uff09\u662f\u4e00\u79cd\u5f00\u6e90\u7684\u3001\u4e0e\u4f9b\u5e94\u5546\u65e0\u5173\u7684\u534f\u8bae\uff0c\u7528\u4e8e\u4ece\u8f6f\u4ef6\u7cfb\u7edf\u548c\u5e94\u7528\u7a0b\u5e8f\u6536\u96c6\u3001\u4f20\u8f93\u548c\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\u3002</p> <p>OTLP \u5b9a\u4e49\u4e86\u5728\u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\u548c\u540e\u7aef\u7cfb\u7edf\u4e4b\u95f4\u4ea4\u6362\u7684\u8fde\u63a5\u683c\u5f0f\u548c\u6570\u636e\u7ed3\u6784\u3002\u5b83\u6307\u5b9a\u4e86\u9065\u6d4b\u6570\u636e\u7684\u7f16\u7801\u683c\u5f0f\uff0c\u5305\u62ec\u6307\u6807\u3001\u8ddf\u8e2a\u548c\u65e5\u5fd7\u7684\u6a21\u5f0f\uff0c\u4ee5\u53ca\u5728\u7f51\u7edc\u4e2d\u4f20\u8f93\u8fd9\u4e9b\u6570\u636e\u7684\u89c4\u5219\u3002</p> <p>OTLP \u5bfc\u51fa\u5668\u5141\u8bb8\u5c06\u6536\u96c6\u7684\u9065\u6d4b\u6570\u636e\u4f20\u8f93\u5230\u540e\u7aef\u8fdb\u884c\u5904\u7406\u548c\u5206\u6790\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#context-propagation","title":"Context Propagation(\u4e0a\u4e0b\u6587\u4f20\u64ad)","text":"<p>Context propagation \u786e\u4fdd\u76f8\u5173\u7684\u4e0a\u4e0b\u6587\u6570\u636e(\u5982 trace IDs\u3001span IDs \u548c\u5176\u4ed6\u5143\u6570\u636e)\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u670d\u52a1\u548c\u7ec4\u4ef6\u4e4b\u95f4\u4e00\u81f4\u5730\u4f20\u64ad\u3002</p> <p>\u901a\u8fc7\u4f20\u64ad\u4e0a\u4e0b\u6587\uff0cOpenTelemetry \u786e\u4fdd\u4ece\u4e0d\u540c\u670d\u52a1\u548c\u7ec4\u4ef6\u6536\u96c6\u7684\u9065\u6d4b\u6570\u636e\u4fdd\u6301\u76f8\u5173\uff0c\u5373\u4f7f\u5728\u5206\u5e03\u5f0f\u548c\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u4e5f\u662f\u5982\u6b64\u3002\u5b83\u652f\u6301\u7aef\u5230\u7aef\u8ddf\u8e2a\uff0c\u4ece\u800c\u66f4\u5bb9\u6613\u7406\u89e3\u8bf7\u6c42\u6d41\u3001\u6027\u80fd\u74f6\u9888\u548c\u7cfb\u7edf\u4f9d\u8d56\u5173\u7cfb\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#resource","title":"Resource(\u8d44\u6e90)","text":"<p>Resource \u5c5e\u6027\u662f\u952e\u503c\u5bf9\uff0c\u63d0\u4f9b\u6709\u5173\u88ab\u76d1\u89c6\u5b9e\u4f53(\u5982\u670d\u52a1\u3001\u8fdb\u7a0b\u6216\u5bb9\u5668)\u7684\u5143\u6570\u636e\u3002\u5b83\u4eec\u6709\u52a9\u4e8e\u8bc6\u522b\u8d44\u6e90\uff0c\u5e76\u63d0\u4f9b\u53ef\u7528\u4e8e\u8fc7\u6ee4\u548c\u5206\u7ec4\u9065\u6d4b\u6570\u636e\u7684\u9644\u52a0\u4fe1\u606f\u3002</p> <p>\u901a\u8fc7\u5728\u9065\u6d4b\u6570\u636e\u4e2d\u5305\u542b\u8d44\u6e90\u4fe1\u606f\uff0cOpenTelemetry \u53ef\u4ee5\u66f4\u597d\u5730\u5206\u6790\u3001\u53ef\u89c6\u5316\u548c\u7406\u89e3\u7cfb\u7edf\u884c\u4e3a\u3002\u5b83\u6709\u52a9\u4e8e\u5173\u8054\u548c\u4e0a\u4e0b\u6587\u5316\u6765\u81ea\u4e0d\u540c\u6765\u6e90\u7684\u9065\u6d4b\u6570\u636e\uff0c\u5e76\u63d0\u4f9b\u89c2\u6d4b\u5230\u7684\u5e94\u7528\u7a0b\u5e8f\u6216\u670d\u52a1\u7684\u66f4\u5168\u9762\u7684\u89c6\u56fe\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry-collector","title":"OpenTelemetry Collector(\u6536\u96c6\u5668)","text":"<p>OpenTelemetry Collector \u901a\u8fc7\u63d0\u4f9b\u7075\u6d3b\u3001\u53ef\u6269\u5c55\u7684\u9065\u6d4b\u6570\u636e\u6536\u96c6\u548c\u5904\u7406\u89e3\u51b3\u65b9\u6848\uff0c\u5728 OpenTelemetry \u751f\u6001\u7cfb\u7edf\u4e2d\u53d1\u6325\u7740\u5173\u952e\u4f5c\u7528\u3002</p> <ul> <li>https://opentelemetry.io/docs/collector/</li> </ul> <p>Otel Collector \u4f5c\u4e3a\u4e00\u4e2a\u96c6\u4e2d\u7684\u4e2d\u4ecb\uff0c\u7b80\u5316\u4e86\u6570\u636e\u6536\u96c6\u7684\u590d\u6742\u6027\uff0c\u5e76\u5b9e\u73b0\u4e86\u4e0e\u4e0d\u540c\u540e\u7aef\u548c\u7cfb\u7edf\u7684\u7075\u6d3b\u96c6\u6210\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry_3","title":"OpenTelemetry \u540e\u7aef","text":"<p>OpenTelemetry \u4e0d\u5305\u62ec\u7279\u5b9a\u7684\u5185\u7f6e\u540e\u7aef\u6216\u5b58\u50a8\u7cfb\u7edf\u6765\u5904\u7406\u548c\u5206\u6790\u6570\u636e\u3002</p> <p>\u76f8\u53cd\uff0cOpenTelemetry \u63d0\u4f9b\u4e86\u57fa\u4e8e\u60a8\u7684\u7279\u5b9a\u9700\u6c42\u548c\u504f\u597d\u9009\u62e9\u548c\u96c6\u6210\u5404\u79cd\u540e\u7aef\u7cfb\u7edf\u7684\u7075\u6d3b\u6027\u3002</p> <p>\u540e\u7aef\u7cfb\u7edf\u4ece\u63d2\u5165\u6307\u4ee4\u7684\u5e94\u7528\u7a0b\u5e8f\u6216 OpenTelemetry Collector \u63a5\u6536\u5bfc\u51fa\u7684\u9065\u6d4b\u6570\u636e\u3002\u8fd9\u4e9b\u7cfb\u7edf\u8d1f\u8d23\u5b58\u50a8\u3001\u5206\u6790\u548c\u53ef\u89c6\u5316\u9065\u6d4b\u6570\u636e\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry_4","title":"OpenTelemetry \u5206\u5e03\u5f0f\u8ffd\u8e2a","text":"<p>\u5206\u5e03\u5f0f\u8ffd\u8e2a\u5141\u8bb8\u60a8\u67e5\u770b\u8bf7\u6c42\u5982\u4f55\u901a\u8fc7\u4e0d\u540c\u7684\u670d\u52a1\u548c\u7cfb\u7edf\u3001\u6bcf\u4e2a\u64cd\u4f5c\u7684\u65f6\u95f4\u3001\u53d1\u751f\u65f6\u7684\u4efb\u4f55\u65e5\u5fd7\u548c\u9519\u8bef\u3002</p> <p>\u5206\u5e03\u5f0f\u8ffd\u8e2a\u5de5\u5177\u63d0\u4f9b\u5bf9\u7cfb\u7edf\u884c\u4e3a\u7684\u53ef\u89c1\u6027\uff0c\u5e2e\u52a9\u8bc6\u522b\u6027\u80fd\u95ee\u9898\uff0c\u534f\u52a9\u8c03\u8bd5\uff0c\u5e76\u5e2e\u52a9\u786e\u4fdd\u5206\u5e03\u5f0f\u5e94\u7528\u7a0b\u5e8f\u7684\u53ef\u9760\u6027\u548c\u53ef\u4f38\u7f29\u6027\u3002</p> <p>OpenTelemetry \u8ddf\u8e2a\u5728\u5fae\u670d\u52a1\u67b6\u6784\u7684\u4e0a\u4e0b\u6587\u4e2d\u7279\u522b\u6709\u4ef7\u503c\uff0c\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u5e94\u7528\u7a0b\u5e8f\u7531\u591a\u4e2a\u72ec\u7acb\u7684\u670d\u52a1\u7ec4\u6210\uff0c\u5171\u540c\u5de5\u4f5c\u4ee5\u6ee1\u8db3\u7528\u6237\u8bf7\u6c42\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_5","title":"\u8ffd\u8e2a\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff1f","text":"<p>\u5728\u73b0\u4ee3\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u5c24\u5176\u662f\u90a3\u4e9b\u57fa\u4e8e\u5fae\u670d\u52a1\u6216\u65e0\u670d\u52a1\u5668\u67b6\u6784\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e0d\u540c\u7684\u670d\u52a1\u7ecf\u5e38\u76f8\u4e92\u4ea4\u4e92\u4ee5\u6ee1\u8db3\u5355\u4e2a\u7528\u6237\u8bf7\u6c42\u3002</p> <p>\u8fd9\u4f7f\u5f97\u8bc6\u522b\u6027\u80fd\u74f6\u9888\u3001\u8bca\u65ad\u95ee\u9898\u548c\u5206\u6790\u6574\u4e2a\u7cfb\u7edf\u884c\u4e3a\u5177\u6709\u6311\u6218\u6027\u3002</p> <p>\u5206\u5e03\u5f0f\u8ddf\u8e2a\u65e8\u5728\u901a\u8fc7\u521b\u5efa\u8ddf\u8e2a\u6765\u89e3\u51b3\u8fd9\u4e9b\u6311\u6218\uff0c\u8ddf\u8e2a\u662f\u5355\u4e2a\u7528\u6237\u8bf7\u6c42\u901a\u8fc7\u5404\u79cd\u670d\u52a1\u548c\u7ec4\u4ef6\u7684\u8fc7\u7a0b\u7684\u8868\u793a\u3002</p> <p>\u6bcf\u4e2a\u8ddf\u8e2a\u90fd\u7531\u4e00\u7cfb\u5217\u76f8\u4e92\u8fde\u63a5\u7684 span \u7ec4\u6210\uff0c\u5176\u4e2d\u6bcf\u4e2a span \u4ee3\u8868\u7279\u5b9a\u670d\u52a1\u6216\u7ec4\u4ef6\u4e2d\u7684\u5355\u4e2a\u64cd\u4f5c\u6216\u6d3b\u52a8\u3002</p> <p>\u5f53\u8bf7\u6c42\u8fdb\u5165\u670d\u52a1\u65f6\uff0c\u8ddf\u8e2a\u4e0a\u4e0b\u6587\u5c06\u4e0e\u8bf7\u6c42\u4e00\u8d77\u4f20\u64ad\u3002\u8fd9\u901a\u5e38\u6d89\u53ca\u5230\u5c06\u8ddf\u8e2a\u5934\u6ce8\u5165\u5230\u8bf7\u6c42\u4e2d\uff0c\u5141\u8bb8\u4e0b\u6e38\u670d\u52a1\u53c2\u4e0e\u540c\u4e00\u8ddf\u8e2a\u3002</p> <p>\u5f53\u8bf7\u6c42\u5728\u7cfb\u7edf\u4e2d\u6d41\u52a8\u65f6\uff0c\u6bcf\u4e2a\u670d\u52a1\u90fd\u4f1a\u751f\u6210\u81ea\u5df1\u7684 span\uff0c\u5e76\u4f7f\u7528\u6709\u5173\u5176\u64cd\u4f5c\u6301\u7eed\u65f6\u95f4\u3001\u5143\u6570\u636e\u548c\u4efb\u4f55\u76f8\u5173\u4e0a\u4e0b\u6587\u7684\u4fe1\u606f\u66f4\u65b0\u8ddf\u8e2a\u4e0a\u4e0b\u6587\u3002</p> <p></p> <p>\u5206\u5e03\u5f0f\u8ddf\u8e2a\u5de5\u5177\u4f7f\u7528\u751f\u6210\u7684\u8ddf\u8e2a\u6570\u636e\u6765\u63d0\u4f9b\u5bf9\u7cfb\u7edf\u884c\u4e3a\u7684\u53ef\u89c1\u6027\uff0c\u5e2e\u52a9\u8bc6\u522b\u6027\u80fd\u95ee\u9898\uff0c\u5e2e\u52a9\u8c03\u8bd5\uff0c\u5e76\u5e2e\u52a9\u786e\u4fdd\u5206\u5e03\u5f0f\u5e94\u7528\u7a0b\u5e8f\u7684\u53ef\u9760\u6027\u548c\u53ef\u6269\u5c55\u6027\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#spans","title":"Spans(\u8de8\u5ea6)","text":"<p>Span \u8868\u793a\u8ddf\u8e2a\u4e2d\u7684\u4e00\u4e2a\u64cd\u4f5c(\u5de5\u4f5c\u5355\u5143)\u3002span \u53ef\u4ee5\u662f\u8fdc\u7a0b\u8fc7\u7a0b\u8c03\u7528(RPC)\u3001\u6570\u636e\u5e93\u67e5\u8be2\u6216\u8fdb\u7a0b\u5185\u51fd\u6570\u8c03\u7528\u3002\u4e00\u4e2a span \u6709:</p> <ul> <li>span name(\u64cd\u4f5c\u540d\u79f0)\u3002</li> <li>\u7236 span\u3002</li> <li>span kind(\u7c7b\u578b)\u3002</li> <li>\u5f00\u59cb\u548c\u7ed3\u675f\u65f6\u95f4\u3002</li> <li>\u62a5\u544a\u64cd\u4f5c\u6210\u529f\u6216\u5931\u8d25\u7684 status\u3002</li> <li>\u63cf\u8ff0\u64cd\u4f5c\u7684\u4e00\u7ec4\u952e\u503c attributes\u3002</li> <li>events \u7684\u65f6\u95f4\u8f74\u3002</li> <li>\u6307\u5411\u5176\u5b83 span \u7684\u94fe\u63a5\u5217\u8868\u3002</li> <li>\u5728\u4e0d\u540c\u670d\u52a1\u4e4b\u95f4\u4f20\u64ad trace ID \u548c\u5176\u4ed6\u6570\u636e\u7684 span context\u3002</li> </ul> <p>trace \u662f\u4e00\u4e2a span \u6811\uff0c\u5b83\u663e\u793a\u4e86\u8bf7\u6c42\u901a\u8fc7\u5e94\u7528\u7a0b\u5e8f\u6240\u4ea7\u751f\u7684\u8def\u5f84\u3002root span \u662f\u8ddf\u8e2a\u4e2d\u7684\u7b2c\u4e00\u4e2a span\u3002</p> <p></p>"},{"location":"chap_ot/1OpenTelemetry_intro/#span","title":"Span \u540d\u79f0","text":"<p>OpenTelemetry \u540e\u7aef\u4f7f\u7528 span \u540d\u79f0\u548c\u4e00\u4e9b\u5c5e\u6027\u5c06\u76f8\u4f3c\u7684 span \u7ec4\u5408\u5728\u4e00\u8d77\u3002</p> <p>\u8981\u6b63\u786e\u5730\u5bf9 span \u8fdb\u884c\u5206\u7ec4\uff0c\u8bf7\u7ed9\u5b83\u4eec\u8d77\u7b80\u77ed\u800c\u7b80\u6d01\u7684\u540d\u5b57\u3002</p> <p>\u552f\u4e00\u7684 span \u540d\u79f0\u7684\u603b\u6570\u5e94\u5c0f\u4e8e 1000\u3002\u5426\u5219\uff0c\u60a8\u5c06\u6709\u592a\u591a\u7684 span \u7ec4\uff0c\u60a8\u7684\u4f53\u9a8c\u53ef\u80fd\u4f1a\u53d7\u5230\u5f71\u54cd\u3002</p> <p>\u4e0b\u9762\u7684\u540d\u5b57\u5f88\u597d\uff0c\u56e0\u4e3a\u5b83\u4eec\u7b80\u77ed\u3001\u72ec\u7279\uff0c\u5e76\u4e14\u6709\u52a9\u4e8e\u5c06\u76f8\u4f3c\u7684 span \u5206\u7ec4\u5728\u4e00\u8d77:</p> Span name Comment <code>GET /projects/:id</code> Good\u3002\u5e26\u6709\u53c2\u6570\u540d\u7684\u8def\u7531\u540d\u3002 <code>select_project</code> Good\u3002\u4e0d\u5e26\u53c2\u6570\u7684\u51fd\u6570\u540d\u3002 <code>SELECT * FROM projects WHERE id = ?</code> Good\u3002\u4e0d\u5e26\u53c2\u6570\u7684\u51fd\u6570\u540d\u3002 <p>\u4ee5\u4e0b\u540d\u79f0\u4e0d\u6b63\u786e\uff0c\u56e0\u4e3a\u5b83\u4eec\u5305\u542b\u53d8\u91cf params \u548c args\uff1a</p> Span name Comment <code>GET /projects/42</code> Bad\u3002\u5305\u542b\u4e00\u4e2a\u53d8\u91cf\u53c2\u6570 42\u3002 <code>select_project(42)</code> Bad\u3002\u5305\u542b\u53d8\u91cf 42\u3002 <code>SELECT * FROM projects WHERE id = 42</code> Bad\u3002\u5305\u542b\u4e00\u4e2a\u53d8\u91cf arg 42\u3002"},{"location":"chap_ot/1OpenTelemetry_intro/#span_1","title":"Span \u7c7b\u578b","text":"<p>Span kind \u5fc5\u987b\u662f\u4ee5\u4e0b\u503c\u4e4b\u4e00:</p> <ul> <li>server \u7528\u4e8e\u670d\u52a1\u5668\u64cd\u4f5c\uff0c\u4f8b\u5982 HTTP \u670d\u52a1\u5668\u5904\u7406\u7a0b\u5e8f\u3002</li> <li>client \u7528\u4e8e\u5ba2\u6237\u7aef\u64cd\u4f5c\uff0c\u4f8b\u5982 HTTP \u5ba2\u6237\u7aef\u8bf7\u6c42\u3002</li> <li>producer \u5bf9\u4e8e\u6d88\u606f\u751f\u4ea7\u8005\uff0c\u4f8b\u5982 Kafka producer\u3002</li> <li>consumer \u4e00\u822c\u7528\u4e8e\u6d88\u606f\u6d88\u8d39\u8005\u548c\u5f02\u6b65\u5904\u7406\uff0c\u4f8b\u5982 Kafka consumer\u3002</li> <li>internal \u7528\u4e8e\u5185\u90e8\u64cd\u4f5c\u3002</li> </ul>"},{"location":"chap_ot/1OpenTelemetry_intro/#status-code","title":"Status code(\u72b6\u6001\u7801)","text":"<p>\u72b6\u6001\u7801\u8868\u793a\u64cd\u4f5c\u6210\u529f\u6216\u5931\u8d25\u3002\u5fc5\u987b\u662f\u4ee5\u4e0b\u503c\u4e4b\u4e00:</p> <ul> <li>ok - \u6210\u529f\u3002</li> <li>error - \u5931\u8d25\u3002</li> <li>unset - \u5141\u8bb8\u540e\u7aef\u5206\u914d\u72b6\u6001\u7684\u9ed8\u8ba4\u503c\u3002</li> </ul>"},{"location":"chap_ot/1OpenTelemetry_intro/#attributes","title":"Attributes(\u5c5e\u6027)","text":"<p>\u8981\u8bb0\u5f55\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u60a8\u53ef\u4ee5\u7528\u5e26\u6709\u7279\u5b9a\u4e8e\u64cd\u4f5c\u7684\u4fe1\u606f\u7684\u5c5e\u6027\u5bf9 span \u8fdb\u884c\u6ce8\u91ca\u3002</p> <p>\u4f8b\u5982\uff0cHTTP \u7aef\u70b9\u53ef\u80fd\u5177\u6709 <code>http.method = GET</code> \u4e0e <code>http.route = /projects/:id</code>\u3002</p> <p>\u60a8\u53ef\u4ee5\u968f\u610f\u547d\u540d\u5c5e\u6027\uff0c\u4f46\u5bf9\u4e8e\u5e38\u89c1\u64cd\u4f5c\uff0c\u60a8\u5e94\u8be5\u4f7f\u7528 semantic attributes \u7ea6\u5b9a\u3002\u5b83\u5b9a\u4e49\u4e86\u4e00\u4e2a\u516c\u5171\u5c5e\u6027\u952e\u5217\u8868\uff0c\u5176\u4e2d\u5305\u542b\u5b83\u4eec\u7684\u542b\u4e49\u548c\u53ef\u80fd\u7684\u503c\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#events","title":"Events(\u4e8b\u4ef6)","text":"<p>\u60a8\u8fd8\u53ef\u4ee5\u7528\u5177\u6709\u5f00\u59cb\u65f6\u95f4\u548c\u4efb\u610f\u6570\u91cf\u5c5e\u6027\u7684\u4e8b\u4ef6\u6ce8\u91ca span \u3002\u4e8b\u4ef6\u548c span \u7684\u4e3b\u8981\u533a\u522b\u5728\u4e8e\u4e8b\u4ef6\u6ca1\u6709\u7ed3\u675f\u65f6\u95f4(\u56e0\u6b64\u6ca1\u6709\u6301\u7eed\u65f6\u95f4)\u3002</p> <p>\u4e8b\u4ef6\u901a\u5e38\u8868\u793a\u5f02\u5e38\u3001\u9519\u8bef\u3001\u65e5\u5fd7\u548c\u6d88\u606f(\u4f8b\u5982\u5728 RPC \u4e2d)\uff0c\u4f46\u662f\u60a8\u4e5f\u53ef\u4ee5\u521b\u5efa\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#context","title":"Context(\u4e0a\u4e0b\u6587)","text":"<p>\u5f53 Span context \u901a\u8fc7\u4e0d\u540c\u7684\u7ec4\u4ef6\u548c\u670d\u52a1\u4f20\u64ad\u65f6\uff0c\u5b83\u643a\u5e26\u6709\u5173\u8be5 span \u7684\u4fe1\u606f\u3002</p> <p>Trace/span context \u662f\u4e00\u4e2a\u8bf7\u6c42\u8303\u56f4\u7684\u6570\u636e\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>Trace ID. \u8868\u793a\u6574\u4e2a trace \u6216 query \u7684\u5168\u5c40\u552f\u4e00\u6807\u8bc6\u7b26\u3002trace \u4e2d\u7684\u6240\u6709 span \u90fd\u5177\u6709\u76f8\u540c\u7684 trace ID\u3002</li> <li>Span ID. trace \u4e2d\u7279\u5b9a span \u7684\u552f\u4e00\u6807\u8bc6\u7b26\u3002trace \u4e2d\u7684\u6bcf\u4e2a span \u90fd\u6709\u4e0d\u540c\u7684 span ID\u3002</li> <li>Trace flags. \u6307\u793a trace \u7684\u5404\u79cd\u5c5e\u6027\u7684 flag\uff0c\u4f8b\u5982\u662f\u5426\u5bf9\u5176\u8fdb\u884c\u4e86\u91c7\u6837\u3002\u91c7\u6837\u662f\u6307\u786e\u5b9a\u5e94\u8bb0\u5f55\u54ea\u4e9b span \u5e76\u5c06\u5176\u62a5\u544a\u7ed9\u53ef\u89c2\u6d4b\u6027\u540e\u7aef\u7684\u8fc7\u7a0b\u3002</li> <li>Trace State. \u4e00\u4e2a\u53ef\u9009\u5b57\u6bb5\uff0c\u5305\u542b\u4e0e trace \u76f8\u5173\u7684\u5176\u4ed6\u4f9b\u5e94\u5546\u6216\u5e94\u7528\u7a0b\u5e8f\u7279\u5b9a\u6570\u636e\u3002</li> </ul> <p>Span context \u5bf9\u4e8e\u4fdd\u6301\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d span \u7684\u8fde\u7eed\u6027\u548c\u76f8\u5173\u6027\u975e\u5e38\u91cd\u8981\u3002\u5b83\u5141\u8bb8\u4e0d\u540c\u7684\u670d\u52a1\u548c\u7ec4\u4ef6\u5c06\u5176 span \u4e0e\u6b63\u786e\u7684\u8ddf\u8e2a\u76f8\u5173\u8054\uff0c\u5e76\u63d0\u4f9b\u5bf9\u8bf7\u6c42\u6216\u4e8b\u52a1\u6d41\u7684\u7aef\u5230\u7aef\u53ef\u89c1\u6027\u3002</p> <p>Span context \u901a\u5e38\u4f7f\u7528\u670d\u52a1\u4e4b\u95f4\u901a\u4fe1\u534f\u8bae\u7684\u6807\u5934\u6216\u5143\u6570\u636e\u8fdb\u884c\u4f20\u64ad\uff0c\u7c7b\u4f3c\u4e8e baggage \u6570\u636e\u7684\u4f20\u64ad\u65b9\u5f0f\u3002\u8fd9\u786e\u4fdd\u4e86\u5f53\u670d\u52a1\u63a5\u6536\u5230\u8bf7\u6c42\u65f6\uff0c\u5b83\u53ef\u4ee5\u63d0\u53d6 span context\uff0c\u5e76\u5c06\u4f20\u5165\u7684 span \u4e0e\u6b63\u786e\u7684 trace \u76f8\u5173\u8054\u3002</p> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528\u4e0a\u4e0b\u6587\u4e2d\u7684\u6570\u636e\u8fdb\u884c span \u76f8\u5173\u6027\u6216\u91c7\u6837\uff0c\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 trace id \u6765\u77e5\u9053\u54ea\u4e9b span \u5c5e\u4e8e\u54ea\u4e9b trace\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#context-propagation_1","title":"Context propagation(\u4e0a\u4e0b\u6587\u4f20\u64ad)","text":"<p>\u4e0a\u4e0b\u6587\u4f20\u64ad\u786e\u4fdd\u76f8\u5173\u7684\u4e0a\u4e0b\u6587\u6570\u636e\uff0c\u5982 trace ID\u3001span ID \u548c\u5176\u4ed6\u5143\u6570\u636e\uff0c\u5728\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u670d\u52a1\u548c\u7ec4\u4ef6\u4e4b\u95f4\u4e00\u81f4\u5730\u4f20\u64ad\u3002</p> <p>OpenTemetry \u5728\u8fdb\u7a0b\u5185\u7684\u51fd\u6570\u4e4b\u95f4\u4f20\u64ad\u4e0a\u4e0b\u6587(\u8fdb\u7a0b\u5185\u4f20\u64ad)\uff0c\u751a\u81f3\u4ece\u4e00\u4e2a\u670d\u52a1\u4f20\u64ad\u5230\u53e6\u4e00\u4e2a\u670d\u52a1(\u5206\u5e03\u5f0f\u4f20\u64ad)\u3002</p> <p>\u8fdb\u7a0b\u5185\u4f20\u64ad\u53ef\u4ee5\u662f\u9690\u5f0f\u7684\uff0c\u4e5f\u53ef\u4ee5\u662f\u663e\u5f0f\u7684\uff0c\u8fd9\u53d6\u51b3\u4e8e\u6240\u4f7f\u7528\u7684\u7f16\u7a0b\u8bed\u8a00\u3002\u9690\u5f0f\u4f20\u64ad\u901a\u8fc7\u5c06\u6d3b\u52a8\u4e0a\u4e0b\u6587\u5b58\u50a8\u5728\u7ebf\u7a0b\u5c40\u90e8\u53d8\u91cf(Java, Python, Ruby, NodeJS)\u4e2d\u81ea\u52a8\u5b8c\u6210\u3002\u663e\u5f0f\u4f20\u64ad\u9700\u8981\u663e\u5f0f\u5730\u5c06\u6d3b\u52a8\u4e0a\u4e0b\u6587\u4f5c\u4e3a\u53c2\u6570\u4ece\u4e00\u4e2a\u51fd\u6570\u4f20\u9012\u5230\u53e6\u4e00\u4e2a\u51fd\u6570(Go)\u3002</p> <p>\u5bf9\u4e8e\u5206\u5e03\u5f0f\u4e0a\u4e0b\u6587\u4f20\u64ad\uff0cOpenTelemetry \u652f\u6301\u51e0\u79cd\u534f\u8bae\uff0c\u8fd9\u4e9b\u534f\u8bae\u5b9a\u4e49\u4e86\u5982\u4f55\u5e8f\u5217\u5316\u548c\u4f20\u9012\u4e0a\u4e0b\u6587\u6570\u636e:</p> <ul> <li>W3C trace context \u5728 <code>traceparent header</code> \u4e2d, \u4f8b\u5982, <code>traceparent=00-84b54e9330faae5350f0dd8673c98146-279fa73bc935cc05-01</code>\u3002<ul> <li>https://www.w3.org/TR/trace-context/</li> </ul> </li> <li><code>B3 Zipkin</code> \u5728\u4ee5 <code>x-b3-</code> \u5f00\u59cb\u7684 <code>header</code> \u4e2d, \u4f8b\u5982, <code>X-B3-TraceId</code>\u3002<ul> <li>https://github.com/openzipkin/b3-propagation</li> </ul> </li> </ul> <p>W3C trace context \u662f\u9ed8\u8ba4\u542f\u7528\u7684\u63a8\u8350\u4f20\u64ad\u5668\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#baggage","title":"Baggage(\u884c\u674e)","text":"<p><code>Baggage</code> \u7684\u5de5\u4f5c\u539f\u7406\u7c7b\u4f3c\u4e8e <code>span context</code>\uff0c\u5141\u8bb8\u60a8\u5c06\u81ea\u5b9a\u4e49 <code>key:value</code> \u5bf9(\u5c5e\u6027)\u4ece\u4e00\u4e2a\u670d\u52a1\u4f20\u64ad\u5230\u53e6\u4e00\u4e2a\u670d\u52a1\u3002</p> <p>\u5728 gRPC \u4e16\u754c\u4e2d\uff0c\u6709\u4e00\u4e2a\u7c7b\u4f3c\u7684\u6982\u5ff5\u53eb\u505a gRPC metadata\u3002</p> <p>https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/baggage/api.md</p> <p>Baggage \u5141\u8bb8\u60a8\u5c06\u952e\u503c\u5bf9\u4e0e\u8bf7\u6c42\u6216\u4e8b\u52a1\u5173\u8054\u8d77\u6765\u3002\u8fd9\u4e9b\u952e\u503c\u5bf9\u8868\u793a\u53ef\u80fd\u4e0e\u8bf7\u6c42\u6216\u4e8b\u52a1\u5904\u7406\u76f8\u5173\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u4f8b\u5982 user ID\u3001session ID \u6216\u5176\u4ed6\u7279\u5b9a\u4e8e\u5e94\u7528\u7a0b\u5e8f\u7684\u5143\u6570\u636e\u3002</p> <p>Baggage \u6709\u52a9\u4e8e\u7ef4\u62a4\u548c\u5173\u8054\u8de8\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u4ece\u800c\u5b9e\u73b0\u5bf9\u5e94\u7528\u7a0b\u5e8f\u884c\u4e3a\u7684\u66f4\u597d\u7684\u53ef\u89c2\u6d4b\u6027\u548c\u5206\u6790\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u79cd\u6807\u51c6\u5316\u7684\u65b9\u5f0f\u6765\u5728\u6574\u4e2a\u7cfb\u7edf\u4e2d\u4f20\u9012\u76f8\u5173\u6570\u636e\uff0c\u800c\u4e0d\u4f9d\u8d56\u4e8e\u7279\u522b\u7684\u673a\u5236\u6216\u624b\u52a8\u68c0\u6d4b\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#instrumentation_1","title":"\u4ec0\u4e48\u65f6\u5019\u4f18\u5148\u53bb Instrumentation","text":"<p>Instrumentation \u5b98\u65b9\u8be6\u7ec6\u6587\u6863</p> <p>https://opentelemetry.io/docs/instrumentation/</p> <p>\u60a8\u4e0d\u9700\u8981\u8bb0\u5f55\u6bcf\u4e2a\u64cd\u4f5c\u6765\u5145\u5206\u5229\u7528\u8ddf\u8e2a\u3002\u8fd9\u53ef\u80fd\u4f1a\u82b1\u8d39\u5f88\u591a\u65f6\u95f4\uff0c\u800c\u4e14\u901a\u5e38\u662f\u4e0d\u5fc5\u8981\u7684\u3002\u4f18\u5148\u8003\u8651\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ul> <li>Network \u64cd\u4f5c, \u4f8b\u5982\uff0cHTTP \u8bf7\u6c42\u6216 RPC \u8c03\u7528\u3002</li> <li>Filesystem \u64cd\u4f5c, \u4f8b\u5982\uff0c\u8bfb/\u5199\u6587\u4ef6\u3002</li> <li>Database \u67e5\u8be2\uff0c\u5b83\u7ed3\u5408\u4e86\u7f51\u7edc\u4e0e\u6587\u4ef6\u7cfb\u7edf\u64cd\u4f5c\u3002</li> <li>Errors and logs\uff0c\u4f8b\u5982\uff0c\u4f7f\u7528\u7ed3\u6784\u5316\u65e5\u5fd7\u3002</li> </ul>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry-metrics","title":"OpenTelemetry Metrics(\u6307\u6807)","text":"<p>OpenTelemetry Metrics \u662f\u4e00\u4e2a\u5173\u4e8e\u5982\u4f55\u6536\u96c6\u3001\u805a\u5408\u548c\u53d1\u9001\u6307\u6807\u5230 OpenTelemetry APM \u5de5\u5177(\u5982 Uptrace \u6216 Prometheus )\u7684\u6807\u51c6\u3002</p> <p>\u5728\u5b9a\u4e49\u65b0\u6807\u51c6\u7684\u540c\u65f6\uff0cOpenTelemetry \u8fd8\u81f4\u529b\u4e8e\u4e0e\u73b0\u6709\u7684\u6307\u6807\u5de5\u5177\u534f\u8bae(\u5982 Prometheus \u548c Statsd)\u4e00\u8d77\u5de5\u4f5c\u3002\u6b64\u5916\uff0cOpenTelemetry Collector \u751a\u81f3\u652f\u6301\u66f4\u591a\u7684\u534f\u8bae\uff0c\u5982 AWS Metrics\u3001InfluxDB\u3001Chrony \u7b49\u3002</p> <p>OpenTelemetry \u8fd8\u5141\u8bb8\u60a8\u901a\u8fc7\u793a\u4f8b\u5173\u8054\u6307\u6807\u548c\u8ddf\u8e2a\uff0c\u8fd9\u4e9b\u793a\u4f8b\u5e94\u8be5\u5411\u60a8\u5c55\u793a\u7cfb\u7edf\u72b6\u6001\u7684\u66f4\u5e7f\u6cdb\u7684\u56fe\u50cf\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_6","title":"\u4ec0\u4e48\u662f\u6307\u6807?","text":"<p>\u6307\u6807\u662f\u8868\u793a\u7cfb\u7edf\u8fd0\u884c\u72b6\u51b5\u548c\u6027\u80fd\u7684\u6570\u503c\u6570\u636e\u70b9\uff0c\u4f8b\u5982 CPU \u5229\u7528\u7387\u3001\u7f51\u7edc\u6d41\u91cf\u548c\u6570\u636e\u5e93\u8fde\u63a5\u3002</p> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528\u6307\u6807\u6765\u5ea6\u91cf\u3001\u76d1\u89c6\u548c\u6bd4\u8f83\u6027\u80fd\uff0c\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u5ea6\u91cf\u670d\u52a1\u5668\u54cd\u5e94\u65f6\u95f4\u3001\u5185\u5b58\u5229\u7528\u7387\u3001\u9519\u8bef\u7387\u7b49\u7b49\u3002</p> <p>Instruments</p> <p>instrument \u662f\u4e00\u79cd\u7279\u5b9a\u7c7b\u578b\u7684\u6307\u6807(\u4f8b\u5982\uff0ccounter, gauge, histogram)\uff0c\u7528\u4e8e\u6536\u96c6\u5173\u4e8e\u5e94\u7528\u7a0b\u5e8f\u884c\u4e3a\u7684\u7279\u5b9a\u65b9\u9762\u7684\u6570\u636e\u3002</p> <p>\u60a8\u901a\u8fc7\u521b\u5efa\u5177\u6709\u4ee5\u4e0b\u529f\u80fd\u7684 instrument \u6765\u6355\u83b7\u6d4b\u91cf\u7ed3\u679c:</p> <ul> <li>\u552f\u4e00\u7684\u540d\u79f0\uff0c\u4f8b\u5982 <code>http.server.duration</code>\u3002</li> <li>\u4e00\u79cd instrument \u7c7b\u578b\uff0c\u4f8b\u5982 <code>Histogram</code>\u3002</li> <li>\u4e00\u4e2a\u53ef\u9009\u7684\u6307\u6807\u5355\u4f4d\uff0c\u4f8b\u5982 <code>milliseconds</code> \u6216 <code>bytes</code>\u3002</li> <li>\u53ef\u9009\u63cf\u8ff0\u3002</li> </ul> <p>Timeseries(\u65f6\u95f4\u5e8f\u5217)</p> <p>\u4e00\u4e2a instrument \u53ef\u4ee5\u751f\u6210\u591a\u4e2a\u65f6\u95f4\u5e8f\u5217\u3002\u65f6\u95f4\u5e8f\u5217\u662f\u4e00\u4e2a\u5177\u6709\u552f\u4e00\u5c5e\u6027\u96c6\u7684\u6307\u6807\uff0c\u4f8b\u5982\uff0c\u5bf9\u4e8e\u76f8\u540c\u7684\u6307\u6807\u540d\u79f0\uff0c\u6bcf\u4e2a\u4e3b\u673a\u90fd\u6709\u4e00\u4e2a\u5355\u72ec\u7684\u65f6\u95f4\u5e8f\u5217\u3002</p> <p>Additive(\u53ef\u52a0) instruments</p> <p>Additive \u6216 summable instruments \u4ea7\u751f\u7684\u65f6\u95f4\u5e8f\u5217\uff0c\u5f53\u52a0\u5728\u4e00\u8d77\u65f6\uff0c\u4ea7\u751f\u53e6\u4e00\u4e2a\u6709\u610f\u4e49\u548c\u51c6\u786e\u7684\u65f6\u95f4\u5e8f\u5217\u3002\u6d4b\u91cf <code>non-decreasing</code> \u6570\u7684 <code>Additive instruments</code> \u4e5f\u79f0\u4e3a <code>monotonic</code>(\u5355\u8c03\u7684)\u3002</p> <p>\u4f8b\u5982\uff0c<code>http.server.requests</code> \u662f\u4e00\u4e2a <code>additive</code> \u65f6\u95f4\u5e8f\u5217\uff0c\u56e0\u4e3a\u60a8\u53ef\u4ee5\u5c06\u6765\u81ea\u4e0d\u540c\u4e3b\u673a\u7684\u8bf7\u6c42\u6570\u76f8\u52a0\uff0c\u4ee5\u83b7\u5f97\u8bf7\u6c42\u603b\u6570\u3002</p> <p>\u4f46\u662f\uff0c<code>system.memory.utilization</code>(\u767e\u5206\u6bd4) \u4e0d\u662f\u76f8\u52a0\u7684\uff0c\u56e0\u4e3a\u6765\u81ea\u4e0d\u540c\u4e3b\u673a\u7684\u5185\u5b58\u5229\u7528\u7387\u4e4b\u548c\u6ca1\u6709\u610f\u4e49(90% + 90% = 180%)\u3002</p> <p>Synchronous(\u540c\u6b65) instruments</p> <p><code>Synchronous instruments</code> \u4e0e\u5b83\u4eec\u6b63\u5728\u6d4b\u91cf\u7684\u64cd\u4f5c\u4e00\u8d77\u88ab\u8c03\u7528\u3002\u4f8b\u5982\uff0c\u4e3a\u4e86\u6d4b\u91cf\u8bf7\u6c42\u7684\u6570\u91cf\uff0c\u53ea\u8981\u6709\u65b0\u7684\u8bf7\u6c42\uff0c\u5c31\u53ef\u4ee5\u8c03\u7528 <code>counter.Add(ctx, 1)</code>\u3002\u540c\u6b65\u6d4b\u91cf\u53ef\u4ee5\u5177\u6709\u5173\u8054\u7684 <code>trace context</code>\u3002</p> <p>\u5bf9\u4e8e <code>synchronous instruments</code>\uff0c<code>additive</code>\u548c <code>grouping instruments</code>\u4e4b\u95f4\u7684\u533a\u522b\u5728\u4e8e <code>additive instruments</code> \u4ea7\u751f <code>summable</code> \u65f6\u95f4\u5e8f\u5217\uff0c<code>grouping instruments</code> \u4ea7\u751f <code>histogram</code>\u3002</p> Instrument Properties Aggregation Example Counter \u5355\u8c03\u7684 sum -&gt; delta \u8bf7\u6c42\u6570\uff0c\u8bf7\u6c42\u5927\u5c0f UpDownCounter \u53ef\u52a0\u7684 last value -&gt; sum \u8fde\u63a5\u6570 Histogram \u53ef\u5206\u7ec4\u7684 histogram \u8bf7\u6c42\u6301\u7eed\u65f6\u95f4\u3001\u8bf7\u6c42\u5927\u5c0f"},{"location":"chap_ot/1OpenTelemetry_intro/#asynchronous-instruments","title":"Asynchronous(\u5f02\u6b65) instruments","text":"<p>Asynchronous instruments \u5b9a\u671f\u8c03\u7528\u56de\u8c03\u51fd\u6570\u6765\u6536\u96c6\u6d4b\u91cf\u503c\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u89c2\u5bdf\u5668\u5b9a\u671f\u6d4b\u91cf\u5185\u5b58\u6216 CPU \u7684\u4f7f\u7528\u60c5\u51b5\u3002Asynchronous \u6d4b\u91cf\u4e0d\u80fd\u5177\u6709\u5173\u8054\u7684 trace context\u3002</p> <p>\u5728 <code>UpDownCounterObserver (additive)</code> \u548c <code>GaugeObserver (grouping)</code>\u4e4b\u95f4\u8fdb\u884c\u9009\u62e9\u65f6\uff0c \u5bf9\u4e8e summable \u65f6\u95f4\u5e8f\u5217\uff0c\u8bf7\u9009\u62e9 <code>UpDownCounterObserver</code>\uff0c\u5426\u5219\uff0c\u8bf7\u9009\u62e9 <code>GaugeObserver</code>\u3002</p> <p>\u4f8b\u5982\uff0c\u8981\u6d4b\u91cf <code>system.memory.usage (bytes)</code>\uff0c\u5e94\u4f7f\u7528 <code>UpDownCounterObserver</code>\u3002\u4f46\u8981\u6d4b\u91cf <code>system.memory.utilization</code>\uff08\u767e\u5206\u6bd4\uff09\uff0c\u60a8\u5e94\u8be5\u4f7f\u7528 <code>GaugeObserver</code>\u3002</p> Instrument Name Properties Aggregation Example CounterObserver \u5355\u8c03\u7684 sum -&gt; delta CPU time UpDownCounter \u53ef\u52a0\u7684 last value -&gt; sum Memory usage (bytes) GaugeObserver \u53ef\u5206\u7ec4\u7684 last value -&gt; none/avg Memory utilization (%)"},{"location":"chap_ot/1OpenTelemetry_intro/#instruments","title":"\u9009\u62e9 instruments","text":"<ul> <li>\u5982\u679c\u60a8\u9700\u8981\u76f4\u65b9\u56fe\u3001\u70ed\u56fe\u6216\u767e\u5206\u4f4d\u6570\uff0c\u8bf7\u4f7f\u7528 <code>Histogram</code>\u3002</li> <li>\u5982\u679c\u60a8\u60f3\u901a\u8fc7\u8bb0\u5f55\u589e\u91cf\u503c\u6765\u8ba1\u6570\uff1a<ul> <li>\u5982\u679c\u8be5\u503c\u662f <code>monotonic</code>\u7684\uff0c\u8bf7\u4f7f\u7528 <code>Counter</code>\u3002</li> <li>\u5426\u5219\uff0c\u4f7f\u7528 <code>UpDownCounter</code>\u3002</li> </ul> </li> <li>\u5982\u679c\u4f60\u60f3\u901a\u8fc7\u8bb0\u5f55\u4e00\u4e2a\u7edd\u5bf9\u503c\u6765\u6d4b\u91cf\u67d0\u4e2a\u4e1c\u897f\uff1a<ul> <li>\u5982\u679c\u8be5\u503c\u662f monotonic \u7684\uff0c\u8bf7\u4f7f\u7528 CounterObserver\u3002</li> <li>\u5426\u5219\uff0c\u8bf7\u4f7f\u7528 UpDownCounterObserver\u3002</li> <li>\u5982\u679c\u8be5\u503c\u662f additive/summable \u7684\uff1a</li> <li>\u5982\u679c\u8be5\u503c\u4e0d additive/summable\uff0c\u8bf7\u4f7f\u7528 GaugeObserver\u3002</li> </ul> </li> </ul>"},{"location":"chap_ot/1OpenTelemetry_intro/#counter","title":"Counter","text":"<p><code>synchronous monotonic</code></p> <p><code>Counter</code> \u662f\u4e00\u79cd\u540c\u6b65 instrument\uff0c\u7528\u4e8e\u6d4b\u91cf\u76f8\u52a0\u7684\u975e\u9012\u51cf\u503c\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>processed requests</li> <li>errors</li> <li>received bytes</li> <li>disk reads</li> </ul> <p>Counters \u7528\u4e8e\u6d4b\u91cf\u4e00\u4e2a\u4e8b\u4ef6\u7684\u53d1\u751f\u6b21\u6570\u6216\u4e00\u4e2a\u503c\u968f\u65f6\u95f4\u7684\u7d2f\u79ef\u3002\u5b83\u4eec\u53ea\u80fd\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\u800c\u589e\u52a0\u3002</p> <p>\u5bf9\u4e8e Counter \u65f6\u95f4\u5e8f\u5217\uff0c\u540e\u7aef\u901a\u5e38\u8ba1\u7b97\u589e\u91cf\u5e76\u663e\u793a\u901f\u7387\u503c\uff0c\u4f8b\u5982\uff0c<code>per_min(http.server.requests)</code>\u8fd4\u56de\u6bcf\u5206\u949f\u5904\u7406\u7684\u8bf7\u6c42\u6570\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#counterobserver","title":"CounterObserver","text":"<p><code>asynchronous monotonic</code></p> <p>CounterObserver \u662f <code>Counter instrument</code> \u7684\u5f02\u6b65\u7248\u672c\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#updowncounter","title":"UpDownCounter","text":"<p><code>synchronous additive</code></p> <p><code>UpDownCounter</code> \u662f\u4e00\u79cd\u540c\u6b65 instrument\uff0c\u7528\u4e8e\u6d4b\u91cf\u53ef\u968f\u65f6\u95f4\u589e\u52a0\u6216\u51cf\u5c11\u7684\u9644\u52a0\u503c\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>active requests</li> <li>open connections</li> <li>memory in use (megabytes)</li> </ul> <p>\u5bf9\u4e8e\u52a0\u6cd5\u975e\u9012\u51cf(non-decreasing)\u503c\uff0c\u5e94\u4f7f\u7528 Counter \u6216 CounterObserver\u3002</p> <p>\u5bf9\u4e8e <code>UpDownCounter</code> \u65f6\u95f4\u5e8f\u5217\uff0c\u540e\u7aef\u901a\u5e38\u663e\u793a\u6700\u540e\u4e00\u4e2a\u503c\uff0c\u4f46\u4e0d\u540c\u7684\u65f6\u95f4\u5e8f\u5217\u53ef\u4ee5\u52a0\u5728\u4e00\u8d77\uff0c \u4f8b\u5982\uff0c<code>go.sql.connections_open</code> \u8fd4\u56de\u6253\u5f00\u7684\u8fde\u63a5\u603b\u6570\uff0c <code>go.sql.connections_open{service.name = myservice}</code>\u8fd4\u56de\u4e00\u4e2a\u670d\u52a1\u7684\u6253\u5f00\u8fde\u63a5\u6570\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#updowncounterobserver","title":"UpDownCounterObserver","text":"<p><code>asynchronous additive</code></p> <p>UpDownCounterOserver \u662f UpDownCounter instrument \u7684\u5f02\u6b65\u7248\u672c\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#histogram","title":"Histogram","text":"<p><code>synchronous grouping</code></p> <p>\u76f4\u65b9\u56fe\u662f\u4e00\u79cd\u540c\u6b65 instrument\uff0c\u5b83\u6839\u636e\u8bb0\u5f55\u7684\u503c\u751f\u6210\u76f4\u65b9\u56fe\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>request latency</li> <li>request size</li> </ul> <p>\u76f4\u65b9\u56fe\u7528\u4e8e\u6d4b\u91cf\u503c\u968f\u65f6\u95f4\u7684\u5206\u5e03\u3002\u5bf9\u4e8e\u76f4\u65b9\u56fe\u65f6\u95f4\u5e8f\u5217\uff0c\u540e\u7aef\u901a\u5e38\u663e\u793a\u767e\u5206\u4f4d\u6570\u3001\u70ed\u56fe\u548c\u76f4\u65b9\u56fe\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#gaugeobserver","title":"GaugeObserver","text":"<p><code>asynchronous grouping</code></p> <p>GaugeObserver \u662f\u4e00\u79cd\u5f02\u6b65 instrument\uff0c\u7528\u4e8e\u6d4b\u91cf sum \u4e0d\u80fd\u4ea7\u751f\u6709\u610f\u4e49\u6216\u6b63\u786e\u7ed3\u679c\u7684\u975e\u76f8\u52a0\u503c\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>error rate</li> <li>memory utilization</li> <li>cache hit rate</li> </ul> <p>\u5bf9\u4e8e GaugeObserver \u65f6\u95f4\u5e8f\u5217\uff0c\u540e\u7aef\u901a\u5e38\u663e\u793a\u6700\u540e\u4e00\u4e2a\u503c\uff0c\u4e0d\u5141\u8bb8\u5c06\u4e0d\u540c\u7684\u65f6\u95f4\u5e8f\u5217\u76f8\u52a0\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#metrics","title":"Metrics \u793a\u4f8b","text":"<p>\u90ae\u4ef6\u6570\u91cf</p> <p>\u8981\u6d4b\u91cf\u53d1\u9001\u7684\u7535\u5b50\u90ae\u4ef6\u6570\u91cf\uff0c\u60a8\u53ef\u4ee5\u521b\u5efa Counter instrument\uff0c\u5e76\u5728\u53d1\u9001\u7535\u5b50\u90ae\u4ef6\u65f6\u9012\u589e\uff1a</p> <pre><code>import \"go.opentelemetry.io/otel/metric\"\n\nvar emailCounter = meter.NewInt64Counter(\n    \"some.prefix.emails\",\n    metric.WithDescription(\"Number of sent emails\"),\n)\n\nemailCounter.Add(ctx, 1)\n</code></pre> <p>\u7a0d\u540e\uff0c\u60a8\u53ef\u4ee5\u6dfb\u52a0\u66f4\u591a\u5c5e\u6027\u6765\u6536\u96c6\u8be6\u7ec6\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u4f8b\u5982\uff1a</p> <ul> <li><code>kind = welcome</code> \u548c <code>kind = reset_password</code>\u53ef\u4ee5\u6d4b\u91cf\u4e0d\u540c\u7684\u7535\u5b50\u90ae\u4ef6\u3002</li> <li><code>state = sent</code> \u548c <code>state = bounced</code> \u4ee5\u8861\u91cf\u9000\u56de\u7684\u7535\u5b50\u90ae\u4ef6\u3002</li> </ul>"},{"location":"chap_ot/1OpenTelemetry_intro/#_7","title":"\u64cd\u4f5c\u5ef6\u8fdf","text":"<p>\u8981\u6d4b\u91cf\u64cd\u4f5c\u7684\u5ef6\u8fdf\uff0c\u60a8\u53ef\u4ee5\u521b\u5efa Histogram instrument \u5e76\u4e0e\u64cd\u4f5c\u540c\u6b65\u66f4\u65b0\uff1a</p> <pre><code>import \"go.opentelemetry.io/otel/metric\"\n\nvar opHistogram = meter.NewInt64Histogram(\n    \"some.prefix.duration\",\n    metric.WithDescription(\"Duration of some operation\"),\n)\n\nt1 := time.Now()\nop(ctx)\ndur := time.Since(t1)\n\nopHistogram.Record(ctx, dur.Microseconds())\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_8","title":"\u7f13\u5b58\u547d\u4e2d\u7387","text":"<p>\u8981\u6d4b\u91cf\u7f13\u5b58\u547d\u4e2d\u7387\uff0c\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a CounterObserver \u5e76\u89c2\u5bdf\u7f13\u5b58\u7edf\u8ba1\u4fe1\u606f\uff1a</p> <pre><code>import \"go.opentelemetry.io/otel/metric\"\n\nvar counter metric.Int64CounterObserver\n\n// Arbitrary key/value labels.\nhits := []attribute.KeyValue{attribute.String(\"type\", \"hits\")}\nmisses := []attribute.KeyValue{attribute.String(\"type\", \"misses\")}\nerrors := []attribute.KeyValue{attribute.String(\"type\", \"errors\")}\n\nbatchObserver := meter.NewBatchObserver(\n    func(ctx context.Context, result metric.BatchObserverResult) {\n        stats := cache.Stats()\n\n        result.Observe(hits, counter.Observation(int64(stats.Hits)))\n        result.Observe(misses, counter.Observation(int64(stats.Misses)))\n        result.Observe(errors, counter.Observation(int64(stats.Errors)))\n    })\n\ncounter = batchObserver.NewInt64CounterObserver(\"some.prefix.cache_operations\")\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_9","title":"\u51fa\u9519\u7387","text":"<p>\u8981\u76f4\u63a5\u6d4b\u91cf\u9519\u8bef\u7387\uff0c\u60a8\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a GaugeObserver \u5e76\u89c2\u5bdf\u8be5\u503c\uff0c\u800c\u4e0d\u5fc5\u62c5\u5fc3\u5b83\u662f\u5982\u4f55\u8ba1\u7b97\u7684\uff1a</p> <pre><code>import \"go.opentelemetry.io/otel/metric\"\n\n_ = meter.NewFloat64GaugeObserver(\"some.prefix.error_rate\",\n    func(ctx context.Context, result metric.Float64ObserverResult) {\n        result.Observe(rand.Float64())\n    },\n    metric.WithDescription(\"Error rate as reported by some other system\"),\n)\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry-logs","title":"OpenTelemetry Logs(\u65e5\u5fd7)","text":"<p>OpenTelemetry Logs \u5141\u8bb8\u4ee5\u4e00\u79cd\u80fd\u591f\u4e0e\u5176\u4ed6\u53ef\u89c2\u5bdf\u4fe1\u53f7\u8fdb\u884c\u5173\u8054\u548c\u66f4\u597d\u96c6\u6210\u7684\u65b9\u5f0f\u8bb0\u5f55\u548c\u6536\u96c6\u65e5\u5fd7\u3002</p> <p>\u65e5\u5fd7\u5bf9\u4e8e\u7406\u89e3\u5e94\u7528\u7a0b\u5e8f\u884c\u4e3a\u3001\u8bca\u65ad\u95ee\u9898\u548c\u76d1\u89c6\u7cfb\u7edf\u8fd0\u884c\u72b6\u51b5\u81f3\u5173\u91cd\u8981\u3002</p> <p>\u5206\u5e03\u5f0f\u8ddf\u8e2a\u548c\u6307\u6807\u63d0\u4f9b\u4e86\u5bf9\u7cfb\u7edf\u6027\u80fd\u7684\u6709\u4ef7\u503c\u7684\u89c1\u89e3\uff0c\u800c\u65e5\u5fd7\u63d0\u4f9b\u4e86\u5173\u4e8e\u7279\u5b9a\u4e8b\u4ef6\u3001\u9519\u8bef\u548c\u5e94\u7528\u7a0b\u5e8f\u884c\u4e3a\u7684\u8be6\u7ec6\u4e0a\u4e0b\u6587\u548c\u4fe1\u606f\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_10","title":"\u6982\u8ff0","text":"<p>\u867d\u7136 OpenTelemetry \u4e3b\u8981\u5173\u6ce8\u4e8e\u6536\u96c6\u6307\u6807\u548c\u8ddf\u8e2a\uff0c\u4f46\u5b83\u4e5f\u901a\u8fc7\u5176\u65e5\u5fd7 API \u652f\u6301\u65e5\u5fd7\u6536\u96c6\u3002OpenTelemetry \u652f\u6301\u73b0\u6709\u7684\u65e5\u5fd7\u89e3\u51b3\u65b9\u6848\uff0c\u5e76\u786e\u4fdd\u5b83\u53ef\u4ee5\u4e0e\u73b0\u6709\u7684\u65e5\u5fd7\u5e93\u548c\u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u4e00\u8d77\u5f88\u597d\u5730\u5de5\u4f5c\u3002</p> <p>OpenTelemetry \u63d0\u4f9b\u4e86\u4e00\u4e2a\u65e5\u5fd7 API\uff0c\u5141\u8bb8\u60a8\u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\u5e76\u751f\u6210\u7ed3\u6784\u5316\u65e5\u5fd7\u3002OpenTelemetry Logging API \u65e8\u5728\u4e0e\u5176\u4ed6\u9065\u6d4b\u6570\u636e(\u5982\u6307\u6807\u548c\u8ddf\u8e2a)\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u63d0\u4f9b\u7edf\u4e00\u7684\u53ef\u89c2\u6d4b\u6027\u89e3\u51b3\u65b9\u6848\u3002</p> <p>OpenTelemetry \u5f3a\u8c03\u7ed3\u6784\u5316\u7684\u65e5\u5fd7\uff0c\u5141\u8bb8\u60a8\u901a\u8fc7\u5c5e\u6027\u6216\u5143\u6570\u636e\u5411\u65e5\u5fd7\u6761\u76ee\u9644\u52a0\u989d\u5916\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002</p> <p>\u8fd9\u5141\u8bb8\u60a8\u5305\u542b\u76f8\u5173\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u4f8b\u5982 timestamps, request IDs, user IDs, correlation IDs \u548c\u5176\u4ed6\u6709\u52a9\u4e8e\u65e5\u5fd7\u5206\u6790\u548c\u6545\u969c\u6392\u9664\u7684\u81ea\u5b9a\u4e49\u4e0a\u4e0b\u6587\u3002</p> <p></p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_11","title":"\u4e0d\u540c\u7c7b\u578b\u7684\u65e5\u5fd7","text":"<p>OpenTelemetry \u652f\u6301\u4ece\u5e94\u7528\u7a0b\u5e8f\u6216\u7cfb\u7edf\u4e2d\u7684\u5404\u79cd\u6e90\u6355\u83b7\u65e5\u5fd7\u3002\u6839\u636e\u65e5\u5fd7\u7684\u751f\u6210\u548c\u6536\u96c6\u65b9\u5f0f\uff0c\u65e5\u5fd7\u53ef\u4ee5\u5206\u4e3a 3 \u7c7b\u3002</p> <ul> <li>\u7cfb\u7edf\u548c\u57fa\u7840\u8bbe\u65bd\u65e5\u5fd7</li> </ul> <p>\u7cfb\u7edf\u65e5\u5fd7\u63d0\u4f9b\u6709\u5173\u7cfb\u7edf\u64cd\u4f5c\u3001\u6027\u80fd\u548c\u5b89\u5168\u6027\u7684\u5b9d\u8d35\u4fe1\u606f\u3002\u7cfb\u7edf\u65e5\u5fd7\u901a\u5e38\u7531\u7cfb\u7edf\u5185\u7684\u5404\u79cd\u7ec4\u4ef6\u751f\u6210\uff0c\u5305\u62ec\u64cd\u4f5c\u7cfb\u7edf\u3001\u5e94\u7528\u7a0b\u5e8f\u3001\u7f51\u7edc\u8bbe\u5907\u548c\u670d\u52a1\u5668\u3002</p> <p>\u7cfb\u7edf\u65e5\u5fd7\u662f\u5728\u4e3b\u673a\u7ea7\u522b\u7f16\u5199\u7684\uff0c\u5177\u6709\u65e0\u6cd5\u8f7b\u6613\u66f4\u6539\u7684\u9884\u5b9a\u4e49\u683c\u5f0f\u548c\u5185\u5bb9\u3002\u7cfb\u7edf\u65e5\u5fd7\u4e0d\u5305\u62ec\u6709\u5173\u8ddf\u8e2a\u4e0a\u4e0b\u6587\u7684\u4fe1\u606f\u3002</p> <ul> <li>Legacy first-party \u65e5\u5fd7</li> </ul> <p>First-party \u65e5\u5fd7\u7531\u5185\u90e8\u5e94\u7528\u7a0b\u5e8f\u751f\u6210\uff0c\u8bb0\u5f55\u7279\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u4e8b\u4ef6\u3001\u9519\u8bef\u548c\u7528\u6237\u6d3b\u52a8\u3002\u8fd9\u4e9b\u65e5\u5fd7\u5bf9\u4e8e\u5e94\u7528\u7a0b\u5e8f\u8c03\u8bd5\u548c\u6545\u969c\u6392\u9664\u975e\u5e38\u6709\u7528\u3002</p> <p>\u901a\u5e38\uff0c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u4fee\u6539\u8fd9\u4e9b\u5e94\u7528\u7a0b\u5e8f\uff0c\u4ee5\u66f4\u6539\u65e5\u5fd7\u7684\u7f16\u5199\u65b9\u5f0f\u548c\u5305\u542b\u7684\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u4e3a\u4e86\u5c06\u65e5\u5fd7\u4e0e\u8ddf\u8e2a\u5173\u8054\u8d77\u6765\uff0c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u624b\u52a8\u5c06\u8ddf\u8e2a\u4e0a\u4e0b\u6587\u6dfb\u52a0\u5230\u6bcf\u4e2a\u65e5\u5fd7\u8bed\u53e5\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u65e5\u5fd7\u5e93\u7684\u63d2\u4ef6\u81ea\u52a8\u6dfb\u52a0\u3002</p> <p>\u4f8b\u5982\uff0c\u8981\u4f20\u64ad\u4e0a\u4e0b\u6587\u5e76\u5c06\u65e5\u5fd7\u8bb0\u5f55\u4e0e span \u76f8\u5173\u8054\uff0c\u53ef\u4ee5\u5728\u65e5\u5fd7\u6d88\u606f\u4e2d\u4f7f\u7528\u4ee5\u4e0b\u5c5e\u6027\uff1a</p> <ul> <li><code>trace_id</code> \u7528\u4e8e TraceId, \u5341\u516d\u8fdb\u5236\u7f16\u7801\u3002</li> <li><code>span_id</code> \u7528\u4e8e SpanId, \u5341\u516d\u8fdb\u5236\u7f16\u7801\u3002</li> <li><code>trace_flags</code> \u7528\u4e8e trace flags, \u6839\u636e W3C traceflags \u683c\u5f0f\u8fdb\u884c\u683c\u5f0f\u5316\u3002</li> </ul> <p>\u4f8b\u5982\uff1a</p> <pre><code>request failed trace_id=958180131ddde684c1dbda1aeacf51d3 span_id=0cf859e4f7510204\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#new-first-party","title":"New first-party \u65e5\u5fd7","text":"<p>\u542f\u52a8\u65b0\u9879\u76ee\u65f6\uff0c\u60a8\u53ef\u4ee5\u9075\u5faa OpenTelemetry \u7684\u5efa\u8bae\u548c\u6700\u4f73\u5b9e\u8df5\uff0c \u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u81ea\u52a8\u68c0\u6d4b\u53d1\u51fa\u65e5\u5fd7\uff0c\u6216\u5c06\u65e5\u5fd7\u5e93\u914d\u7f6e\u4e3a\u4f7f\u7528 OpenTelemetry log \u9644\u52a0\u7a0b\u5e8f\u3002</p> <p>OpenTelemetry \u7684\u65e5\u5fd7 API \u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u5bf9\u5176\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c instrument\uff0c \u4ee5\u751f\u6210\u7ed3\u6784\u5316\u65e5\u5fd7\uff0c\u8fd9\u4e9b\u65e5\u5fd7\u53ef\u4ee5\u7531\u65e5\u5fd7\u540e\u53f0\u6216\u65e5\u5fd7\u7ba1\u7406\u7cfb\u7edf\u6536\u96c6\u548c\u5904\u7406\u3002</p> <p>\u65e5\u5fd7 API \u63d0\u4f9b\u4e86\u4e00\u79cd\u5c06\u9644\u52a0\u4e0a\u4e0b\u6587\u4fe1\u606f\u9644\u52a0\u5230\u65e5\u5fd7\u6761\u76ee\uff08\u5982\u6807\u7b7e\u3001\u5c5e\u6027\u6216\u5143\u6570\u636e\uff09\u7684\u65b9\u6cd5\u3002</p> <p>\u4f7f\u7528 Logger API \u8bb0\u5f55\u4e0d\u540c\u4e25\u91cd\u6027\u7ea7\u522b\u7684\u4e8b\u4ef6\u6216\u6d88\u606f\uff0c\u5982 debug\u3001info\u3001warn\u3001error \u7b49\u3002\u60a8\u8fd8\u53ef\u4ee5\u5c06\u5176\u4ed6\u5c5e\u6027\u6216\u4e0a\u4e0b\u6587\u9644\u52a0\u5230\u65e5\u5fd7\u6761\u76ee\u4ee5\u63d0\u4f9b\u66f4\u591a\u4fe1\u606f\u3002</p> <p>OpenTelemetry \u8fd8\u63d0\u4f9b\u4e86\u4e00\u79cd\u6807\u51c6\u5316\u7684\u65b9\u6cd5\uff0c\u7528\u4e8e\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u4f20\u64ad\u65e5\u5fd7\u4e2d\u7684\u4e0a\u4e0b\u6587\u3002\u8fd9\u786e\u4fdd\u4e86\u76f8\u5173\u7684\u6267\u884c\u4e0a\u4e0b\u6587\u88ab\u4e00\u81f4\u5730\u6355\u83b7\u548c\u4fdd\u5b58\uff0c\u5373\u4f7f\u65e5\u5fd7\u662f\u7531\u7cfb\u7edf\u7684\u4e0d\u540c\u7ec4\u4ef6\u751f\u6210\u7684\u3002</p> <p>OpenTelemetry Logs \u6570\u636e\u6a21\u578b\u5141\u8bb8\u5c06 TraceId \u548c SpanId \u76f4\u63a5\u5305\u542b\u5728 LogRecords \u4e2d\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry_5","title":"OpenTelemetry \u6536\u96c6\u5668","text":"<p>OpenTelemetry Collector \u662f\u4e00\u4e2a\u7075\u6d3b\u4e14\u53ef\u6269\u5c55\u7684\u4ee3\u7406\uff0c\u7528\u4e8e\u6536\u96c6\u3001\u5904\u7406\u548c\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\u3002\u5b83\u7b80\u5316\u4e86\u4ece\u591a\u4e2a\u6e90\u63a5\u6536\u548c\u7ba1\u7406\u9065\u6d4b\u6570\u636e\u7684\u4efb\u52a1\uff0c\u5e76\u80fd\u591f\u5c06\u6570\u636e\u5bfc\u51fa\u5230\u591a\u4e2a\u540e\u7aef\u6216\u53ef\u89c2\u6d4b\u6027\u7cfb\u7edf\u3002</p> <p>OpenTelemetry Collector \u652f\u6301\u591a\u4e2a\u65e5\u5fd7\u6e90\uff0c\u5305\u62ec\u5e94\u7528\u7a0b\u5e8f\u65e5\u5fd7\u3001\u65e5\u5fd7\u6587\u4ef6\u3001\u65e5\u5fd7\u5e93\u548c\u7b2c\u4e09\u65b9\u65e5\u5fd7\u7cfb\u7edf\u3002\u5b83\u63d0\u4f9b\u4e86\u4e0e\u6d41\u884c\u7684\u65e5\u5fd7\u6846\u67b6\u548c\u5e93\u7684\u96c6\u6210\uff0c\u5b9e\u73b0\u4e86\u65e5\u5fd7\u6570\u636e\u7684\u65e0\u7f1d\u63a5\u6536\u3002</p> <p>\u6536\u96c6\u5668\u63d0\u4f9b\u4e86\u8f6c\u6362\u548c\u4e30\u5bcc\u65e5\u5fd7\u6570\u636e\u7684\u529f\u80fd\u3002\u60a8\u53ef\u4ee5\u4fee\u6539\u65e5\u5fd7\u5c5e\u6027\u3001\u6dfb\u52a0\u5143\u6570\u636e\u6216\u4f7f\u7528\u5176\u4ed6\u4e0a\u4e0b\u6587\u4fe1\u606f\u4e30\u5bcc\u65e5\u5fd7\uff0c\u4ee5\u589e\u5f3a\u5176\u4ef7\u503c\uff0c\u5e76\u4f7f\u5176\u5bf9\u5206\u6790\u548c\u6545\u969c\u6392\u9664\u66f4\u6709\u610f\u4e49\u3002</p> <p>\u6536\u96c6\u548c\u5904\u7406\u540e\uff0cOpenTelemetry Collector \u53ef\u4ee5\u5c06\u65e5\u5fd7\u6570\u636e\u5bfc\u51fa\u5230\u5404\u79cd\u65e5\u5fd7\u540e\u7aef\u6216\u7cfb\u7edf\u3002\u5b83\u652f\u6301\u5c06\u65e5\u5fd7\u5bfc\u51fa\u5230\u6d41\u884c\u7684\u65e5\u5fd7\u8bb0\u5f55\u5e73\u53f0\u3001\u5b58\u50a8\u7cfb\u7edf\u6216\u65e5\u5fd7\u7ba1\u7406\u5de5\u5177\uff0c\u4ee5\u8fdb\u884c\u957f\u671f\u5b58\u50a8\u3001\u5206\u6790\u548c\u53ef\u89c6\u5316\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry_6","title":"OpenTelemetry \u540e\u7aef","text":"<p>\u4e00\u65e6\u65e5\u5fd7\u6570\u636e\u5bfc\u51fa\u5230\u65e5\u5fd7\u540e\u7aef\uff0c\u60a8\u5c31\u53ef\u4ee5\u4f7f\u7528\u5e73\u53f0\u7684\u529f\u80fd\u5904\u7406\u548c\u5206\u6790\u65e5\u5fd7\u3002\u8fd9\u53ef\u4ee5\u5305\u62ec\u8fc7\u6ee4\u3001\u641c\u7d22\u3001\u805a\u5408\u548c\u53ef\u89c6\u5316\u65e5\u5fd7\uff0c\u4ee5\u6df1\u5165\u4e86\u89e3\u5e94\u7528\u7a0b\u5e8f\u7684\u884c\u4e3a\u5e76\u89e3\u51b3\u95ee\u9898\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry-sampling","title":"OpenTelemetry Sampling(\u91c7\u6837)","text":"<p>OpenTelemetry \u91c7\u6837\u901a\u8fc7\u51cf\u5c11\u521b\u5efa\uff08\u91c7\u6837\uff09span \u7684\u6570\u91cf\uff0c\u964d\u4f4e\u4e86\u8ddf\u8e2a\u7684\u6210\u672c\u548c\u5197\u957f\u7a0b\u5ea6\u3002</p> <p>\u5c31\u6027\u80fd\u800c\u8a00\uff0c\u91c7\u6837\u53ef\u4ee5\u8282\u7701\u6536\u96c6\u3001\u5904\u7406\u548c\u5bfc\u51fa span \u6240\u9700\u7684 CPU \u5468\u671f\u548c\u5185\u5b58\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_12","title":"\u4ec0\u4e48\u662f\u91c7\u6837\uff1f","text":"<p>\u5728\u5206\u5e03\u5f0f\u8ffd\u8e2a\u4e2d\u4f7f\u7528\u91c7\u6837\u6765\u63a7\u5236\u6536\u96c6\u5e76\u53d1\u9001\u5230\u8ddf\u8e2a\u540e\u7aef\u7684\u6570\u636e\u91cf\u3002\u5b83\u6709\u52a9\u4e8e\u5e73\u8861\u6570\u636e\u91cf\u548c\u8ddf\u8e2a\u7cbe\u5ea6\u4e4b\u95f4\u7684\u6743\u8861\u3002</p> <p>\u5728\u5206\u5e03\u5f0f\u8ddf\u8e2a\u4e2d\uff0c\u8bf7\u6c42\u5728\u6d41\u7ecf\u7cfb\u7edf\u65f6\u751f\u6210 span\u3002span \u8868\u793a\u5728\u5904\u7406\u8be5\u8bf7\u6c42\u671f\u95f4\u53d1\u751f\u7684\u5355\u4e2a\u64cd\u4f5c\u6216\u4e8b\u4ef6\u3002\u5728\u4e00\u4e2a\u590d\u6742\u7684\u7cfb\u7edf\u4e2d\uff0c\u8fd9\u4e9b span \u53ef\u80fd\u4f1a\u53d8\u5f97\u975e\u5e38\u591a\uff0c\u5e76\u4e14\u5c06\u5b83\u4eec\u5168\u90e8\u53d1\u9001\u5230\u8ddf\u8e2a\u540e\u7aef\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5927\u91cf\u7684\u5f00\u9500\u548c\u5b58\u50a8\u6210\u672c\u3002</p> <p>\u62bd\u6837\u6d89\u53ca\u5230\u51b3\u5b9a\u54ea\u4e9b\u65f6\u95f4\u6bb5\u8981\u8bb0\u5f55\uff0c\u54ea\u4e9b\u65f6\u95f4\u6bb5\u8981\u4e22\u5f03\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_13","title":"\u91c7\u6837\uff1a\u4f55\u65f6\u4f55\u5730","text":"<p>\u91c7\u6837\u53ef\u80fd\u53d1\u751f\u5728 span \u5904\u7406\u7684\u4e0d\u540c\u9636\u6bb5\uff1a</p> <ul> <li>\u521b\u5efa trace \u65f6 - \u5934\u90e8\u91c7\u6837\uff1b</li> <li>\u5f53\u540e\u7aef\u63a5\u6536\u5230 trace \u65f6 - \u901f\u7387\u9650\u5236\u91c7\u6837\uff1b</li> <li>\u5f53\u5b8c\u6574\u7684 trace \u53ef\u7528\u65f6 - \u57fa\u4e8e\u5c3e\u90e8\u7684\u91c7\u6837\uff1b</li> </ul> <p>\u62bd\u6837\u7b56\u7565\u7684\u9009\u62e9\u53d6\u51b3\u4e8e\u51e0\u4e2a\u56e0\u7d20\uff0c\u5305\u62ec\u671f\u671b\u7684\u53ef\u89c2\u6d4b\u6027\u6c34\u5e73\u3001\u53ef\u7528\u8d44\u6e90\u548c\u7cfb\u7edf\u7684\u7279\u5b9a\u7528\u4f8b\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_14","title":"\u6982\u7387\u62bd\u6837","text":"<p>\u62bd\u6837\u63d0\u4f9b\u4e86\u4e00\u79cd\u62bd\u6837\u6982\u7387\uff0c\u4f7f\u5f97\u4ec5\u4f7f\u7528\u90e8\u5206\u62bd\u6837 span \u5c31\u80fd\u5bf9\u6240\u6709 span \u8fdb\u884c\u51c6\u786e\u7684\u7edf\u8ba1\u8ba1\u6570\u3002\u4f8b\u5982\uff0c\u5982\u679c\u91c7\u6837\u6982\u7387\u4e3a 50%\uff0c\u91c7\u6837\u7684 span \u6570\u4e3a 10\uff0c\u5219\u8c03\u6574\u540e\u7684(\u603b) span \u6570\u4e3a 10 / 50% = 20\u3002</p> <pre><code>Name            Side         Adjusted count   Accuracy\n\u57fa\u4e8e\u5934\u90e8\u7684\u91c7\u6837 Client-side     Yes  100%\n\u901f\u7387\u9650\u5236\u91c7\u6837      Server-side Yes   &lt;90%\n\u57fa\u4e8e\u5c3e\u90e8\u91c7\u6837      Server-side   Yes     &lt;90%\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_15","title":"\u57fa\u4e8e\u5934\u90e8\u7684\u91c7\u6837","text":"<p>\u57fa\u4e8e\u5934\u90e8\u7684\u62bd\u6837\u5c3d\u53ef\u80fd\u65e9\u5730\u505a\u51fa\u62bd\u6837\u51b3\u7b56\uff0c\u5e76\u4f7f\u7528 context \u5c06\u5176\u4f20\u64ad\u7ed9\u5176\u4ed6\u53c2\u4e0e\u8005\u3002\u8fd9\u5141\u8bb8\u901a\u8fc7\u4e0d\u6536\u96c6\u4efb\u4f55\u7528\u4e8e\u5220\u9664 span (\u64cd\u4f5c)\u7684\u9065\u6d4b\u6570\u636e\u6765\u8282\u7701 CPU \u548c\u5185\u5b58\u8d44\u6e90\u3002</p> <p>\u57fa\u4e8e\u5934\u90e8\u7684\u91c7\u6837\u662f\u6700\u7b80\u5355\u3001\u6700\u51c6\u786e\u3001\u6700\u53ef\u9760\u7684\u91c7\u6837\u65b9\u6cd5\uff0c\u4e0e\u6240\u6709\u5176\u4ed6\u65b9\u6cd5\u76f8\u6bd4\uff0c\u60a8\u5e94\u8be5\u66f4\u559c\u6b22\u8fd9\u79cd\u65b9\u6cd5\u3002</p> <p>\u57fa\u4e8e\u5934\u7684\u91c7\u6837\u7684\u4e00\u4e2a\u7f3a\u70b9\u662f\uff0c\u4e0d\u80fd\u5bf9\u6709\u9519\u8bef\u7684 span \u8fdb\u884c\u91c7\u6837\uff0c\u56e0\u4e3a\u521b\u5efa span \u65f6\u8be5\u4fe1\u606f\u4e0d\u53ef\u7528\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u4f7f\u7528\u57fa\u4e8e\u5c3e\u90e8\u7684\u91c7\u6837\u3002</p> <p>\u57fa\u4e8e\u5934\u90e8\u7684\u91c7\u6837\u4e5f\u4e0d\u8003\u8651\u6d41\u91cf\u5cf0\u503c\uff0c\u5e76\u4e14\u53ef\u80fd\u6536\u96c6\u6bd4\u671f\u671b\u7684\u66f4\u591a\u7684\u6570\u636e\u3002\u8fd9\u5c31\u662f rate-limiting \u91c7\u6837\u53d8\u5f97\u65b9\u4fbf\u7684\u5730\u65b9\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry_7","title":"OpenTelemetry \u4e2d\u57fa\u4e8e\u5934\u7684\u91c7\u6837","text":"<p>OpenTelemetry \u6709 2 \u4e2a span \u5c5e\u6027\u8d1f\u8d23\u5ba2\u6237\u7aef\u91c7\u6837\uff1a</p> <ul> <li>IsRecording - \u5f53\u4e3a false \u65f6\uff0cspan \u5c06\u4e22\u5f03\u5c5e\u6027\u3001\u4e8b\u4ef6\u3001\u94fe\u63a5\u7b49\u3002</li> <li>Sampled - \u5f53\u4e3a false \u65f6\uff0cOpenTelemetry \u5220\u9664 span\u3002</li> </ul> <p>\u60a8\u5e94\u8be5\u68c0\u67e5 IsRecording \u5c5e\u6027\uff0c\u4ee5\u907f\u514d\u6536\u96c6\u6602\u8d35\u7684\u9065\u6d4b\u6570\u636e\u3002</p> <pre><code>if span.IsRecording() {\n    // collect expensive data\n}\n</code></pre> <p>Sampler \u662f\u4e00\u4e2a\u63a5\u53d7\u5c06\u8981\u521b\u5efa\u7684 root span \u7684\u51fd\u6570\u3002\u8be5\u51fd\u6570\u8fd4\u56de\u4e00\u4e2a\u91c7\u6837\u51b3\u7b56\uff0c\u8be5\u51b3\u7b56\u5fc5\u987b\u662f:</p> <ul> <li>Drop - trace \u88ab\u4e22\u5f03\u3002IsRecording = false, Sampled = false\u3002</li> <li>RecordOnly - \u8bb0\u5f55 trace\uff0c\u4f46\u4e0d\u91c7\u6837\u3002IsRecording = true, Sampled = false\u3002</li> <li>RecordAndSample - \u8bb0\u5f55\u5e76\u91c7\u6837 trace\u3002IsRecording = true, Sampled = true\u3002</li> </ul> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cOpenTelemetry \u5bf9\u6240\u6709\u8ddf\u8e2a\u8fdb\u884c\u91c7\u6837\uff0c\u4f46\u60a8\u53ef\u4ee5\u5c06\u5176\u914d\u7f6e\u4e3a\u5bf9\u90e8\u5206\u8ddf\u8e2a\u8fdb\u884c\u91c7\u6837\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u540e\u7aef\u4f7f\u7528\u6982\u7387\u62bd\u6837\u6765\u8c03\u6574 span \u7684\u6570\u91cf\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry_8","title":"OpenTelemetry \u91c7\u6837\u5668","text":"<p>AlwaysOn sampler \u5bf9\u6bcf\u4e2a trace \u8fdb\u884c\u91c7\u6837\uff0c\u4f8b\u5982\uff0c\u5c06\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u542f\u52a8\u5e76\u5bfc\u51fa\u4e00\u4e2a\u65b0\u7684 trace\u3002</p> <p>AlwaysOff sampler \u4e0d\u91c7\u6837 trace\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u5220\u9664\u6240\u6709 trace\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u91c7\u6837\u5668\u6267\u884c\u8d1f\u8f7d\u6d4b\u8bd5\u6216\u6682\u65f6\u7981\u7528 trace\u3002</p> <p>TraceIDRatioBased sampler \u4f7f\u7528 trace id \u5bf9\u8ddf\u8e2a\u7684\u4e00\u5c0f\u90e8\u5206\u8fdb\u884c\u91c7\u6837\uff0c\u4f8b\u5982\uff0c20% \u7684\u8ddf\u8e2a\u3002</p> <p>Parent-based sampler \u662f\u4e00\u79cd\u590d\u5408\u91c7\u6837\u5668\uff0c\u5b83\u6839\u636e span \u7684\u7236\u5143\u7d20\u8868\u73b0\u51fa\u4e0d\u540c\u7684\u884c\u4e3a\u3002\u5f53\u60a8\u5f00\u59cb\u4e00\u4e2a\u65b0\u7684 trace \u65f6\uff0c\u91c7\u6837\u5668\u5c06\u51b3\u5b9a\u662f\u5426\u5bf9\u5176\u8fdb\u884c\u91c7\u6837\uff0c\u5e76\u5c06\u8be5\u51b3\u7b56\u5411\u4e0b\u4f20\u64ad\u5230\u5176\u4ed6\u670d\u52a1\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_16","title":"\u901f\u7387\u9650\u5236\u91c7\u6837","text":"<p>\u901f\u7387\u9650\u5236\u91c7\u6837\u53d1\u751f\u5728\u670d\u52a1\u5668\u7aef\uff0c\u5e76\u786e\u4fdd\u60a8\u4e0d\u4f1a\u8d85\u8fc7\u67d0\u4e9b\u9650\u5236\uff0c\u4f8b\u5982\uff0c\u5b83\u5141\u8bb8\u6bcf\u79d2\u91c7\u6837 10 \u4e2a\u6216\u66f4\u5c11\u7684\u8ddf\u8e2a\u3002</p> <p>\u9650\u901f\u91c7\u6837\u652f\u6301\u8c03\u6574\u8ba1\u6570\uff0c\u4f46\u7cbe\u5ea6\u8f83\u4f4e\u3002\u4e3a\u4e86\u83b7\u5f97\u66f4\u597d\u7684\u7ed3\u679c\u5e76\u63d0\u9ad8\u6027\u80fd\uff0c\u60a8\u5e94\u8be5\u5c06\u9650\u901f\u91c7\u6837\u4e0e\u66f4\u6709\u6548\u548c\u51c6\u786e\u7684\u57fa\u4e8e\u5934\u90e8\u7684\u91c7\u6837\u4e00\u8d77\u4f7f\u7528\u3002</p> <p>\u5927\u591a\u6570\u540e\u7aef\u5728\u5fc5\u8981\u65f6\u81ea\u52a8\u5e94\u7528\u9650\u901f\u91c7\u6837\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_17","title":"\u57fa\u4e8e\u5c3e\u90e8\u91c7\u6837","text":"<p>\u5728\u57fa\u4e8e\u5934\u90e8\u7684\u91c7\u6837\u7684\u62bd\u6837\u4e2d\uff0c\u62bd\u6837\u51b3\u7b56\u662f\u9884\u5148\u505a\u51fa\u7684\uff0c\u901a\u5e38\u662f\u968f\u673a\u7684\u3002\u57fa\u4e8e\u5934\u90e8\u7684\u91c7\u6837\u4e0d\u80fd\u5bf9\u5931\u8d25\u6216\u5f02\u5e38\u957f\u65f6\u95f4\u7684\u64cd\u4f5c\u8fdb\u884c\u91c7\u6837\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u4fe1\u606f\u53ea\u80fd\u5728\u8ddf\u8e2a\u7ed3\u675f\u65f6\u83b7\u5f97\u3002</p> <p>\u4f7f\u7528\u57fa\u4e8e\u5c3e\u90e8\u7684\u91c7\u6837\uff0c\u6211\u4eec\u5ef6\u8fdf\u91c7\u6837\u51b3\u7b56\uff0c\u76f4\u5230\u8ddf\u8e2a\u7684\u6240\u6709 span \u53ef\u7528\uff0c\u8fd9\u4f7f\u5f97\u57fa\u4e8e\u6765\u81ea\u8ddf\u8e2a\u7684\u6240\u6709\u6570\u636e\u7684\u66f4\u597d\u7684\u91c7\u6837\u51b3\u7b56\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u5931\u8d25\u6216\u5f02\u5e38\u957f\u7684\u8ddf\u8e2a\u8fdb\u884c\u91c7\u6837\u3002</p> <p>\u5927\u591a\u6570 OpenTelemetry \u540e\u7aef\u5728\u5fc5\u8981\u65f6\u81ea\u52a8\u5e94\u7528\u57fa\u4e8e\u5c3e\u90e8\u7684\u91c7\u6837\uff0c\u4f46\u662f\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 OpenTelemetry Collector \u548c tailsamplingprocessor \u6765\u6839\u636e\u4f60\u7684\u9700\u8981\u914d\u7f6e\u91c7\u6837\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_18","title":"\u57fa\u4e8e\u6982\u7387\u7684\u91c7\u6837","text":"<p>\u57fa\u4e8e\u6982\u7387\u7684\u91c7\u6837\u6839\u636e\u914d\u7f6e\u7684\u6982\u7387\u6216\u91c7\u6837\u7387\u968f\u673a\u9009\u62e9\u8981\u8bb0\u5f55\u7684\u8ddf\u8e2a\u7684\u5b50\u96c6\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u8bbe\u7f6e\u91c7\u6837\u7387\u4e3a 10%\uff0c\u8fd9\u610f\u5473\u7740\u53ea\u8bb0\u5f55 10% \u7684\u8ff9\u7ebf\uff0c\u5176\u4f59\u7684\u8ff9\u7ebf\u88ab\u4e22\u5f03\u3002</p> <p>\u5f53\u60a8\u5e0c\u671b\u51cf\u5c11\u8ddf\u8e2a\u6570\u636e\u7684\u6570\u91cf\uff0c\u540c\u65f6\u4ecd\u7136\u4fdd\u6301\u7cfb\u7edf\u884c\u4e3a\u7684\u4ee3\u8868\u6027\u6837\u672c\u65f6\uff0c\u57fa\u4e8e\u6982\u7387\u7684\u91c7\u6837\u975e\u5e38\u6709\u7528\u3002\u5b83\u6709\u52a9\u4e8e\u5728\u5f00\u9500\u548c\u6240\u9700\u7684\u53ef\u89c2\u6d4b\u6027\u7ea7\u522b\u4e4b\u95f4\u53d6\u5f97\u5e73\u8861\u3002</p> <p>\u4ee5\u4e0b\u662f\u5982\u4f55\u5728 OpenTelemetry Go \u4e2d\u914d\u7f6e\u57fa\u4e8e\u6982\u7387\u7684\u91c7\u6837\u5668\uff0c\u57fa\u4e8e Uptrace\u3002</p> <pre><code>import \"go.opentelemetry.io/contrib/samplers/probability/consistent\"\n\nsampler := consistent.ParentProbabilityBased(\n    consistent.ProbabilityBased(0.5), // sample 50% of traces\n)\n\nuptrace.ConfigureOpentelemetry(\n    uptrace.WithTraceSampler(sampler),\n\n    // Other options\n)\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry-collector_1","title":"OpenTelemetry Collector(\u6536\u96c6\u5668)","text":"<p>OpenTelemetry Collector \u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u3001\u53ef\u6269\u5c55\u548c\u53ef\u9760\u7684\u6570\u636e\u6536\u96c6\u7ba1\u9053\uff0c\u7528\u4e8e\u53ef\u89c2\u5bdf\u6027\u6570\u636e\u3002\u5b83\u4ece\u5404\u79cd\u6765\u6e90\u63a5\u6536\u9065\u6d4b\u6570\u636e\uff0c\u6267\u884c\u5904\u7406\u548c\u8f6c\u6362\u4e3a\u901a\u7528\u683c\u5f0f\uff0c\u7136\u540e\u5c06\u6570\u636e\u5bfc\u51fa\u5230\u5404\u79cd\u540e\u7aef\u8fdb\u884c\u5b58\u50a8\u548c\u5206\u6790\u3002</p> <p>Otel Collector \u652f\u6301\u591a\u79cd\u6570\u636e\u683c\u5f0f\u3001\u534f\u8bae\u548c\u5e73\u53f0\uff0c\u4f7f\u5176\u6210\u4e3a\u53ef\u89c2\u5bdf\u6027\u9700\u6c42\u7684\u7075\u6d3b\u3001\u53ef\u6269\u5c55\u7684\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry-collector_2","title":"OpenTelemetry Collector \u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff1f","text":"<p>OpenTelemetry Collector \u662f\u5e94\u7528\u7a0b\u5e8f\u548c\u5206\u5e03\u5f0f\u8ddf\u8e2a\u5de5\u5177(\u5982 SigNoz/Jaeger)\u4e4b\u95f4\u4e0e\u4f9b\u5e94\u5546\u65e0\u5173\u7684\u4ee3\u7406/\u4e2d\u95f4\u4eba\u3002</p> <p>OpenTelemetry Collector \u7684\u5de5\u4f5c\u539f\u7406\u662f\u63a5\u6536\u6765\u81ea\u5404\u79cd\u6765\u6e90\u7684\u9065\u6d4b\u6570\u636e\uff0c \u5bf9\u6570\u636e\u8fdb\u884c\u5904\u7406\u548c\u89c4\u8303\u5316\uff0c\u7136\u540e\u5c06\u5176\u5bfc\u51fa\u5230\u5404\u79cd\u540e\u7aef\u8fdb\u884c\u5b58\u50a8\u548c\u5206\u6790\u3002</p> <p></p> <p>Otel Collector \u63d0\u4f9b\u5f3a\u5927\u7684\u6570\u636e\u5904\u7406\u80fd\u529b\uff0c\u5141\u8bb8\u60a8\u6267\u884c\u805a\u5408\uff0c\u8fc7\u6ee4\uff0c\u91c7\u6837\u548c\u4e30\u5bcc\u7684\u9065\u6d4b\u6570\u636e\u3002\u5728\u5c06\u6570\u636e\u53d1\u9001\u5230\u540e\u7aef\u7cfb\u7edf\u4e4b\u524d\uff0c\u60a8\u53ef\u4ee5\u8f6c\u6362\u548c\u91cd\u5851\u6570\u636e\u4ee5\u6ee1\u8db3\u7279\u5b9a\u7684\u76d1\u89c6\u548c\u5206\u6790\u9700\u6c42\u3002</p> <p>Otel Collector \u662f\u7528 Go \u8bed\u8a00\u7f16\u5199\u7684\uff0c\u4f7f\u7528 Apache 2.0 license \uff0c\u5141\u8bb8\u60a8\u66f4\u6539\u6e90\u4ee3\u7801\u5e76\u5b89\u88c5\u81ea\u5b9a\u4e49\u6269\u5c55\u3002\u8fd9\u662f\u4ee5\u8fd0\u884c\u548c\u7ef4\u62a4\u60a8\u81ea\u5df1\u7684 OpenTelemetry Collector \u5b9e\u4f8b\u4e3a\u4ee3\u4ef7\u7684\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry-collector_3","title":"\u4f55\u65f6\u4f7f\u7528 OpenTelemetry Collector?","text":"<p>\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u5c06\u9065\u6d4b\u6570\u636e\u76f4\u63a5\u53d1\u9001\u5230\u540e\u7aef\u662f\u5f00\u59cb\u4f7f\u7528 OpenTelemetry \u7684\u597d\u65b9\u6cd5\u3002\u4f46\u662f\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u5728\u670d\u52a1\u65c1\u8fb9\u90e8\u7f72\u6536\u96c6\u5668\uff0c\u4ee5\u83b7\u5f97\u6279\u5904\u7406\u3001\u91cd\u8bd5\u3001\u654f\u611f\u6570\u636e\u8fc7\u6ee4\u7b49\u529f\u80fd\u3002</p> <p>OpenTelemetry Collector \u6700\u7a81\u51fa\u7684\u7279\u6027\u662f\u80fd\u591f\u64cd\u4f5c\u6574\u4e2a\u8f68\u8ff9\uff0c\u800c\u4e0d\u662f\u5355\u4e2a span\u3002\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e00\u70b9\uff0cOpenTelemetry Collector \u7f13\u51b2\u63a5\u6536\u5230\u7684 span\uff0c\u5e76\u6309 trace id \u5bf9\u5b83\u4eec\u8fdb\u884c\u5206\u7ec4\u3002\u8fd9\u662f\u5b9e\u73b0\u57fa\u4e8e tail-based sampling \u7684\u5173\u952e\u8981\u6c42\u3002</p> <p>OpenTelemetry Collector \u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a agent\uff0c\u4ece\u88ab\u76d1\u63a7\u7684\u7cfb\u7edf\u4e2d\u63d0\u53d6\u9065\u6d4b\u6570\u636e\uff0c\u4f8b\u5982\uff0cOpenTelemetry Redis \u6216 host metrics\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#otelcol-otelcol-contrib","title":"Otelcol \u4e0e Otelcol-Contrib","text":"<p>OpenTelemetry Collector \u5728 GitHub \u4e0a\u6709 2 \u4e2a\u5b58\u50a8\u5e93:</p> <ul> <li> <p>opentelemetry-collector \u662f\u53ea\u5305\u542b\u6700\u5173\u952e\u7ec4\u4ef6\u7684\u6838\u5fc3\u3002\u5b83\u4ee5 otelcol \u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u5f62\u5f0f\u5206\u53d1\u3002</p> <ul> <li>https://github.com/open-telemetry/opentelemetry-collector</li> </ul> </li> <li> <p>opentelemetry-collector-contrib \u5305\u542b\u6838\u5fc3\u548c\u6240\u6709\u989d\u5916\u7684\u53ef\u7528\u7ec4\u4ef6\uff0c\u4f8b\u5982\uff0cRedis \u548c PostgreSQL \u63a5\u6536\u5668\u3002\u5b83\u4ee5 otelcol-contrib \u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u5f62\u5f0f\u5206\u53d1\u3002</p> <ul> <li>https://github.com/open-telemetry/opentelemetry-collector-contrib</li> </ul> </li> </ul> <p>\u60a8\u5e94\u8be5\u59cb\u7ec8\u5b89\u88c5\u548c\u4f7f\u7528 otelcol-contrib\uff0c\u56e0\u4e3a\u5b83\u548c\u6838\u5fc3\u4e00\u6837\u7a33\u5b9a\uff0c\u5e76\u4e14\u652f\u6301\u66f4\u591a\u7684\u7279\u6027\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_19","title":"\u5b89\u88c5","text":"<p>OpenTelemetry Collector \u4e3a Linux\u3001MacOS \u548c Windows \u5206\u53d1\u9884\u7f16\u8bd1\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#linux","title":"Linux","text":"<p>\u8981\u5b89\u88c5 otelcol-contrib binary \u548c\u76f8\u5173\u7684 systemd \u670d\u52a1\uff0c\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u5c06 0.82.0 \u66ff\u6362\u4e3a\u6240\u9700\u7684\u7248\u672c\uff0c\u5e76\u5c06 amd64 \u66ff\u6362\u4e3a\u6240\u9700\u7684\u67b6\u6784:</p> <p>Debian</p> <pre><code>wget https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.82.0/otelcol-contrib_0.82.0_linux_amd64.deb\nsudo dpkg -i otelcol-contrib_0.82.0_linux_amd64.deb\n</code></pre> <p>RPM</p> <pre><code>wget https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.82.0/otelcol_0.82.0_linux_amd64.rpm\nsudo rpm -ivh otelcol_0.82.0_linux_amd64.rpm\n</code></pre> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5\u5df2\u5b89\u88c5\u670d\u52a1\u7684\u72b6\u6001:</p> <pre><code>sudo systemctl status otelcol-contrib\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5\u65e5\u5fd7:</p> <pre><code>sudo journalctl -u otelcol-contrib -f\n</code></pre> <p>\u60a8\u53ef\u4ee5\u5728 <code>/etc/otelcol-contrib/config.yaml</code> \u4e2d\u7f16\u8f91\u914d\u7f6e\u3002\u5e76\u91cd\u65b0\u542f\u52a8 OpenTelemetry Collector:</p> <pre><code>sudo systemctl restart otelcol-contrib\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_20","title":"\u4ece\u6e90\u4ee3\u7801\u7f16\u8bd1","text":"<p>\u4f60\u4e5f\u53ef\u4ee5\u5728\u672c\u5730\u7f16\u8bd1 OpenTelemetry Collector:</p> <pre><code>git clone https://github.com/open-telemetry/opentelemetry-collector-contrib.git\ncd opentelemetry-collector-contrib\nmake install-tools\nmake otelcontribcol\n./bin/otelcontribcol_linux_amd64 --config ./examples/local/otel-config.yaml\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_21","title":"\u914d\u7f6e","text":"<p>OpenTelemetry Collector \u662f\u9ad8\u5ea6\u53ef\u914d\u7f6e\u7684\uff0c\u5141\u8bb8\u60a8\u81ea\u5b9a\u4e49\u5176\u884c\u4e3a\u5e76\u5c06\u5176\u96c6\u6210\u5230\u53ef\u89c2\u6d4b\u6027\u5806\u6808\u4e2d\u3002\u5b83\u63d0\u4f9b\u4e86\u7528\u4e8e\u6307\u5b9a\u8f93\u5165\u3001\u5904\u7406\u5668\u548c\u5bfc\u51fa\u5668\u7684\u914d\u7f6e\u9009\u9879\uff0c\u4f7f\u60a8\u80fd\u591f\u6839\u636e\u81ea\u5df1\u7684\u7279\u5b9a\u9700\u6c42\u5b9a\u5236\u4ee3\u7406\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u4ee5\u5728 <code>/etc/otelcol-contrib/config.yaml</code>\u4e2d\u627e\u5230\u914d\u7f6e\u6587\u4ef6\u3002\u4f8b\u5982(Uptrace):</p> <pre><code># receivers configure how data gets into the Collector.\nreceivers:\n  otlp:\n    protocols:\n      grpc:\n      http:\n\n# processors specify what happens with the received data.\nprocessors:\n  resourcedetection:\n    detectors: [env, system]\n  cumulativetodelta:\n  batch:\n    send_batch_size: 10000\n    timeout: 10s\n\n# exporters configure how to send processed data to one or more backends.\nexporters:\n  otlp/uptrace:\n    endpoint: otlp.uptrace.dev:4317\n    headers:\n      uptrace-dsn: 'https://&lt;token&gt;@uptrace.dev/&lt;project_id&gt;'\n\n# service.pipelines pull the configured receivers, processors, and exporters together into\n# pipelines that process data.\n#\n# receivers, processors, and exporters that are not used in pipelines are silently ignored.\nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [otlp/uptrace]\n    metrics:\n      receivers: [otlp]\n      processors: [cumulativetodelta, batch, resourcedetection]\n      exporters: [otlp/uptrace]\n    logs:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [otlp/uptrace]\n</code></pre> <p>\u60a8\u53ef\u4ee5\u901a\u8fc7\u5b98\u65b9\u6587\u6863\u4e86\u89e3\u66f4\u591a\u5173\u4e8e Otel Collector \u7684\u4fe1\u606f\u3002</p> <p>https://opentelemetry.io/docs/collector/configuration/</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_22","title":"\u6545\u969c\u6392\u9664","text":"<p>\u5982\u679c otelcol \u6ca1\u6709\u50cf\u9884\u671f\u7684\u90a3\u6837\u5de5\u4f5c\uff0c\u60a8\u53ef\u4ee5\u68c0\u67e5\u65e5\u5fd7\u8f93\u51fa\u662f\u5426\u5b58\u5728\u6f5c\u5728\u95ee\u9898\u3002\u65e5\u5fd7\u8bb0\u5f55\u7684\u8be6\u7ec6\u7a0b\u5ea6\u9ed8\u8ba4\u4e3a INFO\uff0c\u4f46\u60a8\u53ef\u4ee5\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\u66f4\u6539\u5b83:</p> <pre><code>service:\n  telemetry:\n    logs:\n      level: 'debug'\n</code></pre> <p>\u67e5\u770b\u6f5c\u5728\u95ee\u9898\u7684\u65e5\u5fd7\u3002</p> <pre><code>sudo journalctl -u otelcol-contrib -f\n</code></pre> <p>\u60a8\u8fd8\u53ef\u4ee5\u542f\u7528 metrics \u6765\u76d1\u89c6 OpenTelemetry Collector:</p> <pre><code>receivers:\n  prometheus/otelcol:\n    config:\n      scrape_configs:\n        - job_name: 'otelcol'\n          scrape_interval: 10s\n          static_configs:\n            - targets: ['0.0.0.0:8888']\n\nservice:\n  telemetry:\n    metrics:\n      address: ':8888'\n  pipelines:\n    metrics/hostmetrics:\n      receivers: [prometheus/otelcol]\n      processors: [cumulativetodelta, batch, resourcedetection]\n      exporters: [otlp/uptrace]\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_23","title":"\u6269\u5c55","text":"<p>Extensions \u4e3a OpenTelemetry Collector \u63d0\u4f9b\u4e86\u989d\u5916\u7684\u529f\u80fd\uff0c\u5e76\u4e14\u4e0d\u9700\u8981\u76f4\u63a5\u8bbf\u95ee\u9065\u6d4b\u6570\u636e\uff0c \u4f8b\u5982\uff0c\u5065\u5eb7\u68c0\u67e5\u6269\u5c55\u54cd\u5e94\u5065\u5eb7\u68c0\u67e5\u8bf7\u6c42\u3002</p> <pre><code>extensions:\n  # Health Check extension responds to health check requests\n  health_check:\n  # PProf extension allows fetching Collector's performance profile\n  pprof:\n  # zPages extension enables in-process diagnostics\n  zpages:\n  # Memory Ballast extension configures memory ballast for the process\n  memory_ballast:\n    size_mib: 512\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_24","title":"\u8d44\u6e90\u68c0\u6d4b","text":"<p>\u4e3a\u4e86\u68c0\u6d4b\u6765\u81ea\u4e3b\u673a\u7684\u8d44\u6e90\u4fe1\u606f\uff0cOtel Collector \u81ea\u5e26 resourcedetection processor\u3002</p> <p>https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor</p> <p>Resource Detection Processor \u81ea\u52a8\u68c0\u6d4b\u548c\u6807\u8bb0\u6709\u5173\u6570\u636e\u751f\u6210\u73af\u5883\u7684\u5143\u6570\u636e\u3002\u8fd9\u79cd\u5143\u6570\u636e\u79f0\u4e3a \"resources\"\uff0c\u4e3a\u9065\u6d4b\u6570\u636e\u63d0\u4f9b\u4e0a\u4e0b\u6587\uff0c\u53ef\u4ee5\u5305\u62ec\u4e3b\u673a\u3001\u670d\u52a1\u3001\u5bb9\u5668\u548c\u4e91\u63d0\u4f9b\u5546\u7b49\u4fe1\u606f\u3002</p> <p>\u4f8b\u5982\uff0c\u8981\u68c0\u6d4b host.name \u548c os.type \u5c5e\u6027\uff0c\u53ef\u4ee5\u4f7f\u7528\u7cfb\u7edf\u68c0\u6d4b\u5668\uff1a</p> <pre><code>processors:\n  resourcedetection:\n    detectors: [env, system]\n\nservice:\n  pipelines:\n    metrics:\n      receivers: [otlp, hostmetrics]\n      processors: [batch, resourcedetection]\n      exporters: [otlp/uptrace]\n</code></pre> <p>\u8981\u6dfb\u52a0\u81ea\u5b9a\u4e49\u5c5e\u6027\uff0c\u5982 IP \u5730\u5740\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 env \u53d8\u91cf\u548c env \u68c0\u6d4b\u5668:</p> <pre><code>export OTEL_RESOURCE_ATTRIBUTES=\"instance=127.0.0.1\"\n</code></pre> <p>\u4e3a\u4e86\u68c0\u6d4b\u66f4\u591a\u7684\u4fe1\u606f\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u66f4\u4e13\u95e8\u7684\u68c0\u6d4b\u5668\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u6b63\u5728\u4f7f\u7528 Amazon EC2\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 ec2 \u68c0\u6d4b\u5668\u6765\u53d1\u73b0 <code>cloud.region</code> \u548c <code>cloud.availability_zone</code> \u5c5e\u6027\uff1a</p> <pre><code>processors:\n  resourcedetection/ec2:\n    detectors: [env, ec2]\n</code></pre> <p>\u5982\u679c\u60a8\u6b63\u5728\u4f7f\u7528 Google Cloud:</p> <pre><code>processors:\n  resourcedetection/gcp:\n    detectors: [env, gcp]\n</code></pre> <p>\u5982\u679c\u4f60\u6b63\u5728\u4f7f\u7528 Docker:</p> <pre><code>processors:\n  resourcedetection/docker:\n    detectors: [env, docker]\n</code></pre> <p>\u60a8\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff0c\u4e86\u89e3 Heroku\u3001Azure\u3001Consul \u548c\u8bb8\u591a\u5176\u4ed6\u53ef\u7528\u7684\u68c0\u6d4b\u5668\u3002</p> <p>https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor#system-metadata</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_25","title":"\u5185\u5b58\u9650\u5236\u5668","text":"<p>memorylimiterprocessor \u662f\u4e00\u4e2a\u7ec4\u4ef6\uff0c\u5141\u8bb8\u7528\u6237\u5728\u5904\u7406\u9065\u6d4b\u6570\u636e\u65f6\u9650\u5236 OpenTelemetry Collector \u6d88\u8017\u7684\u5185\u5b58\u91cf\u3002\u5b83\u53ef\u4ee5\u9632\u6b62\u6536\u96c6\u5668\u4f7f\u7528\u8fc7\u591a\u7684\u5185\u5b58\uff0c\u8fd9\u53ef\u80fd\u5bfc\u81f4\u6027\u80fd\u95ee\u9898\u751a\u81f3\u5d29\u6e83\u3002</p> <p>https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/memorylimiterprocessor/README.md</p> <p>Memory Limiter Processor \u7684\u5de5\u4f5c\u65b9\u5f0f\u662f\u5b9a\u671f\u68c0\u67e5 OpenTelemetry Collector \u6d88\u8017\u7684\u5185\u5b58\u91cf\uff0c\u5e76\u5c06\u5176\u4e0e\u7528\u6237\u5b9a\u4e49\u7684\u5185\u5b58\u9650\u5236\u8fdb\u884c\u6bd4\u8f83\u3002\u5982\u679c\u6536\u96c6\u5668\u4f7f\u7528\u7684\u5185\u5b58\u8d85\u8fc7\u6307\u5b9a\u7684\u9650\u5236\uff0c\u5904\u7406\u5668\u5c06\u5f00\u59cb\u4e22\u5f03\u9065\u6d4b\u6570\u636e\uff0c\u76f4\u5230\u5185\u5b58\u4f7f\u7528\u4f4e\u4e8e\u9650\u5236\u3002</p> <p>\u8981\u542f\u7528\u5185\u5b58\u9650\u5236\u5668\uff1a</p> <pre><code>processors:\n  memory_limiter:\n    check_interval: 1s\n    limit_mib: 4000\n    spike_limit_mib: 800\n\nservice:\n  pipelines:\n    metrics:\n      processors: [memory_limiter]\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#opentelemetry_9","title":"OpenTelemetry \u4e3b\u673a\u6307\u6807","text":"<p>hostmetricsreceiver \u662f\u4e00\u4e2a OpenTelemetry Collector plugin\uff0c\u5b83\u6536\u96c6\u5173\u4e8e\u4e3b\u673a\u7cfb\u7edf\u7684\u5404\u79cd\u6307\u6807\uff0c\u4f8b\u5982\uff0cCPU, RAM\uff0c\u78c1\u76d8\u6307\u6807\u548c\u5176\u4ed6\u7cfb\u7edf\u7ea7\u6307\u6807\u3002</p> <p>https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/hostmetricsreceiver</p> <p>\u901a\u8fc7\u6536\u96c6\u548c\u5206\u6790\u4e3b\u673a\u6307\u6807\uff0c\u60a8\u53ef\u4ee5\u6df1\u5165\u4e86\u89e3\u4e3b\u673a\u7cfb\u7edf\u7684\u6027\u80fd\u548c\u8fd0\u884c\u72b6\u51b5\uff0c\u5e76\u8bc6\u522b\u53ef\u80fd\u5f71\u54cd\u5e94\u7528\u7a0b\u5e8f\u548c\u670d\u52a1\u6574\u4f53\u6027\u80fd\u7684\u6f5c\u5728\u95ee\u9898\u6216\u74f6\u9888\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_intro/#_26","title":"\u4e3b\u673a\u6307\u6807","text":"<p>\u8981\u5f00\u59cb\u6536\u96c6\u4e3b\u673a\u6307\u6807\uff0c\u60a8\u9700\u8981\u5728\u8981\u76d1\u89c6\u7684\u6bcf\u4e2a\u7cfb\u7edf\u4e0a\u5b89\u88c5 Collector\uff0c\u5e76\u5c06\u4ee5\u4e0b\u884c\u6dfb\u52a0\u5230 Collector \u914d\u7f6e\u4e2d:</p> <pre><code>processors:\n  resourcedetection:\n    detectors: [env, system]\n  cumulativetodelta:\n\nreceivers:\n  hostmetrics:\n    collection_interval: 10s\n    scrapers:\n      # CPU utilization metrics\n      cpu:\n      # Disk I/O metrics\n      disk:\n      # File System utilization metrics\n      filesystem:\n      # CPU load metrics\n      load:\n      # Memory utilization metrics\n      memory:\n      # Network interface I/O metrics &amp; TCP connection metrics\n      network:\n      # Paging/Swap space utilization and I/O metrics\n      paging:\n\nservice:\n  pipelines:\n    metrics:\n      receivers: [otlp, hostmetrics]\n      processors: [cumulativetodelta, batch, resourcedetection]\n      exporters: [otlp/uptrace]\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_27","title":"\u6587\u4ef6\u7cfb\u7edf\u6307\u6807","text":"<p>\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u4e0d\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u66f4\u5f7b\u5e95\u5730\u914d\u7f6e filesystem \u63a5\u6536\u5668\uff0c\u4f8b\u5982\uff0c\u53ea\u6293\u53d6\u652f\u6301\u7684\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\u5e76\u907f\u514d\u8b66\u544a\uff1a</p> <pre><code>receivers:\n  hostmetrics:\n    collection_interval: 10s\n    scrapers:\n      cpu:\n      disk:\n      load:\n      filesystem:\n        include_fs_types:\n          match_type: strict\n          fs_types: [ext3, ext4]\n      memory:\n      network:\n      paging:\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_28","title":"\u8fdb\u7a0b\u6307\u6807","text":"<p>\u8981\u6536\u96c6\u6bcf\u4e2a\u8fdb\u7a0b\u7684 CPU\u3001\u5185\u5b58\u548c\u78c1\u76d8 I/O \u6307\u6807\uff0c\u60a8\u9700\u8981\u542f\u7528\u5404\u81ea\u7684\u6293\u53d6\u5668\uff1a</p> <pre><code>receivers:\n  hostmetrics:\n    collection_interval: 10s\n    scrapers:\n      # Process count metrics\n      process:\n      # Per process CPU, Memory, and Disk I/O metrics\n      processes:\n</code></pre> <p>\u8fd9\u4e9b\u6293\u53d6\u5668\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u7981\u7528\u7684\uff0c\u56e0\u4e3a\u5b83\u4eec\u9700\u8981\u4ee5\u66f4\u9ad8\u7684\u6743\u9650\u8fd0\u884c OpenTelemetry Collector \u624d\u80fd\u8bbf\u95ee\u5176\u4ed6\u8fdb\u7a0b\u7684\u4fe1\u606f\u3002</p> <p>\u5728 Linux \u4e0a\uff0c\u4f60\u53ef\u4ee5\u5728 root \u7528\u6237\u4e0b\u8fd0\u884c otelcol-contrib:</p> <pre><code># /lib/systemd/system/otelcol-contrib.service\n\nUser=root\nGroup=root\n</code></pre> <p>\u6216\u8005\u4f7f\u7528 sudo \u542f\u52a8\u8be5\u8fdb\u7a0b\uff1a</p> <pre><code># /lib/systemd/system/otelcol-contrib.service\n\nExecStart=sudo /usr/bin/otelcol-contrib $OTELCOL_OPTIONS\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_intro/#_29","title":"\u5bb9\u5668\u4e3b\u673a\u6307\u6807","text":"<p>\u5728 Linux \u4e0a\uff0cOpenTelemetry \u4ece Linux \u7cfb\u7edf\u76ee\u5f55\u6536\u96c6\u6307\u6807\u3002\u8981\u6536\u96c6\u5173\u4e8e\u4e3b\u673a\u7cfb\u7edf\u800c\u4e0d\u662f\u5bb9\u5668\u7684\u6307\u6807\uff0c\u53ef\u4ee5\u5728\u8fd0\u884c\u5bb9\u5668\u65f6\u6302\u8f7d\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf:</p> <pre><code># mount the entire filesystem\ndocker run -v /:/hostfs ...\n\n# or mount only parts you need\ndocker run -v /proc:/hostfs/proc ...\n</code></pre> <p>\u7136\u540e\u914d\u7f6e <code>root_path</code>\uff0c\u4ee5\u4fbf hostmetrics \u63a5\u6536\u5668\u77e5\u9053\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u4f4d\u7f6e:</p> <pre><code>receivers:\n  hostmetrics:\n    root_path: /hostfs\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/","title":"2 \u4f7f\u7528 OpenTelemetry Collector \u91c7\u96c6 Kubernetes \u6307\u6807\u6570\u636e","text":"<p>Kubernetes \u5df2\u6210\u4e3a\u4e00\u4e2a\u88ab\u5e7f\u6cdb\u91c7\u7528\u7684\u884c\u4e1a\u5de5\u5177\uff0c\u5bf9\u53ef\u89c2\u6d4b\u6027\u5de5\u5177\u7684\u9700\u6c42\u4e5f\u5728\u4e0d\u65ad\u589e\u52a0\u3002</p> <p>\u4e3a\u6b64\uff0cOpenTelemetry \u521b\u5efa\u4e86\u8bb8\u591a\u4e0d\u540c\u7684\u5de5\u5177\uff0c\u6765\u5e2e\u52a9 Kubernetes \u7528\u6237\u89c2\u5bdf\u4ed6\u4eec\u7684\u96c6\u7fa4\u548c\u670d\u52a1\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u5f00\u59cb\u4f7f\u7528 OpenTelemetry \u76d1\u63a7 Kubernetes \u96c6\u7fa4\uff0c\u5c06\u4e13\u6ce8\u4e8e\u6536\u96c6 Kubernetes \u96c6\u7fa4\u3001\u8282\u70b9\u3001pod \u548c\u5bb9\u5668\u7684\u6307\u6807\u548c\u65e5\u5fd7\uff0c\u5e76\u4f7f\u96c6\u7fa4\u80fd\u591f\u652f\u6301\u53d1\u51fa OTLP \u6570\u636e\u7684\u670d\u52a1\u3002</p> <p>Kubernetes \u4ee5\u591a\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\u66b4\u9732\u4e86\u8bb8\u591a\u91cd\u8981\u7684\u9065\u6d4b\u6570\u636e\u3002\u5b83\u5177\u6709\u7528\u4e8e\u8bb8\u591a\u4e0d\u540c\u5bf9\u8c61\u7684\u65e5\u5fd7\u3001\u4e8b\u4ef6\u548c\u6307\u6807\uff0c\u4ee5\u53ca\u5176\u5de5\u4f5c\u8d1f\u8f7d\u751f\u6210\u7684\u6570\u636e\u3002 </p> <p>\u4e3a\u4e86\u6536\u96c6\u8fd9\u4e9b\u6570\u636e\uff0c\u6211\u4eec\u5c06\u4f7f\u7528 OpenTelemetry Collector\u3002\u8be5\u6536\u96c6\u5668\u53ef\u4ee5\u9ad8\u6548\u5730\u6536\u96c6\u6240\u6709\u8fd9\u4e9b\u6570\u636e</p> <p>\u4e3a\u4e86\u6536\u96c6\u6240\u6709\u7684\u6570\u636e\uff0c\u6211\u4eec\u5c06\u9700\u8981\u5b89\u88c5\u4e24\u4e2a\u6536\u96c6\u5668\uff0c\u4e00\u4e2a\u4f5c\u4e3a Daemonset\uff0c\u4e00\u4e2a\u4f5c\u4e3a Deployment\u3002</p> <p>\u6536\u96c6\u5668\u7684 DaemonSet \u5c06\u7528\u4e8e\u6536\u96c6\u670d\u52a1\u3001\u65e5\u5fd7\u548c\u8282\u70b9\u3001Pod \u548c\u5bb9\u5668\u7684\u6307\u6807\uff0c\u800c Deployment \u5c06\u7528\u4e8e\u6536\u96c6\u96c6\u7fa4\u7684\u6307\u6807\u548c\u4e8b\u4ef6\u3002</p> <p>\u4e3a\u4e86\u5b89\u88c5\u6536\u96c6\u5668\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06\u4f7f\u7528 OpenTelemetry Collector Helm \u56fe\u8868\uff0c\u8be5\u56fe\u8868\u5e26\u6709\u4e00\u4e9b\u914d\u7f6e\u9009\u9879\uff0c\u53ef\u4ee5\u66f4\u8f7b\u677e\u5730\u914d\u7f6e\u6536\u96c6\u5668\u3002</p> <p>\u9996\u5148\u9700\u8981\u6dfb\u52a0 OpenTelemetry Helm \u4ed3\u5e93\uff1a</p> <pre><code>$ helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts\n$ helm repo update\n</code></pre> <p>\u6536\u96c6 Kubernetes \u9065\u6d4b\u6570\u636e\u7684\u7b2c\u4e00\u6b65\u662f\u90e8\u7f72\u4e00\u4e2a OpenTelemetry Collector \u7684 DaemonSet \u5b9e\u4f8b\uff0c\u4ee5\u6536\u96c6\u4e0e\u8282\u70b9\u548c\u8fd0\u884c\u5728\u8fd9\u4e9b\u8282\u70b9\u4e0a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u76f8\u5173\u7684\u9065\u6d4b\u6570\u636e\u3002</p> <p>\u4f7f\u7528 DaemonSet \u53ef\u4ee5\u786e\u4fdd\u6b64\u6536\u96c6\u5668\u5b9e\u4f8b\u88ab\u5b89\u88c5\u5728\u6240\u6709\u8282\u70b9\u4e0a\u3002\u6bcf\u4e2a DaemonSet \u4e2d\u7684\u6536\u96c6\u5668\u5b9e\u4f8b\u5c06\u4ec5\u4ece\u5176\u8fd0\u884c\u7684\u8282\u70b9\u6536\u96c6\u6570\u636e</p> <p>\u901a\u8fc7 OpenTelemetry Collector Helm Chat \u914d\u7f6e\u6240\u6709\u8fd9\u4e9b\u7ec4\u4ef6\u975e\u5e38\u7b80\u5355\uff0c\u5b83\u8fd8\u4f1a\u5904\u7406\u6240\u6709\u4e0e Kubernetes \u76f8\u5173\u7684\u7ec6\u8282\uff0c\u4f8b\u5982 RBAC\u3001\u6302\u8f7d\u548c\u4e3b\u673a\u7aef\u53e3\u7b49\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8fd9\u4e2a Chart \u56fe\u8868\u4e0d\u4f1a\u5c06\u6570\u636e\u53d1\u9001\u5230\u4efb\u4f55\u540e\u7aef\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#_1","title":"\u6307\u6807\u91c7\u96c6","text":"<p>\u6211\u4eec\u8fd9\u91cc\u9996\u5148\u521b\u5efa\u4e00\u4e2a Prometheus \u5b9e\u4f8b\u6765\u6536\u96c6\u6307\u6807\u6570\u636e\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u4f7f\u7528 Helm Chart \u6765\u5feb\u901f\u90e8\u7f72 Prometheus\uff1a</p> <pre><code>$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\n$ helm repo update\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a <code>prometheus-values.yaml</code> \u6587\u4ef6\u6765\u914d\u7f6e Prometheus Helm Chart\uff1a</p> <pre><code># prometheus-values.yaml\nkubeStateMetrics:\n  enabled: false\n\nnodeExporter:\n  enabled: false\n\nkubelet:\n  enabled: false\n\nkubeApiServer:\n  enabled: false\n\nkubeControllerManager:\n  enabled: false\n\ncoreDns:\n  enabled: false\n\nkubeDns:\n  enabled: false\n\nkubeEtcd:\n  enabled: false\n\nkubeScheduler:\n  enabled: false\n\nkubeProxy:\n  enabled: false\n\nsidecar:\n  datasources:\n    label: grafana_datasource\n    labelValue: \"1\"\n  dashboards:\n    enabled: true\n\nprometheus:\n  prometheusSpec:\n    enableFeatures:\n      - remote-write-receiver\n\nprometheusOperator:\n  enabled: true\n  admissionWebhooks:\n    patch:\n      enabled: true\n      image:\n        registry: cnych\n        repository: ingress-nginx-kube-webhook-certgen\n        tag: v20221220-controller-v1.5.1-58-g787ea74b6\n\ngrafana:\n  ingress:\n    enabled: true\n    ingressClassName: nginx\n    hosts:\n      - grafana.k8s.local\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u6211\u4eec\u6ca1\u6709\u5b9a\u5236\u4efb\u4f55 Exporter\uff0c\u56e0\u4e3a\u6211\u4eec\u5c06\u4f7f\u7528 <code>OpenTelemetry Collector</code> \u6765\u6536\u96c6\u6307\u6807\u6570\u636e\uff0c\u7136\u540e\u518d\u5c06\u5176\u53d1\u9001\u5230 Prometheus \u4e2d\u3002</p> <p>\u6b64\u5916\u4e3a\u4e86\u80fd\u591f\u5c06\u6536\u96c6\u5668\u6307\u6807\u53d1\u9001\u5230 Prometheus \uff0c\u6211\u4eec\u9700\u8981\u542f\u7528\u8fdc\u7a0b\u5199\u5165\u529f\u80fd\uff0c\u6b63\u5e38\u53ea\u9700\u8981\u5728 Prometheus \u542f\u52a8\u53c2\u6570\u4e2d\u6307\u5b9a <code>--web.enable-remote-write-receiver</code> \u5373\u53ef\uff0c\u4f46\u662f\u6211\u4eec\u8fd9\u91cc\u662f\u901a\u8fc7 Prometheus Operator \u65b9\u5f0f\u90e8\u7f72\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u53bb\u4fee\u6539 Prometheus \u7684 CR \u5b9e\u4f8b\u5bf9\u8c61\uff0c\u542f\u7528 <code>remote-write-receiver</code> \u7279\u6027\u3002</p> <p>\u53e6\u5916\u6211\u4eec\u8fd8\u4e3a Grafana \u542f\u7528\u4e86 Ingress\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>grafana.k8s.local</code> \u6765\u8bbf\u95ee Grafana \u4e86\uff0c\u9ed8\u8ba4\u7528\u6237\u540d\u4e3a admin\uff0c\u5bc6\u7801\u4e3a prom-operator</p> <p>\u63a5\u4e0b\u6765\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e00\u952e\u90e8\u7f72 Prometheus \u5373\u53ef\uff1a</p> <pre><code>$ helm upgrade --install prometheus prometheus-community/kube-prometheus-stack -f prometheus-values.yaml --namespace kube-otel --create-namespace\nRelease \"prometheus\" does not exist. Installing it now.\n\nNAME: prometheus\nLAST DEPLOYED: Wed Aug 23 09:42:23 2023\nNAMESPACE: kube-otel\nSTATUS: deployed\nREVISION: 1\nNOTES:\nkube-prometheus-stack has been installed. Check its status by running:\n  kubectl --namespace kube-otel get pods -l \"release=prometheus\"\n\nVisit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create &amp; configure Alertmanager and Prometheus instances using the Operator.\n</code></pre> <p>\u90e8\u7f72\u540e\u7684\u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl get pods -n kube-otel\nNAME                                                     READY   STATUS    RESTARTS   AGE\nalertmanager-prometheus-kube-prometheus-alertmanager-0   2/2     Running   0          6m3s\nprometheus-grafana-5d95cbc57f-v2bw8                      3/3     Running   0          61s\nprometheus-kube-prometheus-operator-74fcfc7ff6-2bzfj     1/1     Running   0          6m19s\nprometheus-prometheus-kube-prometheus-prometheus-0       2/2     Running   0          6m3s\n$ kubectl get ingress -n kube-otel\nNAME                 CLASS   HOSTS               ADDRESS       PORTS   AGE\nprometheus-grafana   nginx   grafana.k8s.local   10.98.12.94   80      114s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u9700\u8981\u5c06\u6307\u6807\u6570\u636e\u53d1\u9001\u5230 Prometheus\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5728 Otel \u91c7\u96c6\u5668\u91cc\u9762\u53bb\u914d\u7f6e\u5bfc\u51fa\u5668\uff0c\u53ef\u4ee5\u4f7f\u7528\u5230 prometheus \u6216\u8005 <code>prometheusremotewrite</code> \u5bfc\u51fa\u5668\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u5c06\u4f7f\u7528\u5982\u4e0b\u7684 otel-collector-ds-values.yaml \u6587\u4ef6\u6765\u914d\u7f6e OpenTelemetry Collector Helm Chart\uff1a</p> <pre><code># otel-collector-ds-values.yaml\nmode: daemonset\n\ntolerations:\n  - key: node-role.kubernetes.io/control-plane\n    effect: NoSchedule\n\nclusterRole:\n  create: true\n  rules:\n    - apiGroups:\n        - \"\"\n      resources:\n        - nodes/proxy\n      verbs:\n        - get\n        - watch\n    - apiGroups:\n        - \"\"\n      resources:\n        - nodes\n      verbs:\n        - list\n        - watch\n        - get\n\npresets:\n  hostMetrics:\n    enabled: true\n  kubernetesAttributes:\n    enabled: true\n  kubeletMetrics:\n    enabled: true\n\nports:\n  prom: # \u6dfb\u52a0\u4e00\u4e2a 9090 \u7aef\u53e3\uff0c\u7528\u4e8e Prometheus \u6293\u53d6\n    enabled: true\n    containerPort: 9090\n    servicePort: 9090\n    protocol: TCP\n\nservice: # \u521b\u5efa\u4e00\u4e2a Service\uff0c\u540e\u9762 ServiceMonitor \u4f1a\u7528\u5230\n  enabled: true\n\nconfig:\n  receivers:\n    prometheus:\n      config:\n        scrape_configs:\n          - job_name: opentelemetry-collector\n            scrape_interval: 10s\n            static_configs:\n              - targets:\n                  - ${env:MY_POD_IP}:8888\n  exporters:\n    logging:\n      loglevel: debug\n    prometheus:\n      endpoint: \"0.0.0.0:9090\"\n      metric_expiration: 180m\n      resource_to_telemetry_conversion:\n        enabled: true\n    # prometheusremotewrite:\n    #   endpoint: http://prometheus-kube-prometheus-prometheus:9090/api/v1/write\n    #   tls:\n    #     insecure: true\n  processors:\n    metricstransform:\n      transforms:\n        include: .+\n        match_type: regexp\n        action: update\n        operations:\n          - action: add_label\n            new_label: k8s.cluster.id\n            new_value: abcd1234\n          - action: add_label\n            new_label: k8s.cluster.name\n            new_value: youdian-k8s\n  service:\n    pipelines:\n      metrics:\n        exporters:\n          - prometheus\n        processors:\n          - memory_limiter # \u5185\u5b58\u9650\u5236\u4e00\u822c\u653e\u5728\u6700\u524d\u9762\n          - metricstransform\n          - k8sattributes\n          - batch # \u6279\u91cf\u5904\u7406\u5668\u653e\u5728\u6700\u540e\n        receivers:\n          - otlp\n          - hostmetrics\n          - kubeletstats\n          - prometheus\n</code></pre> <p>\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u6765\u90e8\u7f72 OpenTelemetry Collector DaemonSet\uff1a</p> <pre><code>$ helm upgrade --install opentelemetry-collector open-telemetry/opentelemetry-collector -f otel-ds-values.yaml --namespace kube-otel --create-namespace\n\n$ kubectl get pods -n kube-otel\nNAME                                                     READY   STATUS      RESTARTS   AGE\nopentelemetry-collector-agent-22rsm                      1/1     Running     0          18h\nopentelemetry-collector-agent-v4nkh                      1/1     Running     0          18h\nopentelemetry-collector-agent-xndlq                      1/1     Running     0          18h\n</code></pre> <p>\u5b89\u88c5\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u91c7\u96c6\u5668\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u4f7f\u7528\u547d\u4ee4 <code>kubectl get cm -n kube-otel opentelemetry-collector-agent -oyaml</code>\uff1a</p> <pre><code>exporters:\n  logging:\n    loglevel: debug\n  prometheus:\n    endpoint: 0.0.0.0:9090\n    metric_expiration: 180m\n    resource_to_telemetry_conversion:\n      enabled: true\nextensions:\n  health_check: {}\n  memory_ballast:\n    size_in_percentage: 40\nprocessors:\n  batch: {}\n  k8sattributes:\n    extract:\n      metadata:\n        - k8s.namespace.name\n        - k8s.deployment.name\n        - k8s.statefulset.name\n        - k8s.daemonset.name\n        - k8s.cronjob.name\n        - k8s.job.name\n        - k8s.node.name\n        - k8s.pod.name\n        - k8s.pod.uid\n        - k8s.pod.start_time\n    filter:\n      node_from_env_var: K8S_NODE_NAME\n    passthrough: false\n    pod_association:\n      - sources:\n          - from: resource_attribute\n            name: k8s.pod.ip\n      - sources:\n          - from: resource_attribute\n            name: k8s.pod.uid\n      - sources:\n          - from: connection\n  memory_limiter:\n    check_interval: 5s\n    limit_percentage: 80\n    spike_limit_percentage: 25\n  metricstransform:\n    transforms:\n      action: update\n      include: .+\n      match_type: regexp\n      operations:\n        - action: add_label\n          new_label: k8s.cluster.id\n          new_value: abcd1234\n        - action: add_label\n          new_label: k8s.cluster.name\n          new_value: youdian-k8s\nreceivers:\n  hostmetrics:\n    collection_interval: 10s\n    root_path: /hostfs\n    scrapers:\n      cpu: null\n      disk: null\n      filesystem:\n        exclude_fs_types:\n          fs_types:\n            - autofs\n            - binfmt_misc\n            - bpf\n            - cgroup2\n            - configfs\n            - debugfs\n            - devpts\n            - devtmpfs\n            - fusectl\n            - hugetlbfs\n            - iso9660\n            - mqueue\n            - nsfs\n            - overlay\n            - proc\n            - procfs\n            - pstore\n            - rpc_pipefs\n            - securityfs\n            - selinuxfs\n            - squashfs\n            - sysfs\n            - tracefs\n          match_type: strict\n        exclude_mount_points:\n          match_type: regexp\n          mount_points:\n            - /dev/*\n            - /proc/*\n            - /sys/*\n            - /run/k3s/containerd/*\n            - /var/lib/docker/*\n            - /var/lib/kubelet/*\n            - /snap/*\n      load: null\n      memory: null\n      network: null\n  kubeletstats:\n    auth_type: serviceAccount\n    collection_interval: 20s\n    endpoint: ${K8S_NODE_NAME}:10250\n  otlp:\n    protocols:\n      grpc:\n        endpoint: ${env:MY_POD_IP}:4317\n      http:\n        endpoint: ${env:MY_POD_IP}:4318\n  prometheus:\n    config:\n      scrape_configs:\n        - job_name: opentelemetry-collector\n          scrape_interval: 10s\n          static_configs:\n            - targets:\n                - ${env:MY_POD_IP}:8888\nservice:\n  extensions:\n    - health_check\n    - memory_ballast\n  pipelines:\n    metrics:\n      exporters:\n        - prometheus\n      processors:\n        - memory_limiter\n        - metricstransform\n        - k8sattributes\n        - batch\n      receivers:\n        - otlp\n        - hostmetrics\n        - kubeletstats\n        - prometheus\n  telemetry:\n    metrics:\n      address: ${env:MY_POD_IP}:8888\n# ...... \u7701\u7565\u5176\u4ed6\n</code></pre> <p>\u4e0a\u9762\u7684\u914d\u7f6e\u4fe1\u606f\u662f OpenTelemetry Collector \u771f\u6b63\u8fd0\u884c\u65f6\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u4fdd\u7559\u4e86\u548c metrics \u76f8\u5173\u7684\u914d\u7f6e\u3002\u4ece\u4e0a\u9762\u914d\u7f6e\u6587\u4ef6\u53ef\u4ee5\u770b\u51fa\u6211\u4eec\u5b9a\u4e49\u4e86 </p> <p>4 \u4e2a\u63a5\u6536\u5668\uff1a</p> <ul> <li>hostmetrics \u63a5\u6536\u5668</li> <li>kubeletstats \u63a5\u6536\u5668</li> <li>otlp \u63a5\u6536\u5668</li> <li>prometheus \u63a5\u6536\u5668</li> </ul> <p>4 \u4e2a\u5904\u7406\u5668\uff1a</p> <ul> <li>batch \u5904\u7406\u5668</li> <li><code>memory_limiter</code> \u5904\u7406\u5668</li> <li>k8sattributes \u5904\u7406\u5668</li> <li>metricstransform \u5904\u7406\u5668</li> </ul> <p>2 \u4e2a\u5bfc\u51fa\u5668\uff1a</p> <ul> <li>logging \u5bfc\u51fa\u5668</li> <li>prometheus \u5bfc\u51fa\u5668</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u6765\u8be6\u7ec6\u4ecb\u7ecd\u4e00\u4e0b\u5176\u4ed6\u7ec4\u4ef6\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#otlp","title":"otlp \u63a5\u6536\u5668","text":"<p>otlp \u63a5\u6536\u5668\u662f\u5728 OTLP \u683c\u5f0f\u4e2d\u6536\u96c6\u8ddf\u8e2a\u3001\u6307\u6807\u548c\u65e5\u5fd7\u7684\u6700\u4f73\u89e3\u51b3\u65b9\u6848\u3002\u5982\u679c\u60a8\u5728\u4ee5\u5176\u4ed6\u683c\u5f0f\u53d1\u51fa\u5e94\u7528\u7a0b\u5e8f\u9065\u6d4b\u6570\u636e\uff0c\u90a3\u4e48\u6536\u96c6\u5668\u5f88\u6709\u53ef\u80fd\u4e5f\u6709\u4e00\u4e2a\u76f8\u5e94\u7684\u63a5\u6536\u5668\u3002\u8fd9\u4e2a\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u8be6\u7ec6\u4ecb\u7ecd\u8fc7\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e86 <code>http</code> \u548c <code>grpc</code> \u4e24\u79cd\u534f\u8bae\uff0c\u5206\u522b\u76d1\u542c <code>4317</code> \u548c <code>4318</code> \u7aef\u53e3\u3002\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>receivers:\n  otlp:\n    protocols:\n      grpc:\n        endpoint: ${env:MY_POD_IP}:4317\n      http:\n        endpoint: ${env:MY_POD_IP}:4318\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#hostmetrics","title":"hostmetrics \u63a5\u6536\u5668","text":"<p><code>hostmetrics</code> \u63a5\u6536\u5668\u7528\u4e8e\u6536\u96c6\u4e3b\u673a\u7ea7\u522b\u7684\u6307\u6807\uff0c\u4f8b\u5982 CPU \u4f7f\u7528\u7387\u3001\u78c1\u76d8\u4f7f\u7528\u7387\u3001\u5185\u5b58\u4f7f\u7528\u7387\u548c\u7f51\u7edc\u6d41\u91cf\u3002\u6211\u4eec\u8fd9\u91cc\u7684\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>receivers:\n  hostmetrics:\n    collection_interval: 10s\n    root_path: /hostfs\n    scrapers:\n      cpu: null\n      disk: null\n      filesystem:\n        exclude_fs_types:\n          fs_types:\n            - autofs\n            - binfmt_misc\n            - bpf\n            - cgroup2\n            - configfs\n            - debugfs\n            - devpts\n            - devtmpfs\n            - fusectl\n            - hugetlbfs\n            - iso9660\n            - mqueue\n            - nsfs\n            - overlay\n            - proc\n            - procfs\n            - pstore\n            - rpc_pipefs\n            - securityfs\n            - selinuxfs\n            - squashfs\n            - sysfs\n            - tracefs\n          match_type: strict\n        exclude_mount_points:\n          match_type: regexp\n          mount_points:\n            - /dev/*\n            - /proc/*\n            - /sys/*\n            - /run/k3s/containerd/*\n            - /var/lib/docker/*\n            - /var/lib/kubelet/*\n            - /snap/*\n      load: null\n      memory: null\n      network: null\n</code></pre> <p>\u914d\u7f6e\u7ea2\u901a\u8fc7 <code>collection_interval</code> \u6307\u5b9a\u4e86\u6bcf 10 \u79d2\u6536\u96c6\u4e00\u6b21\u6307\u6807\uff0c\u5e76\u4f7f\u7528\u6839\u8def\u5f84 <code>/hostfs</code> \u6765\u8bbf\u95ee\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf\u3002</p> <p>hostmetrics \u63a5\u6536\u5668\u5305\u62ec\u591a\u4e2a\u6293\u53d6\u5668\uff0c\u7528\u4e8e\u6536\u96c6\u4e0d\u540c\u7c7b\u578b\u7684\u6307\u6807\u3002\u4f8b\u5982\uff0ccpu \u6293\u53d6\u5668\u7528\u4e8e\u6536\u96c6 CPU \u4f7f\u7528\u7387\u6307\u6807\uff0cdisk \u6293\u53d6\u5668\u7528\u4e8e\u6536\u96c6\u78c1\u76d8\u4f7f\u7528\u7387\u6307\u6807\uff0cmemory \u6293\u53d6\u5668\u7528\u4e8e\u6536\u96c6\u5185\u5b58\u4f7f\u7528\u7387\u6307\u6807,load \u6293\u53d6\u5668\u7528\u4e8e\u6536\u96c6 CPU \u8d1f\u8f7d\u6307\u6807\u3002\u5728\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u53ea\u542f\u7528\u4e86 filesystem \u6293\u53d6\u5668\uff0c\u7528\u4e8e\u6536\u96c6\u6587\u4ef6\u7cfb\u7edf\u4f7f\u7528\u7387\u6307\u6807\u3002</p> <p>filesystem \u6293\u53d6\u5668\u7684\u914d\u7f6e\u4e2d\uff0c\u6307\u5b9a\u4e86\u8981\u6392\u9664\u67d0\u4e9b\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\u548c\u6302\u8f7d\u70b9\u7684\u6307\u6807\u6536\u96c6\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5b83\u6392\u9664\u4e86\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b <code>autofs</code>\u3001<code>binfmt_misc</code>\u3001<code>bpf</code>\u3001<code>cgroup2</code>......\uff0c\u5b83\u8fd8\u6392\u9664\u4e86\u6302\u8f7d\u70b9 <code>/dev/*</code>\u3001<code>/proc/*</code>\u3001<code>/sys/*</code>\u3001<code>/run/k3s/containerd/*</code>\u3001<code>/var/lib/docker/*</code>\u3001<code>/var/lib/kubelet/*</code> \u548c<code>/snap/*</code>\uff0c\u8fd9\u4e9b\u6392\u9664\u64cd\u4f5c\u786e\u4fdd\u53ea\u6536\u96c6\u76f8\u5173\u7684\u6587\u4ef6\u7cfb\u7edf\u4f7f\u7528\u7387\u6307\u6807\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#kubeletstats","title":"kubeletstats \u63a5\u6536\u5668","text":"<p>Kubelet Stats Receiver \u7528\u4e8e\u4ece kubelet \u4e0a\u7684 API \u670d\u52a1\u5668\u4e2d\u83b7\u53d6\u6307\u6807\u3002\u901a\u5e38\u7528\u4e8e\u6536\u96c6\u4e0e Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u76f8\u5173\u7684\u6307\u6807\uff0c\u4f8b\u5982 CPU \u4f7f\u7528\u7387\u3001\u5185\u5b58\u4f7f\u7528\u7387\u548c\u7f51\u7edc\u6d41\u91cf\u3002\u8fd9\u4e9b\u6307\u6807\u53ef\u7528\u4e8e\u76d1\u89c6 Kubernetes \u96c6\u7fa4\u548c\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5065\u5eb7\u72b6\u51b5\u548c\u6027\u80fd\u3002</p> <p><code>Kubelet Stats Receiver</code> \u9ed8\u8ba4\u652f\u6301\u5728\u7aef\u53e3 10250 \u66b4\u9732\u7684\u5b89\u5168 Kubelet \u7aef\u70b9\u548c\u5728\u7aef\u53e3 10255 \u66b4\u9732\u7684\u53ea\u8bfb Kubelet \u7aef\u70b9\u3002</p> <p>\u5982\u679c <code>auth_type</code> \u8bbe\u7f6e\u4e3a <code>none</code>\uff0c\u5219\u5c06\u4f7f\u7528\u53ea\u8bfb\u7aef\u70b9\u3002\u5982\u679c <code>auth_type</code> \u8bbe\u7f6e\u4e3a\u4ee5\u4e0b\u4efb\u4f55\u503c\uff0c\u5219\u5c06\u4f7f\u7528\u5b89\u5168\u7aef\u70b9\uff1a</p> <ul> <li>tls \u544a\u8bc9\u63a5\u6536\u65b9\u4f7f\u7528 TLS \u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\uff0c\u5e76\u8981\u6c42\u8bbe\u7f6e <code>ca_file</code>\u3001<code>key_file</code> \u548c <code>cert_file</code> \u5b57\u6bb5\u3002</li> <li><code>serviceAccount</code> \u544a\u8bc9\u8be5\u63a5\u6536\u8005\u4f7f\u7528\u9ed8\u8ba4\u7684 <code>ServiceAccount</code> \u4ee4\u724c\u6765\u5411 kubelet API \u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u3002</li> <li><code>kubeConfig</code> \u544a\u8bc9\u8be5\u63a5\u6536\u5668\u4f7f\u7528 kubeconfig \u6587\u4ef6\uff08KUBECONFIG \u73af\u5883\u53d8\u91cf\u6216 <code>~/.kube/config</code>\uff09\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u5e76\u4f7f\u7528 APIServer \u4ee3\u7406\u6765\u8bbf\u95ee kubelet API\u3002</li> <li><code>initial_delay</code>\uff08\u9ed8\u8ba4 = 1 \u79d2\uff09\uff0c\u5b9a\u4e49\u63a5\u6536\u5668\u5728\u5f00\u59cb\u4e4b\u524d\u7b49\u5f85\u7684\u65f6\u95f4\u3002</li> </ul> <p>\u6b64\u5916\u8fd8\u53ef\u4ee5\u6307\u5b9a\u4ee5\u4e0b\u53c2\u6570\uff1a</p> <ul> <li><code>collection_interval</code>\uff08\u9ed8\u8ba4= 10s\uff09\uff0c\u6536\u96c6\u6570\u636e\u7684\u65f6\u95f4\u95f4\u9694\u3002</li> <li><code>insecure_skip_verify</code>\uff08\u9ed8\u8ba4= false\uff09\uff0c\u662f\u5426\u8df3\u8fc7\u8bc1\u4e66\u9a8c\u8bc1\u3002</li> </ul> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u751f\u6210\u7684\u6307\u6807\u90fd\u57fa\u4e8e kubelet \u7684 <code>/stats/summary</code> \u7aef\u70b9\u63d0\u4f9b\u7684\u8d44\u6e90\u6807\u7b7e\u3002\u5bf9\u4e8e\u67d0\u4e9b\u573a\u666f\u800c\u8a00\uff0c\u8fd9\u53ef\u80fd\u8fd8\u4e0d\u591f\u3002</p> <p>\u56e0\u6b64\uff0c\u53ef\u4ee5\u5229\u7528\u5176\u4ed6\u7aef\u70b9\u6765\u83b7\u53d6\u9644\u52a0\u7684\u5143\u6570\u636e\uff0c\u5e76\u5c06\u5b83\u4eec\u8bbe\u7f6e\u4e3a\u6307\u6807\u8d44\u6e90\u7684\u989d\u5916\u6807\u7b7e\u3002\u5f53\u524d\u652f\u6301\u7684\u5143\u6570\u636e\u5305\u62ec\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ul> <li><code>container.id</code> - \u4f7f\u7528\u4ece\u901a\u8fc7 <code>/pods</code> \u66b4\u9732\u7684\u5bb9\u5668\u72b6\u6001\u83b7\u53d6\u7684\u5bb9\u5668 ID \u6807\u7b7e\u6765\u589e\u5f3a\u6307\u6807\u3002</li> <li><code>k8s.volume.type</code> - \u4ece\u901a\u8fc7 <code>/pods</code> \u66b4\u9732\u7684 Pod \u89c4\u8303\u6536\u96c6\u5377\u7c7b\u578b\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u5377\u6307\u6807\u7684\u6807\u7b7e\u3002\u5982\u679c\u7aef\u70b9\u63d0\u4f9b\u7684\u4fe1\u606f\u4e0d\u4ec5\u4ec5\u662f\u5377\u7c7b\u578b\uff0c\u8fd9\u4e9b\u4fe1\u606f\u4e5f\u4f1a\u6839\u636e\u53ef\u7528\u5b57\u6bb5\u548c\u5377\u7c7b\u578b\u8fdb\u884c\u540c\u6b65\u3002\u4f8b\u5982\uff0c<code>aws.volume.id</code> \u5c06\u4ece <code>awsElasticBlockStore</code> \u540c\u6b65\uff0c<code>gcp.pd.name</code> \u5c06\u4ece <code>gcePersistentDisk</code> \u540c\u6b65\u3002</li> </ul> <p>\u5982\u679c\u4f60\u5e0c\u671b\u5c06 <code>container.id</code> \u6807\u7b7e\u6dfb\u52a0\u5230\u4f60\u7684\u6307\u6807\u4e2d\uff0c\u8bf7\u4f7f\u7528 <code>extra_metadata_labels</code> \u5b57\u6bb5\u6765\u542f\u7528\u5b83\uff0c\u4f8b\u5982\uff1a</p> <pre><code>receivers:\n  kubeletstats:\n    collection_interval: 10s\n    auth_type: \"serviceAccount\"\n    endpoint: \"${env:K8S_NODE_NAME}:10250\"\n    insecure_skip_verify: true\n    extra_metadata_labels:\n      - container.id\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e <code>extra_metadata_labels</code>\uff0c\u5219\u4e0d\u4f1a\u8fdb\u884c\u989d\u5916\u7684 API \u8c03\u7528\u6765\u83b7\u53d6\u989d\u5916\u7684\u5143\u6570\u636e\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8be5\u6536\u96c6\u5668\u5c06\u6536\u96c6\u6765\u81ea\u5bb9\u5668\u3001pod \u548c\u8282\u70b9\u7684\u6307\u6807\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u4e00\u4e2a <code>metric_groups</code> \u6765\u6307\u5b9a\u8981\u6536\u96c6\u7684\u6570\u636e\u6765\u6e90\uff0c\u53ef\u4ee5\u6307\u5b9a\u7684\u503c\u5305\u62ec container\u3001pod\u3001node \u548c volume\u3002</p> <p>\u6bd4\u5982\u5e0c\u671b\u4ec5\u4ece\u63a5\u6536\u5668\u6536\u96c6\u8282\u70b9\u548c Pod \u6307\u6807\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>receivers:\n  kubeletstats:\n    collection_interval: 10s\n    auth_type: \"serviceAccount\"\n    endpoint: \"${env:K8S_NODE_NAME}:10250\"\n    insecure_skip_verify: true\n    metric_groups:\n      - node\n      - pod\n</code></pre> <p><code>K8S_NODE_NAME</code> \u73af\u5883\u53d8\u91cf\u5728 Kubernetes \u96c6\u7fa4\u91cc\u9762\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Downward API \u6765\u6ce8\u5165\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#prometheus","title":"prometheus \u63a5\u6536\u5668","text":"<p>Prometheus \u63a5\u6536\u5668\u4ee5 Prometheus \u683c\u5f0f\u63a5\u6536\u6307\u6807\u6570\u636e\u3002\u8be5\u63a5\u6536\u5668\u65e8\u5728\u6700\u5927\u9650\u5ea6\u5730\u6210\u4e3a Prometheus \u7684\u66ff\u4ee3\u54c1\uff0c\u4f46\u662f\u76ee\u524d\u4e0d\u652f\u6301\u4e0b\u9762\u8fd9\u4e9b Prometheus \u7684\u9ad8\u7ea7\u529f\u80fd\uff1a</p> <ul> <li><code>alert_config.alertmanagers</code></li> <li><code>alert_config.relabel_configs</code></li> <li><code>remote_read</code></li> <li><code>remote_write</code></li> <li><code>rule_files</code></li> </ul> <p>\u8be5\u63a5\u6536\u5668\u662f\u8ba9 Prometheus \u6293\u53d6\u4f60\u7684\u670d\u52a1\u7684\u76f4\u63a5\u66ff\u4ee3\u54c1\u3002\u5b83\u652f\u6301 <code>scrape_config</code> \u4e2d\u7684\u5168\u90e8 <code>Prometheus</code> \u914d\u7f6e\uff0c\u5305\u62ec\u670d\u52a1\u53d1\u73b0\u3002</p> <p>\u5c31\u50cf\u5728\u542f\u52a8 Prometheus \u4e4b\u524d\u5728 YAML \u914d\u7f6e\u6587\u4ef6\u4e2d\u5199\u5165\u4e00\u6837\uff0c\u4f8b\u5982\uff1a</p> <pre><code>prometheus --config.file=prom.yaml\n</code></pre> <p>\u6ce8\u610f\uff1a\u7531\u4e8e\u6536\u96c6\u5668\u914d\u7f6e\u652f\u6301env\u53d8\u91cf\u66ff\u6362\uff0cprometheus\u914d\u7f6e\u4e2d\u7684\u5b57\u7b26\u5c06\u88ab\u89e3\u91ca\u4e3a\u73af\u5883\u53d8\u91cf\u3002\u5982\u679c\u8981\u5728prometheus\u914d\u7f6e\u4e2d\u4f7f\u7528\u5b57\u7b26\uff0c\u5219\u5fc5\u987b\u4f7f\u7528</p> <p>\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u914d\u7f6e\u6765\u8ba9\u6536\u96c6\u5668\u63a5\u6536 Prometheus \u7684\u6307\u6807\u6570\u636e\uff0c\u4f7f\u7528\u65b9\u6cd5\u548c Prometheus \u4e00\u6837\uff0c\u53ea\u9700\u8981\u5728 <code>scrape_configs</code> \u4e2d\u6dfb\u52a0\u4e00\u4e2a\u4efb\u52a1\u5373\u53ef\uff1a</p> <pre><code>receivers:\n  prometheus:\n    config:\n      scrape_configs:\n        - job_name: opentelemetry-collector\n          scrape_interval: 10s\n          static_configs:\n            - targets:\n                - ${env:MY_POD_IP}:8888\n        - job_name: k8s\n          kubernetes_sd_configs:\n            - role: pod\n          relabel_configs:\n            - source_labels:\n                [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n              regex: \"true\"\n              action: keep\n          metric_relabel_configs:\n            - source_labels: [__name__]\n              regex: \"(request_duration_seconds.*|response_duration_seconds.*)\"\n              action: keep\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u6dfb\u52a0\u7684 <code>opentelemetry-collecto</code>r \u4efb\u52a1\uff0c\u662f\u53bb\u6293\u53d6 8888 \u7aef\u53e3\u7684\u6570\u636e\uff0c\u800c 8888 \u7aef\u53e3\u5c31\u662f <code>OpenTelemetry Collector</code> \u7684\u7aef\u53e3\uff0c\u8fd9\u4e2a\u7aef\u53e3\u6211\u4eec\u5728 <code>service.telemetry</code> \u4e2d\u5df2\u7ecf\u5b9a\u4e49\u4e86\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u8be5\u63a5\u6536\u5668\u6765\u6293\u53d6 <code>OpenTelemetry Collector</code>\u672c\u8eab\u7684\u6307\u6807\u6570\u636e\u4e86\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#batch","title":"batch \u5904\u7406\u5668","text":"<p>\u6279\u5904\u7406\u5668\u63a5\u53d7\u8ffd\u8e2a\u3001\u6307\u6807\u6216\u65e5\u5fd7\uff0c\u5e76\u5c06\u5b83\u4eec\u5206\u6279\u5904\u7406\u3002\u6279\u5904\u7406\u6709\u52a9\u4e8e\u66f4\u597d\u5730\u538b\u7f29\u6570\u636e\uff0c\u5e76\u51cf\u5c11\u4f20\u8f93\u6570\u636e\u6240\u9700\u7684\u5916\u90e8\u8fde\u63a5\u6570\u91cf\u3002\u8be5\u5904\u7406\u5668\u652f\u6301\u57fa\u4e8e\u5927\u5c0f\u548c\u65f6\u95f4\u7684\u6279\u5904\u7406\u3002</p> <p>\u5f3a\u70c8\u5efa\u8bae\u5728\u6bcf\u4e2a\u91c7\u96c6\u5668\u4e0a\u914d\u7f6e\u6279\u5904\u7406\u5668\u3002\u6279\u5904\u7406\u5668\u5e94\u8be5\u5728\u5185\u5b58\u9650\u5236\u5668\uff08<code>memory_limiter</code>\uff09\u4ee5\u53ca\u4efb\u4f55\u5176\u4ed6\u91c7\u6837\u5904\u7406\u5668\u4e4b\u540e\u7684\u7ba1\u9053\u4e2d\u5b9a\u4e49\u3002\u8fd9\u662f\u56e0\u4e3a\u6279\u5904\u7406\u5e94\u8be5\u5728\u4efb\u4f55\u6570\u636e\u91c7\u6837\u4e4b\u540e\u518d\u53d1\u751f\u3002</p> <p>\u6279\u5904\u7406\u5668\u4e2d\u53ef\u4ee5\u914d\u7f6e\u5982\u4e0b\u6240\u793a\u7684\u4e00\u4e9b\u53c2\u6570\uff1a</p> <ul> <li><code>send_batch_size</code>\uff08\u9ed8\u8ba4\u503c=8192\uff09\uff1a\u65e0\u8bba\u8d85\u65f6\u5982\u4f55\uff0c\u8fbe\u5230\u6b64\u6570\u91cf\u7684\u8ffd\u8e2a\u3001\u6307\u6807\u6570\u636e\u6216\u65e5\u5fd7\u8bb0\u5f55\u540e\uff0c\u90fd\u5c06\u7acb\u5373\u53d1\u9001\u6279\u5904\u7406\u3002<code>send_batch_size</code> \u8d77\u5230\u89e6\u53d1\u5668\u7684\u4f5c\u7528\uff0c\u4e0d\u5f71\u54cd\u6279\u5904\u7406\u7684\u5927\u5c0f\u3002\u5982\u679c\u9700\u8981\u5f3a\u5236\u9650\u5236\u53d1\u9001\u5230\u7ba1\u9053\u4e2d\u4e0b\u4e00\u4e2a\u7ec4\u4ef6\u7684\u6279\u5904\u7406\u5927\u5c0f\uff0c\u53ef\u4ee5\u914d\u7f6e <code>send_batch_max_size</code>\u3002</li> <li>timeout\uff08\u9ed8\u8ba4\u503c=200ms\uff09\uff1a\u65e0\u8bba\u6279\u5904\u7406\u5927\u5c0f\u5982\u4f55\uff0c\u5728\u7ecf\u8fc7\u4e00\u5b9a\u65f6\u95f4\u540e\uff0c\u5c06\u7acb\u5373\u53d1\u9001\u6279\u5904\u7406\u3002\u5982\u679c\u8bbe\u7f6e\u4e3a\u96f6\uff0c\u5219\u5ffd\u7565<code>send_batch_size</code>\uff0c\u56e0\u4e3a\u6570\u636e\u5c06\u7acb\u5373\u53d1\u9001\uff0c\u53ea\u53d7 <code>send_batch_max_size</code> \u7684\u9650\u5236\u3002</li> <li><code>send_batch_max_size</code>\uff08\u9ed8\u8ba4\u503c=0\uff09\uff1a\u6279\u5904\u7406\u5927\u5c0f\u7684\u4e0a\u9650\u30020 \u8868\u793a\u6279\u5904\u7406\u5927\u5c0f\u65e0\u4e0a\u9650\uff0c\u6b64\u5c5e\u6027\u786e\u4fdd\u8f83\u5927\u7684\u6279\u5904\u7406\u88ab\u62c6\u5206\u4e3a\u8f83\u5c0f\u7684\u5355\u4f4d\u3002\u5b83\u5fc5\u987b\u5927\u4e8e\u6216\u7b49\u4e8e<code>send_batch_size</code>\u3002</li> <li><code>metadata_keys</code>\uff08\u9ed8\u8ba4\u503c=\u7a7a\uff09\uff1a\u5f53\u8bbe\u7f6e\u65f6\uff0c\u6b64\u5904\u7406\u5668\u5c06\u4e3a client.Metadata \u4e2d\u503c\u7684\u6bcf\u4e2a\u4e0d\u540c\u7ec4\u5408\u521b\u5efa\u4e00\u4e2a\u6279\u5904\u7406\u7a0b\u5e8f\u5b9e\u4f8b\u3002</li> <li><code>metadata_cardinality_limit</code>\uff08\u9ed8\u8ba4\u503c=1000\uff09\uff1a\u5f53 <code>metadata_keys</code>\u4e0d\u4e3a\u7a7a\u65f6\uff0c\u6b64\u8bbe\u7f6e\u9650\u5236\u5c06\u5728\u8fdb\u7a0b\u7684\u751f\u547d\u5468\u671f\u5185\u5904\u7406\u7684\u5143\u6570\u636e\u952e\u503c\u7684\u552f\u4e00\u7ec4\u5408\u7684\u6570\u91cf\u3002</li> </ul> <p>\u6bd4\u5982\u5982\u4e0b\u914d\u7f6e\u5305\u542b\u4e00\u4e2a\u9ed8\u8ba4\u7684\u6279\u5904\u7406\u5668\u548c\u4e00\u4e2a\u5177\u6709\u81ea\u5b9a\u4e49\u8bbe\u7f6e\u7684\u7b2c\u4e8c\u4e2a\u6279\u5904\u7406\u5668\u3002\u6279\u5904\u7406\u5668 batch/2 \u5c06\u5728 10 \u79d2\u5185\u7f13\u51b2\u6700\u591a 10000 \u4e2a span\u3001\u6307\u6807\u6570\u636e\u70b9\u6216\u65e5\u5fd7\u8bb0\u5f55\uff0c\u800c\u4e0d\u4f1a\u5206\u5272\u6570\u636e\u9879\u4ee5\u5f3a\u5236\u6267\u884c\u6700\u5927\u6279\u5904\u7406\u5927\u5c0f\u3002</p> <pre><code>processors:\n  batch:\n  batch/2:\n    send_batch_size: 10000\n    timeout: 10s\n</code></pre> <p>\u4e0b\u9762\u7684\u914d\u7f6e\u5c06\u5f3a\u5236\u6267\u884c\u6700\u5927\u6279\u5904\u7406\u5927\u5c0f\u9650\u5236\uff0c\u5373 10000 \u4e2a span\u3001\u6307\u6807\u6570\u636e\u70b9\u6216\u65e5\u5fd7\u8bb0\u5f55\uff0c\u800c\u4e0d\u5f15\u5165\u4efb\u4f55\u4eba\u4e3a\u7684\u5ef6\u8fdf\u3002</p> <pre><code>processors:\n  batch:\n    send_batch_max_size: 10000\n    timeout: 0s\n</code></pre>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#memory_limiter","title":"<code>memory_limiter</code> \u5904\u7406\u5668","text":"<p>\u5185\u5b58\u9650\u5236\u5904\u7406\u5668\u7528\u4e8e\u9632\u6b62\u6536\u96c6\u5668\u7684\u5185\u5b58\u4e0d\u8db3\u60c5\u51b5\u3002\u8003\u8651\u5230\u6536\u96c6\u5668\u5904\u7406\u7684\u6570\u636e\u7684\u6570\u91cf\u548c\u7c7b\u578b\u662f\u73af\u5883\u7279\u5b9a\u7684\uff0c\u5e76\u4e14\u6536\u96c6\u5668\u7684\u8d44\u6e90\u5229\u7528\u7387\u4e5f\u53d6\u51b3\u4e8e\u914d\u7f6e\u7684\u5904\u7406\u5668\uff0c\u56e0\u6b64\u5bf9\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u8fdb\u884c\u68c0\u67e5\u975e\u5e38\u91cd\u8981\u3002</p> <ul> <li><code>memory_limiter</code>\u5904\u7406\u5668\u5141\u8bb8\u5b9a\u671f\u68c0\u67e5\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\uff0c\u5982\u679c\u8d85\u8fc7\u5b9a\u4e49\u7684\u9650\u5236\uff0c\u5c06\u5f00\u59cb\u62d2\u7edd\u6570\u636e\u5e76\u5f3a\u5236 GC \u51cf\u5c11\u5185\u5b58\u6d88\u8017\u3002</li> <li><code>memory_limiter</code> \u4f7f\u7528\u8f6f\u5185\u5b58\u9650\u5236\u548c\u786c\u5185\u5b58\u9650\u5236\uff0c\u786c\u9650\u5236\u59cb\u7ec8\u9ad8\u4e8e\u6216\u7b49\u4e8e\u8f6f\u9650\u5236\u3002</li> </ul> <p>\u5185\u5b58\u4f7f\u7528\u91cf\u968f\u65f6\u95f4\u53d8\u5316\uff0c\u786c\u9650\u5236\u662f\u8fdb\u7a0b\u5806\u5206\u914d\u7684\u6700\u5927\u5185\u5b58\u91cf\uff0c\u8d85\u8fc7\u6b64\u9650\u5236\u5c06\u89e6\u53d1\u5185\u5b58\u9650\u5236\u64cd\u4f5c\u3002\u8f6f\u9650\u5236\u662f\u5185\u5b58\u4f7f\u7528\u91cf\u4e0b\u964d\u5230\u786c\u9650\u5236\u4ee5\u4e0b\u7684\u9608\u503c\uff0c\u6062\u590d\u6b63\u5e38\u64cd\u4f5c\u3002</p> <p>\u6bd4\u5982\u5b9a\u4e49\u786c\u9650\u5236 <code>limit_mib</code> \u4e3a 100 MiB\uff0c\u8f6f\u9650\u5236\u662f 80 MiB\uff0c\u90a3\u4e48 <code>spike_limit_mib</code> \u5219\u4e3a 20 MiB\u3002\u5f53\u5185\u5b58\u4f7f\u7528\u91cf\u8d85\u8fc7\u786c\u9650\u5236\u65f6\uff0c\u5904\u7406\u5668\u5c06\u62d2\u7edd\u63a5\u6536\u6570\u636e\uff0c\u5e76\u5f3a\u5236\u6267\u884c\u5783\u573e\u6536\u96c6\u4ee5\u5c1d\u8bd5\u91ca\u653e\u5185\u5b58\u3002\u5f53\u5185\u5b58\u4f7f\u7528\u91cf\u8d85\u8fc7\u8f6f\u9650\u5236\u65f6\uff0c\u5904\u7406\u5668\u5c06\u8fdb\u5165\u5185\u5b58\u9650\u5236\u6a21\u5f0f\uff0c\u5982\u679c\u5185\u5b58\u4f7f\u7528\u91cf\u4e0b\u964d\u5230\u8f6f\u9650\u5236\u4ee5\u4e0b\uff0c\u5219\u6062\u590d\u6b63\u5e38\u64cd\u4f5c\uff0c\u6570\u636e\u5c06\u4e0d\u518d\u88ab\u62d2\u7edd\uff0c\u5e76\u4e14\u4e0d\u4f1a\u6267\u884c\u5f3a\u5236\u5783\u573e\u6536\u96c6\u3002</p> <p>\u5728\u5185\u5b58\u9650\u5236\u6a21\u5f0f\u4e0b\uff0c\u5904\u7406\u5668\u8fd4\u56de\u7684\u9519\u8bef\u662f\u975e\u6c38\u4e45\u6027\u9519\u8bef\u3002\u5f53\u63a5\u6536\u5668\u65b9\u770b\u5230\u6b64\u9519\u8bef\u65f6\uff0c\u4ed6\u4eec\u4f1a\u91cd\u8bd5\u53d1\u9001\u76f8\u540c\u7684\u6570\u636e\u3002</p> <p>\u5f3a\u70c8\u5efa\u8bae\u5728\u6bcf\u4e2a\u6536\u96c6\u5668\u4e0a\u914d\u7f6e ballast \u6269\u5c55\u4ee5\u53ca <code>memory_limiter</code>\u5904\u7406\u5668\u3002ballast \u6269\u5c55\u5e94\u914d\u7f6e\u4e3a\u5206\u914d\u7ed9\u6536\u96c6\u5668\u7684\u5185\u5b58\u7684 1/3 \u5230 1/2\u3002 <code>memory_limiter</code> \u5904\u7406\u5668\u5e94\u8be5\u662f\u7ba1\u9053\u4e2d\u5b9a\u4e49\u7684\u7b2c\u4e00\u4e2a\u5904\u7406\u5668\uff08\u7d27\u63a5\u5728\u63a5\u6536\u5668\u4e4b\u540e\uff09\u3002\u8fd9\u662f\u4e3a\u4e86\u786e\u4fdd\u53ef\u4ee5\u5c06\u80cc\u538b\u53d1\u9001\u5230\u9002\u7528\u7684\u63a5\u6536\u5668\uff0c\u5e76\u5728\u89e6\u53d1 memory_limiter \u65f6\u5c06\u6570\u636e\u4e22\u5931\u7684\u53ef\u80fd\u6027\u964d\u5230\u6700\u4f4e\u3002</p> <p>\u5185\u5b58\u9650\u5236\u5668\u4e3b\u8981\u7684\u914d\u7f6e\u9009\u9879\u5305\u62ec\u4e0b\u9762\u8fd9\u4e9b\uff1a</p> <ul> <li><code>check_interval</code>\uff08\u9ed8\u8ba4 = 0s\uff09\uff1a\u7528\u4e8e\u6307\u5b9a\u68c0\u67e5\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u7684\u65f6\u95f4\u95f4\u9694\u3002\u6bd4\u5982\u8bbe\u7f6e\u4e3a 5s\uff0c\u8868\u793a\u6bcf 5 \u79d2\u68c0\u67e5\u4e00\u6b21\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u3002</li> <li><code>limit_mib</code>\uff08\u9ed8\u8ba4 = 0\uff09\uff1a\u8fdb\u7a0b\u5806\u5206\u914d\u7684\u6700\u5927\u5185\u5b58\u91cf\uff08\u4ee5 MiB \u4e3a\u5355\u4f4d\uff09\u3002\u8bf7\u6ce8\u610f\uff0c\u901a\u5e38\u8fdb\u7a0b\u7684\u603b\u5185\u5b58\u4f7f\u7528\u91cf\u5c06\u6bd4\u8be5\u503c\u9ad8\u51fa\u7ea6 50MiB\uff0c\u8fd9\u5b9a\u4e49\u4e86\u786c\u9650\u5236\u3002</li> <li><code>spike_limit_mib</code>\uff08\u9ed8\u8ba4 = <code>limit_mib</code> \u7684 20%\uff09\uff1a\u5185\u5b58\u4f7f\u7528\u6d4b\u91cf\u4e4b\u95f4\u9884\u671f\u7684\u6700\u5927\u5cf0\u503c\u3002\u8be5\u503c\u5fc5\u987b\u5c0f\u4e8e<code>limit_mib</code>\u3002\u8f6f\u9650\u5236\u503c\u5c06\u7b49\u4e8e <code>limit_mib</code> - <code>spike_limit_mib</code>\u3002 <code>spike_limit_mib</code> \u7684\u5efa\u8bae\u503c\u7ea6\u4e3a limit_mib \u7684 20%\u3002</li> <li><code>limit_percentage</code>\uff08\u9ed8\u8ba4\u503c = 0\uff09\uff1a\u8fdb\u7a0b\u5806\u8981\u5206\u914d\u7684\u6700\u5927\u603b\u5185\u5b58\u91cf\u3002\u6b64\u914d\u7f6e\u5728\u5177\u6709 cgroup \u7684 Linux \u7cfb\u7edf\u4e0a\u53d7\u652f\u6301\uff0c\u65e8\u5728\u7528\u4e8e\u50cf docker \u8fd9\u6837\u7684\u52a8\u6001\u5e73\u53f0\u3002\u6b64\u9009\u9879\u7528\u4e8e\u6839\u636e\u53ef\u7528\u603b\u5185\u5b58\u8ba1\u7b97\u5185\u5b58\u9650\u5236\u3002\u4f8b\u5982\uff0c\u8bbe\u7f6e\u4e3a 75%\uff0c\u603b\u5185\u5b58\u4e3a 1GiB\uff0c\u5c06\u9650\u5236\u4e3a 750 MiB\u3002\u56fa\u5b9a\u5185\u5b58\u8bbe\u7f6e (<code>limit_mib</code>) \u4f18\u5148\u4e8e\u767e\u5206\u6bd4\u914d\u7f6e\u3002</li> <li><code>spike_limit_percentage</code>\uff08\u9ed8\u8ba4 = 0\uff09\uff1a\u5185\u5b58\u4f7f\u7528\u6d4b\u91cf\u4e4b\u95f4\u9884\u671f\u7684\u6700\u5927\u5cf0\u503c\u3002\u8be5\u503c\u5fc5\u987b\u5c0f\u4e8e <code>limit_percentage</code>\u3002\u8be5\u9009\u9879\u7528\u4e8e\u6839\u636e\u603b\u53ef\u7528\u5185\u5b58\u8ba1\u7b97 <code>spike_limit_mib</code>\u3002\u4f8b\u5982\uff0c\u5982\u679c\u603b\u5185\u5b58\u4e3a 1GiB\uff0c\u5219\u8bbe\u7f6e\u4e3a 25% \u5c06\u5cf0\u503c\u9650\u5236\u4e3a 250MiB\u3002\u6b64\u9009\u9879\u4ec5\u4e0e <code>limit_percentage</code> \u4e00\u8d77\u4f7f\u7528\u3002</li> </ul>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#k8sattributes","title":"k8sattributes \u5904\u7406\u5668","text":"<p>Kubernetes \u5c5e\u6027\u5904\u7406\u5668\u5141\u8bb8\u4f7f\u7528 K8s \u5143\u6570\u636e\u81ea\u52a8\u8bbe\u7f6e\u8ffd\u8e2a\u3001\u6307\u6807\u548c\u65e5\u5fd7\u8d44\u6e90\u5c5e\u6027\u3002\u5f53 k8sattributes \u5904\u7406\u5668\u88ab\u5e94\u7528\u4e8e\u4e00\u4e2a Kubernetes \u96c6\u7fa4\u4e2d\u7684 Pod \u65f6\uff0c\u5b83\u4f1a\u4ece Pod \u7684\u5143\u6570\u636e\u4e2d\u63d0\u53d6\u4e00\u4e9b\u5c5e\u6027\uff0c\u4f8b\u5982 Pod \u7684\u540d\u79f0\u3001UID\u3001\u542f\u52a8\u65f6\u95f4\u7b49\u5176\u4ed6\u5143\u6570\u636e\u3002\u8fd9\u4e9b\u5c5e\u6027\u5c06\u4e0e\u9065\u6d4b\u6570\u636e\u4e00\u8d77\u53d1\u9001\u5230\u540e\u7aef\uff0c\u4ee5\u4fbf\u5728\u5206\u6790\u548c\u8c03\u8bd5\u9065\u6d4b\u6570\u636e\u65f6\u53ef\u4ee5\u66f4\u597d\u5730\u4e86\u89e3\u5b83\u4eec\u6765\u81ea\u54ea\u4e2a Pod\u3002</p> <p>\u5728 k8sattributes \u5904\u7406\u5668\u4e2d\uff0c<code>pod_association</code> \u5c5e\u6027\u5b9a\u4e49\u4e86\u5982\u4f55\u5c06\u9065\u6d4b\u6570\u636e\u4e0e Pod \u76f8\u5173\u8054\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4e00\u4e2a Pod \u53d1\u9001\u4e86\u591a\u4e2a\u9065\u6d4b\u6570\u636e\uff0c\u90a3\u4e48\u8fd9\u4e9b\u9065\u6d4b\u6570\u636e\u5c06\u88ab\u5173\u8054\u5230\u540c\u4e00\u4e2a Pod \u4e0a\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u7684\u5206\u6790\u548c\u8c03\u8bd5\u4e2d\u53ef\u4ee5\u66f4\u597d\u5730\u4e86\u89e3\u5b83\u4eec\u6765\u81ea\u54ea\u4e2a Pod\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u7684\u5904\u7406\u5668\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>k8sattributes:\n  extract:\n    metadata: # \u5217\u51fa\u8981\u4ecek8s\u4e2d\u63d0\u53d6\u7684\u5143\u6570\u636e\u5c5e\u6027\n      - k8s.namespace.name\n      - k8s.deployment.name\n      - k8s.statefulset.name\n      - k8s.daemonset.name\n      - k8s.cronjob.name\n      - k8s.job.name\n      - k8s.node.name\n      - k8s.pod.name\n      - k8s.pod.uid\n      - k8s.pod.start_time\n  filter: # \u53ea\u6709\u6765\u81ea\u4e0e\u8be5\u503c\u5339\u914d\u7684\u8282\u70b9\u7684\u6570\u636e\u5c06\u88ab\u8003\u8651\u3002\n    node_from_env_var: K8S_NODE_NAME\n  passthrough: false # \u8868\u793a\u5904\u7406\u5668\u4e0d\u4f1a\u4f20\u9012\u4efb\u4f55\u4e0d\u7b26\u5408\u8fc7\u6ee4\u6761\u4ef6\u7684\u6570\u636e\u3002\n  pod_association:\n    - sources:\n        - from: resource_attribute # from \u8868\u793a\u89c4\u5219\u7c7b\u578b\n          name: k8s.pod.ip\n    - sources:\n        - from: resource_attribute # resource_attribute \u8868\u793a\u4ece\u63a5\u6536\u5230\u7684\u8d44\u6e90\u7684\u5c5e\u6027\u5217\u8868\u4e2d\u67e5\u627e\u7684\u5c5e\u6027\u540d\u79f0\n          name: k8s.pod.uid\n    - sources:\n        - from: connection\n</code></pre> <p>\u5176\u4e2d extract \u9009\u9879\u5217\u51fa\u8981\u4ece Kubernetes \u4e2d\u63d0\u53d6\u7684\u5143\u6570\u636e\u5c5e\u6027\uff0c\u6211\u4eec\u8fd9\u91cc\u5305\u62ec\u547d\u540d\u7a7a\u95f4\u3001Deployment\u3001StatefulSet\u3001DaemonSet\u3001CronJob\u3001Job\u3001Node\u3001Pod \u540d\u79f0\u3001Pod UID \u548c Pod \u542f\u52a8\u65f6\u95f4\u3002 filter \u5c5e\u6027\u6307\u5b9a\u4ec5\u8003\u8651\u540d\u79f0\u4e0e <code>K8S_NODE_NAME</code> \u73af\u5883\u53d8\u91cf\u7684\u503c\u5339\u914d\u7684\u8282\u70b9\u7684\u6570\u636e\u3002</p> <p>passthrough\u9009\u9879\u8bbe\u7f6e\u4e3a false\uff0c\u8fd9\u610f\u5473\u7740\u5904\u7406\u5668\u4e0d\u4f1a\u4f20\u9012\u4efb\u4f55\u4e0d\u7b26\u5408\u8fc7\u6ee4\u6761\u4ef6\u7684\u6570\u636e\u3002</p> <p>\u6700\u540e\uff0c<code>pod_association</code> \u9009\u9879\u5b9a\u4e49\u4e86\u5982\u4f55\u5c06\u4ece Kubernetes \u4e2d\u63d0\u53d6\u7684 Pod \u5143\u6570\u636e\u4e0e\u9065\u6d4b\u6570\u636e\u5173\u8054\u8d77\u6765\u3002\u5728\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c<code>pod_association</code> \u5c5e\u6027\u5b9a\u4e49\u4e86\u4e09\u4e2a\u5173\u8054\u6e90\uff0c\u5206\u522b\u662f <code>k8s.pod.ip</code>\u3001<code>k8s.pod.uid</code> \u548c <code>connection</code>\u3002</p> <ul> <li>\u7b2c\u4e00\u4e2a\u5173\u8054\u6e90\u662f <code>k8s.pod.ip</code>\uff0c\u5b83\u4f7f\u7528 Pod IP \u4f5c\u4e3a\u5173\u8054\u7684\u6765\u6e90\u3002\u8fd9\u610f\u5473\u7740\u4ece\u540c\u4e00\u4e2a Pod IP \u53d1\u9001\u7684\u6240\u6709\u9065\u6d4b\u6570\u636e\u90fd\u5c06\u4e0e\u540c\u4e00\u4e2a Pod \u5173\u8054\u8d77\u6765\u3002</li> <li>\u7b2c\u4e8c\u4e2a\u5173\u8054\u6e90\u662f <code>k8s.pod.uid</code>\uff0c\u5b83\u4f7f\u7528 Pod UID \u4f5c\u4e3a\u5173\u8054\u7684\u6765\u6e90\u3002\u8fd9\u610f\u5473\u7740\u4ece\u540c\u4e00\u4e2a Pod UID \u53d1\u9001\u7684\u6240\u6709\u9065\u6d4b\u6570\u636e\u90fd\u5c06\u4e0e\u540c\u4e00\u4e2a Pod \u5173\u8054\u8d77\u6765\u3002</li> <li>\u7b2c\u4e09\u4e2a\u5173\u8054\u6e90\u662f <code>connection</code>\uff0c\u5b83\u4f7f\u7528\u8fde\u63a5\u4fe1\u606f\u4f5c\u4e3a\u5173\u8054\u7684\u6765\u6e90\u3002\u8fd9\u610f\u5473\u7740\u4ece\u540c\u4e00\u4e2a\u8fde\u63a5\u53d1\u9001\u7684\u6240\u6709\u9065\u6d4b\u6570\u636e\u90fd\u5c06\u4e0e\u540c\u4e00\u4e2a Pod \u5173\u8054\u8d77\u6765\u3002</li> </ul> <p>\u5982\u679c\u672a\u914d\u7f6e Pod \u5173\u8054\u89c4\u5219\uff0c\u5219\u8d44\u6e90\u4ec5\u901a\u8fc7\u8fde\u63a5\u7684 IP \u5730\u5740\u4e0e\u5143\u6570\u636e\u5173\u8054\u3002</p> <p>\u901a\u8fc7\u8fd9\u4e9b\u5173\u8054\u6e90\uff0c<code>pod_association</code> \u5c5e\u6027\u53ef\u4ee5\u786e\u4fdd\u9065\u6d4b\u6570\u636e\u4e0e\u6b63\u786e\u7684 Pod \u76f8\u5173\u8054\uff0c\u4ece\u800c\u4f7f\u5f97\u5728\u5206\u6790\u548c\u8c03\u8bd5\u9065\u6d4b\u6570\u636e\u65f6\u66f4\u52a0\u65b9\u4fbf\u548c\u51c6\u786e\u3002</p> <p>\u8981\u6536\u96c6\u7684\u5143\u6570\u636e\u7531\u5b9a\u4e49\u7684\u5143\u6570\u636e\u914d\u7f6e\u786e\u5b9a\uff0c\u8be5\u914d\u7f6e\u5b9a\u4e49\u4e86\u8981\u6dfb\u52a0\u7684\u8d44\u6e90\u5c5e\u6027\u5217\u8868\u3002\u5217\u8868\u4e2d\u7684\u9879\u4e0e\u5c06\u8981\u6dfb\u52a0\u7684\u8d44\u6e90\u5c5e\u6027\u540d\u79f0\u5b8c\u5168\u76f8\u540c\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6dfb\u52a0\u4ee5\u4e0b\u5c5e\u6027\uff1a</p> <ul> <li>k8s.namespace.name</li> <li>k8s.pod.name</li> <li>k8s.pod.uid</li> <li>k8s.pod.start_time</li> <li>k8s.deployment.name</li> <li>k8s.node.name</li> </ul> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528 metadata \u914d\u7f6e\u66f4\u6539\u6b64\u5217\u8868\u3002\u5e76\u975e\u6240\u6709\u5c5e\u6027\u90fd\u80fd\u591f\u88ab\u6dfb\u52a0\u3002\u53ea\u6709\u6765\u81ea metadata \u7684\u5c5e\u6027\u540d\u79f0\u5e94\u8be5\u7528\u4e8e <code>pod_association</code> \u7684 <code>resource_attribute</code>\uff0c\u7a7a\u503c\u6216\u4e0d\u5b58\u5728\u7684\u503c\u5c06\u4f1a\u88ab\u5ffd\u7565\u3002</p> <p>\u6b64\u5916 k8sattributesprocessor \u8fd8\u53ef\u4ee5\u901a\u8fc7 pod \u548c\u547d\u540d\u7a7a\u95f4\u7684\u6807\u7b7e\u548c\u6ce8\u89e3\u6765\u8bbe\u7f6e\u8d44\u6e90\u5c5e\u6027\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#metricstransform","title":"metricstransform \u5904\u7406\u5668","text":"<p>\u6307\u6807\u8f6c\u6362\u5904\u7406\u5668\u53ef\u7528\u4e8e\u91cd\u547d\u540d\u6307\u6807\uff0c\u4ee5\u53ca\u6dfb\u52a0\u3001\u91cd\u547d\u540d\u6216\u5220\u9664\u6807\u7b7e\u952e\u548c\u503c\u3002\u5b83\u8fd8\u53ef\u7528\u4e8e\u8de8\u6807\u7b7e\u6216\u6807\u7b7e\u503c\u5bf9\u6307\u6807\u6267\u884c\u7f29\u653e\u548c\u805a\u5408\u3002\u4e0b\u8868\u63d0\u4f9b\u4e86\u53ef\u5e94\u7528\u4e8e\u4e00\u4e2a\u6216\u591a\u4e2a\u6307\u6807\u7684\u53d7\u652f\u6301\u64cd\u4f5c\u7684\u5b8c\u6574\u5217\u8868\u3002</p> <pre><code>\u64cd\u4f5c    \u793a\u4f8b (\u57fa\u4e8e\u6307\u6807 system.cpu.usage)\n\nRename metrics      \u91cd\u547d\u540d system.cpu.usage_time\n\nAdd labels          \u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u6807\u7b7e identifirer \u503c\u4e3a 1\n\nRename label keys       \u91cd\u547d\u540d\u6807\u7b7e state \u4e3a cpu_state\n\nRename label values     \u5bf9\u4e8e\u6807\u7b7e state, \u5c06\u503c idle \u91cd\u547d\u540d\u4e3a -\n\nDelete data points      \u5220\u9664\u6807\u7b7e\u4e3a state=idle \u7684\u6240\u6709\u6570\u636e\u70b9\n\nToggle data type        \u4ece int \u6570\u636e\u70b9\u66f4\u6539\u4e3a double \u6570\u636e\u70b9\n\nScale value     \u5c06\u503c\u4e58\u4ee5 1000\uff0c\u4ece\u79d2\u8f6c\u6362\u4e3a\u6beb\u79d2\u3002\n\nAggregate across label sets     \u4ec5\u4fdd\u7559\u6807\u7b7e state\uff0c\u5bf9\u8be5\u6807\u7b7e\u5177\u6709\u76f8\u540c\u503c\u7684\u6240\u6709\u70b9\u6c42\u5e73\u5747\u503c\n\nAggregate across label values       \u6807\u7b7estate\uff0c\u5c06\u503c\u4e3a user \u6216 system \u7684\u70b9\u6c42\u548c\uff0c\u5e76\u8d4b\u7ed9used = user + system\u3002\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u7684\u6dfb\u52a0\u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>metricstransform:\n  transforms:\n    action: update\n    include: .+\n    match_type: regexp\n    operations:\n      - action: add_label\n        new_label: k8s.cluster.id\n        new_value: abcd1234\n      - action: add_label\n        new_label: k8s.cluster.name\n        new_value: youdian-k8s\n</code></pre> <p>\u8868\u793a\u6211\u4eec\u4f1a\u5bf9\u6240\u6709\u7684\u6307\u6807\u6dfb\u52a0 <code>k8s.cluster.id</code> \u548c <code>k8s.cluster.name</code> \u4e24\u4e2a\u6807\u7b7e\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#logging","title":"logging \u5bfc\u51fa\u5668","text":"<p>\u65e5\u5fd7\u5bfc\u51fa\u5668\uff0c\u7528\u4e8e\u5c06\u6570\u636e\u5bfc\u51fa\u5230\u6807\u51c6\u8f93\u51fa\uff0c\u4e3b\u8981\u7528\u4e8e\u8c03\u8bd5\u9636\u6bb5\u3002</p>"},{"location":"chap_ot/1OpenTelemetry_k8s_metrics/#prometheus_1","title":"prometheus \u5bfc\u51fa\u5668","text":"<p>Prometheus \u5bfc\u51fa\u5668\uff0c\u8be5\u5bfc\u51fa\u5668\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u7aef\u70b9\uff0c\u5c06\u4ece\u63a5\u6536\u5668\u63a5\u6536\u5230\u7684\u6307\u6807\u6570\u636e\u901a\u8fc7\u8fd9\u4e2a\u7aef\u70b9\u8fdb\u884c\u5bfc\u51fa\uff0c\u8fd9\u6837 Prometheus \u53ea\u9700\u8981\u4ece\u8fd9\u4e2a\u7aef\u70b9\u62c9\u53d6\u6570\u636e\u5373\u53ef\u3002\u800c <code>prometheusremotewrite</code> \u5bfc\u51fa\u5668\u5219\u662f\u5c06\u6307\u6807\u6570\u636e\u76f4\u63a5\u8fdc\u7a0b\u5199\u5165\u5230\u6307\u5b9a\u7684\u5730\u5740\uff0c\u8fd9\u4e2a\u5730\u5740\u662f\u652f\u6301 Prometheus \u8fdc\u7a0b\u5199\u5165\u534f\u8bae\u7684\u5730\u5740\u3002\uff08\u7ecf\u6d4b\u8bd5\u5f53\u524d\u7248\u672c\u8fdc\u7a0b\u5199\u5165\u7684\u5bfc\u51fa\u5668\u6709\u4e00\u5b9a\u95ee\u9898\uff09</p> <p>\u6211\u4eec\u8fd9\u91cc\u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>prometheus:\n  endpoint: 0.0.0.0:9090\n  metric_expiration: 180m\n  resource_to_telemetry_conversion:\n    enabled: true\n</code></pre> <ul> <li>endpoint\uff1a\u6307\u6807\u5c06\u901a\u8fc7\u8def\u5f84 <code>/metrics</code> \u66b4\u9732\u7684\u5730\u5740\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u60f3\u901a\u8fc7\u4e0a\u9762\u5730\u5740\u6765\u8bbf\u95ee\u6307\u6807\u6570\u636e\uff0c\u6211\u4eec\u8fd9\u91cc\u8868\u793a\u60f3\u5728 9090 \u7aef\u53e3\u6765\u66b4\u9732\u6307\u6807\u6570\u636e\u3002</li> <li><code>metric_expiration</code>\uff08\u9ed8\u8ba4\u503c= 5m\uff09\uff1a\u5b9a\u4e49\u4e86\u5728\u6ca1\u6709\u66f4\u65b0\u7684\u60c5\u51b5\u4e0b\u66b4\u9732\u7684\u6307\u6807\u7684\u65f6\u95f4\u957f\u5ea6\u3002</li> <li><code>resource_to_telemetry_conversion</code>\uff08\u9ed8\u8ba4\u4e3a false\uff09\uff1a\u5982\u679c\u542f\u7528\u4e3a true\uff0c\u5219\u6240\u6709\u8d44\u6e90\u5c5e\u6027\u5c06\u9ed8\u8ba4\u8f6c\u6362\u4e3a\u6307\u6807\u6807\u7b7e\u3002</li> </ul> <p>\u6240\u4ee5\u6700\u540e\u6211\u4eec\u53ef\u4ee5\u5728 Prometheus \u4e2d\u53bb\u91c7\u96c6 OpenTelemetry Collector \u5728 9090 \u7aef\u53e3\u66b4\u9732\u7684\u6307\u6807\u6570\u636e\uff0c\u53ea\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 ServiceMonitor \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: otel-prom\n  namespace: kube-otel\n  labels:\n    release: prometheus\nspec:\n  endpoints:\n    - interval: 10s\n      port: prom # \u6211\u4eec\u5728helm values \u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a prom \u7684 Service \u7aef\u53e3\n      path: metrics\n  selector:\n    matchLabels:\n      component: agent-collector\n      app.kubernetes.io/instance: opentelemetry-collector\n</code></pre> <p>\u521b\u5efa\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Prometheus \u4e2d\u627e\u5230 OpenTelemetry Collector \u66b4\u9732\u7684\u6307\u6807\u6570\u636e\u4e86\u3002</p> <p></p> <p>\u91c7\u96c6\u5230\u7684\u6307\u6807\u91cc\u9762\u5305\u542b\u4e86\u5f88\u591a\u7684\u6807\u7b7e\uff0c\u8fd9\u4e9b\u6807\u7b7e\u90fd\u662f\u901a\u8fc7\u6211\u4eec\u524d\u9762\u5b9a\u4e49\u7684\u5904\u7406\u5668\u6dfb\u52a0\u7684\uff0c\u6bd4\u5982\uff1a</p> <p></p> <p>\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 Grafana \u6765\u67e5\u8be2\u8fd9\u4e9b\u6307\u6807\u6570\u636e\uff1a</p> <p></p>"},{"location":"chap_ot/2OpenTelemetry_MS/","title":"5 \u4f7f\u7528 OpenTelemetry Tracing \u4e86\u89e3\u60a8\u7684\u5fae\u670d\u52a1","text":"<p>\u5fae\u670d\u52a1\u67b6\u6784\u5177\u6709\u8bf8\u591a\u4f18\u52bf\uff0c\u5305\u62ec\u589e\u5f3a\u56e2\u961f\u81ea\u4e3b\u6027\u3001\u63d0\u9ad8\u6269\u5c55\u4e0e\u90e8\u7f72\u7075\u6d3b\u6027\u3002\u4f46\u7f3a\u70b9\u662f\uff0c\u7cfb\u7edf\u4e2d\u7684\u670d\u52a1\u8d8a\u591a\uff08\u4e00\u4e2a\u5fae\u670d\u52a1\u5e94\u7528\u53ef\u80fd\u5305\u542b\u51e0\u5341\u4e2a\u751a\u81f3\u51e0\u767e\u4e2a\u670d\u52a1\uff09\uff0c\u6e05\u6670\u5730\u4e86\u89e3\u7cfb\u7edf\u603b\u4f53\u8fd0\u884c\u60c5\u51b5\u7684\u96be\u5ea6\u5c31\u8d8a\u5927\u3002</p> <p>\u4f5c\u4e3a\u590d\u6742\u8f6f\u4ef6\u7cfb\u7edf\u7684\u7f16\u5199\u8005\u548c\u7ef4\u62a4\u8005\uff0c\u6211\u4eec\u6df1\u77e5\u638c\u63e1\u7cfb\u7edf\u8fd0\u884c\u60c5\u51b5\u7684\u91cd\u8981\u6027\u3002\u53ef\u89c2\u6d4b\u6027\u5de5\u5177\u53ef\u5e2e\u52a9\u6211\u4eec\u6e05\u6670\u5730\u4e86\u89e3\u4f17\u591a\u670d\u52a1\u548c\u652f\u6301\u57fa\u7840\u8bbe\u65bd\u3002</p> <p>\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u4eec\u5c06\u91cd\u70b9\u4ecb\u7ecd\u5fae\u670d\u52a1\u5e94\u7528\u7684\u4e00\u79cd\u975e\u5e38\u91cd\u8981\u7684\u53ef\u89c2\u6d4b\u6027\u5de5\u5177\uff1a\u94fe\u8def\u8ffd\u8e2a\uff08tracing\uff09\u3002</p> <p>\u5728\u6b65\u5165\u6b63\u9898\u4e4b\u524d\uff0c\u8ba9\u6211\u4eec\u5148\u5b9a\u4e49\u4e00\u4e0b\u8ba8\u8bba\u53ef\u89c2\u6d4b\u6027\u65f6\u901a\u5e38\u4f1a\u7528\u5230\u7684\u4e00\u4e9b\u672f\u8bed\uff1a</p> <ul> <li>\u53ef\u89c2\u6d4b\u6027\u2014\u4ec5\u57fa\u4e8e\u5bf9\u590d\u6742\u7cfb\u7edf\uff08\u5982\u5fae\u670d\u52a1\u5e94\u7528\uff09\u7684\u5916\u90e8\u8f93\u51fa\uff08\u5982\u94fe\u8def\u8ffd\u8e2a\u3001\u65e5\u5fd7\u548c\u6307\u6807\uff09\u7684\u4e86\u89e3\u5c31\u80fd\u83b7\u6089\u5176\u5185\u90e8\u72b6\u6001\u6216\u72b6\u51b5\u7684\u80fd\u529b\u3002</li> <li>\u76d1\u63a7\u2014\u89c2\u6d4b\u5e76\u68c0\u67e5\u5bf9\u8c61\u5728\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u8fdb\u5ea6\u6216\u72b6\u6001\u7684\u80fd\u529b\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u76d1\u63a7\u5728\u9ad8\u5cf0\u65f6\u6bb5\u4f20\u5165\u5e94\u7528\u7684\u6d41\u91cf\uff0c\u5e76\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u5bf9\u5e94\u7528\u8fdb\u884c\u76f8\u5e94\u7684\u6269\u5c55\u3002</li> <li>\u9065\u6d4b\u2014\u6536\u96c6\u6307\u6807\u3001\u94fe\u8def\u8ffd\u8e2a\u548c\u65e5\u5fd7\uff0c\u5e76\u5c06\u5b83\u4eec\u4ece\u6e90\u70b9\u8f6c\u79fb\u5230\u53e6\u4e00\u4e2a\u7cfb\u7edf\u8fdb\u884c\u5b58\u50a8\u548c\u5206\u6790\u7684\u884c\u4e3a\u3002\u6709\u65f6\uff0c\u9065\u6d4b\u8fd8\u6307\u6570\u636e\u672c\u8eab\u3002</li> <li>\u94fe\u8def\u8ffd\u8e2a\u2014\u8bb0\u5f55\u8bf7\u6c42\u6216\u64cd\u4f5c\u901a\u8fc7\u5206\u5e03\u5f0f\u7cfb\u7edf\u6240\u6709\u8282\u70b9\u7684\u8fc7\u7a0b\u3002</li> <li>Span\u2014\u4e00\u9879\u64cd\u4f5c\u94fe\u8def\u8ffd\u8e2a\u4e2d\u7684\u8bb0\u5f55\u53ca\u5176\u76f8\u5173\u5143\u6570\u636e\u3002\u94fe\u8def\u8ffd\u8e2a\u7531\u8bb8\u591a\u5d4c\u5957\u7684 span \u7ec4\u6210\u3002</li> <li>\u4e8b\u4ef6\u8bb0\u5f55/\u65e5\u5fd7\u2014\u5e26\u65f6\u95f4\u6233\u7684\u6587\u672c\u8bb0\u5f55\uff0c\u5305\u542b\u5143\u6570\u636e\u3002</li> <li>\u6307\u6807\u2014\u5728\u8fd0\u884c\u65f6\u6355\u83b7\u7684\u5ea6\u91cf\u503c\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u5e94\u7528\u5728\u67d0\u4e00\u65f6\u95f4\u70b9\u5360\u7528\u7684\u5185\u5b58\u91cf\u3002</li> </ul> <p>\u6211\u4eec\u53ef\u501f\u52a9\u6240\u6709\u8fd9\u4e9b\u6982\u5ff5\u6765\u4e86\u89e3\u5fae\u670d\u52a1\u7684\u6027\u80fd\u3002\u94fe\u8def\u8ffd\u8e2a\u662f\u53ef\u89c2\u6d4b\u6027\u7b56\u7565\u4e2d\u7279\u522b\u6709\u7528\u7684\u90e8\u5206\uff0c\u56e0\u4e3a\u94fe\u8def\u8ffd\u8e2a\u63d0\u4f9b\u4e86\u53d1\u51fa\u8bf7\u6c42\u65f6\u591a\u4e2a\u901a\u5e38\u677e\u6563\u8026\u5408\u7684\u7ec4\u4ef6\u4e4b\u95f4\u7684\u201c\u5168\u5c40\u89c6\u56fe\u201d\u3002</p> <p>\u8fd9\u4e5f\u662f\u8bc6\u522b\u6027\u80fd\u74f6\u9888\u7684\u4e00\u79cd\u5c24\u4e3a\u9ad8\u6548\u7684\u65b9\u6cd5\u3002</p> <p>\u672c\u6559\u7a0b\u4f7f\u7528\u4e86\u6765\u81ea OpenTelemetry (OTel) \u7684\u94fe\u8def\u8ffd\u8e2a\u5de5\u5177\u5957\u4ef6\uff0cOTel \u662f\u4e00\u5957\u7528\u4e8e\u6536\u96c6\u3001\u5904\u7406\u5e76\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\u7684\u5382\u5546\u4e2d\u7acb\u7684\u5f00\u6e90\u6807\u51c6\uff0c\u6b63\u5feb\u901f\u88ab\u5e7f\u6cdb\u91c7\u7528\u3002</p> <p>\u5728 OTel \u7684\u6982\u5ff5\u4e2d\uff0c\u94fe\u8def\u8ffd\u8e2a\u5c06\u4e00\u4e2a\u53ef\u80fd\u5305\u62ec\u591a\u4e2a\u670d\u52a1\u7684\u6570\u636e\u6d41\u5206\u6210\u4e86\u4e00\u7cfb\u5217\u6309\u65f6\u95f4\u987a\u5e8f\u6392\u5217\u7684\u6570\u636e\u5757\uff0c\u4ee5\u4fbf\u4e8e\u60a8\u7406\u89e3\uff1a</p> <ul> <li>\u5728\u6570\u636e\u5757\u4e2d\u6267\u884c\u7684\u6240\u6709\u6b65\u9aa4</li> <li>\u6267\u884c\u6240\u6709\u8fd9\u4e9b\u6b65\u9aa4\u82b1\u8d39\u7684\u65f6\u95f4</li> <li>\u5173\u4e8e\u6bcf\u4e2a\u6b65\u9aa4\u7684\u5143\u6570\u636e</li> </ul>"},{"location":"chap_ot/2OpenTelemetry_MS/#_1","title":"\u6559\u7a0b\u6982\u8ff0","text":"<p>\u672c\u6559\u7a0b\u4e3b\u8981\u4ecb\u7ecd\u4e86\u5982\u4f55\u5229\u7528 OTel \u6765\u8ddf\u8e2a\u5fae\u670d\u52a1\u5e94\u7528\u7684\u64cd\u4f5c\u3002\u5728\u672c\u6559\u7a0b\u7684\u56db\u4e2a\u6311\u6218\u4e2d\uff0c\u60a8\u5c06\u5b66\u4e60\u5982\u4f55\u8ddf\u8e2a\u901a\u8fc7\u7cfb\u7edf\u7684\u8bf7\u6c42\u5e76\u89e3\u51b3\u6709\u5173\u81ea\u8eab\u5fae\u670d\u52a1\u7684\u95ee\u9898\uff1a</p> <ul> <li>\u8bbe\u7f6e\u57fa\u672c OTel \u57cb\u70b9\uff08instrumentation\uff09</li> <li>\u4e3a\u6240\u6709\u670d\u52a1\u8bbe\u7f6e OTel \u57cb\u70b9\u548c\u94fe\u8def\u8ffd\u8e2a\u53ef\u89c6\u5316</li> <li>\u5b66\u4e60\u89e3\u8bfb OTel \u94fe\u8def\u8ffd\u8e2a</li> <li>\u6839\u636e\u94fe\u8def\u8ffd\u8e2a\u89e3\u8bfb\u4f18\u5316\u57cb\u70b9</li> </ul> <p>\u4ee5\u4e0b\u6311\u6218\u4ecb\u7ecd\u4e86\u5728\u9996\u6b21\u8bbe\u7f6e\u94fe\u8def\u8ffd\u8e2a\u65f6\u6211\u4eec\u63a8\u8350\u4f7f\u7528\u7684\u6d41\u7a0b\u3002\u5177\u4f53\u6b65\u9aa4\uff1a</p> <ul> <li>\u4e86\u89e3\u7cfb\u7edf\u4ee5\u53ca\u60a8\u6b63\u5728\u76d1\u6d4b\u7684\u7279\u5b9a\u64cd\u4f5c\u3002</li> <li>\u786e\u5b9a\u60a8\u9700\u8981\u4ece\u8fd0\u884c\u7cfb\u7edf\u4e2d\u83b7\u53d6\u7684\u4fe1\u606f\u3002</li> <li>\u5bf9\u7cfb\u7edf\u8fdb\u884c\u539f\u751f\u76d1\u6d4b\uff08\u8fd9\u610f\u5473\u7740\u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\uff0c\u4e0d\u8981\u8bd5\u56fe\u5220\u9664\u60a8\u4e0d\u9700\u8981\u7684\u4fe1\u606f\u6216\u6536\u96c6\u81ea\u5b9a\u4e49\u6570\u636e\u70b9\uff09\uff0c\u5e76\u8bc4\u4f30\u76d1\u6d4b\u662f\u5426\u6709\u52a9\u4e8e\u60a8\u89e3\u51b3\u95ee\u9898\u3002</li> <li>\u8c03\u6574\u62a5\u544a\u7684\u4fe1\u606f\uff0c\u4ee5\u4fbf\u66f4\u5feb\u5730\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u3002</li> </ul>"},{"location":"chap_ot/2OpenTelemetry_MS/#_2","title":"\u6559\u7a0b\u67b6\u6784\u548c\u9065\u6d4b\u76ee\u6807","text":""},{"location":"chap_ot/2OpenTelemetry_MS/#_3","title":"\u67b6\u6784\u548c\u7528\u6237\u6d41","text":"<p>\u4e0b\u56fe\u663e\u793a\u4e86\u672c\u6559\u7a0b\u4e2d\u6240\u7528\u7684\u5fae\u670d\u52a1\u53ca\u5176\u4ed6\u5143\u7d20\u4e4b\u95f4\u7684\u6574\u4f53\u67b6\u6784\u548c\u6570\u636e\u6d41\u3002</p> <p></p> <p>\u4e24\u79cd\u5fae\u670d\u52a1\u5982\u4e0b\uff1a</p> <ul> <li>\u4fe1\u4f7f\uff08messenger\uff09\u670d\u52a1(https://github.com/microservices-march/messenger) - \u4e00\u4e2a\u7b80\u5355\u7684\u804a\u5929 API\uff0c\u5177\u6709\u6d88\u606f\u5b58\u50a8\u529f\u80fd</li> <li>\u901a\u77e5\u5668\uff08notifier\uff09\u670d\u52a1(https://github.com/microservices-march/notifier) - \u4e00\u4e2a\u6839\u636e\u7528\u6237\u504f\u597d\u89e6\u53d1\u4e8b\u4ef6\u4ee5\u63d0\u9192\u7528\u6237\u7684\u76d1\u542c\u5668</li> </ul> <p>\u4e09\u79cd\u652f\u6301\u57fa\u7840\u67b6\u6784\u5305\u62ec\uff1a</p> <ul> <li>NGINX \u5f00\u6e90\u7248 - \u901a\u5f80\u4fe1\u4f7f\u670d\u52a1\u548c\u6574\u4e2a\u7cfb\u7edf\u7684\u5165\u53e3\u70b9</li> <li>RabbitMQ - \u4e00\u4e2a\u5e38\u7528\u7684\u5f00\u6e90\u6d88\u606f\u4ee3\u7406\uff0c\u652f\u6301\u670d\u52a1\u5f02\u6b65\u901a\u4fe1</li> <li>Jaeger - \u4e00\u4e2a\u5f00\u6e90\u7684\u7aef\u5230\u7aef\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u7528\u4e8e\u4ece\u76f8\u5173\u7cfb\u7edf\u7ec4\u4ef6\u4e2d\u6536\u96c6\u9065\u6d4b\u6570\u636e\u5e76\u5b9e\u73b0\u53ef\u89c6\u5316\u67e5\u770b\u3002</li> </ul> <p>\u73b0\u5728\u6682\u65f6\u628a OTel \u6401\u7f6e\u8111\u540e\uff0c\u91cd\u70b9\u4ecb\u7ecd\u4e0b\u6211\u4eec\u6b63\u5728\u8ddf\u8e2a\u7684\u4e8b\u4ef6\u5e8f\u5217\uff0c\u5373\u5f53\u7528\u6237\u53d1\u9001\u65b0\u7684\u804a\u5929\u6d88\u606f\u5e76\u4e14\u63a5\u6536\u8005\u6536\u5230\u76f8\u5173\u901a\u77e5\u65f6\u4f1a\u53d1\u751f\u4ec0\u4e48\u3002</p> <p></p> <p>\u6d41\u7a0b\u5206\u89e3\u5982\u4e0b\uff1a</p> <ul> <li>\u7528\u6237\u5411\u4fe1\u4f7f\u670d\u52a1\u53d1\u9001\u6d88\u606f\u3002NGINX \u53cd\u5411\u4ee3\u7406\u62e6\u622a\u6d88\u606f\uff0c\u5e76\u5c06\u5176\u8f6c\u53d1\u7ed9\u4fe1\u4f7f\u5e76\u5c06\u5176\u8f6c\u53d1\u7ed9\u4fe1\u4f7f\u670d\u52a1\u7684\u4f17\u591a\u5b9e\u4f8b\u4e4b\u4e00\u3002</li> <li>\u4fe1\u4f7f\u670d\u52a1\u5c06\u65b0\u6d88\u606f\u5199\u5165\u5176\u6570\u636e\u5e93\u3002</li> <li>\u4fe1\u4f7f\u670d\u52a1\u5728\u540d\u4e3a <code>chat_queue</code> \u7684 RabbitMQ \u6d88\u606f\u961f\u5217\u4e0a\u751f\u6210\u4e00\u4e2a\u4e8b\u4ef6\uff0c\u4ee5\u8868\u660e\u6d88\u606f\u5df2\u53d1\u9001\u3002\u8be5\u4e8b\u4ef6\u4e3a\u666e\u901a\u4e8b\u4ef6\uff0c\u65e0\u5177\u4f53\u76ee\u6807\u3002</li> <li>\u4e0e\u6b64\u540c\u65f6\uff1a<ul> <li>4a. \u4fe1\u4f7f\u4fe1\u4f7f\u670d\u52a1\u5411\u53d1\u9001\u8005\u8fd4\u56de\u4e00\u4e2a\u54cd\u5e94\uff0c\u62a5\u544a\u8be5\u6d88\u606f\u5df2\u6210\u529f\u53d1\u9001\u3002</li> <li>4b. \u901a\u77e5\u5668\u670d\u52a1\u6ce8\u610f\u5230 <code>chat_queue</code> \u4e0a\u7684\u65b0\u4e8b\u4ef6\uff0c\u5e76\u4f7f\u7528\u8be5\u4e8b\u4ef6\u3002</li> </ul> </li> <li>\u901a\u77e5\u5668\u670d\u52a1\u5728\u5176\u6570\u636e\u5e93\u4e2d\u67e5\u770b\u65b0\u6d88\u606f\u63a5\u6536\u8005\u7684\u901a\u77e5\u504f\u597d\u3002</li> <li>\u901a\u77e5\u5668\u670d\u52a1\u4f7f\u7528\u63a5\u6536\u8005\u9996\u9009\u7684\u65b9\u6cd5\u53d1\u9001\u4e00\u4e2a\u6216\u591a\u4e2a\u901a\u77e5\uff08\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u9009\u62e9\u7684\u65b9\u6cd5\u662f\u77ed\u4fe1\u548c\u7535\u5b50\u90ae\u4ef6)\u3002</li> </ul>"},{"location":"chap_ot/2OpenTelemetry_MS/#_4","title":"\u9065\u6d4b\u76ee\u6807","text":"<p>\u5728\u8bbe\u7f6e\u9065\u6d4b\u5de5\u5177\u65f6\uff0c\u6700\u597d\u5148\u786e\u5b9a\u4e00\u7ec4\u660e\u786e\u7684\u76d1\u6d4b\u76ee\u6807\uff0c\u800c\u4e0d\u662f\u201c\u53d1\u9001\u6240\u6709\u5185\u5bb9\uff0c\u5e0c\u671b\u83b7\u5f97\u6d1e\u5bdf\u201d\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u4eec\u6709\u4e09\u4e2a\u4e3b\u8981\u7684\u9065\u6d4b\u76ee\u6807\uff1a</p> <ol> <li>\u4e86\u89e3\u4e00\u4e2a\u8bf7\u6c42\u5728\u65b0\u6d88\u606f\u6d41\u671f\u95f4\u6240\u7ecf\u5386\u7684\u6240\u6709\u6b65\u9aa4\u3002</li> <li>\u786e\u4fe1\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u6d88\u606f\u6d41\u53ef\u5728\u4e94\u79d2\u949f\u5185\u7aef\u5230\u7aef\u6267\u884c\u5b8c\u6bd5\u3002</li> <li>\u67e5\u770b\u901a\u77e5\u5668\u670d\u52a1\u5728\u591a\u957f\u65f6\u95f4\u4e4b\u540e\u624d\u5f00\u59cb\u5904\u7406\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684\u4e8b\u4ef6\uff08\u5ef6\u8fdf\u8fc7\u957f\u53ef\u80fd\u610f\u5473\u7740\u901a\u77e5\u5668\u670d\u52a1\u5728\u8bfb\u53d6\u4e8b\u4ef6\u961f\u5217\u65f6\u9047\u5230\u4e86\u95ee\u9898\uff0c\u51fa\u73b0\u4e8b\u4ef6\u5806\u79ef\uff09\u3002</li> </ol> <p>\u8bf7\u6ce8\u610f\uff0c\u8fd9\u4e9b\u76ee\u6807\u4e0e\u7cfb\u7edf\u7684\u6280\u672f\u64cd\u4f5c\u548c\u7528\u6237\u4f53\u9a8c\u6709\u5173\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#_5","title":"\u6559\u7a0b\u51c6\u5907\u5de5\u4f5c\u548c\u8bbe\u7f6e","text":""},{"location":"chap_ot/2OpenTelemetry_MS/#_6","title":"\u51c6\u5907\u5de5\u4f5c","text":"<p>\u82e5\u5728\u81ea\u5df1\u7684\u73af\u5883\u4e2d\u5b8c\u6210\u672c\u6559\u7a0b\u7684\u5b66\u4e60\uff0c\u60a8\u9700\u8981\uff1a</p> <ul> <li>\u4e00\u4e2a\u517c\u5bb9 Linux/Unix \u7684\u73af\u5883</li> </ul> <p>\u6ce8\uff1a\u7531\u4e8e NGINX \u7684 OpenTelemetry \u6a21\u5757\u4e0d\u517c\u5bb9\uff08\u5305\u62ec Linux aarch64 \u67b6\u6784\u548c\u642d\u8f7d M1 \u6216 M2 \u82af\u7247\u7684\u82f9\u679c\u8bbe\u5907\uff09\uff0c\u672c\u6559\u7a0b\u4e2d\u6d89\u53ca\u8ddf\u8e2a NGINX \u7684\u6d3b\u52a8\u4e0d\u80fd\u5728\u57fa\u4e8e ARM \u7684\u5904\u7406\u5668\u4e0a\u5de5\u4f5c\u3002\u6d89\u53ca\u4fe1\u4f7f\u548c\u901a\u77e5\u5668\u670d\u52a1\u7684\u6d3b\u52a8\u9002\u7528\u4e8e\u6240\u6709\u67b6\u6784\u3002</p> <ul> <li>\u57fa\u672c\u4e86\u89e3 Linux \u547d\u4ee4\u884c\u3001JavaScript \u548c bashbash \uff08\u672c\u6559\u7a0b\u4f1a\u63d0\u4f9b\u5e76\u89e3\u91ca\u6240\u6709\u4ee3\u7801\u548c\u547d\u4ee4\uff0c\u56e0\u6b64\u5373\u4f7f\u60a8\u77e5\u8bc6\u6709\u9650\u4e5f\u65e0\u59a8\uff09</li> <li>Docker \u548c Docker Compose</li> <li> <p>Node.js 19.x \u6216\u66f4\u9ad8\u7248\u672c</p> <ul> <li>\u6211\u4eec\u53ea\u6d4b\u8bd5\u4e86\u7248\u672c 19.x\uff0c\u4f46\u9884\u8ba1\u66f4\u65b0\u7248\u672c\u7684 Node.js \u4e5f\u9002\u7528\u3002</li> <li>\u5982\u6b32\u4e86\u89e3\u6709\u5173 Node,js \u5b89\u88c5\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u67e5\u770b\u4fe1\u4f7f\u670d\u52a1\u4ee3\u7801\u5e93\u4e2d\u7684 README \u6587\u4ef6\u3002\u60a8\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5 asdf\uff0c\u83b7\u53d6\u4e0e\u6559\u7a0b\u4e2d\u6240\u7528\u5b8c\u5168\u76f8\u540c\u7684 Node.js \u7248\u672c\u3002</li> </ul> </li> <li> <p>curl\uff08\u5df2\u5b89\u88c5\u5728\u5927\u591a\u6570\u7cfb\u7edf\u4e0a\uff09</p> </li> <li>\u67b6\u6784\u548c\u7528\u6237\u6d41\u90e8\u5206\u63d0\u5230\u4e86\u4ee5\u4e0b\u6280\u672f\uff1a\u4fe1\u4f7f\u548c\u901a\u77e5\u5668\uff08\u5c06\u5728\u4e0b\u4e00\u90e8\u5206\u4e2d\u4e0b\u8f7d\uff09\u3001NGINX \u5f00\u6e90\u7248\u3001Jaeger \u548c RabbitMQ\u3002</li> </ul> <p>\u6ce8\uff1a\u672c\u6559\u7a0b\u7528\u5230\u4e86 JavaScript SDK\uff0c\u56e0\u4e3a\u4fe1\u4f7f\u548c\u901a\u77e5\u5668\u670d\u52a1\u5747\u4f7f\u7528 Node.js \u7f16\u5199\u800c\u6210\u3002\u60a8\u8fd8\u9700\u8981\u8bbe\u7f6e OTel \u81ea\u52a8\u57cb\u70b9\u7279\u6027\uff0c\u4ee5\u4fbf\u4e86\u89e3 OTel \u63d0\u4f9b\u7684\u4fe1\u606f\u7c7b\u578b\u3002\u672c\u6559\u7a0b\u4ecb\u7ecd\u4e86\u6709\u5173 OTel Node.js SDK \u7684\u5e38\u7528\u4fe1\u606f\uff0c\u5982\u6b32\u4e86\u89e3\u66f4\u591a\u8be6\u60c5\uff0c\u8bf7\u53c2\u9605 [OTel \u6587\u6863]\uff1a</p> <p>https://opentelemetry.io/docs/instrumentation/js/getting-started/nodejs/\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#_7","title":"\u8bbe\u7f6e","text":"<ul> <li>\u5f00\u542f\u7ec8\u7aef\u4f1a\u8bdd\u3002</li> <li>\u5728\u4e3b\u76ee\u5f55\u4e0b\uff0c\u521b\u5efa microservices-march \u76ee\u5f55\uff0c\u5e76\u5c06\u672c\u6559\u7a0b\u4f1a\u7528\u5230\u7684 GitHub \u4ee3\u7801\u5e93\u590d\u5236\u5230\u5176\u4e2d\u3002\uff08\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u76ee\u5f55\u540d\u79f0\uff0c\u76f8\u5e94\u4fee\u6539\u6307\u4ee4\u5373\u53ef\uff09\u3002</li> </ul> <pre><code>mkdir ~/microservices-march\ncd ~/microservices-march\ngit clone https://github.com/microservices-march/messenger --branch mm23-metrics-start\ngit clone https://github.com/microservices-march/notifier --branch mm23-metrics-start\ngit clone https://github.com/microservices-march/platform --branch mm23-metrics-start\n</code></pre>"},{"location":"chap_ot/2OpenTelemetry_MS/#1-otel","title":"\u6311\u6218 1\uff1a\u8bbe\u7f6e\u57fa\u672c OTel \u57cb\u70b9","text":"<p>\u5728\u8fd9\u4e2a\u6311\u6218\u4e2d\uff0c\u542f\u52a8\u4fe1\u4f7f\u670d\u52a1\u5e76\u914d\u7f6e OTel \u81ea\u52a8\u57cb\u70b9\u4ee5\u5c06\u9065\u6d4b\u6570\u636e\u53d1\u9001\u81f3\u63a7\u5236\u53f0\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#_8","title":"\u542f\u52a8\u4fe1\u4f7f\u670d\u52a1","text":"<ol> <li>\u5207\u6362\u5230\u5e73\u53f0 platform \u4ee3\u7801\u5e93\u5e76\u542f\u52a8 Docker Compose\uff1a</li> </ol> <pre><code>cd ~/microservices-march/platform\ndocker compose up -d --build\n</code></pre> <p>\u8fd9\u5c06\u540c\u65f6\u542f\u52a8 RabbitMQ \u548c Jaeger\u2014\u2014\u4e24\u8005\u5c06\u5728\u540e\u9762\u7684\u6311\u6218\u4e2d\u7528\u5230\u3002</p> <ul> <li><code>\u2011d</code>\u6807\u8bb0\u6307\u793a Docker Compose \u5728\u5bb9\u5668\u542f\u52a8\u65f6\u4e0e\u4e4b\u5206\u79bb\uff08\u5426\u5219\u5bb9\u5668\u5c06\u59cb\u7ec8\u4e0e\u60a8\u7684\u7ec8\u7aef\u4fdd\u6301\u8fde\u63a5\uff09\u3002</li> <li> <p><code>--build</code> \u6807\u8bb0\u6307\u793a <code>Docker Compose</code> \u5728\u542f\u52a8\u65f6\u91cd\u5efa\u6240\u6709\u955c\u50cf\u3002\u8fd9\u53ef\u786e\u4fdd\u60a8\u6b63\u5728\u8fd0\u884c\u7684\u955c\u50cf\u901a\u8fc7\u4efb\u4f55\u6f5c\u5728\u7684\u6587\u4ef6\u53d8\u66f4\u4fdd\u6301\u66f4\u65b0\u3002</p> </li> <li> <p>\u5207\u6362\u5230\u4fe1\u4f7f messenger \u4ee3\u7801\u5e93\u7684 app \u76ee\u5f55\u5e76\u5b89\u88c5 Node.js\uff08\u60a8\u4e5f\u53ef\u4ee5\u6309\u9700\u91c7\u7528\u5176\u4ed6\u66ff\u4ee3\u65b9\u6cd5\uff09\uff1a</p> </li> </ul> <pre><code>cd ~/microservices-march/messenger/app\nasdf install\n</code></pre> <ol> <li>\u5b89\u88c5\u4f9d\u8d56\u9879\uff1a</li> </ol> <pre><code>npm install\n</code></pre> <p>\u4e3a\u4fe1\u4f7f\u670d\u52a1\u542f\u52a8 PostgreSQL \u6570\u636e\u5e93\uff1a</p> <pre><code>docker compose up -d\n</code></pre> <p>\u521b\u5efa\u6570\u636e\u5e93\u6a21\u5f0f\u548c\u8868\u683c\uff0c\u5e76\u63d2\u5165\u4e00\u4e9b\u79cd\u5b50\u6570\u636e\uff1a</p> <pre><code>npm run refresh-db\n</code></pre>"},{"location":"chap_ot/2OpenTelemetry_MS/#otel","title":"\u914d\u7f6e\u53d1\u9001\u5230\u63a7\u5236\u53f0\u7684 OTel \u81ea\u52a8\u57cb\u70b9","text":"<p>\u501f\u52a9 OTel \u81ea\u52a8\u57cb\u70b9\uff0c\u65e0\u9700\u4fee\u6539\u4fe1\u4f7f\u4ee3\u7801\u5e93\u4e2d\u7684\u4efb\u4f55\u5185\u5bb9\u5373\u53ef\u8bbe\u7f6e\u94fe\u8def\u8ffd\u8e2a\u3002\u6240\u6709\u94fe\u8def\u8ffd\u8e2a\u914d\u7f6e\u5e76\u975e\u76f4\u63a5\u7f16\u5199\u5728\u5e94\u7528\u4ee3\u7801\u4e2d\uff0c\u800c\u662f\u5728\u811a\u672c\u4e2d\u5b9a\u4e49\uff0c\u7136\u540e\u5728\u8fd0\u884c\u65f6\u628a\u811a\u672c\u5bfc\u5165 Node.js \u8fdb\u7a0b\u3002</p> <p>\u6b64\u5904\uff0c\u60a8\u53ef\u4ee5\u914d\u7f6e\u4fe1\u4f7f\u670d\u52a1\u7684\u81ea\u52a8\u57cb\u70b9\u4f7f\u7528\u6700\u57fa\u672c\u7684\u94fe\u8def\u8ffd\u8e2a\u76ee\u6807\u4f4d\u7f6e\uff0c\u5373\u63a7\u5236\u53f0\u3002\u5728\u6311\u6218 2 \u4e2d\uff0c\u60a8\u9700\u8981\u66f4\u6539\u914d\u7f6e\uff0c\u5c06\u94fe\u8def\u8ffd\u8e2a\u53d1\u9001\u5230\u4f5c\u4e3a\u5916\u90e8\u6536\u96c6\u5668\u7684 Jaeger\u3002</p> <ol> <li>\u4ecd\u7136\u5728 messenger \u4ee3\u7801\u5e93\u7684 app \u76ee\u5f55\u4e0b\u64cd\u4f5c\uff0c\u5b89\u88c5\u6838\u5fc3 OTel Node.js \u5305\uff1a</li> </ol> <pre><code>npm install @opentelemetry/sdk-node@0.36.0 \\\n            @opentelemetry/auto-instrumentations-node@0.36.4\n</code></pre> <p>\u4e0b\u5217\u5e93\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u529f\u80fd\uff1a</p> <ul> <li><code>@opentelemetry/sdk-node</code>\u2014\u2014 \u751f\u6210\u5e76\u5bfc\u51fa OTel \u6570\u636e</li> <li> <p><code>@opentelemetry/auto-instrumentations-node</code>\u2014\u2014 \u4f7f\u7528\u6240\u6709\u5e38\u89c1 Node.js \u57cb\u70b9\u7684\u9ed8\u8ba4\u914d\u7f6e\u8fdb\u884c\u81ea\u52a8\u8bbe\u7f6e</p> </li> <li> <p>\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a tracing.mjs \u7684\u6587\u4ef6\uff0c\u6dfb\u52a0 OTel \u94fe\u8def\u8ffd\u8e2a\u7684\u8bbe\u7f6e\u548c\u914d\u7f6e\u4ee3\u7801\uff1a</p> </li> </ul> <pre><code>touch tracing.mjs\n</code></pre> <p>\u5728\u60a8\u5e38\u7528\u7684\u6587\u672c\u7f16\u8f91\u5668\u4e2d\uff0c\u6253\u5f00 tracing.mjs \u5e76\u6dfb\u52a0\u4e0b\u5217\u4ee3\u7801\uff1a</p> <pre><code>//1\nimport opentelemetry from \"@opentelemetry/sdk-node\";\nimport { getNodeAutoInstrumentations } from \"@opentelemetry/auto-instrumentations-node\";\n\n//2\nconst sdk = new opentelemetry.NodeSDK({\n  traceExporter: new opentelemetry.tracing.ConsoleSpanExporter(),\n  instrumentations: [getNodeAutoInstrumentations()],\n});\n\n//3\nsdk.start();\n</code></pre> <p>\u8fd9\u4e9b\u4ee3\u7801\u4f1a\u5b8c\u6210\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <p>\u65b0\u5efa NodeSDK \u5b9e\u4f8b\u5e76\u5bf9\u5176\u8fdb\u884c\u914d\u7f6e\uff0c\u4ee5\u4fbf\uff1a</p> <ul> <li>\u9762\u5411 Postgres \u6570\u636e\u5e93\u7684 <code>@opentelemetry/instrumentation-pg</code> \u5e93 (<code>pg</code>)</li> <li>\u9762\u5411 <code>Node.js</code> Express \u6846\u67b6\u7684 <code>@opentelemetry/instrumentation-express</code></li> <li>\u9762\u5411 RabbitMQ \u7684 <code>@opentelemetry/instrumentation-amqplib</code> \u5e93 (amqplib)</li> <li>\u5c06 span \u53d1\u9001\u81f3\u63a7\u5236\u53f0 (<code>ConsoleSpanExporter</code>)\u3002</li> <li>\u5c06\u81ea\u52a8\u57cb\u70b9\u7528\u4f5c\u57fa\u672c\u57cb\u70b9\u7ec4\u3002\u8be5\u57cb\u70b9\u52a0\u8f7d\u4e86\u6240\u6709\u6700\u5e38\u89c1\u7684\u81ea\u52a8\u57cb\u70b9\u5e93\u3002\u672c\u6559\u7a0b\u7528\u5230\u4e86\u4ee5\u4e0b\u5e93\uff1a</li> </ul> <p>\u542f\u52a8 SDK\u3002</p> <p>\u542f\u52a8\u4fe1\u4f7f\u670d\u52a1\uff0c\u5bfc\u5165\u60a8\u5728\u7b2c\u4e09\u6b65\u4e2d\u521b\u5efa\u7684\u81ea\u52a8\u57cb\u70b9\u811a\u672c\u3002</p> <pre><code>node --import ./tracing.mjs index.mjs\n</code></pre> <p>\u7a0d\u540e\uff0c\u63a7\u5236\u53f0\uff08\u60a8\u7684\u7ec8\u7aef\uff09\u4e2d\u5f00\u59cb\u663e\u793a\u5927\u91cf\u4e0e\u94fe\u8def\u8ffd\u8e2a\u76f8\u5173\u7684\u8f93\u51fa\uff1a</p> <pre><code>...\n{\n  traceId: '9c1801593a9d3b773e5cbd314a8ea89c',\n  parentId: undefined,\n  traceState: undefined,\n  name: 'fs statSync',\n  id: '2ddf082c1d609fbe',\n  kind: 0,\n  timestamp: 1676076410782000,\n  duration: 3,\n  attributes: {},\n  status: { code: 0 },\n  events: [],\n  links: []\n}\n...\n</code></pre> <p>\u6ce8\uff1a\u8ba9\u7ec8\u7aef\u4f1a\u8bdd\u4fdd\u6301\u6253\u5f00\u72b6\u6001\uff0c\u4ee5\u4fbf\u5728\u6311\u6218 2 \u4e2d\u4f7f\u7528\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#2-otel","title":"\u6311\u6218 2\uff1a\u4e3a\u6240\u6709\u670d\u52a1\u8bbe\u7f6e OTel \u57cb\u70b9\u548c\u94fe\u8def\u8ffd\u8e2a\u53ef\u89c6\u5316","text":"<p>\u60a8\u53ef\u4ee5\u4f7f\u7528\u8bb8\u591a\u5de5\u5177\u6765\u67e5\u770b\u548c\u5206\u6790\u94fe\u8def\u8ffd\u8e2a\uff0c\u4f46\u672c\u6559\u7a0b\u4f7f\u7528\u7684\u662f Jaeger\u3002Jaeger \u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5f00\u6e90\u7aef\u5230\u7aef\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u6846\u67b6\uff0c\u5185\u7f6e\u4e00\u4e2a\u57fa\u4e8e Web \u7684\u7528\u6237\u754c\u9762\uff0c\u7528\u4e8e\u67e5\u770b span \u53ca\u5176\u4ed6\u94fe\u8def\u8ffd\u8e2a\u6570\u636e\u3002</p> <p>\u5e73\u53f0\u4ee3\u7801\u5e93\u4e2d\u63d0\u4f9b\u7684\u57fa\u7840\u67b6\u6784\u5305\u62ec Jaeger\uff08\u5df2\u5728\u6311\u6218 1 \u7684\u7b2c\u4e00\u6b65\u4e2d\u542f\u52a8\uff09\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u4e13\u6ce8\u4e8e\u5206\u6790\u6570\u636e\uff0c\u4e0d\u7528\u8003\u8651\u5de5\u5177\u95ee\u9898\u3002</p> <p>\u60a8\u53ef\u901a\u8fc7\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee http://localhost:16686 \u7aef\u70b9\u6765\u8bbf\u95ee Jaeger\uff0c\u4f46\u5982\u679c\u60a8\u73b0\u5728\u5c31\u8bbf\u95ee\u8be5\u7aef\u70b9\uff0c\u4e0d\u4f1a\u770b\u5230\u4e0e\u60a8\u7684\u7cfb\u7edf\u6709\u5173\u7684\u4efb\u4f55\u5185\u5bb9\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u60a8\u76ee\u524d\u6536\u96c6\u7684\u94fe\u8def\u8ffd\u8e2a\u6b63\u88ab\u53d1\u9001\u5230\u63a7\u5236\u53f0\uff01\u5982\u6b32\u5728 Jaeger \u4e2d\u67e5\u770b\u94fe\u8def\u8ffd\u8e2a\u6570\u636e\uff0c\u9700\u4f7f\u7528 OpenTelemetry \u534f\u8bae (OTLP) \u683c\u5f0f\u5bfc\u51fa\u94fe\u8def\u8ffd\u8e2a\u3002</p> <p>\u5728\u8fd9\u4e2a\u6311\u6218\u4e2d\uff0c\u60a8\u9700\u8981\u4e3a\u4ee5\u4e0b\u670d\u52a1\u914d\u7f6e\u57cb\u70b9\u4ee5\u76d1\u6d4b\u6838\u5fc3\u7528\u6237\u6d41\uff1a</p> <ul> <li>\u4fe1\u4f7f\u670d\u52a1\uff0c\u5c06\u94fe\u8def\u8ffd\u8e2a\u76ee\u6807\u4f4d\u7f6e\u4ece\u63a7\u5236\u53f0\u5207\u6362\u5230 Jaeger\u3002</li> <li>\u901a\u77e5\u5668\u670d\u52a1</li> <li>NGINX</li> </ul>"},{"location":"chap_ot/2OpenTelemetry_MS/#otel_1","title":"\u914d\u7f6e OTel \u81ea\u52a8\u57cb\u70b9\u53d1\u9001\u5230\u5916\u90e8\u6536\u96c6\u5668","text":"<p>\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u4f7f\u7528 OTel \u81ea\u52a8\u57cb\u70b9\u610f\u5473\u7740\u60a8\u65e0\u9700\u4fee\u6539\u4fe1\u4f7f\u4ee3\u7801\u5e93\u4e2d\u7684\u4efb\u4f55\u5185\u5bb9\u5373\u53ef\u8bbe\u7f6e\u94fe\u8def\u8ffd\u8e2a\u3002</p> <p>\u4f46\u6240\u6709\u94fe\u8def\u8ffd\u8e2a\u914d\u7f6e\u90fd\u4f4d\u4e8e\u5728\u8fd0\u884c\u65f6\u88ab\u5bfc\u5165 Node.js \u8fdb\u7a0b\u7684\u811a\u672c\u4e2d\u3002</p> <p>\u6b64\u5904\uff0c\u60a8\u53ef\u5c06\u7531\u4fe1\u4f7f\u670d\u52a1\u751f\u6210\u7684\u94fe\u8def\u8ffd\u8e2a\u7684\u76ee\u6807\u4f4d\u7f6e\u4ece\u63a7\u5236\u53f0\u66f4\u6539\u4e3a\u5916\u90e8\u6536\u96c6\u5668\uff08\u5728\u672c\u6559\u7a0b\u4e2d\u4e3a Jaeger\uff09\u3002</p> <ol> <li>\u4ecd\u7136\u5728\u4e0e\u6311\u6218 1 \u4e2d\u76f8\u540c\u7684\u7ec8\u7aef\u4e0b\u64cd\u4f5c\uff0c\u5728\u4fe1\u4f7f\u4ee3\u7801\u5e93\u7684 app \u76ee\u5f55\u4e0b\uff0c\u5b89\u88c5 OTLP \u8f93\u51fa\u5668 Node.js \u5305\uff1a</li> </ol> <pre><code>npm install @opentelemetry/exporter-trace-otlp-http@0.36.0\n</code></pre> <p><code>@opentelemetry/exporter-trace-otlp-http</code> \u5e93\u901a\u8fc7 HTTP \u5bfc\u51fa OTLP \u683c\u5f0f\u7684\u94fe\u8def\u8ffd\u8e2a\u4fe1\u606f\uff0c\u7528\u4e8e\u5411 OTel \u5916\u90e8\u6536\u96c6\u5668\u53d1\u9001\u9065\u6d4b\u6570\u636e\u3002</p> <p>2.\u6253\u5f00 tracing.mjs\uff08\u5df2\u5728\u6311\u6218 1 \u4e2d\u521b\u5efa\u548c\u7f16\u8f91\uff09\uff0c\u5e76\u8fdb\u884c\u4ee5\u4e0b\u4fee\u6539\uff1a</p> <pre><code>import { OTLPTraceExporter } from \"@opentelemetry/exporter-trace-otlp-http\";\n</code></pre> <p>\u6ce8\uff1a\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u672c\u6559\u7a0b\u5047\u8bbe\u6536\u96c6\u5668\u4f4d\u4e8e\u9ed8\u8ba4\u4f4d\u7f6e http://localhost:4318/v1/traces\u3002\u5728\u771f\u5b9e\u7cfb\u7edf\u4e2d\uff0c\u6700\u597d\u660e\u786e\u8bbe\u7f6e\u8be5\u4f4d\u7f6e\u3002</p> <ul> <li>\u5c06\u63d0\u4f9b\u7ed9 OTel SDK \u7684\u201c\u5bfc\u51fa\u5668\u201d\u4ece\u6311\u6218 1 \u4e2d\u6240\u7528\u7684\u63a7\u5236\u53f0\u5bfc\u51fa\u5668\u66f4\u6539\u4e3a\u53ef\u901a\u8fc7 HTTP \u5411\u517c\u5bb9 OTLP \u7684\u6536\u96c6\u5668\u53d1\u9001 OTLP \u6570\u636e\u7684\u5bfc\u51fa\u5668\u3002\u5c06</li> </ul> <pre><code>traceExporter:new opentelemetry.tracing.ConsoleSpanExporter(),\n</code></pre> <p>\u5c06\u4e0b\u5217\u4e00\u884c\u6dfb\u52a0\u5230\u6587\u4ef6\u9876\u90e8\u7684 import \u8bed\u53e5\u4e2d\uff1a</p> <p>3.\u6309\u4e0b Ctrl+c \u505c\u6b62\u4fe1\u4f7f\u670d\u52a1\uff0c\u8be5\u7ec8\u7aef\u662f\u5728\u914d\u7f6e OTel \u81ea\u52a8\u57cb\u70b9\u53d1\u9001\u5230\u63a7\u5236\u53f0\u7684\u7b2c\u56db\u6b65\u4e2d\u542f\u52a8\u7684\u3002\u91cd\u542f\u8be5\u670d\u52a1\uff0c\u4ee5\u4f7f\u7528\u5728\u7b2c\u4e8c\u6b65\u4e2d\u914d\u7f6e\u7684\u65b0\u5bfc\u51fa\u5668\uff1a</p> <pre><code>^c\nnode --import ./tracing.mjs index.mjs\n</code></pre> <p>4.\u5f00\u542f\u7b2c\u4e8c\u4e2a\u7ec8\u7aef\u4f1a\u8bdd\u3002\uff08\u5728\u540e\u9762\u7684\u6307\u4ee4\u4e2d\u79f0\u5176\u4e3a\u5ba2\u6237\u7aef\u7ec8\u7aef\uff0c\u5728\u7b2c\u4e00\u6b65\u548c\u7b2c\u4e09\u6b65\u4e2d\u4f7f\u7528\u7684\u539f\u59cb\u7ec8\u7aef\u88ab\u79f0\u4f5c\u4fe1\u4f7f\u7ec8\u7aef\u3002\uff09\u7b49\u5f85\u5927\u7ea6\u5341\u79d2\u949f\uff0c\u7136\u540e\u5411\u4fe1\u4f7f\u670d\u52a1\u53d1\u9001\u5065\u5eb7\u68c0\u67e5\u8bf7\u6c42\uff08\u5982\u8981\u67e5\u770b\u591a\u4e2a\u94fe\u8def\u8ffd\u8e2a\uff0c\u5219\u53ef\u591a\u8fd0\u884c\u51e0\u6b21\uff09\uff1a</p> <pre><code>curl -X GET http://localhost:4000/health\n</code></pre> <p>\u5728\u53d1\u9001\u8bf7\u6c42\u524d\u7b49\u5f85 10 \u79d2\u949f\u6709\u52a9\u4e8e\u60a8\u7684\u8ddf\u8e2a\u66f4\u5bb9\u6613\u88ab\u627e\u5230\uff0c\u56e0\u4e3a\u5728\u670d\u52a1\u542f\u52a8\u65f6\u81ea\u52a8\u57cb\u70b9\u4f1a\u751f\u6210\u8bb8\u591a\u94fe\u8def\u8ffd\u8e2a\u3002</p> <p>\u5728\u6d4f\u89c8\u5668\u4e2d\uff0c\u8bbf\u95ee Jaeger \u7528\u6237\u754c\u9762\uff1a<code>http://localhost:16686</code>\uff0c\u5e76\u9a8c\u8bc1 OTLP \u5bfc\u51fa\u5668\u662f\u5426\u6309\u9884\u671f\u8fd0\u884c\u3002</p> <p>\u5728\u6807\u9898\u680f\u4e2d\u70b9\u51fb Search\uff08\u641c\u7d22\uff09\uff0c\u4ece Service\uff08\u670d\u52a1\uff09\u5b57\u6bb5\u7684\u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9\u540d\u79f0\u4ee5 <code>unknown_service</code> \u5f00\u5934\u7684\u670d\u52a1\u3002</p> <p>\u70b9\u51fb Find Traces\uff08\u67e5\u627e\u8ffd\u8e2a\uff09\u6309\u94ae\uff1a</p> <p></p> <p>\u70b9\u51fb\u7a97\u53e3\u53f3\u4fa7\u7684\u94fe\u8def\u8ffd\u8e2a\uff0c\u4ee5\u663e\u793a\u5176\u4e2d\u7684 span \u5217\u8868\u3002\u6bcf\u4e2a span \u90fd\u63cf\u8ff0\u4e86\u4f5c\u4e3a\u94fe\u8def\u8ffd\u8e2a\u7684\u4e00\u90e8\u5206\u8fd0\u884c\u7684\u5404\u9879\u64cd\u4f5c\uff0c\u6709\u65f6\u6d89\u53ca\u591a\u4e2a\u670d\u52a1\u3002\u622a\u56fe\u4e2d\u7684 jsonParser span \u663e\u793a\u4e86\u8fd0\u884c\u4fe1\u4f7f\u670d\u52a1\u7684\u8bf7\u6c42\u5904\u7406\u4ee3\u7801\u7684 jsonParser \u90e8\u5206\u6240\u7528\u7684\u65f6\u957f\u3002</p> <p></p> <p>\u6b63\u5982\u7b2c\u4e94\u6b65\u4e2d\u6240\u8ff0\uff0cOTel SDK \u5bfc\u51fa\u7684\u670d\u52a1\u540d\u79f0 (<code>unknown_service</code>) \u6beb\u65e0\u610f\u4e49\u3002\u8981\u60f3\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728\u4fe1\u4f7f\u7ec8\u7aef\u6309\u4e0b Ctrl+c \u6765\u505c\u6b62\u4fe1\u4f7f\u670d\u52a1\u3002 \u7136\u540e\u518d\u5b89\u88c5\u51e0\u4e2a Node.js \u5305\uff1a</p> <pre><code>^c \nnpm install @opentelemetry/semantic-conventions@1.10.0 \\\n            @opentelemetry/resources@1.10.0\n</code></pre> <p>\u4e0b\u5217\u4e24\u4e2a\u5e93\u63d0\u4f9b\u4ee5\u4e0b\u529f\u80fd\uff1a</p> <ul> <li><code>@opentelemetry/semantic-conventions</code>\u2014\u2014\u5b9a\u4e49\u4e86 OTel \u89c4\u8303\u4e2d\u6240\u5b9a\u4e49\u7684\u94fe\u8def\u8ffd\u8e2a\u7684\u6807\u51c6\u5c5e\u6027\u3002</li> <li><code>@opentelemetry/resources</code>\u2014\u2014\u5b9a\u4e49\u4e00\u4e2a\u5bf9\u8c61\uff08\u8d44\u6e90\uff09\u4ee5\u4ee3\u8868\u751f\u6210 OTel \u6570\u636e\u7684\u6765\u6e90\uff08\u5728\u672c\u6559\u7a0b\u4e2d\u4e3a\u4fe1\u4f7f\u670d\u52a1\uff09\u3002</li> </ul> <p>8.\u5728\u6587\u672c\u7f16\u8f91\u5668\u4e2d\u6253\u5f00 <code>tracing.mjs</code> \u5e76\u8fdb\u884c\u4ee5\u4e0b\u4fee\u6539\uff1a</p> <ul> <li>\u5c06\u4e0b\u5217\u884c\u6dfb\u52a0\u5230\u6587\u4ef6\u9876\u90e8\u7684 import \u8bed\u53e5\u4e2d\uff1a</li> </ul> <pre><code>import { Resource } from \"@opentelemetry/resources\";\nimport { SemanticResourceAttributes } from \"@opentelemetry/semantic-conventions\";\n</code></pre> <ul> <li>\u5728 OTel \u89c4\u8303\u4e2d\u7684\u6b63\u786e\u952e\u503c\u4e0b\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a messenger \u7684 resource\uff0c\u5177\u4f53\u65b9\u6cd5\u662f\u5728\u6700\u540e\u4e00\u4e2a import \u8bed\u53e5\u540e\u6dfb\u52a0\u4ee5\u4e0b\u884c\uff1a</li> </ul> <pre><code>const resource = new Resource({\n  [SemanticResourceAttributes.SERVICE_NAME]: \"messenger\",\n});\n</code></pre> <ul> <li>\u901a\u8fc7\u5728\u4ee5\u4e0b\u9ed1\u8272\u884c\u4e4b\u95f4\u6dfb\u52a0\u6a59\u8272\u9ad8\u4eae\u663e\u793a\u7684\u884c\uff0c\u5c06 resource \u5bf9\u8c61\u4f20\u9012\u7ed9 NodeSDK \u6784\u9020\u51fd\u6570\uff1a</li> </ul> <pre><code>const sdk = new opentelemetry.NodeSDK({\n  resource,\n  traceExporter: new OTLPTraceExporter({ headers: {} }),\n  instrumentations: [getNodeAutoInstrumentations()],\n});\n</code></pre> <p>9.\u91cd\u542f\u4fe1\u4f7f\u670d\u52a1\uff1a</p> <pre><code>node --import ./tracing.mjs index.mjs\n</code></pre> <p>10.\u7b49\u5f85\u5927\u7ea6\u5341\u79d2\u949f\uff0c\u7136\u540e\u5728\u5ba2\u6237\u7aef\u7ec8\u7aef\u4e2d\uff08\u5df2\u5728\u7b2c\u56db\u6b65\u4e2d\u6253\u5f00\uff09\u5411\u670d\u52a1\u5668\u53d1\u9001\u53e6\u4e00\u5065\u5eb7\u68c0\u67e5\u8bf7\u6c42\uff08\u5982\u6b32\u67e5\u770b\u591a\u4e2a\u94fe\u8def\u8ffd\u8e2a\uff0c\u5219\u53ef\u591a\u8fd0\u884c\u51e0\u6b21\u547d\u4ee4\uff09\uff1a</p> <pre><code>curl -X GET http://localhost:4000/health\n</code></pre> <p>\u6ce8\uff1a\u8ba9\u5ba2\u6237\u7aef\u7ec8\u7aef\u4fdd\u6301\u6253\u5f00\u72b6\u6001\uff0c\u4ee5\u4fbf\u5728\u4e0b\u4e00\u90e8\u5206\u4e2d\u518d\u6b21\u4f7f\u7528\uff0c\u540c\u65f6\u8ba9\u4fe1\u4f7f\u7ec8\u7aef\u4fdd\u6301\u6253\u5f00\u72b6\u6001\uff0c\u4ee5\u5728\u6311\u6218 3 \u4e2d\u518d\u6b21\u4f7f\u7528</p> <p>11.\u786e\u8ba4\u4e00\u4e2a\u540d\u4e3a messenger\uff08\u4fe1\u4f7f\uff09\u7684\u65b0\u670d\u52a1\u51fa\u73b0\u5728\u6d4f\u89c8\u5668\u7684 Jaeger \u7528\u6237\u754c\u9762\u4e2d\uff08\u8fd9\u53ef\u80fd\u9700\u8981\u51e0\u79d2\u949f\u7684\u65f6\u95f4\uff0c\u800c\u4e14\u60a8\u53ef\u80fd\u9700\u8981\u5237\u65b0 Jaeger \u7528\u6237\u754c\u9762\uff09\uff1a</p> <p></p> <p>12.\u4ece Service \u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9 messenger\uff0c\u7136\u540e\u70b9\u51fb Find Traces \u6309\u94ae\uff0c\u5373\u53ef\u67e5\u770b\u7531\u4fe1\u4f7f\u670d\u52a1\u751f\u6210\u7684\u6240\u6709\u6700\u65b0\u94fe\u8def\u8ffd\u8e2a\uff08\u622a\u56fe\u663e\u793a\u4e86 20 \u6761\u4fe1\u606f\u4e2d\u7684\u4e24\u6761\u6700\u65b0\u4fe1\u606f\uff09\uff1a</p> <p></p> <p>13.\u70b9\u51fb\u4e00\u4e2a\u8ffd\u8e2a\uff0c\u4ee5\u663e\u793a\u5176\u4e2d\u7684 span\u3002\u6bcf\u4e2a span \u90fd\u88ab\u6b63\u786e\u5730\u6807\u8bb0\u4e3a\u6e90\u81ea\u4e8e\u4fe1\u4f7f\u670d\u52a1\uff1a</p> <p></p>"},{"location":"chap_ot/2OpenTelemetry_MS/#otel_2","title":"\u914d\u7f6e\u901a\u77e5\u5668\u670d\u52a1\u7684 OTel \u81ea\u52a8\u57cb\u70b9","text":"<p>\u73b0\u5728\u4e3a\u901a\u77e5\u5668\u670d\u52a1\u542f\u52a8\u5e76\u914d\u7f6e\u81ea\u52a8\u57cb\u70b9\uff0c\u8fd0\u884c\u4e0e\u524d\u4e24\u90e8\u5206\u4e2d\u4fe1\u4f7f\u670d\u52a1\u57fa\u672c\u76f8\u540c\u7684\u547d\u4ee4\u3002</p> <p>1.\u5f00\u542f\u65b0\u7684\u7ec8\u7aef\u4f1a\u8bdd\uff08\u5728\u540e\u7eed\u6b65\u9aa4\u4e2d\u88ab\u79f0\u4e3a\u901a\u77e5\u5668\u7ec8\u7aef\uff09\u3002\u5207\u6362\u5230\u901a\u77e5\u5668\u4ee3\u7801\u5e93\u7684 app \u76ee\u5f55\u5e76\u5b89\u88c5 Node.js\uff08\u60a8\u4e5f\u53ef\u4ee5\u6309\u9700\u91c7\u7528\u5176\u4ed6\u66ff\u4ee3\u65b9\u6cd5\uff09\uff1a</p> <pre><code>cd ~/microservices-march/notifier/app\nasdf install\n</code></pre> <p>2 \u5b89\u88c5\u4f9d\u8d56\u9879\uff1a</p> <pre><code>npm install\n</code></pre> <p>3 \u4e3a\u901a\u77e5\u5668\u670d\u52a1\u542f\u52a8 PostgreSQL \u6570\u636e\u5e93\uff1a</p> <pre><code>docker compose up -d\n</code></pre> <p>4 \u521b\u5efa\u6570\u636e\u5e93\u6a21\u5f0f\u548c\u8868\u683c\uff0c\u5e76\u63d2\u5165\u4e00\u4e9b\u79cd\u5b50\u6570\u636e\uff1a</p> <pre><code>npm run refresh-db\n</code></pre> <p>5 \u5b89\u88c5 OTel Node.js \u5305\uff08\u5173\u4e8e\u8fd9\u4e9b\u5305\u529f\u80fd\u7684\u63cf\u8ff0\uff0c\u8bf7\u53c2\u9605\u201c\u914d\u7f6e OTel \u81ea\u52a8\u57cb\u70b9\u53d1\u9001\u5230\u63a7\u5236\u53f0\u201d\u4e2d\u7684\u7b2c\u4e00\u6b65\u548c\u7b2c\u4e09\u6b65\uff09\uff1a</p> <pre><code>npm install @opentelemetry/auto-instrumentations-node@0.36.4 \\\n  @opentelemetry/exporter-trace-otlp-http@0.36.0 \\\n  @opentelemetry/resources@1.10.0 \\\n  @opentelemetry/sdk-node@0.36.0 \\\n  @opentelemetry/semantic-conventions@1.10.0\n</code></pre> <p>6 \u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a tracing.mjs \u7684\u6587\u4ef6\uff1a</p> <pre><code>touch tracing.mjs\n</code></pre> <p>7 \u5728\u60a8\u5e38\u7528\u7684\u6587\u672c\u7f16\u8f91\u5668\u4e2d\uff0c\u6253\u5f00 tracing.mjs \u5e76\u6dfb\u52a0\u4ee5\u4e0b\u811a\u672c\uff0c\u4ee5\u542f\u52a8\u5e76\u8fd0\u884c OTel SDK\uff1a</p> <pre><code>import opentelemetry from \"@opentelemetry/sdk-node\";\nimport { getNodeAutoInstrumentations } from \"@opentelemetry/auto-instrumentations-node\";\nimport { OTLPTraceExporter } from \"@opentelemetry/exporter-trace-otlp-http\";\nimport { Resource } from \"@opentelemetry/resources\";\nimport { SemanticResourceAttributes } from \"@opentelemetry/semantic-conventions\";\n\nconst resource = new Resource({\n  [SemanticResourceAttributes.SERVICE_NAME]: \"notifier\",\n});\n\nconst sdk = new opentelemetry.NodeSDK({\n  resource,\n  traceExporter: new OTLPTraceExporter({ headers: {} }),\n  instrumentations: [getNodeAutoInstrumentations()],\n});\n\nsdk.start();\n</code></pre> <p>\u6ce8\uff1a\u672c\u811a\u672c\u4e0e\u4fe1\u4f7f\uff08notifier\uff09\u670d\u52a1\u6240\u7528\u7684\u5b8c\u5168\u76f8\u540c\uff0c\u552f\u4e00\u4e0d\u540c\u4e4b\u5904\u662f<code>SemanticResourceAttributes.SERVICE_NAME</code> \u5b57\u6bb5\u4e2d\u7684\u503c\u662f <code>notifier</code>\u3002</p> <p>8 \u4f7f\u7528 OTel \u81ea\u52a8\u57cb\u70b9\u542f\u52a8\u901a\u77e5\u5668\u670d\u52a1\uff1a</p> <pre><code>node --import ./tracing.mjs index.mjs\n</code></pre> <p>9 \u7b49\u5f85\u5927\u7ea6\u5341\u79d2\u949f\uff0c\u7136\u540e\u5728\u5ba2\u6237\u7aef\u7ec8\u7aef\u5411\u901a\u77e5\u5668\u670d\u52a1\u53d1\u9001\u5065\u5eb7\u68c0\u67e5\u8bf7\u6c42\u3002\u8be5\u670d\u52a1\u5c06\u76d1\u542c\u7aef\u53e3 5000\uff0c\u4ee5\u9632\u6b62\u4e0e\u76d1\u542c\u7aef\u53e3 4000 \u7684\u4fe1\u4f7f\u670d\u52a1\u53d1\u751f\u51b2\u7a81\uff1a</p> <pre><code>curl http://localhost:5000/health\n</code></pre> <p>\u6ce8\uff1a\u8ba9\u5ba2\u6237\u7aef\u7ec8\u7aef\u548c\u901a\u77e5\u5668\u7ec8\u7aef\u4fdd\u6301\u6253\u5f00\u72b6\u6001\uff0c\u4ee5\u4fbf\u5728\u6311\u6218 3 \u4e2d\u518d\u6b21\u4f7f\u7528\u3002</p> <p>10 \u786e\u8ba4\u4e00\u4e2a\u540d\u4e3a notifier \u7684\u65b0\u670d\u52a1\u51fa\u73b0\u5728\u6d4f\u89c8\u5668\u7684 Jaeger \u7528\u6237\u754c\u9762\u4e2d\uff1a</p> <p></p>"},{"location":"chap_ot/2OpenTelemetry_MS/#nginx-otel","title":"\u914d\u7f6e NGINX \u7684 OTEL \u57cb\u70b9","text":"<p>\u5bf9\u4e8e NGINX\uff0c\u60a8\u9700\u8981\u624b\u52a8\u8bbe\u7f6e\u94fe\u8def\u8ffd\u8e2a\uff0c\u800c\u4e0d\u662f\u4f7f\u7528 OTel \u81ea\u52a8\u57cb\u70b9\u65b9\u6cd5\u3002</p> <p>\u76ee\u524d\uff0c\u4f7f\u7528 OTel \u5bf9 NGINX \u8fdb\u884c\u76d1\u6d4b\u7684\u6700\u5e38\u89c1\u65b9\u5f0f\u662f\u4f7f\u7528[\u7528 C \u8bed\u8a00\u7f16\u5199\u7684\u6a21\u5757]\uff1ahttps://github.com/open-telemetry/opentelemetry-cpp-contrib/tree/main/instrumentation/otel-webserver-module#nginx-webserver-module\u3002</p> <p>\u7b2c\u4e09\u65b9\u6a21\u5757\u662f NGINX \u751f\u6001\u7cfb\u7edf\u7684\u4e00\u4e2a\u91cd\u8981\u7ec4\u6210\u90e8\u5206\uff0c\u4f46\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u8bbe\u7f6e\u3002\u672c\u6559\u7a0b\u5411\u60a8\u5c55\u793a\u4e86\u5982\u4f55\u8fdb\u884c\u8fd9\u4e9b\u8bbe\u7f6e\u3002\u6709\u5173\u80cc\u666f\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u6211\u4eec\u7684\u535a\u6587\u300a\u4e3a NGINX \u548c NGINX Plus \u7f16\u8bd1\u7b2c\u4e09\u65b9\u52a8\u6001\u6a21\u5757\u300b\u3002</p> <p>1 \u5f00\u542f\u65b0\u7684\u7ec8\u7aef\u4f1a\u8bdd\uff08NGINX \u7ec8\u7aef\uff09\uff0c\u5c06\u76ee\u5f55\u66f4\u6539\u4e3a\u4fe1\u4f7f\u4ee3\u7801\u5e93\u7684\u6839\u76ee\u5f55\uff0c\u5e76\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a load-balancer \u7684\u76ee\u5f55\u53ca\u4e09\u4e2a\u540d\u4e3a Dockerfile\u3001<code>nginx.conf</code> \u548c <code>opentelemetry_module.conf</code> \u7684\u6587\u4ef6\uff1a</p> <pre><code>cd ~/microservices-march/messenger/\nmkdir load-balancer\ncd load-balancer\ntouch Dockerfile\ntouch nginx.conf\ntouch opentelemetry_module.conf\n</code></pre> <p>\u5728\u60a8\u5e38\u7528\u7684\u6587\u672c\u7f16\u8f91\u5668\u4e2d\uff0c\u6253\u5f00 Dockerfile \u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff08\u6ce8\u91ca\u89e3\u91ca\u4e86\u6bcf\u4e00\u884c\u4ee3\u7801\u7684\u529f\u80fd\uff0c\u5373\u4fbf\u60a8\u4e0d\u5b8c\u5168\u7406\u89e3\u8fd9\u4e9b\u6ce8\u91ca\uff0c\u4e5f\u80fd\u6784\u5efa\u548c\u8fd0\u884c Docker \u5bb9\u5668\uff09\uff1a</p> <pre><code>FROM --platform=amd64 nginx:1.23.1\n\n# \u7528\u6211\u4eec\u81ea\u5df1\u7684\u6587\u4ef6\u66ff\u6362 nginx.conf \u6587\u4ef6\nCOPY nginx.conf /etc/nginx/nginx.conf\n\n# \u5b9a\u4e49 NGINX OTel \u6a21\u5757\u7684\u7248\u672c\nARG OPENTELEMETRY_CPP_VERSION=1.0.3\n\n# \u5b9a\u4e49\u7f16\u8bd1\u548c\u8fd0\u884c NGINX \u65f6\u6240\u7528\u5171\u4eab\u5e93\u7684\u641c\u7d22\u8def\u5f84\nENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/opentelemetry-webserver-sdk/sdk_lib/lib\n\n# 1. \u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684 Consul \u6a21\u677f\u548c OTEL C++ Web \u670d\u52a1\u5668\u6a21\u5757\u3001otel-webserver-module\nADD https://github.com/open-telemetry/opentelemetry-cpp-contrib/releases/download/webserver%2Fv${OPENTELEMETRY_CPP_VERSION}/opentelemetry-webserver-sdk-x64-linux.tgz /tmp\n\nRUN apt-get update \\\n  &amp;&amp; apt-get install -y --no-install-recommends dumb-init unzip \\\n# 2. \u63d0\u53d6\u6a21\u5757\u6587\u4ef6\n  &amp;&amp; tar xvfz /tmp/opentelemetry-webserver-sdk-x64-linux.tgz -C /opt \\\n  &amp;&amp; rm -rf /tmp/opentelemetry-webserver-sdk-x64-linux.tgz \\\n# 3. \u5c06\u2018load_module\u2019\u6307\u4ee4\u5b89\u88c5\u5e76\u6dfb\u52a0\u81f3\u4e3b NGINX \u914d\u7f6e\u6587\u4ef6\u7684\u9876\u90e8\n  &amp;&amp; /opt/opentelemetry-webserver-sdk/install.sh \\\n  &amp;&amp; echo \"load_module /opt/opentelemetry-webserver-sdk/WebServerModule/Nginx/1.23.1/ngx_http_opentelemetry_module.so;\\n$(cat /etc/nginx/nginx.conf)\" &gt; /etc/nginx/nginx.conf\n\n# 4. \u590d\u5236\u5230 NGINX OTel \u6a21\u5757\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\nCOPY opentelemetry_module.conf /etc/nginx/conf.d/opentelemetry_module.conf\n\nEXPOSE 8085\n\nSTOPSIGNAL SIGQUIT\n</code></pre> <p>3 \u6253\u5f00 nginx.conf \u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>events {}\n\nhttp {\n    include /etc/nginx/conf.d/opentelemetry_module.conf;\n\n    upstream messenger {\n        server localhost:4000;\n    }\n\n    server {\n        listen 8085;\n\n        location / {\n            proxy_pass http://messenger;\n        }\n    }\n}\n</code></pre> <p>\u8fd9\u4e2a\u57fa\u672c\u7684 NGINX \u914d\u7f6e\u6587\u4ef6\u6307\u793a NGINX\uff1a</p> <ul> <li>\u8bbe\u7f6e\u4e00\u4e2a\u540d\u4e3a\u4fe1\u4f7f\u7684\u4e0a\u6e38\u7ec4\uff0c\u4ee5\u8868\u793a\u4fe1\u4f7f\u670d\u52a1\u5b9e\u4f8b\u7ec4\u3002</li> <li>\u5728\u7aef\u53e3 8085 \u76d1\u542c HTTP \u8bf7\u6c42</li> <li>\u5c06\u4ee5 <code>/</code>\u5f00\u5934\u7684\u8def\u5f84\u7684\u6240\u6709\u4f20\u5165\u8bf7\u6c42\uff08\u5373\u6240\u6709\u4f20\u5165\u8bf7\u6c42\uff09\u8f6c\u53d1\u5230\u4fe1\u4f7f\u4e0a\u6e38</li> </ul> <p>\u6ce8\uff1a\u8fd9\u4e0e NGINX \u5728\u751f\u4ea7\u73af\u5883\u4e2d\u4f5c\u4e3a\u53cd\u5411\u4ee3\u7406\u548c\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u5b9e\u9645\u914d\u7f6e\u5f88\u76f8\u4f3c\u3002\u552f\u4e00\u7684\u4e3b\u8981\u533a\u522b\u662f\uff0cupstream \u5757\u4e2d server \u6307\u4ee4\u7684\u53c2\u6570\u901a\u5e38\u662f\u57df\u540d\u6216 IP \u5730\u5740\uff0c\u800c\u975e localhost\u3002</p> <p>4 \u6253\u5f00 <code>opentelemetry_module.conf</code> \u5e76\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>NginxModuleEnabled ON;\nNginxModuleOtelSpanExporter otlp;\nNginxModuleOtelExporterEndpoint localhost:4317;\nNginxModuleServiceName messenger-lb;\nNginxModuleServiceNamespace MicroservicesMarchDemoArchitecture;\nNginxModuleServiceInstanceId DemoInstanceId;\nNginxModuleResolveBackends ON;\nNginxModuleTraceAsError ON;\n</code></pre> <p>5 \u6784\u5efa\u4e00\u4e2a\u5305\u542b NGINX \u548c NGINX OTel \u6a21\u5757\u7684 Docker \u955c\u50cf\uff1a</p> <pre><code>docker build -t messenger-lb .\n</code></pre> <p>6 \u542f\u52a8 NGINX \u53cd\u5411\u4ee3\u7406\u548c\u8d1f\u8f7d\u5747\u8861\u5668\u7684 Docker \u5bb9\u5668\uff1a</p> <pre><code>docker run --rm --name messenger-lb -p 8085:8085 --network=\"host\" messenger-lb\n</code></pre> <p>7 \u5728\u5ba2\u6237\u7aef\u7ec8\u7aef\uff0c\u901a\u8fc7 NGINX \u53cd\u5411\u4ee3\u7406\u548c\u8d1f\u8f7d\u5747\u8861\u5668\u5411\u4fe1\u4f7f\u670d\u52a1\u53d1\u9001\u5065\u5eb7\u68c0\u67e5\u8bf7\u6c42\uff08\u5728\u53d1\u9001\u8be5\u8bf7\u6c42\u4e4b\u524d\u65e0\u9700\u7b49\u5f85\uff09\uff1a</p> <pre><code>curl http://localhost:8085/health\n</code></pre> <p>\u6ce8\uff1a\u8ba9 NGINX \u548c\u5ba2\u6237\u7aef\u7ec8\u7aef\u4fdd\u6301\u6253\u5f00\u72b6\u6001\uff0c\u4ee5\u4fbf\u5728\u6311\u6218 3 \u4e2d\u518d\u6b21\u4f7f\u7528\u3002</p> <p>8 \u5728\u6d4f\u89c8\u5668\u4e2d\uff0c\u786e\u8ba4\u65b0\u7684 <code>messenger-lb</code>\u670d\u52a1\u4e0e\u60a8\u4e4b\u524d\u542f\u52a8\u7684\u670d\u52a1\u4e00\u540c\u5217\u5728 Jaeger \u7528\u6237\u754c\u9762\u4e2d\u3002\u60a8\u53ef\u80fd\u9700\u8981\u5728\u60a8\u7684\u6d4f\u89c8\u5668\u4e2d\u91cd\u65b0\u52a0\u8f7d Jaeger \u7528\u6237\u754c\u9762\u3002</p> <p></p>"},{"location":"chap_ot/2OpenTelemetry_MS/#3-otel","title":"\u6311\u6218 3\uff1a\u5b66\u4e60\u89e3\u8bfb OTel \u94fe\u8def\u8ffd\u8e2a","text":"<p>\u5728\u67b6\u6784\u548c\u7528\u6237\u6d41\u4e2d\uff0c\u6211\u4eec\u6982\u8ff0\u4e86\u7528\u6237\u6d41\u7684\u5404\u4e2a\u9636\u6bb5\uff0c\u73b0\u5728\u7b80\u5355\u56de\u987e\u4e00\u4e0b\uff1a</p> <ul> <li>\u4e00\u4f4d\u7528\u6237\u901a\u8fc7\u5411\u53e6\u4e00\u4f4d\u7528\u6237\u53d1\u9001\u6d88\u606f\u5f00\u59cb\u5bf9\u8bdd\u3002</li> <li>NGINX \u53cd\u5411\u4ee3\u7406\u62e6\u622a\u6d88\u606f\u5e76\u5c06\u5176\u8f6c\u53d1\u7ed9\u4fe1\u4f7f\u670d\u52a1\u3002</li> <li>\u8be5\u4fe1\u4f7f\u670d\u52a1\u5c06\u6d88\u606f\u5199\u5165\u5176\u6570\u636e\u5e93\uff0c\u7136\u540e\u901a\u8fc7 RabbitMQ \u6d3e\u53d1\u4e8b\u4ef6\u3002</li> <li>\u901a\u77e5\u5668\u670d\u52a1\u4f7f\u7528\u8be5\u4e8b\u4ef6\uff0c\u67e5\u8be2\u63a5\u6536\u8005\uff08\u7b2c\u4e8c\u4f4d\u7528\u6237\uff09\u7684\u901a\u77e5\u504f\u597d\uff0c\u5e76\u901a\u8fc7\u9996\u9009\u65b9\u6cd5\u5411\u63a5\u6536\u8005\u53d1\u9001\u901a\u77e5\u3002</li> </ul> <p>\u5b9e\u65bd\u9065\u6d4b\u7684\u76ee\u6807\u662f\uff1a</p> <ul> <li>\u4e86\u89e3\u4e00\u4e2a\u8bf7\u6c42\u5728\u65b0\u7684\u6d88\u606f\u6d41\u4e2d\u6240\u7ecf\u5386\u7684\u6240\u6709\u6b65\u9aa4\u3002</li> <li>\u786e\u8ba4\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u6d88\u606f\u6d41\u53ef\u5728\u4e94\u79d2\u949f\u5185\u7aef\u5230\u7aef\u6267\u884c\u5b8c\u6bd5\u3002</li> <li>\u67e5\u770b\u901a\u77e5\u5668\u670d\u52a1\u5728\u591a\u957f\u65f6\u95f4\u4e4b\u540e\u624d\u5f00\u59cb\u5904\u7406\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684\u4e8b\u4ef6\u3002</li> </ul> <p>\u5728\u8fd9\u4e2a\u6311\u6218\u4e2d\uff0c\u60a8\u5c06\u5b66\u4e60\u5982\u4f55\u8bc4\u4f30 OTel \u57cb\u70b9\u751f\u6210\u7684\u94fe\u8def\u8ffd\u8e2a\u662f\u5426\u6ee1\u8db3\u4e0a\u8ff0\u76ee\u6807\u8981\u6c42\u3002\u9996\u5148\uff0c\u8fd0\u884c\u7cfb\u7edf\u5e76\u521b\u5efa\u4e00\u4e9b\u94fe\u8def\u8ffd\u8e2a\u6570\u636e\u3002\u7136\u540e\uff0c\u68c0\u67e5\u6d88\u606f\u6d41\u7684\u94fe\u8def\u8ffd\u8e2a\u4ee5\u53ca\u5176\u4e2d\u5206\u522b\u7531 NGINX\u3001\u4fe1\u4f7f\u670d\u52a1\u548c\u901a\u77e5\u5668\u670d\u52a1\u751f\u6210\u7684\u90e8\u5206\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#_9","title":"\u521b\u5efa\u94fe\u8def\u8ffd\u8e2a\u6570\u636e","text":"<p>\u5728\u5ba2\u6237\u7aef\u7ec8\u7aef\uff0c\u8bbe\u7f6e\u5bf9\u8bdd\u5e76\u5728\u4e24\u4f4d\u7528\u6237\u4e4b\u95f4\u53d1\u9001\u51e0\u6761\u6d88\u606f\uff1a</p> <pre><code>curl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"participant_ids\": [1, 2]}' \\\n    'http://localhost:8085/conversations'\n\ncurl -X POST \\\n    -H \"User-Id: 1\" \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"content\": \"This is the first message\"}' \\\n    'http://localhost:8085/conversations/1/messages'\n\ncurl -X POST \\\n    -H \"User-Id: 2\" \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"content\": \"This is the second message\"}' \\\n    'http://localhost:8085/conversations/1/messages'\n</code></pre> <p>\u901a\u77e5\u5668\u670d\u52a1\u751f\u6210\u5982\u4e0b\u8f93\u51fa\uff0c\u5e76\u663e\u793a\u5728\u901a\u77e5\u5668\u7ec8\u7aef\u4e2d\uff1a</p> <pre><code>Received new_message: {\"type\":\"new_message\",\"channel_id\":1,\"user_id\":1,\"index\":1,\"participant_ids\":[1,2]}\nSending notification of new message via sms to 12027621401\n\nReceived new_message:  {\"type\":\"new_message\",\"channel_id\":1,\"user_id\":2,\"index\":2,\"participant_ids\":[1,2]}\n\nSending notification of new message via email to the_hotstepper@kamo.ze\n\nSending notification of new message via sms to 19147379938\n</code></pre>"},{"location":"chap_ot/2OpenTelemetry_MS/#_10","title":"\u51c6\u5907\u597d\u89e3\u8bfb\u94fe\u8def\u8ffd\u8e2a","text":"<p>\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 Jaeger \u7528\u6237\u754c\u9762\uff0c\u4ece Service \u4e0b\u62c9\u83dc\u5355\u4e2d\u9009\u62e9 <code>messenger-lb</code>\uff0c\u7136\u540e\u70b9\u51fb Find Traces \u6309\u94ae\u3002 \u6b64\u65f6\u754c\u9762\u4e0a\u4f1a\u663e\u793a\u4e00\u4e2a\u94fe\u8def\u8ffd\u8e2a\u5217\u8868\uff0c\u56de\u6eaf\u5230\u7528\u6237\u6d41\u8d77\u521d\u3002\u70b9\u51fb\u4efb\u4f55\u94fe\u8def\u8ffd\u8e2a\uff0c\u5373\u53ef\u663e\u793a\u76f8\u5173\u8be6\u60c5\uff0c\u5982\u4e0b\u622a\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u70b9\u51fb\u5e76\u67e5\u770b\u8be6\u60c5\u3002\u5728\u7ee7\u7eed\u64cd\u4f5c\u4e4b\u524d\uff0c\u8003\u8651\u4e00\u4e0b\u94fe\u8def\u8ffd\u8e2a\u4e2d\u7684\u4fe1\u606f\u53ef\u5982\u4f55\u5e2e\u52a9\u60a8\u5b9e\u73b0\u6311\u6218 3 \u7684\u7b80\u4ecb\u4e2d\u63d0\u5230\u7684\u76d1\u6d4b\u76ee\u6807\u3002\u76f8\u5173\u95ee\u9898\u5305\u62ec\uff1a</p> <ul> <li>\u54ea\u4e9b\u4fe1\u606f\u6709\u52a9\u4e8e\u5b9e\u73b0\u76ee\u6807\uff1f</li> <li>\u7f3a\u5c11\u4ec0\u4e48\u4fe1\u606f\uff1f</li> <li>\u54ea\u4e9b\u4fe1\u606f\u4e0d\u76f8\u5173\uff1f</li> </ul>"},{"location":"chap_ot/2OpenTelemetry_MS/#nginx-messenger-lb","title":"\u68c0\u67e5\u94fe\u8def\u8ffd\u8e2a\u7684 NGINX (messenger-lb) \u90e8\u5206","text":"<p>\u76ee\u6807 1\uff1a\u5728\u65b0\u7684\u6d88\u606f\u6d41\u4e2d\u67e5\u770b\u4e00\u4e2a\u8bf7\u6c42\u6240\u7ecf\u5386\u7684\u5168\u90e8\u6b65\u9aa4</p> <p>\u4ece NGINX span \u5f00\u59cb\uff0c\u7236 span \u5305\u542b 11 \u4e2a\u5b50 span\u3002\u7531\u4e8e\u5f53\u524d\u7684 NGINX \u914d\u7f6e\u975e\u5e38\u7b80\u5355\uff0c\u56e0\u6b64\u5b50 span \u610f\u4e49\u4e0d\u5927\uff0c\u53ea\u663e\u793a\u4e86 NGINX \u8bf7\u6c42\u5904\u7406\u751f\u547d\u5468\u671f\u4e2d\u6bcf\u4e2a\u6b65\u9aa4\u6240\u7528\u7684\u65f6\u95f4\u3002\u4f46 \u7236 span\uff08\u7b2c\u4e00\u4e2a\uff09\u63d0\u4f9b\u4e86\u4e00\u4e9b\u6709\u4ef7\u503c\u7684\u4fe1\u606f\uff1a</p> <p></p> <p>\u5728 Tags\uff08\u6807\u7b7e\uff09\u4e0b\uff0c\u60a8\u80fd\u591f\u770b\u5230\u4ee5\u4e0b\u5c5e\u6027\uff1a</p> <p>\u7efc\u5408\u6765\u770b\uff0c\u8fd9\u4e09\u6761\u4fe1\u606f\u4f20\u8fbe\u7684\u610f\u601d\u662f\uff1a\u201c\u5411 <code>/conversations/1/messages</code> \u53d1\u9001\u4e86\u4e00\u4e2a POST \u8bf7\u6c42\uff0c\u54cd\u5e94\u4e3a 201\uff08\u521b\u5efa\u6210\u529f\uff09\u201d\u3002\u8fd9\u4e0e\u67b6\u6784\u548c\u7528\u6237\u6d41\u4e2d\u7684\u7b2c\u4e00\u6b65\u548c\u7b2c 4a \u6b65\u76f8\u5bf9\u5e94\uff09\u3002</p> <ul> <li><code>http.method</code> \u5b57\u6bb5\u2014\u2014POST\uff08\u5728 REST \u672f\u8bed\u4e2d\uff0c\u8fd9\u610f\u5473\u7740\u521b\u5efa\uff09</li> <li><code>http.status_code</code> \u5b57\u6bb5\u2014\u2014201\uff08\u8868\u793a\u521b\u5efa\u6210\u529f\uff09</li> <li><code>http.target</code>\u5b57\u6bb5\u2014\u2014<code>conversations/1/messages</code> \uff08\u6d88\u606f\u7aef\u70b9\uff09</li> </ul> <p>\u5728 Process\uff08\u8fdb\u7a0b\uff09\u4e0b\uff0cwebengine.name \u5b57\u6bb5\u663e\u793a\u8fd9\u662f\u8be5\u8bf7\u6c42\u7684 NGINX \u90e8\u5206\u3002</p> <p>\u6b64\u5916\uff0c\u7531\u4e8e\u4fe1\u4f7f\u548c\u901a\u77e5\u5668\u7684 span \u5d4c\u5957\u5728 <code>messenger-lb conversations/1 span</code> \u5185\uff08\u5982\u51c6\u5907\u597d\u89e3\u8bfb\u94fe\u8def\u8ffd\u8e2a\u4e2d\u7684\u622a\u56fe\u6240\u793a\uff09\uff0c\u60a8\u53ef\u4ee5\u5224\u65ad\u901a\u8fc7 NGINX \u53cd\u5411\u4ee3\u7406\u53d1\u9001\u7ed9\u4fe1\u4f7f\u670d\u52a1\u7684\u8bf7\u6c42\u662f\u5426\u5230\u8fbe\u4e86\u6d41\u7a0b\u4e2d\u7684\u6240\u6709\u9884\u671f\u7ec4\u4ef6\u3002</p> <p>\u8be5\u4fe1\u606f\u6ee1\u8db3\u76ee\u6807\u8981\u6c42\uff0c\u56e0\u4e3a\u60a8\u53ef\u4ee5\u770b\u5230 NGINX \u53cd\u5411\u4ee3\u7406\u662f\u6d41\u7a0b\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u76ee\u6807 2\uff1a\u9a8c\u8bc1\u6d88\u606f\u6d41\u80fd\u5426\u5728\u4e94\u79d2\u5185\u6267\u884c\u5b8c\u6bd5</p> <p>\u5728\u6807\u8bb0 messenger-lb \u7684 span \u5217\u8868\u4e2d\uff0c\u67e5\u770b\u6700\u65b0 span\uff08\u4f4d\u4e8e\u5217\u8868\u7684\u5e95\u90e8\uff09\uff0c\u4ee5\u4e86\u89e3\u8bf7\u6c42\u7684 NGINX \u90e8\u5206\u6240\u7528\u65f6\u957f\u3002\u5728\u622a\u56fe\u4e2d\uff0cspan \u4ece 589 \u5fae\u79d2 (\u00b5s) \u5f00\u59cb\uff0c\u6301\u7eed\u4e86 24\u00b5s\uff0c\u8fd9\u610f\u5473\u7740\u6574\u4e2a\u53cd\u5411\u4ee3\u7406\u64cd\u4f5c\u53ea\u82b1\u4e86 613\u00b5s\u2014\u2014\u7ea6 0.6 \u6beb\u79d2 (ms)\u3002\uff08\u5f53\u7136\uff0c\u5f53\u60a8\u81ea\u5df1\u64cd\u4f5c\u672c\u6559\u7a0b\u6b65\u9aa4\u65f6\uff0c\u5177\u4f53\u6570\u503c\u4f1a\u6709\u6240\u4e0d\u540c\uff09\u3002</p> <p></p> <p>\u5728\u8fd9\u6837\u7684\u8bbe\u7f6e\u4e2d\uff0c\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e9b\u503c\u53ea\u662f\u76f8\u5bf9\u4e8e\u5176\u4ed6\u5ea6\u91cf\u503c\u800c\u8a00\u6709\u7528\uff0c\u5e76\u968f\u7cfb\u7edf\u800c\u53d8\u3002\u4e0d\u8fc7\u5728\u672c\u4f8b\u4e2d\uff0c\u8be5\u64cd\u4f5c\u7684\u65f6\u957f\u663e\u7136\u4e0d\u5230 5 \u79d2\u9608\u503c\u3002</p> <p>\u8be5\u4fe1\u606f\u6ee1\u8db3\u76ee\u6807\u8981\u6c42\uff0c\u56e0\u4e3a\u60a8\u53ef\u4ee5\u770b\u5230 NGINX \u64cd\u4f5c\u7684\u65f6\u957f\u90fd\u4e0d\u66fe\u63a5\u8fd1 5 \u79d2\u3002\u5982\u679c\u6d88\u606f\u6d41\u4e2d\u51fa\u73b0\u4e86\u975e\u5e38\u7f13\u6162\u7684\u64cd\u4f5c\uff0c\u90a3\u4e00\u5b9a\u662f\u540e\u6765\u53d1\u751f\u7684\u3002</p> <p>\u76ee\u6807 3\uff1a\u67e5\u770b\u901a\u77e5\u5668\u670d\u52a1\u8bfb\u53d6\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684\u4e8b\u4ef6\u9700\u8981\u591a\u957f\u65f6\u95f4</p> <p>NGINX \u53cd\u5411\u4ee3\u7406\u5c42\u5e76\u4e0d\u5305\u62ec\u4efb\u4f55\u76f8\u5173\u4fe1\u606f\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u8f6c\u5230\u4fe1\u4f7f span\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#_11","title":"\u68c0\u67e5\u94fe\u8def\u8ffd\u8e2a\u7684\u4fe1\u4f7f\u90e8\u5206","text":"<p>\u76ee\u6807 1\uff1a\u5728\u65b0\u7684\u6d88\u606f\u6d41\u4e2d\u67e5\u770b\u4e00\u4e2a\u8bf7\u6c42\u6240\u7ecf\u5386\u7684\u5168\u90e8\u6b65\u9aa4</p> <p>\u94fe\u8def\u8ffd\u8e2a\u7684\u4fe1\u4f7f\u670d\u52a1\u90e8\u5206\u5305\u542b\u53e6\u5916 11 \u4e2a span\u3002\u540c\u6837\uff0c\u5927\u591a\u6570\u5b50 span \u6d89\u53ca Express \u6846\u67b6\u5728\u5904\u7406\u8bf7\u6c42\u65f6\u4f7f\u7528\u7684\u57fa\u672c\u6b65\u9aa4\uff0c\u610f\u4e49\u4e0d\u5927\u3002\u4f46\u7236 span\uff08\u7b2c\u4e00\u4e2a\uff09\u518d\u6b21\u63d0\u4f9b\u4e86\u4e00\u4e9b\u6709\u4ef7\u503c\u7684\u4fe1\u606f\uff1a</p> <p></p> <p>\u5728 Tags \u4e0b\uff0c\u60a8\u80fd\u591f\u770b\u5230\u4ee5\u4e0b\u5c5e\u6027\uff1a</p> <ul> <li><code>http.method</code> \u5b57\u6bb5\u2014\u2014POST\uff08\u540c\u6837\u5728 REST \u672f\u8bed\u4e2d\uff0c\u8fd9\u610f\u5473\u7740\u521b\u5efa\uff09</li> <li><code>http.route</code> \u5b57\u6bb5\u2014\u2014<code>/conversations/:conversationId/messages</code>\uff08\u6d88\u606f\u8def\u7531\uff09</li> <li><code>http.target</code> \u5b57\u6bb5\u2014\u2014<code>/conversations/1/messages</code>\uff08\u6d88\u606f\u7aef\u70b9\uff09</li> </ul> <p>\u8be5\u4fe1\u606f\u6ee1\u8db3\u76ee\u6807\u8981\u6c42\uff0c\u56e0\u4e3a\u4ece\u4e2d\u53ef\u4ee5\u770b\u51fa\u4fe1\u4f7f\u670d\u52a1\u662f\u6d41\u7a0b\u7684\u4e00\u90e8\u5206\uff0c\u800c\u4e14\u5230\u8fbe\u7684\u7aef\u70b9\u662f\u65b0\u7684\u6d88\u606f\u7aef\u70b9\u3002</p> <p>\u76ee\u6807 2\uff1a\u9a8c\u8bc1\u6d88\u606f\u6d41\u80fd\u5426\u5728\u4e94\u79d2\u5185\u6267\u884c\u5b8c\u6bd5</p> <p>\u5982\u4e0b\u622a\u56fe\u6240\u793a\uff0c\u94fe\u8def\u8ffd\u8e2a\u7684\u4fe1\u4f7f\u90e8\u5206\u5f00\u59cb\u4e8e 1.28 ms\uff0c\u7ed3\u675f\u4e8e 36.28ms\uff0c\u603b\u65f6\u957f\u4e3a 35ms\u3002\u5176\u4e2d\u5927\u90e8\u5206\u65f6\u95f4\u82b1\u5728\u89e3\u6790 JSON\uff08middleware - jsonParser\uff09\u548c\u8fde\u63a5\u6570\u636e\u5e93\uff08pg-pool.connect \u548c tcp.connect\uff09\u4e0a\u3002</p> <p>\u9274\u4e8e\u5728\u6d88\u606f\u7f16\u5199\u8fc7\u7a0b\u4e2d\u8fd8\u8fdb\u884c\u4e86\u51e0\u6b21 SQL \u67e5\u8be2\uff0c\u56e0\u6b64\u8fd9\u4e5f\u5f88\u5408\u7406\u3002\u8fd9\u53cd\u8fc7\u6765\u8868\u660e\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u589e\u52a0\u81ea\u52a8\u57cb\u70b9\u914d\u7f6e\uff0c\u4ee5\u6355\u83b7\u8fd9\u4e9b\u67e5\u8be2\u7684\u7528\u65f6\u3002\uff08\u672c\u6559\u7a0b\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u989d\u5916\u7684\u57cb\u70b9\uff0c\u56e0\u6b64\u5728\u6311\u6218 4 \u4e2d\uff0c\u60a8\u4f1a\u624b\u52a8\u521b\u5efa span\uff0c\u540e\u8005\u53ef\u7528\u4e8e\u6253\u5305\u6570\u636e\u5e93\u67e5\u8be2\u3002\uff09</p> <p></p> <p>\u8be5\u4fe1\u606f\u6ee1\u8db3\u76ee\u6807\u8981\u6c42\uff0c\u56e0\u4e3a\u4ece\u4e2d\u53ef\u4ee5\u770b\u51fa\u4fe1\u4f7f\u64cd\u4f5c\u7684\u65f6\u957f\u90fd\u4e0d\u66fe\u63a5\u8fd1 5 \u79d2\u3002\u5982\u679c\u6d88\u606f\u6d41\u4e2d\u51fa\u73b0\u4e86\u975e\u5e38\u7f13\u6162\u7684\u64cd\u4f5c\uff0c\u90a3\u4e00\u5b9a\u662f\u540e\u6765\u53d1\u751f\u7684\u3002</p> <p>\u76ee\u6807 3\uff1a\u67e5\u770b\u901a\u77e5\u5668\u670d\u52a1\u8bfb\u53d6\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684\u4e8b\u4ef6\u9700\u8981\u591a\u957f\u65f6\u95f4</p> <p>\u4e0e NGINX span \u4e00\u6837\uff0c\u4fe1\u4f7f span \u4e0d\u5305\u542b\u8fd9\u4e9b\u4fe1\u606f\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u8f6c\u5230\u901a\u77e5\u5668 span\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#_12","title":"\u68c0\u67e5\u94fe\u8def\u8ffd\u8e2a\u7684\u901a\u77e5\u5668\u90e8\u5206","text":"<p>\u76ee\u6807 1\uff1a\u5728\u65b0\u7684\u6d88\u606f\u6d41\u4e2d\u67e5\u770b\u4e00\u4e2a\u8bf7\u6c42\u6240\u7ecf\u5386\u7684\u5168\u90e8\u6b65\u9aa4</p> <p>\u94fe\u8def\u8ffd\u8e2a\u7684\u901a\u77e5\u5668\u90e8\u5206\u53ea\u5305\u542b\u4e24\u4e2a span\uff1a</p> <p></p> <ul> <li><code>chat_queue process</code> span\u2014\u2014\u786e\u8ba4\u901a\u77e5\u5668\u670d\u52a1\u5904\u7406\u4e86\u6765\u81ea chat_queue \u6d88\u606f\u961f\u5217\u7684\u4e8b\u4ef6</li> <li><code>pg-pool.connect</code> span\u2014\u2014\u663e\u793a\u5904\u7406\u5b8c\u4e8b\u4ef6\u540e\uff0c\u901a\u77e5\u5668\u670d\u52a1\u4e0e\u5176\u6570\u636e\u5e93\u5efa\u7acb\u4e86\u67d0\u79cd\u8fde\u63a5</li> </ul> <p>\u4ec5\u51ed\u4ece\u8fd9\u4e9b span \u4e2d\u83b7\u53d6\u7684\u4fe1\u606f\uff0c\u65e0\u6cd5\u5168\u9762\u4e86\u89e3\u6bcf\u4e00\u6b65\u3002\u60a8\u53ef\u4ee5\u770b\u5230\u901a\u77e5\u5668\u670d\u52a1\u4f7f\u7528\u6765\u81ea\u961f\u5217\u7684\u4e8b\u4ef6\uff0c\u4f46\u5374\u4e0d\u77e5\u9053\uff1a</p> <ul> <li>\u8be5\u670d\u52a1\u53d1\u9001\u7684\u6d88\u606f\u901a\u77e5\u662f\u5426\u4e0e\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684\u4e8b\u4ef6\u76f8\u5bf9\u5e94</li> <li>\u76f8\u5173\u6d88\u606f\u901a\u77e5\u662f\u5426\u6b63\u786e\u5730\u53d1\u9001\u7ed9\u4e86\u6d88\u606f\u63a5\u6536\u8005</li> </ul> <p>\u8fd9\u8868\u660e\u60a8\u9700\u8981\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\u624d\u80fd\u5145\u5206\u4e86\u89e3\u901a\u77e5\u5668\u670d\u52a1\u6d41\uff1a</p> <ul> <li>\u624b\u52a8\u76d1\u6d4b\u663e\u793a\u901a\u77e5\u6b63\u5728\u53d1\u9001\u4e2d\u7684 span</li> <li>\u786e\u4fdd\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684\u4e8b\u4ef6\u548c\u901a\u77e5\u5668\u670d\u52a1\u4f7f\u7528\u7684\u4e8b\u4ef6\u4e4b\u95f4\u4ee5\u94fe\u8def\u8ffd\u8e2a ID \u7684\u5f62\u5f0f\u5efa\u7acb\u4e86\u660e\u786e\u7684\u8054\u7cfb</li> </ul> <p>\u76ee\u6807 2\uff1a\u9a8c\u8bc1\u6d88\u606f\u6d41\u80fd\u5426\u5728\u4e94\u79d2\u5185\u6267\u884c\u5b8c\u6bd5</p> <p>\u901a\u8fc7\u67e5\u770b\u901a\u77e5\u5668\u670d\u52a1 span \u7684\u603b\u7528\u65f6\uff0c\u60a8\u53ef\u4ee5\u770b\u5230\u8bf7\u6c42\u5728\u6d88\u606f\u6d41\u7684\u901a\u77e5\u5668\u90e8\u5206\u82b1\u8d39\u4e86 30.77 ms\u3002\u4f46\u662f\uff0c\u7531\u4e8e\u6ca1\u6709\u8868\u793a\u6574\u4e2a\u6d88\u606f\u6d41\uff08\u5411\u63a5\u6536\u8005\u53d1\u9001\u901a\u77e5\uff09\u201c\u7ed3\u675f\u201d\u7684 span\uff0c\u56e0\u6b64\u60a8\u65e0\u6cd5\u786e\u5b9a\u6d88\u606f\u6d41\u8fd9\u4e00\u90e8\u5206\u7684\u603b\u7528\u65f6\u6216\u64cd\u4f5c\u5b8c\u6210\u7684\u603b\u7528\u65f6\u3002</p> <p>\u76ee\u6807 3\uff1a\u67e5\u770b\u901a\u77e5\u5668\u670d\u52a1\u8bfb\u53d6\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684\u4e8b\u4ef6\u9700\u8981\u591a\u957f\u65f6\u95f4</p> <p>\u60a8\u53ef\u4ee5\u770b\u5230\u901a\u77e5\u5668\u670d\u52a1\u7684 <code>chat_queue</code> process \u5f00\u59cb\u4e8e 6.12ms\uff0c\u5373\u4fe1\u4f7f\u670d\u52a1\u7684 <code>chat_queue</code> send \u5f00\u59cb\uff08\u4e8e 4.12ms\uff09\u540e 2ms\u3002</p> <p></p> <p>\u8be5\u76ee\u6807\u8fbe\u6210\u4e86\uff0c\u56e0\u4e3a\u60a8\u77e5\u9053\u901a\u77e5\u5668\u5728\u4fe1\u4f7f \u670d\u52a1\u6d3e\u53d1\u4e8b\u4ef6 2ms \u540e\u4f7f\u7528\u4e86\u8be5\u4e8b\u4ef6\u3002\u4e0e\u76ee\u6807 2 \u4e0d\u540c\u7684\u662f\uff0c\u60a8\u4e0d\u9700\u8981\u77e5\u9053\u4e8b\u4ef6\u662f\u5426\u5df2\u88ab\u5b8c\u5168\u5904\u7406\uff0c\u4e5f\u4e0d\u9700\u8981\u77e5\u9053\u8017\u65f6\u591a\u5c11\u4fbf\u53ef\u5b9e\u73b0\u6b64\u76ee\u6807\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#_13","title":"\u7ed3\u8bba","text":"<p>\u6839\u636e\u6211\u4eec\u5bf9\u5f53\u524d OTel \u81ea\u52a8\u57cb\u70b9\u751f\u6210\u7684\u94fe\u8def\u8ffd\u8e2a\u7684\u5206\u6790\uff0c\u53ef\u4ee5\u6e05\u695a\u5730\u53d1\u73b0\uff1a</p> <p>\u8bb8\u591a span \u4ee5\u5f53\u524d\u5f62\u5f0f\u800c\u8a00\u6beb\u65e0\u7528\u5904\uff1a</p> <ul> <li>NGINX \u6b63\u5728\u751f\u6210\u4e0e\u529f\u80fd\u76f8\u5173\u7684 span\uff0c\u4f8b\u5982\u6388\u6743\u68c0\u67e5\u548c\u6587\u4ef6\u670d\u52a1\uff0c\u4f46\u8fd9\u4e9b span \u4e0e\u60a8\u6240\u5173\u5fc3\u7684\u89d2\u8272 \u2014 \u53cd\u5411\u4ee3\u7406\u65e0\u5173\u3002\u4f46\u76ee\u524d\u9762\u5411 NGINX \u7684 OTel \u57cb\u70b9\u4e0d\u5141\u8bb8\u60a8\u7701\u7565\u4e0d\u76f8\u5173\u7684 span\uff0c\u56e0\u6b64\u6211\u4eec\u4e5f\u65e0\u80fd\u4e3a\u529b\u3002</li> <li>\u5728 Node.js \u670d\u52a1\uff08\u4fe1\u4f7f\u548c\u901a\u77e5\u5668\u670d\u52a1\uff09\u7684 span \u4e2d\uff0c\u4ee5\u4e0b span \u4f3c\u4e4e\u4e0e\u76ee\u6807\u76f8\u5173\uff1aJSON \u89e3\u6790\u3001request handler \u4ee5\u53ca\u6240\u6709\u6570\u636e\u5e93\u64cd\u4f5c\u7684 span\u3002\u4e00\u4e9b\u4e2d\u95f4\u4ef6 span\uff08\u4f8b\u5982 expressInit \u548c corsMiddleware\uff09\u4f3c\u4e4e\u4e0d\u76f8\u5173\uff0c\u53ef\u4ee5\u79fb\u9664\u3002</li> </ul> <p>\u4ee5\u4e0b\u670d\u52a1\u7f3a\u5c11\u5173\u952e span\uff1a</p> <ul> <li>\u901a\u77e5\u5668\u670d\u52a1\u53d1\u9001\u7684\u901a\u77e5</li> <li>\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684 RabbitMQ \u4e8b\u4ef6\u4e0e\u901a\u77e5\u5668\u670d\u52a1\u5904\u7406\u7684\u4e8b\u4ef6\u4e4b\u95f4\u7684\u660e\u786e\u6620\u5c04</li> </ul> <p>\u8fd9\u610f\u5473\u7740\uff0c\u57fa\u672c\u57cb\u70b9\u6ee1\u8db3\u4e86\u6700\u540e\u4e00\u4e2a\u76ee\u6807\u8981\u6c42\uff1a</p> <ul> <li>\u67e5\u770b\u901a\u77e5\u5668\u670d\u52a1\u5728\u591a\u957f\u65f6\u95f4\u4e4b\u540e\u5f00\u59cb\u5904\u7406\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684\u4e8b\u4ef6\u3002</li> </ul> <p>\u7136\u800c\uff0c\u6ca1\u6709\u8db3\u591f\u7684\u4fe1\u606f\u6765\u5b9e\u73b0\u524d\u4e24\u4e2a\u76ee\u6807\uff1a</p> <ul> <li>\u4e86\u89e3\u4e00\u4e2a\u8bf7\u6c42\u5728\u65b0\u7684\u6d88\u606f\u6d41\u4e2d\u6240\u7ecf\u5386\u7684\u6240\u6709\u6b65\u9aa4\u3002</li> <li>\u786e\u8ba4\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u6d88\u606f\u6d41\u53ef\u5728\u4e94\u79d2\u949f\u5185\u7aef\u5230\u7aef\u6267\u884c\u5b8c\u6bd5\u3002</li> </ul>"},{"location":"chap_ot/2OpenTelemetry_MS/#4","title":"\u6311\u6218 4\uff1a\u6839\u636e\u94fe\u8def\u8ffd\u8e2a\u89e3\u8bfb\u4f18\u5316\u57cb\u70b9","text":"<p>\u5728\u8fd9\u4e2a\u6311\u6218\u4e2d\uff0c\u60a8\u5c06\u9700\u8981\u6839\u636e\u5728\u6311\u6218 3 \u4e2d\u5b8c\u6210\u7684\u8ffd\u8e2a\u5206\u6790\uff0c\u4f18\u5316 OTel \u57cb\u70b9\u3002\u5176\u4e2d\u5305\u62ec\u5220\u9664\u4e0d\u5fc5\u8981\u7684 span, \u521b\u5efa\u65b0\u7684\u81ea\u5b9a\u4e49 span\uff0c\u5e76\u786e\u8ba4\u901a\u77e5\u5668\u670d\u52a1\u4f7f\u7528\u7684\u4e8b\u4ef6\u662f\u4fe1\u4f7f\u670d\u52a1\u751f\u6210\u7684\u4e8b\u4ef6\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#span","title":"\u5220\u9664\u4e0d\u5fc5\u8981\u7684 span","text":"<p>1.\u5728\u60a8\u5e38\u7528\u7684\u6587\u672c\u7f16\u8f91\u5668\u4e2d\uff0c\u6253\u5f00\u4fe1\u4f7f\u4ee3\u7801\u5e93\u7684 app \u76ee\u5f55\u4e0b\u7684 tracing.mjs \u6587\u4ef6\uff0c\u5e76\u5728\u9876\u90e8\u7684\u5bfc\u5165\u8bed\u53e5\u5217\u8868\u7684\u672b\u5c3e\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>const IGNORED_EXPRESS_SPANS = new Set([\n  \"middleware - expressInit\",\n  \"middleware - corsMiddleware\",\n]);\n</code></pre> <p>\u8fd9\u5b9a\u4e49\u4e86\u4e00\u7ec4 span \u540d\u79f0\uff0c\u8fd9\u4e9b\u540d\u79f0\u6765\u81ea\u4e8e\u4e0b\u9762 Jaeger \u7528\u6237\u754c\u9762\u622a\u56fe\u4e2d\u7684 span \u5217\u8868\uff0c\u4f46\u7531\u4e8e\u65e0\u6cd5\u4e3a\u8be5\u6d88\u606f\u6d41\u63d0\u4f9b\u6709\u7528\u7684\u4fe1\u606f\u800c\u5c06\u4ece\u8ffd\u8e2a\u4e2d\u5220\u9664\u3002\u60a8\u53ef\u80fd\u51b3\u5b9a\u4e5f\u4e0d\u9700\u8981\u8be5\u622a\u56fe\u4e2d\u6240\u5217\u7684\u5176\u4ed6 span\uff0c\u5e76\u5c06\u5176\u6dfb\u52a0\u5230 `IGNORED_EXPRESS_SPANS \u5217\u8868\u4e2d\u3002</p> <p></p> <p>2.\u5c06\u8fc7\u6ee4\u5668\u6dfb\u52a0\u81f3\u81ea\u52a8\u57cb\u70b9\u914d\u7f6e\uff0c\u4ee5\u5220\u9664\u60a8\u4e0d\u9700\u8981\u7684 span\uff0c\u5177\u4f53\u65b9\u6cd5\u662f\u5c06\u4e0b\u5217\u6a59\u8272\u9ad8\u4eae\u663e\u793a\u7684\u90e8\u5206\uff1a</p> <pre><code>const sdk = new opentelemetry.NodeSDK({\n  resource,\n  traceExporter: new OTLPTraceExporter({ headers: {} }),\n  instrumentations: [getNodeAutoInstrumentations()],\n});\n</code></pre> <p>\u66f4\u6539\u4e3a\u4ee5\u4e0b\u884c\uff1a</p> <pre><code>const sdk = new opentelemetry.NodeSDK({\n  resource,\n  traceExporter: new OTLPTraceExporter({ headers: {} }),\n  instrumentations: [\n    getNodeAutoInstrumentations({\n      \"@opentelemetry/instrumentation-express\": {\n        ignoreLayers: [\n          (name) =&gt; {\n            return IGNORED_EXPRESS_SPANS.has(name);\n          },\n        ],\n      },\n    }),\n  ],\n});\n</code></pre> <p><code>getNodeAutoInstrumentations</code> \u51fd\u6570\u5f15\u7528\u4e86\u7b2c\u4e00\u6b65\u4e2d\u5b9a\u4e49\u7684 span \u96c6\uff0c\u4ee5\u5c06\u8fd9\u4e9b span \u4ece @opentelemetry/instrumentation-express \u751f\u6210\u7684\u94fe\u8def\u8ffd\u8e2a\u4e2d\u6ee4\u9664\u3002\u6362\u800c\u8a00\u4e4b\uff0c\u5bf9\u4e8e\u5c5e\u4e8e <code>IGNORED_EXPRESS_SPANS</code> \u7684 span\uff0c\u5c06 return \u8bed\u53e5\u89e3\u6790\u4e3a true\uff0c\u540c\u65f6 <code>ignoreLayers</code> \u8bed\u53e5\u4ece\u94fe\u8def\u8ffd\u8e2a\u4e2d\u79fb\u9664\u8be5 span\u3002</p> <p>3.\u5728\u4fe1\u4f7f\u7ec8\u7aef\uff0c\u6309\u4e0b Ctrl+c \u6765\u505c\u6b62\u4fe1\u4f7f\u670d\u52a1\u3002\u7136\u540e\u91cd\u542f\u5b83\u3002</p> <pre><code>^c\nnode --import ./tracing.mjs index.mjs\n</code></pre> <p>4.\u7b49\u5f85\u5927\u7ea6\u5341\u79d2\u949f\uff0c\u7136\u540e\u5728\u5ba2\u6237\u7aef\u7ec8\u7aef\u53d1\u9001\u4e00\u6761\u65b0\u6d88\u606f\uff1a</p> <pre><code>curl -X POST \\\n -H \"User-Id: 2\" \\\n -H \"Content-Type: application/json\" \\\n -d '{\"content\": \"This is the second message\"}' \\\n 'http://localhost:8085/conversations/1/messages'\n</code></pre> <p>5 \u5728 Jaeger \u7528\u6237\u754c\u9762\u4e2d\u518d\u68c0\u67e5\u4fe1\u4f7f span\u3002\u4e24\u4e2a <code>middleware span \u2014 expressInit</code> \u548c <code>corsMiddleware</code>\u4e0d\u518d\u663e\u793a\uff08\u60a8\u53ef\u4ee5\u5c06\u5176\u4e0e\u6311\u6218 3 \u4e2d\u68c0\u67e5\u94fe\u8def\u8ffd\u8e2a\u7684\u4fe1\u4f7f\u90e8\u5206\u7684\u76ee\u6807 2 \u622a\u56fe\u8fdb\u884c\u6bd4\u8f83\uff09\u3002</p> <p></p>"},{"location":"chap_ot/2OpenTelemetry_MS/#span_1","title":"\u8bbe\u7f6e\u81ea\u5b9a\u4e49 span","text":"<p>\u5728\u8fd9\u4e00\u90e8\u5206\u4e2d\uff0c\u60a8\u5c06\u9996\u6b21\u63a5\u89e6\u5230\u5e94\u7528\u4ee3\u7801\u3002\u81ea\u52a8\u57cb\u70b9\u65e0\u9700\u66f4\u6539\u5e94\u7528\u4fbf\u53ef\u751f\u6210\u5927\u91cf\u4fe1\u606f\uff0c\u4f46\u6709\u4e9b\u89c1\u89e3\u5fc5\u987b\u901a\u8fc7\u5bf9\u4e1a\u52a1\u903b\u8f91\u7684\u7279\u5b9a\u90e8\u5206\u8fdb\u884c\u76d1\u6d4b\u624d\u80fd\u83b7\u53d6\u3002</p> <p>\u5bf9\u4e8e\u60a8\u6b63\u5728\u76d1\u6d4b\u7684\u65b0\u6d88\u606f\u6d41\uff0c\u4e00\u4e2a\u793a\u4f8b\u662f\u8ddf\u8e2a\u5411\u6d88\u606f\u63a5\u6536\u8005\u53d1\u9001\u901a\u77e5\u3002</p> <p>1.\u6253\u5f00\u901a\u77e5\u5668\u4ee3\u7801\u5e93\u7684 app \u76ee\u5f55\u4e0b\u7684 index.mjs\u3002\u8be5\u6587\u4ef6\u5305\u542b\u670d\u52a1\u7684\u6240\u6709\u4e1a\u52a1\u903b\u8f91\u3002\u5728\u6587\u4ef6\u9876\u90e8\u7684 import \u8bed\u53e5\u5217\u8868\u7684\u672b\u5c3e\u6dfb\u52a0\u4ee5\u4e0b\u884c\uff1a</p> <pre><code>import { trace } from \"@opentelemetry/api\";\n</code></pre> <p>2.\u66ff\u6362\u8be5\u4ee3\u7801\uff08\u5728\u6587\u4ef6\u4e2d\u7684\u7b2c 91 \u884c\u5de6\u53f3\uff09\uff1a</p> <pre><code>for (let pref of preferences) {\n  console.log(\n    `Sending notification of new message via ${pref.address_type} to ${pref.address}`\n  );\n}\n</code></pre> <p>\u7528\u4ee5\u4e0b\u4ee3\u7801\u66ff\u6362\u4e0a\u6587:</p> <pre><code>const tracer = trace.getTracer(\"notifier\"); // 1\ntracer.startActiveSpan( // 2\n  \"notification.send_all\",\n  {\n    attributes: {\n      user_id: msg.user_id,\n    },\n  },\n  (parentSpan) =&gt; {\n    for (let pref of preferences) {\n      tracer.startActiveSpan(  // 3\n        \"notification.send\",\n        {\n          attributes: { // 4\n            notification_type: pref.address_type,\n            user_id: pref.user_id,\n          },\n        },\n        (span) =&gt; {\n          console.log(\n            `Sending notification of new message via ${pref.address_type} to ${pref.address}`\n          );\n          span.end(); // 5\n        }\n      );\n    }\n    parentSpan.end(); // 6\n  }\n);\n</code></pre> <p>\u65b0\u4ee3\u7801\u4f1a\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ul> <li>\u83b7\u53d6 tracer\uff0c\u5b83\u662f\u4e00\u4e2a\u5168\u5c40\u5bf9\u8c61\uff0c\u7528\u4e8e\u4e0e OTel \u94fe\u8def\u8ffd\u8e2a\u8fdb\u884c\u4ea4\u4e92\u3002</li> <li>\u5f00\u542f\u4e00\u4e2a\u540d\u4e3a <code>notification.send_all</code> \u7684\u65b0\u7684\u7236 span\uff0c\u5e76\u8bbe\u7f6e <code>user_id</code> \u5c5e\u6027\u4ee5\u8bc6\u522b\u6d88\u606f\u7684\u53d1\u9001\u8005\u3002</li> <li>\u8fdb\u5165\u4e00\u4e2a\u5faa\u73af\uff0c\u5176\u4e2d\u5217\u4e3e\u4e86\u63a5\u6536\u8005\u7684\u901a\u77e5\u504f\u597d\uff0c\u5e76\u5728 <code>notification.send_all</code> \u4e0b\u65b0\u5efa\u4e86\u4e00\u4e2a\u540d\u4e3a <code>notification.send</code> \u7684\u5b50 `span\u3002\u6bcf\u4e2a\u901a\u77e5\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a\u65b0 span\u3002</li> <li>\u4e3a\u5b50 span \u8bbe\u7f6e\u66f4\u591a\u7684\u5c5e\u6027\uff1a</li> <li>notification_type\u2014\u2014\u77ed\u4fe1\u6216\u7535\u5b50\u90ae\u4ef6\u4e4b\u4e00</li> <li>user_id\u2014\u2014\u901a\u77e5\u63a5\u6536\u7528\u6237\u7684 ID</li> <li>\u4f9d\u6b21\u5173\u95ed\u6bcf\u4e2a\u5b50 <code>notification.send</code>\u3002</li> <li>\u5173\u95ed\u7236 <code>notification.send_all</code>\u3002</li> </ul> <pre><code>^c\nnode --import ./tracing.mjs index.mjs\n</code></pre> <p>4 \u7b49\u5f85\u5927\u7ea6\u5341\u79d2\u949f\uff0c\u7136\u540e\u5728\u5ba2\u6237\u7aef\u7ec8\u7aef\u53d1\u9001\u4e00\u6761\u65b0\u6d88\u606f\uff1a</p> <pre><code>curl -X POST \\\n -H \"User-Id: 2\" \\\n -H \"Content-Type: application/json\" \\\n -d '{\"content\": \"This is the second message\"}' \\\n 'http://localhost:8085/conversations/1/messages'\n</code></pre> <p>5 \u5728 Jaeger \u7528\u6237\u754c\u9762\u4e2d\u518d\u68c0\u67e5\u901a\u77e5\u5668 span\u3002\u60a8\u4f1a\u770b\u5230\u7236 span \u548c\u4e24\u4e2a\u5b50 span\uff0c\u6bcf\u4e2a span \u90fd\u6709\u201c\u53d1\u9001\u901a\u77e5\u201d\u64cd\u4f5c\uff1a</p> <p></p> <p>\u73b0\u5728\u60a8\u53ef\u4ee5\u5b8c\u5168\u5b9e\u73b0\u7b2c\u4e00\u4e2a\u548c\u7b2c\u4e8c\u4e2a\u76ee\u6807\uff0c\u56e0\u4e3a\u60a8\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u8bf7\u6c42\u5728\u65b0\u7684\u6d88\u606f\u6d41\u4e2d\u6240\u7ecf\u5386\u7684\u6240\u6709\u6b65\u9aa4\u3002\u5728\u6bcf\u4e2a span \u4e0a\u6240\u82b1\u8d39\u7684\u65f6\u95f4\u80fd\u591f\u66b4\u9732\u8fd9\u4e9b\u6b65\u9aa4\u4e4b\u95f4\u7684\u4efb\u4f55\u5ef6\u8fdf\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#_14","title":"\u786e\u8ba4\u4fe1\u4f7f\u548c\u901a\u77e5\u5668\u6b63\u5728\u5904\u7406\u540c\u4e00\u4e2a\u4e8b\u4ef6","text":"<p>\u5982\u6b32\u5168\u9762\u4e86\u89e3\u6d88\u606f\u6d41\uff0c\u60a8\u8fd8\u9700\u8981\u786e\u8ba4\u4ee5\u4e0b\u4e00\u70b9\u3002\u901a\u77e5\u5668\u670d\u52a1\u5904\u7406\u7684\u4e8b\u4ef6\u5b9e\u9645\u4e0a\u662f\u4fe1\u4f7f\u670d\u52a1\u6d3e\u53d1\u7684\u4e8b\u4ef6\u5417\uff1f</p> <p>\u60a8\u4e0d\u5fc5\u505a\u51fa\u4efb\u4f55\u660e\u786e\u7684\u4fee\u6539\u4fbf\u53ef\u8fde\u63a5\u8fd9\u4e24\u4e2a\u8ffd\u8e2a\uff0c\u4f46\u60a8\u4e5f\u4e0d\u80fd\u76f2\u76ee\u76f8\u4fe1\u81ea\u52a8\u57cb\u70b9\u3002</p> <p>\u8003\u8651\u5230\u8fd9\u4e00\u70b9\uff0c\u60a8\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e9b\u5feb\u901f\u8c03\u8bd5\u4ee3\u7801\uff0c\u4ee5\u9a8c\u8bc1\u5728 NGINX \u670d\u52a1\u4e2d\u542f\u52a8\u7684\u8ffd\u8e2a\u786e\u5b9e\u4e0e\u901a\u77e5\u5668\u670d\u52a1\u6240\u7528\u7684\u8ffd\u8e2a\u76f8\u540c\uff08\u5177\u6709\u76f8\u540c\u7684\u8ffd\u8e2a ID\uff09\u3002</p> <p>1.\u6253\u5f00\u4fe1\u4f7f\u4ee3\u7801\u5e93\u7684 app \u76ee\u5f55\u4e0b\u7684 index.mjs \u6587\u4ef6\uff0c\u5e76\u8fdb\u884c\u4ee5\u4e0b\u4fee\u6539\uff1a</p> <p>\u5728\u9876\u90e8\u7684\u5bfc\u5165\u8bed\u53e5\u5217\u8868\u7684\u672b\u5c3e\u6dfb\u52a0\u4ee5\u4e0b\u4ee3\u7801\uff1a</p> <pre><code>import { trace } from \"@opentelemetry/api\";\n</code></pre> <p>\u5728\u73b0\u6709\u7684\u9ed1\u8272\u884c\u4e0b\u9762\u6dfb\u52a0\u6a59\u8272\u9ad8\u4eae\u663e\u793a\u7684\u4ee3\u7801\uff1a</p> <pre><code>async function createMessageInConversation(req, res) {\n  const tracer = trace.getActiveSpan();\n  console.log(\"TRACE_ID: \", tracer.spanContext().traceId);\n</code></pre> <p>\u65b0\u884c\u5217\u51fa\u4e86\u4fe1\u4f7f\u4e2d\u5904\u7406\u65b0\u6d88\u606f\u521b\u5efa\u7684\u51fd\u6570\u5185\u7684 <code>TRACE_ID</code>\u3002</p> <p>2.\u6253\u5f00\u901a\u77e5\u5668\u4ee3\u7801\u5e93\u7684 app \u76ee\u5f55\u4e0b\u7684 index.mjs \u6587\u4ef6\uff0c\u5e76\u5728\u73b0\u6709\u7684\u9ed1\u8272\u884c\u4e0b\u9762\u6dfb\u52a0\u6a59\u8272\u9ad8\u4eae\u663e\u793a\u7684\u884c\uff1a</p> <pre><code>export async function handleMessageConsume(channel, msg, handlers) {\n  console.log(\"RABBIT_MQ_MESSAGE: \", msg);\n</code></pre> <p>\u65b0\u884c\u5217\u51fa\u4e86\u901a\u77e5\u670d\u52a1\u63a5\u6536\u7684 AMQP \u4e8b\u4ef6\u7684\u5168\u90e8\u5185\u5bb9\u3002</p> <pre><code>^c\nnode --import ./tracing.mjs index.mjs\n</code></pre> <p>4 \u7b49\u5f85\u5927\u7ea6 10 \u79d2\u949f\uff0c\u7136\u540e\u5728\u5ba2\u6237\u7aef\u7ec8\u7aef\u4e0a\u518d\u6b21\u53d1\u9001\u4fe1\u606f\uff1a</p> <pre><code>curl -X POST \\\n -H \"User-Id: 2\" \\\n -H \"Content-Type: application/json\" \\\n -d '{\"content\": \"This is the second message\"}' \\\n 'http://localhost:8085/conversations/1/messages'\n ```\n\n5 \u67e5\u770b\u4fe1\u4f7f\u670d\u52a1\u548c\u901a\u77e5\u5668\u670d\u52a1\u7684\u65e5\u5fd7\u3002\u5728\u4fe1\u4f7f\u670d\u52a1\u65e5\u5fd7\u4e2d\uff0c\u5982\u4e0b\u6240\u793a\u7684\u4e00\u884c\u62a5\u544a\u4e86\u6d88\u606f\u7684\u94fe\u8def\u8ffd\u8e2a ID\uff08\u5f53\u60a8\u81ea\u5df1\u64cd\u4f5c\u672c\u6559\u7a0b\u6b65\u9aa4\u65f6\uff0c\u5b9e\u9645 ID \u4f1a\u6709\u6240\u4e0d\u540c\uff09\uff1a\n\n ```\n TRACE_ID:  29377a9b546c50be629c8e64409bbfb5\n</code></pre> <p>6 \u540c\u6837\u5730\uff0c\u901a\u77e5\u5668\u670d\u52a1\u65e5\u5fd7\u5728\u5982\u4e0b\u6240\u793a\u7684\u8f93\u51fa\u4e2d\u62a5\u544a\u94fe\u8def\u8ffd\u8e2a ID\uff1a</p> <pre><code>\n_spanContext: {\n  traceId: '29377a9b546c50be629c8e64409bbfb5',\n  spanId: 'a94e9462a39e6dbf',\n  traceFlags: 1,\n  traceState: undefined\n},\n</code></pre> <p>7 \u5728\u63a7\u5236\u53f0\u4e2d\u94fe\u8def\u8ffd\u8e2a ID \u662f\u5339\u914d\u7684\uff0c\u4f46\u6700\u540e\u60a8\u53ef\u4ee5\u5c06\u5176\u4e0e Jaeger \u7528\u6237\u754c\u9762\u4e2d\u7684\u94fe\u8def\u8ffd\u8e2a ID \u8fdb\u884c\u6bd4\u8f83\u3002</p> <p>\u5728\u76f8\u5173\u94fe\u8def\u8ffd\u8e2a ID \u7aef\u70b9\uff08\u60a8\u7684\u7aef\u70b9\u4f1a\u6709\u6240\u4e0d\u540c\uff0c\u4f46\u5728\u672c\u4f8b\u4e2d\u662f http://localhost:16686/trace/29377a9b546c50be629c8e64409bbfb5\uff09\uff0c\u6253\u5f00\u7528\u6237\u754c\u9762\uff0c\u67e5\u770b\u6574\u4e2a\u94fe\u8def\u8ffd\u8e2a\u3002</p> <p>Jaeger \u94fe\u8def\u8ffd\u8e2a\u786e\u8ba4\uff1a</p> <ul> <li>\u5728\u6d3e\u53d1\u4e8b\u4ef6\u65f6\uff0c\u4fe1\u4f7f\u670d\u52a1\u4e2d\u7684 AMQP \u81ea\u52a8\u57cb\u70b9\u6dfb\u52a0\u4e86\u8fd9\u4e2a\u94fe\u8def\u8ffd\u8e2a ID \u4f5c\u4e3a\u5143\u6570\u636e\u7684\u4e00\u90e8\u5206\u3002</li> <li>\u901a\u77e5\u5668\u670d\u52a1\u4e2d\u7684 AMQP \u81ea\u52a8\u57cb\u70b9\u9700\u8981\u8be5\u5143\u6570\u636e\u5e76\u76f8\u5e94\u5730\u8bbe\u7f6e\u4e86\u94fe\u8def\u8ffd\u8e2a\u4e0a\u4e0b\u6587\u3002</li> </ul> <p>\u6ce8\uff1a\u5728\u5b9e\u9645\u751f\u4ea7\u7cfb\u7edf\u4e2d\uff0c\u4e00\u65e6\u786e\u8ba4\u6d41\u7a0b\u6309\u9884\u671f\u8fd0\u884c\uff0c\u5373\u53ef\u5220\u9664\u60a8\u5728\u672c\u90e8\u5206\u4e2d\u6dfb\u52a0\u7684\u4ee3\u7801\u3002</p>"},{"location":"chap_ot/2OpenTelemetry_MS/#_15","title":"\u8d44\u6e90\u6e05\u7406","text":"<p>\u6574\u4e2a\u6559\u7a0b\u4e0b\u6765\uff0c\u60a8\u521b\u5efa\u4e86\u4e0d\u5c11\u5bb9\u5668\u548c\u955c\u50cf\uff01\u4f7f\u7528\u4ee5\u4e0b\u6307\u4ee4\u6765\u5c06\u5176\u5220\u9664\u3002</p> <p>\u5220\u9664\u4efb\u4f55\u6b63\u5728\u8fd0\u884c\u7684 Docker \u5bb9\u5668\uff1a</p> <pre><code>docker rm $(docker stop messenger-lb)\n</code></pre> <p>\u5220\u9664\u5e73\u53f0\u670d\u52a1\u4ee5\u53ca\u4fe1\u4f7f\u4e0e\u901a\u77e5\u5668\u6570\u636e\u5e93\u670d\u52a1\uff1a</p> <pre><code>cd ~/microservices-march/platform &amp;&amp; docker compose down\ncd ~/microservices-march/notifier &amp;&amp; docker compose down\ncd ~/microservices-march/messenger &amp;&amp; docker compose down\n</code></pre>"},{"location":"chap_ot/2OpenTelemetry_MS/#_16","title":"\u540e\u7eed\u6b65\u9aa4","text":"<ul> <li>\u5728\u4e00\u4e2a NGINX \u53cd\u5411\u4ee3\u7406\u548c\u4e24\u4e2a Node.js \u670d\u52a1\u4e2d\u8bbe\u7f6e\u4e86 OTel \u57cb\u70b9\u3002</li> <li>\u4ee5\u4e25\u8c28\u7684\u773c\u5149\u5ba1\u89c6\u4e86 OTel \u81ea\u52a8\u57cb\u70b9\u63d0\u4f9b\u7684\u6570\u636e\uff0c\u5e76\u589e\u6dfb\u4e86\u4e00\u4e9b\u7f3a\u5931\u7684\u9065\u6d4b\u6570\u636e\uff0c\u4ee5\u5b9e\u73b0 OTel \u5b9e\u9a8c\u7684\u76ee\u6807\uff1a<ul> <li>\u5728\u4e0d\u76f4\u63a5\u66f4\u6539\u4efb\u4f55\u5e94\u7528\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\uff0c\u5bf9\u7279\u5b9a\u8bf7\u6c42\u5728\u6d88\u606f\u4f20\u9012\u7cfb\u7edf\u4e2d\u7684\u7ecf\u5386\u83b7\u5f97\u4e86\u6e05\u6670\u7684\u89c6\u56fe\u3002 \u60a8\u786e\u8ba4\u4e86\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u6d88\u606f\u6d41\u53ef\u5728\u4e94\u79d2\u5185\u7aef\u5230\u7aef\u6267\u884c\u5b8c\u6bd5\u3002</li> <li>\u786e\u8ba4\u4e86\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u6d88\u606f\u6d41\u53ef\u5728\u4e94\u79d2\u5185\u7aef\u5230\u7aef\u6267\u884c\u5b8c\u6bd5\u3002</li> </ul> </li> </ul>"},{"location":"chap_ot/3OpenTelemetry_K8S/","title":"6 \u4f7f\u7528 OpenTelemetry Tracing \u6700\u5927\u5316 Kubernetes \u6548\u7387","text":"<p>OpenTelemetry \u662f\u4e00\u79cd\u5f00\u6e90\u7684\u53ef\u89c2\u6d4b\u6027\u6846\u67b6\uff0c\u63d0\u4f9b\u4e00\u7ec4 API \u548c\u5e93\uff0c\u7528\u4e8e\u6536\u96c6\u3001\u5904\u7406\u548c\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\uff0c\u5982\u8ffd\u8e2a\u3001\u6307\u6807\u548c\u65e5\u5fd7\u3002</p> <p>\u5b83\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u4ee5\u6700\u5c0f\u7684\u5f00\u9500\u6765\u68c0\u6d4b\u4ed6\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5e76\u63d0\u4f9b\u4e00\u79cd\u6536\u96c6\u548c\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\u7684\u6807\u51c6\u5316\u65b9\u6cd5\u3002</p> <p>\u5728 Kubernetes \u73af\u5883\u4e2d\uff0c\u7531\u4e8e\u5176\u590d\u6742\u548c\u52a8\u6001\u7684\u7279\u6027\uff0c\u5982\u679c\u6ca1\u6709\u9002\u5f53\u7684\u53ef\u89c2\u6d4b\u6027\u5de5\u5177\uff0c\u5f88\u96be\u8bc6\u522b\u6027\u80fd\u95ee\u9898\u548c\u74f6\u9888\u3002</p> <p>OpenTelemetry \u8ffd\u8e2a\u53ef\u4ee5\u901a\u8fc7\u6536\u96c6\u8bf7\u6c42\u6267\u884c\u7684\u8be6\u7ec6\u6570\u636e\u5e76\u63d0\u4f9b\u5bf9\u6574\u4e2a\u7cfb\u7edf\u7684\u53ef\u89c1\u6027\uff0c\u63d0\u4f9b\u5f3a\u5927\u7684\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u901a\u8fc7\u53ca\u65e9\u8bc6\u522b\u548c\u89e3\u51b3\u6027\u80fd\u95ee\u9898\uff0cOpenTelemetry\uff08OTEL\uff09\u53ef\u4ee5\u5e2e\u52a9\u4f18\u5316 Kubernetes \u7684\u6548\u7387\uff0c\u6700\u7ec8\u63d0\u9ad8\u7528\u6237\u4f53\u9a8c\u5e76\u964d\u4f4e\u5e94\u7528\u7a0b\u5e8f\u6545\u969c\u7684\u98ce\u9669\u3002</p> <p>\u901a\u8fc7\u63d0\u4f9b\u4e00\u79cd\u6807\u51c6\u5316\u7684\u65b9\u5f0f\u6765\u6536\u96c6\u548c\u5bfc\u51fa\u9065\u6d4b\u6570\u636e\uff0cOpenTelemetry \u4f7f\u4e0e\u5176\u4ed6\u53ef\u89c2\u5bdf\u6027\u5de5\u5177\u548c\u5e73\u53f0\u96c6\u6210\u53d8\u5f97\u66f4\u52a0\u5bb9\u6613\uff0c\u63d0\u4f9b\u4e86\u7cfb\u7edf\u6027\u80fd\u7684\u66f4\u5168\u9762\u7684\u89c6\u56fe\u3002</p>"},{"location":"chap_ot/3OpenTelemetry_K8S/#kubernetes","title":"\u7406\u89e3 Kubernetes \u4e2d\u7684\u8ffd\u8e2a","text":"<p>\u8ffd\u8e2a\u662f\u901a\u8fc7\u6355\u83b7\u548c\u5b58\u50a8\u6709\u5173\u5355\u4e2a\u8bf7\u6c42\u5728\u7cfb\u7edf\u4e2d\u79fb\u52a8\u7684\u8be6\u7ec6\u4fe1\u606f\u6765\u5de5\u4f5c\u7684\u3002\u8fd9\u5305\u62ec\u6709\u5173\u8bf7\u6c42\u5904\u7406\u6240\u9700\u65f6\u95f4\u3001\u5904\u7406\u8bf7\u6c42\u6240\u6d89\u53ca\u7684\u7ec4\u4ef6\u4ee5\u53ca\u6cbf\u9014\u53d1\u751f\u7684\u4efb\u4f55\u9519\u8bef\u7684\u4fe1\u606f\u3002</p> <p>\u7136\u540e\u5bf9\u6b64\u4fe1\u606f\u8fdb\u884c\u805a\u5408\u548c\u5206\u6790\uff0c\u4ee5\u8bc6\u522b\u6a21\u5f0f\u548c\u8d8b\u52bf\uff0c\u5e2e\u52a9\u5f00\u53d1\u4eba\u5458\u548c DevOps \u56e2\u961f\u4f18\u5316\u5e94\u7528\u7a0b\u5e8f\u7684\u6027\u80fd\u3002</p> <p>\u7136\u800c\uff0c\u5728 Kubernetes \u7f16\u6392\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u8fdb\u884c\u8ffd\u8e2a\u53ef\u80fd\u662f\u5177\u6709\u6311\u6218\u6027\u7684\u3002\u5206\u5e03\u5f0f\u7cfb\u7edf\u672c\u8d28\u4e0a\u662f\u590d\u6742\u7684\uff0c\u8bf7\u6c42\u901a\u8fc7\u591a\u4e2a\u7ec4\u4ef6\u8def\u7531\uff0c\u6bcf\u4e2a\u7ec4\u4ef6\u5728\u4e0d\u540c\u7684\u8282\u70b9\u6216 Pod \u4e0a\u8fd0\u884c\uff0c\u8fd9\u4f7f\u5f97\u83b7\u53d6\u6709\u5173\u8bf7\u6c42\u5728\u7cfb\u7edf\u4e2d\u5982\u4f55\u6d41\u52a8\u7684\u5b8c\u6574\u56fe\u50cf\u53d8\u5f97\u56f0\u96be\u3002</p> <p>\u6b64\u5916\uff0c\u4e0d\u540c\u7684\u7ec4\u4ef6\u53ef\u80fd\u4f7f\u7528\u4e0d\u540c\u7684\u8ffd\u8e2a\u6846\u67b6\uff0c\u8fd9\u4f7f\u5f97\u5728\u5b83\u4eec\u4e4b\u95f4\u8fdb\u884c\u5173\u8054\u4fe1\u606f\u53d8\u5f97\u56f0\u96be\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u6311\u6218\uff0c\u5f00\u53d1\u4e86\u8bf8\u5982 OpenTelemetry \u4e4b\u7c7b\u7684\u5de5\u5177\uff0c\u4ee5\u63d0\u4f9b\u5728 Kubernetes \u4e2d\u8de8\u4e0d\u540c\u7ec4\u4ef6\u548c\u6846\u67b6\u6355\u83b7\u548c\u5173\u8054\u8ffd\u8e2a\u4fe1\u606f\u7684\u6807\u51c6\u5316\u65b9\u5f0f\u3002</p>"},{"location":"chap_ot/3OpenTelemetry_K8S/#opentelemetry","title":"OpenTelemetry \u8ffd\u8e2a\u7684\u4f18\u52bf","text":"<p>OpenTelemetry \u4e3a Kubernetes \u8ffd\u8e2a\u63d0\u4f9b\u4e86\u591a\u79cd\u7279\u6027\u548c\u4f18\u52bf\uff0c\u5305\u62ec\uff1a</p> <ol> <li>\u4eea\u8868\u5316\u5e93\uff1aOTEL \u63d0\u4f9b\u4e86\u591a\u79cd\u8bed\u8a00\u7279\u5b9a\u7684\u5e93\uff0c\u5141\u8bb8\u8f7b\u677e\u4eea\u8868\u5316\u5728 Kubernetes \u4e2d\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u786e\u4fdd\u6536\u96c6\u6240\u6709\u76f8\u5173\u7684\u9065\u6d4b\u6570\u636e\u3002</li> <li>\u6807\u51c6\u5316API\uff1a\u9065\u6d4b\u6570\u636e\u7684\u4e00\u81f4 API \u5141\u8bb8\u4e0e\u5404\u79cd\u8ffd\u8e2a\u548c\u76d1\u6d4b\u5de5\u5177\u8f7b\u677e\u96c6\u6210\u3002</li> <li>\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1a\u8fd9\u4e9b\u529f\u80fd\u5141\u8bb8\u5728 Kubernetes \u73af\u5883\u4e2d\u8ffd\u8e2a\u8de8\u591a\u4e2a\u670d\u52a1\u7684\u8bf7\u6c42\uff0c\u63d0\u4f9b\u6709\u5173\u8bf7\u6c42\u5904\u7406\u65b9\u5f0f\u7684\u89c1\u89e3\uff0c\u5e76\u8bc6\u522b\u6f5c\u5728\u7684\u74f6\u9888\u3002</li> <li>\u4f9b\u5e94\u5546\u65e0\u5173\uff1aOpenTelemetry \u662f\u4f9b\u5e94\u5546\u4e2d\u7acb\u7684\uff0c\u5e76\u53ef\u4ee5\u4e0e\u5404\u79cd\u8ffd\u8e2a\u548c\u76d1\u6d4b\u5e73\u53f0\u96c6\u6210\uff0c\u63d0\u4f9b\u7075\u6d3b\u6027\u5e76\u907f\u514d\u4f9b\u5e94\u5546\u9501\u5b9a\u3002</li> </ol> <p>OTEL \u53ef\u4ee5\u4e0e\u6d41\u884c\u7684 Kubernetes \u5de5\u5177\u548c\u5e73\u53f0\u96c6\u6210\uff0c\u5982 Prometheus\u3001Jaeger \u548c Grafana\u3002</p> <p>\u4f8b\u5982\uff0cOpenTelemetry Collector \u53ef\u7528\u4e8e\u6536\u96c6\u548c\u5bfc\u51fa\u5230 Prometheus \u7684\u9065\u6d4b\u6570\u636e\uff0c\u800c Jaeger \u548c Grafana \u540e\u7aef\u53ef\u7528\u4e8e\u53ef\u89c6\u5316\u548c\u5206\u6790\u7531 OTEL \u6536\u96c6\u7684\u8ffd\u8e2a\u6570\u636e\u3002</p> <p>\u6b64\u5916\uff0cOpenTelemetry \u8fd8\u53ef\u4ee5\u901a\u8fc7 OpenTelemetry Operator \u4e0e Kubernetes \u96c6\u6210\uff0c\u63d0\u4f9b\u4e00\u79cd\u65e0\u7f1d\u7684\u65b9\u5f0f\u6765\u90e8\u7f72\u548c\u7ba1\u7406 Kubernetes \u96c6\u7fa4\u4e2d\u7684OTEL\u7ec4\u4ef6\u3002</p>"},{"location":"chap_ot/3OpenTelemetry_K8S/#kubernetes-otel","title":"\u5728 Kubernetes \u4e2d\u5b9e\u73b0 OTEL \u8ffd\u8e2a","text":"<p>\u5728 Kubernetes \u4e2d\u5b9e\u73b0 OTEL \u8ffd\u8e2a\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u6b65\u9aa4\u5b9e\u73b0\uff1a</p> <ol> <li>\u5b89\u88c5 OpenTelemetry Collector\uff1a<ul> <li>\u9996\u5148\uff0c\u60a8\u9700\u8981\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5 OpenTelemetry Collector</li> <li>\u53ef\u4ee5\u4f7f\u7528\u5404\u79cd\u65b9\u6cd5\u6765\u5b8c\u6210\u6b64\u4efb\u52a1\uff0c\u5305\u62ec Helm\u3001Kubernetes \u6e05\u5355\u6216 Operator\u3002</li> </ul> </li> <li>\u914d\u7f6e\u6536\u96c6\u5668\uff1a<ul> <li>\u4e00\u65e6\u5b89\u88c5\u4e86\u6536\u96c6\u5668\uff0c\u60a8\u9700\u8981\u914d\u7f6e\u5b83\u4ee5\u4ece\u5e94\u7528\u7a0b\u5e8f\u6536\u96c6\u8ffd\u8e2a\uff0c\u5e76\u5c06\u5176\u53d1\u9001\u5230\u60a8\u9996\u9009\u7684\u8ffd\u8e2a\u540e\u7aef\u3002</li> <li>\u8fd9\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u5b8c\u6210\uff0c\u8be5\u6587\u4ef6\u6307\u5b9a\u6240\u9700\u7684 exporters\u3001receivers \u548c processors\u3002</li> </ul> </li> </ol> <p>\u4ee5\u4e0b\u662f\u7528\u4e8e\u8ffd\u8e2a\u7684\u57fa\u672c OpenTelemetry Collector \u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\uff1a</p> <pre><code>receivers:\n otlp:\n  protocols:\n   grpc:\n\nexporters:\n jaeger:\n  endpoint: &lt;jaeger-endpoint&gt;\n  insecure: true\n\nprocessors:\n batch:\n\nextensions:\n health_check:\n\nservice:\n pipelines:\n  traces:\n   receivers: [otlp]\n   processors: [batch]\n   exporters: [jaeger]\n</code></pre> <ul> <li>\u8bf7\u6ce8\u610f\uff0c\u6b64\u793a\u4f8b\u4f7f\u7528 OTLP \u4f5c\u4e3a\u63a5\u6536\u5668\uff0c\u5e76\u4f7f\u7528 gRPC \u534f\u8bae\u8fdb\u884c\u901a\u4fe1\u3002</li> <li>\u5b83\u4f7f\u7528 Jaeger \u4f5c\u4e3a exporter\uff0c\u5e76\u6307\u5b9a\u4e86 endpoint \u548c insecure \u9009\u9879\u3002\u5b83\u8fd8\u4f7f\u7528\u4e86 batch processor\uff0c\u5e76\u542f\u7528\u4e86 <code>health_check</code> \u6269\u5c55\u7a0b\u5e8f\u3002</li> <li> <p>\u6700\u540e\uff0c\u5b83\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7ba1\u9053\uff0c\u8be5\u7ba1\u9053\u5c06 OTLP \u63a5\u6536\u5668\u3001\u6279\u5904\u7406\u5668\u548cJaeger exporter \u94fe\u63a5\u5728\u4e00\u8d77\u4ee5\u6536\u96c6\u8ffd\u8e2a\u6570\u636e\u3002</p> </li> <li> <p>\u68c0\u6d4b\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\uff1a\u914d\u7f6e\u6536\u96c6\u5668\u540e\uff0c\u60a8\u9700\u8981\u4f7f\u7528 OpenTelemetry SDK \u6216\u517c\u5bb9\u7684\u8ffd\u8e2a\u5e93\u6765\u68c0\u6d4b\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee5\u751f\u6210\u8ffd\u8e2a\u3002\u8fd9\u6d89\u53ca\u5c06\u4ee3\u7801\u6dfb\u52a0\u5230\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u4ee5\u521b\u5efa\u8de8\u5ea6\u5e76\u5c06\u5b83\u4eec\u9644\u52a0\u5230\u8ffd\u8e2a\u4e0a\u4e0b\u6587\u3002</p> </li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u793a\u4f8b\uff0c\u8bf4\u660e\u5982\u4f55\u4f7f\u7528 OpenTelemetry SDK \u68c0\u6d4b\u4e00\u4e2a\u7b80\u5355\u7684 Go \u5e94\u7528\u7a0b\u5e8f\u3002</p> <pre><code>package main\n\nimport (\n \"context\"\n\n \"go.opentelemetry.io/otel\"\n \"go.opentelemetry.io/otel/trace\"\n\n)\n\n\nfunc main() {\n      // Create a tracer provider with the default configuration\n      provider := otel.GetTracerProvider()\n\n      // Get a tracer instance from the provider\n      tracer := provider.Tracer(\"my-app\")\n\n      // Create a span\n      ctx, span := tracer.Start(context.Background(), \"my-span\")\n      defer span.End()\n\n      // Do some work\n}\n</code></pre> <p>\u5728\u6b64\u793a\u4f8b\u4e2d\uff0cOpenTelemetry SDK \u7528\u4e8e\u521b\u5efa\u8ffd\u8e2a\u5668\u63d0\u4f9b\u7a0b\u5e8f\u548c\u8ffd\u8e2a\u5668\u5b9e\u4f8b\u3002\u7136\u540e\u521b\u5efa\u4e00\u4e2a Span\uff0c\u5e76\u5728\u8be5 Span \u7684\u4e0a\u4e0b\u6587\u4e2d\u6267\u884c\u5de5\u4f5c\u3002\u9a8c\u8bc1\u8ffd\u8e2a\u662f\u5426\u5df2\u53d1\u9001\u5230\u540e\u7aef\u3002</p> <p>\u6700\u540e\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u540e\u7aef\u63d0\u4f9b\u7684\u8ffd\u8e2a UI \u9a8c\u8bc1\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u751f\u6210\u8ffd\u8e2a\u5e76\u5c06\u5b83\u4eec\u53d1\u9001\u5230\u540e\u7aef\u3002\u8fd9\u4f7f\u60a8\u53ef\u4ee5\u53ef\u89c6\u5316\u8ffd\u8e2a\u5e76\u8bc6\u522b\u6027\u80fd\u74f6\u9888\u548c\u5176\u4ed6\u95ee\u9898\u3002</p>"},{"location":"chap_ot/3OpenTelemetry_K8S/#opentelemetry-kubernetes","title":"\u4f7f\u7528 OpenTelemetry \u4e0e Kubernetes \u7684\u6700\u4f73\u5b9e\u8df5","text":"<p>\u4ee5\u4e0b\u662f\u4f7f\u7528 OpenTelemetry \u4e0e Kubernetes \u6700\u4f73\u5b9e\u8df5\u7684\u4e00\u4e9b\u5efa\u8bae\u548c\u6280\u5de7\uff0c\u4ee5\u6700\u5927\u5316\u8ffd\u8e2a\u6548\u7387\u548c\u51c6\u786e\u6027\u3002</p> <p>\u9996\u5148\u8981\u6e05\u695a\u4e86\u89e3\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u67b6\u6784\u3002\u5f00\u59cb\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b9e\u73b0 OpenTelemetry \u8ffd\u8e2a\u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u60a8\u5145\u5206\u4e86\u89e3\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u67b6\u6784\uff0c\u5305\u62ec\u5176\u5fae\u670d\u52a1\u3001API\u548c\u4f9d\u8d56\u5173\u7cfb\u3002\u8fd9\u5c06\u5e2e\u52a9\u60a8\u786e\u5b9a\u8ffd\u8e2a\u6700\u91cd\u8981\u7684\u5173\u952e\u9886\u57df\u4ee5\u53ca\u5e94\u8be5\u96c6\u4e2d\u7cbe\u529b\u7684\u5730\u65b9\u3002</p> <p>\u4e3a\u60a8\u7684\u8ffd\u8e2a\u5de5\u4f5c\u5b9a\u4e49\u660e\u786e\u7684\u76ee\u6807\u3002\u786e\u5b9a\u60a8\u60f3\u8981\u901a\u8fc7\u8ffd\u8e2a\u5de5\u4f5c\u5b9e\u73b0\u7684\u76ee\u6807\uff0c\u4f8b\u5982\u8bc6\u522b\u6027\u80fd\u74f6\u9888\u6216\u76d1\u89c6\u670d\u52a1\u5065\u5eb7\u72b6\u51b5\u3002\u8fd9\u5c06\u5e2e\u52a9\u60a8\u5b9a\u4e49\u60a8\u7684\u8ffd\u8e2a\u4eea\u5668\u7b56\u7565\u5e76\u9009\u62e9\u6b63\u786e\u7684\u8ffd\u8e2a\u540e\u7aef\u3002</p> <p>\u9075\u5faaOTEL\u6700\u4f73\u5b9e\u8df5\u3002\u4e3a\u786e\u4fdd\u60a8\u7684\u8ffd\u8e2a\u5de5\u4f5c\u80fd\u591f\u53d6\u5f97\u6700\u4f73\u7ed3\u679c\uff0c\u8bf7\u9075\u5faa OpenTelemetry \u63a8\u8350\u7684\u6700\u4f73\u5b9e\u8df5\uff0c\u4f8b\u5982\u4f7f\u7528\u8bed\u4e49\u7ea6\u5b9a\u8fdb\u884c\u8ffd\u8e2a\u5c5e\u6027\uff0c\u5e76\u907f\u514d\u8fc7\u5ea6\u4eea\u5668\u5316\u3002</p> <p>\u5728\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6808\u4e0a\u5b9e\u73b0\u5206\u5e03\u5f0f\u8ffd\u8e2a\u3002\u4e3a\u4e86\u5168\u9762\u4e86\u89e3\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\uff0c\u4f7f\u7528\u5206\u5e03\u5f0f\u8ffd\u8e2a\u8986\u76d6\u6574\u4e2a\u5e94\u7528\u7a0b\u5e8f\u6808\uff0c\u5305\u62ec\u6240\u6709\u5fae\u670d\u52a1\u3001API\u548c\u4f9d\u8d56\u5173\u7cfb\u3002</p> <p>\u9009\u62e9\u9002\u5408\u60a8\u9700\u6c42\u7684\u6b63\u786e\u8ffd\u8e2a\u540e\u7aef\u3002\u9009\u62e9\u9002\u5408\u60a8\u9700\u6c42\u5e76\u63d0\u4f9b\u6240\u9700\u529f\u80fd\u7684\u8ffd\u8e2a\u540e\u7aef\u3002\u53ef\u9009\u9879\u5305\u62ec Jaeger\u3001Zipkin \u548c Amazon Web Services X-Ray\u3002</p> <p>\u5b9a\u671f\u76d1\u89c6\u548c\u5206\u6790\u60a8\u7684\u8ffd\u8e2a\u6570\u636e\u3002\u4f7f\u7528 OpenTelemetry \u6536\u96c6\u7684\u8ffd\u8e2a\u6570\u636e\u5b9a\u671f\u76d1\u89c6\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\uff1b\u5206\u6790\u6570\u636e\u4ee5\u786e\u5b9a\u6539\u8fdb\u7684\u9886\u57df\u3002</p>"},{"location":"chap_ot/4OpenTelemetry_datamon/","title":"4 \u804a\u804a\u53ef\u89c2\u6d4b\u6027\u4e4b\u6570\u636e\u6a21\u578b","text":"<p>\u4f46\u662f\u7ba1\u7406\u5bb9\u5668\u662f\u4e00\u4ef6\u590d\u6742\u7684\u4e8b\u60c5\uff0c\u540e\u6765\u51fa\u73b0\u4e86 Kubernetes\uff0c\u6210\u4e3a\u4e86\u4e8b\u5b9e\u4e0a\u7684\u5bb9\u5668\u7ba1\u7406\u6807\u51c6\uff0c\u76ee\u524d\u5404\u5927\u516c\u53f8\u90fd\u5728\u4f7f\u7528 Kubernetes\u3002</p> <p>\u56e0\u4e3a\u5bb9\u5668\u548c Kubernetes \u964d\u4f4e\u4e86\u670d\u52a1\uff08\u5e94\u7528\uff09\u7684\u90e8\u7f72\u548c\u5347\u7ea7\u6210\u672c\uff0c\u6240\u4ee5\u50ac\u751f\u4e86\u300c\u5fae\u670d\u52a1\u300d\u7684\u6982\u5ff5\uff0c\u670d\u52a1\u4ece\u300c\u5355\u4f53\u590d\u6742\u670d\u52a1\u300d\u5411\u300c\u591a\u4e2a\u7b80\u5355\u670d\u52a1\u300d\u6f14\u53d8\uff0c\u5728\u4e4b\u524d\uff0c\u9700\u8981\u7740\u91cd\u8003\u8651\u670d\u52a1\u5185\u7684\u67b6\u6784\u8bbe\u8ba1\uff0c\u5355\u4e2a\u670d\u52a1\u5bf9\u5916\u63d0\u4f9b\u5c3d\u53ef\u80fd\u591a\u7684\u80fd\u529b\uff0c\u800c\u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u4f1a\u76f4\u63a5\u628a\u5355\u4e2a\u670d\u52a1\u62c6\u5206\u6210\u591a\u4e2a\u670d\u52a1\uff0c\u670d\u52a1\u4e4b\u95f4\u7528 API \u8c03\u7528\u3002</p> <p>\u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u67b6\u6784\u8bbe\u8ba1\u7684\u91cd\u8981\u6027\u964d\u4f4e\uff0cAPI \u8bbe\u8ba1\u7684\u91cd\u8981\u6027\u63d0\u9ad8\u3002</p> <p>\u53e6\u5916\uff0c\u62c6\u5206\u51fa\u5fae\u670d\u52a1\u540e\uff0c\u7f16\u7a0b\u7684\u96be\u5ea6\u4e8b\u5b9e\u4e0a\u964d\u4f4e\u4e86\uff0c\u5bf9\u7f16\u7a0b\u4eba\u5458\u7684\u8981\u6c42\u4e5f\u964d\u4f4e\u4e86\u3002</p> <p>\u8fd9\u8bf4\u660e\u4e00\u4e2a\u4e8b\u5b9e\uff0c\u968f\u7740\u57fa\u7840\u8bbe\u65bd\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u4f1a\u6709\u8d8a\u6765\u8d8a\u591a\u7684\u300c\u7f16\u7a0b\u80fd\u529b\u300d\u6c89\u6dc0\u6210\u57fa\u7840\u8bbe\u65bd\uff0c\u4f7f\u7f16\u7a0b\u7684\u96be\u5ea6\u4e0d\u65ad\u964d\u4f4e\uff1a\u8f6f\u4ef6\u5f00\u53d1\u4e0d\u65ad\u5411\u7b80\u5355\u7684\u65b9\u5f0f\u53d1\u5c55\u3002</p> <p>\u4f46\u662f\uff0c\u968f\u7740\u5fae\u670d\u52a1\u7684\u53d1\u5c55\uff0c\u670d\u52a1\u53d8\u5f97\u592a\u591a\u4e86\uff0c\u7ba1\u7406\u8d1f\u8d23\u5ea6\u53c8\u4e0a\u5347\u4e86\uff0c\u6bd4\u5982\u600e\u4e48\u53bb\u89e3\u51b3\u670d\u52a1\u53d1\u73b0\u7684\u95ee\u9898\u3001\u600e\u4e48\u63a7\u5236\u6d41\u91cf\u3001\u670d\u52a1\u4e4b\u95f4\u600e\u4e48\u505a\u9694\u79bb\uff0c\u670d\u52a1\u72b6\u6001\u600e\u4e48\u89c2\u6d4b\u7b49\u7b49\u3002\u8fd9\u65f6\u5019\u53c8\u51fa\u73b0\u4e86\u300c\u670d\u52a1\u6cbb\u7406\u300d\u7684\u6982\u5ff5\uff0c\u5173\u4e8e\u670d\u52a1\u6cbb\u7406\uff0c\u6709\u4e00\u4e2a\u65b0\u7684\u8bcd\uff1aService Mesh\uff0c\u73b0\u5728\u4e8b\u5b9e\u6807\u51c6\u662f Istio\u3002</p>"},{"location":"chap_ot/4OpenTelemetry_datamon/#_1","title":"\u6982\u8ff0","text":"<p>\u53ef\u89c2\u6d4b\u6027\u662f\u4e3a\u4e86\u5e94\u5bf9\u5fae\u670d\u52a1\u7684\u590d\u6742\u573a\u666f\u4e0b\u53d1\u660e\u51fa\u6765\u7684\u4e00\u4e2a\u8bcd\uff0c\u672c\u8d28\u4e0a\u662f\u4e3a\u4e86\u8861\u91cf\u7cfb\u7edf\u8fd0\u884c\u7684\u72b6\u6001\uff0c\u53ef\u89c2\u6d4b\u6027\u662f\u670d\u52a1\u6cbb\u7406\u7684\u4e00\u4e2a\u7ef4\u5ea6\uff0c\u548c\u529f\u80fd\u6027\u3001\u53ef\u6d4b\u8bd5\u6027\u3001\u53ef\u8fd0\u7ef4\u6027\u4e00\u6837\u3002</p> <p>\u4e00\u822c\u5e38\u8bf4\u53ef\u89c2\u6d4b\u6027\u5305\u542b\u4e09\u4e2a\u5ea6\u91cf\u89d2\u5ea6\uff1aMetric\u3001Logging\u3001Tracing\uff0c\u5176\u5b9e\u8fd8\u6709\u4e00\u4e2a\uff1aProfiling\u3002</p> <ul> <li>Metric\uff1a\u6307\u6807\uff0c\u5bf9\u7cfb\u7edf\u4e2d\u67d0\u4e00\u7c7b\u4fe1\u606f\u7684\u805a\u5408\u7edf\u8ba1\uff0c\u6bd4\u5982 QPS\u3001\u5ef6\u8fdf\u3001\u9519\u8bef\u7387\u7b49\u3002</li> <li>Logging\uff1a\u65e5\u5fd7\uff0c\u5bf9\u7cfb\u7edf\u6240\u505a\u884c\u4e3a\u7684\u4e00\u79cd\u8bb0\u5f55\uff0c\u5b83\u662f\u79bb\u6563\u7684\uff0c\u6ca1\u6709\u76f8\u5173\u6027\uff0c\u4e3a\u4e86\u533a\u5206\u8fd9\u79cd\u8bb0\u5f55\u7684\u91cd\u8981\u7a0b\u5ea6\uff0c\u4f1a\u5206\u7ea7\u522b\uff08DEBUG\u3001INFO\u3001WARN\u3001ERROR\u3001FATAL\uff09\u3002</li> <li>Tracing\uff1a\u8c03\u7528\u94fe\uff0c\u5b83\u53cd\u6620\u7684\u662f\u8bf7\u6c42\u7ecf\u8fc7\u67d0\u4e2a\u7ec4\u4ef6\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u7ecf\u8fc7\u7ec4\u4ef6\u7684\u6570\u636e\u53eb\u505a Span\uff0cSpan \u53ef\u4ee5\u4f53\u73b0\u7ecf\u8fc7\u7ec4\u4ef6\u7684\u72b6\u6001\u3001\u4e00\u4e9b\u5173\u952e\u5c5e\u6027\u548c\u4e8b\u4ef6\u3001\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002Span \u4e4b\u95f4\u901a\u8fc7 Trace ID \u5173\u8054\u3002</li> <li>Profiling\uff1a\u4e00\u822c\u53eb\u505a Continuous Profiling\uff0c\u6301\u7eed\u5206\u6790\uff0c\u5b83\u53cd\u6620\u7684\u662f\u7a0b\u5e8f\u5185\u90e8\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u6bd4\u5982\u6808\u8c03\u7528\u3001\u6267\u884c\u65f6\u95f4\u7b49\u3002\u53ef\u4ee5\u628a Profiling \u53ef\u89c6\u5316\u6210\u706b\u7130\u56fe\u65b9\u9762\u5206\u6790\u95ee\u9898\u3002</li> </ul> <p>\u822c\u6765\u8bf4\uff0c\u57fa\u4e8e\u8fd9\u4e9b\u5ea6\u91cf\u5904\u7406\u6545\u969c\u7684\u6d41\u7a0b\u662f\uff1aMetric \u2192 Tracing \u2192 Logging \u2192 Profiling</p> <ul> <li>\u6839\u636e Metric \u914d\u7f6e\u7684\u544a\u8b66\u7b56\u7565\u53d1\u73b0\u95ee\u9898\uff0c</li> <li>\u57fa\u4e8e Tracing \u67e5\u770b\u662f\u54ea\u4e2a\u7ec4\u4ef6\u51fa\u95ee\u9898\uff0c</li> <li>\u57fa\u4e8e Logging \u67e5\u770b\u7ec4\u4ef6\u7684\u65e5\u5fd7\uff0c</li> <li>Profiling \u5206\u6790\u7ec4\u4ef6\u5177\u4f53\u7684\u6545\u969c\u6216\u6027\u80fd\u95ee\u9898\u3002</li> </ul>"},{"location":"chap_ot/4OpenTelemetry_datamon/#_2","title":"\u6570\u636e\u6a21\u578b","text":"<p>\u5728 Tracing \u9886\u57df\uff0c\u4e4b\u524d\u6709\u4e24\u4e2a\u9879\u76ee\uff0c\u4e00\u4e2a\u662f OpenTracing\uff0c\u5b83\u662f\u4e00\u4e2a\u89c4\u8303\uff0cJaeger \u5c31\u662f\u57fa\u4e8e OpenTracing \u7684\u5f00\u6e90\u5b9e\u73b0\uff0c\u53e6\u4e00\u4e2a\u662f OpenCensus\uff0c\u5b83\u662f Google \u5f00\u6e90\u7684\u5ea6\u91cf\u5de5\u5177\u3002\u8fd9\u4e24\u4e2a\u9879\u76ee\u529f\u80fd\u9ad8\u5ea6\u91cd\u5408\uff0c\u5728 CNCF \u4e3b\u5bfc\u4e0b\u5408\u5e76\u6210\u4e86 OpenTelemetry\uff0c\u800c OpenTracing \u548c OpenCensus \u4e5f\u4e0d\u518d\u7ef4\u62a4\u3002</p> <p>\u5f53\u7136 OpenTelemetry \u4e0d\u6b62\u505a Tracing\uff0c\u8fd8\u8986\u76d6 Metric \u548c Logging\uff0c\u5b83\u7684\u76ee\u6807\u662f\u7edf\u4e00\u53ef\u89c2\u6d4b\u6027\u7684\u6807\u51c6\u534f\u8bae\uff0c\u5305\u62ec\u6570\u636e\u6a21\u578b\u3001API \u89c4\u8303\u3001\u591a\u8bed\u8a00 SDK\u3001\u91c7\u96c6\u5668\u3002</p> <p>OpenTelemetry \u53ea\u505a\u7edf\u4e00\u7684\u534f\u8bae\u548c\u89c4\u8303\uff0c\u5177\u4f53\u6570\u636e\u7684\u540e\u7aef\u5b58\u50a8\u548c\u5c55\u793a\u4e0d\u662f\u5b83\u7684\u8303\u56f4\u3002\u534f\u8bae\u548c\u89c4\u8303\u662f\u53ef\u89c2\u6d4b\u6027\u5bf9\u5916\u66b4\u9732\u7684\u300c\u63a5\u53e3\u300d\uff0c\u5b83\u7684\u7edf\u4e00\u5bf9\u4e8e\u4f7f\u7528\u65b9\u6765\u8bf4\u662f\u5de8\u5927\u7684\u597d\u5904\uff0c\u76ee\u524d\u6765\u770b\uff0cOpenTelemetry \u672a\u6765\u4f1a\u6210\u4e3a\u4e8b\u5b9e\u6807\u51c6\u3002</p> <p>\u4e3a\u4e86\u5bf9\u63a5\u4e0d\u540c\u7684\u540e\u7aef\u5b9e\u73b0\uff0cOpenTelemetry \u63d0\u4f9b\u4e86\u5404\u79cd Exporter\uff0c\u6bd4\u5982\u4e3a\u5bf9\u63a5 Prometheus \u63d0\u4f9b\u4e86 Prometheus Exporter\uff0c\u5bf9\u63a5 Cortex \u548c Thanos \u63d0\u4f9b\u4e86 Prometheus Remote Write Exporter\uff0c\u5bf9\u63a5 Loki \u63d0\u4f9b\u4e86 Loki Exporter\uff0c\u5bf9\u63a5 Jaeger \u63d0\u4f9b\u4e86 Jaeger gRPC Exporter\u3002</p> <ul> <li>Metric \u6211\u4eec\u4f7f\u7528\u5206\u5e03\u5f0f Prometheus \u65b9\u6848 Cortex\uff0c\u6570\u636e\u6a21\u578b\u548c Prometheus \u4e00\u81f4</li> <li>Logging \u6211\u4eec\u4f7f\u7528 Loki</li> <li>Tracing \u6211\u4eec\u4f7f\u7528 Grafana Tempo\uff0cTempo \u672c\u8eab\u517c\u5bb9 Zipkin\u3001Jaeger\u3001OpenTelemetry \u7b49\u534f\u8bae\uff0c\u6240\u4ee5 Tracing \u76f4\u63a5\u91c7\u7528 OpenTelemetry \u7684\u6570\u636e\u6a21\u578b</li> <li>Profiling \u7684\u540e\u7aef\u5b9e\u73b0\u57fa\u672c\u53ef\u4ee5\u590d\u7528 Loki\uff0c\u6570\u636e\u6a21\u578b\u4e5f\u548c Logging \u7c7b\u4f3c</li> </ul> <p>\u5148\u770b Metric\uff0c\u5b83\u7684\u6570\u636e\u6a21\u578b\uff1aLabelSet + Timestamp + Number</p> <ul> <li>LabelSet \u5c31\u662f Series\uff0c\u662f\u82e5\u5e72\u4e2a label name / value \u7ec4\u5408\uff0c\u6307\u6807\u540d\u79f0\u4e5f\u662f\u4e00\u4e2a label name / value\u3002</li> <li>Timestamp \u662f\u65f6\u95f4\u6233\uff0c\u7cbe\u5ea6\u662f\u6beb\u7c73\u3002</li> <li>Number \u662f\u6570\u503c\uff0c\u7c7b\u578b\u662f float64\u3002</li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a Metric \u4f8b\u5b50\uff1a</p> <p></p> <p>\u53e6\u5916\uff0cPrometheus \u5185\u7f6e\u51e0\u79cd Metric \u7c7b\u578b\uff0c\u5305\u62ec Counter\u3001Gauge\u3001Histogram\u3001Summary\uff0c</p> <ul> <li>Counter \u662f\u81ea\u589e\u7684\uff0c</li> <li><code>Gauge</code> \u53ef\u589e\u53ef\u51cf\uff0c</li> <li><code>Histogram</code> \u662f\u76f4\u65b9\u56fe\uff0c</li> <li><code>Summary</code> \u662f\u6458\u8981\uff0c</li> <li>Histogram \u548c Summary \u533a\u522b\u662f Histogram \u9700\u8981\u901a\u8fc7 <code>_bucket</code> \u6765\u8ba1\u7b97 P \u503c\uff0c\u800c Summary \u5728\u5ba2\u6237\u7aef\u76f4\u63a5\u8ba1\u7b97\u597d P \u503c\uff0c\u76f4\u63a5\u5b58\u50a8\u5373\u53ef\u3002</li> </ul> <p>\u53e6\u5916\uff0cPrometheus \u8fd8\u6709\u5f88\u591a\u5185\u7f6e\u51fd\u6570\uff0c\u6765\u505a Metric \u7684\u805a\u5408\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002</p> <p>\u518d\u770b Logging\uff0c\u6570\u636e\u6a21\u578b\uff1aLabelSet + Timestamp + String</p> <p>\u548c Metric \u7c7b\u4f3c\uff0c\u53ea\u662f Number \u6362\u6210\u4e86 String\uff0cTimestamp \u7cbe\u5ea6\u662f\u7eb3\u79d2\u3002</p> <p>\u5728 Loki \u4e2d\uff0c\u4f7f\u7528 Logql \u8bed\u6cd5\u67e5\u8be2\u65e5\u5fd7\uff08\u548c Promql \u7c7b\u4f3c\uff09\uff0c\u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50</p> <pre><code>{container=\"query-frontend\",namespace=\"loki-dev\"} |= \"metrics.go\" | logfmt | duration &gt; 10s and throughput_mb &lt; 500\n</code></pre> <p>\u4e0b\u4e00\u4e2a\u662f Tracing\uff0cTracing \u6bd4\u8f83\u590d\u6742\uff1aOperation Name + Start / End Timestamp + Attributes + Events + Parent + SpanContext</p> <ul> <li>Operation Name\uff1a\u64cd\u4f5c\u540d</li> <li>Start / End Timestamp\uff1a\u5f00\u59cb\u548c\u7ed3\u675f\u65f6\u95f4</li> <li>Attributes\uff1aKV \u5bf9\uff0c\u5305\u62ec Status\uff08\u6bd4\u5982 OK\u3001Cancelled\u3001Permission Denied\uff09\u3001</li> <li> <p>SpanKind\uff08CLIENT\u3001SERVER\u3001PRODUCER\u3001CONSUMER\u3001INTERNAL \u7b49\uff09\u3001\u81ea\u5b9a\u4e49\u4fe1\u606f\u7b49</p> </li> <li> <p>Events\uff1a\u82e5\u5e72\u4e2a\u5143\u7ec4\u5217\u8868\uff0c\u6bcf\u4e2a\u5143\u7ec4\u5305\u62ec timestamp\u3001name\u3001Attributes\uff0c\u7528\u4e8e\u8bb0\u5f55\u4e00\u7cfb\u5217\u91cd\u8981\u4e8b\u4ef6</p> </li> <li>Parent \u5305\u542b\u7236\u4eb2\u7684 Span ID\u3001Trace ID</li> <li>SpanContext \u5305\u542b\u81ea\u8eab\u7684 Span ID\u3001Trace ID</li> </ul> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u4f8b\u5b50\uff1a</p> <p></p> <p>\u6700\u540e\u770b Profiling\uff0c\u6570\u636e\u6a21\u578b\uff1aLabelSet + Timestamp + []byte</p> <p>Profiling \u7684\u6570\u636e\u683c\u5f0f\u662f protocol buffers\uff0c\u6240\u4ee5\u7528 []byte\u3002</p> <p>\u4e0a\u9762\u4ecb\u7ecd\u4e86\u56db\u79cd\u6570\u636e\u6a21\u578b\uff0c\u5176\u5b9e\u5728\u5b9e\u9645\u573a\u666f\u4e2d\uff0c\u5b83\u4eec\u4e4b\u95f4\u4e5f\u4f1a\u4e92\u76f8\u878d\u5408\uff0c\u4e0b\u9762\u8bf4\u51e0\u79cd\u5e38\u89c1\u7684\u878d\u5408\u573a\u666f\u3002</p> <p>\u7b2c\u4e00\uff0cMetric \u548c Tracing \u878d\u5408\u3002</p> <p>\u8fd9\u91cc\u8981\u7528\u5230 Exemplar\uff0cExemplar \u6700\u65e9\u88ab\u7528\u5728 Google \u7684 StackDriver \u4e2d\uff0c\u540e\u9762\u6210\u4e3a\u4e86 OpenMetrics \u6807\u51c6\u7684\u4e00\u90e8\u5206\uff0c\u5728\u5e94\u7528\u901a\u8fc7\u6807\u51c6 /metrics \u7aef\u53e3\u66b4\u9732 Metric \u65f6\uff0cExemplar \u4fe1\u606f\u4e5f\u4f1a\u88ab\u4e00\u8d77\u66b4\u9732\u3002</p> <p>Prometheus \u76ee\u524d\u5df2\u652f\u6301 Exemplar\uff0cPrometheus \u901a\u8fc7 /metrics \u91c7\u96c6\u6570\u636e\u65f6\u4e5f\u4f1a\u628a Exemplar \u5b58\u50a8\u4e0b\u6765\uff0c\u5e76\u66b4\u9732\u5355\u72ec\u7684 API \u6765\u83b7\u53d6 Exemplar \u4fe1\u606f\u3002</p> <pre><code>$ curl -g 'http://localhost:9090/api/v1/query_exemplar?query=test_exemplar_metric_total&amp;start=2020-09-14T15:22:25.479Z&amp;end=020-09-14T15:23:25.479Z'\n{\n    \"status\": \"success\",\n    \"data\": [\n        {\n            \"seriesLabels\": {\n                \"__name__\": \"test_exemplar_metric_total\",\n                \"instance\": \"localhost:8090\",\n                \"job\": \"prometheus\",\n                \"service\": \"bar\"\n            },\n            \"exemplars\": [\n                {\n                    \"labels\": {\n                        \"traceID\": \"EpTxMJ40fUus7aGY\"\n                    },\n                    \"value\": 6,\n                    \"timestamp\": 1600096945479,\n                    \"hasTimestamp\": true\n                }\n            ]\n        },\n    ]\n}\n</code></pre> <p>\u501f\u52a9 Exemplar\uff0c\u53ef\u4ee5\u628a Trace ID \u4f5c\u4e3a\u4e00\u4e2a label pair \u52a0\u5165 Exemplar \u4e2d\uff0c\u4ece\u800c\u53ef\u4ee5\u5728Prometheus \u67e5\u8be2\u5230 Tracing \u7684\u4fe1\u606f\uff0c\u4ece\u800c\u5c06 Metric \u548c Tracing \u8fde\u63a5\u8d77\u6765\u3002</p> <p></p> <p>\u7b2c\u4e8c\uff0cLogging \u548c Tracing \u878d\u5408\u3002</p> <p>\u53ea\u8981\u4f7f\u7528\u5e26\u6709 Tracing \u5e93\u7684 SDK\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u4f1a\u5e26\u4e0a Trace ID\uff0c\u5e76\u628a\u8fd9\u4e9b ID \u6253\u5728\u65e5\u5fd7\u4e2d\u3002</p> <p>\u901a\u8fc7 Trace ID \u53ef\u4ee5\u5b9a\u4f4d\u5230\u4e00\u4e2a\u552f\u4e00\u7684 Tracing\uff0c \u8df3\u8f6c\u5230 Tracing \u7cfb\u7edf\u7684 UI \u8fdb\u884c\u67e5\u8be2\u3002</p> <p>\u7b2c\u4e09\uff0cMetric \u548c Profiling \u878d\u5408\u3002</p> <p>\u57fa\u4e8e Exemplar\uff0c\u628a Profiling ID \u4e5f\u653e\u5165 Exemplar \u4e2d\uff0cPrometheus \u652f\u6301\u5b58\u50a8\u548c\u67e5\u8be2\u5373\u53ef\u3002</p> <p>\u81f3\u4e8e\u5c55\u793a\uff0c\u53ef\u4ee5\u5728 Grafana \u4e0a\u5f00\u53d1\u4e00\u4e2a pprof \u7684 Panel \u63d2\u4ef6\uff0c\u8fd9\u6837\u53ef\u4ee5\u5c55\u793a Profiling\u3002</p>"},{"location":"chap_ot/5OpenTelemetry_log/","title":"3 \u4f7f\u7528 OpenTelemetry Collector \u6536\u96c6 Kubernetes \u65e5\u5fd7\u6570\u636e","text":""},{"location":"chap_ot/5OpenTelemetry_log/#loki","title":"\u5b89\u88c5 Loki","text":"<p>\u9996\u5148\u6211\u4eec\u9700\u8981\u90e8\u7f72 Loki \u6765\u6536\u96c6\u65e5\u5fd7\u6570\u636e\uff0c\u540c\u6837\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Helm Chart \u6765\u5feb\u901f\u90e8\u7f72\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u540c\u6837\u4e0d\u9700\u8981\u90e8\u7f72\u4efb\u4f55\u65e5\u5fd7\u91c7\u96c6\u5668\uff0c\u56e0\u4e3a\u6211\u4eec\u5c06\u4f7f\u7528 OpenTelemetry Collector \u6765\u6536\u96c6\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u518d\u5c06\u5176\u53d1\u9001\u5230 Loki \u4e2d\u3002</p> <pre><code>$ helm repo add grafana https://grafana.github.io/helm-chart\n$ helm repo update\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a loki-values.yaml \u6587\u4ef6\u6765\u914d\u7f6e Loki Helm Chart\uff1a</p> <pre><code># loki-values.yaml\nloki:\n  commonConfig:\n    replication_factor: 1\n  auth_enabled: false\n  storage:\n    type: \"filesystem\"\nsingleBinary:\n  replicas: 1\n  persistence:\n    enabled: true\n    size: 10Gi\n    storageClass: cfsauto\nmonitoring:\n  lokiCanary:\n    enabled: false\n  selfMonitoring:\n    grafanaAgent:\n      installOperator: false\ntest:\n  enabled: false\ngateway:\n  ingress:\n    enabled: true\n    ingressClassName: nginx\n    tls: []\n    hosts:\n      - host: loki.k8s.local\n        paths:\n          - path: /\n            pathType: Prefix\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4e00\u952e\u90e8\u7f72 Loki \u5373\u53ef\uff1a</p> <pre><code>$ helm upgrade --install loki grafana/loki -f loki-values.yaml --namespace kube-otel\n\n$ kubectl get pods -n kube-otel -l app.kubernetes.io/instance=loki\nNAME                            READY   STATUS    RESTARTS   AGE\nloki-0                          1/1     Running   0          3m52s\nloki-gateway-5ffc9fbbf5-m5q75   1/1     Running   0          8m42s\n\n$ kubectl get ingress -n kube-otel\nNAME                 CLASS   HOSTS               ADDRESS       PORTS   AGE\nloki-gateway         nginx   loki.k8s.local      10.98.12.94   80      11m\n</code></pre>"},{"location":"chap_ot/5OpenTelemetry_log/#filelog","title":"\u542f\u7528 filelog \u63a5\u6536\u5668","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u9700\u8981\u914d\u7f6e OpenTelemetry Collector \u6765\u5c06\u65e5\u5fd7\u6570\u636e\u53d1\u9001\u5230 Loki \u4e2d\uff0c\u9996\u5148\u66f4\u65b0 <code>otel-collector-ds-values.yaml</code> \u6587\u4ef6\uff0c\u6211\u4eec\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a Loki \u7684\u5bfc\u51fa\u5668\uff0c\u5e76\u5f00\u542f <code>filelogreceiver</code> \u63a5\u6536\u5668</p> <p><code>opentelemetry-collector</code></p> <pre><code># otel-collector-ds-values.yaml\nmode: daemonset\n\npresets:\n  hostMetrics:\n    enabled: true\n  kubernetesAttributes:\n    enabled: true\n  kubeletMetrics:\n    enabled: true\n  # \u542f\u7528 filelogreceiver \u6536\u96c6\u5668\n  logsCollection:\n    enabled: true\n\nconfig:\n  exporters:\n    loki:\n      endpoint: http://loki-gateway/loki/api/v1/push\n      timeout: 10s # \u8d85\u65f6\u65f6\u95f4\n      read_buffer_size: 200\n      write_buffer_size: 100\n      retry_on_failure: # \u914d\u7f6e\u91cd\u8bd5\n        enabled: true\n        initial_interval: 10s # \u521d\u59cb\u95f4\u9694\n        max_interval: 60s # \u6700\u5927\u95f4\u9694\n        max_elapsed_time: 10m # \u6700\u5927\u65f6\u95f4\n      default_labels_enabled:\n        exporter: false\n\n  processors:\n    resource:\n      attributes:\n        - action: insert\n          key: loki.resource.labels\n          value: k8s.namespace.name,k8s.pod.name,k8s.container.name\n\n  service:\n    pipelines:\n      logs:\n        exporters:\n          - loki\n        processors:\n          - memory_limiter\n          - k8sattributes\n          - resource\n          - batch\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u66f4\u65b0 OpenTelemetry Collector DaemonSet\uff1a</p> <pre><code>$ helm upgrade --install opentelemetry-collector ./opentelemetry-collector -f otel-ds-values.yaml --namespace kube-otel --create-namespace\n</code></pre> <p>\u540c\u6837\u66f4\u65b0\u540e\u67e5\u770b\u5b8c\u6574\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u4f7f\u7528\u547d\u4ee4 <code>kubectl get cm -n opentelemetry-collector-agent -oyaml</code>\uff1a</p> <pre><code>exporters:\n  logging:\n    loglevel: debug\n  loki:\n    endpoint: http://loki-gateway/loki/api/v1/push\n    timeout: 10s # \u8d85\u65f6\u65f6\u95f4\n    read_buffer_size: 200\n    write_buffer_size: 100\n    retry_on_failure: # \u914d\u7f6e\u91cd\u8bd5\n      enabled: true\n      initial_interval: 10s # \u521d\u59cb\u95f4\u9694\n      max_interval: 60s # \u6700\u5927\u95f4\u9694\n      max_elapsed_time: 10m # \u6700\u5927\u65f6\u95f4\n    default_labels_enabled:\n      exporter: false\nextensions:\n  health_check: {}\n  memory_ballast:\n    size_in_percentage: 40\nprocessors:\n  batch: {}\n  k8sattributes:\n    extract:\n      metadata:\n        - k8s.namespace.name\n        - k8s.deployment.name\n        - k8s.statefulset.name\n        - k8s.daemonset.name\n        - k8s.cronjob.name\n        - k8s.job.name\n        - k8s.node.name\n        - k8s.pod.name\n        - k8s.pod.uid\n        - k8s.pod.start_time\n    filter:\n      node_from_env_var: K8S_NODE_NAME\n    passthrough: false\n    pod_association:\n      - sources:\n          - from: resource_attribute\n            name: k8s.pod.ip\n      - sources:\n          - from: resource_attribute\n            name: k8s.pod.uid\n      - sources:\n          - from: connection\n  memory_limiter:\n    check_interval: 5s\n    limit_percentage: 80\n    spike_limit_percentage: 25\n  resource:\n    attributes:\n      - action: insert\n        key: loki.resource.labels\n        value: k8s.namespace.name,k8s.pod.name,k8s.container.name\nreceivers:\n  filelog:\n    exclude:\n      - /var/log/pods/kube-otel_opentelemetry-collector*_*/opentelemetry-collector/*.log\n    include:\n      - /var/log/pods/*/*/*.log\n    include_file_name: false\n    include_file_path: true\n    operators:\n      - id: get-format\n        routes:\n          - expr: body matches \"^\\\\{\"\n            output: parser-docker\n          - expr: body matches \"^[^ Z]+ \"\n            output: parser-crio\n          - expr: body matches \"^[^ Z]+Z\"\n            output: parser-containerd\n        type: router\n      - id: parser-crio\n        regex: ^(?P&lt;time&gt;[^ Z]+) (?P&lt;stream&gt;stdout|stderr) (?P&lt;logtag&gt;[^ ]*) ?(?P&lt;log&gt;.*)$\n        timestamp:\n          layout: 2006-01-02T15:04:05.999999999Z07:00\n          layout_type: gotime\n          parse_from: attributes.time\n        type: regex_parser\n      - combine_field: attributes.log\n        combine_with: \"\"\n        id: crio-recombine\n        is_last_entry: attributes.logtag == 'F'\n        max_log_size: 102400\n        output: extract_metadata_from_filepath\n        source_identifier: attributes[\"log.file.path\"]\n        type: recombine\n      - id: parser-containerd\n        regex: ^(?P&lt;time&gt;[^ ^Z]+Z) (?P&lt;stream&gt;stdout|stderr) (?P&lt;logtag&gt;[^ ]*) ?(?P&lt;log&gt;.*)$\n        timestamp:\n          layout: \"%Y-%m-%dT%H:%M:%S.%LZ\"\n          parse_from: attributes.time\n        type: regex_parser\n      - combine_field: attributes.log\n        combine_with: \"\"\n        id: containerd-recombine\n        is_last_entry: attributes.logtag == 'F'\n        max_log_size: 102400\n        output: extract_metadata_from_filepath\n        source_identifier: attributes[\"log.file.path\"]\n        type: recombine\n      - id: parser-docker\n        output: extract_metadata_from_filepath\n        timestamp:\n          layout: \"%Y-%m-%dT%H:%M:%S.%LZ\"\n          parse_from: attributes.time\n        type: json_parser\n      - id: extract_metadata_from_filepath\n        parse_from: attributes[\"log.file.path\"]\n        regex: ^.*\\/(?P&lt;namespace&gt;[^_]+)_(?P&lt;pod_name&gt;[^_]+)_(?P&lt;uid&gt;[a-f0-9\\-]+)\\/(?P&lt;container_name&gt;[^\\._]+)\\/(?P&lt;restart_count&gt;\\d+)\\.log$\n        type: regex_parser\n      - from: attributes.stream\n        to: attributes[\"log.iostream\"]\n        type: move\n      - from: attributes.container_name\n        to: resource[\"k8s.container.name\"]\n        type: move\n      - from: attributes.namespace\n        to: resource[\"k8s.namespace.name\"]\n        type: move\n      - from: attributes.pod_name\n        to: resource[\"k8s.pod.name\"]\n        type: move\n      - from: attributes.restart_count\n        to: resource[\"k8s.container.restart_count\"]\n        type: move\n      - from: attributes.uid\n        to: resource[\"k8s.pod.uid\"]\n        type: move\n      - from: attributes.log\n        to: body\n        type: move\n    start_at: beginning\n  otlp:\n    protocols:\n      grpc:\n        endpoint: ${env:MY_POD_IP}:4317\n      http:\n        endpoint: ${env:MY_POD_IP}:4318\nservice:\n  extensions:\n    - health_check\n    - memory_ballast\n  pipelines:\n    logs:\n      exporters:\n        - loki\n      processors:\n        - memory_limiter\n        - k8sattributes\n        - resource\n        - batch\n      receivers:\n        - otlp\n        - filelog\n# \u540c\u6837\u53ea\u4fdd\u7559\u4e86\u548c logs \u76f8\u5173\u7684\u914d\u7f6e\uff0c\u5176\u4ed6\u7701\u7565......\n</code></pre> <p>\u9664\u975e\u901a\u8fc7 <code>default_labels_enabled</code> \u8bbe\u7f6e\u7981\u7528\uff0c\u9ed8\u8ba4\u6807\u7b7e\u59cb\u7ec8\u4f1a\u88ab\u8bbe\u7f6e\u3002</p> <ul> <li>job=service.namespace/service.name</li> <li>instance=service.instance.id</li> <li>exporter=OTLP</li> <li>level=severity</li> </ul> <p>\u5982\u679c service.name \u548c service.namespace \u5b58\u5728\uff0c\u90a3\u4e48\u8bbe\u7f6e <code>job=service.namespace/service.name</code>\u3002\u5982\u679c <code>service.name</code> \u5b58\u5728\u4e14 <code>service.namespace</code> \u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u8bbe\u7f6e <code>job=service.name</code>\u3002</p> <p>\u5982\u679c <code>service.name</code> \u4e0d\u5b58\u5728\u4e14 <code>service.namespace</code> \u5b58\u5728\uff0c\u5219\u4e0d\u4f1a\u8bbe\u7f6e job \u6807\u7b7e\u3002\u5982\u679c\u5b58\u5728 <code>service.instance.id</code> \u5219\u8bbe\u7f6e <code>instance=service.instance.id</code>\u3002\u5982\u679c <code>service.instance.id</code> \u4e0d\u5b58\u5728\uff0c\u5219\u4e0d\u8bbe\u7f6e <code>instance</code> \u6807\u7b7e\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u7684\u5b8c\u6574\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>loki:\n  endpoint: http://loki-gateway/loki/api/v1/push\n  timeout: 10s # \u8d85\u65f6\u65f6\u95f4\n  read_buffer_size: 200\n  write_buffer_size: 100\n  retry_on_failure: # \u914d\u7f6e\u91cd\u8bd5\n    enabled: true\n    initial_interval: 10s # \u521d\u59cb\u95f4\u9694\n    max_interval: 60s # \u6700\u5927\u95f4\u9694\n    max_elapsed_time: 10m # \u6700\u5927\u65f6\u95f4\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u4e86\u8d85\u65f6\u65f6\u95f4\uff0c\u8bfb\u5199\u7f13\u51b2\u533a\u5927\u5c0f\uff0c\u53d1\u9001\u961f\u5217\uff0c\u91cd\u8bd5\u7b49\u3002</p> <p><code>read_buffer_size</code> \u548c <code>write_buffer_size</code> \u5b57\u6bb5\u5206\u522b\u6307\u5b9a\u4e86 OpenTelemetry \u5bfc\u51fa\u5668\u7684\u8bfb\u53d6\u548c\u5199\u5165\u7f13\u51b2\u533a\u7684\u5927\u5c0f\u3002\u8fd9\u4e9b\u7f13\u51b2\u533a\u7528\u4e8e\u5728\u53d1\u9001\u6570\u636e\u4e4b\u524d\u7f13\u5b58\u6570\u636e\uff0c\u4ee5\u63d0\u9ad8\u53d1\u9001\u6548\u7387\u548c\u53ef\u9760\u6027\u3002</p> <p><code>read_buffer_size</code> \u5b57\u6bb5\u6307\u5b9a\u4e86\u5bfc\u51fa\u5668\u4ece\u6570\u636e\u6e90\u8bfb\u53d6\u6570\u636e\u65f6\u4f7f\u7528\u7684\u7f13\u51b2\u533a\u5927\u5c0f\u3002\u5982\u679c\u6570\u636e\u6e90\u4ea7\u751f\u7684\u6570\u636e\u91cf\u8d85\u8fc7\u4e86\u7f13\u51b2\u533a\u7684\u5927\u5c0f\uff0c\u5bfc\u51fa\u5668\u5c06\u5206\u6279\u8bfb\u53d6\u6570\u636e\u5e76\u5c06\u5176\u7f13\u5b58\u5230\u7f13\u51b2\u533a\u4e2d\uff0c\u76f4\u5230\u7f13\u51b2\u533a\u88ab\u586b\u6ee1\u6216\u6570\u636e\u6e90\u6ca1\u6709\u66f4\u591a\u6570\u636e\u4e3a\u6b62\u3002</p> <p><code>write_buffer_size</code>\u5b57\u6bb5\u6307\u5b9a\u4e86\u5bfc\u51fa\u5668\u5c06\u6307\u6807\u6570\u636e\u5199\u5165\u76ee\u6807\u65f6\u4f7f\u7528\u7684\u7f13\u51b2\u533a\u5927\u5c0f\u3002\u5982\u679c\u5bfc\u51fa\u5668\u4ea7\u751f\u7684\u6570\u636e\u91cf\u8d85\u8fc7\u4e86\u7f13\u51b2\u533a\u7684\u5927\u5c0f\uff0c\u5bfc\u51fa\u5668\u5c06\u5206\u6279\u5c06\u6570\u636e\u5199\u5165\u76ee\u6807\uff0c\u5e76\u5c06\u5176\u7f13\u5b58\u5230\u7f13\u51b2\u533a\u4e2d\uff0c\u76f4\u5230\u7f13\u51b2\u533a\u88ab\u586b\u6ee1\u6216\u76ee\u6807\u4e0d\u53ef\u7528\u4e3a\u6b62\u3002</p> <p>\u901a\u8fc7\u914d\u7f6e\u8fd9\u4e9b\u7f13\u51b2\u533a\u7684\u5927\u5c0f\uff0c\u60a8\u53ef\u4ee5\u63a7\u5236 OpenTelemetry \u5bfc\u51fa\u5668\u7684\u6027\u80fd\u548c\u53ef\u9760\u6027\u3002\u5982\u679c\u60a8\u7684\u6570\u636e\u6e90\u4ea7\u751f\u7684\u6570\u636e\u91cf\u5f88\u5927\uff0c\u53ef\u4ee5\u589e\u52a0 <code>read_buffer_size</code> \u548c <code>write_buffer_size</code> \u7684\u5927\u5c0f\uff0c\u4ee5\u63d0\u9ad8\u5bfc\u51fa\u5668\u7684\u541e\u5410\u91cf\u548c\u6548\u7387\u3002\u5982\u679c\u60a8\u7684\u76ee\u6807\u4e0d\u592a\u7a33\u5b9a\u6216\u7f51\u7edc\u4e0d\u592a\u53ef\u9760\uff0c\u53ef\u4ee5\u51cf\u5c0f <code>write_buffer_size</code> \u7684\u5927\u5c0f\uff0c\u4ee5\u51cf\u5c11\u6570\u636e\u4e22\u5931\u7684\u98ce\u9669\u3002</p> <p>\u53e6\u5916\u6dfb\u52a0\u4e86\u4e00\u4e2aresource\u7684\u5904\u7406\u5668\uff0c\u5c06 <code>k8s.namespace.name</code>\u3001<code>k8s.pod.name</code>\u3001<code>k8s.container.name</code> \u8f6c\u6362\u4e3a Loki \u6807\u7b7e\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Loki \u4e2d\u5bf9\u5176\u8fdb\u884c\u7d22\u5f15\u4e86\u3002</p> <pre><code>resource:\n  attributes:\n    - action: insert\n      key: loki.resource.labels\n      value: k8s.namespace.name,k8s.pod.name,k8s.container.name\n</code></pre>"},{"location":"chap_ot/5OpenTelemetry_log/#filelog_1","title":"filelog \u63a5\u6536\u5668","text":"<p>\u8be5\u63a5\u6536\u5668\u7528\u4e8e\u4ece\u6587\u4ef6\u4e2d\u6536\u96c6\u5e76\u89e3\u6790\u65e5\u5fd7\u6570\u636e\uff0c\u5b83\u4f1a\u4ece\u6307\u5b9a\u7684\u6587\u4ef6\u4e2d\u8bfb\u53d6\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u5c06\u5176\u53d1\u9001\u5230 OpenTelemetry Collector \u4e2d\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u5bf9\u8be5\u63a5\u6536\u5668\u7684\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>filelog:\n  exclude:\n    - /var/log/pods/kube-otel_opentelemetry-collector*_*/opentelemetry-collector/*.log\n  include:\n    - /var/log/pods/*/*/*.log\n  include_file_name: false\n  include_file_path: true\n  operators:\n    - id: get-format\n      routes:\n        - expr: body matches \"^\\\\{\"\n          output: parser-docker\n        - expr: body matches \"^[^ Z]+ \"\n          output: parser-crio\n        - expr: body matches \"^[^ Z]+Z\"\n          output: parser-containerd\n      type: router\n    - id: parser-crio\n      regex: ^(?P&lt;time&gt;[^ Z]+) (?P&lt;stream&gt;stdout|stderr) (?P&lt;logtag&gt;[^ ]*) ?(?P&lt;log&gt;.*)$\n      timestamp:\n        layout: 2006-01-02T15:04:05.999999999Z07:00\n        layout_type: gotime\n        parse_from: attributes.time\n      type: regex_parser\n    - combine_field: attributes.log\n      combine_with: \"\"\n      id: crio-recombine\n      is_last_entry: attributes.logtag == 'F'\n      max_log_size: 102400\n      output: extract_metadata_from_filepath\n      source_identifier: attributes[\"log.file.path\"]\n      type: recombine\n    - id: parser-containerd\n      regex: ^(?P&lt;time&gt;[^ ^Z]+Z) (?P&lt;stream&gt;stdout|stderr) (?P&lt;logtag&gt;[^ ]*) ?(?P&lt;log&gt;.*)$\n      timestamp:\n        layout: \"%Y-%m-%dT%H:%M:%S.%LZ\"\n        parse_from: attributes.time\n      type: regex_parser\n    - combine_field: attributes.log\n      combine_with: \"\"\n      id: containerd-recombine\n      is_last_entry: attributes.logtag == 'F'\n      max_log_size: 102400\n      output: extract_metadata_from_filepath\n      source_identifier: attributes[\"log.file.path\"]\n      type: recombine\n    - id: parser-docker\n      output: extract_metadata_from_filepath\n      timestamp:\n        layout: \"%Y-%m-%dT%H:%M:%S.%LZ\"\n        parse_from: attributes.time\n      type: json_parser\n    - id: extract_metadata_from_filepath\n      parse_from: attributes[\"log.file.path\"]\n      regex: ^.*\\/(?P&lt;namespace&gt;[^_]+)_(?P&lt;pod_name&gt;[^_]+)_(?P&lt;uid&gt;[a-f0-9\\-]+)\\/(?P&lt;container_name&gt;[^\\._]+)\\/(?P&lt;restart_count&gt;\\d+)\\.log$\n      type: regex_parser\n    - from: attributes.stream\n      to: attributes[\"log.iostream\"]\n      type: move\n    - from: attributes.container_name\n      to: resource[\"k8s.container.name\"]\n      type: move\n    - from: attributes.namespace\n      to: resource[\"k8s.namespace.name\"]\n      type: move\n    - from: attributes.pod_name\n      to: resource[\"k8s.pod.name\"]\n      type: move\n    - from: attributes.restart_count\n      to: resource[\"k8s.container.restart_count\"]\n      type: move\n    - from: attributes.uid\n      to: resource[\"k8s.pod.uid\"]\n      type: move\n    - from: attributes.log\n      to: body\n      type: move\n  start_at: beginning\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u914d\u7f6e\u975e\u5e38\u957f\uff0c\u9996\u5148\u901a\u8fc7 <code>exclude</code> \u6392\u9664\u4e00\u4e9b\u4e0d\u9700\u8981\u6536\u96c6\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u7136\u540e\u901a\u8fc7 <code>include</code> \u6307\u5b9a\u4e86\u9700\u8981\u6536\u96c6\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u7531\u4e8e\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u662f\u57fa\u4e8e Containerd \u5bb9\u5668\u8fd0\u884c\u65f6\u7684\uff0c\u6240\u4ee5\u91c7\u96c6\u7684\u65e5\u5fd7\u76ee\u5f55\u4e3a <code>/var/log/pods/*/*/*.log</code>\uff0c\u7136\u540e\u901a\u8fc7 <code>include_file_path</code> \u6765\u6307\u5b9a\u662f\u5426\u5c06\u6587\u4ef6\u8def\u5f84\u6dfb\u52a0\u4e3a\u5c5e\u6027 <code>log.file.path</code>\uff0c<code>include_file_name</code> \u6307\u5b9a\u662f\u5426\u5c06\u6587\u4ef6\u540d\u6dfb\u52a0\u4e3a\u5c5e\u6027 <code>log.file.name</code>\u3002</p> <p><code>start_at</code> \u8868\u793a\u5728\u542f\u52a8\u65f6\uff0c\u4ece\u6587\u4ef6\u7684\u54ea\u4e2a\u4f4d\u7f6e\u5f00\u59cb\u8bfb\u53d6\u65e5\u5fd7\u3002\u9009\u9879\u6709 beginning \u6216 end\uff0c\u9ed8\u8ba4\u4e3a end\u3002</p> <p>\u7136\u540e\u5c31\u662f\u6700\u91cd\u8981\u7684 operators \u5c5e\u6027\uff0c\u7528\u6765\u6307\u5b9a\u5982\u4f55\u5904\u7406\u65e5\u5fd7\u6587\u4ef6\uff0c\u8fd0\u7b97\u7b26\u662f\u65e5\u5fd7\u5904\u7406\u7684\u6700\u57fa\u672c\u5355\u5143\u3002\u6bcf\u4e2a\u8fd0\u7b97\u7b26\u90fd\u5b8c\u6210\u4e00\u4e2a\u5355\u4e00\u7684\u8d23\u4efb\uff0c\u6bd4\u5982\u4ece\u6587\u4ef6\u4e2d\u8bfb\u53d6\u884c\uff0c\u6216\u8005\u4ece\u5b57\u6bb5\u4e2d\u89e3\u6790 JSON\u3002\u7136\u540e\uff0c\u8fd9\u4e9b\u8fd0\u7b97\u7b26\u88ab\u94fe\u63a5\u5728\u4e00\u8d77\uff0c\u5f62\u6210\u4e00\u4e2a\u7ba1\u9053\uff0c\u4ee5\u5b9e\u73b0\u6240\u9700\u7684\u7ed3\u679c\u3002</p> <p>\u4f8b\u5982\u7528\u6237\u53ef\u4ee5\u4f7f\u7528 <code>file_input</code> \u64cd\u4f5c\u7b26\u4ece\u6587\u4ef6\u4e2d\u8bfb\u53d6\u65e5\u5fd7\u884c\u3002\u7136\u540e\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u7684\u7ed3\u679c\u53ef\u4ee5\u53d1\u9001\u5230 <code>regex_parser</code> \u64cd\u4f5c\u7b26\uff0c\u6839\u636e\u6b63\u5219\u8868\u8fbe\u5f0f\u521b\u5efa\u5b57\u6bb5\u3002\u6700\u540e\uff0c\u8fd9\u4e9b\u7ed3\u679c\u53ef\u4ee5\u53d1\u9001\u5230 <code>file_output</code> \u64cd\u4f5c\u7b26\uff0c\u5c06\u65e5\u5fd7\u5199\u5165\u5230\u78c1\u76d8\u4e0a\u7684\u6587\u4ef6\u4e2d\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u9996\u5148\u914d\u7f6e\u4e86\u4e00\u4e2a <code>router</code> \u64cd\u4f5c\u7b26\uff1a</p> <pre><code>id: get-format\nroutes:\n  - expr: body matches \"^\\\\{\"\n    output: parser-docker\n  - expr: body matches \"^[^ Z]+ \"\n    output: parser-crio\n  - expr: body matches \"^[^ Z]+Z\"\n    output: parser-containerd\ntype: router\n</code></pre> <p>\u8be5\u64cd\u4f5c\u7b26\u5141\u8bb8\u6839\u636e\u65e5\u5fd7\u5185\u5bb9\u52a8\u6001\u8def\u7531\u65e5\u5fd7\uff0c\u6211\u4eec\u8fd9\u91cc\u662f Containerd \u7684\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u4ea7\u751f\u7684\u65e5\u5fd7\u6570\u636e\u53ef\u4ee5\u5339\u914d <code>body matches \"^[^ Z]+Z\"</code>\uff0c\u7136\u540e\u5c06\u6570\u636e\u8def\u7531\u5230 <code>parser-containerd</code> \u64cd\u4f5c\u7b26\u3002</p> <pre><code>id: parser-containerd\nregex: ^(?P&lt;time&gt;[^ ^Z]+Z) (?P&lt;stream&gt;stdout|stderr) (?P&lt;logtag&gt;[^ ]*) ?(?P&lt;log&gt;.*)$\ntimestamp:\n  layout: \"%Y-%m-%dT%H:%M:%S.%LZ\"\n  parse_from: attributes.time\ntype: regex_parser\n</code></pre> <p><code>parser-containerd</code> \u662f\u4e00\u4e2a <code>regex_parser</code>\u64cd\u4f5c\u7b26\uff0c\u5b83\u4f7f\u7528\u6307\u5b9a\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u6765\u89e3\u6790\u524d\u9762\u8def\u7531\u8fc7\u6765\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u4f1a\u5c06\u7ed3\u679c\u5b58\u50a8\u5728 time\u3001stream\u3001logtag\u3001log \u7b49\u5c5e\u6027\u4e2d\uff0c\u5e76\u683c\u5f0f\u5316 timestamp \u65f6\u95f4\u6233\u3002</p> <p>\u63a5\u4e0b\u6765\u518d\u901a\u8fc7 recombine \u64cd\u4f5c\u7b26\u5c06\u8fde\u7eed\u7684\u65e5\u5fd7\u7ec4\u5408\u6210\u5355\u4e2a\u65e5\u5fd7\u3002</p> <pre><code>combine_field: attributes.log\ncombine_with: \"\"\nid: containerd-recombine\nis_last_entry: attributes.logtag == 'F'\nmax_log_size: 102400\noutput: extract_metadata_from_filepath\nsource_identifier: attributes[\"log.file.path\"]\ntype: recombine\n</code></pre> <p>\u7ecf\u8fc7\u4e0a\u9762\u5904\u7406\u540e\u8fdb\u5165<code>extract_metadata_from_filepath</code> \u8fd9\u4e2a\u64cd\u4f5c\u7b26\uff0c\u8be5\u64cd\u4f5c\u7b26\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u4ece\u6587\u4ef6\u8def\u5f84\u4e2d\u63d0\u53d6\u5143\u6570\u636e\uff0c\u7136\u540e\u5c06\u5176\u5b58\u50a8\u5728 namespace\u3001<code>pod_name</code>\u3001uid\u3001<code>container_name</code>\u3001<code>restart_count</code> \u7b49\u5c5e\u6027\u4e2d\u3002</p> <pre><code>id: extract_metadata_from_filepath\nparse_from: attributes[\"log.file.path\"]\nregex: ^.*\\/(?P&lt;namespace&gt;[^_]+)_(?P&lt;pod_name&gt;[^_]+)_(?P&lt;uid&gt;[a-f0-9\\-]+)\\/(?P&lt;container_name&gt;[^\\._]+)\\/(?P&lt;restart_count&gt;\\d+)\\.log$\ntype: regex_parser\n</code></pre> <p>\u63a5\u4e0b\u6765\u5c31\u662f\u901a\u8fc7 move \u64cd\u4f5c\u7b26\u5c06\u4e00\u4e2a\u5b57\u6bb5\u4ece\u4e00\u4e2a\u4f4d\u7f6e\u79fb\u52a8\uff08\u6216\u91cd\u547d\u540d\uff09\u5230\u53e6\u4e00\u4e2a\u4f4d\u7f6e\u3002</p> <pre><code>- from: attributes.stream\n  to: attributes[\"log.iostream\"]\n  type: move\n- from: attributes.container_name\n  to: resource[\"k8s.container.name\"]\n  type: move\n- from: attributes.namespace\n  to: resource[\"k8s.namespace.name\"]\n  type: move\n- from: attributes.pod_name\n  to: resource[\"k8s.pod.name\"]\n  type: move\n- from: attributes.restart_count\n  to: resource[\"k8s.container.restart_count\"]\n  type: move\n- from: attributes.uid\n  to: resource[\"k8s.pod.uid\"]\n  type: move\n- from: attributes.log\n  to: body\n  type: move\n</code></pre> <p>\u6700\u540e\u6211\u4eec\u53ef\u4ee5\u5c06 Loki \u6570\u636e\u6e90\u6dfb\u52a0\u5230 Grafana \u4e2d\uff1a</p> <p></p> <p>Loki \u6570\u636e\u6e90</p> <p>\u7136\u540e\u5728 Explorer \u9875\u9762\u5207\u6362\u5230 Loki \u6570\u636e\u6e90\u4e0b\u9762\u5c31\u53ef\u4ee5\u770b\u5230 Loki \u4e2d\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff1a</p> <p></p> <p>Loki \u65e5\u5fd7</p> <p>\u542f\u7528 k8sobject \u63a5\u6536\u5668</p> <p>\u540c\u6837\u5bf9\u4e8e Gateway \u6a21\u5f0f\u7684\u91c7\u96c6\u5668\u6211\u4eec\u8fd8\u53ef\u4ee5\u53bb\u5f00\u542f k8sobject \u63a5\u6536\u5668\u6765\u91c7\u96c6 Kubernetes Events \u6570\u636e\uff0c\u7136\u540e\u66f4\u65b0 <code>otel-collector-deploy-values.yaml</code>\u6587\u4ef6\uff1a</p> <pre><code># otel-collector-deploy-values.yaml\nmode: deployment\n\n# \u6211\u4eec\u53ea\u9700\u8981\u4e00\u4e2a\u6536\u96c6\u5668 - \u591a\u4e86\u5c31\u4f1a\u4ea7\u751f\u91cd\u590d\u6570\u636e\nreplicaCount: 1\n\npresets:\n  clusterMetrics:\n    enabled: true\n  kubernetesEvents:\n    enabled: true\n\nconfig:\n  exporters:\n    loki:\n      endpoint: http://loki-gateway/loki/api/v1/push\n      timeout: 10s # \u8d85\u65f6\u65f6\u95f4\n      read_buffer_size: 200\n      write_buffer_size: 100\n      retry_on_failure: # \u914d\u7f6e\u91cd\u8bd5\n        enabled: true\n        initial_interval: 10s # \u521d\u59cb\u95f4\u9694\n        max_interval: 60s # \u6700\u5927\u95f4\u9694\n        max_elapsed_time: 10m # \u6700\u5927\u65f6\u95f4\n\n  service:\n    pipelines:\n      logs:\n        exporters:\n          - loki\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u66f4\u65b0 OpenTelemetry Collector Deployment\uff1a</p> <pre><code>$ helm upgrade --install opentelemetry-collector-cluster ./opentelemetry-collector -f otel-collector-deploy-values.yaml --namespace kube-otel --create-namespace\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5f00\u542f\u4e86 kubernetesEvents \u9884\u8bbe\uff0c\u5bf9\u5e94\u7684\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>k8sobjects:\n  objects:\n    - group: events.k8s.io\n      mode: watch\n      name: events\n</code></pre> <p><code>k8sobjects</code> \u63a5\u6536\u5668\u53ef\u4ee5\u7528\u6765\u62c9\u53d6\u6216 Watch Kubernetes API \u670d\u52a1\u5668\u4e2d\u7684\u5bf9\u8c61\uff0c\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7 group\u3001mode\u3001name \u6765\u6307\u5b9a\u8981\u62c9\u53d6\u7684 Kubernetes Events \u5bf9\u8c61\u3002</p> <p>\u6700\u540e\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 Loki \u4e2d\u67e5\u627e\u5230\u5bf9\u5e94\u7684 Events \u65e5\u5fd7\u6570\u636e\u3002</p> <p></p>"},{"location":"chap_ot/6OpenTelemetry_java/","title":"8 Java \u5e94\u7528\u901a\u8fc7 OpenTelemetry API \u5b9e\u73b0\u624b\u52a8\u57cb\u70b9","text":"<p>Java \u5e94\u7528\u53ef\u4ee5\u901a\u8fc7 OpenTelemetry \u63d0\u4f9b\u7684 Java agent \u6765\u5b9e\u73b0\u81ea\u52a8\u57cb\u70b9\u529f\u80fd\uff0c\u5728\u5927\u591a\u6570\u573a\u666f\u4e0b\u4e5f\u5b8c\u5168\u8db3\u591f\u4e86\uff0c\u4f46\u662f\u6709\u65f6\u5019\u6211\u4eec\u9700\u8981\u66f4\u52a0\u7cbe\u7ec6\u7684\u63a7\u5236\uff0c\u8fd9\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u624b\u52a8\u57cb\u70b9\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u4e86\u3002</p>"},{"location":"chap_ot/6OpenTelemetry_java/#_1","title":"\u4f7f\u7528\u6ce8\u89e3\u57cb\u70b9","text":"<p>\u6211\u4eec\u53ef\u4ee5\u5728 Java \u5e94\u7528\u901a\u8fc7\u624b\u52a8\u57cb\u70b9\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u94fe\u8def\u8ffd\u8e2a\uff0c\u4f46\u5982\u679c\u6211\u4eec\u4e0d\u5e0c\u671b\u8fdb\u884c\u592a\u591a\u7684\u4ee3\u7801\u66f4\u6539\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u6ce8\u89e3\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\uff0cOpenTelemetry \u63d0\u4f9b\u4e86\u4e00\u4e9b\u6ce8\u89e3\u6765\u5e2e\u52a9\u6211\u4eec\u5b9e\u73b0\u624b\u52a8\u57cb\u70b9\uff0c\u6bd4\u5982 <code>@WithSpan</code>\u3001<code>@SpanAttribute</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u9700\u8981\u6dfb\u52a0\u4f9d\u8d56\u5e93 <code>opentelemetry-instrumentation-annotations</code>\u3002</p> <pre><code>&lt;dependencies&gt;\n  &lt;dependency&gt;\n    &lt;groupId&gt;io.opentelemetry.instrumentation&lt;/groupId&gt;\n    &lt;artifactId&gt;opentelemetry-instrumentation-annotations&lt;/artifactId&gt;\n    &lt;version&gt;1.29.0&lt;/version&gt;\n  &lt;/dependency&gt;\n&lt;/dependencies&gt;\n</code></pre> <p>\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u4f7f\u7528 <code>@WithSpan</code> \u6ce8\u89e3\u6765\u5411 <code>OpenTelemetry</code> \u81ea\u52a8\u68c0\u6d4b\u53d1\u9001\u4fe1\u53f7\uff0c\u6bcf\u5f53\u6807\u8bb0\u7684\u65b9\u6cd5\u88ab\u6267\u884c\u65f6\u90fd\u5e94\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 span\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5728 Order Service \u4e2d\u7684 <code>IndexController</code> \u4e2d\u6dfb\u52a0\u4e00\u4e2a <code>@WithSpan</code>\u6ce8\u89e3\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// src/main/java/com/youdianzhishi/orderservice/controller/IndexController.java\npackage com.youdianzhishi.orderservice.controller;\n\n// ......\n\nimport io.opentelemetry.instrumentation.annotations.WithSpan;\n\n\n@RestController\n@RequestMapping(\"/\")\npublic class IndexController {\n    @GetMapping\n    @WithSpan\n    public ResponseEntity&lt;String&gt; home(HttpServletRequest request) {\n        return new ResponseEntity&lt;&gt;(\"Hello OpenTelemetry!\", HttpStatus.OK);\n    }\n}\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u91cd\u5efa\u955c\u50cf\uff0c\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\uff0c\u5f53\u6211\u4eec\u8bbf\u95ee\u9996\u9875\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u770b\u5230 Jaeger UI \u4e2d\u591a\u4e86\u4e00\u4e2a IndexController.home \u7684 span \u4e86\u3002</p> <p></p> <p>\u6bcf\u6b21\u5e94\u7528\u7a0b\u5e8f\u8c03\u7528\u6709\u6ce8\u89e3\u7684\u65b9\u6cd5\u65f6\uff0c\u5b83\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u8868\u793a\u5176\u6301\u7eed\u65f6\u95f4\u5e76\u63d0\u4f9b\u4efb\u4f55\u629b\u51fa\u5f02\u5e38\u7684 span\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cspan \u540d\u79f0\u662f <code>&lt;className&gt;.&lt;methodName&gt;</code>\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u5728\u6ce8\u89e3\u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e2a\u540d\u79f0\u4f5c\u4e3a\u53c2\u6570\uff0c\u6bd4\u5982\u53ef\u4ee5\u4f7f\u7528 <code>@WithSpan(\"indexSpan\")</code>\u6765\u6307\u5b9a span \u7684\u540d\u79f0\uff0c\u8fd9\u6837\u5728 Jaeger UI \u4e2d\u5c31\u53ef\u4ee5\u770b\u5230 <code>indexSpan</code> \u7684 span \u4e86\u3002</p> <p></p> <p>\u6b64\u5916\u5f53\u4e3a\u4e00\u4e2a\u5e26\u6ce8\u89e3\u7684\u65b9\u6cd5\u521b\u5efa\u4e00\u4e2a span \u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 <code>@SpanAttribute</code> \u6ce8\u89e3\u6765\u81ea\u52a8\u5c06\u65b9\u6cd5\u8c03\u7528\u7684\u53c2\u6570\u503c\u6dfb\u52a0\u4e3a\u521b\u5efa span \u7684\u5c5e\u6027\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5728 <code>IndexController</code> \u4e2d\u6dfb\u52a0\u4e00\u4e2a <code>fetchId</code> \u51fd\u6570\uff0c\u5e76\u63a5\u6536\u4e00\u4e2a id \u53c2\u6570\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>@SpanAttribute</code> \u6ce8\u89e3\u6765\u5c06\u63a5\u6536\u7684 <code>id</code>\u53c2\u6570\u6dfb\u52a0\u4e3a <code>indexSpanWithAttr</code> \u8fd9\u4e2a <code>span</code> \u7684\u5c5e\u6027\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// src/main/java/com/youdianzhishi/orderservice/controller/IndexController.java\npackage com.youdianzhishi.orderservice.controller;\n\n// ......\n\nimport io.opentelemetry.instrumentation.annotations.WithSpan;\nimport io.opentelemetry.instrumentation.annotations.SpanAttribute;\n\n\n@RestController\n@RequestMapping(\"/\")\npublic class IndexController {\n    @GetMapping\n    @WithSpan(\"indexSpan\")\n    public ResponseEntity&lt;String&gt; home(HttpServletRequest request) {\n        return new ResponseEntity&lt;&gt;(\"Hello OpenTelemetry!\", HttpStatus.OK);\n    }\n\n    @GetMapping(\"/{id}\")\n    @WithSpan(\"indexSpanWithAttr\")\n    public ResponseEntity&lt;String&gt; fetchId(@SpanAttribute(\"id\") @PathVariable Long id) {\n        return new ResponseEntity&lt;&gt;(\"Hello OpenTelemetry\uff1a\" + id, HttpStatus.OK);\n    }\n}\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u91cd\u5efa\u955c\u50cf\uff0c\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\uff0c\u5f53\u6211\u4eec\u8bbf\u95ee <code>http://localhost:8081/123</code> \u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u770b\u5230 Jaeger UI \u4e2d\u591a\u4e86\u4e00\u4e2a <code>indexSpanWithAttr</code> \u7684 span \u4e86\uff0c\u5e76\u4e14\u8be5 span \u7684\u5c5e\u6027\u4e2d\u5305\u542b\u4e86\u6211\u4eec\u4f20\u9012\u7684 id \u53c2\u6570\u3002</p> <p></p>"},{"location":"chap_ot/6OpenTelemetry_java/#api","title":"\u4f7f\u7528 API \u624b\u52a8\u57cb\u70b9","text":"<p>\u9664\u4e86\u4f7f\u7528\u6ce8\u89e3\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u57cb\u70b9\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 OpenTelemetry \u63d0\u4f9b\u7684 API \u6765\u5b9e\u73b0\u624b\u52a8\u57cb\u70b9\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u66f4\u52a0\u7cbe\u7ec6\u7684\u63a7\u5236\u6211\u4eec\u7684 span \u4e86\uff0c\u5f53\u7136\u8fd9\u6837\u4e5f\u4f1a\u589e\u52a0\u6211\u4eec\u7684\u4ee3\u7801\u91cf\uff0c\u4f46\u5c31\u4e0d\u9700\u8981\u4f7f\u7528 <code>java agent</code> \u4e86\u3002</p> <p>\u5728 Java \u5e94\u7528\u4e2d\uff0c\u8981\u5b9e\u73b0\u624b\u52a8\u57cb\u70b9\uff0c</p> <ul> <li>\u9996\u5148\u7b2c\u4e00\u6b65\u662f\u83b7\u53d6 <code>OpenTelemetry</code> \u63a5\u53e3\u7684\u5b9e\u4f8b\uff0c\u6211\u4eec\u9700\u8981\u5c3d\u65e9\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u914d\u7f6e\u4e00\u4e2a <code>OpenTelemetrySdk</code> \u7684\u5b9e\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>OpenTelemetrySdk.builder()</code> \u65b9\u6cd5\u6765\u5b8c\u6210\u8fd9\u4e2a\u64cd\u4f5c\u3002</li> <li>\u7136\u540e\u53ef\u4ee5\u901a\u8fc7\u8fd4\u56de\u7684 <code>OpenTelemetrySdkBuilder</code> \u5b9e\u4f8b\u83b7\u53d6\u4e0e\u4fe1\u53f7\u3001\u8ddf\u8e2a\u548c\u6307\u6807\u76f8\u5173\u7684\u63d0\u4f9b\u7a0b\u5e8f\uff0c\u4ee5\u6784\u5efa <code>OpenTelemetry</code> \u5b9e\u4f8b\u3002</li> <li>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>SdkTracerProvider.builder()</code>\u548c <code>SdkMeterProvider.builder()</code>\u65b9\u6cd5\u6765\u6784\u5efa Provider\u3002</li> <li>\u6b64\u5916\u8fd8\u5f3a\u70c8\u5efa\u8bae\u5c06 Resource \u5b9e\u4f8b\u5b9a\u4e49\u4e3a\u751f\u6210\u9065\u6d4b\u6570\u636e\u7684\u5b9e\u4f53\u7684\u8868\u793a\uff1b\u7279\u522b\u662f service.name \u5c5e\u6027\u662f\u6700\u91cd\u8981\u7684\u9065\u6d4b\u6e90\u6807\u8bc6\u4fe1\u606f\u7684\u4e00\u90e8\u5206\u3002</li> </ul> <pre><code>&lt;!-- pom.xml --&gt;\n&lt;project&gt;\n    &lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;\n                &lt;artifactId&gt;opentelemetry-bom&lt;/artifactId&gt;\n                &lt;version&gt;1.29.0&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;\n            &lt;artifactId&gt;opentelemetry-api&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;\n            &lt;artifactId&gt;opentelemetry-sdk&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;\n            &lt;artifactId&gt;opentelemetry-exporter-otlp&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;\n            &lt;artifactId&gt;opentelemetry-semconv&lt;/artifactId&gt;\n            &lt;version&gt;1.29.0-alpha&lt;/version&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n&lt;/project&gt;\n</code></pre> <p>\u5728 <code>pom.xml</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e86 <code>opentelemetry-api</code>\u3001<code>opentelemetry-sdk</code>\u3001<code>opentelemetry-exporter-otlp</code>\u3001<code>opentelemetry-semconv</code>\u8fd9\u51e0\u4e2a\u4f9d\u8d56\u5e93\uff0c\u5176\u4e2d <code>opentelemetry-semconv</code> \u662f\u7528\u6765\u5b9a\u4e49\u4e00\u4e9b\u5e38\u7528\u7684\u5c5e\u6027\u7684\uff0c\u6bd4\u5982 <code>service.name</code>\u3001<code>http.method</code>\u3001<code>http.status_code</code> \u7b49\uff0c\u5f53\u7136\u73b0\u5728\u6211\u4eec\u5c31\u4e0d\u9700\u8981 <code>opentelemetry-instrumentation-annotations</code> \u8fd9\u4e2a\u4f9d\u8d56\u5e93\u4e86\u3002</p> <p>\u5728 Spring Boot \u9879\u76ee\u4e2d\uff0c\u521d\u59cb\u5316 <code>OpenTelemetry</code> \u7684\u4e00\u79cd\u5e38\u89c1\u65b9\u6cd5\u662f\u4f7f\u7528 <code>@Configuration</code> \u7c7b\u3002</p> <p>\u8fd9\u6837\u7684\u7c7b\u4f1a\u5728 Spring Boot \u5e94\u7528\u542f\u52a8\u65f6\u81ea\u52a8\u8fd0\u884c\uff0c\u4f7f\u5f97\u521d\u59cb\u5316\u5de5\u4f5c\u66f4\u52a0\u96c6\u4e2d\u548c\u7ec4\u7ec7\u5316\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 OpenTelemetryConfig \u7c7b\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// src/main/java/com/youdianzhishi/orderservice/config/OpenTelemetryConfig.java\npackage com.youdianzhishi.orderservice.config;\n\nimport io.opentelemetry.api.OpenTelemetry;\nimport io.opentelemetry.api.common.Attributes;\nimport io.opentelemetry.exporter.otlp.trace.OtlpGrpcSpanExporter;\nimport io.opentelemetry.sdk.OpenTelemetrySdk;\nimport io.opentelemetry.sdk.resources.Resource;\nimport io.opentelemetry.sdk.trace.SdkTracerProvider;\nimport io.opentelemetry.sdk.trace.export.SimpleSpanProcessor;\nimport io.opentelemetry.semconv.resource.attributes.ResourceAttributes;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.core.annotation.Order;\n\n@Configuration\n@Order(2)\npublic class OpenTelemetryConfig {\n\n    @Bean\n    public OpenTelemetry openTelemetry() {\n        GlobalOpenTelemetry.resetForTest(); // \u521d\u59cb\u5316\u4e4b\u524d\u5148\u91cd\u7f6e GlobalOpenTelemetry\n\n        // \u4ece\u73af\u5883\u53d8\u91cf\u4e2d\u83b7\u53d6 OTLP Exporter \u7684\u5730\u5740\n        String exporterEndpointFromEnv = System.getenv(\"OTLP_EXPORTER_ENDPOINT\");\n        String exporterEndpoint = exporterEndpointFromEnv != null ? exporterEndpointFromEnv\n                : \"http://otel-collector:4317\";\n\n        String serviceNameFromEnv = System.getenv(\"SERVICE_NAME\");\n        String serviceName = serviceNameFromEnv != null ? serviceNameFromEnv : \"order-service\";\n\n        // \u521d\u59cb\u5316 OTLP Exporter\n        OtlpGrpcSpanExporter exporter = OtlpGrpcSpanExporter.builder()\n                .setEndpoint(exporterEndpoint)\n                .build();\n\n        Resource resource = Resource.getDefault()\n                .merge(Resource.create(Attributes.of(\n                        ResourceAttributes.SERVICE_NAME, serviceName,\n                        ResourceAttributes.TELEMETRY_SDK_LANGUAGE, \"java\")));\n\n        // \u521d\u59cb\u5316 TracerProvider\n        SdkTracerProvider tracerProvider = SdkTracerProvider.builder()\n                .addSpanProcessor(SimpleSpanProcessor.create(exporter))\n                .setResource(resource)\n                .build();\n\n        // \u521d\u59cb\u5316 ContextPropagators\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u5305\u542b W3C Trace Context \u548c W3C Baggage\n        ContextPropagators propagators = ContextPropagators.create(\n                TextMapPropagator.composite(\n                        W3CTraceContextPropagator.getInstance(),\n                        W3CBaggagePropagator.getInstance()));\n\n        // \u521d\u59cb\u5316\u5e76\u8fd4\u56de OpenTelemetry SDK\n        return OpenTelemetrySdk.builder()\n                .setPropagators(propagators)\n                .setTracerProvider(tracerProvider)\n                .buildAndRegisterGlobal();\n    }\n\n    @Bean\n    public Tracer tracer() {\n        return openTelemetry().getTracer(OrderserviceApplication.class.getName());\n    }\n}\n</code></pre> <p>\u5728\u4e0a\u8ff0\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>@Configuration</code> \u7c7b\uff0c\u5e76\u4f7f\u7528 <code>@Bean</code>\u6ce8\u89e3\u4e3a <code>OpenTelemetry</code> \u521b\u5efa\u4e86\u4e00\u4e2a <code>Bean</code>\uff0c<code>Spring</code> \u4f1a\u7ba1\u7406\u8fd9\u4e2a <code>Bean</code> \u7684\u751f\u547d\u5468\u671f\uff0c\u5e76\u5728\u9700\u8981\u65f6\u81ea\u52a8\u6ce8\u5165\u3002</p> <p>\u8fd9\u6837\uff0c\u4f60\u7684 <code>Spring Boot</code> \u5e94\u7528\u6bcf\u6b21\u542f\u52a8\u65f6\uff0c\u90fd\u4f1a\u6267\u884c\u8fd9\u4e9b\u521d\u59cb\u5316\u4ee3\u7801\uff0c\u4ece\u800c\u786e\u4fdd\u4e86 <code>OpenTelemetry</code> \u7684\u6b63\u786e\u914d\u7f6e\u3002</p> <p>\u5728\u771f\u6b63\u521d\u59cb\u5316\u7684\u4ee3\u7801\u4e2d\uff0c\u6211\u4eec\u9996\u5148\u4ece\u73af\u5883\u53d8\u91cf\u4e2d\u83b7\u53d6 OTLP Exporter \u7684\u5730\u5740\uff0c\u7136\u540e\u521d\u59cb\u5316 OTLP Exporter\uff0c\u63a5\u7740\u521d\u59cb\u5316 <code>TracerProvider</code>\uff0c\u6700\u540e\u521d\u59cb\u5316\u5e76\u8fd4\u56de <code>OpenTelemetry SDK</code>\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u5728 <code>OrderController</code>\u4e2d\u7684 <code>getAllOrders</code> \u5904\u7406\u5668\u4e2d\u6765\u624b\u52a8\u57cb\u70b9\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// src/main/java/com/youdianzhishi/orderservice/controller/OrderController.java\npackage com.youdianzhishi.orderservice.controller;\n\n// ......\n\nimport io.opentelemetry.api.OpenTelemetry;\nimport io.opentelemetry.api.trace.StatusCode;\nimport io.opentelemetry.api.trace.Tracer;\n\n@RestController\n@RequestMapping(\"/api/orders\")\npublic class OrderController {\n    private static final Logger logger = LoggerFactory.getLogger(OrderserviceApplication.class);\n\n    @Autowired\n    private OrderRepository orderRepository;\n\n    @Autowired\n    private WebClient webClient;\n\n    @Autowired\n    private Tracer tracer;  // \u6ce8\u5165 Tracer\n\n    @GetMapping\n    public ResponseEntity&lt;List&lt;OrderDto&gt;&gt; getAllOrders(HttpServletRequest request) {\n        // \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Span \u5e76\u8bbe\u7f6e Span \u540d\u79f0\u4e3a \"GET /api/orders\"\n        var span = tracer.spanBuilder(\"GET /api/orders\").startSpan();\n\n        // \u5c06 Span \u6ce8\u5165\u5230\u4e0a\u4e0b\u6587\u4e2d\n        try (var scope = span.makeCurrent()) {\n            // \u4ece\u62e6\u622a\u5668\u4e2d\u83b7\u53d6\u7528\u6237\u4fe1\u606f\n            User user = (User) request.getAttribute(\"user\");\n\n            // \u8981\u6839\u636e orderDate \u5012\u5e8f\u6392\u5217\n            List&lt;Order&gt; orders = orderRepository.findByUserIdOrderByOrderDateDesc(user.getId());\n\n            // \u5c06Order\u8f6c\u6362\u4e3aOrderDto\n            List&lt;OrderDto&gt; orderDtos = orders.stream().map(order -&gt; {\n                try {\n                    return order.toOrderDto(webClient);\n                } catch (Exception e) {\n                    throw new RuntimeException(e);\n                }\n            }).collect(Collectors.toList());\n\n            span.setAttribute(\"user_id\", user.getId());\n            span.setAttribute(\"order_count\", orders.size());\n\n            return new ResponseEntity&lt;&gt;(orderDtos, HttpStatus.OK);\n        } catch (Exception e) {\n            // \u8bb0\u5f55 Span \u9519\u8bef\n            span.recordException(e).setStatus(StatusCode.ERROR, e.getMessage());\n            return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);\n        } finally {\n            // \u8bb0\u5f55 Span \u7ed3\u675f\u65f6\u95f4\n            span.end();\n        }\n    }\n\n    // \u5ffd\u7565\u5176\u4ed6......\n}\n</code></pre> <p>\u4e0a\u9762\u4ee3\u7801\u4e2d\u6211\u4eec\u9996\u5148\u901a\u8fc7 <code>openTelemetry.getTracer(OrderController.class.getName())</code> \u65b9\u6cd5\u6765\u521d\u59cb\u5316 Tracer\uff0c\u7136\u540e\u901a\u8fc7 <code>tracer.spanBuilder(\"getAllOrders\").startSpan()</code> \u65b9\u6cd5\u6765\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Span\uff0c\u63a5\u7740\u901a\u8fc7 <code>span.makeCurrent()</code> \u65b9\u6cd5\u5c06 Span \u6ce8\u5165\u5230\u4e0a\u4e0b\u6587\u4e2d\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u5728 try \u4ee3\u7801\u5757\u4e2d\u6267\u884c\u6211\u4eec\u7684\u4e1a\u52a1\u903b\u8f91\u4e86\uff0c\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e24\u4e2a\u5c5e\u6027\uff0c\u5982\u679c\u51fa\u73b0\u4e86\u5f02\u5e38\u5219\u4f1a\u8bb0\u5f55\u5f02\u5e38\u4fe1\u606f\uff0c\u6700\u540e\u5728 finally \u4ee3\u7801\u5757\u4e2d\u7ed3\u675f Span\u3002</p> <p>\u6211\u4eec\u8fd8\u9700\u8981\u4fee\u6539 Dockerfile \u4e2d\u7684\u542f\u52a8\u547d\u4ee4\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># ......\n# CMD [\"mvn\", \"-Pdev\", \"spring-boot:run\"]\nCMD [\"mvn\", \"spring-boot:run\"]\n</code></pre> <p>\u56e0\u4e3a\u73b0\u5728\u6211\u4eec\u4e0d\u9700\u8981\u4f7f\u7528 <code>java agent</code> \u4e86\uff0c\u6240\u4ee5\u53bb\u6389 <code>-Pdev</code> \u53c2\u6570\uff08\u8be5 profile \u4e2d\u5b9a\u4e49\u4e86 <code>java agent</code> \u542f\u52a8\u53c2\u6570\uff09\uff0c\u7136\u540e\u91cd\u65b0\u6784\u5efa\u955c\u50cf\uff0c\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\uff0c\u5f53\u6211\u4eec\u8bbf\u95ee\u8ba2\u5355\u5217\u8868\u540e\u5c31\u53ef\u4ee5\u770b\u5230 Jaeger UI \u4e2d\u591a\u4e86\u4e00\u4e2a <code>getAllOrders</code>\u7684 <code>span</code> \u4e86\u3002</p> <p></p> <p>\u5f88\u660e\u663e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u7684 span \u975e\u5e38\u7b80\u5355\uff0c\u6ca1\u6709\u548c\u524d\u7aef frontend \u670d\u52a1\u7684 span \u5173\u8054\u8d77\u6765\u3002</p> <p>\u7531\u4e8e\u524d\u7aef <code>frontend</code>\u5728\u8bf7\u6c42\u540e\u7aef\u63a5\u53e3\u7684\u65f6\u5019\u6211\u4eec\u5df2\u7ecf\u6ce8\u5165\u4e86 <code>W3CTraceContext</code>\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u5728 Java \u5e94\u7528\u4e2d\u901a\u8fc7 <code>propagation api</code> \u6765\u83b7\u53d6\u5230 <code>span context</code>\uff0c\u7136\u540e\u5c06\u5176\u4f5c\u4e3a\u7236\u7ea7 <code>span</code>\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5c06\u524d\u7aef\u7684 span \u548c\u540e\u7aef\u7684 span \u5173\u8054\u8d77\u6765\u4e86\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a\u62e6\u622a\u5668\u6765\u4f7f\u7528 <code>propagation</code> \u63a5\u53e3\u89e3\u6790 <code>span context</code>\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// src/main/java/com/youdianzhishi/orderservice/interceptor/OpenTelemetryInterceptor.java\npackage com.youdianzhishi.orderservice.interceptor;\n\n// ......\n\n@Component\npublic class OpenTelemetryInterceptor implements HandlerInterceptor {\n    @Autowired\n    private OpenTelemetry openTelemetry;\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {\n        TextMapGetter&lt;HttpServletRequest&gt; getter = new TextMapGetter&lt;&gt;() {\n            @Override\n            public Iterable&lt;String&gt; keys(HttpServletRequest carrier) {\n                return Collections.list(carrier.getHeaderNames());\n            }\n\n            @Override\n            public String get(HttpServletRequest carrier, String key) {\n                return carrier.getHeader(key);\n            }\n        };\n\n        // \u63d0\u53d6\u4f20\u5165\u7684Trace Context\n        Context extractedContext = openTelemetry.getPropagators().getTextMapPropagator()\n                                       .extract(Context.current(), request, getter);\n\n        StringBuilder sb = new StringBuilder();\n        sb.append(request.getMethod()).append(\" \").append(request.getRequestURI());\n        Span span = tracer.spanBuilder(sb.toString()).setParent(extractedContext)\n                    .startSpan();\n\n        // \u5c06\u89e3\u6790\u51fa\u6765\u7684SpanContext\u5b58\u50a8\u5728\u8bf7\u6c42\u5c5e\u6027\u4e2d\uff0c\u4ee5\u4fbf\u540e\u7eed\u4f7f\u7528\n        request.setAttribute(\"currentSpan\", span);\n\n        return true;\n    }\n}\n</code></pre> <p>\u4e0a\u9762\u4ee3\u7801\u4e2d\u6211\u4eec\u9996\u5148\u901a\u8fc7 <code>openTelemetry.getPropagators().getTextMapPropagator()</code> \u65b9\u6cd5\u6765\u83b7\u53d6\u5230 <code>TextMapPropagator</code>\uff0c\u7136\u540e\u901a\u8fc7 <code>extract</code> \u65b9\u6cd5\u6765\u89e3\u6790 <code>span context</code>\uff0c\u7136\u540e\u5c06\u89e3\u6790\u51fa\u6765\u7684 <code>span context</code> \u8bbe\u7f6e\u4e3a\u5b50 <code>span</code> \u7684\u7236\u7ea7<code>span</code>\uff0c\u6700\u540e\u5c06 <code>span context</code> \u5b58\u50a8\u5728\u8bf7\u6c42\u5c5e\u6027\u4e2d\uff0c\u4ee5\u4fbf\u540e\u7eed\u4f7f\u7528\u3002</p> <p>\u8fd9\u91cc\u7684\u5173\u952e\u662f\u5728\u521d\u59cb\u5316 <code>OpenTelemetry</code>\u7684\u65f6\u5019\u9700\u8981\u914d\u7f6e <code>ContextPropagators</code>\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// \u521d\u59cb\u5316 ContextPropagators\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u5305\u542b W3C Trace Context \u548c W3C Baggage\nContextPropagators propagators = ContextPropagators.create(\n        TextMapPropagator.composite(\n                W3CTraceContextPropagator.getInstance(),\n                W3CBaggagePropagator.getInstance()));\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u624d\u80fd\u53bb\u89e3\u6790 <code>TraceContext</code> \u548c <code>Baggage</code> \u4e24\u79cd\u4e0a\u4e0b\u6587\u4f20\u64ad\u673a\u5236\u3002\u800c\u5176\u4e2d\u7684 getter \u5c31\u662f\u7528\u6765\u4ece HTTP \u8bf7\u6c42\u5934\u4e2d\u83b7\u53d6 <code>span context</code> \u7684\u65b9\u5f0f\u3002</p> <p>\u5f53\u7136\u6700\u540e\u6211\u4eec\u8fd8\u9700\u8981\u5728 <code>WebMvcConfig</code> \u4e2d\u6ce8\u518c\u8be5\u62e6\u622a\u5668\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a</p> <pre><code>// src/main/java/com/youdianzhishi/orderservice/config/WebMvcConfig.java\npackage com.youdianzhishi.orderservice.config;\n\n// ......\n\n@Configuration\n@Order(4)\npublic class WebMvcConfig implements WebMvcConfigurer {\n\n    @Autowired\n    private TokenInterceptor tokenInterceptor;\n\n    @Autowired\n    private OpenTelemetryInterceptor otelCtxInterceptor;\n\n    @Override\n    public void addInterceptors(InterceptorRegistry registry) {\n        registry.addInterceptor(otelCtxInterceptor)\n            .addPathPatterns(\"/api/orders/**\");\n\n        registry.addInterceptor(tokenInterceptor)\n            .addPathPatterns(\"/api/orders/**\") // \u6307\u5b9a\u62e6\u622a\u5668\u5e94\u8be5\u5e94\u7528\u7684\u8def\u5f84\u6a21\u5f0f\n            .excludePathPatterns(\"/api/login\", \"/api/register\"); // \u6307\u5b9a\u5e94\u8be5\u6392\u9664\u7684\u8def\u5f84\u6a21\u5f0f\n    }\n\n}\n</code></pre> <p>\u8fd9\u6837\u5f53\u6211\u4eec\u5728\u8bf7\u6c42 <code>/api/orders/**</code> \u4e0b\u9762\u7684\u63a5\u53e3\u65f6\uff0c\u5c31\u53ef\u4ee5\u4ece\u8bf7\u6c42\u5c5e\u6027\u4e2d\u83b7\u53d6\u7236\u7ea7\u7684 <code>span context</code> \u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u4fee\u6539 <code>getAllOrders</code> \u5904\u7406\u5668\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>@GetMapping\npublic ResponseEntity&lt;List&lt;OrderDto&gt;&gt; getAllOrders(HttpServletRequest request) {\n    // \u4ece\u8bf7\u6c42\u5c5e\u6027\u4e2d\u83b7\u53d6 Span\n    Span span = (Span) request.getAttribute(\"currentSpan\");\n\n    try {\n        // \u4ece\u62e6\u622a\u5668\u4e2d\u83b7\u53d6\u7528\u6237\u4fe1\u606f\n        User user = (User) request.getAttribute(\"user\");\n\n        // \u8981\u6839\u636e orderDate \u5012\u5e8f\u6392\u5217\n        List&lt;Order&gt; orders = orderRepository.findByUserIdOrderByOrderDateDesc(user.getId());\n\n        // \u5c06Order\u8f6c\u6362\u4e3aOrderDto\n        List&lt;OrderDto&gt; orderDtos = orders.stream().map(order -&gt; {\n            try {\n                return order.toOrderDto(webClient);\n            } catch (Exception e) {\n                throw new RuntimeException(e);\n            }\n        }).collect(Collectors.toList());\n\n        span.setAttribute(\"user_id\", user.getId());\n        span.setAttribute(\"order_count\", orders.size());\n\n        return new ResponseEntity&lt;&gt;(orderDtos, HttpStatus.OK);\n    } catch (Exception e) {\n        // \u8bb0\u5f55 Span \u9519\u8bef\n        span.recordException(e).setStatus(StatusCode.ERROR, e.getMessage());\n        return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);\n    } finally {\n        // \u8bb0\u5f55 Span \u7ed3\u675f\u65f6\u95f4\n        span.end();\n    }\n\n}\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u9996\u5148\u901a\u8fc7\u8bf7\u6c42\u5c5e\u6027\u83b7\u53d6\u5230 span context\uff0c\u8fd9\u91cc\u6211\u4eec\u6dfb\u52a0\u4e86\u4e24\u4e2a\u5c5e\u6027\uff0c\u5982\u679c\u51fa\u73b0\u4e86\u5f02\u5e38\u5219\u4f1a\u8bb0\u5f55\u5f02\u5e38\u4fe1\u606f\uff0c\u6700\u540e\u5728 finally \u4ee3\u7801\u5757\u4e2d\u7ed3\u675f Span\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\uff0c\u5f53\u6211\u4eec\u8bbf\u95ee\u8ba2\u5355\u5217\u8868\u540e\u5c31\u53ef\u4ee5\u770b\u5230 Jaeger UI \u4e2d\u591a\u4e86\u4e00\u4e2a <code>GET /api/orders</code> \u7684 span \u4e86\uff0c\u5e76\u4e14\u8be5 span \u548c\u524d\u7aef frontend \u670d\u52a1\u7684 span \u5173\u8054\u8d77\u6765\u4e86\u3002</p> <p></p> <p>\u5f53\u7136\u8fd9\u8fd8\u4e0d\u591f\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u8ba2\u5355\u5217\u8868\u63a5\u53e3\u8fd8\u4f1a\u53bb\u8bf7\u6c42 user-service \u670d\u52a1\u6765\u83b7\u53d6\u7528\u6237\u4fe1\u606f\uff0c\u8fd8\u4f1a\u53bb\u8bf7\u6c42 catalog-service \u670d\u52a1\u83b7\u53d6\u4e66\u7c4d\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u5728\u8fd9\u4e24\u4e2a\u8bf7\u6c42\u4e2d\u4e5f\u6ce8\u5165\u6211\u4eec\u8fd9\u91cc\u7684 span\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5c06\u6574\u4e2a\u94fe\u8def\u4e32\u8054\u8d77\u6765\u4e86\u3002</p> <p>\u9996\u5148\u9488\u5bf9 TokenInterceptor \u62e6\u622a\u5668\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2a\u5b50 span\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// src/main/java/com/youdianzhishi/orderservice/interceptor/TokenInterceptor.java\npackage com.youdianzhishi.orderservice.interceptor;\n\n// ......\n\n@Component\npublic class TokenInterceptor implements HandlerInterceptor {\n\n    @Autowired\n    private WebClient webClient;\n\n    @Autowired\n    private Tracer tracer;\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {\n        // \u5148\u83b7\u53d6 Span\n        Span currentSpan = (Span) request.getAttribute(\"currentSpan\");\n        Context context = Context.current().with(currentSpan);\n\n        // \u521b\u5efa\u65b0\u7684 Span\uff0c\u4f5c\u4e3a\u5b50 Span\n        Span span = tracer.spanBuilder(\"GET /api/userinfo\")\n            .setParent(context).startSpan();\n\n        // \u5c06\u5b50 Span \u8bbe\u7f6e\u4e3a\u5f53\u524d\u4e0a\u4e0b\u6587\uff0c\u76f8\u5f53\u4e8e\u5207\u6362\u4e0a\u4e0b\u6587\u5230\u5b50 Span\n        try (Scope scope = span.makeCurrent()) {\n\n            try {\n                String token = request.getHeader(\"Authorization\");\n                if (token == null) {\n                    response.setStatus(HttpStatus.UNAUTHORIZED.value());\n                    span.addEvent(\"Token is null\").setStatus(StatusCode.ERROR);\n                    return false;\n                }\n                // \u4ece\u73af\u5883\u53d8\u91cf\u4e2d\u83b7\u53d6 userServiceUrl\n                String userServiceEnv = System.getenv(\"USER_SERVICE_URL\");\n                String userServiceUrl = userServiceEnv != null ? userServiceEnv : \"http://localhost:8080\";\n                User user = webClient.get()\n                        .uri(userServiceUrl + \"/api/userinfo\")\n                        .header(HttpHeaders.AUTHORIZATION, token)\n                        .retrieve()\n                        .onStatus(httpStatus -&gt; httpStatus.equals(HttpStatus.UNAUTHORIZED),\n                                clientResponse -&gt; Mono.error(new RuntimeException(\"Unauthorized\")))\n                        .onStatus(\n                                httpStatus -&gt; httpStatus.is4xxClientError()\n                                        &amp;&amp; !httpStatus.equals(HttpStatus.UNAUTHORIZED),\n                                clientResponse -&gt; Mono.error(new RuntimeException(\"Other Client Error\")))\n                        .bodyToMono(User.class)\n                        .block();\n                if (user != null) {\n                    request.setAttribute(\"user\", user);\n                    span.setAttribute(\"user_id\", user.getId());\n                    return true;\n                } else {\n                    response.setStatus(HttpStatus.UNAUTHORIZED.value());\n                    span.addEvent(\"User is null\").setStatus(StatusCode.ERROR);\n                    return false;\n                }\n            } catch (RuntimeException e) {\n                span.recordException(e).setStatus(StatusCode.ERROR, e.getMessage());\n                if (e.getMessage().equals(\"Unauthorized\")) {\n                    response.setStatus(HttpStatus.UNAUTHORIZED.value());\n                } else {\n                    response.setStatus(HttpStatus.BAD_REQUEST.value());\n                }\n                return false;\n            } catch (Exception e) {\n                span.recordException(e).setStatus(StatusCode.ERROR, e.getMessage());\n                response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());\n                return false;\n            } finally {\n                request.setAttribute(\"parentSpan\", span);\n                span.end();\n            }\n        }\n\n    }\n}\n</code></pre> <p>\u5728\u4e0a\u9762\u4ee3\u7801\u4e2d\u6211\u4eec\u9996\u5148\u83b7\u53d6\u5f53\u524d\u4e0a\u4e0b\u6587\u7684 Span\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a GET /api/userinfo \u7684 span\uff0c\u5c06\u5176\u8bbe\u7f6e\u4e3a\u5f53\u524d\u4e0a\u4e0b\u6587\u7684\u5b50 span\uff0c\u5e76\u5c06\u4e0a\u4e0b\u6587\u5207\u6362\u5230\u5f53\u524d\u5b50 span\uff0c\u7136\u540e\u6267\u884c\u6211\u4eec\u7684\u4e1a\u52a1\u903b\u8f91\uff0c\u6700\u540e\u7ed3\u675f\u5b50 span\u3002</p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u7edf\u4e00\u5728 WebClient \u4e2d\u6765\u6ce8\u5165 span context\uff0c\u8fd9\u6837\u5f53\u6211\u4eec Java \u670d\u52a1\u8bf7\u6c42\u5176\u4ed6\u670d\u52a1\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u5f62\u6210\u94fe\u8def\u3002</p> <pre><code>// src/main/java/com/youdianzhishi/orderservice/config/WebClientConfig.java\npackage com.youdianzhishi.orderservice.config;\n\n// ......\n\n@Configuration\n@Order(3)\npublic class WebClientConfig {\n    @Autowired\n    private OpenTelemetry openTelemetry;\n\n    @Bean\n    public WebClient webClient() {\n        return WebClient.builder().filter(traceExchangeFilterFunction()).build();\n    }\n\n    @Bean\n    public ExchangeFilterFunction traceExchangeFilterFunction() {\n        return (clientRequest, next) -&gt; {\n            // \u83b7\u53d6\u5f53\u524d\u4e0a\u4e0b\u6587\u7684 Span\n            Span currentSpan = Span.current();\n            Context context = Context.current().with(currentSpan);\n\n            // \u521b\u5efa\u65b0\u7684\u8bf7\u6c42\u5934\u5e76\u6dfb\u52a0\u8ddf\u8e2a\u4fe1\u606f\n            HttpHeaders newHeaders = new HttpHeaders();\n            newHeaders.putAll(clientRequest.headers());\n\n            TextMapSetter&lt;HttpHeaders&gt; setter = new TextMapSetter&lt;HttpHeaders&gt;() {\n                @Override\n                public void set(HttpHeaders carrier, String key, String value) {\n                    carrier.add(key, value);\n                }\n            };\n\n            // \u5c06\u5f53\u524d\u4e0a\u4e0b\u6587\u7684 Span \u6ce8\u5165\u5230\u8bf7\u6c42\u5934\u4e2d\n            openTelemetry.getPropagators().getTextMapPropagator().inject(context, newHeaders, setter);\n\n            // \u521b\u5efa\u4e00\u4e2a\u65b0\u7684 ClientRequest \u5bf9\u8c61\n            ClientRequest newRequest = ClientRequest.from(clientRequest)\n                    .headers(headers -&gt; headers.addAll(newHeaders))\n                    .build();\n\n            return next.exchange(newRequest);\n        };\n    }\n}\n</code></pre> <p>\u5728\u4e0a\u9762\u4ee3\u7801\u4e2d\u6211\u4eec\u4e3a WebClient \u6dfb\u52a0\u4e86\u4e00\u4e2a\u540d\u4e3a <code>traceExchangeFilterFunction</code> \u7684\u8fc7\u6ee4\u5668\u51fd\u6570\uff0c\u5728\u8be5\u51fd\u6570\u4e2d\u6211\u4eec\u9996\u5148\u83b7\u53d6\u5f53\u524d\u4e0a\u4e0b\u6587\u7684 Span\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8bf7\u6c42\u5934\u5e76\u6dfb\u52a0\u8ddf\u8e2a\u4fe1\u606f\uff0c\u6700\u540e\u5c06\u5f53\u524d\u4e0a\u4e0b\u6587\u7684 Span \u901a\u8fc7 <code>Propagator</code> \u63a5\u53e3\u6ce8\u5165\u5230\u8bf7\u6c42\u5934\u4e2d\uff0c\u8fd9\u6837\u5f53\u6211\u4eec\u8bf7\u6c42\u5176\u4ed6\u670d\u52a1\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u5f62\u6210\u94fe\u8def\u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\uff0c\u5f53\u6211\u4eec\u8bbf\u95ee\u8ba2\u5355\u5217\u8868\u540e\u5c31\u53ef\u4ee5\u770b\u5230 Jaeger UI \u4e2d\u591a\u4e86\u4e00\u4e2a <code>GET /api/userinfo</code> \u7684 span \u4e86\uff0c\u5e76\u4e14\u8be5 span \u548c\u8fd8\u4f1a\u548c user-service \u670d\u52a1\u7684 span \u5173\u8054\u8d77\u6765\u3002</p> <p></p> <p>\u540c\u6837\u7684\u65b9\u5f0f\u6211\u4eec\u8fd8\u53ef\u4ee5\u5728 <code>getAllOrders</code> \u5904\u7406\u5668\u4e2d\u6dfb\u52a0\u6570\u636e\u5e93\u67e5\u8be2\u7684 span\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// \u65b0\u5efa\u4e00\u4e2a DB \u67e5\u8be2\u7684 span\nSpan dbSpan = tracer.spanBuilder(\"DB findByUserIdOrderByOrderDateDesc\").setParent(context).startSpan();\n// \u8981\u6839\u636e orderDate \u5012\u5e8f\u6392\u5217\nList&lt;Order&gt; orders = orderRepository.findByUserIdOrderByOrderDateDesc(user.getId());\ndbSpan.addEvent(\"OrderRepository findByUserIdOrderByOrderDateDesc From DB\");\ndbSpan.setAttribute(\"order_count\", orders.size());\ndbSpan.end();\n</code></pre> <p>\u5c06 Order \u8f6c\u6362\u4e3a OrderDto \u4e5f\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a span\uff0c\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// src/main/java/com/youdianzhishi/orderservice/model/Order.java\npackage com.youdianzhishi.orderservice.model;\n\n// ......\n\npublic OrderDto toOrderDto(WebClient webClient, Tracer tracer, Context context) throws Exception {\n    // \u521b\u5efa\u65b0\u7684 Span\uff0c\u4f5c\u4e3a\u5b50 Span\n    Span span = tracer.spanBuilder(\"GET /api/books/batch\").setParent(context).startSpan();\n\n    try (Scope scope = span.makeCurrent()) { // \u5207\u6362\u4e0a\u4e0b\u6587\u5230\u5b50 Span\n\n        span.setAttribute(\"order_id\", this.getId());\n        span.setAttribute(\"status\", this.getStatus());\n\n        OrderDto orderDto = new OrderDto();\n        orderDto.setId(this.getId());\n        orderDto.setStatus(this.getStatus());\n        SimpleDateFormat formatter = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\");\n        String strDate = formatter.format(this.getOrderDate());\n        orderDto.setOrderDate(strDate);\n\n        List&lt;Integer&gt; bookIds = this.getBookIds(); // \u5047\u8bbe\u4f60\u6709\u4e00\u4e2a\u53ef\u4ee5\u83b7\u53d6\u4e66\u7c4dID\u7684\u65b9\u6cd5\n        // \u5c06 bookIds \u8f6c\u6362\u4e3a\u5b57\u7b26\u4e32\uff0c\u4ee5\u4fbf\u4e8e\u4f20\u9012\u7ed9 WebClient\n        String bookIdsStr = bookIds.stream().map(String::valueOf).collect(Collectors.joining(\",\"));\n        span.addEvent(\"get book ids\");\n        span.setAttribute(\"book_ids\", bookIdsStr);\n\n        // \u7528 WebClient \u8c03\u7528\u6279\u91cf\u67e5\u8be2\u4e66\u7c4d\u7684\u670d\u52a1\u63a5\u53e3\n        // \u4ece\u73af\u5883\u53d8\u91cf\u4e2d\u83b7\u53d6 bookServiceUrl\n        String catalogServiceEnv = System.getenv(\"CATALOG_SERVICE_URL\");\n        String catalogServiceUrl = catalogServiceEnv != null ? catalogServiceEnv : \"http://localhost:8082\";\n        Mono&lt;List&lt;BookDto&gt;&gt; booksMono = webClient.get() // \u5047\u8bbe\u4f60\u6709\u4e00\u4e2awebClient\u5b9e\u4f8b\n                .uri(catalogServiceUrl + \"/api/books/batch?ids=\" + bookIdsStr)\n                .retrieve()\n                .bodyToMono(new ParameterizedTypeReference&lt;&gt;() {\n                });\n        List&lt;BookDto&gt; books = booksMono.block();\n\n        span.addEvent(\"get books info from catalog service\");\n\n        // \u8fd8\u9700\u8981\u5c06\u4e66\u7c4d\u6570\u91cf\u548c\u603b\u4ef7\u586b\u5145\u5230 OrderDto \u5bf9\u8c61\u4e2d\n        int totalAmount = 0;\n        int totalCount = 0;\n        List&lt;BookQuantity&gt; bqs = this.getBookQuantities();\n        for (BookDto book : books) {\n            // \u5982\u679c book.id \u5728 bqs \u4e2d\uff0c\u90a3\u4e48\u5c31\u5c06\u5bf9\u5e94\u7684\u6570\u91cf\u8bbe\u7f6e\u5230 book.quantity \u4e2d\n            int quantity = bqs.stream().filter(bq -&gt; bq.getId() == book.getId()).findFirst().get().getQuantity();\n            book.setQuantity(quantity);\n            totalCount += quantity;\n            totalAmount += book.getPrice() * quantity;\n        }\n\n        orderDto.setBooks(books);\n        orderDto.setAmount(totalAmount);\n        orderDto.setTotal(totalCount);\n\n        span.addEvent(\"calculate total amount and total count\");\n\n        span.end();\n\n        return orderDto;\n    }\n}\n</code></pre> <p>\u8fd9\u91cc\u540c\u6837\u6211\u4eec\u4f1a\u4e3a\u6bcf\u4e00\u4e2a\u8f6c\u6362\u521b\u5efa\u4e00\u4e2a\u5b50 span\uff0c\u7136\u540e\u5c06\u5176\u8bbe\u7f6e\u4e3a\u5f53\u524d\u4e0a\u4e0b\u6587\u7684\u5b50 span\uff0c\u6700\u540e\u7ed3\u675f\u5b50 span\uff0c\u8fd9\u6837\u5f53\u6211\u4eec\u901a\u8fc7 WebClient \u53bb\u8bf7\u6c42 <code>catalog-service</code> \u670d\u52a1\u7684\u65f6\u5019\u4e5f\u5c31\u53ef\u4ee5\u5f62\u6210\u94fe\u8def\u4e86\u3002</p> <p>\u6700\u540e\u6211\u4eec\u518d\u53bb\u67e5\u770b\u4e0b\u5b8c\u6574\u7684\u94fe\u8def\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5b8c\u6574\u4ee3\u7801\u8bf7\u67e5\u770b\uff1ahttps://github.com/cnych/podemo\u3002</p>"},{"location":"chap_ot/7OT_practice/","title":"9 Opentelemetry \u91c7\u6837\u6700\u4f73\u5b9e\u8df5(\u6982\u7387\u91c7\u6837\u5668/\u5c3e\u90e8\u91c7\u6837\u5668)","text":"<p>\u5168\u94fe\u8def\u6570\u636e\u786e\u5b9e\u80fd\u591f\u5f88\u597d\u7684\u5e2e\u52a9\u76f8\u5173\u4eba\u5458\u53ca\u65f6\u3001\u51c6\u786e\u7684\u53d1\u73b0\u4e1a\u52a1\u95ee\u9898\u3002\u4f46\u4f01\u4e1a\u4e1a\u52a1\u53d1\u751f\u95ee\u9898\u7684\u6982\u7387\u4e00\u822c\u90fd\u5f88\u4f4e\uff0c\u5168\u94fe\u8def\u91c7\u6837\u6709\u7740\u81ea\u8eab\u7684\u4f18\u7f3a\u70b9\u3002</p> <ul> <li>\u4f18\u70b9\uff1a\u94fe\u8def\u6570\u636e\u5065\u5168</li> <li>\u7f3a\u70b9\uff1a\u8d44\u6e90\u6d6a\u8d39\uff0c\u7531\u4e8e\u6570\u636e\u5065\u5168\u5bfc\u81f4\u6570\u636e\u5b58\u50a8\u8d44\u6e90\u6210\u672c\u5927\u5927\u63d0\u9ad8\uff0c\u5bf9\u4e8e\u5f02\u5e38\u94fe\u8def\u6570\u636e\u68c0\u7d22\u6210\u672c\u63d0\u9ad8</li> </ul> <p>\u57fa\u4e8e\u5168\u94fe\u8def\u6570\u636e\u91c7\u96c6\u7684\u91c7\u6837\uff0cOpenTelemetry \u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u91c7\u6837\u5668</p> <ul> <li>\u6982\u7387\u91c7\u6837\u5668\uff08probabilistic sampler processor\uff09</li> <li>\u5c3e\u90e8\u91c7\u6837\u5668\uff08tail sampling processor\uff09</li> </ul>"},{"location":"chap_ot/7OT_practice/#_1","title":"\u6982\u7387\u91c7\u6837\u5904\u7406\u5668","text":"<p>\u987e\u540d\u601d\u4e49\uff0c\u6982\u7387\u91c7\u6837\u5668\uff0c\u662f\u6309\u7167\u67d0\u79cd\u6982\u7387\u8fdb\u884c\u91c7\u6837\u3002\u540c\u6837 OpenTelemetry \u652f\u6301\u4e24\u79cd\u6982\u7387\u91c7\u6837</p> <ul> <li><code>sampling.priority OpenTracing</code> \u5b9a\u4e49\u7684\u8bed\u4e49\u7ea6\u5b9a</li> <li><code>TraceId hash</code></li> </ul> <p><code>sampling.priority</code> \u8bed\u4e49\u7ea6\u5b9a\u4f18\u5148\u4e8e <code>TraceId hash</code>\u3002</p> <p>\u987e\u540d\u601d\u4e49\uff0c<code>TraceId hash</code> \u91c7\u6837\u57fa\u4e8e\u7531<code>TraceId</code> \u786e\u5b9a\u7684<code>hash</code> \u503c\u3002</p> <p>\u4e3a\u4e86\u4f7f TraceId hash \u8d77\u4f5c\u7528\uff0c\u7ed9\u5b9a\u5c42\u7684\u6240\u6709\u6536\u96c6\u5668\uff08\u4f8b\u5982\uff0c\u5728\u540c\u4e00\u8d1f\u8f7d\u5747\u8861\u5668\u540e\u9762\uff09\u5fc5\u987b\u5177\u6709\u76f8\u540c\u7684 hash_seed\u3002\u4e5f\u53ef\u4ee5\u5229\u7528<code>hash_seed</code>\u4e0d\u540c\u6536\u96c6\u5668\u5c42\u7684\u4e0d\u540c\u6765\u652f\u6301\u989d\u5916\u7684\u91c7\u6837\u8981\u6c42\uff0c\u6709\u5173\u914d\u7f6e\u89c4\u8303\uff0c\u8bf7\u53c2\u9605 <code>config.go</code>\u3002</p> <p>\u53ef\u4ee5\u4fee\u6539\u4ee5\u4e0b\u914d\u7f6e\u9009\u9879\uff1a</p> <p><code>hash_seed</code>\uff08\u65e0\u9ed8\u8ba4\u503c\uff09\uff1a\u7528\u4e8e\u8ba1\u7b97\u54c8\u5e0c\u7b97\u6cd5\u7684\u6574\u6570\u3002\u8bf7\u6ce8\u610f\uff0c\u7ed9\u5b9a\u5c42\u7684\u6240\u6709\u6536\u96c6\u5668\uff08\u4f8b\u5982\uff0c\u5728\u540c\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u540e\u9762\uff09\u5e94\u8be5\u5177\u6709\u76f8\u540c\u7684 <code>hash_seed</code>\u3002</p> <p>\u5728\u4f7f\u7528\u591a\u5c42\u91c7\u96c6\u5668\u5b9e\u73b0\u6240\u9700\u91c7\u6837\u7387\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e00\u70b9\u5f88\u91cd\u8981\uff0c\u4f8b\u5982\uff1a\u7b2c\u4e00\u5c42\u4e3a10%\uff0c\u7b2c\u4e8c\u5c42\u4e3a10%\uff0c\u603b\u4f53\u91c7\u6837\u7387\u4e3a1%\uff0810%x 10%\uff09\u3002</p> <p>\u5982\u679c\u6240\u6709\u5c42\u4f7f\u7528\u76f8\u540c\u7684\u79cd\u5b50\uff0c\u5219\u901a\u8fc7\u4e00\u5c42\u7684\u6240\u6709\u6570\u636e\u4e5f\u5c06\u901a\u8fc7\u4e0b\u4e00\u5c42\uff0c\u4e0e\u914d\u7f6e\u7684\u91c7\u6837\u7387\u65e0\u5173\u3002\u5728\u4e0d\u540c\u7684\u5c42\u4e2d\u6709\u4e0d\u540c\u7684\u79cd\u5b50\u53ef\u4ee5\u786e\u4fdd\u6bcf\u5c42\u4e2d\u7684\u91c7\u6837\u7387\u6309\u9884\u671f\u5de5\u4f5c\u3002</p> <p><code>sampling_percentage</code>\uff08\u9ed8\u8ba4\u503c = 0\uff09\uff1a\u5bf9 trace \u8fdb\u884c\u91c7\u6837\u7684\u767e\u5206\u6bd4\uff1b<code>&gt;= 100</code> \u8868\u793a\u91c7\u96c6\u6240\u6709\u7684 trace\u3002</p> <p>\u914d\u7f6e\u6982\u7387\u91c7\u6837\u5668</p> <pre><code>processors:\n  # \u6982\u7387\u91c7\u6837\u5668\n  probabilistic_sampler:\n    hash_seed: 22\n    sampling_percentage: 15.3\n</code></pre> <p>\u542f\u7528\u6982\u7387\u91c7\u6837\u5668</p> <pre><code>service:\n  extensions: [pprof, zpages, health_check]\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch,probabilistic_sampler]\n      exporters: [otlp]\n    metrics:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [otlp]\n</code></pre>"},{"location":"chap_ot/7OT_practice/#_2","title":"\u5c3e\u90e8\u91c7\u6837\u5668","text":"<p>\u5c3e\u90e8\u91c7\u6837\u5904\u7406\u5668\u6839\u636e\u4e00\u7ec4\u5b9a\u4e49\u7684\u7b56\u7565\u5bf9 trace \u8fdb\u884c\u91c7\u6837\u3002\u76ee\u524d\uff0c\u8be5\u5904\u7406\u5668\u4ec5\u9002\u7528\u4e8e collector \u7684\u5355\u4e2a\u5b9e\u4f8b\u3002\u4ece\u6280\u672f\u4e0a\u8bb2\uff0ctraceId \u611f\u77e5\u8d1f\u8f7d\u5e73\u8861\u53ef\u7528\u4e8e\u652f\u6301\u591a\u4e2a collector \u5b9e\u4f8b\uff0c\u4f46\u6b64\u914d\u7f6e\u5c1a\u672a\u7ecf\u8fc7\u6d4b\u8bd5\u3002\u6709\u5173\u914d\u7f6e\u89c4\u8303\uff0c\u8bf7\u53c2\u9605 config.go\u3002</p> <p>\u9700\u8981\u4ee5\u4e0b\u914d\u7f6e\u9009\u9879\uff1a</p> <ul> <li>policies\uff08\u65e0\u9ed8\u8ba4\u503c\uff09\uff1a\u7528\u4e8e\u505a\u51fa\u62bd\u6837\u51b3\u7b56\u7684\u7b56\u7565</li> </ul> <p>\u76ee\u524d\u652f\u6301\u591a\u79cd\u7b56\u7565\u3002\u8fd9\u4e9b\u5305\u62ec\uff1a</p> <ul> <li><code>always_sample</code>\uff1a\u91c7\u6837\u6240\u6709\u7684 traces</li> <li>latency\uff1a\u57fa\u4e8e trace \u6301\u7eed\u65f6\u95f4\u7684\u91c7\u6837\u3002\u6301\u7eed\u65f6\u95f4\u662f\u901a\u8fc7\u67e5\u770b\u6700\u65e9\u7684\u5f00\u59cb\u65f6\u95f4\u548c\u6700\u665a\u7684\u7ed3\u675f\u65f6\u95f4\u6765\u786e\u5b9a\u7684\uff0c\u800c\u4e0d\u8003\u8651\u4e24\u8005\u4e4b\u95f4\u53d1\u751f\u7684\u4e8b\u60c5\u3002</li> <li><code>numeric_attribute</code>: \u57fa\u4e8e\u6570\u5b57\u5c5e\u6027\u7684\u91c7\u6837</li> <li>probabilistic\uff1a\u91c7\u6837\u4e00\u5b9a\u767e\u5206\u6bd4\u7684 trace \u3002</li> <li><code>status_code</code>: \u57fa\u4e8e\u72b6\u6001\u7801\u7684\u793a\u4f8b ( OK,ERROR\u6216UNSET)\u3002\u5f88\u591a\u4eba\u5f53\u505a\u662fresponse body json\u7684 code\uff08\u73b0\u5728\u5f88\u591a\u9879\u76ee\u90fd\u8fd9\u4e48\u5b9a\u4e49\uff09\uff0c\u5176\u5b9e\u662f\u4e0d\u5bf9\u7684\u3002</li> <li><code>string_attribute</code>\uff1a\u57fa\u4e8e\u5b57\u7b26\u4e32\u5c5e\u6027\u503c\u5339\u914d\u7684\u91c7\u6837\uff0c\u652f\u6301\u7cbe\u786e\u5339\u914d\u548c\u6b63\u5219\u8868\u8fbe\u5f0f\u503c\u5339\u914d</li> <li><code>rate_limiting</code>: \u57fa\u4e8e\u901f\u7387\u7684\u91c7\u6837</li> <li>and\uff1a\u57fa\u4e8e\u591a\u4e2a\u7b56\u7565\u7684\u91c7\u6837\uff0c\u521b\u5efa\u4e00\u4e2a AND \u7b56\u7565</li> <li>composite\uff1a\u57fa\u4e8e\u4e0a\u8ff0\u91c7\u6837\u5668\u7ec4\u5408\u7684\u91c7\u6837\uff0c\u6bcf\u4e2a\u91c7\u6837\u5668\u5177\u6709\u6392\u5e8f\u548c\u901f\u7387\u5206\u914d\u3002\u8d39\u7387\u5206\u914d\u4e3a\u6bcf\u4e2a\u4fdd\u5355\u8ba2\u5355\u5206\u914d\u4e00\u5b9a\u767e\u5206\u6bd4\u7684\u8de8\u5ea6\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u5c06 <code>max_total_spans_per_second</code> \u8bbe\u7f6e\u4e3a 100\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5c06 <code>rate_allocation</code> \u8bbe\u7f6e\u5982\u4e0b:<ul> <li><code>test-composite-policy-1 = max_total_spans_per_second</code> \u7684 50 % = 50 <code>spans_per_second</code></li> <li><code>test-composite-policy-2 = max_total_spans_per_second</code> \u7684 25 % = 25 <code>spans_per_second</code></li> <li>\u4e3a\u786e\u4fdd\u5269\u4f59\u5bb9\u91cf\u88ab\u586b\u6ee1\uff0c\u8bf7\u4f7f\u7528 <code>always_sample</code> \u4f5c\u4e3a\u7b56\u7565\u4e4b\u4e00</li> </ul> </li> </ul> <p>\u8fd8\u53ef\u4ee5\u4fee\u6539\u4ee5\u4e0b\u914d\u7f6e\u9009\u9879\uff1a</p> <ul> <li><code>decision_wait</code>\uff08\u9ed8\u8ba4 = 30 \u79d2\uff09\uff1a\u5728\u505a\u51fa\u91c7\u6837\u51b3\u5b9a\u4e4b\u524d\uff0c\u4ece trace \u7684\u7b2c\u4e00\u4e2a\u8de8\u5ea6\u5f00\u59cb\u7684\u7b49\u5f85\u65f6\u95f4</li> <li><code>num_traces</code>\uff08\u9ed8\u8ba4\u503c = 50000\uff09\uff1a\u5185\u5b58\u4e2d\u4fdd\u5b58\u7684 trace \u6570</li> <li><code>expected_new_traces_per_sec</code>\uff08\u9ed8\u8ba4 = 0\uff09\uff1a\u9884\u671f\u7684\u65b0 trace \u6570\uff08\u6709\u52a9\u4e8e\u5206\u914d\u6570\u636e\u7ed3\u6784\uff09</li> </ul> <p>\u4f8b\u5b50\uff1a</p> <pre><code>processors:\n  tail_sampling:\n    decision_wait: 10s\n    num_traces: 100\n    expected_new_traces_per_sec: 10\n    policies:      [\n          {\n            name: test-policy-1,\n            type: always_sample\n          },\n          {\n            name: test-policy-2,\n            type: latency,\n            latency: {threshold_ms: 5000}\n          },\n          {\n            name: test-policy-3,\n            type: numeric_attribute,\n            numeric_attribute: {key: key1, min_value: 50, max_value: 100}\n          },\n          {\n            name: test-policy-4,\n            type: probabilistic,\n            probabilistic: {sampling_percentage: 10}\n          },\n          {\n            name: test-policy-5,\n            type: status_code,\n            status_code: {status_codes: [ERROR, UNSET]}\n          },\n          {\n            name: test-policy-6,\n            type: string_attribute,\n            string_attribute: {key: key2, values: [value1, value2]}\n          },\n          {\n            name: test-policy-7,\n            type: string_attribute,\n            string_attribute: {key: key2, values: [value1, val*], enabled_regex_matching: true, cache_max_size: 10}\n          },\n          {\n            name: test-policy-8,\n            type: rate_limiting,\n            rate_limiting: {spans_per_second: 35}\n         },\n         {\n            name: test-policy-9,\n            type: string_attribute,\n            string_attribute: {key: http.url, values: [\\/health, \\/metrics], enabled_regex_matching: true, invert_match: true}\n         },\n         {\n            name: and-policy-1,\n            type: and,\n            and: {\n              and_sub_policy:               [\n                {\n                  name: test-and-policy-1,\n                  type: numeric_attribute,\n                  numeric_attribute: { key: key1, min_value: 50, max_value: 100 }\n                },\n                {\n                    name: test-and-policy-2,\n                    type: string_attribute,\n                    string_attribute: { key: key2, values: [ value1, value2 ] }\n                },\n              ]\n            }\n         },\n         {\n            name: composite-policy-1,\n            type: composite,\n            composite:              {\n                max_total_spans_per_second: 1000,\n                policy_order: [test-composite-policy-1, test-composite-policy-2, test-composite-policy-3],\n                composite_sub_policy:                  [\n                    {\n                      name: test-composite-policy-1,\n                      type: numeric_attribute,\n                      numeric_attribute: {key: key1, min_value: 50, max_value: 100}\n                    },\n                    {\n                      name: test-composite-policy-2,\n                      type: string_attribute,\n                      string_attribute: {key: key2, values: [value1, value2]}\n                    },\n                    {\n                      name: test-composite-policy-3,\n                      type: always_sample\n                    }\n                  ],\n                rate_allocation:                  [\n                    {\n                      policy: test-composite-policy-1,\n                      percent: 50\n                    },\n                    {\n                      policy: test-composite-policy-2,\n                      percent: 25\n                    }\n                  ]\n              }\n          },\n        ]\n</code></pre> <p>\u6709\u5173\u4f7f\u7528\u5904\u7406\u5668\u7684\u8be6\u7ec6\u793a\u4f8b\uff0c\u8bf7\u53c2\u9605 <code>tail_sampling_config.yaml</code>\u3002</p>"},{"location":"chap_ot/7OT_practice/#demo","title":"\u6f14\u793a demo","text":"<p>\u672c demo \u4e3b\u8981\u662f\u5c06 OpenTelemetry \u6570\u636e\u63a8\u9001\u81f3\u89c2\u6d4b\u4e91\u3002</p> <ul> <li> <p>\u4e0b\u8f7d\u6e90\u7801\uff1ahttps://github.com/lrwh/observable-demo/tree/main/opentelemetry-collector-sampling</p> </li> <li> <p>\u786e\u4fdd\u5df2\u7ecf\u5b89\u88c5\u4e86 DataKit</p> </li> <li> <p><code>otel-collector</code>   :  otel/opentelemetry-collector-contrib:0.51.0</p> </li> <li><code>springboot_server</code>  : <code>8080:8080</code> :  <code>opentelemetry-agent</code> \u7248\u672c 1.13.1\uff0c \u6e90\u7801\u5730\u5740\uff1ahttps://github.com/lrwh/observable-demo/tree/main/springboot-server</li> </ul> <p>Datakit \u5f00\u542f OpenTelemetry \u91c7\u96c6\uff0c\u53c2\u7167\u6700\u4f73\u5b9e\u8df5OpenTelemetry \u94fe\u8def\u6570\u636e\u63a5\u5165\u6700\u4f73\u5b9e\u8df5 \u3002</p> <p>\u7136\u540e\u542f\u52a8\u670d\u52a1\uff1a</p> <pre><code>docker-compose up -d\n</code></pre> <p>\u4ee5\u4e0b\u793a\u4f8b\u4e3b\u8981\u4ee5\u5c3e\u90e8\u91c7\u6837\u7b56\u7565\u4e3a\u6d4b\u8bd5\u573a\u666f\u3002</p> <p>\u914d\u7f6e\u5c3e\u90e8\u91c7\u6837\u5668</p> <pre><code>processors:\n  # \u5c3e\u90e8\u91c7\u6837\u5668\n  tail_sampling:\n    decision_wait: 10s\n    num_traces: 100\n    expected_new_traces_per_sec: 100\n    policies:\n      [\n        {\n          name: policy-1,\n          type: status_code,\n          status_code: {status_codes: [ERROR]}\n        },\n        {\n          name: policy-2,\n          type: probabilistic,\n          probabilistic: {sampling_percentage: 20}\n        }\n      ]\n</code></pre> <p>\u4ee5\u4e0a\u89c4\u5219\u662f\u6216\u7684\u5173\u7cfb\uff0c\u8868\u793a policy-1 \u548c policy-2 \u4efb\u610f\u4e00\u4e2a\u6210\u7acb\u5219\u8fdb\u884c\u91c7\u6837\u3002</p> <p>\u542f\u7528\u5c3e\u90e8\u91c7\u6837\u5668</p> <p>\u573a\u666f\u4e00</p> <p>\u8bbf\u95ee\u670d\u52a1API gateway 5 \u6b21\uff0c\u6bcf\u6b21\u5747\u4e3a\u6b63\u5e38\u8fd4\u56de</p> <pre><code>curl http://localhost:8080/gateway\n</code></pre> <p>\u524d\u5f80\u89c2\u6d4b\u4e91\u67e5\u770b trace \u4fe1\u606f\uff0c\u6309\u7167\u91c7\u6837\u89c4\u5219\uff0c\u6700\u591a\u91c7\u6837\u4e00\u6b21 trace \u6570\u636e\u3002</p>"},{"location":"chap_ot/7OT_practice/#_3","title":"\u573a\u666f\u4e8c","text":"<p>1.\u8bbe\u7f6e\u542f\u52a8\u5ba2\u6237\u7aef</p> <pre><code>curl http://localhost:8080/setClient?c=true\n</code></pre> <p>\u5f53\u524d\u6f14\u793ademo\u5e76\u6ca1\u6709\u542f\u52a8\u5ba2\u6237\u7aef\u670d\u52a1\uff0c\u6240\u4ee5\u540e\u7eed\u8c03\u7528 gateway \u63a5\u53e3\u4f1a\u6709\u5f02\u5e38\u4ea7\u751f\u3002</p> <p>2.\u8bbf\u95ee 5 \u6b21 gateway \u670d\u52a1,\u8fd4\u56de <code>{\"msg\":\"client \u8c03\u7528\u5931\u8d25\",\"code\":500}</code></p> <p>3.\u524d\u5f80\u89c2\u6d4b\u4e91\u67e5\u770b trace \u4fe1\u606f\uff0c\u6309\u7167\u91c7\u6837\u89c4\u5219\uff0c\u5982\u679c\u53d1\u751f\u5f02\u5e38\uff0c\u5219\u5f02\u5e38\u5168\u91c7\u3002</p> <p>\u6982\u7387\u91c7\u6837\u5904\u7406\u5668\u4e0e\u91c7\u7528\u6982\u7387\u7b56\u7565\u7684\u5c3e\u90e8\u91c7\u6837\u5904\u7406\u5668\u76f8\u6bd4</p> <p>\u6982\u7387\u91c7\u6837\u5904\u7406\u5668\u548c\u6982\u7387\u5c3e\u91c7\u6837\u5904\u7406\u5668\u7b56\u7565\u7684\u5de5\u4f5c\u65b9\u5f0f\u975e\u5e38\u76f8\u4f3c\uff1a\u57fa\u4e8e\u53ef\u914d\u7f6e\u7684\u91c7\u6837\u767e\u5206\u6bd4\uff0c\u5b83\u4eec\u5c06\u5bf9\u63a5\u6536\u5230\u7684 trace \u8fdb\u884c\u56fa\u5b9a\u6bd4\u7387\u7684\u91c7\u6837\u3002\u4f46\u6839\u636e\u6574\u4f53\u5904\u7406\u7ba1\u9053\uff0c\u60a8\u5e94\u8be5\u66f4\u559c\u6b22\u4f7f\u7528\u5176\u4e2d\u4e00\u4e2a\u3002</p> <p>\u5982\u679c\u4f60\u8fd8\u6ca1\u6709\u4f7f\u7528\u5c3e\u90e8\u91c7\u6837\u5904\u7406\u5668\uff1a\u4f7f\u7528\u6982\u7387\u91c7\u6837\u5904\u7406\u5668\u3002\u8fd0\u884c\u6982\u7387\u91c7\u6837\u5904\u7406\u5668\u6bd4\u5c3e\u90e8\u91c7\u6837\u5904\u7406\u5668\u66f4\u6709\u6548\u3002 \u6982\u7387\u62bd\u6837\u7b56\u7565\u6839\u636e traceId \u505a\u51fa\u51b3\u5b9a\uff0c\u56e0\u6b64\u7b49\u5f85\u66f4\u591a\u8de8\u5ea6\u5230\u8fbe\u4e0d\u4f1a\u5f71\u54cd\u5176\u51b3\u5b9a\u3002</p> <p>\u5982\u679c\u5df2\u7ecf\u5728\u4f7f\u7528\u5c3e\u90e8\u91c7\u6837\u5904\u7406\u5668\uff1a\u6dfb\u52a0\u6982\u7387\u91c7\u6837\u7b56\u7565\u3002\u60a8\u5df2\u7ecf\u627f\u62c5\u4e86\u8fd0\u884c\u5c3e\u90e8\u91c7\u6837\u5904\u7406\u5668\u7684\u6210\u672c\uff0c\u6dfb\u52a0\u6982\u7387\u7b56\u7565\u5c06\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1\u3002</p> <p>\u6b64\u5916\uff0c\u5728\u5c3e\u90e8\u91c7\u6837\u5904\u7406\u5668\u4e2d\u4f7f\u7528\u8be5\u7b56\u7565\u5c06\u786e\u4fdd\u4e0d\u4f1a\u4e22\u5f03\u7531\u5176\u4ed6\u7b56\u7565\u91c7\u6837\u7684 trace\u3002</p>"}]}

<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Prometheus 技术实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
        <link rel="prev" href="../8Adv_K8S_Grafana/">
      
      
        <link rel="next" href="../16Adv_Prometheus_Del_index/">
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>第九节 报警神器 AlertManager 的使用 - Jacob Prometheus Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#alertmanager" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Prometheus Book" class="md-header__button md-logo" aria-label="Jacob Prometheus Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Prometheus Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第九节 报警神器 AlertManager 的使用
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxprombook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxprombook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Prometheus Book" class="md-nav__button md-logo" aria-label="Jacob Prometheus Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Prometheus Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxprombook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxprombook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    监控解决方案
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            监控解决方案
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap0/1monitor_tools10/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 监控解决方案：10个 Kubernetes 监控工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/11Prom_intro_2023-CN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 云原生系统监控
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus技术介绍,K8S Metrics介绍&查看
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Prometheus技术介绍,K8S Metrics介绍&查看
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/57prometheus_best_practice/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第零节 Promethues 应用监控的一些实践
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1prometheus2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Prometheus 系统介绍 2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/18Adv_Prometheus_index_classfication/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 深入Prometheus设计-指标定义与分类(PromQL)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/k8s_adv39_kube_state_metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 kube-state-metrics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/17Adv_K8S_Metrics_Server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 Metrics Server 安装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/20Install_metrics_server_SAP_CC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 Install Kubernetes Metrics Server on SAP Converged Cloud
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/38k8s_hpa_metricsserver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 Kubernetes HPA 使用详解(Metrics Server/CPU/Mem/adapater)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/55prometheus_go_metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 为Go应用添加Prometheus监控指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/37kubectl_top/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 从kubectl top看K8S监控原理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/9kube-state-metrics_crd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第九节 通过 kube-state-metrics 添加 CRD 状态指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/10kube-state-metrics-cluster-opt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十节 kube-state-metrics 在大规模集群下的优化(2023)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus on Linux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Prometheus on Linux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/19centos7_Prometheus_Alertmanager_Grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Centos7 Prometheus安装部署+监控+绘图+告警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/59node_exporter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 使用Node Exporter监控Linux主机&常用监控指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/36Prometheus_Mysql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 基于Prometheus构建MySQL可视化监控平台
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/4mysql_exporter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 官方 mysqld_exporter支持抓取多MySQL实例
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/5prom_grafana_chatops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 使用 Grafana、Prometheus 和 Slack 构建一个简单的 ChatOps 机器人
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    手动部署Kubernetes Prometheus
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            手动部署Kubernetes Prometheus
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1prometheus_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Kubernetes使用Prometheus搭建监控平台(2018)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2prometheus_AlertManager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Prometheus报警 && AlertManager实战（2018）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3changes_on_Grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 Grafana 显示参数设置(2018)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4Adv_Prometheus_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 在 Kubernetes 中手动部署 Prometheus (adv)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5Adv_Prometheus_monitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 应用监控（Metrics/Exporter的配置）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6Adv_K8S_Nodes_monitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 监控K8S集群节点&Node-exporter DaemonSet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7Adv_K8S_Resource_monitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 监控常用资源对象（容器/apiserver/Service监控/kube-state-metric）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../8Adv_K8S_Grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 Grafana 在 Kubernetes 中的使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    第九节 报警神器 AlertManager 的使用
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    第九节 报警神器 AlertManager 的使用
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1 安装
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2 报警规则
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-webhook" class="md-nav__link">
    <span class="md-ellipsis">
      3 webhook接收器
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../16Adv_Prometheus_Del_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十节 Prometheus 删除数据指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../50PrometheusAlert/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十一节 Prometheus中使用PrometheusAlert进行聚合报警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12gpu_monitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十二节 监控Kubernetes集群的GPU资源
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../29AlertManager_SendAlerts_when/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十三节 AlertManager何时报警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../41Prometheus_Monitor_OutCluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十四节 Prometheus监控外部Kubernetes集群
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    玩转Prometheus Operator
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            玩转Prometheus Operator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/11Adv_Prometheus_Operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Prometheus Operator 初体验
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/13Adv_Prometheus_Operator_etcd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 使用 Prometheus Operator 监控 etcd
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/14Adv_Prometheus_Operator_alarm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 Prometheus Operator 自定义报警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/22Customize_Alert_Email/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 Add Custom Alert and Send Alert Email with Alertmanager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/24Kubernetes_Prometheus_blackbox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 Prometheus 黑盒监控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/32Prometheus_troubleshoot_Servicemonitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 Troubleshooting ServiceMonitor changes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/43Prometheus_operator_ssl_exporter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 使用ssl_exporter监控K8S集群证书
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/44Prometheus_KubeNurse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 Operator2021-使用KubeNurse进行集群网络监控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/45Prom-operator_2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第九节 Prometheus Operator安装配置(2021)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/46Prometheus_traefik/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十节 Traefik之使用Prometheus Operator进行监控报警2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/47Prometheus_opt_AlertmanagerConfig/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十一节 Operator使用AlertmanagerConfig进行报警配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/49Prometheus_SLI_SLO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十二节 通过Prometheus来做SLI/SLO监控展示
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/51missing-container-metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十三节 Prometheus使用missing-container-metrics监控Pod oomkill
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/chap4_blackbox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十四节 如何在Prometheus中进行黑盒监控(ICMP/DNS/TCP/HTTP/gRPC)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/chap4_Operator_probe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十五节 Prometheus Operator中探针的使用（Blackbox Exporter）
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus服务发现
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Prometheus服务发现
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/53Prometheus_auto_discovery/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Prometheus服务的自动发现使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/52Prometheus_Relabeling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Prometheus Relabeling重新标记的使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/54prometheus_go_metrics_guideline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 如何使用Prometheus仪表化应用
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Jam prometheus Monitor
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Jam prometheus Monitor
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/25Alertmanager_AWS_SES/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap1 Alertmanager alerts with Amazon SES SMTP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/26Prometheus_Monitor_Argocd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap2 Prometheus Operator Monitor on ArgoCD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/27Prometheus_Monitor_elasticsearch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap3 Prometheus Operator Monitor on ElasticSearch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/31Prometheus_Monitor_rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap4 Prometheus Operator Monitor on Rabbitmq
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/33Prometheus_Monitor_memcached/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap5 Prometheus Operator Monitor on Memcached
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus-Adapter
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Prometheus-Adapter
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/23Kubernetes_Scale_Prometheus-Adapter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    应用进行自定义指标扩缩容 by Prometheus-Adapter and Flask-Exporter
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    PromQL学习
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            PromQL学习
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/1Promql_basic1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 初识 PromQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/2Promql_basic2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 PromQL 操作符 & 内置函数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/3Promql_basic3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 PromQL 内置函数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/4Promql_basic4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 PromQL简单示例
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/5Promql_basic5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 在 HTTP API中使用 PromQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/6Promql_adv1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 Prometheus记录规则的使用(Recording Rule)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/56prometheus_promql_rate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 PromQL查询之rate函数的使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/60prometheus_job/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 解决Prometheus监控Kubernetes Job误报的坑
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/9promql_6errors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9 使用 Prometheus PromQL时需要避免这6个错误
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Awesome alerts rules
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Awesome alerts rules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/1basic_resource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 Basic resource monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/2database_broker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 Databases and brokers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/3proxy_lb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 Reverse proxies and load balancers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/4runtimes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 Runtimes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/5Orchestrators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 Orchestrators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/6network_sec_storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 Network, security and storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/7other/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 Others
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/8Alerting_sleep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 Alert Sleep Peacefully
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    数据可视化&Grafana Plugin
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            数据可视化&Grafana Plugin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/58grafana_init/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 使用 Grafana 构建你的第一个仪表盘
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/28Grafana_plugin_DevOpsProdigy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 优秀的Grafana K8S 插件-DevOpsProdigy KubeGraf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/30Create_Grafana_dashboards/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 用 Kubernetes darks资源对象创建Grafana Dashboard
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/48grafana_Trickster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 Grafana 图表加速神器-Trickster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/5Grafana_Loki/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 使用读写分离模式扩展 Grafana Loki
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/6Prometheus_grafaa_docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 使用 Prometheus 和 Grafana 实现服务器运行状态监控（基于 Docker）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/7loki_promtail_grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 Docker上部署LPG（loki+promtail+grafana）踩坑复盘
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus(OpenTelemetry)架构设计与工具平台
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Prometheus(OpenTelemetry)架构设计与工具平台
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/1deepflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 DeepFlow AutoTagging之Prometheus标签标准化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/2Prometheus_opentele/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 Prometheus与OpenTelemetry该选哪个？
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/3Prometheus_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 Prometheus的四种指标类型
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/4OpenTelemetry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 透彻理解OpenTelemetry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/4OpenTelemetry_tracing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 使用OpenTelemetry Tracing最大化Kubernetes效率
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Thanos
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Thanos
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/39Thanos_tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 大规模场景下Prometheus的优化手段&Thanos架构详解
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/34Thanos_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 使用Thanos实现Prometheus的高可用介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/35Thanos_install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 Prometheus高可用Thanos学习-sidercar和query&Thanos部署
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/61thanos_sidecar_receiver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节（2022）如何选择Thanos的Sidecar和Receiver两种模式？
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/62thanos_query/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节（2022）使用Thanos查询前端优化查询性能
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/63prometheus_optimiztion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 (Thaos1-2022)大规模场景下Prometheus的优化手段
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/64thanos_detail/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 (Thaos2-2022)Thanos架构详解
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/65thanos_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 (Thaos3-2022)Thanos部署与实践
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/66thanos_ruler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第九节（2022）Thanos Ruler组件的使用
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    VictoriaMetrics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            VictoriaMetrics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/67vm_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Prometheus远程存储VictoriaMetrics简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/68vm_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Prometheus长期远程存储方案VictoriaMetrics入门实践
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/69vm_cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 VictorialMetrics 集群模式的使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/70vm_vmagent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 使用vmagent代替Prometheus采集监控指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/71vm_operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 使用Victoria Metrics Operator管理VM集群
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/72vm_vmalert/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 使用 vmalert 代替 Prometheus 监控报警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/73vm_pressure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 对Prometheus兼容的时序数据库进行压力测试
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    APM 工具及功能介绍
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            APM 工具及功能介绍
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/1apm_prods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 APM产品落地实战
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/2opentracing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 APM + OpenTracing原理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/3apm_tracing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 怎么理解分布式链路追踪技术？
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/4apm_prod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 在生产环境中如何选择靠谱的APM系统？
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/6k8s_watching/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 聊聊可观测性之数据模型
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
        
          
          <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    OpenTelemetry 介绍
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_17">
            <span class="md-nav__icon md-icon"></span>
            OpenTelemetry 介绍
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_ot/0OpenTelemetrey_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0 OpenTelemetry保姆入门攻略可PPT-2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_ot/1OpenTelemetry_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 云原生可观测 OpenTelemetry 基础知识
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_ot/1OpenTelemetry_k8s_metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 使用 OpenTelemetry Collector 采集 Kubernetes 指标数据
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_ot/5OpenTelemetry_log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 使用 OpenTelemetry Collector 收集 Kubernetes 日志数据
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/5apm_Sentry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 Sentry+OpenTelemetry前后端全链路打通
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/2OpenTelemetry_MS.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 使用 OpenTelemetry Tracing 了解您的微服务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/3OpenTelemetry_K8S.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 使用 OpenTelemetry Tracing 最大化Kubernetes效率
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/4OpenTelemetry_datamon.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 聊聊可观测性之数据模型
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/6OpenTelemetry_java.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 Java 应用通过 OpenTelemetry API 实现手动埋点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_ot/7OT_practice/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9 Opentelemetry 采样最佳实践(概率采样器/尾部采样器)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1 安装
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2 报警规则
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-webhook" class="md-nav__link">
    <span class="md-ellipsis">
      3 webhook接收器
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="alertmanager"><strong>第九节 报警神器 AlertManager 的使用</strong></h1>
<h2 id="_1">简介</h2>
<p>之前我们学习 <code>Prometheus</code> 的时候就了解到 <code>Prometheus</code> 包含一个<strong>报警模块</strong>，就是我们的 <code>AlertManager</code>，<code>Alertmanager</code> 主要用于接收 <code>Prometheus</code> 发送的告警信息，它支持丰富的告警通知渠道，而且很容易做到告警信息进行<strong>去重，降噪，分组</strong>等，是一款前卫的告警通知系统。</p>
<p><img alt="Alt Image Text" src="../../images/10_1.jpg" title="Body image" /></p>
<p>接下来我们就来学习下 AlertManager 的具体使用方法。</p>
<h2 id="1"><strong>1 安装</strong></h2>
<p>从官方文档<code>https://prometheus.io/docs/alerting/configuration/</code>中我们可以看到下载<code>AlertManager</code>二进制文件后，可以通过下面的命令运行：</p>
<pre><code>$ ./alertmanager --config.file=simple.yml
</code></pre>
<p>其中 <code>-config.file</code> 参数是用来指定对应的配置文件的，由于我们这里同样要运行到 Kubernetes 集群中来. 所以我们使用 <code>docker</code> 镜像的方式来安装，使用的镜像是：<code>prom/alertmanager:v0.15.3</code>。</p>
<p>首先，指定配置文件，同样的，我们这里使用一个 <code>ConfigMap</code> 资源对象：(<code>alertmanager-conf.yaml</code>)</p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-config  
  namespace: kube-ops
data:
  config.yml: |-
    global:
      # 在没有报警的情况下声明为已解决的时间
      resolve_timeout: 5m      # 配置邮件发送信息
      smtp_smarthost: 'smtp.gmail.com'
      smtp_from: 'xichao2014@gmail.com'
      smtp_auth_username: 'xichao2014@gmail.com'
      smtp_auth_password: '&lt;邮箱密码&gt;'
      smtp_hello: 'gmail.com'
      smtp_require_tls: false
    # 所有报警信息进入后的根路由，用来设置报警的分发策略
    route:
      # 这里的标签列表是接收到报警信息后的重新分组标签，例如，接收到的报警信息里面有许多具有 cluster=A 和 alertname=LatncyHigh 这样的标签的报警信息将会批量被聚合到一个分组里面
      group_by: ['alertname', 'cluster']
      # 当一个新的报警分组被创建后，需要等待至少group_wait时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。
      group_wait: 30s      # 当第一个报警发送后，等待'group_interval'时间来发送新的一组报警信息。
      group_interval: 5m      # 如果一个报警信息已经发送成功了，等待'repeat_interval'时间来重新发送他们
      repeat_interval: 5m      # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器
      receiver: default      # 上面所有的属性都由所有子路由继承，并且可以在每个子路由上进行覆盖。
      routes:
      - receiver: email        
        group_wait: 10s        
        match:
          team: node    
    receivers:
    - name: 'default'
      email_configs:
      - to: 'xichao2017@gmail.com'
        send_resolved: true
    - name: 'email'
      email_configs:
      - to: 'xichao2017@gmail.com'
        send_resolved: true
</code></pre>
<p>这是 <code>AlertManager</code> 的配置文件，我们先直接创建这个 ConfigMap 资源对象：</p>
<pre><code>$ kubectl create -f alertmanager-conf.yaml
configmap &quot;alert-config&quot; created
</code></pre>
<p>然后配置 <code>AlertManager</code> 的容器，我们可以直接在之前的 <code>Prometheus</code> 的 Pod 中添加这个容器，对应的 YAML 资源声明如下：</p>
<pre><code> - name: alertmanager    
    image: prom/alertmanager:v0.15.3    
    imagePullPolicy: IfNotPresent    
    args:
    - &quot;--config.file=/etc/alertmanager/config.yml&quot;
    ports:
    - containerPort: 9093
      name: http    
    volumeMounts:
    - mountPath: &quot;/etc/alertmanager&quot;
      name: alertcfg    
    resources:
      requests:
        cpu: 100m        
        memory: 256Mi      
      limits:
        cpu: 100m        
        memory: 256Mi
volumes:
- name: alertcfg  
  configMap:
    name: alert-config
</code></pre>
<p>这里我们将上面创建的 <code>alert-config</code> 这个 <code>ConfigMap</code> 资源对象以 <code>Volume</code> 的形式挂载到 <code>/etc/alertmanager</code> 目录下去，然后在启动参数中指定了配置文件 <code>--config.file=/etc/alertmanager/config.yml</code>，然后我们可以来更新这个 Prometheus 的 Pod：</p>
<pre><code>$ kubectl apply -f prome-deploy.yaml
deployment.extensions &quot;prometheus&quot; configured
</code></pre>
<p>当然我们也可以将 AlertManager 的配置文件内容直接放入到之前的 <code>Prometheus</code> 的 <code>ConfigMap</code> 的资源对象中，也可以用一个单独的 Pod 来运行 <code>AlertManager</code> 这个容器，完整的资源清单文件可以参考这里：</p>
<p><code>AlertManager</code> 的容器启动起来后，我们还需要在 <code>Prometheus</code> 中配置下 <code>AlertManager</code> 的地址，让 <code>Prometheus</code> 能够访问到 <code>AlertManager</code>，在 <code>Prometheus</code> 的 <code>ConfigMap</code> 资源清单中添加如下配置：</p>
<pre><code>alerting:
  alertmanagers:
    - static_configs:
      - targets: [&quot;localhost:9093&quot;]
</code></pre>
<p>更新这个资源对象后，稍等一小会儿，执行 reload 操作：</p>
<pre><code>$ kubectl delete -f prome-cm.yaml
configmap &quot;prometheus-config&quot; deleted
$ kubectl create -f prome-cm.yaml
configmap &quot;prometheus-config&quot; created

# 隔一会儿后
$ kubectl get svc -n kube-ops
NAME         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                          AGE
prometheus   NodePort   10.102.74.90   &lt;none&gt;        9090:30358/TCP                   3d
$ curl -X POST &quot;http://10.102.74.90:9090/-/reload&quot;
</code></pre>
<p>更新完成后，我们查看 <code>Pod</code> 发现有错误，查看下 <code>alertmanager</code> 容器的日志，发现有如下错误信息：</p>
<pre><code>$ kubectl get pods -n kube-ops
NAME                          READY     STATUS             RESTARTS   AGE
prometheus-56d64bf6f7-rpz9j   1/2       CrashLoopBackOff   491        1d
$ kubectl logs -f prometheus-56d64bf6f7-rpz9j alertmanager -n kube-ops
level=info ts=2018-11-28T10:33:51.830071513Z caller=main.go:174 msg=&quot;Starting Alertmanager&quot; version=&quot;(version=0.15.3, branch=HEAD, revision=d4a7697cc90f8bce62efe7c44b63b542578ec0a1)&quot;level=info ts=2018-11-28T10:33:51.830362309Z caller=main.go:175 build_context=&quot;(go=go1.11.2, user=root@4ecc17c53d26, date=20181109-15:40:48)&quot;level=error ts=2018-11-28T10:33:51.830464639Z caller=main.go:179 msg=&quot;Unable to create data directory&quot; err=&quot;mkdir data/: read-only file system&quot;
</code></pre>
<p>这个是因为新版本 <code>dockerfile</code> 中的默认 <code>WORKDIR</code> 发生了变化，变成了 <code>/etc/alertmanager</code> 目录，默认情况下存储路径 <code>--storage.path</code> 是相对目录 <code>data/</code>，因此，<code>alertmanager</code> 会在我们上面挂载的 <code>ConfigMap</code> 中去创建这个目录，所以会报错，我们可以通过覆盖 <code>--storage.path</code> 参数来解决这个问题，在容器启动参数中添加该参数：(<code>prome-deploy.yaml</code>)</p>
<pre><code>- name: alertmanager
  image: prom/alertmanager:v0.15.3
  imagePullPolicy: IfNotPresent
  args:
  - &quot;--config.file=/etc/alertmanager/config.yml&quot;
  - &quot;--storage.path=/alertmanager/data&quot;
</code></pre>
<p>重新更新 Pod，可以发现 Prometheus 已经是 Running 状态了：</p>
<pre><code>$ kubectl apply -f prome-deploy.yaml
deployment.extensions &quot;prometheus&quot; configured

$ kubectl get pods -n kube-ops
NAME                          READY     STATUS      RESTARTS   AGE
prometheus-646f457455-gr8x5   2/2       Running     0          3m
$ kubectl logs -f prometheus-646f457455-gr8x5 alertmanager -n kube-ops
level=info ts=2018-11-28T11:03:16.054633463Z caller=main.go:174 msg=&quot;Starting Alertmanager&quot; version=&quot;(version=0.15.3, branch=HEAD, revision=d4a7697cc90f8bce62efe7c44b63b542578ec0a1)&quot;level=info ts=2018-11-28T11:03:16.054931931Z caller=main.go:175 build_context=&quot;(go=go1.11.2, user=root@4ecc17c53d26, date=20181109-15:40:48)&quot;level=info ts=2018-11-28T11:03:16.351058702Z caller=cluster.go:155 component=cluster msg=&quot;setting advertise address explicitly&quot; addr=10.244.2.217 port=9094
level=info ts=2018-11-28T11:03:16.456683857Z caller=main.go:322 msg=&quot;Loading configuration file&quot; file=/etc/alertmanager/config.yml
level=info ts=2018-11-28T11:03:16.548558156Z caller=cluster.go:570 component=cluster msg=&quot;Waiting for gossip to settle...&quot; interval=2s
level=info ts=2018-11-28T11:03:16.556768564Z caller=main.go:398 msg=Listening address=:9093
level=info ts=2018-11-28T11:03:18.549158865Z caller=cluster.go:595 component=cluster msg=&quot;gossip not settled&quot; polls=0 before=0 now=1 elapsed=2.000272112s
level=info ts=2018-11-28T11:03:26.558221484Z caller=cluster.go:587 component=cluster msg=&quot;gossip settled; proceeding&quot; elapsed=10.009335611s
</code></pre>
<h2 id="2"><strong>2 报警规则</strong></h2>
<p>现在我们只是把 AlertManager 容器运行起来了，也和 Prometheus 进行了关联，但是现在我们并不知道要做什么报警，因为没有任何地方告诉我们要报警，所以我们还需要配置一些报警规则来告诉我们对哪些数据进行报警。</p>
<p>警报规则允许你基于 Prometheus 表达式语言的表达式来定义报警报条件，并在触发警报时发送通知给外部的接收者。</p>
<p>同样在 <strong>Prometheus 的配置文件</strong>中添加如下报警规则配置：</p>
<pre><code>rule_files:
  - /etc/prometheus/rules.yml
</code></pre>
<p>其中 <code>rule_files</code> 就是用来指定报警规则的，这里我们将<code>rules.yml</code> 用ConfigMap的形式挂载到<code>/etc/prometheus</code>目录下面即可:</p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config  
  namespace: kube-ops
data:
  prometheus.yml: |
...
  rules.yml: |
    groups:
    - name: test-rule
      rules:
      - alert: NodeMemoryUsage
        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 20
        for: 2m
        labels:
          team: node
        annotations:
          summary: &quot;{{$labels.instance}}: High Memory usage detected&quot;
          description: &quot;{{$labels.instance}}: Memory usage is above 20% (current value is: {{ $value }}&quot;
</code></pre>
<p>上面我们定义了一个名为 <code>NodeMemoryUsage</code> 的报警规则，其中：</p>
<ul>
<li><code>for</code> 语句会使 <code>Prometheus</code> 服务等待指定的时间, 然后执行查询表达式。</li>
<li><code>labels</code> 语句允许指定额外的标签列表，把它们附加在告警上。</li>
<li><code>annotations</code> 语句指定了另一组标签，它们不被当做告警实例的身份标识，它们经常用于存储一些额外的信息，用于报警信息的展示之类的。</li>
</ul>
<p>为了方便演示，我们将的表达式判断报警临界值设置为<strong>20</strong>，重新更新 <code>ConfigMap</code> 资源对象，由于我们在 <code>Prometheus</code> 的 <code>Pod</code> 中已经通过 <code>Volume</code> 的形式将 <code>prometheus-config</code> 这个一个 <code>ConfigMap</code> 对象挂载到了<code>/etc/prometheus</code>目录下面，所以更新后，该目录下面也会出现<code>rules.yml</code>文件，所以前面配置的<code>rule_files</code>路径也是正常的，更新完成后，重新执行<code>reload</code>操作，这个时候我们去 <code>Prometheus</code> 的 <code>Dashboard</code> 中切换到alerts路径下面就可以看到有报警配置规则的数据了：</p>
<p><img alt="Alt Image Text" src="../../images/10_2.jpg" title="Body image" /></p>
<p><em>prometheus alerts</em></p>
<p>我们可以看到页面中出现了我们刚刚定义的报警规则信息，而且报警信息中还有状态显示。一个报警信息在生命周期内有下面3种状态：</p>
<ul>
<li><code>inactive</code>: 表示当前报警信息既不是firing状态也不是pending状态</li>
<li><code>pending</code>: 表示在设置的阈值时间范围内被激活了</li>
<li><code>firing</code>: 表示超过设置的阈值时间被激活了</li>
</ul>
<p>我们这里的状态现在是 <code>firing</code> 就表示这个报警已经被激活了，我们这里的报警信息有一个 <code>team=node</code> 这样的标签，而最上面我们配置 <code>alertmanager</code> 的时候就有如下的路由配置信息了：</p>
<pre><code>routes:
- receiver: email
  group_wait: 10s
  match:
    team: node
</code></pre>
<p>所以我们这里的报警信息会被<code>email</code>这个接收器来进行报警，我们上面配置的是邮箱，所以正常来说这个时候我们会收到一封如下的报警邮件：</p>
<p><img alt="Alt Image Text" src="../../images/10_3.jpg" title="Body image" /></p>
<p>我们可以看到收到的邮件内容中包含一个<code>View In AlertManager</code>的链接，我们同样可以通过 NodePort 的形式去访问到 <code>AlertManager</code> 的 <code>Dashboard</code> 页面：</p>
<pre><code>$ kubectl get svc -n kube-ops
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE
prometheus   NodePort    10.102.74.90    &lt;none&gt;        9093:31788/TCP,9090:30358/TCP    34d
</code></pre>
<p>然后通过<code>&lt;任一Node节点&gt;:31788</code>进行访问，我们就可以查看到 <code>AlertManager</code> 的 <code>Dashboard</code>页面：</p>
<p><img alt="Alt Image Text" src="../../images/10_4.jpg" title="Body image" /></p>
<p>在这个页面中我们可以进行一些操作，比如过滤、分组等等，里面还有两个新的概念：<code>Inhibition(抑制)</code>和 <code>Silences(静默)</code>。</p>
<ul>
<li><strong>Inhibition</strong>：如果某些其他警报已经触发了，则对于某些警报，Inhibition 是一个抑制通知的概念。例如：一个警报已经触发，它正在通知整个集群是不可达的时，Alertmanager 则可以配置成关心这个集群的其他警报无效。这可以防止与实际问题无关的数百或数千个触发警报的通知，Inhibition 需要通过上面的配置文件进行配置。</li>
<li><strong>Silences</strong>：静默是一个非常简单的方法，可以在给定时间内简单地忽略所有警报。Silences 基于 matchers配置，类似路由树。来到的警告将会被检查，判断它们是否和活跃的 Silences 相等或者正则表达式匹配。如果匹配成功，则不会将这些警报发送给接收者。</li>
</ul>
<p>由于全局配置中我们配置的 <code>group_interval: 5m</code>，也就是每5分钟一个分组的报警将会重新触发，所以正常来说，上面的测试报警如果一直满足报警条件(CPU使用率大于20%)的话，那么每5分钟我们就可以收到一条报警邮件。</p>
<p>现在我们添加一个 <code>Silences</code>，如下图所示，匹配 <code>node02</code> 节点的内存报警：</p>
<p><img alt="Alt Image Text" src="../../images/10_5.jpg" title="Body image" /></p>
<p><em>prometheus alertmanager Silences</em></p>
<p>添加完成后，等下一次的报警信息触发后，我们可以看到报警信息里面已经没有了节点 node02 的报警信息了：</p>
<p><img alt="Alt Image Text" src="../../images/10_6.jpg" title="Body image" /></p>
<p>由于我们上面添加的 Silences 是有过期时间的，所以在这个时间段过后，node02 的报警信息就会恢复了。</p>
<h2 id="3-webhook"><strong>3 webhook接收器</strong></h2>
<p>上面我们配置的是 AlertManager 自带的邮件报警模板，我们也说了 AlertManager 支持很多中报警接收器，比如 slack、微信之类的，其中最为灵活的方式当然是使用 <code>webhook</code> 了，我们可以定义一个 <code>webhook</code> 来接收报警信息，然后在 <code>webhook</code> 里面去进行处理，需要发送怎样的报警信息我们自定义就可以。</p>
<p>比如我们这里用 <code>Flask</code> 编写了一个简单的处理钉钉报警的 <code>webhook</code> 的程序：</p>
<pre><code>import os
import requests

from flask import Flask
from flask import request

app = Flask(__name__)


@app.route('/', methods=['POST', 'GET'])
def send():
    if request.method == 'POST':
        post_data = request.get_data()
        send_alert(post_data)
        return 'success'
    else:
        return 'weclome to use prometheus alertmanager dingtalk webhook server!'


def send_alert(data):
    token = os.getenv('ROBOT_TOKEN')
    if not token:
        print('you must set ROBOT_TOKEN env')
        return
    url = 'https://oapi.dingtalk.com/robot/send?access_token=%s' % token
    send_data = {
        &quot;msgtype&quot;: &quot;text&quot;,
        &quot;text&quot;: {
            &quot;content&quot;: data
        }
    }
    req = requests.post(url, json=send_data)
    result = req.json()
    if result['errcode'] != 0:
        print('notify dingtalk error: %s' % result['errcode'])

if __name__ == '__main__':
    from waitress import serve
    serve(app, listen='0.0.0.0:5000')
</code></pre>
<p>代码非常简单，通过一个 <code>ROBOT_TOKEN</code> 的环境变量传入群机器人的 <code>TOKEN</code>，然后直接将 <code>webhook</code> 发送过来的数据直接以文本的形式转发给群机器人。</p>
<p>当然我们得将上面这个服务部署到集群中来，对应的资源清单如下：(<code>dingtalk-hook.yaml</code>)</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: dingtalk-hook
  namespace: kube-ops
spec:
  template:
    metadata:
      labels:
        app: dingtalk-hook
    spec:
      containers:
      - name: dingtalk-hook
        image: cnych/alertmanager-dingtalk-hook:v0.2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5000
          name: http
        env:
        - name: ROBOT_TOKEN
          valueFrom:
            secretKeyRef:
              name: dingtalk-secret
              key: token
        resources:
          requests:
            cpu: 50m
            memory: 100Mi
          limits:
            cpu: 50m
            memory: 100Mi

---
apiVersion: v1
kind: Service
metadata:
  name: dingtalk-hook
  namespace: kube-ops
spec:
  selector:
    app: dingtalk-hook
  ports:
  - name: hook
    port: 5000
    targetPort: http
</code></pre>
<p>要注意上面我们声明了一个 <code>ROBOT_TOKEN</code> 的环境变量，由于这是一个相对于私密的信息，所以我们这里从一个 <code>Secret</code> 对象中去获取，通过如下命令创建一个名为 <code>dingtalk-secret</code> 的 <code>Secret</code> 对象，然后部署上面的资源对象即可：</p>
<pre><code>$ kubectl create secret generic dingtalk-secret --from-literal=token=替换成钉钉群聊的机器人TOKEN -n kube-ops
secret &quot;dingtalk-secret&quot; created
$ kubectl create -f dingtalk-hook.yaml
deployment.extensions &quot;dingtalk-hook&quot; created
service &quot;dingtalk-hook&quot; created
$ kubectl get pods -n kube-ops
NAME                            READY     STATUS      RESTARTS   AGE
dingtalk-hook-c4fcd8cd6-6r2b6   1/1       Running     0          45m
......
</code></pre>
<p>部署成功后，现在我们就可以给 <code>AlertManager</code> 配置一个 <code>webhook</code> 了，在上面的配置中增加一个路由接收器</p>
<pre><code>routes:
- receiver: webhook
match:
  filesystem: node
receivers:
- name: 'webhook'
  webhook_configs:
  - url: 'http://dingtalk-hook:5000'
    send_resolved: true
</code></pre>
<p>我们这里配置了一个名为 webhook 的接收器，地址为：<code>http://dingtalk-hook:5000</code>，这个地址当然就是上面我们部署的钉钉的 <code>webhook</code> 的接收程序的 <code>Service</code> 地址。</p>
<p>然后我们也在报警规则中添加一条关于节点文件系统使用情况的报警规则，注意 <code>labels</code> 标签要带上<code>alertname=NodeFilesystem</code>，这样报警信息就会被 <code>webook</code> 这一个接收器所匹配：</p>
<pre><code>- alert: NodeFilesystemUsage
  expr: (node_filesystem_size_bytes{device=&quot;rootfs&quot;} - node_filesystem_free_bytes{device=&quot;rootfs&quot;}) / node_filesystem_size_bytes{device=&quot;rootfs&quot;} * 100 &gt; 10
  for: 2m
  labels:
    filesystem: node
  annotations:
    summary: &quot;{{$labels.instance}}: High Filesystem usage detected&quot;
    description: &quot;{{$labels.instance}}: Filesystem usage is above 10% (current value is: {{ $value }}&quot;
</code></pre>
<p>更新 <code>AlertManager</code> 和 <code>Prometheus</code> 的 <code>ConfigMap</code> 资源对象（先删除再创建），更新完成后，隔一会儿执行 <code>reload</code> 操作是更新生效：</p>
<pre><code>$ kubectl get svc -n kube-ops
NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE
prometheus      NodePort    10.102.74.90    &lt;none&gt;        9093:31788/TCP,9090:30358/TCP    34d
$ curl -X POST &quot;http://10.102.74.90:9093/-/reload&quot;
$ curl -X POST &quot;http://10.102.74.90:9090/-/reload&quot;
</code></pre>
<p><strong><code>AlertManager</code> 和 <code>Prometheus</code> 都可以通过上面的 reload 操作进行重新加载</strong></p>
<p>都完成更新后，再次去 Prometheus 的 Alert 路径下面查看报警信息：</p>
<p><img alt="Alt Image Text" src="../../images/10_7.jpg" title="Body image" /></p>
<p>隔一会儿关于这个节点文件系统的报警就会被触发了，由于这个报警信息包含一个 <code>filesystem=node</code> 的 <code>label</code> 标签，所以会被路由到 <code>webhook</code> 这个接收器中，也就是上面我们自定义的这个 <code>dingtalk-hook</code> ，触发后可以观察这个 Pod 的日志：</p>
<pre><code>$ kubectl logs -f dingtalk-hook-cc677c46d-gf26f -n kube-ops
 * Serving Flask app &quot;app&quot; (lazy loading)
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)

10.244.2.217 - - [28/Nov/2018 17:14:09] &quot;POST / HTTP/1.1&quot; 200 -
</code></pre>
<p>可以看到 POST 请求已经成功了，同时这个时候正常来说就可以收到一条钉钉消息了：</p>
<p><img alt="Alt Image Text" src="../../images/10_8.jpg" title="Body image" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>
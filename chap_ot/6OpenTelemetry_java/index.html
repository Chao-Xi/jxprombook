
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Prometheus 技术实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>8 Java 应用通过 OpenTelemetry API 实现手动埋点 - Jacob Prometheus Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#8-java-opentelemetry-api" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob Prometheus Book" class="md-header__button md-logo" aria-label="Jacob Prometheus Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob Prometheus Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              8 Java 应用通过 OpenTelemetry API 实现手动埋点
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxprombook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxprombook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob Prometheus Book" class="md-nav__button md-logo" aria-label="Jacob Prometheus Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob Prometheus Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxprombook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxprombook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    监控解决方案
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            监控解决方案
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap0/1monitor_tools10/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 监控解决方案：10个 Kubernetes 监控工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/11Prom_intro_2023-CN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 云原生系统监控
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus技术介绍,K8S Metrics介绍&查看
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Prometheus技术介绍,K8S Metrics介绍&查看
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/57prometheus_best_practice/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第零节 Promethues 应用监控的一些实践
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1prometheus2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Prometheus 系统介绍 2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/18Adv_Prometheus_index_classfication/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 深入Prometheus设计-指标定义与分类(PromQL)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/k8s_adv39_kube_state_metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 kube-state-metrics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/17Adv_K8S_Metrics_Server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 Metrics Server 安装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/20Install_metrics_server_SAP_CC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 Install Kubernetes Metrics Server on SAP Converged Cloud
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/38k8s_hpa_metricsserver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 Kubernetes HPA 使用详解(Metrics Server/CPU/Mem/adapater)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/55prometheus_go_metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 为Go应用添加Prometheus监控指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/37kubectl_top/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 从kubectl top看K8S监控原理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/9kube-state-metrics_crd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第九节 通过 kube-state-metrics 添加 CRD 状态指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/10kube-state-metrics-cluster-opt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十节 kube-state-metrics 在大规模集群下的优化(2023)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus on Linux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Prometheus on Linux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/19centos7_Prometheus_Alertmanager_Grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Centos7 Prometheus安装部署+监控+绘图+告警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/59node_exporter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 使用Node Exporter监控Linux主机&常用监控指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/36Prometheus_Mysql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 基于Prometheus构建MySQL可视化监控平台
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/4mysql_exporter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 官方 mysqld_exporter支持抓取多MySQL实例
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/5prom_grafana_chatops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 使用 Grafana、Prometheus 和 Slack 构建一个简单的 ChatOps 机器人
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    手动部署Kubernetes Prometheus
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            手动部署Kubernetes Prometheus
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/1prometheus_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Kubernetes使用Prometheus搭建监控平台(2018)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/2prometheus_AlertManager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Prometheus报警 && AlertManager实战（2018）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/3changes_on_Grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 Grafana 显示参数设置(2018)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/4Adv_Prometheus_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 在 Kubernetes 中手动部署 Prometheus (adv)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/5Adv_Prometheus_monitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 应用监控（Metrics/Exporter的配置）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/6Adv_K8S_Nodes_monitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 监控K8S集群节点&Node-exporter DaemonSet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/7Adv_K8S_Resource_monitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 监控常用资源对象（容器/apiserver/Service监控/kube-state-metric）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/8Adv_K8S_Grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 Grafana 在 Kubernetes 中的使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/10Adv_k8s_AlertManger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第九节 报警神器 AlertManager 的使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/16Adv_Prometheus_Del_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十节 Prometheus 删除数据指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/50PrometheusAlert/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十一节 Prometheus中使用PrometheusAlert进行聚合报警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/12gpu_monitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十二节 监控Kubernetes集群的GPU资源
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/29AlertManager_SendAlerts_when/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十三节 AlertManager何时报警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/41Prometheus_Monitor_OutCluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十四节 Prometheus监控外部Kubernetes集群
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    玩转Prometheus Operator
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            玩转Prometheus Operator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/11Adv_Prometheus_Operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Prometheus Operator 初体验
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/13Adv_Prometheus_Operator_etcd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 使用 Prometheus Operator 监控 etcd
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/14Adv_Prometheus_Operator_alarm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 Prometheus Operator 自定义报警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/22Customize_Alert_Email/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 Add Custom Alert and Send Alert Email with Alertmanager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/24Kubernetes_Prometheus_blackbox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 Prometheus 黑盒监控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/32Prometheus_troubleshoot_Servicemonitor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 Troubleshooting ServiceMonitor changes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/43Prometheus_operator_ssl_exporter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 使用ssl_exporter监控K8S集群证书
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/44Prometheus_KubeNurse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 Operator2021-使用KubeNurse进行集群网络监控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/45Prom-operator_2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第九节 Prometheus Operator安装配置(2021)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/46Prometheus_traefik/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十节 Traefik之使用Prometheus Operator进行监控报警2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/47Prometheus_opt_AlertmanagerConfig/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十一节 Operator使用AlertmanagerConfig进行报警配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/49Prometheus_SLI_SLO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十二节 通过Prometheus来做SLI/SLO监控展示
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/51missing-container-metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十三节 Prometheus使用missing-container-metrics监控Pod oomkill
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/chap4_blackbox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十四节 如何在Prometheus中进行黑盒监控(ICMP/DNS/TCP/HTTP/gRPC)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/chap4_Operator_probe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第十五节 Prometheus Operator中探针的使用（Blackbox Exporter）
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus服务发现
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Prometheus服务发现
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/53Prometheus_auto_discovery/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Prometheus服务的自动发现使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/52Prometheus_Relabeling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Prometheus Relabeling重新标记的使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/54prometheus_go_metrics_guideline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 如何使用Prometheus仪表化应用
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Jam prometheus Monitor
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Jam prometheus Monitor
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/25Alertmanager_AWS_SES/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap1 Alertmanager alerts with Amazon SES SMTP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/26Prometheus_Monitor_Argocd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap2 Prometheus Operator Monitor on ArgoCD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/27Prometheus_Monitor_elasticsearch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap3 Prometheus Operator Monitor on ElasticSearch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/31Prometheus_Monitor_rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap4 Prometheus Operator Monitor on Rabbitmq
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/33Prometheus_Monitor_memcached/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chap5 Prometheus Operator Monitor on Memcached
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus-Adapter
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Prometheus-Adapter
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/23Kubernetes_Scale_Prometheus-Adapter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    应用进行自定义指标扩缩容 by Prometheus-Adapter and Flask-Exporter
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    PromQL学习
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            PromQL学习
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/1Promql_basic1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 初识 PromQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/2Promql_basic2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 PromQL 操作符 & 内置函数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/3Promql_basic3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 PromQL 内置函数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/4Promql_basic4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 PromQL简单示例
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/5Promql_basic5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 在 HTTP API中使用 PromQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/6Promql_adv1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 Prometheus记录规则的使用(Recording Rule)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/56prometheus_promql_rate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 PromQL查询之rate函数的使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/60prometheus_job/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 解决Prometheus监控Kubernetes Job误报的坑
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/9promql_6errors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9 使用 Prometheus PromQL时需要避免这6个错误
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Awesome alerts rules
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Awesome alerts rules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/1basic_resource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 Basic resource monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/2database_broker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 Databases and brokers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/3proxy_lb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 Reverse proxies and load balancers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/4runtimes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 Runtimes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/5Orchestrators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 Orchestrators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/6network_sec_storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 Network, security and storage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/7other/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 Others
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/8Alerting_sleep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 Alert Sleep Peacefully
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    数据可视化&Grafana Plugin
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            数据可视化&Grafana Plugin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/58grafana_init/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 使用 Grafana 构建你的第一个仪表盘
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/28Grafana_plugin_DevOpsProdigy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 优秀的Grafana K8S 插件-DevOpsProdigy KubeGraf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/30Create_Grafana_dashboards/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 用 Kubernetes darks资源对象创建Grafana Dashboard
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/48grafana_Trickster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 Grafana 图表加速神器-Trickster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/5Grafana_Loki/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 使用读写分离模式扩展 Grafana Loki
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/6Prometheus_grafaa_docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 使用 Prometheus 和 Grafana 实现服务器运行状态监控（基于 Docker）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/7loki_promtail_grafana/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 Docker上部署LPG（loki+promtail+grafana）踩坑复盘
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prometheus(OpenTelemetry)架构设计与工具平台
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Prometheus(OpenTelemetry)架构设计与工具平台
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/1deepflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 DeepFlow AutoTagging之Prometheus标签标准化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/2Prometheus_opentele/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 Prometheus与OpenTelemetry该选哪个？
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/3Prometheus_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 Prometheus的四种指标类型
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/4OpenTelemetry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 透彻理解OpenTelemetry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/4OpenTelemetry_tracing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 使用OpenTelemetry Tracing最大化Kubernetes效率
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Thanos
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Thanos
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/39Thanos_tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 大规模场景下Prometheus的优化手段&Thanos架构详解
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/34Thanos_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 使用Thanos实现Prometheus的高可用介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/35Thanos_install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 Prometheus高可用Thanos学习-sidercar和query&Thanos部署
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/61thanos_sidecar_receiver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节（2022）如何选择Thanos的Sidecar和Receiver两种模式？
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/62thanos_query/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节（2022）使用Thanos查询前端优化查询性能
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/63prometheus_optimiztion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 (Thaos1-2022)大规模场景下Prometheus的优化手段
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/64thanos_detail/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 (Thaos2-2022)Thanos架构详解
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/65thanos_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第八节 (Thaos3-2022)Thanos部署与实践
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/66thanos_ruler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第九节（2022）Thanos Ruler组件的使用
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    VictoriaMetrics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            VictoriaMetrics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/67vm_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 Prometheus远程存储VictoriaMetrics简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/68vm_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 Prometheus长期远程存储方案VictoriaMetrics入门实践
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/69vm_cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 VictorialMetrics 集群模式的使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/70vm_vmagent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 使用vmagent代替Prometheus采集监控指标
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/71vm_operator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第五节 使用Victoria Metrics Operator管理VM集群
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/72vm_vmalert/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 使用 vmalert 代替 Prometheus 监控报警
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/73vm_pressure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第七节 对Prometheus兼容的时序数据库进行压力测试
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    APM 工具及功能介绍
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            APM 工具及功能介绍
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/1apm_prods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第一节 APM产品落地实战
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/2opentracing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二节 APM + OpenTracing原理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/3apm_tracing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三节 怎么理解分布式链路追踪技术？
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/4apm_prod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第四节 在生产环境中如何选择靠谱的APM系统？
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/6k8s_watching/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第六节 聊聊可观测性之数据模型
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
        
          
          <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    OpenTelemetry 介绍
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_17">
            <span class="md-nav__icon md-icon"></span>
            OpenTelemetry 介绍
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../0OpenTelemetrey_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0 OpenTelemetry保姆入门攻略可PPT-2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1OpenTelemetry_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 云原生可观测 OpenTelemetry 基础知识
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1OpenTelemetry_k8s_metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 使用 OpenTelemetry Collector 采集 Kubernetes 指标数据
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5OpenTelemetry_log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 使用 OpenTelemetry Collector 收集 Kubernetes 日志数据
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/5apm_Sentry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 Sentry+OpenTelemetry前后端全链路打通
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/2OpenTelemetry_MS.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 使用 OpenTelemetry Tracing 了解您的微服务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/3OpenTelemetry_K8S.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 使用 OpenTelemetry Tracing 最大化Kubernetes效率
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/4OpenTelemetry_datamon.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 聊聊可观测性之数据模型
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_apm/6OpenTelemetry_java.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 Java 应用通过 OpenTelemetry API 实现手动埋点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7OT_practice/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9 Opentelemetry 采样最佳实践(概率采样器/尾部采样器)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      使用注解埋点
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      使用 API 手动埋点
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="8-java-opentelemetry-api">8 Java 应用通过 OpenTelemetry API 实现手动埋点</h1>
<p>Java 应用可以通过 OpenTelemetry 提供的 Java agent 来实现自动埋点功能，在大多数场景下也完全足够了，但是有时候我们需要更加精细的控制，这时候我们就需要使用手动埋点的方式来实现了。</p>
<h3 id="_1">使用注解埋点</h3>
<p>我们可以在 Java 应用通过手动埋点的方式来实现链路追踪，但如果我们不希望进行太多的代码更改，那么可以使用注解的方式来实现，OpenTelemetry 提供了一些注解来帮助我们实现手动埋点，比如 <code>@WithSpan</code>、<code>@SpanAttribute</code>。</p>
<p>首先我们需要添加依赖库 <code>opentelemetry-instrumentation-annotations</code>。</p>
<pre><code>&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;io.opentelemetry.instrumentation&lt;/groupId&gt;
    &lt;artifactId&gt;opentelemetry-instrumentation-annotations&lt;/artifactId&gt;
    &lt;version&gt;1.29.0&lt;/version&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>开发人员可以使用 <code>@WithSpan</code> 注解来向 <code>OpenTelemetry</code> 自动检测发送信号，每当标记的方法被执行时都应创建一个新的 span。</p>
<p>比如我们在 Order Service 中的 <code>IndexController</code> 中添加一个 <code>@WithSpan</code>注解，代码如下所示：</p>
<pre><code>// src/main/java/com/youdianzhishi/orderservice/controller/IndexController.java
package com.youdianzhishi.orderservice.controller;

// ......

import io.opentelemetry.instrumentation.annotations.WithSpan;


@RestController
@RequestMapping(&quot;/&quot;)
public class IndexController {
    @GetMapping
    @WithSpan
    public ResponseEntity&lt;String&gt; home(HttpServletRequest request) {
        return new ResponseEntity&lt;&gt;(&quot;Hello OpenTelemetry!&quot;, HttpStatus.OK);
    }
}
</code></pre>
<p>然后我们重建镜像，重新启动容器，当我们访问首页的时候就可以看到 Jaeger UI 中多了一个 IndexController.home 的 span 了。</p>
<p><img alt="Alt Image Text" src="../../images/ot1_6_1.png" title="Body image" /></p>
<p>每次应用程序调用有注解的方法时，它都会创建一个表示其持续时间并提供任何抛出异常的 span。默认情况下，span 名称是 <code>&lt;className&gt;.&lt;methodName&gt;</code>，当然也可以在注解中提供了一个名称作为参数，比如可以使用 <code>@WithSpan("indexSpan")</code>来指定 span 的名称，这样在 Jaeger UI 中就可以看到 <code>indexSpan</code> 的 span 了。</p>
<p><img alt="Alt Image Text" src="../../images/ot1_6_2.png" title="Body image" /></p>
<p>此外当为一个带注解的方法创建一个 span 时，可以通过使用 <code>@SpanAttribute</code> 注解来自动将方法调用的参数值添加为创建 span 的属性。</p>
<p>比如我们在 <code>IndexController</code> 中添加一个 <code>fetchId</code> 函数，并接收一个 id 参数，我们就可以使用 <code>@SpanAttribute</code> 注解来将接收的 <code>id</code>参数添加为 <code>indexSpanWithAttr</code> 这个 <code>span</code> 的属性，代码如下所示：</p>
<pre><code>// src/main/java/com/youdianzhishi/orderservice/controller/IndexController.java
package com.youdianzhishi.orderservice.controller;

// ......

import io.opentelemetry.instrumentation.annotations.WithSpan;
import io.opentelemetry.instrumentation.annotations.SpanAttribute;


@RestController
@RequestMapping(&quot;/&quot;)
public class IndexController {
    @GetMapping
    @WithSpan(&quot;indexSpan&quot;)
    public ResponseEntity&lt;String&gt; home(HttpServletRequest request) {
        return new ResponseEntity&lt;&gt;(&quot;Hello OpenTelemetry!&quot;, HttpStatus.OK);
    }

    @GetMapping(&quot;/{id}&quot;)
    @WithSpan(&quot;indexSpanWithAttr&quot;)
    public ResponseEntity&lt;String&gt; fetchId(@SpanAttribute(&quot;id&quot;) @PathVariable Long id) {
        return new ResponseEntity&lt;&gt;(&quot;Hello OpenTelemetry：&quot; + id, HttpStatus.OK);
    }
}
</code></pre>
<p>然后我们重建镜像，重新启动容器，当我们访问 <code>http://localhost:8081/123</code> 的时候就可以看到 Jaeger UI 中多了一个 <code>indexSpanWithAttr</code> 的 span 了，并且该 span 的属性中包含了我们传递的 id 参数。</p>
<p><img alt="Alt Image Text" src="../../images/ot1_6_3.png" title="Body image" /></p>
<h3 id="api">使用 API 手动埋点</h3>
<p>除了使用注解的方式来实现埋点之外，<strong>我们还可以使用 OpenTelemetry 提供的 API 来实现手动埋点</strong>，这样我们就可以更加精细的控制我们的 span 了，当然这样也会增加我们的代码量，但就不需要使用 <code>java agent</code> 了。</p>
<p>在 Java 应用中，要实现手动埋点，</p>
<ul>
<li>首先第一步是获取 <code>OpenTelemetry</code> 接口的实例，我们需要尽早在应用程序中配置一个 <code>OpenTelemetrySdk</code> 的实例，我们可以使用 <code>OpenTelemetrySdk.builder()</code> 方法来完成这个操作。</li>
<li>然后可以通过返回的 <code>OpenTelemetrySdkBuilder</code> 实例获取与信号、跟踪和指标相关的提供程序，以构建 <code>OpenTelemetry</code> 实例。</li>
<li>我们可以使用 <code>SdkTracerProvider.builder()</code>和 <code>SdkMeterProvider.builder()</code>方法来构建 Provider。</li>
<li>此外还强烈建议将 Resource 实例定义为生成遥测数据的实体的表示；特别是 service.name 属性是最重要的遥测源标识信息的一部分。</li>
</ul>
<pre><code>&lt;!-- pom.xml --&gt;
&lt;project&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
                &lt;artifactId&gt;opentelemetry-bom&lt;/artifactId&gt;
                &lt;version&gt;1.29.0&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
            &lt;artifactId&gt;opentelemetry-api&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
            &lt;artifactId&gt;opentelemetry-sdk&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
            &lt;artifactId&gt;opentelemetry-exporter-otlp&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
            &lt;artifactId&gt;opentelemetry-semconv&lt;/artifactId&gt;
            &lt;version&gt;1.29.0-alpha&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<p>在 <code>pom.xml</code>文件中添加了 <code>opentelemetry-api</code>、<code>opentelemetry-sdk</code>、<code>opentelemetry-exporter-otlp</code>、<code>opentelemetry-semconv</code>这几个依赖库，其中 <code>opentelemetry-semconv</code> 是用来定义一些常用的属性的，比如 <code>service.name</code>、<code>http.method</code>、<code>http.status_code</code> 等，当然现在我们就不需要 <code>opentelemetry-instrumentation-annotations</code> 这个依赖库了。</p>
<p><strong>在 Spring Boot 项目中，初始化 <code>OpenTelemetry</code> 的一种常见方法是使用 <code>@Configuration</code> 类</strong>。</p>
<p>这样的类会在 Spring Boot 应用启动时自动运行，使得初始化工作更加集中和组织化。</p>
<p>我们这里创建一个如下所示的 OpenTelemetryConfig 类，代码如下所示：</p>
<pre><code>// src/main/java/com/youdianzhishi/orderservice/config/OpenTelemetryConfig.java
package com.youdianzhishi.orderservice.config;

import io.opentelemetry.api.OpenTelemetry;
import io.opentelemetry.api.common.Attributes;
import io.opentelemetry.exporter.otlp.trace.OtlpGrpcSpanExporter;
import io.opentelemetry.sdk.OpenTelemetrySdk;
import io.opentelemetry.sdk.resources.Resource;
import io.opentelemetry.sdk.trace.SdkTracerProvider;
import io.opentelemetry.sdk.trace.export.SimpleSpanProcessor;
import io.opentelemetry.semconv.resource.attributes.ResourceAttributes;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;

@Configuration
@Order(2)
public class OpenTelemetryConfig {

    @Bean
    public OpenTelemetry openTelemetry() {
        GlobalOpenTelemetry.resetForTest(); // 初始化之前先重置 GlobalOpenTelemetry

        // 从环境变量中获取 OTLP Exporter 的地址
        String exporterEndpointFromEnv = System.getenv(&quot;OTLP_EXPORTER_ENDPOINT&quot;);
        String exporterEndpoint = exporterEndpointFromEnv != null ? exporterEndpointFromEnv
                : &quot;http://otel-collector:4317&quot;;

        String serviceNameFromEnv = System.getenv(&quot;SERVICE_NAME&quot;);
        String serviceName = serviceNameFromEnv != null ? serviceNameFromEnv : &quot;order-service&quot;;

        // 初始化 OTLP Exporter
        OtlpGrpcSpanExporter exporter = OtlpGrpcSpanExporter.builder()
                .setEndpoint(exporterEndpoint)
                .build();

        Resource resource = Resource.getDefault()
                .merge(Resource.create(Attributes.of(
                        ResourceAttributes.SERVICE_NAME, serviceName,
                        ResourceAttributes.TELEMETRY_SDK_LANGUAGE, &quot;java&quot;)));

        // 初始化 TracerProvider
        SdkTracerProvider tracerProvider = SdkTracerProvider.builder()
                .addSpanProcessor(SimpleSpanProcessor.create(exporter))
                .setResource(resource)
                .build();

        // 初始化 ContextPropagators，这里我们配置包含 W3C Trace Context 和 W3C Baggage
        ContextPropagators propagators = ContextPropagators.create(
                TextMapPropagator.composite(
                        W3CTraceContextPropagator.getInstance(),
                        W3CBaggagePropagator.getInstance()));

        // 初始化并返回 OpenTelemetry SDK
        return OpenTelemetrySdk.builder()
                .setPropagators(propagators)
                .setTracerProvider(tracerProvider)
                .buildAndRegisterGlobal();
    }

    @Bean
    public Tracer tracer() {
        return openTelemetry().getTracer(OrderserviceApplication.class.getName());
    }
}
</code></pre>
<p>在上述代码中，我们定义了一个 <code>@Configuration</code> 类，并使用 <code>@Bean</code>注解为 <code>OpenTelemetry</code> 创建了一个 <code>Bean</code>，<code>Spring</code> 会管理这个 <code>Bean</code> 的生命周期，并在需要时自动注入。</p>
<p>这样，你的 <code>Spring Boot</code> 应用每次启动时，都会执行这些初始化代码，从而确保了 <code>OpenTelemetry</code> 的正确配置。</p>
<p>在真正初始化的代码中，我们首先从环境变量中获取 OTLP Exporter 的地址，然后初始化 OTLP Exporter，接着初始化 <code>TracerProvider</code>，最后初始化并返回 <code>OpenTelemetry SDK</code>。</p>
<p>比如现在我们在 <code>OrderController</code>中的 <code>getAllOrders</code> 处理器中来手动埋点，代码如下所示：</p>
<pre><code>// src/main/java/com/youdianzhishi/orderservice/controller/OrderController.java
package com.youdianzhishi.orderservice.controller;

// ......

import io.opentelemetry.api.OpenTelemetry;
import io.opentelemetry.api.trace.StatusCode;
import io.opentelemetry.api.trace.Tracer;

@RestController
@RequestMapping(&quot;/api/orders&quot;)
public class OrderController {
    private static final Logger logger = LoggerFactory.getLogger(OrderserviceApplication.class);

    @Autowired
    private OrderRepository orderRepository;

    @Autowired
    private WebClient webClient;

    @Autowired
    private Tracer tracer;  // 注入 Tracer

    @GetMapping
    public ResponseEntity&lt;List&lt;OrderDto&gt;&gt; getAllOrders(HttpServletRequest request) {
        // 创建一个新的 Span 并设置 Span 名称为 &quot;GET /api/orders&quot;
        var span = tracer.spanBuilder(&quot;GET /api/orders&quot;).startSpan();

        // 将 Span 注入到上下文中
        try (var scope = span.makeCurrent()) {
            // 从拦截器中获取用户信息
            User user = (User) request.getAttribute(&quot;user&quot;);

            // 要根据 orderDate 倒序排列
            List&lt;Order&gt; orders = orderRepository.findByUserIdOrderByOrderDateDesc(user.getId());

            // 将Order转换为OrderDto
            List&lt;OrderDto&gt; orderDtos = orders.stream().map(order -&gt; {
                try {
                    return order.toOrderDto(webClient);
                } catch (Exception e) {
                    throw new RuntimeException(e);
                }
            }).collect(Collectors.toList());

            span.setAttribute(&quot;user_id&quot;, user.getId());
            span.setAttribute(&quot;order_count&quot;, orders.size());

            return new ResponseEntity&lt;&gt;(orderDtos, HttpStatus.OK);
        } catch (Exception e) {
            // 记录 Span 错误
            span.recordException(e).setStatus(StatusCode.ERROR, e.getMessage());
            return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);
        } finally {
            // 记录 Span 结束时间
            span.end();
        }
    }

    // 忽略其他......
}
</code></pre>
<p>上面代码中我们首先通过 <code>openTelemetry.getTracer(OrderController.class.getName())</code> 方法来初始化 Tracer，然后通过 <code>tracer.spanBuilder("getAllOrders").startSpan()</code> 方法来创建一个新的 Span，接着通过 <code>span.makeCurrent()</code> 方法将 Span 注入到上下文中，然后就可以在 try 代码块中执行我们的业务逻辑了，这里我们添加了两个属性，如果出现了异常则会记录异常信息，最后在 finally 代码块中结束 Span。</p>
<p>我们还需要修改 Dockerfile 中的启动命令，代码如下所示：</p>
<pre><code># ......
# CMD [&quot;mvn&quot;, &quot;-Pdev&quot;, &quot;spring-boot:run&quot;]
CMD [&quot;mvn&quot;, &quot;spring-boot:run&quot;]
</code></pre>
<p>因为现在我们不需要使用 <code>java agent</code> 了，所以去掉 <code>-Pdev</code> 参数（该 profile 中定义了 <code>java agent</code> 启动参数），然后重新构建镜像，重新启动容器，当我们访问订单列表后就可以看到 Jaeger UI 中多了一个 <code>getAllOrders</code>的 <code>span</code> 了。</p>
<p><img alt="Alt Image Text" src="../../images/ot1_6_4.png" title="Body image" /></p>
<p>很明显我们可以看到现在的 span 非常简单，没有和前端 frontend 服务的 span 关联起来。</p>
<p>由于前端 <code>frontend</code>在请求后端接口的时候我们已经注入了 <code>W3CTraceContext</code>，所以我们只需要在 Java 应用中通过 <code>propagation api</code> 来获取到 <code>span context</code>，然后将其作为父级 <code>span</code>，这样就可以将前端的 span 和后端的 span 关联起来了。</p>
<p>这里我们可以添加一个拦截器来使用 <code>propagation</code> 接口解析 <code>span context</code>，代码如下所示：</p>
<pre><code>// src/main/java/com/youdianzhishi/orderservice/interceptor/OpenTelemetryInterceptor.java
package com.youdianzhishi.orderservice.interceptor;

// ......

@Component
public class OpenTelemetryInterceptor implements HandlerInterceptor {
    @Autowired
    private OpenTelemetry openTelemetry;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        TextMapGetter&lt;HttpServletRequest&gt; getter = new TextMapGetter&lt;&gt;() {
            @Override
            public Iterable&lt;String&gt; keys(HttpServletRequest carrier) {
                return Collections.list(carrier.getHeaderNames());
            }

            @Override
            public String get(HttpServletRequest carrier, String key) {
                return carrier.getHeader(key);
            }
        };

        // 提取传入的Trace Context
        Context extractedContext = openTelemetry.getPropagators().getTextMapPropagator()
                                       .extract(Context.current(), request, getter);

        StringBuilder sb = new StringBuilder();
        sb.append(request.getMethod()).append(&quot; &quot;).append(request.getRequestURI());
        Span span = tracer.spanBuilder(sb.toString()).setParent(extractedContext)
                    .startSpan();

        // 将解析出来的SpanContext存储在请求属性中，以便后续使用
        request.setAttribute(&quot;currentSpan&quot;, span);

        return true;
    }
}
</code></pre>
<p>上面代码中我们首先通过 <code>openTelemetry.getPropagators().getTextMapPropagator()</code> 方法来获取到 <code>TextMapPropagator</code>，然后通过 <code>extract</code> 方法来解析 <code>span context</code>，然后将解析出来的 <code>span context</code> 设置为子 <code>span</code> 的父级<code>span</code>，最后将 <code>span context</code> 存储在请求属性中，以便后续使用。</p>
<p>这里的关键是在初始化 <code>OpenTelemetry</code>的时候需要配置 <code>ContextPropagators</code>，代码如下所示：</p>
<pre><code>// 初始化 ContextPropagators，这里我们配置包含 W3C Trace Context 和 W3C Baggage
ContextPropagators propagators = ContextPropagators.create(
        TextMapPropagator.composite(
                W3CTraceContextPropagator.getInstance(),
                W3CBaggagePropagator.getInstance()));
</code></pre>
<p>这样我们才能去解析 <code>TraceContext</code> 和 <code>Baggage</code> 两种上下文传播机制。而其中的 getter 就是用来从 HTTP 请求头中获取 <code>span context</code> 的方式。</p>
<p>当然最后我们还需要在 <code>WebMvcConfig</code> 中注册该拦截器，代码如下所示</p>
<pre><code>// src/main/java/com/youdianzhishi/orderservice/config/WebMvcConfig.java
package com.youdianzhishi.orderservice.config;

// ......

@Configuration
@Order(4)
public class WebMvcConfig implements WebMvcConfigurer {

    @Autowired
    private TokenInterceptor tokenInterceptor;

    @Autowired
    private OpenTelemetryInterceptor otelCtxInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(otelCtxInterceptor)
            .addPathPatterns(&quot;/api/orders/**&quot;);

        registry.addInterceptor(tokenInterceptor)
            .addPathPatterns(&quot;/api/orders/**&quot;) // 指定拦截器应该应用的路径模式
            .excludePathPatterns(&quot;/api/login&quot;, &quot;/api/register&quot;); // 指定应该排除的路径模式
    }

}
</code></pre>
<p>这样当我们在请求 <code>/api/orders/**</code> 下面的接口时，就可以从请求属性中获取父级的 <code>span context</code> 了。</p>
<p>现在我们重新修改 <code>getAllOrders</code> 处理器，代码如下所示：</p>
<pre><code>@GetMapping
public ResponseEntity&lt;List&lt;OrderDto&gt;&gt; getAllOrders(HttpServletRequest request) {
    // 从请求属性中获取 Span
    Span span = (Span) request.getAttribute(&quot;currentSpan&quot;);

    try {
        // 从拦截器中获取用户信息
        User user = (User) request.getAttribute(&quot;user&quot;);

        // 要根据 orderDate 倒序排列
        List&lt;Order&gt; orders = orderRepository.findByUserIdOrderByOrderDateDesc(user.getId());

        // 将Order转换为OrderDto
        List&lt;OrderDto&gt; orderDtos = orders.stream().map(order -&gt; {
            try {
                return order.toOrderDto(webClient);
            } catch (Exception e) {
                throw new RuntimeException(e);
            }
        }).collect(Collectors.toList());

        span.setAttribute(&quot;user_id&quot;, user.getId());
        span.setAttribute(&quot;order_count&quot;, orders.size());

        return new ResponseEntity&lt;&gt;(orderDtos, HttpStatus.OK);
    } catch (Exception e) {
        // 记录 Span 错误
        span.recordException(e).setStatus(StatusCode.ERROR, e.getMessage());
        return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);
    } finally {
        // 记录 Span 结束时间
        span.end();
    }

}
</code></pre>
<p>这里我们首先通过请求属性获取到 span context，这里我们添加了两个属性，如果出现了异常则会记录异常信息，最后在 finally 代码块中结束 Span。</p>
<p>现在我们重新启动容器，当我们访问订单列表后就可以看到 Jaeger UI 中多了一个 <code>GET /api/orders</code> 的 span 了，并且该 span 和前端 frontend 服务的 span 关联起来了。</p>
<p><img alt="Alt Image Text" src="../../images/ot1_6_5.png" title="Body image" /></p>
<p>当然这还不够，因为我们的订单列表接口还会去请求 user-service 服务来获取用户信息，还会去请求 catalog-service 服务获取书籍信息，所以我们还需要在这两个请求中也注入我们这里的 span，这样就可以将整个链路串联起来了。</p>
<p>首先针对 TokenInterceptor 拦截器我们先创建一个子 span，代码如下所示：</p>
<pre><code>// src/main/java/com/youdianzhishi/orderservice/interceptor/TokenInterceptor.java
package com.youdianzhishi.orderservice.interceptor;

// ......

@Component
public class TokenInterceptor implements HandlerInterceptor {

    @Autowired
    private WebClient webClient;

    @Autowired
    private Tracer tracer;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 先获取 Span
        Span currentSpan = (Span) request.getAttribute(&quot;currentSpan&quot;);
        Context context = Context.current().with(currentSpan);

        // 创建新的 Span，作为子 Span
        Span span = tracer.spanBuilder(&quot;GET /api/userinfo&quot;)
            .setParent(context).startSpan();

        // 将子 Span 设置为当前上下文，相当于切换上下文到子 Span
        try (Scope scope = span.makeCurrent()) {

            try {
                String token = request.getHeader(&quot;Authorization&quot;);
                if (token == null) {
                    response.setStatus(HttpStatus.UNAUTHORIZED.value());
                    span.addEvent(&quot;Token is null&quot;).setStatus(StatusCode.ERROR);
                    return false;
                }
                // 从环境变量中获取 userServiceUrl
                String userServiceEnv = System.getenv(&quot;USER_SERVICE_URL&quot;);
                String userServiceUrl = userServiceEnv != null ? userServiceEnv : &quot;http://localhost:8080&quot;;
                User user = webClient.get()
                        .uri(userServiceUrl + &quot;/api/userinfo&quot;)
                        .header(HttpHeaders.AUTHORIZATION, token)
                        .retrieve()
                        .onStatus(httpStatus -&gt; httpStatus.equals(HttpStatus.UNAUTHORIZED),
                                clientResponse -&gt; Mono.error(new RuntimeException(&quot;Unauthorized&quot;)))
                        .onStatus(
                                httpStatus -&gt; httpStatus.is4xxClientError()
                                        &amp;&amp; !httpStatus.equals(HttpStatus.UNAUTHORIZED),
                                clientResponse -&gt; Mono.error(new RuntimeException(&quot;Other Client Error&quot;)))
                        .bodyToMono(User.class)
                        .block();
                if (user != null) {
                    request.setAttribute(&quot;user&quot;, user);
                    span.setAttribute(&quot;user_id&quot;, user.getId());
                    return true;
                } else {
                    response.setStatus(HttpStatus.UNAUTHORIZED.value());
                    span.addEvent(&quot;User is null&quot;).setStatus(StatusCode.ERROR);
                    return false;
                }
            } catch (RuntimeException e) {
                span.recordException(e).setStatus(StatusCode.ERROR, e.getMessage());
                if (e.getMessage().equals(&quot;Unauthorized&quot;)) {
                    response.setStatus(HttpStatus.UNAUTHORIZED.value());
                } else {
                    response.setStatus(HttpStatus.BAD_REQUEST.value());
                }
                return false;
            } catch (Exception e) {
                span.recordException(e).setStatus(StatusCode.ERROR, e.getMessage());
                response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());
                return false;
            } finally {
                request.setAttribute(&quot;parentSpan&quot;, span);
                span.end();
            }
        }

    }
}
</code></pre>
<p>在上面代码中我们首先获取当前上下文的 Span，然后创建一个名为 GET /api/userinfo 的 span，将其设置为当前上下文的子 span，并将上下文切换到当前子 span，然后执行我们的业务逻辑，最后结束子 span。</p>
<p>然后我们可以统一在 WebClient 中来注入 span context，这样当我们 Java 服务请求其他服务的时候就可以形成链路。</p>
<pre><code>// src/main/java/com/youdianzhishi/orderservice/config/WebClientConfig.java
package com.youdianzhishi.orderservice.config;

// ......

@Configuration
@Order(3)
public class WebClientConfig {
    @Autowired
    private OpenTelemetry openTelemetry;

    @Bean
    public WebClient webClient() {
        return WebClient.builder().filter(traceExchangeFilterFunction()).build();
    }

    @Bean
    public ExchangeFilterFunction traceExchangeFilterFunction() {
        return (clientRequest, next) -&gt; {
            // 获取当前上下文的 Span
            Span currentSpan = Span.current();
            Context context = Context.current().with(currentSpan);

            // 创建新的请求头并添加跟踪信息
            HttpHeaders newHeaders = new HttpHeaders();
            newHeaders.putAll(clientRequest.headers());

            TextMapSetter&lt;HttpHeaders&gt; setter = new TextMapSetter&lt;HttpHeaders&gt;() {
                @Override
                public void set(HttpHeaders carrier, String key, String value) {
                    carrier.add(key, value);
                }
            };

            // 将当前上下文的 Span 注入到请求头中
            openTelemetry.getPropagators().getTextMapPropagator().inject(context, newHeaders, setter);

            // 创建一个新的 ClientRequest 对象
            ClientRequest newRequest = ClientRequest.from(clientRequest)
                    .headers(headers -&gt; headers.addAll(newHeaders))
                    .build();

            return next.exchange(newRequest);
        };
    }
}
</code></pre>
<p>在上面代码中我们为 WebClient 添加了一个名为 <code>traceExchangeFilterFunction</code> 的过滤器函数，在该函数中我们首先获取当前上下文的 Span，然后创建一个新的请求头并添加跟踪信息，最后将当前上下文的 Span 通过 <code>Propagator</code> 接口注入到请求头中，这样当我们请求其他服务的时候就可以形成链路了。</p>
<p>现在我们重新启动容器，当我们访问订单列表后就可以看到 Jaeger UI 中多了一个 <code>GET /api/userinfo</code> 的 span 了，并且该 span 和还会和 user-service 服务的 span 关联起来。</p>
<p><img alt="Alt Image Text" src="../../images/ot1_6_6.png" title="Body image" /></p>
<p>同样的方式我们还可以在 <code>getAllOrders</code> 处理器中添加数据库查询的 span，代码如下所示：</p>
<pre><code>// 新建一个 DB 查询的 span
Span dbSpan = tracer.spanBuilder(&quot;DB findByUserIdOrderByOrderDateDesc&quot;).setParent(context).startSpan();
// 要根据 orderDate 倒序排列
List&lt;Order&gt; orders = orderRepository.findByUserIdOrderByOrderDateDesc(user.getId());
dbSpan.addEvent(&quot;OrderRepository findByUserIdOrderByOrderDateDesc From DB&quot;);
dbSpan.setAttribute(&quot;order_count&quot;, orders.size());
dbSpan.end();
</code></pre>
<p>将 Order 转换为 OrderDto 也可以添加一个 span，代码如下所示：</p>
<pre><code>// src/main/java/com/youdianzhishi/orderservice/model/Order.java
package com.youdianzhishi.orderservice.model;

// ......

public OrderDto toOrderDto(WebClient webClient, Tracer tracer, Context context) throws Exception {
    // 创建新的 Span，作为子 Span
    Span span = tracer.spanBuilder(&quot;GET /api/books/batch&quot;).setParent(context).startSpan();

    try (Scope scope = span.makeCurrent()) { // 切换上下文到子 Span

        span.setAttribute(&quot;order_id&quot;, this.getId());
        span.setAttribute(&quot;status&quot;, this.getStatus());

        OrderDto orderDto = new OrderDto();
        orderDto.setId(this.getId());
        orderDto.setStatus(this.getStatus());
        SimpleDateFormat formatter = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);
        String strDate = formatter.format(this.getOrderDate());
        orderDto.setOrderDate(strDate);

        List&lt;Integer&gt; bookIds = this.getBookIds(); // 假设你有一个可以获取书籍ID的方法
        // 将 bookIds 转换为字符串，以便于传递给 WebClient
        String bookIdsStr = bookIds.stream().map(String::valueOf).collect(Collectors.joining(&quot;,&quot;));
        span.addEvent(&quot;get book ids&quot;);
        span.setAttribute(&quot;book_ids&quot;, bookIdsStr);

        // 用 WebClient 调用批量查询书籍的服务接口
        // 从环境变量中获取 bookServiceUrl
        String catalogServiceEnv = System.getenv(&quot;CATALOG_SERVICE_URL&quot;);
        String catalogServiceUrl = catalogServiceEnv != null ? catalogServiceEnv : &quot;http://localhost:8082&quot;;
        Mono&lt;List&lt;BookDto&gt;&gt; booksMono = webClient.get() // 假设你有一个webClient实例
                .uri(catalogServiceUrl + &quot;/api/books/batch?ids=&quot; + bookIdsStr)
                .retrieve()
                .bodyToMono(new ParameterizedTypeReference&lt;&gt;() {
                });
        List&lt;BookDto&gt; books = booksMono.block();

        span.addEvent(&quot;get books info from catalog service&quot;);

        // 还需要将书籍数量和总价填充到 OrderDto 对象中
        int totalAmount = 0;
        int totalCount = 0;
        List&lt;BookQuantity&gt; bqs = this.getBookQuantities();
        for (BookDto book : books) {
            // 如果 book.id 在 bqs 中，那么就将对应的数量设置到 book.quantity 中
            int quantity = bqs.stream().filter(bq -&gt; bq.getId() == book.getId()).findFirst().get().getQuantity();
            book.setQuantity(quantity);
            totalCount += quantity;
            totalAmount += book.getPrice() * quantity;
        }

        orderDto.setBooks(books);
        orderDto.setAmount(totalAmount);
        orderDto.setTotal(totalCount);

        span.addEvent(&quot;calculate total amount and total count&quot;);

        span.end();

        return orderDto;
    }
}
</code></pre>
<p>这里同样我们会为每一个转换创建一个子 span，然后将其设置为当前上下文的子 span，最后结束子 span，这样当我们通过 WebClient 去请求 <code>catalog-service</code> 服务的时候也就可以形成链路了。</p>
<p>最后我们再去查看下完整的链路，如下图所示：</p>
<p><img alt="Alt Image Text" src="../../images/ot1_6_7.png" title="Body image" /></p>
<p>完整代码请查看：<a href="https://github.com/cnych/podemo">https://github.com/cnych/podemo</a>。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>